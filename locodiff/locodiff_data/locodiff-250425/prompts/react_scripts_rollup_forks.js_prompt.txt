# Instructions

You are being benchmarked. You will see the output of a git log command, and from that must infer the current state of a file. Think carefully, as you must output the exact state of the file to earn full marks.

**Important:** Your goal is to reproduce the file's content *exactly* as it exists at the final commit, even if the code appears broken, buggy, or contains obvious errors. Do **not** try to "fix" the code. Attempting to correct issues will result in a poor score, as this benchmark evaluates your ability to reproduce the precise state of the file based on its history.

# Required Response Format

Wrap the content of the file in triple backticks (```). Any text outside the final closing backticks will be ignored. End your response after outputting the closing backticks.

# Example Response

```python
#!/usr/bin/env python
print('Hello, world!')
```

# File History

> git log -p --cc --topo-order --reverse -- scripts/rollup/forks.js

commit 8cbc16f0faedafe4f7424b286af52dafd7a79587
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Thu Nov 30 12:11:00 2017 +0000

    Unify the way we fork modules (#11711)
    
    * Unify the way we fork modules
    
    * Replace rollup-plugin-alias with our own plugin
    
    This does exactly what we need and doesn't suffer from https://github.com/rollup/rollup-plugin-alias/issues/34.
    
    * Move the new plugin to its own file
    
    * Rename variable for consistency
    
    I settled on calling them "forks" since we already have a different concept of "shims".
    
    * Move fork config into its own file

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
new file mode 100644
index 0000000000..0c3845353d
--- /dev/null
+++ b/scripts/rollup/forks.js
@@ -0,0 +1,71 @@
+'use strict';
+
+const bundleTypes = require('./bundles').bundleTypes;
+
+const UMD_DEV = bundleTypes.UMD_DEV;
+const UMD_PROD = bundleTypes.UMD_PROD;
+const FB_DEV = bundleTypes.FB_DEV;
+const FB_PROD = bundleTypes.FB_PROD;
+
+// If you need to replace a file with another file for a specific environment,
+// add it to this list with the logic for choosing the right replacement.
+const forks = Object.freeze({
+  // Optimization: for UMDs, use object-assign polyfill that is already a part
+  // of the React package instead of bundling it again.
+  'object-assign': (bundleType, entry, dependencies) => {
+    if (bundleType !== UMD_DEV && bundleType !== UMD_PROD) {
+      // It's only relevant for UMD bundles since that's where the duplication
+      // happens. Other bundles just require('object-assign') anyway.
+      return null;
+    }
+    if (dependencies.indexOf('react') === -1) {
+      // We can only apply the optimizations to bundle that depend on React
+      // because we read assign() from an object exposed on React internals.
+      return null;
+    }
+    // We can use the fork!
+    return 'shared/forks/object-assign.umd.js';
+  },
+
+  // We have a few forks for different environments.
+  'shared/ReactFeatureFlags': (bundleType, entry) => {
+    switch (entry) {
+      case 'react-native-renderer':
+        return 'shared/forks/ReactFeatureFlags.native.js';
+      case 'react-cs-renderer':
+        return 'shared/forks/ReactFeatureFlags.native-cs.js';
+      default:
+        switch (bundleType) {
+          case FB_DEV:
+          case FB_PROD:
+            return 'shared/forks/ReactFeatureFlags.www.js';
+        }
+    }
+    return null;
+  },
+
+  // This logic is forked on www to blacklist warnings.
+  'shared/lowPriorityWarning': (bundleType, entry) => {
+    switch (bundleType) {
+      case FB_DEV:
+      case FB_PROD:
+        return 'shared/forks/lowPriorityWarning.www.js';
+      default:
+        return null;
+    }
+  },
+
+  // In FB bundles, we preserve an inline require to ReactCurrentOwner.
+  // See the explanation in FB version of ReactCurrentOwner in www:
+  'react/src/ReactCurrentOwner': (bundleType, entry) => {
+    switch (bundleType) {
+      case FB_DEV:
+      case FB_PROD:
+        return 'react/src/forks/ReactCurrentOwner.www.js';
+      default:
+        return null;
+    }
+  },
+});
+
+module.exports = forks;

commit 642a678a80af9c2350aea2f8c816085b1aa98d45
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Thu Nov 30 17:57:13 2017 +0000

    Replace ReactFiberErrorLogger injection with static forks (#11717)

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 0c3845353d..920b6a49e4 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -6,6 +6,8 @@ const UMD_DEV = bundleTypes.UMD_DEV;
 const UMD_PROD = bundleTypes.UMD_PROD;
 const FB_DEV = bundleTypes.FB_DEV;
 const FB_PROD = bundleTypes.FB_PROD;
+const RN_DEV = bundleTypes.RN_DEV;
+const RN_PROD = bundleTypes.RN_PROD;
 
 // If you need to replace a file with another file for a specific environment,
 // add it to this list with the logic for choosing the right replacement.
@@ -66,6 +68,28 @@ const forks = Object.freeze({
         return null;
     }
   },
+
+  // Different behavior for caught errors.
+  'react-reconciler/src/ReactFiberErrorDialog': (bundleType, entry) => {
+    switch (bundleType) {
+      case FB_DEV:
+      case FB_PROD:
+        // Use the www fork which shows an error dialog.
+        return 'react-reconciler/src/forks/ReactFiberErrorDialog.www.js';
+      case RN_DEV:
+      case RN_PROD:
+        switch (entry) {
+          case 'react-native-renderer':
+          case 'react-rt-renderer':
+            // Use the RN fork which plays well with redbox.
+            return 'react-reconciler/src/forks/ReactFiberErrorDialog.native.js';
+          default:
+            return null;
+        }
+      default:
+        return null;
+    }
+  },
 });
 
 module.exports = forks;

commit 46b3c3e4ae0d52565f7ed2344036a22016781ca0
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Thu Nov 30 19:10:46 2017 +0000

    Use static injection for ReactErrorUtils (#11725)
    
    * Use `this` inside invokeGuardedCallback
    
    It's slightly odd but that's exactly how our www fork works.
    Might as well do it in the open source version to make it clear we rely on context here.
    
    * Move invokeGuardedCallback into a separate file
    
    This lets us introduce forks for it.
    
    * Add a www fork for invokeGuardedCallback
    
    * Fix Flow

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 920b6a49e4..fe8626bcfa 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -69,7 +69,18 @@ const forks = Object.freeze({
     }
   },
 
-  // Different behavior for caught errors.
+  // Different wrapping/reporting for caught errors.
+  'shared/invokeGuardedCallback': (bundleType, entry) => {
+    switch (bundleType) {
+      case FB_DEV:
+      case FB_PROD:
+        return 'shared/forks/invokeGuardedCallback.www.js';
+      default:
+        return null;
+    }
+  },
+
+  // Different dialogs for caught errors.
   'react-reconciler/src/ReactFiberErrorDialog': (bundleType, entry) => {
     switch (bundleType) {
       case FB_DEV:

commit f93e34e98052d7bb6594bd02012e13432e039445
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Thu Dec 7 22:28:59 2017 +0000

    Remove an extra allocation for open source bundles (#11797)
    
    * Remove EventListener fbjs utility
    
    EventListener normalizes event subscription for <= IE8. This is no
    longer necessary. element.addEventListener is sufficient.
    
    * Remove an extra allocation for open source bundles
    
    * Split into two functions to avoid extra runtime checks
    
    * Revert unrelated changes

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index fe8626bcfa..f2302b1e36 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -101,6 +101,18 @@ const forks = Object.freeze({
         return null;
     }
   },
+
+  // We wrap top-level listeners into guards on www.
+  'react-dom/src/events/EventListener': (bundleType, entry) => {
+    switch (bundleType) {
+      case FB_DEV:
+      case FB_PROD:
+        // Use the www fork which is integrated with TimeSlice profiling.
+        return 'react-dom/src/events/forks/EventListener-www.js';
+      default:
+        return null;
+    }
+  },
 });
 
 module.exports = forks;

commit d3647583b3c2c1e68069f8188370b70a3f749b68
Author: Sebastian Markbåge <sebastian@calyptus.eu>
Date:   Wed Jan 17 18:07:25 2018 -0800

    Remove experimental RT/CS renderers (#12032)
    
    Will follow up with adding a new one.

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index f2302b1e36..481bdc91f2 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -34,8 +34,6 @@ const forks = Object.freeze({
     switch (entry) {
       case 'react-native-renderer':
         return 'shared/forks/ReactFeatureFlags.native.js';
-      case 'react-cs-renderer':
-        return 'shared/forks/ReactFeatureFlags.native-cs.js';
       default:
         switch (bundleType) {
           case FB_DEV:
@@ -91,7 +89,6 @@ const forks = Object.freeze({
       case RN_PROD:
         switch (entry) {
           case 'react-native-renderer':
-          case 'react-rt-renderer':
             // Use the RN fork which plays well with redbox.
             return 'react-reconciler/src/forks/ReactFiberErrorDialog.native.js';
           default:

commit 6031bea239d75e60882769f804e041f89cd22014
Author: Sebastian Markbåge <sebastian@calyptus.eu>
Date:   Mon Jan 22 09:58:35 2018 -0800

    Add Experimental Fabric Renderer (#12069)

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 481bdc91f2..d5963ec78c 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -34,6 +34,8 @@ const forks = Object.freeze({
     switch (entry) {
       case 'react-native-renderer':
         return 'shared/forks/ReactFeatureFlags.native.js';
+      case 'react-native-renderer/src/ReactFabric':
+        return 'shared/forks/ReactFeatureFlags.native-fabric.js';
       default:
         switch (bundleType) {
           case FB_DEV:

commit f828ca407febc6287011f8ae89aa469c4d522fcc
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Mon Feb 5 16:56:21 2018 +0000

    Expose persistent reconciler to custom renderers (#12156)

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index d5963ec78c..cb2661b689 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -36,6 +36,8 @@ const forks = Object.freeze({
         return 'shared/forks/ReactFeatureFlags.native.js';
       case 'react-native-renderer/src/ReactFabric':
         return 'shared/forks/ReactFeatureFlags.native-fabric.js';
+      case 'react-reconciler/persistent':
+        return 'shared/forks/ReactFeatureFlags.persistent.js';
       default:
         switch (bundleType) {
           case FB_DEV:

commit 49b0ca1b836751ae78fd191286b9eb3bf2be385b
Author: Sophie Alpert <git@sophiebits.com>
Date:   Thu Feb 8 13:28:17 2018 -0800

    Fix finding Fabric feature flags (#12189)
    
    Test Plan: yarn build fabric, inspect build/react-native/ReactFabric-dev.js to see enablePersistentReconciler = true.

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index cb2661b689..0833ae7013 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -34,7 +34,7 @@ const forks = Object.freeze({
     switch (entry) {
       case 'react-native-renderer':
         return 'shared/forks/ReactFeatureFlags.native.js';
-      case 'react-native-renderer/src/ReactFabric':
+      case 'react-native-renderer/fabric':
         return 'shared/forks/ReactFeatureFlags.native-fabric.js';
       case 'react-reconciler/persistent':
         return 'shared/forks/ReactFeatureFlags.persistent.js';

commit 268a3f60dfe67c4f6439fc37b569a2d81c81a53a
Author: Andrew Clark <acdlite@me.com>
Date:   Wed Mar 28 14:57:25 2018 -0700

    Add unstable APIs for async rendering to test renderer (#12478)
    
    These are based on the ReactNoop renderer, which we use to test React
    itself. This gives library authors (Relay, Apollo, Redux, et al.) a way
    to test their components for async compatibility.
    
    - Pass `unstable_isAsync` to `TestRenderer.create` to create an async
    renderer instance. This causes updates to be lazily flushed.
    - `renderer.unstable_yield` tells React to yield execution after the
    currently rendering component.
    - `renderer.unstable_flushAll` flushes all pending async work, and
    returns an array of yielded values.
    - `renderer.unstable_flushThrough` receives an array of expected values,
    begins rendering, and stops once those values have been yielded. It
    returns the array of values that are actually yielded. The user should
    assert that they are equal.
    
    Although we've used this pattern successfully in our own tests, I'm not
    sure if these are the final APIs we'll make public.

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 0833ae7013..f6d2a0623c 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -38,6 +38,8 @@ const forks = Object.freeze({
         return 'shared/forks/ReactFeatureFlags.native-fabric.js';
       case 'react-reconciler/persistent':
         return 'shared/forks/ReactFeatureFlags.persistent.js';
+      case 'react-test-renderer':
+        return 'shared/forks/ReactFeatureFlags.test-renderer.js';
       default:
         switch (bundleType) {
           case FB_DEV:

commit 76b4ba01290f446f4313adf3846954412c6051b8
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Mon Apr 9 18:57:52 2018 +0100

    Preserve error codes for invariants on www (#12539)
    
    * Preserve error codes for invariants on www
    
    * Remove unintentional change

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index f6d2a0623c..f02e771b85 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -84,6 +84,17 @@ const forks = Object.freeze({
     }
   },
 
+  // Route production invariants on www through the www invariant module.
+  'shared/reactProdInvariant': (bundleType, entry) => {
+    switch (bundleType) {
+      case FB_DEV:
+      case FB_PROD:
+        return 'shared/forks/reactProdInvariant.www.js';
+      default:
+        return null;
+    }
+  },
+
   // Different dialogs for caught errors.
   'react-reconciler/src/ReactFiberErrorDialog': (bundleType, entry) => {
     switch (bundleType) {

commit 8dfb0578816435a1a72f04506ee20d3c55d0f9bc
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Mon Apr 9 23:58:34 2018 +0100

    Unfork invariant and instead use it from reactProdInvariant (#12585)

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index f02e771b85..f6d2a0623c 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -84,17 +84,6 @@ const forks = Object.freeze({
     }
   },
 
-  // Route production invariants on www through the www invariant module.
-  'shared/reactProdInvariant': (bundleType, entry) => {
-    switch (bundleType) {
-      case FB_DEV:
-      case FB_PROD:
-        return 'shared/forks/reactProdInvariant.www.js';
-      default:
-        return null;
-    }
-  },
-
   // Different dialogs for caught errors.
   'react-reconciler/src/ReactFiberErrorDialog': (bundleType, entry) => {
     switch (bundleType) {

commit 0887c7d56cb9b83f36dcb490b4245d7bc33bda1f
Author: Brian Vaughn <brian.david.vaughn@gmail.com>
Date:   Wed Apr 18 13:16:50 2018 -0700

    Fork React Native renderer into FB and OSS bundles (#12625)
    
    * Added new "native-fb" and "native-fabric-fb" bundles.
    * Split RN_DEV and RN_PROD bundle types into RN_OSS_DEV, RN_OSS_PROD, RN_FB_DEV, and RN_FB_PROD. (This is a bit redundant but it seemed the least intrusive way of supporting a forked feature flags file for these bundles.)
    * Renamed FB_DEV and FB_PROD bundle types to be more explicitly for www (FB_WWW_DEV and FB_WWW_PROD)
    * Removed Haste @providesModule headers from the RB-specific RN renderer bundles to avoid a duplicate name conflicts.
    * Remove dynamic values from OSS RN feature flags. (Leave them in FB RN feature flags.)
    * Updated the sync script(s) to account for new renderer type.
    * Move ReactFeatureFlags.js shim to FB bundle only (since OSS bundle no longer needs dynamic values).

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index f6d2a0623c..97f73879ea 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -4,10 +4,12 @@ const bundleTypes = require('./bundles').bundleTypes;
 
 const UMD_DEV = bundleTypes.UMD_DEV;
 const UMD_PROD = bundleTypes.UMD_PROD;
-const FB_DEV = bundleTypes.FB_DEV;
-const FB_PROD = bundleTypes.FB_PROD;
-const RN_DEV = bundleTypes.RN_DEV;
-const RN_PROD = bundleTypes.RN_PROD;
+const FB_WWW_DEV = bundleTypes.FB_WWW_DEV;
+const FB_WWW_PROD = bundleTypes.FB_WWW_PROD;
+const RN_OSS_DEV = bundleTypes.RN_OSS_DEV;
+const RN_OSS_PROD = bundleTypes.RN_OSS_PROD;
+const RN_FB_DEV = bundleTypes.RN_FB_DEV;
+const RN_FB_PROD = bundleTypes.RN_FB_PROD;
 
 // If you need to replace a file with another file for a specific environment,
 // add it to this list with the logic for choosing the right replacement.
@@ -33,17 +35,39 @@ const forks = Object.freeze({
   'shared/ReactFeatureFlags': (bundleType, entry) => {
     switch (entry) {
       case 'react-native-renderer':
-        return 'shared/forks/ReactFeatureFlags.native.js';
+        switch (bundleType) {
+          case RN_FB_DEV:
+          case RN_FB_PROD:
+            return 'shared/forks/ReactFeatureFlags.native-fb.js';
+          case RN_OSS_DEV:
+          case RN_OSS_PROD:
+            return 'shared/forks/ReactFeatureFlags.native-oss.js';
+          default:
+            throw Error(
+              `Unexpected entry (${entry}) and bundleType (${bundleType})`
+            );
+        }
       case 'react-native-renderer/fabric':
-        return 'shared/forks/ReactFeatureFlags.native-fabric.js';
+        switch (bundleType) {
+          case RN_FB_DEV:
+          case RN_FB_PROD:
+            return 'shared/forks/ReactFeatureFlags.native-fabric-fb.js';
+          case RN_OSS_DEV:
+          case RN_OSS_PROD:
+            return 'shared/forks/ReactFeatureFlags.native-fabric-oss.js';
+          default:
+            throw Error(
+              `Unexpected entry (${entry}) and bundleType (${bundleType})`
+            );
+        }
       case 'react-reconciler/persistent':
         return 'shared/forks/ReactFeatureFlags.persistent.js';
       case 'react-test-renderer':
         return 'shared/forks/ReactFeatureFlags.test-renderer.js';
       default:
         switch (bundleType) {
-          case FB_DEV:
-          case FB_PROD:
+          case FB_WWW_DEV:
+          case FB_WWW_PROD:
             return 'shared/forks/ReactFeatureFlags.www.js';
         }
     }
@@ -53,8 +77,8 @@ const forks = Object.freeze({
   // This logic is forked on www to blacklist warnings.
   'shared/lowPriorityWarning': (bundleType, entry) => {
     switch (bundleType) {
-      case FB_DEV:
-      case FB_PROD:
+      case FB_WWW_DEV:
+      case FB_WWW_PROD:
         return 'shared/forks/lowPriorityWarning.www.js';
       default:
         return null;
@@ -65,8 +89,8 @@ const forks = Object.freeze({
   // See the explanation in FB version of ReactCurrentOwner in www:
   'react/src/ReactCurrentOwner': (bundleType, entry) => {
     switch (bundleType) {
-      case FB_DEV:
-      case FB_PROD:
+      case FB_WWW_DEV:
+      case FB_WWW_PROD:
         return 'react/src/forks/ReactCurrentOwner.www.js';
       default:
         return null;
@@ -76,8 +100,8 @@ const forks = Object.freeze({
   // Different wrapping/reporting for caught errors.
   'shared/invokeGuardedCallback': (bundleType, entry) => {
     switch (bundleType) {
-      case FB_DEV:
-      case FB_PROD:
+      case FB_WWW_DEV:
+      case FB_WWW_PROD:
         return 'shared/forks/invokeGuardedCallback.www.js';
       default:
         return null;
@@ -87,12 +111,14 @@ const forks = Object.freeze({
   // Different dialogs for caught errors.
   'react-reconciler/src/ReactFiberErrorDialog': (bundleType, entry) => {
     switch (bundleType) {
-      case FB_DEV:
-      case FB_PROD:
+      case FB_WWW_DEV:
+      case FB_WWW_PROD:
         // Use the www fork which shows an error dialog.
         return 'react-reconciler/src/forks/ReactFiberErrorDialog.www.js';
-      case RN_DEV:
-      case RN_PROD:
+      case RN_OSS_DEV:
+      case RN_OSS_PROD:
+      case RN_FB_DEV:
+      case RN_FB_PROD:
         switch (entry) {
           case 'react-native-renderer':
             // Use the RN fork which plays well with redbox.
@@ -108,8 +134,8 @@ const forks = Object.freeze({
   // We wrap top-level listeners into guards on www.
   'react-dom/src/events/EventListener': (bundleType, entry) => {
     switch (bundleType) {
-      case FB_DEV:
-      case FB_PROD:
+      case FB_WWW_DEV:
+      case FB_WWW_PROD:
         // Use the www fork which is integrated with TimeSlice profiling.
         return 'react-dom/src/events/forks/EventListener-www.js';
       default:

commit 8c747d01cb395ce06d93c2db6bb3f7b95b57d09d
Author: Sophie Alpert <git@sophiebits.com>
Date:   Mon May 14 18:47:40 2018 -0700

    Use ReactFiberErrorDialog fork for Fabric renderer (#12807)

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 97f73879ea..0a223c59ae 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -121,6 +121,7 @@ const forks = Object.freeze({
       case RN_FB_PROD:
         switch (entry) {
           case 'react-native-renderer':
+          case 'react-native-renderer/fabric':
             // Use the RN fork which plays well with redbox.
             return 'react-reconciler/src/forks/ReactFiberErrorDialog.native.js';
           default:

commit e96dc140599363029bd05565d58bcd4a432db370
Author: Philipp Spieß <hello@philippspiess.com>
Date:   Tue May 15 11:38:50 2018 +0200

    Use browser event names for top-level event types in React DOM (#12629)
    
    * Add TopLevelEventTypes
    
    * Fix `ReactBrowserEventEmitter`
    
    * Fix EventPluginUtils
    
    * Fix TapEventPlugin
    
    * Fix ResponderEventPlugin
    
    * Update ReactDOMFiberComponent
    
    * Fix BeforeInputEventPlugin
    
    * Fix ChangeEventPlugin
    
    * Fix EnterLeaveEventPlugin
    
    * Add missing non top event type used in ChangeEventPlugin
    
    * Fix SelectEventPlugin
    
    * Fix SimpleEventPlugin
    
    * Fix outstanding Flow issues and move TopLevelEventTypes
    
    * Inline a list of all events in `ReactTestUtils`
    
    * Fix tests
    
    * Make it pretty
    
    * Fix completly unrelated typo
    
    * Don’t use map constructor because of IE11
    
    * Update typings, revert changes to native code
    
    * Make topLevelTypes in ResponderEventPlugin injectable and create DOM and ReactNative variant
    
    * Set proper dependencies for DOMResponderEventPlugin
    
    * Prettify
    
    * Make some react dom tests no longer depend on internal API
    
    * Use factories to create top level speific generic event modules
    
    * Remove unused dependency
    
    * Revert exposed module renaming, hide store creation, and inline dependency decleration
    
    * Add Flow types to createResponderEventPlugin and its consumers
    
    * Remove unused dependency
    
    * Use opaque flow type for TopLevelType
    
    * Add missing semis
    
    * Use raw event names as top level identifer
    
    * Upgrade baylon
    
    This is required for parsing opaque flow types in our CI tests.
    
    * Clean up flow types
    
    * Revert Map changes of ReactBrowserEventEmitter
    
    * Upgrade babel-* packages
    
    Apparently local unit tests also have issues with parsing JavaScript
    modules that contain opaque types (not sure why I didn't notice
    earlier!?).
    
    * Revert Map changes of SimpleEventPlugin
    
    * Clean up ReactTestUtils
    
    * Add missing semi
    
    * Fix Flow issue
    
    * Make TopLevelType clearer
    
    * Favor for loops
    
    * Explain the new DOMTopLevelEventTypes concept
    
    * Use static injection for Responder plugin types
    
    * Remove null check and rely on flow checks
    
    * Add missing ResponderEventPlugin dependencies

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 0a223c59ae..28de8651c1 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -143,6 +143,14 @@ const forks = Object.freeze({
         return null;
     }
   },
+
+  // React DOM uses different top level event names and supports mouse events.
+  'events/ResponderTopLevelEventTypes': (bundleType, entry) => {
+    if (entry === 'react-dom' || entry.startsWith('react-dom/')) {
+      return 'events/forks/ResponderTopLevelEventTypes.dom.js';
+    }
+    return null;
+  },
 });
 
 module.exports = forks;

commit 7ccb37161ffcbea33d6ede1397098faa567751f3
Author: Flarnie Marchan <flarnie@users.noreply.github.com>
Date:   Thu May 17 08:57:45 2018 -0700

    Temporary fix for grabbing wrong rAF polyfill in ReactScheduler (#12837)
    
    * Temporary fix for grabbing wrong rAF polyfill in ReactScheduler
    
    **what is the change?:**
    For now...
    We need to grab a slightly different implementation of rAF internally at
    FB than in Open Source. Making rAF a dependency of the ReactScheduler
    module allows us to fork the dependency at FB.
    
    NOTE: After this lands we have an alternative plan to make this module
    separate from React and require it before our Facebook timer polyfills
    are applied. But want to land this now to keep master in a working state
    and fix bugs folks are seeing at Facebook.
    
    Thanks @sebmarkbage @acdlite and @sophiebits for discussing the options
    and trade-offs for solving this issue.
    
    **why make this change?:**
    This fixes a problem we're running into when experimenting with
    ReactScheduler internally at Facebook, **and* it's part of our long term
    plan to use dependency injection with the scheduler to make it easier to
    test and adjust.
    
    **test plan:**
    Ran tests, lint, flow, and will manually test when syncing into
    Facebook's codebase.
    
    **issue:**
    See internal task T29442940
    
    * ran prettier

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 28de8651c1..7df244733f 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -74,6 +74,17 @@ const forks = Object.freeze({
     return null;
   },
 
+  // This logic is forked on www to use the 'acrossTransitions' version.
+  'shared/requestAnimationFrameForReact': (bundleType, entry) => {
+    switch (bundleType) {
+      case FB_WWW_DEV:
+      case FB_WWW_PROD:
+        return 'shared/forks/requestAnimationFrameForReact.www.js';
+      default:
+        return null;
+    }
+  },
+
   // This logic is forked on www to blacklist warnings.
   'shared/lowPriorityWarning': (bundleType, entry) => {
     switch (bundleType) {

commit 47b003a828fe98e12947ba98e819ec4e617deef1
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Sat May 19 11:29:11 2018 +0100

    Resolve host configs at build time (#12792)
    
    * Extract base Jest config
    
    This makes it easier to change the source config without affecting the build test config.
    
    * Statically import the host config
    
    This changes react-reconciler to import HostConfig instead of getting it through a function argument.
    
    Rather than start with packages like ReactDOM that want to inline it, I started with React Noop and ensured that *custom* renderers using react-reconciler package still work. To do this, I'm making HostConfig module in the reconciler look at a global variable by default (which, in case of the react-reconciler npm package, ends up being the host config argument in the top-level scope).
    
    This is still very broken.
    
    * Add scaffolding for importing an inlined renderer
    
    * Fix the build
    
    * ES exports for renderer methods
    
    * ES modules for host configs
    
    * Remove closures from the reconciler
    
    * Check each renderer's config with Flow
    
    * Fix uncovered Flow issue
    
    We know nextHydratableInstance doesn't get mutated inside this function, but Flow doesn't so it thinks it may be null.
    Help Flow.
    
    * Prettier
    
    * Get rid of enable*Reconciler flags
    
    They are not as useful anymore because for almost all cases (except third party renderers) we *know* whether it supports mutation or persistence.
    
    This refactoring means react-reconciler and react-reconciler/persistent third-party packages now ship the same thing.
    Not ideal, but this seems worth how simpler the code becomes. We can later look into addressing it by having a single toggle instead.
    
    * Prettier again
    
    * Fix Flow config creation issue
    
    * Fix imprecise Flow typing
    
    * Revert accidental changes

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 7df244733f..b2d526946e 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -1,6 +1,8 @@
 'use strict';
 
 const bundleTypes = require('./bundles').bundleTypes;
+const moduleTypes = require('./bundles').moduleTypes;
+const inlinedHostConfigs = require('../shared/inlinedHostConfigs');
 
 const UMD_DEV = bundleTypes.UMD_DEV;
 const UMD_PROD = bundleTypes.UMD_PROD;
@@ -10,6 +12,8 @@ const RN_OSS_DEV = bundleTypes.RN_OSS_DEV;
 const RN_OSS_PROD = bundleTypes.RN_OSS_PROD;
 const RN_FB_DEV = bundleTypes.RN_FB_DEV;
 const RN_FB_PROD = bundleTypes.RN_FB_PROD;
+const RENDERER = moduleTypes.RENDERER;
+const RECONCILER = moduleTypes.RECONCILER;
 
 // If you need to replace a file with another file for a specific environment,
 // add it to this list with the logic for choosing the right replacement.
@@ -143,6 +147,33 @@ const forks = Object.freeze({
     }
   },
 
+  'react-reconciler/src/ReactFiberHostConfig': (
+    bundleType,
+    entry,
+    dependencies,
+    moduleType
+  ) => {
+    if (dependencies.indexOf('react-reconciler') !== -1) {
+      return null;
+    }
+    if (moduleType !== RENDERER && moduleType !== RECONCILER) {
+      return null;
+    }
+    // eslint-disable-next-line no-for-of-loops/no-for-of-loops
+    for (let rendererInfo of inlinedHostConfigs) {
+      if (rendererInfo.entryPoints.indexOf(entry) !== -1) {
+        return `react-reconciler/src/forks/ReactFiberHostConfig.${
+          rendererInfo.shortName
+        }.js`;
+      }
+    }
+    throw new Error(
+      'Expected ReactFiberHostConfig to always be replaced with a shim, but ' +
+        `found no mention of "${entry}" entry point in ./scripts/shared/inlinedHostConfigs.js. ` +
+        'Did you mean to add it there to associate it with a specific renderer?'
+    );
+  },
+
   // We wrap top-level listeners into guards on www.
   'react-dom/src/events/EventListener': (bundleType, entry) => {
     switch (bundleType) {

commit ff724d3c286a1753723ea71e8c046498ed1aac98
Author: Flarnie Marchan <flarnie@users.noreply.github.com>
Date:   Tue May 29 13:30:04 2018 -0700

    [scheduler] 4/n Allow splitting out `schedule` in fb-www, prepare to fix polyfill issue internally (#12900)
    
    * Use local references to global things inside 'scheduler'
    
    **what is the change?:**
    See title
    
    **why make this change?:**
    We want to avoid initially calling one version of an API and then later
    accessing a polyfilled version.
    
    **test plan:**
    Run existing tests.
    
    * Shim ReactScheduler for www
    
    **what is the change?:**
    In 'www' we want to reference the separate build of ReactScheduler,
    which allows treating it as a separate module internally.
    
    **why make this change?:**
    We need to require the ReactScheduler before our rAF polyfill activates,
    in order to customize which custom behaviors we want.
    
    This is also a step towards being able to experiment with using it
    outside of React.
    
    **test plan:**
    Ran tests, ran the build, and ran `test-build`.
    
    * Generate a bundle for fb-www
    
    **what is the change?:**
    See title
    
    **why make this change?:**
    Splitting out the 'schedule' module allows us to load it before
    polyfills kick in for rAF and other APIs.
    
    And long term we want to split this into a separate module anyway, this
    is a step towards that.
    
    **test plan:**
    I'll run the sync next week and verify that this all works. :)
    
    * ran prettier
    
    * fix rebase issues
    
    * Change names of variables used for holding globals

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index b2d526946e..d6fcdb4d18 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -79,6 +79,7 @@ const forks = Object.freeze({
   },
 
   // This logic is forked on www to use the 'acrossTransitions' version.
+  // This will be removed soon, see internal task T29442940
   'shared/requestAnimationFrameForReact': (bundleType, entry) => {
     switch (bundleType) {
       case FB_WWW_DEV:
@@ -89,6 +90,16 @@ const forks = Object.freeze({
     }
   },
 
+  'shared/ReactScheduler': (bundleType, entry) => {
+    switch (bundleType) {
+      case FB_WWW_DEV:
+      case FB_WWW_PROD:
+        return 'shared/forks/ReactScheduler.www.js';
+      default:
+        return null;
+    }
+  },
+
   // This logic is forked on www to blacklist warnings.
   'shared/lowPriorityWarning': (bundleType, entry) => {
     switch (bundleType) {

commit d5c11193e2e6d5ea2d55ce3b428616c401310731
Author: Brian Vaughn <brian.david.vaughn@gmail.com>
Date:   Mon Jun 11 13:16:27 2018 -0700

    Added production profiling bundle type (#12886)
    
    * Added profiling bundle
    * Turned profiling on for React Fabric OSS profiling and dev bundles
    * Added new global var "__PROFILE__" for profiling DCE

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index d6fcdb4d18..ed047100a0 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -10,6 +10,7 @@ const FB_WWW_DEV = bundleTypes.FB_WWW_DEV;
 const FB_WWW_PROD = bundleTypes.FB_WWW_PROD;
 const RN_OSS_DEV = bundleTypes.RN_OSS_DEV;
 const RN_OSS_PROD = bundleTypes.RN_OSS_PROD;
+const RN_OSS_PROFILING = bundleTypes.RN_OSS_PROFILING;
 const RN_FB_DEV = bundleTypes.RN_FB_DEV;
 const RN_FB_PROD = bundleTypes.RN_FB_PROD;
 const RENDERER = moduleTypes.RENDERER;
@@ -45,6 +46,7 @@ const forks = Object.freeze({
             return 'shared/forks/ReactFeatureFlags.native-fb.js';
           case RN_OSS_DEV:
           case RN_OSS_PROD:
+          case RN_OSS_PROFILING:
             return 'shared/forks/ReactFeatureFlags.native-oss.js';
           default:
             throw Error(
@@ -58,6 +60,7 @@ const forks = Object.freeze({
             return 'shared/forks/ReactFeatureFlags.native-fabric-fb.js';
           case RN_OSS_DEV:
           case RN_OSS_PROD:
+          case RN_OSS_PROFILING:
             return 'shared/forks/ReactFeatureFlags.native-fabric-oss.js';
           default:
             throw Error(
@@ -143,6 +146,7 @@ const forks = Object.freeze({
         return 'react-reconciler/src/forks/ReactFiberErrorDialog.www.js';
       case RN_OSS_DEV:
       case RN_OSS_PROD:
+      case RN_OSS_PROFILING:
       case RN_FB_DEV:
       case RN_FB_PROD:
         switch (entry) {

commit 2a8085980f5a96fa33bf12d8fd78594a3baecccb
Author: Flarnie Marchan <flarnie@users.noreply.github.com>
Date:   Wed Jun 13 10:57:35 2018 -0700

    Remove rAF fork (#12980)
    
    * Remove rAF fork
    
    **what is the change?:**
    Undid https://github.com/facebook/react/pull/12837
    
    **why make this change?:**
    We originally forked rAF because we needed to pull in a particular
    version of rAF internally at Facebook, to avoid grabbing the default
    polyfilled version.
    
    The longer term solution, until we can get rid of the global polyfill
    behavior, is to initialize 'schedule' before the polyfilling happens.
    
    Now that we have landed and synced
    https://github.com/facebook/react/pull/12900 successfully, we can
    initialize 'schedule' before the polyfill runs.
    So we can remove the rAF fork. Here is how it will work:
    
    1. Land this PR on Github.
    2. Flarnie will quickly run a sync getting this change into www.
    3. We delete the internal forked version of
       'requestAnimationFrameForReact'.
    4. We require 'schedule' in the polyfill file itself, before the
       polyfilling happens.
    
    **test plan:**
    Flarnie will manually try the above steps locally and verify that things
    work.
    
    **issue:**
    Internal task T29442940
    
    * fix nits
    
    * fix tests, fix changes from rebasing
    
    * fix lint

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index ed047100a0..4c9802b369 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -81,18 +81,6 @@ const forks = Object.freeze({
     return null;
   },
 
-  // This logic is forked on www to use the 'acrossTransitions' version.
-  // This will be removed soon, see internal task T29442940
-  'shared/requestAnimationFrameForReact': (bundleType, entry) => {
-    switch (bundleType) {
-      case FB_WWW_DEV:
-      case FB_WWW_PROD:
-        return 'shared/forks/requestAnimationFrameForReact.www.js';
-      default:
-        return null;
-    }
-  },
-
   'shared/ReactScheduler': (bundleType, entry) => {
     switch (bundleType) {
       case FB_WWW_DEV:

commit aeda7b745d9c080150704feb20ea576238a1b9a1
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Tue Jun 19 16:03:45 2018 +0100

    Remove fbjs dependency (#13069)
    
    * Inline fbjs/lib/invariant
    
    * Inline fbjs/lib/warning
    
    * Remove remaining usage of fbjs in packages/*.js
    
    * Fix lint
    
    * Remove fbjs from dependencies
    
    * Protect against accidental fbjs imports
    
    * Fix broken test mocks
    
    * Allow transitive deps on fbjs/ for UMD bundles
    
    * Remove fbjs from release script

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 4c9802b369..64def9eb87 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -91,6 +91,17 @@ const forks = Object.freeze({
     }
   },
 
+  // This logic is forked on www to fork the formatting function.
+  'shared/invariant': (bundleType, entry) => {
+    switch (bundleType) {
+      case FB_WWW_DEV:
+      case FB_WWW_PROD:
+        return 'shared/forks/invariant.www.js';
+      default:
+        return null;
+    }
+  },
+
   // This logic is forked on www to blacklist warnings.
   'shared/lowPriorityWarning': (bundleType, entry) => {
     switch (bundleType) {
@@ -102,6 +113,17 @@ const forks = Object.freeze({
     }
   },
 
+  // This logic is forked on www to blacklist warnings.
+  'shared/warning': (bundleType, entry) => {
+    switch (bundleType) {
+      case FB_WWW_DEV:
+      case FB_WWW_PROD:
+        return 'shared/forks/warning.www.js';
+      default:
+        return null;
+    }
+  },
+
   // In FB bundles, we preserve an inline require to ReactCurrentOwner.
   // See the explanation in FB version of ReactCurrentOwner in www:
   'react/src/ReactCurrentOwner': (bundleType, entry) => {

commit 6d6de6011cf329fabe057186e9a65fc8eb4e175c
Author: Brian Vaughn <brian.david.vaughn@gmail.com>
Date:   Tue Jun 26 13:28:41 2018 -0700

    Add PROFILE bundles for www+DOM and fbsource+RN/RF (#13112)

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 64def9eb87..827050ac32 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -8,11 +8,13 @@ const UMD_DEV = bundleTypes.UMD_DEV;
 const UMD_PROD = bundleTypes.UMD_PROD;
 const FB_WWW_DEV = bundleTypes.FB_WWW_DEV;
 const FB_WWW_PROD = bundleTypes.FB_WWW_PROD;
+const FB_WWW_PROFILING = bundleTypes.FB_WWW_PROFILING;
 const RN_OSS_DEV = bundleTypes.RN_OSS_DEV;
 const RN_OSS_PROD = bundleTypes.RN_OSS_PROD;
 const RN_OSS_PROFILING = bundleTypes.RN_OSS_PROFILING;
 const RN_FB_DEV = bundleTypes.RN_FB_DEV;
 const RN_FB_PROD = bundleTypes.RN_FB_PROD;
+const RN_FB_PROFILING = bundleTypes.RN_FB_PROFILING;
 const RENDERER = moduleTypes.RENDERER;
 const RECONCILER = moduleTypes.RECONCILER;
 
@@ -43,6 +45,7 @@ const forks = Object.freeze({
         switch (bundleType) {
           case RN_FB_DEV:
           case RN_FB_PROD:
+          case RN_FB_PROFILING:
             return 'shared/forks/ReactFeatureFlags.native-fb.js';
           case RN_OSS_DEV:
           case RN_OSS_PROD:
@@ -57,6 +60,7 @@ const forks = Object.freeze({
         switch (bundleType) {
           case RN_FB_DEV:
           case RN_FB_PROD:
+          case RN_FB_PROFILING:
             return 'shared/forks/ReactFeatureFlags.native-fabric-fb.js';
           case RN_OSS_DEV:
           case RN_OSS_PROD:
@@ -75,6 +79,7 @@ const forks = Object.freeze({
         switch (bundleType) {
           case FB_WWW_DEV:
           case FB_WWW_PROD:
+          case FB_WWW_PROFILING:
             return 'shared/forks/ReactFeatureFlags.www.js';
         }
     }
@@ -85,6 +90,7 @@ const forks = Object.freeze({
     switch (bundleType) {
       case FB_WWW_DEV:
       case FB_WWW_PROD:
+      case FB_WWW_PROFILING:
         return 'shared/forks/ReactScheduler.www.js';
       default:
         return null;
@@ -96,6 +102,7 @@ const forks = Object.freeze({
     switch (bundleType) {
       case FB_WWW_DEV:
       case FB_WWW_PROD:
+      case FB_WWW_PROFILING:
         return 'shared/forks/invariant.www.js';
       default:
         return null;
@@ -107,6 +114,7 @@ const forks = Object.freeze({
     switch (bundleType) {
       case FB_WWW_DEV:
       case FB_WWW_PROD:
+      case FB_WWW_PROFILING:
         return 'shared/forks/lowPriorityWarning.www.js';
       default:
         return null;
@@ -118,6 +126,7 @@ const forks = Object.freeze({
     switch (bundleType) {
       case FB_WWW_DEV:
       case FB_WWW_PROD:
+      case FB_WWW_PROFILING:
         return 'shared/forks/warning.www.js';
       default:
         return null;
@@ -130,6 +139,7 @@ const forks = Object.freeze({
     switch (bundleType) {
       case FB_WWW_DEV:
       case FB_WWW_PROD:
+      case FB_WWW_PROFILING:
         return 'react/src/forks/ReactCurrentOwner.www.js';
       default:
         return null;
@@ -141,6 +151,7 @@ const forks = Object.freeze({
     switch (bundleType) {
       case FB_WWW_DEV:
       case FB_WWW_PROD:
+      case FB_WWW_PROFILING:
         return 'shared/forks/invokeGuardedCallback.www.js';
       default:
         return null;
@@ -152,6 +163,7 @@ const forks = Object.freeze({
     switch (bundleType) {
       case FB_WWW_DEV:
       case FB_WWW_PROD:
+      case FB_WWW_PROFILING:
         // Use the www fork which shows an error dialog.
         return 'react-reconciler/src/forks/ReactFiberErrorDialog.www.js';
       case RN_OSS_DEV:
@@ -159,6 +171,7 @@ const forks = Object.freeze({
       case RN_OSS_PROFILING:
       case RN_FB_DEV:
       case RN_FB_PROD:
+      case RN_FB_PROFILING:
         switch (entry) {
           case 'react-native-renderer':
           case 'react-native-renderer/fabric':
@@ -204,6 +217,7 @@ const forks = Object.freeze({
     switch (bundleType) {
       case FB_WWW_DEV:
       case FB_WWW_PROD:
+      case FB_WWW_PROFILING:
         // Use the www fork which is integrated with TimeSlice profiling.
         return 'react-dom/src/events/forks/EventListener-www.js';
       default:

commit 449f6ddd5c075da965ec430015c66977c38db8d3
Author: Chang Yan <cyan.binary@gmail.com>
Date:   Fri Jul 6 12:55:29 2018 -0700

    create a new FeatureFlags file for test renderer on www (#13159)

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 827050ac32..682a4cd767 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -74,6 +74,12 @@ const forks = Object.freeze({
       case 'react-reconciler/persistent':
         return 'shared/forks/ReactFeatureFlags.persistent.js';
       case 'react-test-renderer':
+        switch (bundleType) {
+          case FB_WWW_DEV:
+          case FB_WWW_PROD:
+          case FB_WWW_PROFILING:
+            return 'shared/forks/ReactFeatureFlags.test-renderer.www.js';
+        }
         return 'shared/forks/ReactFeatureFlags.test-renderer.js';
       default:
         switch (bundleType) {

commit 659a29cecf74301532354261369e9048aac6e20f
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Fri Jul 13 02:45:37 2018 +0100

    Reorganize how shared internals are accessed (#13201)
    
    * Reorganize how shared internals are accessed
    
    * Update forks.js

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 682a4cd767..74d4df6c36 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -38,6 +38,15 @@ const forks = Object.freeze({
     return 'shared/forks/object-assign.umd.js';
   },
 
+  // Without this fork, importing `shared/ReactSharedInternals` inside
+  // the `react` package itself would not work due to a cyclical dependency.
+  'shared/ReactSharedInternals': (bundleType, entry) => {
+    if (entry === 'react') {
+      return 'react/src/ReactSharedInternals';
+    }
+    return null;
+  },
+
   // We have a few forks for different environments.
   'shared/ReactFeatureFlags': (bundleType, entry) => {
     switch (entry) {

commit f9358c51c8de93abe3cdd0f4720b489befad8c48
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Mon Jul 16 22:31:59 2018 +0100

    Change warning() to automatically inject the stack, and add warningWithoutStack() as opt-out (#13161)
    
    * Use %s in the console calls
    
    * Add shared/warningWithStack
    
    * Convert some warning callsites to warningWithStack
    
    * Use warningInStack in shared utilities and remove unnecessary checks
    
    * Replace more warning() calls with warningWithStack()
    
    * Fixes after rebase + use warningWithStack in react
    
    * Make warning have stack by default; warningWithoutStack opts out
    
    * Forbid builds that may not use internals
    
    * Revert newly added stacks
    
    I changed my mind and want to keep this PR without functional changes. So we won't "fix" any warnings that are already missing stacks. We'll do it in follow-ups instead.
    
    * Fix silly find/replace mistake
    
    * Reorder imports
    
    * Add protection against warning argument count mismatches
    
    * Address review

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 74d4df6c36..680f5f0709 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -40,10 +40,23 @@ const forks = Object.freeze({
 
   // Without this fork, importing `shared/ReactSharedInternals` inside
   // the `react` package itself would not work due to a cyclical dependency.
-  'shared/ReactSharedInternals': (bundleType, entry) => {
+  'shared/ReactSharedInternals': (bundleType, entry, dependencies) => {
     if (entry === 'react') {
       return 'react/src/ReactSharedInternals';
     }
+    if (dependencies.indexOf('react') === -1) {
+      // React internals are unavailable if we can't reference the package.
+      // We return an error because we only want to throw if this module gets used.
+      return new Error(
+        'Cannot use a module that depends on ReactSharedInternals ' +
+          'from "' +
+          entry +
+          '" because it does not declare "react" in the package ' +
+          'dependencies or peerDependencies. For example, this can happen if you use ' +
+          'warning() instead of warningWithoutStack() in a package that does not ' +
+          'depend on React.'
+      );
+    }
     return null;
   },
 

commit 5776fa3fcff2c93491e95c261d98af3cebf2cac9
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Fri Jul 20 16:50:43 2018 +0100

    Update www warning shim (#13244)

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 680f5f0709..3bd99dafce 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -150,12 +150,12 @@ const forks = Object.freeze({
   },
 
   // This logic is forked on www to blacklist warnings.
-  'shared/warning': (bundleType, entry) => {
+  'shared/warningWithoutStack': (bundleType, entry) => {
     switch (bundleType) {
       case FB_WWW_DEV:
       case FB_WWW_PROD:
       case FB_WWW_PROFILING:
-        return 'shared/forks/warning.www.js';
+        return 'shared/forks/warningWithoutStack.www.js';
       default:
         return null;
     }

commit 83e446e1d846cc0fef4aae473ab8244f6e163a34
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Wed Aug 15 19:02:11 2018 +0100

    Refactor ReactErrorUtils (#13406)
    
    * Refactor ReactErrorUtils
    
    * Remove unnecessary assignments

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 3bd99dafce..ba4a7fe3db 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -175,12 +175,12 @@ const forks = Object.freeze({
   },
 
   // Different wrapping/reporting for caught errors.
-  'shared/invokeGuardedCallback': (bundleType, entry) => {
+  'shared/invokeGuardedCallbackImpl': (bundleType, entry) => {
     switch (bundleType) {
       case FB_WWW_DEV:
       case FB_WWW_PROD:
       case FB_WWW_PROFILING:
-        return 'shared/forks/invokeGuardedCallback.www.js';
+        return 'shared/forks/invokeGuardedCallbackImpl.www.js';
       default:
         return null;
     }

commit 46950a3dfc9e14b5b91ee5823df11883f5d2466e
Author: Brian Vaughn <brian.david.vaughn@gmail.com>
Date:   Sat Sep 1 12:00:00 2018 -0700

    Interaction tracking follow up (#13509)
    
    * Merged interaction-tracking package into react-scheduler
    * Add tracking API to FB+www builds
    * Added Rollup plugin to strip no-side-effect imports from Rollup bundles
    * Re-bundle tracking and scheduling APIs on SECRET_INTERNALS object for UMD build (and provide lazy forwarding methods)
    * Added some additional tests and fixtures
    * Fixed broken UMD fixture in master (#13512)

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index ba4a7fe3db..5ebd3cb4b1 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -114,13 +114,42 @@ const forks = Object.freeze({
     return null;
   },
 
-  'shared/ReactScheduler': (bundleType, entry) => {
+  'react-scheduler': (bundleType, entry, dependencies) => {
     switch (bundleType) {
       case FB_WWW_DEV:
       case FB_WWW_PROD:
       case FB_WWW_PROFILING:
         return 'shared/forks/ReactScheduler.www.js';
+      case UMD_DEV:
+      case UMD_PROD:
+        if (dependencies.indexOf('react') === -1) {
+          // It's only safe to use this fork for modules that depend on React,
+          // because they read the re-exported API from the SECRET_INTERNALS object.
+          return null;
+        }
+        // Optimization: for UMDs, use the API that is already a part of the React
+        // package instead of requiring it to be loaded via a separate <script> tag
+        return 'shared/forks/ReactScheduler.umd.js';
+      default:
+        // For CJS bundles, use the shared NPM package.
+        return null;
+    }
+  },
+
+  'react-scheduler/tracking': (bundleType, entry, dependencies) => {
+    switch (bundleType) {
+      case UMD_DEV:
+      case UMD_PROD:
+        if (dependencies.indexOf('react') === -1) {
+          // It's only safe to use this fork for modules that depend on React,
+          // because they read the re-exported API from the SECRET_INTERNALS object.
+          return null;
+        }
+        // Optimization: for UMDs, use the API that is already a part of the React
+        // package instead of requiring it to be loaded via a separate <script> tag
+        return 'shared/forks/ReactSchedulerTracking.umd.js';
       default:
+        // For CJS bundles, use the shared NPM package.
         return null;
     }
   },

commit b92f947af1b5d8804026cb0e1cfa59ead7484ca5
Author: Brian Vaughn <brian.david.vaughn@gmail.com>
Date:   Mon Sep 3 11:27:50 2018 -0700

    Rename "react-scheduler" package to "schedule" (#13543)
    
    * Git moved packages/react-scheduler -> packages/schedule
    
    * Global find+replace 'react-scheduler' -> 'schedule'
    
    * Global find+replace 'ReactScheduler' -> 'Scheduler'
    
    * Renamed remaining files "ReactScheduler" -> "Schedule"
    
    * Add thank-you note to schedule package README
    
    * Replaced schedule package versions 0.1.0-alpha-1 -> 0.2.0
    
    * Patched our local fixtures to work around Yarn install issue
    
    * Removed some fixture hacks

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 5ebd3cb4b1..5aa72cecbe 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -114,12 +114,12 @@ const forks = Object.freeze({
     return null;
   },
 
-  'react-scheduler': (bundleType, entry, dependencies) => {
+  schedule: (bundleType, entry, dependencies) => {
     switch (bundleType) {
       case FB_WWW_DEV:
       case FB_WWW_PROD:
       case FB_WWW_PROFILING:
-        return 'shared/forks/ReactScheduler.www.js';
+        return 'shared/forks/Schedule.www.js';
       case UMD_DEV:
       case UMD_PROD:
         if (dependencies.indexOf('react') === -1) {
@@ -129,14 +129,14 @@ const forks = Object.freeze({
         }
         // Optimization: for UMDs, use the API that is already a part of the React
         // package instead of requiring it to be loaded via a separate <script> tag
-        return 'shared/forks/ReactScheduler.umd.js';
+        return 'shared/forks/Schedule.umd.js';
       default:
         // For CJS bundles, use the shared NPM package.
         return null;
     }
   },
 
-  'react-scheduler/tracking': (bundleType, entry, dependencies) => {
+  'schedule/tracking': (bundleType, entry, dependencies) => {
     switch (bundleType) {
       case UMD_DEV:
       case UMD_PROD:
@@ -147,7 +147,7 @@ const forks = Object.freeze({
         }
         // Optimization: for UMDs, use the API that is already a part of the React
         // package instead of requiring it to be loaded via a separate <script> tag
-        return 'shared/forks/ReactSchedulerTracking.umd.js';
+        return 'shared/forks/ScheduleTracking.umd.js';
       default:
         // For CJS bundles, use the shared NPM package.
         return null;

commit c1ba7b8cfd6e194f5cf6b0066c708ae48fd2ad67
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Mon Sep 3 19:55:58 2018 +0100

    Remove www scheduler fork (#13545)
    
    Remove unused www scheduler fork

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 5aa72cecbe..e1ace58fa2 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -116,10 +116,6 @@ const forks = Object.freeze({
 
   schedule: (bundleType, entry, dependencies) => {
     switch (bundleType) {
-      case FB_WWW_DEV:
-      case FB_WWW_PROD:
-      case FB_WWW_PROFILING:
-        return 'shared/forks/Schedule.www.js';
       case UMD_DEV:
       case UMD_PROD:
         if (dependencies.indexOf('react') === -1) {
@@ -131,7 +127,7 @@ const forks = Object.freeze({
         // package instead of requiring it to be loaded via a separate <script> tag
         return 'shared/forks/Schedule.umd.js';
       default:
-        // For CJS bundles, use the shared NPM package.
+        // For other bundles, use the shared NPM package.
         return null;
     }
   },
@@ -149,7 +145,7 @@ const forks = Object.freeze({
         // package instead of requiring it to be loaded via a separate <script> tag
         return 'shared/forks/ScheduleTracking.umd.js';
       default:
-        // For CJS bundles, use the shared NPM package.
+        // For other bundles, use the shared NPM package.
         return null;
     }
   },

commit 8a8d973d3cc5623676a84f87af66ef9259c3937c
Author: Dan <dan.abramov@gmail.com>
Date:   Sun Sep 9 16:54:28 2018 +0100

    Use clearer wording
    
    Fixes #13604

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index e1ace58fa2..e559929789 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -162,7 +162,7 @@ const forks = Object.freeze({
     }
   },
 
-  // This logic is forked on www to blacklist warnings.
+  // This logic is forked on www to ignore some warnings.
   'shared/lowPriorityWarning': (bundleType, entry) => {
     switch (bundleType) {
       case FB_WWW_DEV:
@@ -174,7 +174,7 @@ const forks = Object.freeze({
     }
   },
 
-  // This logic is forked on www to blacklist warnings.
+  // This logic is forked on www to ignore some warnings.
   'shared/warningWithoutStack': (bundleType, entry) => {
     switch (bundleType) {
       case FB_WWW_DEV:

commit 4bcee56210bd3ab3f6440ff7313a255148e22107
Author: Brian Vaughn <brian.david.vaughn@gmail.com>
Date:   Thu Sep 13 14:23:16 2018 -0700

    Rename "tracking" API to "tracing" (#13641)
    
    * Replaced "tracking" with "tracing" in all directory and file names
    * Global rename of track/tracking/tracked to trace/tracing/traced

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index e559929789..9c4f4d024c 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -132,7 +132,7 @@ const forks = Object.freeze({
     }
   },
 
-  'schedule/tracking': (bundleType, entry, dependencies) => {
+  'schedule/tracing': (bundleType, entry, dependencies) => {
     switch (bundleType) {
       case UMD_DEV:
       case UMD_PROD:
@@ -143,7 +143,7 @@ const forks = Object.freeze({
         }
         // Optimization: for UMDs, use the API that is already a part of the React
         // package instead of requiring it to be loaded via a separate <script> tag
-        return 'shared/forks/ScheduleTracking.umd.js';
+        return 'shared/forks/ScheduleTracing.umd.js';
       default:
         // For other bundles, use the shared NPM package.
         return null;

commit 8bc0bcabe7505a991e9e40a4b8ad1d3eb9b5723f
Author: Brian Vaughn <brian.david.vaughn@gmail.com>
Date:   Thu Sep 13 17:44:08 2018 -0700

    Add UMD production+profiling entry points (#13642)
    
    * Added UMD_PROFILING type to react-dom and scheduling package. Added UMD shim to schedule package.
    * Added new schedule umd prod+prof bundle to API test

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 9c4f4d024c..22ef8ca0c2 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -6,6 +6,7 @@ const inlinedHostConfigs = require('../shared/inlinedHostConfigs');
 
 const UMD_DEV = bundleTypes.UMD_DEV;
 const UMD_PROD = bundleTypes.UMD_PROD;
+const UMD_PROFILING = bundleTypes.UMD_PROFILING;
 const FB_WWW_DEV = bundleTypes.FB_WWW_DEV;
 const FB_WWW_PROD = bundleTypes.FB_WWW_PROD;
 const FB_WWW_PROFILING = bundleTypes.FB_WWW_PROFILING;
@@ -24,7 +25,11 @@ const forks = Object.freeze({
   // Optimization: for UMDs, use object-assign polyfill that is already a part
   // of the React package instead of bundling it again.
   'object-assign': (bundleType, entry, dependencies) => {
-    if (bundleType !== UMD_DEV && bundleType !== UMD_PROD) {
+    if (
+      bundleType !== UMD_DEV &&
+      bundleType !== UMD_PROD &&
+      bundleType !== UMD_PROFILING
+    ) {
       // It's only relevant for UMD bundles since that's where the duplication
       // happens. Other bundles just require('object-assign') anyway.
       return null;
@@ -118,6 +123,7 @@ const forks = Object.freeze({
     switch (bundleType) {
       case UMD_DEV:
       case UMD_PROD:
+      case UMD_PROFILING:
         if (dependencies.indexOf('react') === -1) {
           // It's only safe to use this fork for modules that depend on React,
           // because they read the re-exported API from the SECRET_INTERNALS object.
@@ -136,6 +142,7 @@ const forks = Object.freeze({
     switch (bundleType) {
       case UMD_DEV:
       case UMD_PROD:
+      case UMD_PROFILING:
         if (dependencies.indexOf('react') === -1) {
           // It's only safe to use this fork for modules that depend on React,
           // because they read the re-exported API from the SECRET_INTERNALS object.

commit 7ea3ca1d13b1b609678fa1369f8a1020c3ecb976
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Wed Sep 19 01:26:28 2018 +0100

    Rename schedule to scheduler (#13683)

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 22ef8ca0c2..bbb22d7a8c 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -119,7 +119,7 @@ const forks = Object.freeze({
     return null;
   },
 
-  schedule: (bundleType, entry, dependencies) => {
+  scheduler: (bundleType, entry, dependencies) => {
     switch (bundleType) {
       case UMD_DEV:
       case UMD_PROD:
@@ -131,14 +131,14 @@ const forks = Object.freeze({
         }
         // Optimization: for UMDs, use the API that is already a part of the React
         // package instead of requiring it to be loaded via a separate <script> tag
-        return 'shared/forks/Schedule.umd.js';
+        return 'shared/forks/Scheduler.umd.js';
       default:
         // For other bundles, use the shared NPM package.
         return null;
     }
   },
 
-  'schedule/tracing': (bundleType, entry, dependencies) => {
+  'scheduler/tracing': (bundleType, entry, dependencies) => {
     switch (bundleType) {
       case UMD_DEV:
       case UMD_PROD:
@@ -150,7 +150,7 @@ const forks = Object.freeze({
         }
         // Optimization: for UMDs, use the API that is already a part of the React
         // package instead of requiring it to be loaded via a separate <script> tag
-        return 'shared/forks/ScheduleTracing.umd.js';
+        return 'shared/forks/SchedulerTracing.umd.js';
       default:
         // For other bundles, use the shared NPM package.
         return null;

commit 1d25aa5787d4e19704c049c3cfa985d3b5190e0d
Author: Sebastian Markbåge <sebastian@calyptus.eu>
Date:   Fri Nov 30 11:38:22 2018 -0800

    [Fizz] New Server Rendering Infra (#14144)
    
    * [Fizz] Add Flow/Jest/Rollup build infra
    
    Add a new package for react-stream which allows for custom server renderer
    outputs. I picked the name because it's a reasonable name but also
    because the npm name is currently owned by a friend of the project.
    
    The react-dom build has its own inlined server renderer under the
    name `react-dom/fizz`.
    
    There is also a noop renderer to be used for testing. At some point
    we might add a public one to test-renderer but for now I don't want to have
    to think about public API design for the tests.
    
    * Add FormatConfig too
    
    We need to separate the format (DOM, React Native, etc) from the host
    running the server (Node, Browser, etc).
    
    * Basic wiring between Node, Noop and DOM configs
    
    The Node DOM API is pipeToNodeStream which accepts a writable stream.
    
    * Merge host and format config in dynamic react-stream entry point
    
    Simpler API this way but also avoids having to fork the wrapper config.
    
    Fixes noop builds.
    
    * Add setImmediate/Buffer globals to lint config
    
    Used by the server renderer
    
    * Properly include fizz.node.js
    
    Also use forwarding to it from fizz.js in builds so that tests covers
    this.
    
    * Make react-stream private since we're not ready to publish
    
    or even name it yet
    
    * Rename Renderer -> Streamer
    
    * Prefix react-dom/fizz with react-dom/unstable-fizz
    
    * Add Fizz Browser host config
    
    This lets Fizz render to WHATWG streams. E.g. for rendering in a
    Service Worker.
    
    I added react-dom/unstable-fizz.browser as the entry point for this.
    
    Since we now have two configurations of DOM. I had to add another
    inlinedHostConfigs configuration called `dom-browser`. The reconciler
    treats this configuration the same as `dom`. For stream it checks
    against the ReactFizzHostConfigBrowser instead of the Node one.
    
    * Add Fizz Browser Fixture
    
    This is for testing server rendering - on the client.
    
    * Lower version number to detach it from react-reconciler version

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index bbb22d7a8c..a6fa873078 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -272,6 +272,66 @@ const forks = Object.freeze({
     );
   },
 
+  'react-stream/src/ReactFizzHostConfig': (
+    bundleType,
+    entry,
+    dependencies,
+    moduleType
+  ) => {
+    if (dependencies.indexOf('react-stream') !== -1) {
+      return null;
+    }
+    if (moduleType !== RENDERER && moduleType !== RECONCILER) {
+      return null;
+    }
+    // eslint-disable-next-line no-for-of-loops/no-for-of-loops
+    for (let rendererInfo of inlinedHostConfigs) {
+      if (rendererInfo.entryPoints.indexOf(entry) !== -1) {
+        if (!rendererInfo.isFizzSupported) {
+          return null;
+        }
+        return `react-stream/src/forks/ReactFizzHostConfig.${
+          rendererInfo.shortName
+        }.js`;
+      }
+    }
+    throw new Error(
+      'Expected ReactFizzHostConfig to always be replaced with a shim, but ' +
+        `found no mention of "${entry}" entry point in ./scripts/shared/inlinedHostConfigs.js. ` +
+        'Did you mean to add it there to associate it with a specific renderer?'
+    );
+  },
+
+  'react-stream/src/ReactFizzFormatConfig': (
+    bundleType,
+    entry,
+    dependencies,
+    moduleType
+  ) => {
+    if (dependencies.indexOf('react-stream') !== -1) {
+      return null;
+    }
+    if (moduleType !== RENDERER && moduleType !== RECONCILER) {
+      return null;
+    }
+    // eslint-disable-next-line no-for-of-loops/no-for-of-loops
+    for (let rendererInfo of inlinedHostConfigs) {
+      if (rendererInfo.entryPoints.indexOf(entry) !== -1) {
+        if (!rendererInfo.isFizzSupported) {
+          return null;
+        }
+        return `react-stream/src/forks/ReactFizzFormatConfig.${
+          rendererInfo.shortName
+        }.js`;
+      }
+    }
+    throw new Error(
+      'Expected ReactFizzFormatConfig to always be replaced with a shim, but ' +
+        `found no mention of "${entry}" entry point in ./scripts/shared/inlinedHostConfigs.js. ` +
+        'Did you mean to add it there to associate it with a specific renderer?'
+    );
+  },
+
   // We wrap top-level listeners into guards on www.
   'react-dom/src/events/EventListener': (bundleType, entry) => {
     switch (bundleType) {

commit 535804f5c822e12bd6d89ad0081d45355e01cea3
Author: Brian Vaughn <brian.david.vaughn@gmail.com>
Date:   Fri Dec 14 07:54:46 2018 -0800

    Removed Fabric-specific feature flag files and updated Rollup to use the (non-Fabric) React Native flag files. (#14437)

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index a6fa873078..5ea01f96a9 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -88,11 +88,11 @@ const forks = Object.freeze({
           case RN_FB_DEV:
           case RN_FB_PROD:
           case RN_FB_PROFILING:
-            return 'shared/forks/ReactFeatureFlags.native-fabric-fb.js';
+            return 'shared/forks/ReactFeatureFlags.native-fb.js';
           case RN_OSS_DEV:
           case RN_OSS_PROD:
           case RN_OSS_PROFILING:
-            return 'shared/forks/ReactFeatureFlags.native-fabric-oss.js';
+            return 'shared/forks/ReactFeatureFlags.native-oss.js';
           default:
             throw Error(
               `Unexpected entry (${entry}) and bundleType (${bundleType})`

commit 653bc582f94e955b175d42836479ee8b9eeeeeaf
Author: Andrew Clark <git@andrewclark.io>
Date:   Mon Dec 17 17:55:34 2018 -0800

    Create separate SchedulerFeatureFlags instead of using ReactFeatureFlags (#14455)

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 5ea01f96a9..d64e9e5328 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -157,6 +157,18 @@ const forks = Object.freeze({
     }
   },
 
+  'scheduler/src/SchedulerFeatureFlags': (bundleType, entry, dependencies) => {
+    if (
+      entry === 'scheduler' &&
+      (bundleType === FB_WWW_DEV ||
+        bundleType === FB_WWW_PROD ||
+        bundleType === FB_WWW_PROFILING)
+    ) {
+      return 'scheduler/forks/SchedulerFeatureFlags.www.js';
+    }
+    return 'scheduler/src/SchedulerFeatureFlags';
+  },
+
   // This logic is forked on www to fork the formatting function.
   'shared/invariant': (bundleType, entry) => {
     switch (bundleType) {

commit 1c5aa2f23a80be137aeecc808498aedc304725bb
Author: Andrew Clark <git@andrewclark.io>
Date:   Tue Dec 18 11:09:44 2018 -0800

    Move SchedulerFeatureFlags fork to src directory to fix lint

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index d64e9e5328..934d213289 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -164,7 +164,7 @@ const forks = Object.freeze({
         bundleType === FB_WWW_PROD ||
         bundleType === FB_WWW_PROFILING)
     ) {
-      return 'scheduler/forks/SchedulerFeatureFlags.www.js';
+      return 'scheduler/src/forks/SchedulerFeatureFlags.www.js';
     }
     return 'scheduler/src/SchedulerFeatureFlags';
   },

commit 3e15b1c69014ad6767eac645228a052df861edc0
Author: Sunil Pai <threepointone@oculus.com>
Date:   Mon Jan 14 16:35:56 2019 +0000

    make a fork for ReactCurrentDispatcher (#14588)

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 934d213289..b5044a1f64 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -218,6 +218,19 @@ const forks = Object.freeze({
     }
   },
 
+  // Similarly, we preserve an inline require to ReactCurrentDispatcher.
+  // See the explanation in FB version of ReactCurrentDispatcher in www:
+  'react/src/ReactCurrentDispatcher': (bundleType, entry) => {
+    switch (bundleType) {
+      case FB_WWW_DEV:
+      case FB_WWW_PROD:
+      case FB_WWW_PROFILING:
+        return 'react/src/forks/ReactCurrentDispatcher.www.js';
+      default:
+        return null;
+    }
+  },
+
   // Different wrapping/reporting for caught errors.
   'shared/invokeGuardedCallbackImpl': (bundleType, entry) => {
     switch (bundleType) {

commit 00748c53e183952696157088a858352cc77b0010
Author: Andrew Clark <git@andrewclark.io>
Date:   Tue Feb 26 20:51:17 2019 -0800

    Add new mock build of Scheduler with flush, yield API (#14964)
    
    * Add new mock build of Scheduler with flush, yield API
    
    Test environments need a way to take control of the Scheduler queue and
    incrementally flush work. Our current tests accomplish this either using
    dynamic injection, or by using Jest's fake timers feature. Both of these
    options are fragile and rely too much on implementation details.
    
    In this new approach, we have a separate build of Scheduler that is
    specifically designed for test environments. We mock the default
    implementation like we would any other module; in our case, via Jest.
    This special build has methods like `flushAll` and `yieldValue` that
    control when work is flushed. These methods are based on equivalent
    methods we've been using to write incremental React tests. Eventually
    we may want to migrate the React tests to interact with the mock
    Scheduler directly, instead of going through the host config like we
    currently do.
    
    For now, I'm using our custom static injection infrastructure to create
    the two builds of Scheduler — a default build for DOM (which falls back
    to a naive timer based implementation), and the new mock build. I did it
    this way because it allows me to share most of the implementation, which
    isn't specific to a host environment — e.g. everything related to the
    priority queue. It may be better to duplicate the shared code instead,
    especially considering that future environments (like React Native) may
    have entirely forked implementations. I'd prefer to wait until the
    implementation stabilizes before worrying about that, but I'm open to
    changing this now if we decide it's important enough.
    
    * Mock Scheduler in bundle tests, too
    
    * Remove special case by making regex more restrictive

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index b5044a1f64..98c1b4a00f 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -159,16 +159,22 @@ const forks = Object.freeze({
 
   'scheduler/src/SchedulerFeatureFlags': (bundleType, entry, dependencies) => {
     if (
-      entry === 'scheduler' &&
-      (bundleType === FB_WWW_DEV ||
-        bundleType === FB_WWW_PROD ||
-        bundleType === FB_WWW_PROFILING)
+      bundleType === FB_WWW_DEV ||
+      bundleType === FB_WWW_PROD ||
+      bundleType === FB_WWW_PROFILING
     ) {
       return 'scheduler/src/forks/SchedulerFeatureFlags.www.js';
     }
     return 'scheduler/src/SchedulerFeatureFlags';
   },
 
+  'scheduler/src/SchedulerHostConfig': (bundleType, entry, dependencies) => {
+    if (entry === 'scheduler/unstable_mock') {
+      return 'scheduler/src/forks/SchedulerHostConfig.mock';
+    }
+    return 'scheduler/src/forks/SchedulerHostConfig.default';
+  },
+
   // This logic is forked on www to fork the formatting function.
   'shared/invariant': (bundleType, entry) => {
     switch (bundleType) {

commit 53e787b45f633468f5ccdc2012468f1ebbba9d4c
Author: Andrew Clark <git@andrewclark.io>
Date:   Thu Feb 28 10:30:46 2019 -0800

    Replace noop's fake Scheduler implementation with mock Scheduler build (#14969)
    
    * Replace noop's fake Scheduler implementation with mock Scheduler build
    
    The noop renderer has its own mock implementation of the Scheduler
    interface, with the ability to partially render work in tests. Now that
    this functionality has been lifted into a proper mock Scheduler build,
    we can use that instead.
    
    Most of the existing noop tests were unaffected, but I did have to make
    some changes. The biggest one involved passive effects: previously, they
    were scheduled on a separate queue from the queue that handles
    rendering. After this change, both rendering and effects are scheduled
    in the Scheduler queue. I think this is a better approach because tests
    no longer have to worry about the difference; if you call `flushAll`,
    all the work is flushed, both rendering and effects. But for those few
    tests that do care to flush the rendering without the effects, that's
    still possible using the `yieldValue` API.
    
    Follow-up: Do the same for test renderer.
    
    * Fix import to scheduler/unstable_mock

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 98c1b4a00f..f86cceb09b 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -169,7 +169,11 @@ const forks = Object.freeze({
   },
 
   'scheduler/src/SchedulerHostConfig': (bundleType, entry, dependencies) => {
-    if (entry === 'scheduler/unstable_mock') {
+    if (
+      entry === 'scheduler/unstable_mock' ||
+      entry === 'react-noop-renderer' ||
+      entry === 'react-noop-renderer/persistent'
+    ) {
       return 'scheduler/src/forks/SchedulerHostConfig.mock';
     }
     return 'scheduler/src/forks/SchedulerHostConfig.default';

commit ccb2a8a44eee74504f1e3f3bebc272cbb1fcc0f0
Author: Andrew Clark <git@andrewclark.io>
Date:   Thu Feb 28 10:50:38 2019 -0800

    Replace test renderer's fake Scheduler implementation with mock build (#14970)
    
    * Replace test renderer's fake Scheduler implementation with mock build
    
    The test renderer has its own mock implementation of the Scheduler
    interface, with the ability to partially render work in tests. Now that
    this functionality has been lifted into a proper mock Scheduler build,
    we can use that instead.
    
    * Fix Profiler tests in prod

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index f86cceb09b..9d028262ba 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -172,7 +172,8 @@ const forks = Object.freeze({
     if (
       entry === 'scheduler/unstable_mock' ||
       entry === 'react-noop-renderer' ||
-      entry === 'react-noop-renderer/persistent'
+      entry === 'react-noop-renderer/persistent' ||
+      entry === 'react-test-renderer'
     ) {
       return 'scheduler/src/forks/SchedulerHostConfig.mock';
     }

commit 42c3c967d1e4ca4731b47866f2090bc34caa086c
Author: Andrew Clark <git@andrewclark.io>
Date:   Mon Mar 18 13:58:03 2019 -0700

    Compile invariant directly to throw expressions (#15071)
    
    * Transform invariant to custom error type
    
    This transforms calls to the invariant module:
    
    ```js
    invariant(condition, 'A %s message that contains %s', adj, noun);
    ```
    
    Into throw statements:
    
    ```js
    if (!condition) {
      if (__DEV__) {
        throw ReactError(`A ${adj} message that contains ${noun}`);
      } else {
        throw ReactErrorProd(ERR_CODE, adj, noun);
      }
    }
    ```
    
    The only thing ReactError does is return an error whose name is set
    to "Invariant Violation" to match the existing behavior.
    
    ReactErrorProd is a special version used in production that throws
    a minified error code, with a link to see to expanded form. This
    replaces the reactProdInvariant module.
    
    As a next step, I would like to replace our use of the invariant module
    for user facing errors by transforming normal Error constructors to
    ReactError and ReactErrorProd. (We can continue using invariant for
    internal React errors that are meant to be unreachable, which was the
    original purpose of invariant.)
    
    * Use numbers instead of strings for error codes
    
    * Use arguments instead of an array
    
    I wasn't sure about this part so I asked Sebastian, and his rationale
    was that using arguments will make ReactErrorProd slightly slower, but
    using an array will likely make all the functions that throw slightly
    slower to compile, so it's hard to say which way is better. But since
    ReactErrorProd is in an error path, and fewer bytes is generally better,
    no array is good.
    
    * Casing nit

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 9d028262ba..c93ac87559 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -180,18 +180,6 @@ const forks = Object.freeze({
     return 'scheduler/src/forks/SchedulerHostConfig.default';
   },
 
-  // This logic is forked on www to fork the formatting function.
-  'shared/invariant': (bundleType, entry) => {
-    switch (bundleType) {
-      case FB_WWW_DEV:
-      case FB_WWW_PROD:
-      case FB_WWW_PROFILING:
-        return 'shared/forks/invariant.www.js';
-      default:
-        return null;
-    }
-  },
-
   // This logic is forked on www to ignore some warnings.
   'shared/lowPriorityWarning': (bundleType, entry) => {
     switch (bundleType) {

commit 4d5cb64aa2beacf982cf0e01628ddda6bd92014c
Author: Andrew Clark <git@andrewclark.io>
Date:   Tue Apr 2 15:49:07 2019 -0700

    Rewrite ReactFiberScheduler for better integration with Scheduler package (#15151)
    
    * Rewrite ReactFiberScheduler
    
    Adds a new implementation of ReactFiberScheduler behind a feature flag.
    We will maintain both implementations in parallel until the new one
    is proven stable enough to replace the old one.
    
    The main difference between the implementations is that the new one is
    integrated with the Scheduler package's priority levels.
    
    * Conditionally add fields to FiberRoot
    
    Some fields only used by the old scheduler, and some by the new.
    
    * Add separate build that enables new scheduler
    
    * Re-enable skipped test
    
    If synchronous updates are scheduled by a passive effect, that work
    should be flushed synchronously, even if flushPassiveEffects is
    called inside batchedUpdates.
    
    * Passive effects have same priority as render
    
    * Revert ability to cancel the current callback
    
    React doesn't need this anyway because it never schedules callbacks if
    it's already rendering.
    
    * Revert change to FiberDebugPerf
    
    Turns out this isn't neccessary.
    
    * Fix ReactFiberScheduler dead code elimination
    
    Should initialize to nothing, then assign the exports conditionally,
    instead of initializing to the old exports and then reassigning to the
    new ones.
    
    * Don't yield before commit during sync error retry
    
    * Call Scheduler.flushAll unconditionally in tests
    
    Instead of wrapping in enableNewScheduler flag.

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index c93ac87559..41d0f9bce6 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -68,6 +68,12 @@ const forks = Object.freeze({
   // We have a few forks for different environments.
   'shared/ReactFeatureFlags': (bundleType, entry) => {
     switch (entry) {
+      case 'react-dom/unstable-new-scheduler': {
+        if (entry === 'react-dom/unstable-new-scheduler') {
+          return 'shared/forks/ReactFeatureFlags.www-new-scheduler.js';
+        }
+        return null;
+      }
       case 'react-native-renderer':
         switch (bundleType) {
           case RN_FB_DEV:

commit 3a44ccefeda8cfa19482c8a3a4480a83cae6c2ae
Author: Andrew Clark <git@andrewclark.io>
Date:   Wed Apr 3 10:36:18 2019 -0700

    Fix feature flags react-dom/unstable-new-scheduler (#15309)
    
    I forgot to account for the CommonJS builds. (I had this change in
    my local checkout but accidentally didn't commit it.)

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 41d0f9bce6..45c1fd411f 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -7,6 +7,9 @@ const inlinedHostConfigs = require('../shared/inlinedHostConfigs');
 const UMD_DEV = bundleTypes.UMD_DEV;
 const UMD_PROD = bundleTypes.UMD_PROD;
 const UMD_PROFILING = bundleTypes.UMD_PROFILING;
+const NODE_DEV = bundleTypes.NODE_DEV;
+const NODE_PROD = bundleTypes.NODE_PROD;
+const NODE_PROFILING = bundleTypes.NODE_PROFILING;
 const FB_WWW_DEV = bundleTypes.FB_WWW_DEV;
 const FB_WWW_PROD = bundleTypes.FB_WWW_PROD;
 const FB_WWW_PROFILING = bundleTypes.FB_WWW_PROFILING;
@@ -69,10 +72,20 @@ const forks = Object.freeze({
   'shared/ReactFeatureFlags': (bundleType, entry) => {
     switch (entry) {
       case 'react-dom/unstable-new-scheduler': {
-        if (entry === 'react-dom/unstable-new-scheduler') {
-          return 'shared/forks/ReactFeatureFlags.www-new-scheduler.js';
+        switch (bundleType) {
+          case FB_WWW_DEV:
+          case FB_WWW_PROD:
+          case FB_WWW_PROFILING:
+            return 'shared/forks/ReactFeatureFlags.www-new-scheduler.js';
+          case NODE_DEV:
+          case NODE_PROD:
+          case NODE_PROFILING:
+            return 'shared/forks/ReactFeatureFlags.new-scheduler.js';
+          default:
+            throw Error(
+              `Unexpected entry (${entry}) and bundleType (${bundleType})`
+            );
         }
-        return null;
       }
       case 'react-native-renderer':
         switch (bundleType) {

commit 9055e31e5c82d03f0a365c459f7bc79e402dbef5
Author: Andrew Clark <git@andrewclark.io>
Date:   Thu Apr 11 19:15:34 2019 -0700

    Replace old Fiber Scheduler with new one (#15387)
    
    The new Fiber Scheduler has been running in Facebook for several days
    without issues. Let's switch to it.

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 45c1fd411f..c93ac87559 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -7,9 +7,6 @@ const inlinedHostConfigs = require('../shared/inlinedHostConfigs');
 const UMD_DEV = bundleTypes.UMD_DEV;
 const UMD_PROD = bundleTypes.UMD_PROD;
 const UMD_PROFILING = bundleTypes.UMD_PROFILING;
-const NODE_DEV = bundleTypes.NODE_DEV;
-const NODE_PROD = bundleTypes.NODE_PROD;
-const NODE_PROFILING = bundleTypes.NODE_PROFILING;
 const FB_WWW_DEV = bundleTypes.FB_WWW_DEV;
 const FB_WWW_PROD = bundleTypes.FB_WWW_PROD;
 const FB_WWW_PROFILING = bundleTypes.FB_WWW_PROFILING;
@@ -71,22 +68,6 @@ const forks = Object.freeze({
   // We have a few forks for different environments.
   'shared/ReactFeatureFlags': (bundleType, entry) => {
     switch (entry) {
-      case 'react-dom/unstable-new-scheduler': {
-        switch (bundleType) {
-          case FB_WWW_DEV:
-          case FB_WWW_PROD:
-          case FB_WWW_PROFILING:
-            return 'shared/forks/ReactFeatureFlags.www-new-scheduler.js';
-          case NODE_DEV:
-          case NODE_PROD:
-          case NODE_PROFILING:
-            return 'shared/forks/ReactFeatureFlags.new-scheduler.js';
-          default:
-            throw Error(
-              `Unexpected entry (${entry}) and bundleType (${bundleType})`
-            );
-        }
-      }
       case 'react-native-renderer':
         switch (bundleType) {
           case RN_FB_DEV:

commit edfedf3ae9453c646afe5e77c75bd2a53159e262
Author: Andrew Clark <git@andrewclark.io>
Date:   Fri May 10 13:51:39 2019 -0700

    Fork ReactSharedInternals for UMD builds (#15617)

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index c93ac87559..96790a1c1e 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -230,6 +230,17 @@ const forks = Object.freeze({
     }
   },
 
+  'react/src/ReactSharedInternals.js': (bundleType, entry) => {
+    switch (bundleType) {
+      case UMD_DEV:
+      case UMD_PROD:
+      case UMD_PROFILING:
+        return 'react/src/forks/ReactSharedInternals.umd.js';
+      default:
+        return null;
+    }
+  },
+
   // Different wrapping/reporting for caught errors.
   'shared/invokeGuardedCallbackImpl': (bundleType, entry) => {
     switch (bundleType) {

commit b1a03dfdc8e42d075422556553ffe59868150e95
Author: Brian Vaughn <bvaughn@fb.com>
Date:   Wed Aug 14 07:32:42 2019 -0700

    Rename legacy "events" package to "legacy-events" (#16388)
    
    * Renamed 'events' package to 'legacy-events'
    * Updated 'events' references to point to 'legacy-events'

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 96790a1c1e..ac217405db 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -381,9 +381,9 @@ const forks = Object.freeze({
   },
 
   // React DOM uses different top level event names and supports mouse events.
-  'events/ResponderTopLevelEventTypes': (bundleType, entry) => {
+  'legacy-events/ResponderTopLevelEventTypes': (bundleType, entry) => {
     if (entry === 'react-dom' || entry.startsWith('react-dom/')) {
-      return 'events/forks/ResponderTopLevelEventTypes.dom.js';
+      return 'legacy-events/forks/ResponderTopLevelEventTypes.dom.js';
     }
     return null;
   },

commit 18d2e0c03e4496a824fdb7f89ea2a3d60c30d49a
Author: Jessica Franco <jessica@jessidhia.dev>
Date:   Tue Sep 24 21:45:38 2019 +0900

    Warning system refactoring (part 1) (#16799)
    
    * Rename lowPriorityWarning to lowPriorityWarningWithoutStack
    
    This maintains parity with the other warning-like functions.
    
    * Duplicate the toWarnDev tests to test toLowPriorityWarnDev
    
    * Make a lowPriorityWarning version of warning.js
    
    * Extract both variants in print-warning
    
    Avoids parsing lowPriorityWarning.js itself as the way it forwards the
    call to lowPriorityWarningWithoutStack is not analyzable.

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index ac217405db..1f6edfbeb8 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -181,12 +181,12 @@ const forks = Object.freeze({
   },
 
   // This logic is forked on www to ignore some warnings.
-  'shared/lowPriorityWarning': (bundleType, entry) => {
+  'shared/lowPriorityWarningWithoutStack': (bundleType, entry) => {
     switch (bundleType) {
       case FB_WWW_DEV:
       case FB_WWW_PROD:
       case FB_WWW_PROFILING:
-        return 'shared/forks/lowPriorityWarning.www.js';
+        return 'shared/forks/lowPriorityWarningWithoutStack.www.js';
       default:
         return null;
     }

commit f4e974d26e273c4eb58c0ffa9b479435bf598ea1
Author: Sebastian Markbåge <sebastian@calyptus.eu>
Date:   Tue Oct 29 14:45:47 2019 -0700

    Add Experimental Flight Infrastructure (#16398)
    
    * Add Flight Build and Unify HostFormat Config between Flight and Fizz
    
    * Add basic resolution of models
    
    * Add basic Flight fixture
    
    Demonstrates the streaming protocol.
    
    * Rename to flight-server to distinguish from the client parts
    
    * Add Flight Client package and entry point
    
    * Fix fixture

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 1f6edfbeb8..8c94593ec8 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -307,13 +307,13 @@ const forks = Object.freeze({
     );
   },
 
-  'react-stream/src/ReactFizzHostConfig': (
+  'react-server/src/ReactServerHostConfig': (
     bundleType,
     entry,
     dependencies,
     moduleType
   ) => {
-    if (dependencies.indexOf('react-stream') !== -1) {
+    if (dependencies.indexOf('react-server') !== -1) {
       return null;
     }
     if (moduleType !== RENDERER && moduleType !== RECONCILER) {
@@ -322,28 +322,28 @@ const forks = Object.freeze({
     // eslint-disable-next-line no-for-of-loops/no-for-of-loops
     for (let rendererInfo of inlinedHostConfigs) {
       if (rendererInfo.entryPoints.indexOf(entry) !== -1) {
-        if (!rendererInfo.isFizzSupported) {
+        if (!rendererInfo.isServerSupported) {
           return null;
         }
-        return `react-stream/src/forks/ReactFizzHostConfig.${
+        return `react-server/src/forks/ReactServerHostConfig.${
           rendererInfo.shortName
         }.js`;
       }
     }
     throw new Error(
-      'Expected ReactFizzHostConfig to always be replaced with a shim, but ' +
+      'Expected ReactServerHostConfig to always be replaced with a shim, but ' +
         `found no mention of "${entry}" entry point in ./scripts/shared/inlinedHostConfigs.js. ` +
         'Did you mean to add it there to associate it with a specific renderer?'
     );
   },
 
-  'react-stream/src/ReactFizzFormatConfig': (
+  'react-server/src/ReactServerFormatConfig': (
     bundleType,
     entry,
     dependencies,
     moduleType
   ) => {
-    if (dependencies.indexOf('react-stream') !== -1) {
+    if (dependencies.indexOf('react-server') !== -1) {
       return null;
     }
     if (moduleType !== RENDERER && moduleType !== RECONCILER) {
@@ -352,16 +352,46 @@ const forks = Object.freeze({
     // eslint-disable-next-line no-for-of-loops/no-for-of-loops
     for (let rendererInfo of inlinedHostConfigs) {
       if (rendererInfo.entryPoints.indexOf(entry) !== -1) {
-        if (!rendererInfo.isFizzSupported) {
+        if (!rendererInfo.isServerSupported) {
           return null;
         }
-        return `react-stream/src/forks/ReactFizzFormatConfig.${
+        return `react-server/src/forks/ReactServerFormatConfig.${
           rendererInfo.shortName
         }.js`;
       }
     }
     throw new Error(
-      'Expected ReactFizzFormatConfig to always be replaced with a shim, but ' +
+      'Expected ReactServerFormatConfig to always be replaced with a shim, but ' +
+        `found no mention of "${entry}" entry point in ./scripts/shared/inlinedHostConfigs.js. ` +
+        'Did you mean to add it there to associate it with a specific renderer?'
+    );
+  },
+
+  'react-flight/src/ReactFlightClientHostConfig': (
+    bundleType,
+    entry,
+    dependencies,
+    moduleType
+  ) => {
+    if (dependencies.indexOf('react-flight') !== -1) {
+      return null;
+    }
+    if (moduleType !== RENDERER && moduleType !== RECONCILER) {
+      return null;
+    }
+    // eslint-disable-next-line no-for-of-loops/no-for-of-loops
+    for (let rendererInfo of inlinedHostConfigs) {
+      if (rendererInfo.entryPoints.indexOf(entry) !== -1) {
+        if (!rendererInfo.isServerSupported) {
+          return null;
+        }
+        return `react-flight/src/forks/ReactFlightClientHostConfig.${
+          rendererInfo.shortName
+        }.js`;
+      }
+    }
+    throw new Error(
+      'Expected ReactFlightClientHostConfig to always be replaced with a shim, but ' +
         `found no mention of "${entry}" entry point in ./scripts/shared/inlinedHostConfigs.js. ` +
         'Did you mean to add it there to associate it with a specific renderer?'
     );

commit 0cf22a56a18790ef34c71bef14f64695c0498619
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Sat Dec 14 18:09:25 2019 +0000

    Use console directly instead of warning() modules (#17599)
    
    * Replace all warning/lowPriWarning with console calls
    
    * Replace console.warn/error with a custom wrapper at build time
    
    * Fail the build for console.error/warn() where we can't read the stack

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 8c94593ec8..b6d2fe5caf 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -57,9 +57,7 @@ const forks = Object.freeze({
           'from "' +
           entry +
           '" because it does not declare "react" in the package ' +
-          'dependencies or peerDependencies. For example, this can happen if you use ' +
-          'warning() instead of warningWithoutStack() in a package that does not ' +
-          'depend on React.'
+          'dependencies or peerDependencies.'
       );
     }
     return null;
@@ -180,25 +178,10 @@ const forks = Object.freeze({
     return 'scheduler/src/forks/SchedulerHostConfig.default';
   },
 
-  // This logic is forked on www to ignore some warnings.
-  'shared/lowPriorityWarningWithoutStack': (bundleType, entry) => {
+  'shared/consoleWithStackDev': (bundleType, entry) => {
     switch (bundleType) {
       case FB_WWW_DEV:
-      case FB_WWW_PROD:
-      case FB_WWW_PROFILING:
-        return 'shared/forks/lowPriorityWarningWithoutStack.www.js';
-      default:
-        return null;
-    }
-  },
-
-  // This logic is forked on www to ignore some warnings.
-  'shared/warningWithoutStack': (bundleType, entry) => {
-    switch (bundleType) {
-      case FB_WWW_DEV:
-      case FB_WWW_PROD:
-      case FB_WWW_PROFILING:
-        return 'shared/forks/warningWithoutStack.www.js';
+        return 'shared/forks/consoleWithStackDev.www.js';
       default:
         return null;
     }

commit b979db4e7215957f03c4221622f0b115a868439a
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Thu Jan 9 13:54:11 2020 +0000

    Bump Prettier (#17811)
    
    * Bump Prettier
    
    * Reformat
    
    * Use non-deprecated option

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index b6d2fe5caf..eeb0c1caee 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -278,9 +278,7 @@ const forks = Object.freeze({
     // eslint-disable-next-line no-for-of-loops/no-for-of-loops
     for (let rendererInfo of inlinedHostConfigs) {
       if (rendererInfo.entryPoints.indexOf(entry) !== -1) {
-        return `react-reconciler/src/forks/ReactFiberHostConfig.${
-          rendererInfo.shortName
-        }.js`;
+        return `react-reconciler/src/forks/ReactFiberHostConfig.${rendererInfo.shortName}.js`;
       }
     }
     throw new Error(
@@ -308,9 +306,7 @@ const forks = Object.freeze({
         if (!rendererInfo.isServerSupported) {
           return null;
         }
-        return `react-server/src/forks/ReactServerHostConfig.${
-          rendererInfo.shortName
-        }.js`;
+        return `react-server/src/forks/ReactServerHostConfig.${rendererInfo.shortName}.js`;
       }
     }
     throw new Error(
@@ -338,9 +334,7 @@ const forks = Object.freeze({
         if (!rendererInfo.isServerSupported) {
           return null;
         }
-        return `react-server/src/forks/ReactServerFormatConfig.${
-          rendererInfo.shortName
-        }.js`;
+        return `react-server/src/forks/ReactServerFormatConfig.${rendererInfo.shortName}.js`;
       }
     }
     throw new Error(
@@ -368,9 +362,7 @@ const forks = Object.freeze({
         if (!rendererInfo.isServerSupported) {
           return null;
         }
-        return `react-flight/src/forks/ReactFlightClientHostConfig.${
-          rendererInfo.shortName
-        }.js`;
+        return `react-flight/src/forks/ReactFlightClientHostConfig.${rendererInfo.shortName}.js`;
       }
     }
     throw new Error(

commit 3e9251d605692e6db6103e4fca9771ac30a62247
Author: Sunil Pai <threepointone@gmail.com>
Date:   Mon Feb 3 23:31:31 2020 +0000

    make testing builds for React/ReactDOM (#17915)
    
    This PR introduces adds `react/testing` and `react-dom/testing`.
    - changes infra to generate these builds
    - exports act on ReactDOM in these testing builds
    - uses the new test builds in fixtures/dom
    
    In the next PR -
    
    - I'll use the new builds for all our own tests
    - I'll replace usages of TestUtils.act with ReactDOM.act.

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index eeb0c1caee..9f1f3c41bd 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -1,23 +1,23 @@
 'use strict';
 
-const bundleTypes = require('./bundles').bundleTypes;
-const moduleTypes = require('./bundles').moduleTypes;
+const {bundleTypes, moduleTypes} = require('./bundles');
 const inlinedHostConfigs = require('../shared/inlinedHostConfigs');
 
-const UMD_DEV = bundleTypes.UMD_DEV;
-const UMD_PROD = bundleTypes.UMD_PROD;
-const UMD_PROFILING = bundleTypes.UMD_PROFILING;
-const FB_WWW_DEV = bundleTypes.FB_WWW_DEV;
-const FB_WWW_PROD = bundleTypes.FB_WWW_PROD;
-const FB_WWW_PROFILING = bundleTypes.FB_WWW_PROFILING;
-const RN_OSS_DEV = bundleTypes.RN_OSS_DEV;
-const RN_OSS_PROD = bundleTypes.RN_OSS_PROD;
-const RN_OSS_PROFILING = bundleTypes.RN_OSS_PROFILING;
-const RN_FB_DEV = bundleTypes.RN_FB_DEV;
-const RN_FB_PROD = bundleTypes.RN_FB_PROD;
-const RN_FB_PROFILING = bundleTypes.RN_FB_PROFILING;
-const RENDERER = moduleTypes.RENDERER;
-const RECONCILER = moduleTypes.RECONCILER;
+const {
+  UMD_DEV,
+  UMD_PROD,
+  UMD_PROFILING,
+  FB_WWW_DEV,
+  FB_WWW_PROD,
+  FB_WWW_PROFILING,
+  RN_OSS_DEV,
+  RN_OSS_PROD,
+  RN_OSS_PROFILING,
+  RN_FB_DEV,
+  RN_FB_PROD,
+  RN_FB_PROFILING,
+} = bundleTypes;
+const {RENDERER, RECONCILER} = moduleTypes;
 
 // If you need to replace a file with another file for a specific environment,
 // add it to this list with the logic for choosing the right replacement.
@@ -46,7 +46,7 @@ const forks = Object.freeze({
   // Without this fork, importing `shared/ReactSharedInternals` inside
   // the `react` package itself would not work due to a cyclical dependency.
   'shared/ReactSharedInternals': (bundleType, entry, dependencies) => {
-    if (entry === 'react') {
+    if (entry === 'react' || entry === 'react/testing') {
       return 'react/src/ReactSharedInternals';
     }
     if (dependencies.indexOf('react') === -1) {
@@ -106,6 +106,10 @@ const forks = Object.freeze({
             return 'shared/forks/ReactFeatureFlags.test-renderer.www.js';
         }
         return 'shared/forks/ReactFeatureFlags.test-renderer.js';
+      case 'react-dom/testing':
+        return 'shared/forks/ReactFeatureFlags.testing.js';
+      case 'react/testing':
+        return 'shared/forks/ReactFeatureFlags.testing.js';
       default:
         switch (bundleType) {
           case FB_WWW_DEV:

commit 8777b44e982e7ddedda62aee02f1fd370795db44
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Thu Feb 13 20:33:53 2020 +0000

    Add Modern WWW build (#18028)
    
    * Build both stable and experimental WWW builds
    
    * Flip already experimental WWW flags to true
    
    * Remove FB-specific internals from modern FB builds
    
    We think we're not going to need these.
    
    * Disable classic features in modern WWW builds
    
    * Disable legacy ReactDOM API for modern WWW build
    
    * Don’t include user timing in prod
    
    * Fix bad copy paste and add missing flags to test renderer
    
    * Add testing WWW feature flag file
    
    We need it because WWW has a different meaning of experimental now.

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 9f1f3c41bd..27b3c97a51 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -107,8 +107,13 @@ const forks = Object.freeze({
         }
         return 'shared/forks/ReactFeatureFlags.test-renderer.js';
       case 'react-dom/testing':
-        return 'shared/forks/ReactFeatureFlags.testing.js';
       case 'react/testing':
+        switch (bundleType) {
+          case FB_WWW_DEV:
+          case FB_WWW_PROD:
+          case FB_WWW_PROFILING:
+            return 'shared/forks/ReactFeatureFlags.testing.www.js';
+        }
         return 'shared/forks/ReactFeatureFlags.testing.js';
       default:
         switch (bundleType) {

commit d28bd2994b749c70233334f4105574b692e74980
Author: Sunil Pai <threepointone@gmail.com>
Date:   Wed Feb 26 13:12:55 2020 +0000

    remove OSS testing builds (#18138)
    
    The testing build versions of react-dom are included in the builds right now, but we're not ready to share them yet. This PR removes them for now (back soon for the next release)

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 27b3c97a51..aa0938b7d5 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -46,7 +46,7 @@ const forks = Object.freeze({
   // Without this fork, importing `shared/ReactSharedInternals` inside
   // the `react` package itself would not work due to a cyclical dependency.
   'shared/ReactSharedInternals': (bundleType, entry, dependencies) => {
-    if (entry === 'react' || entry === 'react/testing') {
+    if (entry === 'react') {
       return 'react/src/ReactSharedInternals';
     }
     if (dependencies.indexOf('react') === -1) {
@@ -107,7 +107,6 @@ const forks = Object.freeze({
         }
         return 'shared/forks/ReactFeatureFlags.test-renderer.js';
       case 'react-dom/testing':
-      case 'react/testing':
         switch (bundleType) {
           case FB_WWW_DEV:
           case FB_WWW_PROD:

commit 58eedbb024d188081e20bee1514d794d731873ad
Author: Sebastian Markbåge <sebastian@calyptus.eu>
Date:   Fri Feb 28 11:14:09 2020 -0800

    Check in a forked version of object-assign only for UMD builds (#18180)
    
    * Check in a forked version of object-assign
    
    This one uses ES modules so that we can inline it into UMD builds.
    
    We could wait for object-assign to make an ESM export but we're going to
    remove this dependency and assume global polyfills in the next version
    anyway. However, we'd have to figure out how to keep the copyright header
    and it'll get counted in terms of byte size (even if other tooling removes
    it).
    
    A lot of headache when we have our own implementation anyway. So I'll just
    use that.
    
    Ours is not resilient to checking certain browser bugs but those browsers
    are mostly unused anyway. (Even FB breaks on them presumably.)
    
    We also don't need to be resilient to Symbols since the way React uses it
    we shouldn't need to copy symbols
    
    * Don't transpile Object.assign to object-assign in object-assign
    
    The polyfill needs to be able to feature detect Object.assign.

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index aa0938b7d5..1fbbd0ffed 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -22,8 +22,8 @@ const {RENDERER, RECONCILER} = moduleTypes;
 // If you need to replace a file with another file for a specific environment,
 // add it to this list with the logic for choosing the right replacement.
 const forks = Object.freeze({
-  // Optimization: for UMDs, use object-assign polyfill that is already a part
-  // of the React package instead of bundling it again.
+  // Optimization: for UMDs, use a version that we can inline into the React bundle.
+  // Use that from all other bundles.
   'object-assign': (bundleType, entry, dependencies) => {
     if (
       bundleType !== UMD_DEV &&
@@ -34,12 +34,16 @@ const forks = Object.freeze({
       // happens. Other bundles just require('object-assign') anyway.
       return null;
     }
+    if (entry === 'react') {
+      // Use the forked version that uses ES modules instead of CommonJS.
+      return 'shared/forks/object-assign.inline-umd.js';
+    }
     if (dependencies.indexOf('react') === -1) {
       // We can only apply the optimizations to bundle that depend on React
       // because we read assign() from an object exposed on React internals.
       return null;
     }
-    // We can use the fork!
+    // We can use the fork that reads the secret export!
     return 'shared/forks/object-assign.umd.js';
   },
 

commit 7a1691cdff209249b49a4472ba87b542980a5f71
Author: Sebastian Markbåge <sebastian@calyptus.eu>
Date:   Fri Mar 6 16:20:42 2020 -0800

    Refactor Host Config Infra (getting rid of .inline*.js) (#18240)
    
    * Require deep for reconcilers
    
    * Delete inline* files
    
    * Delete react-reconciler/persistent
    
    This no longer makes any sense because it react-reconciler takes
    supportsMutation or supportsPersistence as options. It's no longer based
    on feature flags.
    
    * Fix jest mocking
    
    * Fix Flow strategy
    
    We now explicitly list which paths we want to be checked by a renderer.
    For every other renderer config we ignore those paths.
    
    Nothing is "any" typed. So if some transitive dependency isn't reachable
    it won't be accidentally "any" that leaks.

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 1fbbd0ffed..a69629936b 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -100,8 +100,6 @@ const forks = Object.freeze({
               `Unexpected entry (${entry}) and bundleType (${bundleType})`
             );
         }
-      case 'react-reconciler/persistent':
-        return 'shared/forks/ReactFeatureFlags.persistent.js';
       case 'react-test-renderer':
         switch (bundleType) {
           case FB_WWW_DEV:

commit bdc5cc4635f13e5ca43883a9f9587fc9a868c528
Author: Sebastian Markbåge <sebastian@calyptus.eu>
Date:   Sat Mar 7 11:23:30 2020 -0800

    Add Relay Flight Build (#18242)
    
    * Rename to clarify that it's client-only
    
    * Rename FizzStreamer to FizzServer for consistency
    
    * Rename react-flight to react-client/flight
    
    For consistency with react-server. Currently this just includes flight
    but it could be expanded to include the whole reconciler.
    
    * Add Relay Flight Build
    
    * Rename ReactServerHostConfig to ReactServerStreamConfig
    
    This will be the config specifically for streaming purposes.
    There will be other configs for other purposes.

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index a69629936b..105eb25853 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -298,7 +298,7 @@ const forks = Object.freeze({
     );
   },
 
-  'react-server/src/ReactServerHostConfig': (
+  'react-server/src/ReactServerStreamConfig': (
     bundleType,
     entry,
     dependencies,
@@ -316,11 +316,11 @@ const forks = Object.freeze({
         if (!rendererInfo.isServerSupported) {
           return null;
         }
-        return `react-server/src/forks/ReactServerHostConfig.${rendererInfo.shortName}.js`;
+        return `react-server/src/forks/ReactServerStreamConfig.${rendererInfo.shortName}.js`;
       }
     }
     throw new Error(
-      'Expected ReactServerHostConfig to always be replaced with a shim, but ' +
+      'Expected ReactServerStreamConfig to always be replaced with a shim, but ' +
         `found no mention of "${entry}" entry point in ./scripts/shared/inlinedHostConfigs.js. ` +
         'Did you mean to add it there to associate it with a specific renderer?'
     );
@@ -354,13 +354,13 @@ const forks = Object.freeze({
     );
   },
 
-  'react-flight/src/ReactFlightClientHostConfig': (
+  'react-client/src/ReactFlightClientHostConfig': (
     bundleType,
     entry,
     dependencies,
     moduleType
   ) => {
-    if (dependencies.indexOf('react-flight') !== -1) {
+    if (dependencies.indexOf('react-client') !== -1) {
       return null;
     }
     if (moduleType !== RENDERER && moduleType !== RECONCILER) {
@@ -372,7 +372,7 @@ const forks = Object.freeze({
         if (!rendererInfo.isServerSupported) {
           return null;
         }
-        return `react-flight/src/forks/ReactFlightClientHostConfig.${rendererInfo.shortName}.js`;
+        return `react-client/src/forks/ReactFlightClientHostConfig.${rendererInfo.shortName}.js`;
       }
     }
     throw new Error(

commit 99d73718636d7930a2abf0030c51c1d7710b13d8
Author: Sebastian Markbåge <sebastian@calyptus.eu>
Date:   Tue Mar 10 14:55:04 2020 -0700

    [Flight] Split Streaming from Relay Implemenation (#18260)
    
    * Add ReactFlightServerConfig intermediate
    
    This just forwards to the stream version of Flight which is itself forked
    between Node and W3C streams.
    
    The dom-relay goes directly to the Relay config though which allows it to
    avoid the stream part of Flight.
    
    * Separate streaming protocol into the Stream config
    
    * Split streaming parts into the ReactFlightServerConfigStream
    
    This decouples it so that the Relay implementation doesn't have to encode
    the JSON to strings. Instead it can be fed the values as JSON objects and
    do its own encoding.
    
    * Split FlightClient into a basic part and a stream part
    
    Same split as the server.
    
    * Expose lower level async hooks to Relay
    
    This requires an external helper file that we'll wire up internally.

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 105eb25853..35a7977093 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -354,6 +354,34 @@ const forks = Object.freeze({
     );
   },
 
+  'react-server/src/ReactFlightServerConfig': (
+    bundleType,
+    entry,
+    dependencies,
+    moduleType
+  ) => {
+    if (dependencies.indexOf('react-server') !== -1) {
+      return null;
+    }
+    if (moduleType !== RENDERER && moduleType !== RECONCILER) {
+      return null;
+    }
+    // eslint-disable-next-line no-for-of-loops/no-for-of-loops
+    for (let rendererInfo of inlinedHostConfigs) {
+      if (rendererInfo.entryPoints.indexOf(entry) !== -1) {
+        if (!rendererInfo.isServerSupported) {
+          return null;
+        }
+        return `react-server/src/forks/ReactFlightServerConfig.${rendererInfo.shortName}.js`;
+      }
+    }
+    throw new Error(
+      'Expected ReactFlightServerConfig to always be replaced with a shim, but ' +
+        `found no mention of "${entry}" entry point in ./scripts/shared/inlinedHostConfigs.js. ` +
+        'Did you mean to add it there to associate it with a specific renderer?'
+    );
+  },
+
   'react-client/src/ReactFlightClientHostConfig': (
     bundleType,
     entry,

commit cd48a06547390ae426a70d555ec9fd5349c85d08
Author: Andrew Clark <git@andrewclark.io>
Date:   Thu Mar 12 11:38:32 2020 -0700

    Set up infra for react-reconciler fork (#18285)
    
    * ReactFiberReconciler -> ReactFiberReconciler.old
    
    * Set up infra for react-reconciler fork
    
    We're planning to land some significant refactors of the reconciler.
    We want to be able to gradually roll out the new implementation side-by-
    side with the existing one. So we'll create a short lived fork of the
    react-reconciler package. Once the new implementation has stabilized,
    we'll delete the old implementation and promote the new one.
    
    This means, for as long as the fork exists, we'll need to maintain two
    separate implementations. This sounds painful, but since the forks will
    still be largely the same, most changes will not require two separate
    implementations. In practice, you'll implement the change in the old
    fork and then copy paste it to the new one.
    
    This commit only sets up the build and testing infrastructure. It does
    not actually fork any modules. I'll do that in subsequent PRs.
    
    The forked version of the reconciler will be used to build a special
    version of React DOM. I've called this build ReactDOMForked. It's only
    built for www; there's no open source version.
    
    The new reconciler is disabled by default. It's enabled in the
    `yarn test-www-variant` command. The reconciler fork isn't really
    related to the "variant" feature of the www builds, but I'm piggy
    backing on that concept to avoid having to add yet another
    testing dimension.

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 35a7977093..01fd4fee5a 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -246,6 +246,27 @@ const forks = Object.freeze({
     }
   },
 
+  'react-reconciler/src/ReactFiberReconciler': (
+    bundleType,
+    entry,
+    dependencies,
+    moduleType,
+    bundle
+  ) => {
+    if (bundle.enableNewReconciler) {
+      switch (bundleType) {
+        case FB_WWW_DEV:
+        case FB_WWW_PROD:
+        case FB_WWW_PROFILING:
+          // Use the forked version of the reconciler
+          // TODO: Update this to point to the new module, once it exists
+          return 'react-reconciler/src/ReactFiberReconciler.old.js';
+      }
+    }
+    // Otherwise, use the non-forked version.
+    return 'react-reconciler/src/ReactFiberReconciler.old.js';
+  },
+
   // Different dialogs for caught errors.
   'react-reconciler/src/ReactFiberErrorDialog': (bundleType, entry) => {
     switch (bundleType) {

commit 9240918536f38ae50dfd86cae4e60bfc590d04ea
Author: Minh Nguyen <minhnguyenxx@gmail.com>
Date:   Tue Mar 17 00:35:28 2020 +0000

    Bump react-shallow-renderer to 16.13.1 (#18187)

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 01fd4fee5a..61a5f00b92 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -47,6 +47,11 @@ const forks = Object.freeze({
     return 'shared/forks/object-assign.umd.js';
   },
 
+  'react-shallow-renderer': () => {
+    // Use ESM build of `react-shallow-renderer`.
+    return 'react-shallow-renderer/esm/index.js';
+  },
+
   // Without this fork, importing `shared/ReactSharedInternals` inside
   // the `react` package itself would not work due to a cyclical dependency.
   'shared/ReactSharedInternals': (bundleType, entry, dependencies) => {

commit 90f8fe6f5509cab7d6d280b4ed17181697f394e9
Author: Luna Ruan <luna@fb.com>
Date:   Tue Mar 17 13:22:19 2020 -0700

    add jsx-runtime and jsx-dev-runtime (#18299)
    
    This PR adds the jsx-runtime and jsx-dev-runtime modules for the JSX Babel Plugin. WWW still relies on jsx/jsxs/jsxDEV from the "react" module, so once we refactor the code to point to the runtime modules we will remove jsx/jsxs/jsxDEV from the "react" module.

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 61a5f00b92..4f443f154f 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -58,7 +58,7 @@ const forks = Object.freeze({
     if (entry === 'react') {
       return 'react/src/ReactSharedInternals';
     }
-    if (dependencies.indexOf('react') === -1) {
+    if (!entry.startsWith('react/') && dependencies.indexOf('react') === -1) {
       // React internals are unavailable if we can't reference the package.
       // We return an error because we only want to throw if this module gets used.
       return new Error(

commit 94505b961332d9295c3f6da33d51219d126bf04f
Author: Sebastian Markbåge <sebastian@calyptus.eu>
Date:   Wed Mar 18 06:13:50 2020 -0700

    Don't use EventListener Fork in Modern WWW Builds (#18333)
    
    * Move unsubscribe fork to EventListener
    
    That way we can statically compile out more of these indirections.
    
    * Don't use the EventListener fork for Modern WWW builds

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 4f443f154f..34fa68a94e 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -19,6 +19,15 @@ const {
 } = bundleTypes;
 const {RENDERER, RECONCILER} = moduleTypes;
 
+const RELEASE_CHANNEL = process.env.RELEASE_CHANNEL;
+
+// Default to building in experimental mode. If the release channel is set via
+// an environment variable, then check if it's "experimental".
+const __EXPERIMENTAL__ =
+  typeof RELEASE_CHANNEL === 'string'
+    ? RELEASE_CHANNEL === 'experimental'
+    : true;
+
 // If you need to replace a file with another file for a specific environment,
 // add it to this list with the logic for choosing the right replacement.
 const forks = Object.freeze({
@@ -442,8 +451,13 @@ const forks = Object.freeze({
       case FB_WWW_DEV:
       case FB_WWW_PROD:
       case FB_WWW_PROFILING:
-        // Use the www fork which is integrated with TimeSlice profiling.
-        return 'react-dom/src/events/forks/EventListener-www.js';
+        if (__EXPERIMENTAL__) {
+          // In modern builds we don't use the indirection. We just use raw DOM.
+          return null;
+        } else {
+          // Use the www fork which is integrated with TimeSlice profiling.
+          return 'react-dom/src/events/forks/EventListener-www.js';
+        }
       default:
         return null;
     }

commit d686f3f16a796025ce32cfb431b70eef6de1934e
Author: Andrew Clark <git@andrewclark.io>
Date:   Wed Apr 8 19:44:52 2020 -0700

    Add `.old` prefix to reconciler modules

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 34fa68a94e..2754d47c81 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -281,6 +281,27 @@ const forks = Object.freeze({
     return 'react-reconciler/src/ReactFiberReconciler.old.js';
   },
 
+  'react-reconciler/src/ReactFiberHotReloading': (
+    bundleType,
+    entry,
+    dependencies,
+    moduleType,
+    bundle
+  ) => {
+    if (bundle.enableNewReconciler) {
+      switch (bundleType) {
+        case FB_WWW_DEV:
+        case FB_WWW_PROD:
+        case FB_WWW_PROFILING:
+          // Use the forked version of the reconciler
+          // TODO: Update this to point to the new module, once it exists
+          return 'react-reconciler/src/ReactFiberHotReloading.old.js';
+      }
+    }
+    // Otherwise, use the non-forked version.
+    return 'react-reconciler/src/ReactFiberHotReloading.old.js';
+  },
+
   // Different dialogs for caught errors.
   'react-reconciler/src/ReactFiberErrorDialog': (bundleType, entry) => {
     switch (bundleType) {

commit 4c6470cb3b821f3664955290cd4c4c7ac0de733a
Author: Andrew Clark <git@andrewclark.io>
Date:   Wed Apr 8 23:13:04 2020 -0700

    Point ReactDOMForked to the new implementation
    
    Updates Rollup, Jest, and Flow configuration to point to the new
    entry points.

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 2754d47c81..b0319333ea 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -273,8 +273,7 @@ const forks = Object.freeze({
         case FB_WWW_PROD:
         case FB_WWW_PROFILING:
           // Use the forked version of the reconciler
-          // TODO: Update this to point to the new module, once it exists
-          return 'react-reconciler/src/ReactFiberReconciler.old.js';
+          return 'react-reconciler/src/ReactFiberReconciler.new.js';
       }
     }
     // Otherwise, use the non-forked version.
@@ -294,8 +293,7 @@ const forks = Object.freeze({
         case FB_WWW_PROD:
         case FB_WWW_PROFILING:
           // Use the forked version of the reconciler
-          // TODO: Update this to point to the new module, once it exists
-          return 'react-reconciler/src/ReactFiberHotReloading.old.js';
+          return 'react-reconciler/src/ReactFiberHotReloading.new.js';
       }
     }
     // Otherwise, use the non-forked version.

commit b231445f969709fe2da1e66cbc2630c314a16807
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Wed Jul 1 16:20:49 2020 +0100

    Move responder tests and remove dead code (#19226)

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index b0319333ea..80f1b724aa 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -481,14 +481,6 @@ const forks = Object.freeze({
         return null;
     }
   },
-
-  // React DOM uses different top level event names and supports mouse events.
-  'legacy-events/ResponderTopLevelEventTypes': (bundleType, entry) => {
-    if (entry === 'react-dom' || entry.startsWith('react-dom/')) {
-      return 'legacy-events/forks/ResponderTopLevelEventTypes.dom.js';
-    }
-    return null;
-  },
 });
 
 module.exports = forks;

commit 52c51462744ac6a9437d64ae84fcd94eacbb8aa8
Author: Rick Hanlon <rickhanlonii@gmail.com>
Date:   Tue Jul 28 11:11:31 2020 -0400

    Add SchedulerHostConfig fork for post task (#19470)

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 80f1b724aa..5f2744e65b 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -198,6 +198,8 @@ const forks = Object.freeze({
       entry === 'react-test-renderer'
     ) {
       return 'scheduler/src/forks/SchedulerHostConfig.mock';
+    } else if (entry === 'scheduler/unstable_post_task') {
+      return 'scheduler/src/forks/SchedulerHostConfig.post-task';
     }
     return 'scheduler/src/forks/SchedulerHostConfig.default';
   },

commit 74cd7e5f17e801f89c88689ecd9560a342b95c2c
Author: Rick Hanlon <rickhanlonii@gmail.com>
Date:   Wed Jul 29 16:31:05 2020 -0400

    Use feature flags for React Native in the test renderer (#19486)

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 5f2744e65b..f3884185e7 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -116,6 +116,13 @@ const forks = Object.freeze({
         }
       case 'react-test-renderer':
         switch (bundleType) {
+          case RN_FB_DEV:
+          case RN_FB_PROD:
+          case RN_FB_PROFILING:
+          case RN_OSS_DEV:
+          case RN_OSS_PROD:
+          case RN_OSS_PROFILING:
+            return 'shared/forks/ReactFeatureFlags.test-renderer.native.js';
           case FB_WWW_DEV:
           case FB_WWW_PROD:
           case FB_WWW_PROFILING:

commit 86314d5b458348c06df810a67605e8dad1133dd1
Author: Rick Hanlon <rickhanlonii@gmail.com>
Date:   Mon Aug 3 14:45:50 2020 -0400

    Turn off new component stacks for React Native (#19521)

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index f3884185e7..04cf06615d 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -137,6 +137,19 @@ const forks = Object.freeze({
             return 'shared/forks/ReactFeatureFlags.testing.www.js';
         }
         return 'shared/forks/ReactFeatureFlags.testing.js';
+      case 'react':
+        switch (bundleType) {
+          case FB_WWW_DEV:
+          case FB_WWW_PROD:
+          case FB_WWW_PROFILING:
+            return 'shared/forks/ReactFeatureFlags.www.js';
+          case RN_FB_DEV:
+          case RN_FB_PROD:
+          case RN_FB_PROFILING:
+            return 'shared/forks/ReactFeatureFlags.native-fb.js';
+          default:
+            return 'shared/ReactFeatureFlags.js';
+        }
       default:
         switch (bundleType) {
           case FB_WWW_DEV:

commit a437f3ff302dc92347d812d518c9a9659d9aa546
Author: Rick Hanlon <rickhanlonii@gmail.com>
Date:   Mon Aug 3 17:40:58 2020 -0400

    Use RN fork in default branch of feature flags (#19522)

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 04cf06615d..ecbbcd981e 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -137,7 +137,7 @@ const forks = Object.freeze({
             return 'shared/forks/ReactFeatureFlags.testing.www.js';
         }
         return 'shared/forks/ReactFeatureFlags.testing.js';
-      case 'react':
+      default:
         switch (bundleType) {
           case FB_WWW_DEV:
           case FB_WWW_PROD:
@@ -147,15 +147,6 @@ const forks = Object.freeze({
           case RN_FB_PROD:
           case RN_FB_PROFILING:
             return 'shared/forks/ReactFeatureFlags.native-fb.js';
-          default:
-            return 'shared/ReactFeatureFlags.js';
-        }
-      default:
-        switch (bundleType) {
-          case FB_WWW_DEV:
-          case FB_WWW_PROD:
-          case FB_WWW_PROFILING:
-            return 'shared/forks/ReactFeatureFlags.www.js';
         }
     }
     return null;

commit b8ed6a1aa580e4de80f707293015d638d3252d63
Author: Andrew Clark <git@andrewclark.io>
Date:   Wed Aug 12 08:39:47 2020 -0500

    [Scheduler] Call postTask directly (#19551)
    
    This updates the experimental Scheduler postTask build to call postTask
    directly, instead of managing our own custom queue and work loop.
    
    We still use a deadline 5ms mechanism to implement `shouldYield`.
    
    The main thing that postTask is currently missing is the continuation
    feature — when yielding to the main thread, the yielding task is sent
    to the back of the queue, instead of maintaining its position.
    
    While this would be nice to have, even without it, postTask may be good
    enough to replace our userspace implementation.
    
    We'll run some tests to see.

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index ecbbcd981e..e34daab32c 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -209,8 +209,6 @@ const forks = Object.freeze({
       entry === 'react-test-renderer'
     ) {
       return 'scheduler/src/forks/SchedulerHostConfig.mock';
-    } else if (entry === 'scheduler/unstable_post_task') {
-      return 'scheduler/src/forks/SchedulerHostConfig.post-task';
     }
     return 'scheduler/src/forks/SchedulerHostConfig.default';
   },

commit 454c2211c09bfa2fd5475c25665f3bbeb6882841
Author: Rick Hanlon <rickhanlonii@gmail.com>
Date:   Mon Nov 2 12:46:58 2020 -0500

    Refactor SchedulerHostConfigs (#20025)
    
    * Remove SchedulerHostConfigs
    
    * Fix builds
    
    * Fix forks
    
    * Move SchedulerNoDom check to npm/index.js
    
    * Fix tests
    
    * Add @gate source
    
    * Gate build-only test to build test runs

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index e34daab32c..03437e1f31 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -201,18 +201,6 @@ const forks = Object.freeze({
     return 'scheduler/src/SchedulerFeatureFlags';
   },
 
-  'scheduler/src/SchedulerHostConfig': (bundleType, entry, dependencies) => {
-    if (
-      entry === 'scheduler/unstable_mock' ||
-      entry === 'react-noop-renderer' ||
-      entry === 'react-noop-renderer/persistent' ||
-      entry === 'react-test-renderer'
-    ) {
-      return 'scheduler/src/forks/SchedulerHostConfig.mock';
-    }
-    return 'scheduler/src/forks/SchedulerHostConfig.default';
-  },
-
   'shared/consoleWithStackDev': (bundleType, entry) => {
     switch (bundleType) {
       case FB_WWW_DEV:

commit d93b58a5e38cf06998da628932029291cc605c2d
Author: Sebastian Markbåge <sebastian@calyptus.eu>
Date:   Fri Nov 20 11:47:13 2020 -0500

    Add flight specific entry point for react package (#20304)
    
    This configures the Flight fixture to use the "react-server" environment.
    
    This allows the package.json exports field to specify a different resolution
    in this environment.
    
    I use this in the "react" package to resolve to a new bundle that excludes
    the Hooks that aren't relevant in this environment like useState and useEffect.
    
    This allows us to error early if these names are imported. If we actually
    published ESM, it would we a static error. Now it's a runtime error.
    
    You can test this by importing useState in Container.js which is used
    by the client and server.

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 03437e1f31..4651b3fa86 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -43,7 +43,7 @@ const forks = Object.freeze({
       // happens. Other bundles just require('object-assign') anyway.
       return null;
     }
-    if (entry === 'react') {
+    if (entry === 'react' || entry === 'react/unstable-index.server') {
       // Use the forked version that uses ES modules instead of CommonJS.
       return 'shared/forks/object-assign.inline-umd.js';
     }
@@ -64,8 +64,8 @@ const forks = Object.freeze({
   // Without this fork, importing `shared/ReactSharedInternals` inside
   // the `react` package itself would not work due to a cyclical dependency.
   'shared/ReactSharedInternals': (bundleType, entry, dependencies) => {
-    if (entry === 'react') {
-      return 'react/src/ReactSharedInternals';
+    if (entry === 'react' || entry === 'react/unstable-index.server') {
+      return 'react/src/ReactSharedInternals.js';
     }
     if (!entry.startsWith('react/') && dependencies.indexOf('react') === -1) {
       // React internals are unavailable if we can't reference the package.

commit 842ee367e620d322e67262d67e892b17712998f8
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Thu Dec 10 02:14:50 2020 +0000

    [Flight] Rename the shared entry point (#20420)
    
    * [Flight] Rename the shared entry point
    
    * Shared

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 4651b3fa86..af295ad53c 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -43,7 +43,7 @@ const forks = Object.freeze({
       // happens. Other bundles just require('object-assign') anyway.
       return null;
     }
-    if (entry === 'react' || entry === 'react/unstable-index.server') {
+    if (entry === 'react' || entry === 'react/unstable-shared-subset') {
       // Use the forked version that uses ES modules instead of CommonJS.
       return 'shared/forks/object-assign.inline-umd.js';
     }
@@ -64,7 +64,7 @@ const forks = Object.freeze({
   // Without this fork, importing `shared/ReactSharedInternals` inside
   // the `react` package itself would not work due to a cyclical dependency.
   'shared/ReactSharedInternals': (bundleType, entry, dependencies) => {
-    if (entry === 'react' || entry === 'react/unstable-index.server') {
+    if (entry === 'react' || entry === 'react/unstable-shared-subset') {
       return 'react/src/ReactSharedInternals.js';
     }
     if (!entry.startsWith('react/') && dependencies.indexOf('react') === -1) {

commit d0eaf782930b6e6c575f50bf688e667b9f6795b7
Author: Andrew Clark <git@andrewclark.io>
Date:   Tue Mar 23 15:57:28 2021 -0500

    Move priorities to separate import to break cycle (#21060)
    
    The event priority constants exports by the reconciler package are
    meant to be used by the reconciler (host config) itself. So it doesn't
    make sense to export them from a module that requires them.
    
    To break the cycle, we can move them to a separate module and import
    that. This looks like a "deep import" of an internal module, which we
    try to avoid, but conceptually these are part of the public interface
    of the reconciler module. So, no different than importing from the main
    `react-reconciler`.
    
    We do need to be careful about not mixing these types of imports with
    implementation details. Those are the ones to really avoid.
    
    An unintended benefit of the reconciler fork infra is that it makes
    deep imports harder. Any module that we treat as "public", like this
    one, needs to account for the `enableNewReconciler` flag and forward
    to the correct implementation.

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index af295ad53c..2c64c6219e 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -279,6 +279,26 @@ const forks = Object.freeze({
     return 'react-reconciler/src/ReactFiberReconciler.old.js';
   },
 
+  'react-reconciler/src/ReactEventPriorities': (
+    bundleType,
+    entry,
+    dependencies,
+    moduleType,
+    bundle
+  ) => {
+    if (bundle.enableNewReconciler) {
+      switch (bundleType) {
+        case FB_WWW_DEV:
+        case FB_WWW_PROD:
+        case FB_WWW_PROFILING:
+          // Use the forked version of the reconciler
+          return 'react-reconciler/src/ReactEventPriorities.new.js';
+      }
+    }
+    // Otherwise, use the non-forked version.
+    return 'react-reconciler/src/ReactEventPriorities.old.js';
+  },
+
   'react-reconciler/src/ReactFiberHotReloading': (
     bundleType,
     entry,

commit fc33f12bdee1d0ffbcc83d25199cdf4d47252736
Author: Brian Vaughn <bvaughn@fb.com>
Date:   Mon Apr 26 19:16:18 2021 -0400

    Remove unstable scheduler/tracing API (#20037)

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 2c64c6219e..84211da5c5 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -171,25 +171,6 @@ const forks = Object.freeze({
     }
   },
 
-  'scheduler/tracing': (bundleType, entry, dependencies) => {
-    switch (bundleType) {
-      case UMD_DEV:
-      case UMD_PROD:
-      case UMD_PROFILING:
-        if (dependencies.indexOf('react') === -1) {
-          // It's only safe to use this fork for modules that depend on React,
-          // because they read the re-exported API from the SECRET_INTERNALS object.
-          return null;
-        }
-        // Optimization: for UMDs, use the API that is already a part of the React
-        // package instead of requiring it to be loaded via a separate <script> tag
-        return 'shared/forks/SchedulerTracing.umd.js';
-      default:
-        // For other bundles, use the shared NPM package.
-        return null;
-    }
-  },
-
   'scheduler/src/SchedulerFeatureFlags': (bundleType, entry, dependencies) => {
     if (
       bundleType === FB_WWW_DEV ||

commit 6bce0355c3e4bf23c16e82317094230908ee7560
Author: Andrew Clark <git@andrewclark.io>
Date:   Sun Oct 31 18:38:03 2021 -0400

    Upgrade useSyncExternalStore to alpha channel (#22662)
    
    * Move useSyncExternalStore shim to a nested entrypoint
    
    Also renames `useSyncExternalStoreExtra` to
    `useSyncExternalStoreWithSelector`.
    
    - 'use-sync-external-store/shim' -> A shim for `useSyncExternalStore`
      that works in React 16 and 17 (any release that supports hooks). The
      module will first check if the built-in React API exists, before
      falling back to the shim.
    - 'use-sync-external-store/with-selector' -> An extended version of
      `useSyncExternalStore` that also supports `selector` and `isEqual`
      options. It does _not_ shim `use-sync-external-store`; it composes the
      built-in React API. **Use this if you only support 18+.**
    - 'use-sync-external-store/shim/with-selector' -> Same API, but it
      composes `use-sync-external-store/shim` instead. **Use this for
      compatibility with 16 and 17.**
    - 'use-sync-external-store' -> Re-exports React's built-in API. Not
      meant to be used. It will warn and direct users to either the shim or
      the built-in API.
    
    * Upgrade useSyncExternalStore to alpha channel

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 84211da5c5..b2234fa42a 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -481,6 +481,24 @@ const forks = Object.freeze({
         return null;
     }
   },
+
+  'use-sync-external-store/src/useSyncExternalStore': (bundleType, entry) => {
+    if (entry.startsWith('use-sync-external-store/shim')) {
+      return 'use-sync-external-store/src/forks/useSyncExternalStore.forward-to-shim';
+    }
+    if (entry !== 'use-sync-external-store') {
+      // Internal modules that aren't shims should use the native API from the
+      // react package.
+      return 'use-sync-external-store/src/forks/useSyncExternalStore.forward-to-built-in';
+    }
+    return null;
+  },
+
+  'use-sync-external-store/src/isServerEnvironment': (bundleType, entry) => {
+    if (entry.endsWith('.native')) {
+      return 'use-sync-external-store/src/forks/isServerEnvironment.native';
+    }
+  },
 });
 
 module.exports = forks;

commit a3bde7974c48cfa749b18531700f895c86cbad91
Author: Sebastian Markbåge <sebastian@calyptus.eu>
Date:   Tue Feb 8 23:12:31 2022 -0500

    Exclude react-dom/unstable_testing entry point from stable releases (#23258)
    
    * Use consistent naming for unstable_testing entry point
    
    * Exclude the testing build from non-experimental builds except at FB
    
    * FB builds shouldn't contribute to whether we include the npm files
    
    * Exclude exports fields if we delete the files entry
    
    * Move test to no longer be internal so we can test against the build
    
    * Update the bundle artifact names since they've now changed
    
    * Gate import since it doesn't exist

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index b2234fa42a..9cab6e5be3 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -129,7 +129,7 @@ const forks = Object.freeze({
             return 'shared/forks/ReactFeatureFlags.test-renderer.www.js';
         }
         return 'shared/forks/ReactFeatureFlags.test-renderer.js';
-      case 'react-dom/testing':
+      case 'react-dom/unstable_testing':
         switch (bundleType) {
           case FB_WWW_DEV:
           case FB_WWW_PROD:

commit 274b9fb168eae1b3e5b83db657eb964d365fc45a
Author: Andrew Clark <git@andrewclark.io>
Date:   Wed Feb 9 08:44:02 2022 -0800

    Remove path resolution from internal forks plugin (#23255)
    
    Alternative to #23254
    
    Our build script has a custom plugin to resolve internal module forks.
    Currently, it uses require.resolve to resolve the path to a real file
    on disk.
    
    Instead, I've updated all the forked module paths to match their
    location on disk, relative to the project root, to remove the need to
    resolve them in the build script's runtime.
    
    The main motivation is because require.resolve doesn't work with ESM
    modules, but aside from that, hardcoding the relative paths is more
    predictable — the Node module resolution algorithm is complicated, and
    we don't really need its features for this purpose.

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 9cab6e5be3..d4a392770b 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -30,10 +30,22 @@ const __EXPERIMENTAL__ =
 
 // If you need to replace a file with another file for a specific environment,
 // add it to this list with the logic for choosing the right replacement.
+
+// Fork paths are relative to the project root. They must include the full path,
+// including the extension. We intentionally don't use Node's module resolution
+// algorithm because 1) require.resolve doesn't work with ESM modules, and 2)
+// the behavior is easier to predict.
 const forks = Object.freeze({
   // Optimization: for UMDs, use a version that we can inline into the React bundle.
   // Use that from all other bundles.
-  'object-assign': (bundleType, entry, dependencies) => {
+
+  // NOTE: This is hard-coded to the main entry point of the (third-party)
+  // object-assign package.
+  './node_modules/object-assign/index.js': (
+    bundleType,
+    entry,
+    dependencies
+  ) => {
     if (
       bundleType !== UMD_DEV &&
       bundleType !== UMD_PROD &&
@@ -45,7 +57,7 @@ const forks = Object.freeze({
     }
     if (entry === 'react' || entry === 'react/unstable-shared-subset') {
       // Use the forked version that uses ES modules instead of CommonJS.
-      return 'shared/forks/object-assign.inline-umd.js';
+      return './packages/shared/forks/object-assign.inline-umd.js';
     }
     if (dependencies.indexOf('react') === -1) {
       // We can only apply the optimizations to bundle that depend on React
@@ -53,19 +65,25 @@ const forks = Object.freeze({
       return null;
     }
     // We can use the fork that reads the secret export!
-    return 'shared/forks/object-assign.umd.js';
+    return './packages/shared/forks/object-assign.umd.js';
   },
 
-  'react-shallow-renderer': () => {
+  // NOTE: This is hard-coded to the main entry point of the (third-party)
+  // react-shallow-renderer package.
+  './node_modules/react-shallow-renderer/index.js': () => {
     // Use ESM build of `react-shallow-renderer`.
-    return 'react-shallow-renderer/esm/index.js';
+    return './node_modules/react-shallow-renderer/esm/index.js';
   },
 
   // Without this fork, importing `shared/ReactSharedInternals` inside
   // the `react` package itself would not work due to a cyclical dependency.
-  'shared/ReactSharedInternals': (bundleType, entry, dependencies) => {
+  './packages/shared/ReactSharedInternals.js': (
+    bundleType,
+    entry,
+    dependencies
+  ) => {
     if (entry === 'react' || entry === 'react/unstable-shared-subset') {
-      return 'react/src/ReactSharedInternals.js';
+      return './packages/react/src/ReactSharedInternals.js';
     }
     if (!entry.startsWith('react/') && dependencies.indexOf('react') === -1) {
       // React internals are unavailable if we can't reference the package.
@@ -82,18 +100,18 @@ const forks = Object.freeze({
   },
 
   // We have a few forks for different environments.
-  'shared/ReactFeatureFlags': (bundleType, entry) => {
+  './packages/shared/ReactFeatureFlags.js': (bundleType, entry) => {
     switch (entry) {
       case 'react-native-renderer':
         switch (bundleType) {
           case RN_FB_DEV:
           case RN_FB_PROD:
           case RN_FB_PROFILING:
-            return 'shared/forks/ReactFeatureFlags.native-fb.js';
+            return './packages/shared/forks/ReactFeatureFlags.native-fb.js';
           case RN_OSS_DEV:
           case RN_OSS_PROD:
           case RN_OSS_PROFILING:
-            return 'shared/forks/ReactFeatureFlags.native-oss.js';
+            return './packages/shared/forks/ReactFeatureFlags.native-oss.js';
           default:
             throw Error(
               `Unexpected entry (${entry}) and bundleType (${bundleType})`
@@ -104,11 +122,11 @@ const forks = Object.freeze({
           case RN_FB_DEV:
           case RN_FB_PROD:
           case RN_FB_PROFILING:
-            return 'shared/forks/ReactFeatureFlags.native-fb.js';
+            return './packages/shared/forks/ReactFeatureFlags.native-fb.js';
           case RN_OSS_DEV:
           case RN_OSS_PROD:
           case RN_OSS_PROFILING:
-            return 'shared/forks/ReactFeatureFlags.native-oss.js';
+            return './packages/shared/forks/ReactFeatureFlags.native-oss.js';
           default:
             throw Error(
               `Unexpected entry (${entry}) and bundleType (${bundleType})`
@@ -122,37 +140,37 @@ const forks = Object.freeze({
           case RN_OSS_DEV:
           case RN_OSS_PROD:
           case RN_OSS_PROFILING:
-            return 'shared/forks/ReactFeatureFlags.test-renderer.native.js';
+            return './packages/shared/forks/ReactFeatureFlags.test-renderer.native.js';
           case FB_WWW_DEV:
           case FB_WWW_PROD:
           case FB_WWW_PROFILING:
-            return 'shared/forks/ReactFeatureFlags.test-renderer.www.js';
+            return './packages/shared/forks/ReactFeatureFlags.test-renderer.www.js';
         }
-        return 'shared/forks/ReactFeatureFlags.test-renderer.js';
+        return './packages/shared/forks/ReactFeatureFlags.test-renderer.js';
       case 'react-dom/unstable_testing':
         switch (bundleType) {
           case FB_WWW_DEV:
           case FB_WWW_PROD:
           case FB_WWW_PROFILING:
-            return 'shared/forks/ReactFeatureFlags.testing.www.js';
+            return './packages/shared/forks/ReactFeatureFlags.testing.www.js';
         }
-        return 'shared/forks/ReactFeatureFlags.testing.js';
+        return './packages/shared/forks/ReactFeatureFlags.testing.js';
       default:
         switch (bundleType) {
           case FB_WWW_DEV:
           case FB_WWW_PROD:
           case FB_WWW_PROFILING:
-            return 'shared/forks/ReactFeatureFlags.www.js';
+            return './packages/shared/forks/ReactFeatureFlags.www.js';
           case RN_FB_DEV:
           case RN_FB_PROD:
           case RN_FB_PROFILING:
-            return 'shared/forks/ReactFeatureFlags.native-fb.js';
+            return './packages/shared/forks/ReactFeatureFlags.native-fb.js';
         }
     }
     return null;
   },
 
-  scheduler: (bundleType, entry, dependencies) => {
+  './packages/scheduler/index.js': (bundleType, entry, dependencies) => {
     switch (bundleType) {
       case UMD_DEV:
       case UMD_PROD:
@@ -164,28 +182,32 @@ const forks = Object.freeze({
         }
         // Optimization: for UMDs, use the API that is already a part of the React
         // package instead of requiring it to be loaded via a separate <script> tag
-        return 'shared/forks/Scheduler.umd.js';
+        return './packages/shared/forks/Scheduler.umd.js';
       default:
         // For other bundles, use the shared NPM package.
         return null;
     }
   },
 
-  'scheduler/src/SchedulerFeatureFlags': (bundleType, entry, dependencies) => {
+  './packages/scheduler/src/SchedulerFeatureFlags.js': (
+    bundleType,
+    entry,
+    dependencies
+  ) => {
     if (
       bundleType === FB_WWW_DEV ||
       bundleType === FB_WWW_PROD ||
       bundleType === FB_WWW_PROFILING
     ) {
-      return 'scheduler/src/forks/SchedulerFeatureFlags.www.js';
+      return './packages/scheduler/src/forks/SchedulerFeatureFlags.www.js';
     }
-    return 'scheduler/src/SchedulerFeatureFlags';
+    return './packages/scheduler/src/SchedulerFeatureFlags.js';
   },
 
-  'shared/consoleWithStackDev': (bundleType, entry) => {
+  './packages/shared/consoleWithStackDev.js': (bundleType, entry) => {
     switch (bundleType) {
       case FB_WWW_DEV:
-        return 'shared/forks/consoleWithStackDev.www.js';
+        return './packages/shared/forks/consoleWithStackDev.www.js';
       default:
         return null;
     }
@@ -193,12 +215,12 @@ const forks = Object.freeze({
 
   // In FB bundles, we preserve an inline require to ReactCurrentOwner.
   // See the explanation in FB version of ReactCurrentOwner in www:
-  'react/src/ReactCurrentOwner': (bundleType, entry) => {
+  './packages/react/src/ReactCurrentOwner.js': (bundleType, entry) => {
     switch (bundleType) {
       case FB_WWW_DEV:
       case FB_WWW_PROD:
       case FB_WWW_PROFILING:
-        return 'react/src/forks/ReactCurrentOwner.www.js';
+        return './packages/react/src/forks/ReactCurrentOwner.www.js';
       default:
         return null;
     }
@@ -206,41 +228,41 @@ const forks = Object.freeze({
 
   // Similarly, we preserve an inline require to ReactCurrentDispatcher.
   // See the explanation in FB version of ReactCurrentDispatcher in www:
-  'react/src/ReactCurrentDispatcher': (bundleType, entry) => {
+  './packages/react/src/ReactCurrentDispatcher.js': (bundleType, entry) => {
     switch (bundleType) {
       case FB_WWW_DEV:
       case FB_WWW_PROD:
       case FB_WWW_PROFILING:
-        return 'react/src/forks/ReactCurrentDispatcher.www.js';
+        return './packages/react/src/forks/ReactCurrentDispatcher.www.js';
       default:
         return null;
     }
   },
 
-  'react/src/ReactSharedInternals.js': (bundleType, entry) => {
+  './packages/react/src/ReactSharedInternals.js': (bundleType, entry) => {
     switch (bundleType) {
       case UMD_DEV:
       case UMD_PROD:
       case UMD_PROFILING:
-        return 'react/src/forks/ReactSharedInternals.umd.js';
+        return './packages/react/src/forks/ReactSharedInternals.umd.js';
       default:
         return null;
     }
   },
 
   // Different wrapping/reporting for caught errors.
-  'shared/invokeGuardedCallbackImpl': (bundleType, entry) => {
+  './packages/shared/invokeGuardedCallbackImpl.js': (bundleType, entry) => {
     switch (bundleType) {
       case FB_WWW_DEV:
       case FB_WWW_PROD:
       case FB_WWW_PROFILING:
-        return 'shared/forks/invokeGuardedCallbackImpl.www.js';
+        return './packages/shared/forks/invokeGuardedCallbackImpl.www.js';
       default:
         return null;
     }
   },
 
-  'react-reconciler/src/ReactFiberReconciler': (
+  './packages/react-reconciler/src/ReactFiberReconciler.js': (
     bundleType,
     entry,
     dependencies,
@@ -253,14 +275,14 @@ const forks = Object.freeze({
         case FB_WWW_PROD:
         case FB_WWW_PROFILING:
           // Use the forked version of the reconciler
-          return 'react-reconciler/src/ReactFiberReconciler.new.js';
+          return './packages/react-reconciler/src/ReactFiberReconciler.new.js';
       }
     }
     // Otherwise, use the non-forked version.
-    return 'react-reconciler/src/ReactFiberReconciler.old.js';
+    return './packages/react-reconciler/src/ReactFiberReconciler.old.js';
   },
 
-  'react-reconciler/src/ReactEventPriorities': (
+  './packages/react-reconciler/src/ReactEventPriorities.js': (
     bundleType,
     entry,
     dependencies,
@@ -273,14 +295,14 @@ const forks = Object.freeze({
         case FB_WWW_PROD:
         case FB_WWW_PROFILING:
           // Use the forked version of the reconciler
-          return 'react-reconciler/src/ReactEventPriorities.new.js';
+          return './packages/react-reconciler/src/ReactEventPriorities.new.js';
       }
     }
     // Otherwise, use the non-forked version.
-    return 'react-reconciler/src/ReactEventPriorities.old.js';
+    return './packages/react-reconciler/src/ReactEventPriorities.old.js';
   },
 
-  'react-reconciler/src/ReactFiberHotReloading': (
+  './packages/react-reconciler/src/ReactFiberHotReloading.js': (
     bundleType,
     entry,
     dependencies,
@@ -293,21 +315,24 @@ const forks = Object.freeze({
         case FB_WWW_PROD:
         case FB_WWW_PROFILING:
           // Use the forked version of the reconciler
-          return 'react-reconciler/src/ReactFiberHotReloading.new.js';
+          return './packages/react-reconciler/src/ReactFiberHotReloading.new.js';
       }
     }
     // Otherwise, use the non-forked version.
-    return 'react-reconciler/src/ReactFiberHotReloading.old.js';
+    return './packages/react-reconciler/src/ReactFiberHotReloading.old.js';
   },
 
   // Different dialogs for caught errors.
-  'react-reconciler/src/ReactFiberErrorDialog': (bundleType, entry) => {
+  './packages/react-reconciler/src/ReactFiberErrorDialog.js': (
+    bundleType,
+    entry
+  ) => {
     switch (bundleType) {
       case FB_WWW_DEV:
       case FB_WWW_PROD:
       case FB_WWW_PROFILING:
         // Use the www fork which shows an error dialog.
-        return 'react-reconciler/src/forks/ReactFiberErrorDialog.www.js';
+        return './packages/react-reconciler/src/forks/ReactFiberErrorDialog.www.js';
       case RN_OSS_DEV:
       case RN_OSS_PROD:
       case RN_OSS_PROFILING:
@@ -318,7 +343,7 @@ const forks = Object.freeze({
           case 'react-native-renderer':
           case 'react-native-renderer/fabric':
             // Use the RN fork which plays well with redbox.
-            return 'react-reconciler/src/forks/ReactFiberErrorDialog.native.js';
+            return './packages/react-reconciler/src/forks/ReactFiberErrorDialog.native.js';
           default:
             return null;
         }
@@ -327,7 +352,7 @@ const forks = Object.freeze({
     }
   },
 
-  'react-reconciler/src/ReactFiberHostConfig': (
+  './packages/react-reconciler/src/ReactFiberHostConfig.js': (
     bundleType,
     entry,
     dependencies,
@@ -342,7 +367,7 @@ const forks = Object.freeze({
     // eslint-disable-next-line no-for-of-loops/no-for-of-loops
     for (let rendererInfo of inlinedHostConfigs) {
       if (rendererInfo.entryPoints.indexOf(entry) !== -1) {
-        return `react-reconciler/src/forks/ReactFiberHostConfig.${rendererInfo.shortName}.js`;
+        return `./packages/react-reconciler/src/forks/ReactFiberHostConfig.${rendererInfo.shortName}.js`;
       }
     }
     throw new Error(
@@ -352,7 +377,7 @@ const forks = Object.freeze({
     );
   },
 
-  'react-server/src/ReactServerStreamConfig': (
+  './packages/react-server/src/ReactServerStreamConfig.js': (
     bundleType,
     entry,
     dependencies,
@@ -370,7 +395,7 @@ const forks = Object.freeze({
         if (!rendererInfo.isServerSupported) {
           return null;
         }
-        return `react-server/src/forks/ReactServerStreamConfig.${rendererInfo.shortName}.js`;
+        return `./packages/react-server/src/forks/ReactServerStreamConfig.${rendererInfo.shortName}.js`;
       }
     }
     throw new Error(
@@ -380,7 +405,7 @@ const forks = Object.freeze({
     );
   },
 
-  'react-server/src/ReactServerFormatConfig': (
+  './packages/react-server/src/ReactServerFormatConfig.js': (
     bundleType,
     entry,
     dependencies,
@@ -398,7 +423,7 @@ const forks = Object.freeze({
         if (!rendererInfo.isServerSupported) {
           return null;
         }
-        return `react-server/src/forks/ReactServerFormatConfig.${rendererInfo.shortName}.js`;
+        return `./packages/react-server/src/forks/ReactServerFormatConfig.${rendererInfo.shortName}.js`;
       }
     }
     throw new Error(
@@ -408,7 +433,7 @@ const forks = Object.freeze({
     );
   },
 
-  'react-server/src/ReactFlightServerConfig': (
+  './packages/react-server/src/ReactFlightServerConfig.js': (
     bundleType,
     entry,
     dependencies,
@@ -426,7 +451,7 @@ const forks = Object.freeze({
         if (!rendererInfo.isServerSupported) {
           return null;
         }
-        return `react-server/src/forks/ReactFlightServerConfig.${rendererInfo.shortName}.js`;
+        return `./packages/react-server/src/forks/ReactFlightServerConfig.${rendererInfo.shortName}.js`;
       }
     }
     throw new Error(
@@ -436,7 +461,7 @@ const forks = Object.freeze({
     );
   },
 
-  'react-client/src/ReactFlightClientHostConfig': (
+  './packages/react-client/src/ReactFlightClientHostConfig.js': (
     bundleType,
     entry,
     dependencies,
@@ -454,7 +479,7 @@ const forks = Object.freeze({
         if (!rendererInfo.isServerSupported) {
           return null;
         }
-        return `react-client/src/forks/ReactFlightClientHostConfig.${rendererInfo.shortName}.js`;
+        return `./packages/react-client/src/forks/ReactFlightClientHostConfig.${rendererInfo.shortName}.js`;
       }
     }
     throw new Error(
@@ -465,7 +490,7 @@ const forks = Object.freeze({
   },
 
   // We wrap top-level listeners into guards on www.
-  'react-dom/src/events/EventListener': (bundleType, entry) => {
+  './packages/react-dom/src/events/EventListener.js': (bundleType, entry) => {
     switch (bundleType) {
       case FB_WWW_DEV:
       case FB_WWW_PROD:
@@ -475,28 +500,34 @@ const forks = Object.freeze({
           return null;
         } else {
           // Use the www fork which is integrated with TimeSlice profiling.
-          return 'react-dom/src/events/forks/EventListener-www.js';
+          return './packages/react-dom/src/events/forks/EventListener-www.js';
         }
       default:
         return null;
     }
   },
 
-  'use-sync-external-store/src/useSyncExternalStore': (bundleType, entry) => {
+  './packages/use-sync-external-store/src/useSyncExternalStore.js': (
+    bundleType,
+    entry
+  ) => {
     if (entry.startsWith('use-sync-external-store/shim')) {
-      return 'use-sync-external-store/src/forks/useSyncExternalStore.forward-to-shim';
+      return './packages/use-sync-external-store/src/forks/useSyncExternalStore.forward-to-shim.js';
     }
     if (entry !== 'use-sync-external-store') {
       // Internal modules that aren't shims should use the native API from the
       // react package.
-      return 'use-sync-external-store/src/forks/useSyncExternalStore.forward-to-built-in';
+      return './packages/use-sync-external-store/src/forks/useSyncExternalStore.forward-to-built-in.js';
     }
     return null;
   },
 
-  'use-sync-external-store/src/isServerEnvironment': (bundleType, entry) => {
+  './packages/use-sync-external-store/src/isServerEnvironment.js': (
+    bundleType,
+    entry
+  ) => {
     if (entry.endsWith('.native')) {
-      return 'use-sync-external-store/src/forks/isServerEnvironment.native';
+      return './packages/use-sync-external-store/src/forks/isServerEnvironment.native.js';
     }
   },
 });

commit 552c067bb18062f6a1bba2fc848033abd2ea8090
Author: Andrew Clark <git@andrewclark.io>
Date:   Tue Feb 22 20:03:51 2022 -0500

    Remove public export for unstable-shared-subset.js (#23261)
    
    The unstable-shared-subset.js file is not a public module — it's a
    private module that the "react" package maps to when it's accessed from
    the "react-server" package.
    
    We originally added it because it was required to make our Rollup
    configuration work, because at the time only "public" modules could act
    as the entry point for a build artifact — that's why it's prefixed with
    "unstable". We've since updated our Rollup config to support private
    entry points, so we can remove the extra indirection.

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index d4a392770b..eba8f0d684 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -55,7 +55,7 @@ const forks = Object.freeze({
       // happens. Other bundles just require('object-assign') anyway.
       return null;
     }
-    if (entry === 'react' || entry === 'react/unstable-shared-subset') {
+    if (entry === 'react' || entry === 'react/src/ReactSharedSubset.js') {
       // Use the forked version that uses ES modules instead of CommonJS.
       return './packages/shared/forks/object-assign.inline-umd.js';
     }
@@ -82,7 +82,7 @@ const forks = Object.freeze({
     entry,
     dependencies
   ) => {
-    if (entry === 'react' || entry === 'react/unstable-shared-subset') {
+    if (entry === 'react' || entry === 'react/src/ReactSharedSubset.js') {
       return './packages/react/src/ReactSharedInternals.js';
     }
     if (!entry.startsWith('react/') && dependencies.indexOf('react') === -1) {

commit 1ad8d81292415e26ac070dec03ad84c11fbe207d
Author: Sebastian Markbåge <sebastian@calyptus.eu>
Date:   Wed Feb 23 19:34:24 2022 -0500

    Remove object-assign polyfill (#23351)
    
    * Remove object-assign polyfill
    
    We really rely on a more modern environment where this is typically
    polyfilled anyway and we don't officially support IE with more extensive
    polyfilling anyway. So all environments should have the native version
    by now.
    
    * Use shared/assign instead of Object.assign in code
    
    This is so that we have one cached local instance in the bundle.
    
    Ideally we should have a compile do this for us but we already follow
    this pattern with hasOwnProperty, isArray, Object.is etc.
    
    * Transform Object.assign to now use shared/assign
    
    We need this to use the shared instance when Object.spread is used.

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index eba8f0d684..d45c41a742 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -36,38 +36,6 @@ const __EXPERIMENTAL__ =
 // algorithm because 1) require.resolve doesn't work with ESM modules, and 2)
 // the behavior is easier to predict.
 const forks = Object.freeze({
-  // Optimization: for UMDs, use a version that we can inline into the React bundle.
-  // Use that from all other bundles.
-
-  // NOTE: This is hard-coded to the main entry point of the (third-party)
-  // object-assign package.
-  './node_modules/object-assign/index.js': (
-    bundleType,
-    entry,
-    dependencies
-  ) => {
-    if (
-      bundleType !== UMD_DEV &&
-      bundleType !== UMD_PROD &&
-      bundleType !== UMD_PROFILING
-    ) {
-      // It's only relevant for UMD bundles since that's where the duplication
-      // happens. Other bundles just require('object-assign') anyway.
-      return null;
-    }
-    if (entry === 'react' || entry === 'react/src/ReactSharedSubset.js') {
-      // Use the forked version that uses ES modules instead of CommonJS.
-      return './packages/shared/forks/object-assign.inline-umd.js';
-    }
-    if (dependencies.indexOf('react') === -1) {
-      // We can only apply the optimizations to bundle that depend on React
-      // because we read assign() from an object exposed on React internals.
-      return null;
-    }
-    // We can use the fork that reads the secret export!
-    return './packages/shared/forks/object-assign.umd.js';
-  },
-
   // NOTE: This is hard-coded to the main entry point of the (third-party)
   // react-shallow-renderer package.
   './node_modules/react-shallow-renderer/index.js': () => {

commit 6cbf0f7fac772c3fd18706d73af00f3fd06a55b5
Author: Rick Hanlon <rickhanlonii@gmail.com>
Date:   Tue May 3 17:12:23 2022 -0400

    Fork ReactSymbols (#24484)
    
    * Fork ReactSymbols
    
    * Fix tests
    
    * Update jest config

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index d45c41a742..5c3abebc5e 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -138,6 +138,17 @@ const forks = Object.freeze({
     return null;
   },
 
+  './packages/shared/ReactSymbols.js': bundleType => {
+    switch (bundleType) {
+      case FB_WWW_DEV:
+      case FB_WWW_PROD:
+      case FB_WWW_PROFILING:
+        return './packages/shared/ReactSymbols.www.js';
+      default:
+        return './packages/shared/ReactSymbols.js';
+    }
+  },
+
   './packages/scheduler/index.js': (bundleType, entry, dependencies) => {
     switch (bundleType) {
       case UMD_DEV:

commit 0de3ddf56e011c708067319d9b8e94e1cd1ea1a5
Author: Rick Hanlon <rickhanlonii@gmail.com>
Date:   Thu Aug 25 17:01:30 2022 -0400

    Remove Symbol Polyfill (again) (#25144)

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 5c3abebc5e..d45c41a742 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -138,17 +138,6 @@ const forks = Object.freeze({
     return null;
   },
 
-  './packages/shared/ReactSymbols.js': bundleType => {
-    switch (bundleType) {
-      case FB_WWW_DEV:
-      case FB_WWW_PROD:
-      case FB_WWW_PROFILING:
-        return './packages/shared/ReactSymbols.www.js';
-      default:
-        return './packages/shared/ReactSymbols.js';
-    }
-  },
-
   './packages/scheduler/index.js': (bundleType, entry, dependencies) => {
     switch (bundleType) {
       case UMD_DEV:

commit e7fc04b2970197cb953833aa15597cbc9fe38f2e
Author: Josh Story <story@hey.com>
Date:   Thu Sep 15 15:31:31 2022 -0700

    [react-dom] Reorganize react-dom internals to match react (#25277)
    
    * reorganize react-dom internals to match react
    
    * refactor and make forks work for flow and internal imports
    
    * flew too close to the sun
    
    * typo

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index d45c41a742..34345c80a1 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -67,6 +67,33 @@ const forks = Object.freeze({
     return null;
   },
 
+  // Without this fork, importing `shared/ReactDOMSharedInternals` inside
+  // the `react-dom` package itself would not work due to a cyclical dependency.
+  './packages/shared/ReactDOMSharedInternals.js': (
+    bundleType,
+    entry,
+    dependencies
+  ) => {
+    if (entry === 'react-dom') {
+      return './packages/react-dom/src/ReactDOMSharedInternals.js';
+    }
+    if (
+      !entry.startsWith('react-dom/') &&
+      dependencies.indexOf('react-dom') === -1
+    ) {
+      // React DOM internals are unavailable if we can't reference the package.
+      // We return an error because we only want to throw if this module gets used.
+      return new Error(
+        'Cannot use a module that depends on ReactDOMSharedInternals ' +
+          'from "' +
+          entry +
+          '" because it does not declare "react-dom" in the package ' +
+          'dependencies or peerDependencies.'
+      );
+    }
+    return null;
+  },
+
   // We have a few forks for different environments.
   './packages/shared/ReactFeatureFlags.js': (bundleType, entry) => {
     switch (entry) {

commit ebbe599a25f4d751787ad49a9026215f14dc6d03
Author: Sebastian Markbåge <sebastian@calyptus.eu>
Date:   Wed Sep 28 19:45:59 2022 -0400

    Fix EventListener fork (#25347)

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 34345c80a1..b745918acf 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -485,7 +485,10 @@ const forks = Object.freeze({
   },
 
   // We wrap top-level listeners into guards on www.
-  './packages/react-dom/src/events/EventListener.js': (bundleType, entry) => {
+  './packages/react-dom-bindings/src/events/EventListener.js': (
+    bundleType,
+    entry
+  ) => {
     switch (bundleType) {
       case FB_WWW_DEV:
       case FB_WWW_PROD:
@@ -495,7 +498,7 @@ const forks = Object.freeze({
           return null;
         } else {
           // Use the www fork which is integrated with TimeSlice profiling.
-          return './packages/react-dom/src/events/forks/EventListener-www.js';
+          return './packages/react-dom-bindings/src/events/forks/EventListener-www.js';
         }
       default:
         return null;

commit aa9988e5e669122ed0d76c72f2dea159eef872b4
Author: Josh Story <story@hey.com>
Date:   Mon Oct 10 11:06:22 2022 -0700

    Server render fork for react-dom (#25436)
    
    Publish an aliasable entry for `react-dom` top level package exports for use in server environments. This is a stub containing only the exports that we expect to retain in the top level once 19 is released

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index b745918acf..15856230ba 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -74,7 +74,7 @@ const forks = Object.freeze({
     entry,
     dependencies
   ) => {
-    if (entry === 'react-dom') {
+    if (entry === 'react-dom' || entry === 'react-dom/server-rendering-stub') {
       return './packages/react-dom/src/ReactDOMSharedInternals.js';
     }
     if (

commit a8c16a00406a204f0153c21023a04ca9a68411da
Author: Sebastian Markbåge <sebastian@calyptus.eu>
Date:   Wed Oct 12 23:13:39 2022 -0400

    Split Cache into its own Dispatcher (#25474)
    
    * Missing Hooks
    
    * Remove www forks. These can use __SECRET... instead.
    
    * Move cache to separate dispatcher
    
    These will be available in more contexts than just render.

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 15856230ba..484a1288f8 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -208,32 +208,6 @@ const forks = Object.freeze({
     }
   },
 
-  // In FB bundles, we preserve an inline require to ReactCurrentOwner.
-  // See the explanation in FB version of ReactCurrentOwner in www:
-  './packages/react/src/ReactCurrentOwner.js': (bundleType, entry) => {
-    switch (bundleType) {
-      case FB_WWW_DEV:
-      case FB_WWW_PROD:
-      case FB_WWW_PROFILING:
-        return './packages/react/src/forks/ReactCurrentOwner.www.js';
-      default:
-        return null;
-    }
-  },
-
-  // Similarly, we preserve an inline require to ReactCurrentDispatcher.
-  // See the explanation in FB version of ReactCurrentDispatcher in www:
-  './packages/react/src/ReactCurrentDispatcher.js': (bundleType, entry) => {
-    switch (bundleType) {
-      case FB_WWW_DEV:
-      case FB_WWW_PROD:
-      case FB_WWW_PROFILING:
-        return './packages/react/src/forks/ReactCurrentDispatcher.www.js';
-      default:
-        return null;
-    }
-  },
-
   './packages/react/src/ReactSharedInternals.js': (bundleType, entry) => {
     switch (bundleType) {
       case UMD_DEV:

commit 08d035bc8f02be2bd0f23eec2c9e8ddec51083f6
Author: Sebastian Markbåge <sebastian@calyptus.eu>
Date:   Thu Oct 13 19:02:03 2022 -0400

    Remove Shallow Renderer Tests (#25475)

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 484a1288f8..d1f9fbd71c 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -36,13 +36,6 @@ const __EXPERIMENTAL__ =
 // algorithm because 1) require.resolve doesn't work with ESM modules, and 2)
 // the behavior is easier to predict.
 const forks = Object.freeze({
-  // NOTE: This is hard-coded to the main entry point of the (third-party)
-  // react-shallow-renderer package.
-  './node_modules/react-shallow-renderer/index.js': () => {
-    // Use ESM build of `react-shallow-renderer`.
-    return './node_modules/react-shallow-renderer/esm/index.js';
-  },
-
   // Without this fork, importing `shared/ReactSharedInternals` inside
   // the `react` package itself would not work due to a cyclical dependency.
   './packages/shared/ReactSharedInternals.js': (

commit 420f0b7fa1fcc609fc7b438c4599d0f76fab4bc0
Author: Jan Kassens <jkassens@meta.com>
Date:   Thu Dec 1 23:06:25 2022 -0500

    Remove Reconciler fork (1/2) (#25774)
    
    We've heard from multiple contributors that the Reconciler forking
    mechanism was confusing and/or annoying to deal with. Since it's
    currently unused and there's no immediate plans to start using it again,
    this removes the forking.
    
    Fully removing the fork is split into 2 steps to preserve file history:
    
    **This PR**
    - remove `enableNewReconciler` feature flag.
    - remove `unstable_isNewReconciler` export
    - remove eslint rules for cross fork imports
    - remove `*.new.js` files and update imports
    - merge non-suffixed files into `*.old` files where both exist
    (sometimes types were defined there)
    
    **#25775**
    - rename `*.old` files

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index d1f9fbd71c..93833be146 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -224,66 +224,6 @@ const forks = Object.freeze({
     }
   },
 
-  './packages/react-reconciler/src/ReactFiberReconciler.js': (
-    bundleType,
-    entry,
-    dependencies,
-    moduleType,
-    bundle
-  ) => {
-    if (bundle.enableNewReconciler) {
-      switch (bundleType) {
-        case FB_WWW_DEV:
-        case FB_WWW_PROD:
-        case FB_WWW_PROFILING:
-          // Use the forked version of the reconciler
-          return './packages/react-reconciler/src/ReactFiberReconciler.new.js';
-      }
-    }
-    // Otherwise, use the non-forked version.
-    return './packages/react-reconciler/src/ReactFiberReconciler.old.js';
-  },
-
-  './packages/react-reconciler/src/ReactEventPriorities.js': (
-    bundleType,
-    entry,
-    dependencies,
-    moduleType,
-    bundle
-  ) => {
-    if (bundle.enableNewReconciler) {
-      switch (bundleType) {
-        case FB_WWW_DEV:
-        case FB_WWW_PROD:
-        case FB_WWW_PROFILING:
-          // Use the forked version of the reconciler
-          return './packages/react-reconciler/src/ReactEventPriorities.new.js';
-      }
-    }
-    // Otherwise, use the non-forked version.
-    return './packages/react-reconciler/src/ReactEventPriorities.old.js';
-  },
-
-  './packages/react-reconciler/src/ReactFiberHotReloading.js': (
-    bundleType,
-    entry,
-    dependencies,
-    moduleType,
-    bundle
-  ) => {
-    if (bundle.enableNewReconciler) {
-      switch (bundleType) {
-        case FB_WWW_DEV:
-        case FB_WWW_PROD:
-        case FB_WWW_PROFILING:
-          // Use the forked version of the reconciler
-          return './packages/react-reconciler/src/ReactFiberHotReloading.new.js';
-      }
-    }
-    // Otherwise, use the non-forked version.
-    return './packages/react-reconciler/src/ReactFiberHotReloading.old.js';
-  },
-
   // Different dialogs for caught errors.
   './packages/react-reconciler/src/ReactFiberErrorDialog.js': (
     bundleType,

commit 2ccfa657d9529cab25eaa25144efc64df12b13c7
Author: lauren <poteto@users.noreply.github.com>
Date:   Mon Dec 5 12:08:28 2022 -0800

    Fork ReactDOMSharedInternals for www (#25791)
    
    This isn't the right way to do this, but internally we have some
    restrictions so we need to add an indirection. Let's land this now so we
    can catch up our sync and then fix forward from there.
    
    Co-authored-by: Jan Kassens <jkassens@meta.com>

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 93833be146..db046be29a 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -70,6 +70,14 @@ const forks = Object.freeze({
     if (entry === 'react-dom' || entry === 'react-dom/server-rendering-stub') {
       return './packages/react-dom/src/ReactDOMSharedInternals.js';
     }
+    switch (bundleType) {
+      case FB_WWW_DEV:
+      case FB_WWW_PROD:
+      case FB_WWW_PROFILING:
+        return './packages/shared/forks/ReactDOMSharedInternals.www.js';
+      default:
+        break;
+    }
     if (
       !entry.startsWith('react-dom/') &&
       dependencies.indexOf('react-dom') === -1

commit 9c09c1cd62ef862df91bcb4df4271917629d6963
Author: lauren <poteto@users.noreply.github.com>
Date:   Mon Dec 12 09:39:57 2022 -0800

    Revert "Fork ReactDOMSharedInternals for www (#25791)" (#25864)
    
    We did some cleanup internally of our ReactDOM module, so this fork
    should be safe to remove now. Will land this only after our internal
    diff lands.

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index db046be29a..93833be146 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -70,14 +70,6 @@ const forks = Object.freeze({
     if (entry === 'react-dom' || entry === 'react-dom/server-rendering-stub') {
       return './packages/react-dom/src/ReactDOMSharedInternals.js';
     }
-    switch (bundleType) {
-      case FB_WWW_DEV:
-      case FB_WWW_PROD:
-      case FB_WWW_PROFILING:
-        return './packages/shared/forks/ReactDOMSharedInternals.www.js';
-      default:
-        break;
-    }
     if (
       !entry.startsWith('react-dom/') &&
       dependencies.indexOf('react-dom') === -1

commit 6bd53a5bdfe24d9a70819c4eba40b488e62900cd
Author: Sebastian Markbåge <sebastian@calyptus.eu>
Date:   Mon Mar 13 18:43:37 2023 -0400

    Remove FeatureFlags fork for `react-dom/unstable_testing` (#26383)
    
    This doesn't need its own set of flags. We use things like `__PROFILE__`
    in the regular feature flags file to fork for the `react-dom/profiling`
    build so we can do the same here if needed but I don't think we actually
    need to fork this anywhere as far as I can tell.

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 93833be146..21217ec50a 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -135,14 +135,6 @@ const forks = Object.freeze({
             return './packages/shared/forks/ReactFeatureFlags.test-renderer.www.js';
         }
         return './packages/shared/forks/ReactFeatureFlags.test-renderer.js';
-      case 'react-dom/unstable_testing':
-        switch (bundleType) {
-          case FB_WWW_DEV:
-          case FB_WWW_PROD:
-          case FB_WWW_PROFILING:
-            return './packages/shared/forks/ReactFeatureFlags.testing.www.js';
-        }
-        return './packages/shared/forks/ReactFeatureFlags.testing.js';
       default:
         switch (bundleType) {
           case FB_WWW_DEV:

commit 44db16afc61c34e6d46b55e985211df7ccc78fa5
Author: Josh Story <story@hey.com>
Date:   Mon Apr 10 14:47:23 2023 -0700

    Normalize ReactFlightServerConfig and related files (#26589)
    
    First part of https://github.com/facebook/react/pull/26571
    
    merging separately to help with git history with a lot of file renames

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 21217ec50a..55d4409fe9 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -355,7 +355,7 @@ const forks = Object.freeze({
     );
   },
 
-  './packages/react-client/src/ReactFlightClientHostConfig.js': (
+  './packages/react-client/src/ReactFlightClientConfig.js': (
     bundleType,
     entry,
     dependencies,
@@ -373,11 +373,11 @@ const forks = Object.freeze({
         if (!rendererInfo.isServerSupported) {
           return null;
         }
-        return `./packages/react-client/src/forks/ReactFlightClientHostConfig.${rendererInfo.shortName}.js`;
+        return `./packages/react-client/src/forks/ReactFlightClientConfig.${rendererInfo.shortName}.js`;
       }
     }
     throw new Error(
-      'Expected ReactFlightClientHostConfig to always be replaced with a shim, but ' +
+      'Expected ReactFlightClientConfig to always be replaced with a shim, but ' +
         `found no mention of "${entry}" entry point in ./scripts/shared/inlinedHostConfigs.js. ` +
         'Did you mean to add it there to associate it with a specific renderer?'
     );

commit ffb8eaca5966fc7733bd0a23f4055e26d2cc59d7
Author: Josh Story <story@hey.com>
Date:   Mon Apr 10 14:54:26 2023 -0700

    Rename ReactServerFormatConfig to ReactFizzConfig (#26591)
    
    part of https://github.com/facebook/react/pull/26571
    
    merging separately to improve tracking of file renames

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 55d4409fe9..5f6c984604 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -299,7 +299,7 @@ const forks = Object.freeze({
     );
   },
 
-  './packages/react-server/src/ReactServerFormatConfig.js': (
+  './packages/react-server/src/ReactFizzConfig.js': (
     bundleType,
     entry,
     dependencies,
@@ -317,11 +317,11 @@ const forks = Object.freeze({
         if (!rendererInfo.isServerSupported) {
           return null;
         }
-        return `./packages/react-server/src/forks/ReactServerFormatConfig.${rendererInfo.shortName}.js`;
+        return `./packages/react-server/src/forks/ReactFizzConfig.${rendererInfo.shortName}.js`;
       }
     }
     throw new Error(
-      'Expected ReactServerFormatConfig to always be replaced with a shim, but ' +
+      'Expected ReactFizzConfig to always be replaced with a shim, but ' +
         `found no mention of "${entry}" entry point in ./scripts/shared/inlinedHostConfigs.js. ` +
         'Did you mean to add it there to associate it with a specific renderer?'
     );

commit b55d31955982851284bb437a5187a6c56e366539
Author: Josh Story <story@hey.com>
Date:   Mon Apr 10 14:58:44 2023 -0700

    Rename HostConfig files to FiberConfig to clarify they are configs fo… (#26592)
    
    part of https://github.com/facebook/react/pull/26571
    
    merging separately to improve tracking of files renames in git
    
    Rename HostConfig files to FiberConfig to clarify they are configs for
    Fiber and not Fizz/Flight. This better conforms to the naming used in
    Flight and now Fizz of `ReactFlightServerConfig` and `ReactFizzConfig`

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 5f6c984604..d51e784f68 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -246,7 +246,7 @@ const forks = Object.freeze({
     }
   },
 
-  './packages/react-reconciler/src/ReactFiberHostConfig.js': (
+  './packages/react-reconciler/src/ReactFiberConfig.js': (
     bundleType,
     entry,
     dependencies,
@@ -261,11 +261,11 @@ const forks = Object.freeze({
     // eslint-disable-next-line no-for-of-loops/no-for-of-loops
     for (let rendererInfo of inlinedHostConfigs) {
       if (rendererInfo.entryPoints.indexOf(entry) !== -1) {
-        return `./packages/react-reconciler/src/forks/ReactFiberHostConfig.${rendererInfo.shortName}.js`;
+        return `./packages/react-reconciler/src/forks/ReactFiberConfig.${rendererInfo.shortName}.js`;
       }
     }
     throw new Error(
-      'Expected ReactFiberHostConfig to always be replaced with a shim, but ' +
+      'Expected ReactFiberConfig to always be replaced with a shim, but ' +
         `found no mention of "${entry}" entry point in ./scripts/shared/inlinedHostConfigs.js. ` +
         'Did you mean to add it there to associate it with a specific renderer?'
     );

commit 5623f2acf93d762b0b67dab76668b564a6f3b21e
Author: Josh Story <story@hey.com>
Date:   Thu Aug 17 15:17:46 2023 -0700

    Updating forking implementation to match against more general fork implementations (#27205)
    
    Search for more generic fork files if an exact match does not exist. If
    `forks/MyFile.dom.js` exists but `forks/MyFile.dom-node.js` does not
    then use it when trying to resolve forks for the `"dom-node"` renderer
    in flow, tests, and build
    
    consolidate certain fork files that were identical and make semantic
    sense to be generalized
    add `dom-browser-esm` bundle and use it for
    `react-server-dom-esm/client.browser` build

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index d51e784f68..801c876a45 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -1,5 +1,6 @@
 'use strict';
 
+const fs = require('node:fs');
 const {bundleTypes, moduleTypes} = require('./bundles');
 const inlinedHostConfigs = require('../shared/inlinedHostConfigs');
 
@@ -28,6 +29,22 @@ const __EXPERIMENTAL__ =
     ? RELEASE_CHANNEL === 'experimental'
     : true;
 
+function findNearestExistingForkFile(path, segmentedIdentifier, suffix) {
+  const segments = segmentedIdentifier.split('-');
+  while (segments.length) {
+    const candidate = segments.join('-');
+    const forkPath = path + candidate + suffix;
+    try {
+      fs.statSync(forkPath);
+      return forkPath;
+    } catch (error) {
+      // Try the next candidate.
+    }
+    segments.pop();
+  }
+  return null;
+}
+
 // If you need to replace a file with another file for a specific environment,
 // add it to this list with the logic for choosing the right replacement.
 
@@ -261,7 +278,16 @@ const forks = Object.freeze({
     // eslint-disable-next-line no-for-of-loops/no-for-of-loops
     for (let rendererInfo of inlinedHostConfigs) {
       if (rendererInfo.entryPoints.indexOf(entry) !== -1) {
-        return `./packages/react-reconciler/src/forks/ReactFiberConfig.${rendererInfo.shortName}.js`;
+        const foundFork = findNearestExistingForkFile(
+          './packages/react-reconciler/src/forks/ReactFiberConfig.',
+          rendererInfo.shortName,
+          '.js'
+        );
+        if (foundFork) {
+          return foundFork;
+        }
+        // fall through to error
+        break;
       }
     }
     throw new Error(
@@ -289,7 +315,16 @@ const forks = Object.freeze({
         if (!rendererInfo.isServerSupported) {
           return null;
         }
-        return `./packages/react-server/src/forks/ReactServerStreamConfig.${rendererInfo.shortName}.js`;
+        const foundFork = findNearestExistingForkFile(
+          './packages/react-server/src/forks/ReactServerStreamConfig.',
+          rendererInfo.shortName,
+          '.js'
+        );
+        if (foundFork) {
+          return foundFork;
+        }
+        // fall through to error
+        break;
       }
     }
     throw new Error(
@@ -317,7 +352,16 @@ const forks = Object.freeze({
         if (!rendererInfo.isServerSupported) {
           return null;
         }
-        return `./packages/react-server/src/forks/ReactFizzConfig.${rendererInfo.shortName}.js`;
+        const foundFork = findNearestExistingForkFile(
+          './packages/react-server/src/forks/ReactFizzConfig.',
+          rendererInfo.shortName,
+          '.js'
+        );
+        if (foundFork) {
+          return foundFork;
+        }
+        // fall through to error
+        break;
       }
     }
     throw new Error(
@@ -345,7 +389,23 @@ const forks = Object.freeze({
         if (!rendererInfo.isServerSupported) {
           return null;
         }
-        return `./packages/react-server/src/forks/ReactFlightServerConfig.${rendererInfo.shortName}.js`;
+        if (rendererInfo.isFlightSupported === false) {
+          return new Error(
+            `Expected not to use ReactFlightServerConfig with "${entry}" entry point ` +
+              'in ./scripts/shared/inlinedHostConfigs.js. Update the renderer config to ' +
+              'activate flight suppport and add a matching fork implementation for ReactFlightServerConfig.'
+          );
+        }
+        const foundFork = findNearestExistingForkFile(
+          './packages/react-server/src/forks/ReactFlightServerConfig.',
+          rendererInfo.shortName,
+          '.js'
+        );
+        if (foundFork) {
+          return foundFork;
+        }
+        // fall through to error
+        break;
       }
     }
     throw new Error(
@@ -373,7 +433,23 @@ const forks = Object.freeze({
         if (!rendererInfo.isServerSupported) {
           return null;
         }
-        return `./packages/react-client/src/forks/ReactFlightClientConfig.${rendererInfo.shortName}.js`;
+        if (rendererInfo.isFlightSupported === false) {
+          return new Error(
+            `Expected not to use ReactFlightClientConfig with "${entry}" entry point ` +
+              'in ./scripts/shared/inlinedHostConfigs.js. Update the renderer config to ' +
+              'activate flight suppport and add a matching fork implementation for ReactFlightClientConfig.'
+          );
+        }
+        const foundFork = findNearestExistingForkFile(
+          './packages/react-client/src/forks/ReactFlightClientConfig.',
+          rendererInfo.shortName,
+          '.js'
+        );
+        if (foundFork) {
+          return foundFork;
+        }
+        // fall through to error
+        break;
       }
     }
     throw new Error(

commit 2d2f2af29bc3175530a158bc90189fc6f12f7855
Author: Andrew Clark <git@andrewclark.io>
Date:   Fri Sep 15 14:53:19 2023 -0400

    Restrict React DOM imports from Server Components (#27382)
    
    Adds a separate entry point for the react-dom package when it's accessed
    from a Server Component environment, using the "react-server" export
    condition.
    
    When you're inside a Server Component module, you won't be able to
    import client-only APIs like useState. This applies to almost all React
    DOM exports, except for Float ones like preload.

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 801c876a45..d46dbb2b85 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -84,7 +84,11 @@ const forks = Object.freeze({
     entry,
     dependencies
   ) => {
-    if (entry === 'react-dom' || entry === 'react-dom/server-rendering-stub') {
+    if (
+      entry === 'react-dom' ||
+      entry === 'react-dom/server-rendering-stub' ||
+      entry === 'react-dom/src/ReactDOMSharedSubset.js'
+    ) {
       return './packages/react-dom/src/ReactDOMSharedInternals.js';
     }
     if (

commit c7ba8c098889b6dc47fa9c807bbba3975a658584
Author: Sebastian Markbåge <sebastian@calyptus.eu>
Date:   Fri Sep 29 18:24:05 2023 -0400

    Enforce that the "react-server" build of "react" is used (#27436)
    
    I do this by simply renaming the secret export name in the "subset"
    bundle and this renamed version is what the FlightServer uses.
    
    This requires us to be more diligent about always using the correct
    instance of "react" in our tests so there's a bunch of clean up for
    that.

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index d46dbb2b85..fa9a232bef 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -60,8 +60,11 @@ const forks = Object.freeze({
     entry,
     dependencies
   ) => {
-    if (entry === 'react' || entry === 'react/src/ReactSharedSubset.js') {
-      return './packages/react/src/ReactSharedInternals.js';
+    if (entry === 'react') {
+      return './packages/react/src/ReactSharedInternalsClient.js';
+    }
+    if (entry === 'react/src/ReactSharedSubset.js') {
+      return './packages/react/src/ReactSharedInternalsServer.js';
     }
     if (!entry.startsWith('react/') && dependencies.indexOf('react') === -1) {
       // React internals are unavailable if we can't reference the package.

commit bbb9cb116dbf7b6247721aa0c4bcb6ec249aa8af
Author: Jack Pope <jackpope1@gmail.com>
Date:   Fri Nov 17 09:00:56 2023 -0500

    Update fork for ReactSharedInternalsClient export (#27717)
    
    ## Summary
    
    After changes in https://github.com/facebook/react/pull/27436, UMD
    builds no longer expose Scheduler from ReactSharedInternals. This module
    is forked in rollup for UMD builds and the path no longer matches. This
    PR updates the path name to match the new module:
    ReactSharedInternalsClient.
    
    ## How did you test this change?
    
    - `yarn build`
    - Inspect `react.development.js` UMD build, observe `Scheduler:
    Scheduler` is set in `ReactSharedInternals`, matching
    [18.2.0](https://unpkg.com/react@18.2.0/umd/react.development.js)
    - ran attribute-behavior fixture app
    - Observe no more error `Uncaught (in promise) TypeError: Cannot read
    properties of undefined (reading 'unstable_cancelCallback')`
    
    Co-authored-by: Jack Pope <jackpope@meta.com>

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index fa9a232bef..22d7d4c3e9 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -217,7 +217,7 @@ const forks = Object.freeze({
     }
   },
 
-  './packages/react/src/ReactSharedInternals.js': (bundleType, entry) => {
+  './packages/react/src/ReactSharedInternalsClient.js': (bundleType, entry) => {
     switch (bundleType) {
       case UMD_DEV:
       case UMD_PROD:

commit c17a27ef492d9812351aecdfb017488e8e8404ce
Author: Andrey Lunyov <alunyov@meta.com>
Date:   Mon Nov 27 18:34:58 2023 -0500

    FB-specific builds of Flight Server, Flight Client, and React Shared Subset (#27579)
    
    This PR adds a new FB-specific configuration of Flight. We also need to
    bundle a version of ReactSharedSubset that will be used for running
    Flight on the server.
    
    This initial implementation does not support server actions yet.
    
    The FB-Flight still uses the text protocol on the server (the flag
    `enableBinaryFlight` is set to false). It looks like we need some
    changes in Hermes to properly support this binary format.

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 22d7d4c3e9..24ba7c2a86 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -63,7 +63,10 @@ const forks = Object.freeze({
     if (entry === 'react') {
       return './packages/react/src/ReactSharedInternalsClient.js';
     }
-    if (entry === 'react/src/ReactSharedSubset.js') {
+    if (
+      entry === 'react/src/ReactSharedSubset.js' ||
+      entry === 'react/src/ReactSharedSubsetFB.js'
+    ) {
       return './packages/react/src/ReactSharedInternalsServer.js';
     }
     if (!entry.startsWith('react/') && dependencies.indexOf('react') === -1) {

commit 3e97c00debbd6706b6ec6b7da15094bf2ba81ef4
Author: Jack Pope <jackpope1@gmail.com>
Date:   Fri Dec 1 09:48:04 2023 -0500

    Rename fork ReactSharedInternals -> ReactSharedInternalsClient (#27767)
    
    ## Summary
    
    Follow up from #27717 based on feedback to rename the fork module itself
    
    ## How did you test this change?
    
    - `yarn build`
    - `yarn test
    packages/scheduler/src/__tests__/SchedulerUMDBundle-test.internal.js`
    
    Co-authored-by: Jack Pope <jackpope@meta.com>

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 24ba7c2a86..916e857d57 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -225,7 +225,7 @@ const forks = Object.freeze({
       case UMD_DEV:
       case UMD_PROD:
       case UMD_PROFILING:
-        return './packages/react/src/forks/ReactSharedInternals.umd.js';
+        return './packages/react/src/forks/ReactSharedInternalsClient.umd.js';
       default:
         return null;
     }

commit 5d1b15a4f06fa93e76cd89f37ea5bfd62cc66183
Author: Andrew Clark <git@andrewclark.io>
Date:   Tue Jan 16 19:58:11 2024 -0500

    Rename "shared subset" to "server" (#27939)
    
    The internal file ReactSharedSubset is what the `react` module resolves
    to when imported from a Server Component environment. We gave it this
    name because, originally, the idea was that Server Components can access
    a subset of the APIs available on the client.
    
    However, since then, we've also added APIs that can _only_ by accessed
    on the server and not the client. In other words, it's no longer a
    subset, it's a slightly different overlapping set.
    
    So this commit renames ReactSharedSubet to ReactServer and updates all
    the references. This does not affect the public API, only our internal
    implementation.

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 916e857d57..173ff58379 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -64,8 +64,8 @@ const forks = Object.freeze({
       return './packages/react/src/ReactSharedInternalsClient.js';
     }
     if (
-      entry === 'react/src/ReactSharedSubset.js' ||
-      entry === 'react/src/ReactSharedSubsetFB.js'
+      entry === 'react/src/ReactServer.js' ||
+      entry === 'react/src/ReactServerFB.js'
     ) {
       return './packages/react/src/ReactSharedInternalsServer.js';
     }
@@ -93,7 +93,7 @@ const forks = Object.freeze({
     if (
       entry === 'react-dom' ||
       entry === 'react-dom/server-rendering-stub' ||
-      entry === 'react-dom/src/ReactDOMSharedSubset.js'
+      entry === 'react-dom/src/ReactDOMServer.js'
     ) {
       return './packages/react-dom/src/ReactDOMSharedInternals.js';
     }

commit 113ab9af08c46e8a548a397154f5c9dfeb96ab6a
Author: Josh Story <story@hey.com>
Date:   Mon Mar 4 12:27:15 2024 -0800

    [Flight][Fizz][Fiber] Chain HostDispatcher implementations (#28488)
    
    The idea here is that host dispatchers are not bound to renders so we
    need to be able to dispatch to them at any time. This updates the
    implementation to chain these dispatchers so that each renderer can
    respond to the dispatch. Semantically we don't always want every
    renderer to do this for instance if Fizz handles a float method we don't
    want Fiber to as well so each dispatcher implementation can decide if it
    makes sense to forward the call or not. For float methods server
    disaptchers will handle the call if they can resolve a Request otherwise
    they will forward. For client dispatchers they will handle the call and
    always forward. The choice needs to be made for each dispatcher method
    and may have implications on correct renderer import order. For now we
    just live with the restriction that if you want to use server and client
    together (such as renderToString in the browser) you need to import the
    server renderer after the client renderer.

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 173ff58379..10a6324b23 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -93,7 +93,8 @@ const forks = Object.freeze({
     if (
       entry === 'react-dom' ||
       entry === 'react-dom/server-rendering-stub' ||
-      entry === 'react-dom/src/ReactDOMServer.js'
+      entry === 'react-dom/src/ReactDOMServer.js' ||
+      entry === 'react-dom/unstable_testing'
     ) {
       return './packages/react-dom/src/ReactDOMSharedInternals.js';
     }

commit 89021fb4ec9aa82194b0788566e736a4cedfc0e4
Author: Sebastian Markbåge <sebastian@calyptus.eu>
Date:   Mon Mar 11 17:17:07 2024 -0700

    Remove invokeGuardedCallback and replay trick (#28515)
    
    We broke the ability to "break on uncaught exceptions" by adding a
    try/catch higher up in the scheduling. We're giving up on fixing that so
    we can remove the replay trick inside an event handler.
    
    The issue with that approach is that we end up double logging a lot of
    errors in DEV since they get reported to the page.
    
    It's also a lot of complexity around this feature.

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 10a6324b23..eef64866e1 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -232,18 +232,6 @@ const forks = Object.freeze({
     }
   },
 
-  // Different wrapping/reporting for caught errors.
-  './packages/shared/invokeGuardedCallbackImpl.js': (bundleType, entry) => {
-    switch (bundleType) {
-      case FB_WWW_DEV:
-      case FB_WWW_PROD:
-      case FB_WWW_PROFILING:
-        return './packages/shared/forks/invokeGuardedCallbackImpl.www.js';
-      default:
-        return null;
-    }
-  },
-
   // Different dialogs for caught errors.
   './packages/react-reconciler/src/ReactFiberErrorDialog.js': (
     bundleType,

commit a0537160771bafae90c6fd3154eeead2f2c903e7
Author: Sebastian Markbåge <sebastian@calyptus.eu>
Date:   Tue Mar 26 21:51:37 2024 -0700

    Make onUncaughtError and onCaughtError Configurable (#28641)
    
    Stacked on #28627.
    
    This makes error logging configurable using these
    `createRoot`/`hydrateRoot` options:
    
    ```
    onUncaughtError(error: mixed, errorInfo: {componentStack?: ?string}) => void
    onCaughtError(error: mixed, errorInfo: {componentStack?: ?string, errorBoundary?: ?React.Component<any, any>}) => void
    onRecoverableError(error: mixed, errorInfo: {digest?: ?string, componentStack?: ?string}) => void
    ```
    
    We already have the `onRecoverableError` option since before.
    
    Overriding these can be used to implement custom error dialogs (with
    access to the `componentStack`).
    
    It can also be used to silence caught errors when testing an error
    boundary or if you prefer not getting logs for caught errors that you've
    already handled in an error boundary.
    
    I currently expose the error boundary instance but I think we should
    probably remove that since it doesn't make sense for non-class error
    boundaries and isn't very useful anyway. It's also unclear what it
    should do when an error is rethrown from one boundary to another.
    
    Since these are public APIs now we can implement the
    ReactFiberErrorDialog forks using these options at the roots of the
    builds. So I unforked those files and instead passed a custom option for
    the native and www builds.
    
    To do this I had to fork the ReactDOMLegacy file into ReactDOMRootFB
    which is a duplication but that will go away as soon as the FB fork is
    the only legacy root.

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index eef64866e1..f1ed750c22 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -232,36 +232,6 @@ const forks = Object.freeze({
     }
   },
 
-  // Different dialogs for caught errors.
-  './packages/react-reconciler/src/ReactFiberErrorDialog.js': (
-    bundleType,
-    entry
-  ) => {
-    switch (bundleType) {
-      case FB_WWW_DEV:
-      case FB_WWW_PROD:
-      case FB_WWW_PROFILING:
-        // Use the www fork which shows an error dialog.
-        return './packages/react-reconciler/src/forks/ReactFiberErrorDialog.www.js';
-      case RN_OSS_DEV:
-      case RN_OSS_PROD:
-      case RN_OSS_PROFILING:
-      case RN_FB_DEV:
-      case RN_FB_PROD:
-      case RN_FB_PROFILING:
-        switch (entry) {
-          case 'react-native-renderer':
-          case 'react-native-renderer/fabric':
-            // Use the RN fork which plays well with redbox.
-            return './packages/react-reconciler/src/forks/ReactFiberErrorDialog.native.js';
-          default:
-            return null;
-        }
-      default:
-        return null;
-    }
-  },
-
   './packages/react-reconciler/src/ReactFiberConfig.js': (
     bundleType,
     entry,

commit 95e6f032cf59f27b41e150e8a7746ee689acf634
Author: Jack Pope <jackpope1@gmail.com>
Date:   Mon Apr 1 10:56:28 2024 -0400

    Clarify RTR native feature flags are fb specific (#28679)
    
    Make it more clear that these flags aren't used in RN OSS.
    - Rename
    `packages/shared/forks/ReactFeatureFlags.test-renderer.native.js` to
    `packages/shared/forks/ReactFeatureFlags.test-renderer.native-fb.js`
    - Remove RN OSS build cases consuming the feature flags since there is
    no RN OSS RTR build.

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index f1ed750c22..65e72e8a54 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -153,10 +153,7 @@ const forks = Object.freeze({
           case RN_FB_DEV:
           case RN_FB_PROD:
           case RN_FB_PROFILING:
-          case RN_OSS_DEV:
-          case RN_OSS_PROD:
-          case RN_OSS_PROFILING:
-            return './packages/shared/forks/ReactFeatureFlags.test-renderer.native.js';
+            return './packages/shared/forks/ReactFeatureFlags.test-renderer.native-fb.js';
           case FB_WWW_DEV:
           case FB_WWW_PROD:
           case FB_WWW_PROFILING:

commit 9007fdc8f103a5d9247be384791496db9a3be91d
Author: Josh Story <story@hey.com>
Date:   Mon Apr 8 13:39:39 2024 -0700

    [DOM] Shrink ReactDOMSharedInternals source representation (#28771)
    
    Stacked on #28751
    
    ReactDOMSharedInternals uses properties of considerable length to model
    mutuable state. These properties are not mangled during minification and
    contribute a not insigificant amount to the uncompressed bundle size and
    to a lesser degree compressed bundle size.
    
    This change rewrites the DOMInternals in a way that shortens property
    names so we can have smaller builds.
    It also treats the entire object as a mutable container rather than
    having different mutable sub objects.
    
    The same treatment should be given to ReactSharedInternals

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 65e72e8a54..7cfdf58965 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -96,7 +96,15 @@ const forks = Object.freeze({
       entry === 'react-dom/src/ReactDOMServer.js' ||
       entry === 'react-dom/unstable_testing'
     ) {
-      return './packages/react-dom/src/ReactDOMSharedInternals.js';
+      if (
+        bundleType === FB_WWW_DEV ||
+        bundleType === FB_WWW_PROD ||
+        bundleType === FB_WWW_PROFILING
+      ) {
+        return './packages/react-dom/src/ReactDOMSharedInternalsFB.js';
+      } else {
+        return './packages/react-dom/src/ReactDOMSharedInternals.js';
+      }
     }
     if (
       !entry.startsWith('react-dom/') &&

commit c771016e19384e4b6e42e1c275bdf03fe51c2907
Author: Sebastian Markbåge <sebastian@calyptus.eu>
Date:   Mon Apr 8 22:34:59 2024 -0400

    Rename The Secret Export of Server Internals (#28786)
    
    We have a different set of dispatchers that Flight uses. This also
    includes the `jsx-runtime` which must also be aliased to use the right
    version.
    
    To ensure the right versions are used together we rename the export of
    the SharedInternals from 'react' and alias it in relevant bundles.

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 7cfdf58965..f12f36744b 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -58,7 +58,9 @@ const forks = Object.freeze({
   './packages/shared/ReactSharedInternals.js': (
     bundleType,
     entry,
-    dependencies
+    dependencies,
+    _moduleType,
+    bundle
   ) => {
     if (entry === 'react') {
       return './packages/react/src/ReactSharedInternalsClient.js';
@@ -69,6 +71,9 @@ const forks = Object.freeze({
     ) {
       return './packages/react/src/ReactSharedInternalsServer.js';
     }
+    if (bundle.condition === 'react-server') {
+      return './packages/react-server/src/ReactSharedInternalsServer.js';
+    }
     if (!entry.startsWith('react/') && dependencies.indexOf('react') === -1) {
       // React internals are unavailable if we can't reference the package.
       // We return an error because we only want to throw if this module gets used.

commit da6ba53b10d8240fc251ba14a3e5878604d3dc7d
Author: Josh Story <story@hey.com>
Date:   Wed Apr 17 11:15:27 2024 -0700

    [UMD] Remove umd builds (#28735)
    
    In React 19 React will finally stop publishing UMD builds. This is
    motivated primarily by the lack of use of UMD format and the added
    complexity of maintaining build infra for these releases. Additionally
    with ESM becoming more prevalent in browsers and services like esm.sh
    which can host React as an ESM module there are other options for doing
    script tag based react loading.
    
    This PR removes all the UMD build configs and forks.
    
    There are some fixtures that still have references to UMD builds however
    many of them already do not work (for instance they are using legacy
    features like ReactDOM.render) and rather than block the removal on
    these fixtures being brought up to date we'll just move forward and fix
    or removes fixtures as necessary in the future.

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index f12f36744b..98449cf8f8 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -5,9 +5,6 @@ const {bundleTypes, moduleTypes} = require('./bundles');
 const inlinedHostConfigs = require('../shared/inlinedHostConfigs');
 
 const {
-  UMD_DEV,
-  UMD_PROD,
-  UMD_PROFILING,
   FB_WWW_DEV,
   FB_WWW_PROD,
   FB_WWW_PROFILING,
@@ -188,25 +185,6 @@ const forks = Object.freeze({
     return null;
   },
 
-  './packages/scheduler/index.js': (bundleType, entry, dependencies) => {
-    switch (bundleType) {
-      case UMD_DEV:
-      case UMD_PROD:
-      case UMD_PROFILING:
-        if (dependencies.indexOf('react') === -1) {
-          // It's only safe to use this fork for modules that depend on React,
-          // because they read the re-exported API from the SECRET_INTERNALS object.
-          return null;
-        }
-        // Optimization: for UMDs, use the API that is already a part of the React
-        // package instead of requiring it to be loaded via a separate <script> tag
-        return './packages/shared/forks/Scheduler.umd.js';
-      default:
-        // For other bundles, use the shared NPM package.
-        return null;
-    }
-  },
-
   './packages/scheduler/src/SchedulerFeatureFlags.js': (
     bundleType,
     entry,
@@ -231,17 +209,6 @@ const forks = Object.freeze({
     }
   },
 
-  './packages/react/src/ReactSharedInternalsClient.js': (bundleType, entry) => {
-    switch (bundleType) {
-      case UMD_DEV:
-      case UMD_PROD:
-      case UMD_PROFILING:
-        return './packages/react/src/forks/ReactSharedInternalsClient.umd.js';
-      default:
-        return null;
-    }
-  },
-
   './packages/react-reconciler/src/ReactFiberConfig.js': (
     bundleType,
     entry,

commit 1cd77a4ff7a2189003965246a3cfc475d2d9857d
Author: Jan Kassens <jkassens@meta.com>
Date:   Thu Apr 18 16:41:04 2024 -0400

    Remove ReactFlightFB bundles (#28864)
    
    Remove ReactFlightFB bundles

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 98449cf8f8..35b9a5421c 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -62,10 +62,7 @@ const forks = Object.freeze({
     if (entry === 'react') {
       return './packages/react/src/ReactSharedInternalsClient.js';
     }
-    if (
-      entry === 'react/src/ReactServer.js' ||
-      entry === 'react/src/ReactServerFB.js'
-    ) {
+    if (entry === 'react/src/ReactServer.js') {
       return './packages/react/src/ReactSharedInternalsServer.js';
     }
     if (bundle.condition === 'react-server') {

commit cb151849e13f46ec64570519cb93d5939fb60cab
Author: Josh Story <story@hey.com>
Date:   Wed Apr 24 08:50:32 2024 -0700

    [react-dom] move all client code to `react-dom/client` (#28271)
    
    This PR reorganizes the `react-dom` entrypoint to only pull in code that
    is environment agnostic. Previously if you required anything from this
    entrypoint in any environment the entire client reconciler was loaded.
    In a prior release we added a server rendering stub which you could
    alias in server environments to omit this unecessary code. After landing
    this change this entrypoint should not load any environment specific
    code.
    
    While a few APIs are truly client (browser) only such as createRoot and
    hydrateRoot many of the APIs you import from this package are only
    useful in the browser but could concievably be imported in shared code
    (components running in Fizz or shared components as part of an RSC app).
    To avoid making these require opting into the client bundle we are
    keeping them in the `react-dom` entrypoint and changing their
    implementation so that in environments where they are not particularly
    useful they do something benign and expected.
    
    #### Removed APIs
    The following APIs are being removed in the next major. Largely they
    have all been deprecated already and are part of legacy rendering modes
    where concurrent features of React are not available
    * `render`
    * `hydrate`
    * `findDOMNode`
    * `unmountComponentAtNode`
    * `unstable_createEventHandle`
    * `unstable_renderSubtreeIntoContainer`
    * `unstable_runWithPrioirty`
    
    #### moved Client APIs
    These APIs were available on both `react-dom` (with a warning) and
    `react-dom/client`. After this change they are only available on
    `react-dom/client`
    * `createRoot`
    * `hydrateRoot`
    
    #### retained APIs
    These APIs still exist on the `react-dom` entrypoint but have normalized
    behavior depending on which renderers are currently in scope
    * `flushSync`: will execute the function (if provided) inside the
    flushSync implemention of FlightServer, Fizz, and Fiber DOM renderers.
    * `unstable_batchedUpdates`: This is a noop in concurrent mode because
    it is now the only supported behavior because there is no legacy
    rendering mode
    * `createPortal`: This just produces an object. It can be called from
    anywhere but since you will probably not have a handle on a DOM node to
    pass to it it will likely warn in environments other than the browser
    * preloading APIS such as `preload`: These methods will execute the
    preload across all renderers currently in scope. Since we resolve the
    Request object on the server using AsyncLocalStorage or the current
    function stack in practice only one renderer should act upon the
    preload.
    
    In addition to these changes the server rendering stub now just rexports
    everything from `react-dom`. In a future minor we will add a warning
    when using the stub and in the next major we will remove the stub
    altogether

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 35b9a5421c..a83b8b1b1a 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -91,9 +91,9 @@ const forks = Object.freeze({
   ) => {
     if (
       entry === 'react-dom' ||
-      entry === 'react-dom/server-rendering-stub' ||
-      entry === 'react-dom/src/ReactDOMServer.js' ||
-      entry === 'react-dom/unstable_testing'
+      entry === 'react-dom/src/ReactDOMFB.js' ||
+      entry === 'react-dom/src/ReactDOMTestingFB.js' ||
+      entry === 'react-dom/src/ReactDOMServer.js'
     ) {
       if (
         bundleType === FB_WWW_DEV ||

commit ffec9ec5b5c846f61d7b40e92f138e2a7b34f273
Author: Sebastian Markbåge <sebastian@calyptus.eu>
Date:   Thu Jun 27 18:09:40 2024 +0200

    Add new package with renderToMarkup export (#30105)
    
    Name of the package is tbd (straw: `react-html`). It's a new package
    separate from `react-dom` though and can be used as a standalone package
    - e.g. also from a React Native app.
    
    ```js
    import {renderToMarkup} from '...';
    const html = await renderToMarkup(<Component />);
    ```
    
    The idea is that this is a helper for rendering HTML that is not
    intended to be hydrated. It's primarily intended to support a subset of
    HTML that can be used as embedding and not served as HTML documents from
    HTTP. For example as e-mails or in RSS/Atom feeds or other
    distributions. It's a successor to `renderToStaticMarkup`.
    
    A few differences:
    
    - This doesn't support "Client Components". It can only use the Server
    Components subset. No useEffect, no useState etc. since it will never be
    hydrated. Use of those are errors.
    - You also can't pass Client References so you can't use components
    marked with `"use client"`.
    - Unlike `renderToStaticMarkup` this does support async so you can
    suspend and use data from these components.
    - Unlike `renderToReadableStream` this does not support streaming or
    Suspense boundaries and any error rejects the promise. Since there's no
    feasible way to "client render" or patch up the document.
    - Form Actions are not supported since in an embedded environment
    there's no place to post back to across versions. You can render plain
    forms with fixed URLs though.
    - You can't use any resource preloading like `preload()` from
    `react-dom`.
    
    ## Implementation
    
    This first version in this PR only supports Server Components since
    that's the thing that doesn't have an existing API. Might add a Client
    Components version later that errors.
    
    We don't want to maintain a completely separate implementation for this
    use case so this uses the `dom-legacy` build dimension to wire up a
    build that encapsulates a Flight Server -> Flight Client -> Fizz stream
    to render Server Components that then get SSR:ed.
    
    There's no problem to use a Flight Client in a Server Component
    environment since it's already supported for Server-to-Server. Both of
    these use a bundler config that just errors for Client References though
    since we don't need any bundling integration and this is just a
    standalone package.
    
    Running Fizz in a Server Component environment is a problem though
    because it depends on "react" and it needs the client version.
    Therefore, for this build we embed the client version of "react" shared
    internals into the build. It doesn't need anything to be able to use
    those APIs since you can't call the client APIs anyway.
    
    One unfortunate thing though is that since Flight currently needs to go
    to binary and back, we need TextEncoder/TextDecoder to be available but
    this shouldn't really be necessary. Also since we use the legacy stream
    config, large strings that use byteLengthOfChunk errors atm. This needs
    to be fixed before shipping. I'm not sure what would be the best
    layering though that isn't unnecessarily burdensome to maintain. Maybe
    some kind of pass-through protocol that would also be useful in general
    - e.g. when Fizz and Flight are in the same process.
    
    ---------
    
    Co-authored-by: Sebastian Silbermann <silbermann.sebastian@gmail.com>

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index a83b8b1b1a..0ba6827bba 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -65,6 +65,12 @@ const forks = Object.freeze({
     if (entry === 'react/src/ReactServer.js') {
       return './packages/react/src/ReactSharedInternalsServer.js';
     }
+    if (entry === 'react-html/src/ReactHTMLServer.js') {
+      // Inside the ReactHTMLServer render we don't refer to any shared internals
+      // but instead use our own internal copy of the state because you cannot use
+      // any of this state from a component anyway. E.g. you can't use a client hook.
+      return './packages/react/src/ReactSharedInternalsClient.js';
+    }
     if (bundle.condition === 'react-server') {
       return './packages/react-server/src/ReactSharedInternalsServer.js';
     }
@@ -93,7 +99,8 @@ const forks = Object.freeze({
       entry === 'react-dom' ||
       entry === 'react-dom/src/ReactDOMFB.js' ||
       entry === 'react-dom/src/ReactDOMTestingFB.js' ||
-      entry === 'react-dom/src/ReactDOMServer.js'
+      entry === 'react-dom/src/ReactDOMServer.js' ||
+      entry === 'react-html/src/ReactHTMLServer.js'
     ) {
       if (
         bundleType === FB_WWW_DEV ||

commit 1e241f9d6c5f7d0e875b19a99c83cd6197fa62f7
Author: Sebastian Markbåge <sebastian@calyptus.eu>
Date:   Fri Jun 28 15:25:10 2024 +0200

    Add renderToMarkup for Client Components (#30121)
    
    Follow up to #30105.
    
    This supports `renderToMarkup` in a non-RSC environment (not the
    `react-server` condition).
    
    This is just a Fizz renderer but it errors at runtime when you use
    state, effects or event handlers that would require hydration - like the
    RSC version would. (Except RSC can give early errors too.)
    
    To do this I have to move the `react-html` builds to a new `markup`
    dimension out of the `dom-legacy` dimension so that we can configure
    this differently from `renderToString`/`renderToStaticMarkup`.
    Eventually that dimension can go away though if deprecated. That also
    helps us avoid dynamic configuration and we can just compile in the
    right configuration so the split helps anyway.
    
    One consideration is that if a compiler strips out useEffects or inlines
    initial state from useState, then it would not get called an the error
    wouldn't happen. Therefore to preserve semantics, a compiler would need
    to inject some call that can check the current renderer and whether it
    should throw.
    
    There is an argument that it could be useful to not error for these
    because it's possible to write components that works with SSR but are
    just optionally hydrated. However, there's also an argument that doing
    that silently is too easy to lead to mistakes and it's better to error -
    especially for the e-mail use case where you can't take it back but you
    can replay a queue that had failures. There are other ways to
    conditionally branch components intentionally. Besides if you want it to
    be silent you can still use renderToString (or better yet
    renderToReadableStream).
    
    The primary mechanism is the RSC environment and the client-environment
    is really the secondary one that's only there to support legacy
    environments. So this also ensures parity with the primary environment.

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 0ba6827bba..cffc66d232 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -100,6 +100,7 @@ const forks = Object.freeze({
       entry === 'react-dom/src/ReactDOMFB.js' ||
       entry === 'react-dom/src/ReactDOMTestingFB.js' ||
       entry === 'react-dom/src/ReactDOMServer.js' ||
+      entry === 'react-html/src/ReactHTMLClient.js' ||
       entry === 'react-html/src/ReactHTMLServer.js'
     ) {
       if (

commit 9647333b3d5a5d2a3ca7fe2a78d2d3da24bc4984
Author: Sebastian Markbåge <sebastian@calyptus.eu>
Date:   Wed Jul 10 13:37:56 2024 -0400

    Add RN fork of consoleWithStackDev so we can improve the mainline one (#30305)
    
    We're removing this wrapper from the mainline but RN is still using
    component stacks to filter out warnings.
    
    This is unfortunate since it'll be hard to keep track of the interplay
    with these, DevTools and how you're supposed to implement error dialogs
    in userspace.

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index cffc66d232..9dcbc6c0b7 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -209,6 +209,9 @@ const forks = Object.freeze({
     switch (bundleType) {
       case FB_WWW_DEV:
         return './packages/shared/forks/consoleWithStackDev.www.js';
+      case RN_OSS_DEV:
+      case RN_FB_DEV:
+        return './packages/shared/forks/consoleWithStackDev.rn.js';
       default:
         return null;
     }

commit e0a0e65412cfa00e959fbef0f6c3a0c73725f0a3
Author: Sebastian Silbermann <sebastian.silbermann@vercel.com>
Date:   Wed Aug 14 19:22:44 2024 +0200

    Move `react-html` to `react-markup` (#30688)

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 9dcbc6c0b7..8539ce7f7c 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -65,8 +65,8 @@ const forks = Object.freeze({
     if (entry === 'react/src/ReactServer.js') {
       return './packages/react/src/ReactSharedInternalsServer.js';
     }
-    if (entry === 'react-html/src/ReactHTMLServer.js') {
-      // Inside the ReactHTMLServer render we don't refer to any shared internals
+    if (entry === 'react-markup/src/ReactMarkupServer.js') {
+      // Inside the ReactMarkupServer render we don't refer to any shared internals
       // but instead use our own internal copy of the state because you cannot use
       // any of this state from a component anyway. E.g. you can't use a client hook.
       return './packages/react/src/ReactSharedInternalsClient.js';
@@ -100,8 +100,8 @@ const forks = Object.freeze({
       entry === 'react-dom/src/ReactDOMFB.js' ||
       entry === 'react-dom/src/ReactDOMTestingFB.js' ||
       entry === 'react-dom/src/ReactDOMServer.js' ||
-      entry === 'react-html/src/ReactHTMLClient.js' ||
-      entry === 'react-html/src/ReactHTMLServer.js'
+      entry === 'react-markup/src/ReactMarkupClient.js' ||
+      entry === 'react-markup/src/ReactMarkupServer.js'
     ) {
       if (
         bundleType === FB_WWW_DEV ||

commit 156eab2f7b34fe78ef26a1752f95bfdc2092819d
Author: Sebastian Markbåge <sebastian@calyptus.eu>
Date:   Tue Nov 5 15:05:04 2024 -0500

    Fork the "empty" prepareStackTrace case for Server builds (#31427)
    
    We don't actually want the source mapped version of `.stack` from errors
    because that would cause us to not be able to associate it with a source
    map in the UIs that need it. The strategy in browsers is more correct
    where the display is responsible for source maps.
    
    That's why we disable any custom `prepareStackTrace` like the ones added
    by `source-map`. We reset it to `undefined`.
    
    However, when running node with `--enable-source-maps` the default for
    `prepareStackTrace` which is a V8 feature (but may exist elsewhere too
    like Bun) is a source mapped version of the stack. In those environments
    we need to reset it to a default implementation that doesn't apply
    source maps.
    
    We already did this in Flight using the `ReactFlightStackConfigV8.js`
    config. However, we need this more generally in the
    `shared/ReactComponentStackFrame` implementation.
    
    We could always set it to the default implementation instead of
    `undefined` but that's unnecessary code in browser builds and it might
    lead to slightly different results. For safety and code size, this PR
    does it with a fork instead.
    
    All builds specific to `node` or `edge` (or `markup` which is a server
    feature) gets the default implementation where as everything else (e.g.
    browsers) get `undefined` since it's expected that this is not source
    mapped. We don't have to do anything about the equivalent in React
    DevTools since React DevTools doesn't run on the server.

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 8539ce7f7c..2d6f718c76 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -217,6 +217,36 @@ const forks = Object.freeze({
     }
   },
 
+  './packages/shared/DefaultPrepareStackTrace.js': (
+    bundleType,
+    entry,
+    dependencies,
+    moduleType
+  ) => {
+    if (moduleType !== RENDERER && moduleType !== RECONCILER) {
+      return null;
+    }
+    // eslint-disable-next-line no-for-of-loops/no-for-of-loops
+    for (let rendererInfo of inlinedHostConfigs) {
+      if (rendererInfo.entryPoints.indexOf(entry) !== -1) {
+        if (!rendererInfo.isServerSupported) {
+          return null;
+        }
+        const foundFork = findNearestExistingForkFile(
+          './packages/shared/forks/DefaultPrepareStackTrace.',
+          rendererInfo.shortName,
+          '.js'
+        );
+        if (foundFork) {
+          return foundFork;
+        }
+        // fall through to error
+        break;
+      }
+    }
+    return null;
+  },
+
   './packages/react-reconciler/src/ReactFiberConfig.js': (
     bundleType,
     entry,

commit bd76ce54d93153cc84d861bd59e906bc28e1c160
Author: Jack Pope <jackpope1@gmail.com>
Date:   Thu Dec 19 11:49:14 2024 -0500

    Fork Scheduler feature flags for native-fb (#31859)
    
    #31787 introduces an experimental scheduler flag:
    `enableAlwaysYieldScheduler`, which is turned off for www. There wasn't
    a SchedulerFeatureFlags fork for native-fb, so the experimental change
    was enabled in the Scheduler-dev build there which causes test failures
    and is blocking the sync.
    
    #31805 introduces another scheduler flag `enableRequestPaint`, which is
    set as a `__VARIANT__` on www. I've set this to `true` here to preserve
    the existing behavior. We can follow up with dynamic flags for native-fb
    after unblocking the sync.

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 2d6f718c76..5460304366 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -195,14 +195,18 @@ const forks = Object.freeze({
     entry,
     dependencies
   ) => {
-    if (
-      bundleType === FB_WWW_DEV ||
-      bundleType === FB_WWW_PROD ||
-      bundleType === FB_WWW_PROFILING
-    ) {
-      return './packages/scheduler/src/forks/SchedulerFeatureFlags.www.js';
+    switch (bundleType) {
+      case FB_WWW_DEV:
+      case FB_WWW_PROD:
+      case FB_WWW_PROFILING:
+        return './packages/scheduler/src/forks/SchedulerFeatureFlags.www.js';
+      case RN_FB_DEV:
+      case RN_FB_PROD:
+      case RN_FB_PROFILING:
+        return './packages/scheduler/src/forks/SchedulerFeatureFlags.native-fb.js';
+      default:
+        return './packages/scheduler/src/SchedulerFeatureFlags.js';
     }
-    return './packages/scheduler/src/SchedulerFeatureFlags.js';
   },
 
   './packages/shared/consoleWithStackDev.js': (bundleType, entry) => {

commit 25677265038b89c1ee3000e0669339ed160d9d75
Author: Rick Hanlon <rickhanlonii@gmail.com>
Date:   Mon Feb 24 10:00:22 2025 -0500

    [flags] remove enableRemoveConsolePatches (#32425)
    
    wait to merge until we sync
    https://github.com/facebook/react/pull/32376, since that enables it in
    some testing builds that might break

diff --git a/scripts/rollup/forks.js b/scripts/rollup/forks.js
index 5460304366..33c7c96abb 100644
--- a/scripts/rollup/forks.js
+++ b/scripts/rollup/forks.js
@@ -209,18 +209,6 @@ const forks = Object.freeze({
     }
   },
 
-  './packages/shared/consoleWithStackDev.js': (bundleType, entry) => {
-    switch (bundleType) {
-      case FB_WWW_DEV:
-        return './packages/shared/forks/consoleWithStackDev.www.js';
-      case RN_OSS_DEV:
-      case RN_FB_DEV:
-        return './packages/shared/forks/consoleWithStackDev.rn.js';
-      default:
-        return null;
-    }
-  },
-
   './packages/shared/DefaultPrepareStackTrace.js': (
     bundleType,
     entry,

