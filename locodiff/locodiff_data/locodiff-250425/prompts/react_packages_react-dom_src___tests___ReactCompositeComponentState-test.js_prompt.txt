# Instructions

You are being benchmarked. You will see the output of a git log command, and from that must infer the current state of a file. Think carefully, as you must output the exact state of the file to earn full marks.

**Important:** Your goal is to reproduce the file's content *exactly* as it exists at the final commit, even if the code appears broken, buggy, or contains obvious errors. Do **not** try to "fix" the code. Attempting to correct issues will result in a poor score, as this benchmark evaluates your ability to reproduce the precise state of the file based on its history.

# Required Response Format

Wrap the content of the file in triple backticks (```). Any text outside the final closing backticks will be ignored. End your response after outputting the closing backticks.

# Example Response

```python
#!/usr/bin/env python
print('Hello, world!')
```

# File History

> git log -p --cc --topo-order --reverse -- packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js

commit d9c1dbd61772f8f8ab0cdf389e70463d704c480b
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Thu Oct 19 00:22:21 2017 +0100

    Use Yarn Workspaces (#11252)
    
    * Enable Yarn workspaces for packages/*
    
    * Move src/isomorphic/* into packages/react/src/*
    
    * Create index.js stubs for all packages in packages/*
    
    This makes the test pass again, but breaks the build because npm/ folders aren't used yet.
    I'm not sure if we'll keep this structure--I'll just keep working and fix the build after it settles down.
    
    * Put FB entry point for react-dom into packages/*
    
    * Move src/renderers/testing/* into packages/react-test-renderer/src/*
    
    Note that this is currently broken because Jest ignores node_modules,
    and so Yarn linking makes Jest skip React source when transforming.
    
    * Remove src/node_modules
    
    It is now unnecessary. Some tests fail though.
    
    * Add a hacky workaround for Jest/Workspaces issue
    
    Jest sees node_modules and thinks it's third party code.
    
    This is a hacky way to teach Jest to still transform anything in node_modules/react*
    if it resolves outside of node_modules (such as to our packages/*) folder.
    
    I'm not very happy with this and we should revisit.
    
    * Add a fake react-native package
    
    * Move src/renderers/art/* into packages/react-art/src/*
    
    * Move src/renderers/noop/* into packages/react-noop-renderer/src/*
    
    * Move src/renderers/dom/* into packages/react-dom/src/*
    
    * Move src/renderers/shared/fiber/* into packages/react-reconciler/src/*
    
    * Move DOM/reconciler tests I previously forgot to move
    
    * Move src/renderers/native-*/* into packages/react-native-*/src/*
    
    * Move shared code into packages/shared
    
    It's not super clear how to organize this properly yet.
    
    * Add back files that somehow got lost
    
    * Fix the build
    
    * Prettier
    
    * Add missing license headers
    
    * Fix an issue that caused mocks to get included into build
    
    * Update other references to src/
    
    * Re-run Prettier
    
    * Fix lint
    
    * Fix weird Flow violation
    
    I didn't change this file but Flow started complaining.
    Caleb said this annotation was unnecessarily using $Abstract though so I removed it.
    
    * Update sizes
    
    * Fix stats script
    
    * Fix packaging fixtures
    
    Use file: instead of NODE_PATH since NODE_PATH.
    NODE_PATH trick only worked because we had no react/react-dom in root node_modules, but now we do.
    
    file: dependency only works as I expect in Yarn, so I moved the packaging fixtures to use Yarn and committed lockfiles.
    Verified that the page shows up.
    
    * Fix art fixture
    
    * Fix reconciler fixture
    
    * Fix SSR fixture
    
    * Rename native packages

diff --git a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
new file mode 100644
index 0000000000..e2e04fa70f
--- /dev/null
+++ b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
@@ -0,0 +1,465 @@
+/**
+ * Copyright (c) 2013-present, Facebook, Inc.
+ *
+ * This source code is licensed under the MIT license found in the
+ * LICENSE file in the root directory of this source tree.
+ *
+ * @emails react-core
+ */
+
+'use strict';
+
+var React;
+var ReactDOM;
+
+var TestComponent;
+
+describe('ReactCompositeComponent-state', () => {
+  beforeEach(() => {
+    React = require('react');
+
+    ReactDOM = require('react-dom');
+
+    TestComponent = class extends React.Component {
+      constructor(props) {
+        super(props);
+        this.peekAtState('getInitialState', undefined, props);
+        this.state = {color: 'red'};
+      }
+
+      peekAtState = (from, state = this.state, props = this.props) => {
+        props.stateListener(from, state && state.color);
+      };
+
+      peekAtCallback = from => {
+        return () => this.peekAtState(from);
+      };
+
+      setFavoriteColor(nextColor) {
+        this.setState(
+          {color: nextColor},
+          this.peekAtCallback('setFavoriteColor'),
+        );
+      }
+
+      render() {
+        this.peekAtState('render');
+        return <div>{this.state.color}</div>;
+      }
+
+      componentWillMount() {
+        this.peekAtState('componentWillMount-start');
+        this.setState(function(state) {
+          this.peekAtState('before-setState-sunrise', state);
+        });
+        this.setState(
+          {color: 'sunrise'},
+          this.peekAtCallback('setState-sunrise'),
+        );
+        this.setState(function(state) {
+          this.peekAtState('after-setState-sunrise', state);
+        });
+        this.peekAtState('componentWillMount-after-sunrise');
+        this.setState(
+          {color: 'orange'},
+          this.peekAtCallback('setState-orange'),
+        );
+        this.setState(function(state) {
+          this.peekAtState('after-setState-orange', state);
+        });
+        this.peekAtState('componentWillMount-end');
+      }
+
+      componentDidMount() {
+        this.peekAtState('componentDidMount-start');
+        this.setState(
+          {color: 'yellow'},
+          this.peekAtCallback('setState-yellow'),
+        );
+        this.peekAtState('componentDidMount-end');
+      }
+
+      componentWillReceiveProps(newProps) {
+        this.peekAtState('componentWillReceiveProps-start');
+        if (newProps.nextColor) {
+          this.setState(function(state) {
+            this.peekAtState('before-setState-receiveProps', state);
+            return {color: newProps.nextColor};
+          });
+          // No longer a public API, but we can test that it works internally by
+          // reaching into the updater.
+          this.updater.enqueueReplaceState(this, {color: undefined});
+          this.setState(function(state) {
+            this.peekAtState('before-setState-again-receiveProps', state);
+            return {color: newProps.nextColor};
+          }, this.peekAtCallback('setState-receiveProps'));
+          this.setState(function(state) {
+            this.peekAtState('after-setState-receiveProps', state);
+          });
+        }
+        this.peekAtState('componentWillReceiveProps-end');
+      }
+
+      shouldComponentUpdate(nextProps, nextState) {
+        this.peekAtState('shouldComponentUpdate-currentState');
+        this.peekAtState('shouldComponentUpdate-nextState', nextState);
+        return true;
+      }
+
+      componentWillUpdate(nextProps, nextState) {
+        this.peekAtState('componentWillUpdate-currentState');
+        this.peekAtState('componentWillUpdate-nextState', nextState);
+      }
+
+      componentDidUpdate(prevProps, prevState) {
+        this.peekAtState('componentDidUpdate-currentState');
+        this.peekAtState('componentDidUpdate-prevState', prevState);
+      }
+
+      componentWillUnmount() {
+        this.peekAtState('componentWillUnmount');
+      }
+    };
+  });
+
+  it('should support setting state', () => {
+    var container = document.createElement('div');
+    document.body.appendChild(container);
+
+    var stateListener = jest.fn();
+    var instance = ReactDOM.render(
+      <TestComponent stateListener={stateListener} />,
+      container,
+      function peekAtInitialCallback() {
+        this.peekAtState('initial-callback');
+      },
+    );
+    ReactDOM.render(
+      <TestComponent stateListener={stateListener} nextColor="green" />,
+      container,
+      instance.peekAtCallback('setProps'),
+    );
+    instance.setFavoriteColor('blue');
+    instance.forceUpdate(instance.peekAtCallback('forceUpdate'));
+
+    ReactDOM.unmountComponentAtNode(container);
+
+    let expected = [
+      // there is no state when getInitialState() is called
+      ['getInitialState', null],
+      ['componentWillMount-start', 'red'],
+      // setState()'s only enqueue pending states.
+      ['componentWillMount-after-sunrise', 'red'],
+      ['componentWillMount-end', 'red'],
+      // pending state queue is processed
+      ['before-setState-sunrise', 'red'],
+      ['after-setState-sunrise', 'sunrise'],
+      ['after-setState-orange', 'orange'],
+      // pending state has been applied
+      ['render', 'orange'],
+      ['componentDidMount-start', 'orange'],
+      // setState-sunrise and setState-orange should be called here,
+      // after the bug in #1740
+      // componentDidMount() called setState({color:'yellow'}), which is async.
+      // The update doesn't happen until the next flush.
+      ['componentDidMount-end', 'orange'],
+      ['setState-sunrise', 'orange'],
+      ['setState-orange', 'orange'],
+      ['initial-callback', 'orange'],
+      ['shouldComponentUpdate-currentState', 'orange'],
+      ['shouldComponentUpdate-nextState', 'yellow'],
+      ['componentWillUpdate-currentState', 'orange'],
+      ['componentWillUpdate-nextState', 'yellow'],
+      ['render', 'yellow'],
+      ['componentDidUpdate-currentState', 'yellow'],
+      ['componentDidUpdate-prevState', 'orange'],
+      ['setState-yellow', 'yellow'],
+      ['componentWillReceiveProps-start', 'yellow'],
+      // setState({color:'green'}) only enqueues a pending state.
+      ['componentWillReceiveProps-end', 'yellow'],
+      // pending state queue is processed
+      // We keep updates in the queue to support
+      // replaceState(prevState => newState).
+      ['before-setState-receiveProps', 'yellow'],
+      ['before-setState-again-receiveProps', undefined],
+      ['after-setState-receiveProps', 'green'],
+      ['shouldComponentUpdate-currentState', 'yellow'],
+      ['shouldComponentUpdate-nextState', 'green'],
+      ['componentWillUpdate-currentState', 'yellow'],
+      ['componentWillUpdate-nextState', 'green'],
+      ['render', 'green'],
+      ['componentDidUpdate-currentState', 'green'],
+      ['componentDidUpdate-prevState', 'yellow'],
+      ['setState-receiveProps', 'green'],
+      ['setProps', 'green'],
+      // setFavoriteColor('blue')
+      ['shouldComponentUpdate-currentState', 'green'],
+      ['shouldComponentUpdate-nextState', 'blue'],
+      ['componentWillUpdate-currentState', 'green'],
+      ['componentWillUpdate-nextState', 'blue'],
+      ['render', 'blue'],
+      ['componentDidUpdate-currentState', 'blue'],
+      ['componentDidUpdate-prevState', 'green'],
+      ['setFavoriteColor', 'blue'],
+      // forceUpdate()
+      ['componentWillUpdate-currentState', 'blue'],
+      ['componentWillUpdate-nextState', 'blue'],
+      ['render', 'blue'],
+      ['componentDidUpdate-currentState', 'blue'],
+      ['componentDidUpdate-prevState', 'blue'],
+      ['forceUpdate', 'blue'],
+      // unmountComponent()
+      // state is available within `componentWillUnmount()`
+      ['componentWillUnmount', 'blue'],
+    ];
+
+    expect(stateListener.mock.calls.join('\n')).toEqual(expected.join('\n'));
+  });
+
+  it('should call componentDidUpdate of children first', () => {
+    var container = document.createElement('div');
+
+    var ops = [];
+
+    var child = null;
+    var parent = null;
+
+    class Child extends React.Component {
+      state = {bar: false};
+      componentDidMount() {
+        child = this;
+      }
+      componentDidUpdate() {
+        ops.push('child did update');
+      }
+      render() {
+        return <div />;
+      }
+    }
+
+    var shouldUpdate = true;
+
+    class Intermediate extends React.Component {
+      shouldComponentUpdate() {
+        return shouldUpdate;
+      }
+      render() {
+        return <Child />;
+      }
+    }
+
+    class Parent extends React.Component {
+      state = {foo: false};
+      componentDidMount() {
+        parent = this;
+      }
+      componentDidUpdate() {
+        ops.push('parent did update');
+      }
+      render() {
+        return <Intermediate />;
+      }
+    }
+
+    ReactDOM.render(<Parent />, container);
+
+    ReactDOM.unstable_batchedUpdates(() => {
+      parent.setState({foo: true});
+      child.setState({bar: true});
+    });
+    // When we render changes top-down in a batch, children's componentDidUpdate
+    // happens before the parent.
+    expect(ops).toEqual(['child did update', 'parent did update']);
+
+    shouldUpdate = false;
+
+    ops = [];
+
+    ReactDOM.unstable_batchedUpdates(() => {
+      parent.setState({foo: false});
+      child.setState({bar: false});
+    });
+    // We expect the same thing to happen if we bail out in the middle.
+    expect(ops).toEqual(['child did update', 'parent did update']);
+  });
+
+  it('should batch unmounts', () => {
+    var outer;
+
+    class Inner extends React.Component {
+      render() {
+        return <div />;
+      }
+
+      componentWillUnmount() {
+        // This should get silently ignored (maybe with a warning), but it
+        // shouldn't break React.
+        outer.setState({showInner: false});
+      }
+    }
+
+    class Outer extends React.Component {
+      state = {showInner: true};
+
+      render() {
+        return <div>{this.state.showInner && <Inner />}</div>;
+      }
+    }
+
+    var container = document.createElement('div');
+    outer = ReactDOM.render(<Outer />, container);
+    expect(() => {
+      ReactDOM.unmountComponentAtNode(container);
+    }).not.toThrow();
+  });
+
+  it('should update state when called from child cWRP', function() {
+    const log = [];
+    class Parent extends React.Component {
+      state = {value: 'one'};
+      render() {
+        log.push('parent render ' + this.state.value);
+        return <Child parent={this} value={this.state.value} />;
+      }
+    }
+    let updated = false;
+    class Child extends React.Component {
+      componentWillReceiveProps() {
+        if (updated) {
+          return;
+        }
+        log.push('child componentWillReceiveProps ' + this.props.value);
+        this.props.parent.setState({value: 'two'});
+        log.push('child componentWillReceiveProps done ' + this.props.value);
+        updated = true;
+      }
+      render() {
+        log.push('child render ' + this.props.value);
+        return <div>{this.props.value}</div>;
+      }
+    }
+    var container = document.createElement('div');
+    ReactDOM.render(<Parent />, container);
+    ReactDOM.render(<Parent />, container);
+    expect(log).toEqual([
+      'parent render one',
+      'child render one',
+      'parent render one',
+      'child componentWillReceiveProps one',
+      'child componentWillReceiveProps done one',
+      'child render one',
+      'parent render two',
+      'child render two',
+    ]);
+  });
+
+  it('should merge state when sCU returns false', function() {
+    const log = [];
+    class Test extends React.Component {
+      state = {a: 0};
+      render() {
+        return null;
+      }
+      shouldComponentUpdate(nextProps, nextState) {
+        log.push(
+          'scu from ' +
+            Object.keys(this.state) +
+            ' to ' +
+            Object.keys(nextState),
+        );
+        return false;
+      }
+    }
+
+    const container = document.createElement('div');
+    const test = ReactDOM.render(<Test />, container);
+    test.setState({b: 0});
+    expect(log.length).toBe(1);
+    test.setState({c: 0});
+    expect(log.length).toBe(2);
+    expect(log).toEqual(['scu from a to a,b', 'scu from a,b to a,b,c']);
+  });
+
+  it('should treat assigning to this.state inside cWRP as a replaceState, with a warning', () => {
+    spyOn(console, 'error');
+
+    let ops = [];
+    class Test extends React.Component {
+      state = {step: 1, extra: true};
+      componentWillReceiveProps() {
+        this.setState({step: 2}, () => {
+          // Tests that earlier setState callbacks are not dropped
+          ops.push(
+            `callback -- step: ${this.state.step}, extra: ${!!this.state.extra}`,
+          );
+        });
+        // Treat like replaceState
+        this.state = {step: 3};
+      }
+      render() {
+        ops.push(
+          `render -- step: ${this.state.step}, extra: ${!!this.state.extra}`,
+        );
+        return null;
+      }
+    }
+
+    // Mount
+    const container = document.createElement('div');
+    ReactDOM.render(<Test />, container);
+    // Update
+    ReactDOM.render(<Test />, container);
+
+    expect(ops).toEqual([
+      'render -- step: 1, extra: true',
+      'render -- step: 3, extra: false',
+      'callback -- step: 3, extra: false',
+    ]);
+    expect(console.error.calls.count()).toEqual(1);
+    expect(console.error.calls.argsFor(0)[0]).toEqual(
+      'Warning: Test.componentWillReceiveProps(): Assigning directly to ' +
+        "this.state is deprecated (except inside a component's constructor). " +
+        'Use setState instead.',
+    );
+  });
+
+  it('should treat assigning to this.state inside cWM as a replaceState, with a warning', () => {
+    spyOn(console, 'error');
+
+    let ops = [];
+    class Test extends React.Component {
+      state = {step: 1, extra: true};
+      componentWillMount() {
+        this.setState({step: 2}, () => {
+          // Tests that earlier setState callbacks are not dropped
+          ops.push(
+            `callback -- step: ${this.state.step}, extra: ${!!this.state.extra}`,
+          );
+        });
+        // Treat like replaceState
+        this.state = {step: 3};
+      }
+      render() {
+        ops.push(
+          `render -- step: ${this.state.step}, extra: ${!!this.state.extra}`,
+        );
+        return null;
+      }
+    }
+
+    // Mount
+    const container = document.createElement('div');
+    ReactDOM.render(<Test />, container);
+
+    expect(ops).toEqual([
+      'render -- step: 3, extra: false',
+      'callback -- step: 3, extra: false',
+    ]);
+    expect(console.error.calls.count()).toEqual(1);
+    expect(console.error.calls.argsFor(0)[0]).toEqual(
+      'Warning: Test.componentWillMount(): Assigning directly to ' +
+        "this.state is deprecated (except inside a component's constructor). " +
+        'Use setState instead.',
+    );
+  });
+});

commit 3f1f3dc12e72809c997d8e1078edfadd7e31bc14
Author: Anushree Subramani <anushreesubramani@users.noreply.github.com>
Date:   Tue Oct 31 18:05:28 2017 +0530

     Deduplicated many warnings (#11140) (#11216)
    
    *  Deduplicated many warnings (#11140)
    
    *  Deduplicated the following warnings:
    
    1.  Can only update a mounted or mounting component.
        This usually means you called setState, replaceState,
        or forceUpdate on an unmounted component. This is a no-op
    
    2.  %s.componentWillReceiveProps(): Assigning directly to
        this.state is deprecated (except inside a component's
        constructor). Use setState instead.'
    
    3.  An update (setState, replaceState, or forceUpdate) was scheduled
        from inside an update function. Update functions should be pure,
        with zero side-effects. Consider using componentDidUpdate or a
        callback.
    
    4.  setState(...): Cannot call setState() inside getChildContext()
    
    * Code review changes made for #11140
    
    * Minor style fix
    
    * Test deduplication for noop updates in server renderer
    
    * Test deduplication for cWRP warning
    
    * Test deduplication for cWM setState warning
    
    * Test deduplication for unnmounted setState warning
    
    * Fix existing Flow typing
    
    * Test deduplication for invalid updates
    
    * Test deduplication of update-in-updater warning

diff --git a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
index e2e04fa70f..d0299ffc99 100644
--- a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
+++ b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
@@ -421,6 +421,10 @@ describe('ReactCompositeComponent-state', () => {
         "this.state is deprecated (except inside a component's constructor). " +
         'Use setState instead.',
     );
+
+    // Check deduplication
+    ReactDOM.render(<Test />, container);
+    expect(console.error.calls.count()).toEqual(1);
   });
 
   it('should treat assigning to this.state inside cWM as a replaceState, with a warning', () => {

commit 94f44aeba72eacb04443974c2c6c91a050d61b1c
Author: Clement Hoang <clement.hoang24@gmail.com>
Date:   Tue Nov 7 18:09:33 2017 +0000

    Update prettier to 1.8.1 (#10785)
    
    * Change prettier dependency in package.json version 1.8.1
    
    * Update yarn.lock
    
    * Apply prettier changes
    
    * Fix ReactDOMServerIntegration-test.js
    
    * Fix test for ReactDOMComponent-test.js

diff --git a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
index d0299ffc99..93b4d9280e 100644
--- a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
+++ b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
@@ -390,7 +390,8 @@ describe('ReactCompositeComponent-state', () => {
         this.setState({step: 2}, () => {
           // Tests that earlier setState callbacks are not dropped
           ops.push(
-            `callback -- step: ${this.state.step}, extra: ${!!this.state.extra}`,
+            `callback -- step: ${this.state.step}, extra: ${!!this.state
+              .extra}`,
           );
         });
         // Treat like replaceState
@@ -437,7 +438,8 @@ describe('ReactCompositeComponent-state', () => {
         this.setState({step: 2}, () => {
           // Tests that earlier setState callbacks are not dropped
           ops.push(
-            `callback -- step: ${this.state.step}, extra: ${!!this.state.extra}`,
+            `callback -- step: ${this.state.step}, extra: ${!!this.state
+              .extra}`,
           );
         });
         // Treat like replaceState

commit 6041f481b7851d75649630eea489628d399cc3cf
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Wed Nov 22 13:02:26 2017 +0000

    Run Jest in production mode (#11616)
    
    * Move Jest setup files to /dev/ subdirectory
    
    * Clone Jest /dev/ files into /prod/
    
    * Move shared code into scripts/jest
    
    * Move Jest config into the scripts folder
    
    * Fix the equivalence test
    
    It fails because the config is now passed to Jest explicitly.
    But the test doesn't know about the config.
    
    To fix this, we just run it via `yarn test` (which includes the config).
    We already depend on Yarn for development anyway.
    
    * Add yarn test-prod to run Jest with production environment
    
    * Actually flip the production tests to run in prod environment
    
    This produces a bunch of errors:
    
    Test Suites: 64 failed, 58 passed, 122 total
    Tests:       740 failed, 26 skipped, 1809 passed, 2575 total
    Snapshots:   16 failed, 4 passed, 20 total
    
    * Ignore expectDev() calls in production
    
    Down from 740 to 175 failed.
    
    Test Suites: 44 failed, 78 passed, 122 total
    Tests:       175 failed, 26 skipped, 2374 passed, 2575 total
    Snapshots:   16 failed, 4 passed, 20 total
    
    * Decode errors so tests can assert on their messages
    
    Down from 175 to 129.
    
    Test Suites: 33 failed, 89 passed, 122 total
    Tests:       129 failed, 1029 skipped, 1417 passed, 2575 total
    Snapshots:   16 failed, 4 passed, 20 total
    
    * Remove ReactDOMProduction-test
    
    There is no need for it now. The only test that was special is moved into ReactDOM-test.
    
    * Remove production switches from ReactErrorUtils
    
    The tests now run in production in a separate pass.
    
    * Add and use spyOnDev() for warnings
    
    This ensures that by default we expect no warnings in production bundles.
    If the warning *is* expected, use the regular spyOn() method.
    
    This currently breaks all expectDev() assertions without __DEV__ blocks so we go back to:
    
    Test Suites: 56 failed, 65 passed, 121 total
    Tests:       379 failed, 1029 skipped, 1148 passed, 2556 total
    Snapshots:   16 failed, 4 passed, 20 total
    
    * Replace expectDev() with expect() in __DEV__ blocks
    
    We started using spyOnDev() for console warnings to ensure we don't *expect* them to occur in production. As a consequence, expectDev() assertions on console.error.calls fail because console.error.calls doesn't exist. This is actually good because it would help catch accidental warnings in production.
    
    To solve this, we are getting rid of expectDev() altogether, and instead introduce explicit expectation branches. We'd need them anyway for testing intentional behavior differences.
    
    This commit replaces all expectDev() calls with expect() calls in __DEV__ blocks. It also removes a few unnecessary expect() checks that no warnings were produced (by also removing the corresponding spyOnDev() calls).
    
    Some DEV-only assertions used plain expect(). Those were also moved into __DEV__ blocks.
    
    ReactFiberErrorLogger was special because it console.error()'s in production too. So in that case I intentionally used spyOn() instead of spyOnDev(), and added extra assertions.
    
    This gets us down to:
    
    Test Suites: 21 failed, 100 passed, 121 total
    Tests:       72 failed, 26 skipped, 2458 passed, 2556 total
    Snapshots:   16 failed, 4 passed, 20 total
    
    * Enable User Timing API for production testing
    
    We could've disabled it, but seems like a good idea to test since we use it at FB.
    
    * Test for explicit Object.freeze() differences between PROD and DEV
    
    This is one of the few places where DEV and PROD behavior differs for performance reasons.
    Now we explicitly test both branches.
    
    * Run Jest via "yarn test" on CI
    
    * Remove unused variable
    
    * Assert different error messages
    
    * Fix error handling tests
    
    This logic is really complicated because of the global ReactFiberErrorLogger mock.
    I understand it now, so I added TODOs for later.
    
    It can be much simpler if we change the rest of the tests that assert uncaught errors to also assert they are logged as warnings.
    Which mirrors what happens in practice anyway.
    
    * Fix more assertions
    
    * Change tests to document the DEV/PROD difference for state invariant
    
    It is very likely unintentional but I don't want to change behavior in this PR.
    Filed a follow up as https://github.com/facebook/react/issues/11618.
    
    * Remove unnecessary split between DEV/PROD ref tests
    
    * Fix more test message assertions
    
    * Make validateDOMNesting tests DEV-only
    
    * Fix error message assertions
    
    * Document existing DEV/PROD message difference (possible bug)
    
    * Change mocking assertions to be DEV-only
    
    * Fix the error code test
    
    * Fix more error message assertions
    
    * Fix the last failing test due to known issue
    
    * Run production tests on CI
    
    * Unify configuration
    
    * Fix coverage script
    
    * Remove expectDev from eslintrc
    
    * Run everything in band
    
    We used to before, too. I just forgot to add the arguments after deleting the script.

diff --git a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
index 93b4d9280e..131488a500 100644
--- a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
+++ b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
@@ -381,7 +381,7 @@ describe('ReactCompositeComponent-state', () => {
   });
 
   it('should treat assigning to this.state inside cWRP as a replaceState, with a warning', () => {
-    spyOn(console, 'error');
+    spyOnDev(console, 'error');
 
     let ops = [];
     class Test extends React.Component {
@@ -416,20 +416,24 @@ describe('ReactCompositeComponent-state', () => {
       'render -- step: 3, extra: false',
       'callback -- step: 3, extra: false',
     ]);
-    expect(console.error.calls.count()).toEqual(1);
-    expect(console.error.calls.argsFor(0)[0]).toEqual(
-      'Warning: Test.componentWillReceiveProps(): Assigning directly to ' +
-        "this.state is deprecated (except inside a component's constructor). " +
-        'Use setState instead.',
-    );
+    if (__DEV__) {
+      expect(console.error.calls.count()).toEqual(1);
+      expect(console.error.calls.argsFor(0)[0]).toEqual(
+        'Warning: Test.componentWillReceiveProps(): Assigning directly to ' +
+          "this.state is deprecated (except inside a component's constructor). " +
+          'Use setState instead.',
+      );
+    }
 
     // Check deduplication
     ReactDOM.render(<Test />, container);
-    expect(console.error.calls.count()).toEqual(1);
+    if (__DEV__) {
+      expect(console.error.calls.count()).toEqual(1);
+    }
   });
 
   it('should treat assigning to this.state inside cWM as a replaceState, with a warning', () => {
-    spyOn(console, 'error');
+    spyOnDev(console, 'error');
 
     let ops = [];
     class Test extends React.Component {
@@ -461,11 +465,13 @@ describe('ReactCompositeComponent-state', () => {
       'render -- step: 3, extra: false',
       'callback -- step: 3, extra: false',
     ]);
-    expect(console.error.calls.count()).toEqual(1);
-    expect(console.error.calls.argsFor(0)[0]).toEqual(
-      'Warning: Test.componentWillMount(): Assigning directly to ' +
-        "this.state is deprecated (except inside a component's constructor). " +
-        'Use setState instead.',
-    );
+    if (__DEV__) {
+      expect(console.error.calls.count()).toEqual(1);
+      expect(console.error.calls.argsFor(0)[0]).toEqual(
+        'Warning: Test.componentWillMount(): Assigning directly to ' +
+          "this.state is deprecated (except inside a component's constructor). " +
+          'Use setState instead.',
+      );
+    }
   });
 });

commit 48616e591fe23c0b89b0823c3ec99bae2d7b6853
Author: Raphael Amorim <rapha850@gmail.com>
Date:   Tue Dec 5 16:29:22 2017 -0200

    react-dom: convert packages/react-dom/src/__tests__ (#11776)

diff --git a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
index 131488a500..c69e237c4e 100644
--- a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
+++ b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
@@ -9,10 +9,10 @@
 
 'use strict';
 
-var React;
-var ReactDOM;
+let React;
+let ReactDOM;
 
-var TestComponent;
+let TestComponent;
 
 describe('ReactCompositeComponent-state', () => {
   beforeEach(() => {
@@ -123,11 +123,11 @@ describe('ReactCompositeComponent-state', () => {
   });
 
   it('should support setting state', () => {
-    var container = document.createElement('div');
+    const container = document.createElement('div');
     document.body.appendChild(container);
 
-    var stateListener = jest.fn();
-    var instance = ReactDOM.render(
+    const stateListener = jest.fn();
+    const instance = ReactDOM.render(
       <TestComponent stateListener={stateListener} />,
       container,
       function peekAtInitialCallback() {
@@ -217,12 +217,12 @@ describe('ReactCompositeComponent-state', () => {
   });
 
   it('should call componentDidUpdate of children first', () => {
-    var container = document.createElement('div');
+    const container = document.createElement('div');
 
-    var ops = [];
+    let ops = [];
 
-    var child = null;
-    var parent = null;
+    let child = null;
+    let parent = null;
 
     class Child extends React.Component {
       state = {bar: false};
@@ -237,7 +237,7 @@ describe('ReactCompositeComponent-state', () => {
       }
     }
 
-    var shouldUpdate = true;
+    let shouldUpdate = true;
 
     class Intermediate extends React.Component {
       shouldComponentUpdate() {
@@ -284,7 +284,7 @@ describe('ReactCompositeComponent-state', () => {
   });
 
   it('should batch unmounts', () => {
-    var outer;
+    let outer;
 
     class Inner extends React.Component {
       render() {
@@ -306,7 +306,7 @@ describe('ReactCompositeComponent-state', () => {
       }
     }
 
-    var container = document.createElement('div');
+    const container = document.createElement('div');
     outer = ReactDOM.render(<Outer />, container);
     expect(() => {
       ReactDOM.unmountComponentAtNode(container);
@@ -338,7 +338,7 @@ describe('ReactCompositeComponent-state', () => {
         return <div>{this.props.value}</div>;
       }
     }
-    var container = document.createElement('div');
+    const container = document.createElement('div');
     ReactDOM.render(<Parent />, container);
     ReactDOM.render(<Parent />, container);
     expect(log).toEqual([

commit a442d9bc082878ccf66872b1eeed3465927801b6
Author: Brian Vaughn <brian.david.vaughn@gmail.com>
Date:   Wed Jan 3 10:08:24 2018 -0800

    Update additional tests to use .toWarnDev() matcher (#11952)
    
    * Migrated several additional tests to use new .toWarnDev() matcher
    
    * Migrated ReactDOMComponent-test to use .toWarnDev() matcher
    
    Note this test previous had some hacky logic to verify errors were reported against unique line numbers. Since the new matcher doesn't suppor this, I replaced this check with an equivalent (I think) comparison of unique DOM elements (eg div -> span)
    
    * Updated several additional tests to use the new .toWarnDev() matcher
    
    * Updated many more tests to use .toWarnDev()

diff --git a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
index c69e237c4e..c7135984d2 100644
--- a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
+++ b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
@@ -17,7 +17,6 @@ let TestComponent;
 describe('ReactCompositeComponent-state', () => {
   beforeEach(() => {
     React = require('react');
-
     ReactDOM = require('react-dom');
 
     TestComponent = class extends React.Component {
@@ -381,8 +380,6 @@ describe('ReactCompositeComponent-state', () => {
   });
 
   it('should treat assigning to this.state inside cWRP as a replaceState, with a warning', () => {
-    spyOnDev(console, 'error');
-
     let ops = [];
     class Test extends React.Component {
       state = {step: 1, extra: true};
@@ -409,27 +406,20 @@ describe('ReactCompositeComponent-state', () => {
     const container = document.createElement('div');
     ReactDOM.render(<Test />, container);
     // Update
-    ReactDOM.render(<Test />, container);
+    expect(() => ReactDOM.render(<Test />, container)).toWarnDev(
+      'Warning: Test.componentWillReceiveProps(): Assigning directly to ' +
+        "this.state is deprecated (except inside a component's constructor). " +
+        'Use setState instead.',
+    );
 
     expect(ops).toEqual([
       'render -- step: 1, extra: true',
       'render -- step: 3, extra: false',
       'callback -- step: 3, extra: false',
     ]);
-    if (__DEV__) {
-      expect(console.error.calls.count()).toEqual(1);
-      expect(console.error.calls.argsFor(0)[0]).toEqual(
-        'Warning: Test.componentWillReceiveProps(): Assigning directly to ' +
-          "this.state is deprecated (except inside a component's constructor). " +
-          'Use setState instead.',
-      );
-    }
 
-    // Check deduplication
+    // Check deduplication; (no additional warnings are expected)
     ReactDOM.render(<Test />, container);
-    if (__DEV__) {
-      expect(console.error.calls.count()).toEqual(1);
-    }
   });
 
   it('should treat assigning to this.state inside cWM as a replaceState, with a warning', () => {
@@ -459,19 +449,15 @@ describe('ReactCompositeComponent-state', () => {
 
     // Mount
     const container = document.createElement('div');
-    ReactDOM.render(<Test />, container);
+    expect(() => ReactDOM.render(<Test />, container)).toWarnDev(
+      'Warning: Test.componentWillMount(): Assigning directly to ' +
+        "this.state is deprecated (except inside a component's constructor). " +
+        'Use setState instead.',
+    );
 
     expect(ops).toEqual([
       'render -- step: 3, extra: false',
       'callback -- step: 3, extra: false',
     ]);
-    if (__DEV__) {
-      expect(console.error.calls.count()).toEqual(1);
-      expect(console.error.calls.argsFor(0)[0]).toEqual(
-        'Warning: Test.componentWillMount(): Assigning directly to ' +
-          "this.state is deprecated (except inside a component's constructor). " +
-          'Use setState instead.',
-      );
-    }
   });
 });

commit 9f848f8ebec30b3aaa4844ecaef83b014359c5e3
Author: Brian Vaughn <brian.david.vaughn@gmail.com>
Date:   Wed Jan 3 13:55:37 2018 -0800

    Update additional tests to use .toWarnDev() matcher (#11957)
    
    * Migrated several additional tests to use new .toWarnDev() matcher
    
    * Migrated ReactDOMComponent-test to use .toWarnDev() matcher
    
    Note this test previous had some hacky logic to verify errors were reported against unique line numbers. Since the new matcher doesn't suppor this, I replaced this check with an equivalent (I think) comparison of unique DOM elements (eg div -> span)
    
    * Updated several additional tests to use the new .toWarnDev() matcher
    
    * Updated many more tests to use .toWarnDev()
    
    * Updated several additional tests to use .toWarnDev() matcher
    
    * Updated ReactElementValidator to distinguish between Array and Object in its warning. Also updated its test to use .toWarnDev() matcher.
    
    * Updated a couple of additional tests
    
    * Removed unused normalizeCodeLocInfo() methods

diff --git a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
index c7135984d2..87a09f9448 100644
--- a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
+++ b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
@@ -423,8 +423,6 @@ describe('ReactCompositeComponent-state', () => {
   });
 
   it('should treat assigning to this.state inside cWM as a replaceState, with a warning', () => {
-    spyOnDev(console, 'error');
-
     let ops = [];
     class Test extends React.Component {
       state = {step: 1, extra: true};

commit 97e2911508a2a7af6f50cf87ae503abe39842bef
Author: Brian Vaughn <brian.david.vaughn@gmail.com>
Date:   Fri Jan 19 09:36:46 2018 -0800

    RFC 6: Deprecate unsafe lifecycles (#12028)
    
    * Added unsafe_* lifecycles and deprecation warnings
    If the old lifecycle hooks (componentWillMount, componentWillUpdate, componentWillReceiveProps) are detected, these methods will be called and a deprecation warning will be logged. (In other words, we do not check for both the presence of the old and new lifecycles.) This commit is expected to fail tests.
    
    * Ran lifecycle hook codemod over project
    This should handle the bulk of the updates. I will manually update TypeScript and CoffeeScript tests with another commit.
    The actual command run with this commit was: jscodeshift --parser=flow -t ../react-codemod/transforms/rename-unsafe-lifecycles.js ./packages/**/src/**/*.js
    
    * Manually migrated CoffeeScript and TypeScript tests
    
    * Added inline note to createReactClassIntegration-test
    Explaining why lifecycles hooks have not been renamed in this test.
    
    * Udated NativeMethodsMixin with new lifecycle hooks
    
    * Added static getDerivedStateFromProps to ReactPartialRenderer
    Also added a new set of tests focused on server side lifecycle hooks.
    
    * Added getDerivedStateFromProps to shallow renderer
    Also added warnings for several cases involving getDerivedStateFromProps() as well as the deprecated lifecycles.
    Also added tests for the above.
    
    * Dedupe and DEV-only deprecation warning in server renderer
    
    * Renamed unsafe_* prefix to UNSAFE_* to be more noticeable
    
    * Added getDerivedStateFromProps to ReactFiberClassComponent
    Also updated class component and lifecyle tests to cover the added functionality.
    
    * Warn about UNSAFE_componentWillRecieveProps misspelling
    
    * Added tests to createReactClassIntegration for new lifecycles
    
    * Added warning for stateless functional components with gDSFP
    
    * Added createReactClass test for static gDSFP
    
    * Moved lifecycle deprecation warnings behind (disabled) feature flag
    
    Updated tests accordingly, by temporarily splitting tests that were specific to this feature-flag into their own, internal tests. This was the only way I knew of to interact with the feature flag without breaking our build/dist tests.
    
    * Tidying up
    
    * Tweaked warning message wording slightly
    Replaced 'You may may have returned undefined.' with 'You may have returned undefined.'
    
    * Replaced truthy partialState checks with != null
    
    * Call getDerivedStateFromProps via .call(null) to prevent type access
    
    * Move shallow-renderer didWarn* maps off the instance
    
    * Only call getDerivedStateFromProps if props instance has changed
    
    * Avoid creating new state object if not necessary
    
    * Inject state as a param to callGetDerivedStateFromProps
    This value will be either workInProgress.memoizedState (for updates) or instance.state (for initialization).
    
    * Explicitly warn about uninitialized state before calling getDerivedStateFromProps.
    And added some new tests for this change.
    
    Also:
    * Improved a couple of falsy null/undefined checks to more explicitly check for null or undefined.
    * Made some small tweaks to ReactFiberClassComponent WRT when and how it reads instance.state and sets to null.
    
    * Improved wording for deprecation lifecycle warnings
    
    * Fix state-regression for module-pattern components
    Also add support for new static getDerivedStateFromProps method

diff --git a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
index 87a09f9448..65a02827a7 100644
--- a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
+++ b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
@@ -46,7 +46,7 @@ describe('ReactCompositeComponent-state', () => {
         return <div>{this.state.color}</div>;
       }
 
-      componentWillMount() {
+      UNSAFE_componentWillMount() {
         this.peekAtState('componentWillMount-start');
         this.setState(function(state) {
           this.peekAtState('before-setState-sunrise', state);
@@ -78,7 +78,7 @@ describe('ReactCompositeComponent-state', () => {
         this.peekAtState('componentDidMount-end');
       }
 
-      componentWillReceiveProps(newProps) {
+      UNSAFE_componentWillReceiveProps(newProps) {
         this.peekAtState('componentWillReceiveProps-start');
         if (newProps.nextColor) {
           this.setState(function(state) {
@@ -105,7 +105,7 @@ describe('ReactCompositeComponent-state', () => {
         return true;
       }
 
-      componentWillUpdate(nextProps, nextState) {
+      UNSAFE_componentWillUpdate(nextProps, nextState) {
         this.peekAtState('componentWillUpdate-currentState');
         this.peekAtState('componentWillUpdate-nextState', nextState);
       }
@@ -323,7 +323,7 @@ describe('ReactCompositeComponent-state', () => {
     }
     let updated = false;
     class Child extends React.Component {
-      componentWillReceiveProps() {
+      UNSAFE_componentWillReceiveProps() {
         if (updated) {
           return;
         }
@@ -383,7 +383,7 @@ describe('ReactCompositeComponent-state', () => {
     let ops = [];
     class Test extends React.Component {
       state = {step: 1, extra: true};
-      componentWillReceiveProps() {
+      UNSAFE_componentWillReceiveProps() {
         this.setState({step: 2}, () => {
           // Tests that earlier setState callbacks are not dropped
           ops.push(
@@ -426,7 +426,7 @@ describe('ReactCompositeComponent-state', () => {
     let ops = [];
     class Test extends React.Component {
       state = {step: 1, extra: true};
-      componentWillMount() {
+      UNSAFE_componentWillMount() {
         this.setState({step: 2}, () => {
           // Tests that earlier setState callbacks are not dropped
           ops.push(
@@ -458,4 +458,50 @@ describe('ReactCompositeComponent-state', () => {
       'callback -- step: 3, extra: false',
     ]);
   });
+
+  it('should support stateful module pattern components', () => {
+    function Child() {
+      return {
+        state: {
+          count: 123,
+        },
+        render() {
+          return <div>{`count:${this.state.count}`}</div>;
+        },
+      };
+    }
+
+    const el = document.createElement('div');
+    ReactDOM.render(<Child />, el);
+
+    expect(el.textContent).toBe('count:123');
+  });
+
+  it('should support getDerivedStateFromProps for module pattern components', () => {
+    function Child() {
+      return {
+        state: {
+          count: 1,
+        },
+        render() {
+          return <div>{`count:${this.state.count}`}</div>;
+        },
+      };
+    }
+    Child.getDerivedStateFromProps = (props, prevState) => {
+      return {
+        count: prevState.count + props.incrementBy,
+      };
+    };
+
+    const el = document.createElement('div');
+    ReactDOM.render(<Child incrementBy={0} />, el);
+    expect(el.textContent).toBe('count:1');
+
+    ReactDOM.render(<Child incrementBy={2} />, el);
+    expect(el.textContent).toBe('count:3');
+
+    ReactDOM.render(<Child incrementBy={1} />, el);
+    expect(el.textContent).toBe('count:4');
+  });
 });

commit 467d1391016dd2df8e1946aa33c6d6e1219c9dbb
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Mon Jul 16 20:20:18 2018 +0100

    Enforce presence or absence of component stack in tests (#13215)
    
    * Enforce presence or absence of stack in tests
    
    * Rename expectNoStack to withoutStack
    
    * Fix lint
    
    * Add some tests for toWarnDev()

diff --git a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
index 65a02827a7..8402abe9bd 100644
--- a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
+++ b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
@@ -410,6 +410,7 @@ describe('ReactCompositeComponent-state', () => {
       'Warning: Test.componentWillReceiveProps(): Assigning directly to ' +
         "this.state is deprecated (except inside a component's constructor). " +
         'Use setState instead.',
+      {withoutStack: true},
     );
 
     expect(ops).toEqual([
@@ -451,6 +452,7 @@ describe('ReactCompositeComponent-state', () => {
       'Warning: Test.componentWillMount(): Assigning directly to ' +
         "this.state is deprecated (except inside a component's constructor). " +
         'Use setState instead.',
+      {withoutStack: true},
     );
 
     expect(ops).toEqual([

commit b87aabdfe1b7461e7331abb3601d9e6bb27544bc
Author: Héctor Ramos <165856+hramos@users.noreply.github.com>
Date:   Fri Sep 7 15:11:23 2018 -0700

    Drop the year from Facebook copyright headers and the LICENSE file. (#13593)

diff --git a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
index 8402abe9bd..f882dc01be 100644
--- a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
+++ b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
@@ -1,5 +1,5 @@
 /**
- * Copyright (c) 2013-present, Facebook, Inc.
+ * Copyright (c) Facebook, Inc. and its affiliates.
  *
  * This source code is licensed under the MIT license found in the
  * LICENSE file in the root directory of this source tree.

commit acd65db5bc2cd1ab19be66318f3e931054796739
Author: Sebastian Markbåge <sebastian@calyptus.eu>
Date:   Tue Mar 19 12:55:27 2019 -0700

    Deprecate module pattern (factory) components (#15145)

diff --git a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
index f882dc01be..3c28f48337 100644
--- a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
+++ b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
@@ -474,7 +474,14 @@ describe('ReactCompositeComponent-state', () => {
     }
 
     const el = document.createElement('div');
-    ReactDOM.render(<Child />, el);
+    expect(() => ReactDOM.render(<Child />, el)).toWarnDev(
+      'Warning: The <Child /> component appears to be a function component that returns a class instance. ' +
+        'Change Child to a class that extends React.Component instead. ' +
+        "If you can't use a class try assigning the prototype on the function as a workaround. " +
+        '`Child.prototype = React.Component.prototype`. ' +
+        "Don't use an arrow function since it cannot be called with `new` by React.",
+      {withoutStack: true},
+    );
 
     expect(el.textContent).toBe('count:123');
   });

commit b15bf36750ca4c4a5a09f2de76c5315ded1258d0
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Thu Dec 12 23:47:55 2019 +0000

    Add component stacks to (almost) all warnings (#17586)

diff --git a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
index 3c28f48337..4bee754661 100644
--- a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
+++ b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
@@ -410,7 +410,6 @@ describe('ReactCompositeComponent-state', () => {
       'Warning: Test.componentWillReceiveProps(): Assigning directly to ' +
         "this.state is deprecated (except inside a component's constructor). " +
         'Use setState instead.',
-      {withoutStack: true},
     );
 
     expect(ops).toEqual([
@@ -452,7 +451,6 @@ describe('ReactCompositeComponent-state', () => {
       'Warning: Test.componentWillMount(): Assigning directly to ' +
         "this.state is deprecated (except inside a component's constructor). " +
         'Use setState instead.',
-      {withoutStack: true},
     );
 
     expect(ops).toEqual([
@@ -480,7 +478,6 @@ describe('ReactCompositeComponent-state', () => {
         "If you can't use a class try assigning the prototype on the function as a workaround. " +
         '`Child.prototype = React.Component.prototype`. ' +
         "Don't use an arrow function since it cannot be called with `new` by React.",
-      {withoutStack: true},
     );
 
     expect(el.textContent).toBe('count:123');

commit 0b5a26a4895261894f04e50d5a700e83b9c0dcf6
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Mon Dec 16 12:48:16 2019 +0000

    Rename toWarnDev -> toErrorDev, toLowPriorityWarnDev -> toWarnDev (#17605)
    
    * Rename toWarnDev -> toErrorDev in tests
    
    * Rename toWarnDev matcher implementation to toErrorDev
    
    * Rename toLowPriorityWarnDev -> toWarnDev in tests and implementation

diff --git a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
index 4bee754661..70e15b769e 100644
--- a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
+++ b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
@@ -406,7 +406,7 @@ describe('ReactCompositeComponent-state', () => {
     const container = document.createElement('div');
     ReactDOM.render(<Test />, container);
     // Update
-    expect(() => ReactDOM.render(<Test />, container)).toWarnDev(
+    expect(() => ReactDOM.render(<Test />, container)).toErrorDev(
       'Warning: Test.componentWillReceiveProps(): Assigning directly to ' +
         "this.state is deprecated (except inside a component's constructor). " +
         'Use setState instead.',
@@ -447,7 +447,7 @@ describe('ReactCompositeComponent-state', () => {
 
     // Mount
     const container = document.createElement('div');
-    expect(() => ReactDOM.render(<Test />, container)).toWarnDev(
+    expect(() => ReactDOM.render(<Test />, container)).toErrorDev(
       'Warning: Test.componentWillMount(): Assigning directly to ' +
         "this.state is deprecated (except inside a component's constructor). " +
         'Use setState instead.',
@@ -472,7 +472,7 @@ describe('ReactCompositeComponent-state', () => {
     }
 
     const el = document.createElement('div');
-    expect(() => ReactDOM.render(<Child />, el)).toWarnDev(
+    expect(() => ReactDOM.render(<Child />, el)).toErrorDev(
       'Warning: The <Child /> component appears to be a function component that returns a class instance. ' +
         'Change Child to a class that extends React.Component instead. ' +
         "If you can't use a class try assigning the prototype on the function as a workaround. " +

commit d8d2b6e89cdff27a1ac246c6e9e030c2cc8760e3
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Wed Apr 1 18:31:59 2020 +0100

    Disable module components dynamically for WWW (#18446)
    
    * Make disableModulePatternComponents dynamic for WWW
    
    * Run both flags and tests and respect the flag in SSR

diff --git a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
index 70e15b769e..5708d67edb 100644
--- a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
+++ b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
@@ -459,55 +459,57 @@ describe('ReactCompositeComponent-state', () => {
     ]);
   });
 
-  it('should support stateful module pattern components', () => {
-    function Child() {
-      return {
-        state: {
-          count: 123,
-        },
-        render() {
-          return <div>{`count:${this.state.count}`}</div>;
-        },
-      };
-    }
+  if (!require('shared/ReactFeatureFlags').disableModulePatternComponents) {
+    it('should support stateful module pattern components', () => {
+      function Child() {
+        return {
+          state: {
+            count: 123,
+          },
+          render() {
+            return <div>{`count:${this.state.count}`}</div>;
+          },
+        };
+      }
 
-    const el = document.createElement('div');
-    expect(() => ReactDOM.render(<Child />, el)).toErrorDev(
-      'Warning: The <Child /> component appears to be a function component that returns a class instance. ' +
-        'Change Child to a class that extends React.Component instead. ' +
-        "If you can't use a class try assigning the prototype on the function as a workaround. " +
-        '`Child.prototype = React.Component.prototype`. ' +
-        "Don't use an arrow function since it cannot be called with `new` by React.",
-    );
+      const el = document.createElement('div');
+      expect(() => ReactDOM.render(<Child />, el)).toErrorDev(
+        'Warning: The <Child /> component appears to be a function component that returns a class instance. ' +
+          'Change Child to a class that extends React.Component instead. ' +
+          "If you can't use a class try assigning the prototype on the function as a workaround. " +
+          '`Child.prototype = React.Component.prototype`. ' +
+          "Don't use an arrow function since it cannot be called with `new` by React.",
+      );
 
-    expect(el.textContent).toBe('count:123');
-  });
+      expect(el.textContent).toBe('count:123');
+    });
 
-  it('should support getDerivedStateFromProps for module pattern components', () => {
-    function Child() {
-      return {
-        state: {
-          count: 1,
-        },
-        render() {
-          return <div>{`count:${this.state.count}`}</div>;
-        },
-      };
-    }
-    Child.getDerivedStateFromProps = (props, prevState) => {
-      return {
-        count: prevState.count + props.incrementBy,
+    it('should support getDerivedStateFromProps for module pattern components', () => {
+      function Child() {
+        return {
+          state: {
+            count: 1,
+          },
+          render() {
+            return <div>{`count:${this.state.count}`}</div>;
+          },
+        };
+      }
+      Child.getDerivedStateFromProps = (props, prevState) => {
+        return {
+          count: prevState.count + props.incrementBy,
+        };
       };
-    };
 
-    const el = document.createElement('div');
-    ReactDOM.render(<Child incrementBy={0} />, el);
-    expect(el.textContent).toBe('count:1');
+      const el = document.createElement('div');
+      ReactDOM.render(<Child incrementBy={0} />, el);
+      expect(el.textContent).toBe('count:1');
 
-    ReactDOM.render(<Child incrementBy={2} />, el);
-    expect(el.textContent).toBe('count:3');
+      ReactDOM.render(<Child incrementBy={2} />, el);
+      expect(el.textContent).toBe('count:3');
 
-    ReactDOM.render(<Child incrementBy={1} />, el);
-    expect(el.textContent).toBe('count:4');
-  });
+      ReactDOM.render(<Child incrementBy={1} />, el);
+      expect(el.textContent).toBe('count:4');
+    });
+  }
 });

commit 3e94bce765d355d74f6a60feb4addb6d196e3482
Author: Sebastian Markbåge <sebastian@calyptus.eu>
Date:   Wed Apr 1 12:35:52 2020 -0700

    Enable prefer-const lint rules (#18451)
    
    * Enable prefer-const rule
    
    Stylistically I don't like this but Closure Compiler takes advantage of
    this information.
    
    * Auto-fix lints
    
    * Manually fix the remaining callsites

diff --git a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
index 5708d67edb..f4327898ba 100644
--- a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
+++ b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
@@ -143,7 +143,7 @@ describe('ReactCompositeComponent-state', () => {
 
     ReactDOM.unmountComponentAtNode(container);
 
-    let expected = [
+    const expected = [
       // there is no state when getInitialState() is called
       ['getInitialState', null],
       ['componentWillMount-start', 'red'],
@@ -283,8 +283,6 @@ describe('ReactCompositeComponent-state', () => {
   });
 
   it('should batch unmounts', () => {
-    let outer;
-
     class Inner extends React.Component {
       render() {
         return <div />;
@@ -306,7 +304,7 @@ describe('ReactCompositeComponent-state', () => {
     }
 
     const container = document.createElement('div');
-    outer = ReactDOM.render(<Outer />, container);
+    const outer = ReactDOM.render(<Outer />, container);
     expect(() => {
       ReactDOM.unmountComponentAtNode(container);
     }).not.toThrow();
@@ -380,7 +378,7 @@ describe('ReactCompositeComponent-state', () => {
   });
 
   it('should treat assigning to this.state inside cWRP as a replaceState, with a warning', () => {
-    let ops = [];
+    const ops = [];
     class Test extends React.Component {
       state = {step: 1, extra: true};
       UNSAFE_componentWillReceiveProps() {
@@ -423,7 +421,7 @@ describe('ReactCompositeComponent-state', () => {
   });
 
   it('should treat assigning to this.state inside cWM as a replaceState, with a warning', () => {
-    let ops = [];
+    const ops = [];
     class Test extends React.Component {
       state = {step: 1, extra: true};
       UNSAFE_componentWillMount() {

commit 55f5cdee01ed25548ab55f2902a295df4324260d
Author: Sebastian Markbåge <sebastian@calyptus.eu>
Date:   Wed May 6 20:30:59 2020 -0700

    Disable setState before mount in legacy mode (#18851)
    
    We kind of "support" this pattern in legacy mode. It's only deprecated in
    Concurrent Mode.

diff --git a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
index f4327898ba..51dd92d841 100644
--- a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
+++ b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
@@ -510,4 +510,33 @@ describe('ReactCompositeComponent-state', () => {
       expect(el.textContent).toBe('count:4');
     });
   }
+
+  it('should support setState in componentWillUnmount', () => {
+    let subscription;
+    class A extends React.Component {
+      componentWillUnmount() {
+        subscription();
+      }
+      render() {
+        return 'A';
+      }
+    }
+
+    class B extends React.Component {
+      state = {siblingUnmounted: false};
+      UNSAFE_componentWillMount() {
+        subscription = () => this.setState({siblingUnmounted: true});
+      }
+      render() {
+        return 'B' + (this.state.siblingUnmounted ? ' No Sibling' : '');
+      }
+    }
+
+    const el = document.createElement('div');
+    ReactDOM.render(<A />, el);
+    expect(el.textContent).toBe('A');
+
+    ReactDOM.render(<B />, el);
+    expect(el.textContent).toBe('B No Sibling');
+  });
 });

commit 9cdf8a99edcfd94d7420835ea663edca04237527
Author: Andrew Clark <git@andrewclark.io>
Date:   Tue Oct 18 11:19:24 2022 -0400

    [Codemod] Update copyright header to Meta (#25315)
    
    * Facebook -> Meta in copyright
    
    rg --files | xargs sed -i 's#Copyright (c) Facebook, Inc. and its affiliates.#Copyright (c) Meta Platforms, Inc. and affiliates.#g'
    
    * Manual tweaks

diff --git a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
index 51dd92d841..7f2205932e 100644
--- a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
+++ b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
@@ -1,5 +1,5 @@
 /**
- * Copyright (c) Facebook, Inc. and its affiliates.
+ * Copyright (c) Meta Platforms, Inc. and affiliates.
  *
  * This source code is licensed under the MIT license found in the
  * LICENSE file in the root directory of this source tree.

commit 6b3083266686f62b29462d32de75c6e71f7ba3e3
Author: Jan Kassens <jkassens@meta.com>
Date:   Tue Jan 31 08:25:05 2023 -0500

    Upgrade prettier (#26081)
    
    The old version of prettier we were using didn't support the Flow syntax
    to access properties in a type using `SomeType['prop']`. This updates
    `prettier` and `rollup-plugin-prettier` to the latest versions.
    
    I added the prettier config `arrowParens: "avoid"` to reduce the diff
    size as the default has changed in Prettier 2.0. The largest amount of
    changes comes from function expressions now having a space. This doesn't
    have an option to preserve the old behavior, so we have to update this.

diff --git a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
index 7f2205932e..a20f7d3ddd 100644
--- a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
+++ b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
@@ -48,14 +48,14 @@ describe('ReactCompositeComponent-state', () => {
 
       UNSAFE_componentWillMount() {
         this.peekAtState('componentWillMount-start');
-        this.setState(function(state) {
+        this.setState(function (state) {
           this.peekAtState('before-setState-sunrise', state);
         });
         this.setState(
           {color: 'sunrise'},
           this.peekAtCallback('setState-sunrise'),
         );
-        this.setState(function(state) {
+        this.setState(function (state) {
           this.peekAtState('after-setState-sunrise', state);
         });
         this.peekAtState('componentWillMount-after-sunrise');
@@ -63,7 +63,7 @@ describe('ReactCompositeComponent-state', () => {
           {color: 'orange'},
           this.peekAtCallback('setState-orange'),
         );
-        this.setState(function(state) {
+        this.setState(function (state) {
           this.peekAtState('after-setState-orange', state);
         });
         this.peekAtState('componentWillMount-end');
@@ -81,18 +81,18 @@ describe('ReactCompositeComponent-state', () => {
       UNSAFE_componentWillReceiveProps(newProps) {
         this.peekAtState('componentWillReceiveProps-start');
         if (newProps.nextColor) {
-          this.setState(function(state) {
+          this.setState(function (state) {
             this.peekAtState('before-setState-receiveProps', state);
             return {color: newProps.nextColor};
           });
           // No longer a public API, but we can test that it works internally by
           // reaching into the updater.
           this.updater.enqueueReplaceState(this, {color: undefined});
-          this.setState(function(state) {
+          this.setState(function (state) {
             this.peekAtState('before-setState-again-receiveProps', state);
             return {color: newProps.nextColor};
           }, this.peekAtCallback('setState-receiveProps'));
-          this.setState(function(state) {
+          this.setState(function (state) {
             this.peekAtState('after-setState-receiveProps', state);
           });
         }
@@ -310,7 +310,7 @@ describe('ReactCompositeComponent-state', () => {
     }).not.toThrow();
   });
 
-  it('should update state when called from child cWRP', function() {
+  it('should update state when called from child cWRP', function () {
     const log = [];
     class Parent extends React.Component {
       state = {value: 'one'};
@@ -350,7 +350,7 @@ describe('ReactCompositeComponent-state', () => {
     ]);
   });
 
-  it('should merge state when sCU returns false', function() {
+  it('should merge state when sCU returns false', function () {
     const log = [];
     class Test extends React.Component {
       state = {a: 0};

commit 0b32b3edd2c49b25fa25412fa6a6a31d43e15653
Author: Rick Hanlon <rickhanlonii@gmail.com>
Date:   Thu Jan 25 13:36:04 2024 -0500

    Convert ReactCompositeComponentState to createRoot (#28063)

diff --git a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
index a20f7d3ddd..a2894b2ca7 100644
--- a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
+++ b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
@@ -11,23 +11,41 @@
 
 let React;
 let ReactDOM;
-
+let ReactDOMClient;
+let act;
+let Scheduler;
+let assertLog;
 let TestComponent;
+let testComponentInstance;
 
 describe('ReactCompositeComponent-state', () => {
   beforeEach(() => {
     React = require('react');
     ReactDOM = require('react-dom');
+    ReactDOMClient = require('react-dom/client');
+    act = require('internal-test-utils').act;
+    Scheduler = require('scheduler');
+
+    const InternalTestUtils = require('internal-test-utils');
+    assertLog = InternalTestUtils.assertLog;
+
+    function LogAfterCommit({children, color}) {
+      React.useEffect(() => {
+        Scheduler.log(`commit ${color}`);
+      });
+      return children;
+    }
 
     TestComponent = class extends React.Component {
       constructor(props) {
         super(props);
         this.peekAtState('getInitialState', undefined, props);
         this.state = {color: 'red'};
+        testComponentInstance = this;
       }
 
       peekAtState = (from, state = this.state, props = this.props) => {
-        props.stateListener(from, state && state.color);
+        Scheduler.log(`${from} ${state && state.color}`);
       };
 
       peekAtCallback = from => {
@@ -43,7 +61,11 @@ describe('ReactCompositeComponent-state', () => {
 
       render() {
         this.peekAtState('render');
-        return <div>{this.state.color}</div>;
+        return (
+          <LogAfterCommit color={this.state.color}>
+            <div>{this.state.color}</div>
+          </LogAfterCommit>
+        );
       }
 
       UNSAFE_componentWillMount() {
@@ -121,105 +143,106 @@ describe('ReactCompositeComponent-state', () => {
     };
   });
 
-  it('should support setting state', () => {
+  it('should support setting state', async () => {
     const container = document.createElement('div');
     document.body.appendChild(container);
+    const root = ReactDOMClient.createRoot(container);
 
-    const stateListener = jest.fn();
-    const instance = ReactDOM.render(
-      <TestComponent stateListener={stateListener} />,
-      container,
-      function peekAtInitialCallback() {
-        this.peekAtState('initial-callback');
-      },
-    );
-    ReactDOM.render(
-      <TestComponent stateListener={stateListener} nextColor="green" />,
-      container,
-      instance.peekAtCallback('setProps'),
-    );
-    instance.setFavoriteColor('blue');
-    instance.forceUpdate(instance.peekAtCallback('forceUpdate'));
+    await act(() => {
+      root.render(<TestComponent />);
+    });
 
-    ReactDOM.unmountComponentAtNode(container);
+    await act(() => {
+      root.render(<TestComponent nextColor="green" />);
+    });
 
-    const expected = [
+    await act(() => {
+      testComponentInstance.setFavoriteColor('blue');
+    });
+    await act(() => {
+      testComponentInstance.forceUpdate(
+        testComponentInstance.peekAtCallback('forceUpdate'),
+      );
+    });
+
+    root.unmount();
+
+    assertLog([
       // there is no state when getInitialState() is called
-      ['getInitialState', null],
-      ['componentWillMount-start', 'red'],
+      'getInitialState undefined',
+      'componentWillMount-start red',
       // setState()'s only enqueue pending states.
-      ['componentWillMount-after-sunrise', 'red'],
-      ['componentWillMount-end', 'red'],
+      'componentWillMount-after-sunrise red',
+      'componentWillMount-end red',
       // pending state queue is processed
-      ['before-setState-sunrise', 'red'],
-      ['after-setState-sunrise', 'sunrise'],
-      ['after-setState-orange', 'orange'],
+      'before-setState-sunrise red',
+      'after-setState-sunrise sunrise',
+      'after-setState-orange orange',
       // pending state has been applied
-      ['render', 'orange'],
-      ['componentDidMount-start', 'orange'],
+      'render orange',
+      'componentDidMount-start orange',
       // setState-sunrise and setState-orange should be called here,
       // after the bug in #1740
       // componentDidMount() called setState({color:'yellow'}), which is async.
       // The update doesn't happen until the next flush.
-      ['componentDidMount-end', 'orange'],
-      ['setState-sunrise', 'orange'],
-      ['setState-orange', 'orange'],
-      ['initial-callback', 'orange'],
-      ['shouldComponentUpdate-currentState', 'orange'],
-      ['shouldComponentUpdate-nextState', 'yellow'],
-      ['componentWillUpdate-currentState', 'orange'],
-      ['componentWillUpdate-nextState', 'yellow'],
-      ['render', 'yellow'],
-      ['componentDidUpdate-currentState', 'yellow'],
-      ['componentDidUpdate-prevState', 'orange'],
-      ['setState-yellow', 'yellow'],
-      ['componentWillReceiveProps-start', 'yellow'],
+      'componentDidMount-end orange',
+      'setState-sunrise orange',
+      'setState-orange orange',
+      'commit orange',
+      'shouldComponentUpdate-currentState orange',
+      'shouldComponentUpdate-nextState yellow',
+      'componentWillUpdate-currentState orange',
+      'componentWillUpdate-nextState yellow',
+      'render yellow',
+      'componentDidUpdate-currentState yellow',
+      'componentDidUpdate-prevState orange',
+      'setState-yellow yellow',
+      'commit yellow',
+      'componentWillReceiveProps-start yellow',
       // setState({color:'green'}) only enqueues a pending state.
-      ['componentWillReceiveProps-end', 'yellow'],
+      'componentWillReceiveProps-end yellow',
       // pending state queue is processed
       // We keep updates in the queue to support
       // replaceState(prevState => newState).
-      ['before-setState-receiveProps', 'yellow'],
-      ['before-setState-again-receiveProps', undefined],
-      ['after-setState-receiveProps', 'green'],
-      ['shouldComponentUpdate-currentState', 'yellow'],
-      ['shouldComponentUpdate-nextState', 'green'],
-      ['componentWillUpdate-currentState', 'yellow'],
-      ['componentWillUpdate-nextState', 'green'],
-      ['render', 'green'],
-      ['componentDidUpdate-currentState', 'green'],
-      ['componentDidUpdate-prevState', 'yellow'],
-      ['setState-receiveProps', 'green'],
-      ['setProps', 'green'],
+      'before-setState-receiveProps yellow',
+      'before-setState-again-receiveProps undefined',
+      'after-setState-receiveProps green',
+      'shouldComponentUpdate-currentState yellow',
+      'shouldComponentUpdate-nextState green',
+      'componentWillUpdate-currentState yellow',
+      'componentWillUpdate-nextState green',
+      'render green',
+      'componentDidUpdate-currentState green',
+      'componentDidUpdate-prevState yellow',
+      'setState-receiveProps green',
+      'commit green',
       // setFavoriteColor('blue')
-      ['shouldComponentUpdate-currentState', 'green'],
-      ['shouldComponentUpdate-nextState', 'blue'],
-      ['componentWillUpdate-currentState', 'green'],
-      ['componentWillUpdate-nextState', 'blue'],
-      ['render', 'blue'],
-      ['componentDidUpdate-currentState', 'blue'],
-      ['componentDidUpdate-prevState', 'green'],
-      ['setFavoriteColor', 'blue'],
+      'shouldComponentUpdate-currentState green',
+      'shouldComponentUpdate-nextState blue',
+      'componentWillUpdate-currentState green',
+      'componentWillUpdate-nextState blue',
+      'render blue',
+      'componentDidUpdate-currentState blue',
+      'componentDidUpdate-prevState green',
+      'setFavoriteColor blue',
+      'commit blue',
       // forceUpdate()
-      ['componentWillUpdate-currentState', 'blue'],
-      ['componentWillUpdate-nextState', 'blue'],
-      ['render', 'blue'],
-      ['componentDidUpdate-currentState', 'blue'],
-      ['componentDidUpdate-prevState', 'blue'],
-      ['forceUpdate', 'blue'],
+      'componentWillUpdate-currentState blue',
+      'componentWillUpdate-nextState blue',
+      'render blue',
+      'componentDidUpdate-currentState blue',
+      'componentDidUpdate-prevState blue',
+      'forceUpdate blue',
+      'commit blue',
       // unmountComponent()
       // state is available within `componentWillUnmount()`
-      ['componentWillUnmount', 'blue'],
-    ];
-
-    expect(stateListener.mock.calls.join('\n')).toEqual(expected.join('\n'));
+      'componentWillUnmount blue',
+    ]);
   });
 
-  it('should call componentDidUpdate of children first', () => {
+  it('should call componentDidUpdate of children first', async () => {
     const container = document.createElement('div');
 
-    let ops = [];
-
     let child = null;
     let parent = null;
 
@@ -229,7 +252,7 @@ describe('ReactCompositeComponent-state', () => {
         child = this;
       }
       componentDidUpdate() {
-        ops.push('child did update');
+        Scheduler.log('child did update');
       }
       render() {
         return <div />;
@@ -253,36 +276,40 @@ describe('ReactCompositeComponent-state', () => {
         parent = this;
       }
       componentDidUpdate() {
-        ops.push('parent did update');
+        Scheduler.log('parent did update');
       }
       render() {
         return <Intermediate />;
       }
     }
 
-    ReactDOM.render(<Parent />, container);
+    const root = ReactDOMClient.createRoot(container);
+    await act(() => {
+      root.render(<Parent />);
+    });
 
-    ReactDOM.unstable_batchedUpdates(() => {
+    await act(() => {
       parent.setState({foo: true});
       child.setState({bar: true});
     });
+
     // When we render changes top-down in a batch, children's componentDidUpdate
     // happens before the parent.
-    expect(ops).toEqual(['child did update', 'parent did update']);
+    assertLog(['child did update', 'parent did update']);
 
     shouldUpdate = false;
 
-    ops = [];
-
-    ReactDOM.unstable_batchedUpdates(() => {
+    await act(() => {
       parent.setState({foo: false});
       child.setState({bar: false});
     });
+
     // We expect the same thing to happen if we bail out in the middle.
-    expect(ops).toEqual(['child did update', 'parent did update']);
+    assertLog(['child did update', 'parent did update']);
   });
 
-  it('should batch unmounts', () => {
+  it('should batch unmounts', async () => {
+    let outer;
     class Inner extends React.Component {
       render() {
         return <div />;
@@ -297,6 +324,9 @@ describe('ReactCompositeComponent-state', () => {
 
     class Outer extends React.Component {
       state = {showInner: true};
+      componentDidMount() {
+        outer = this;
+      }
 
       render() {
         return <div>{this.state.showInner && <Inner />}</div>;
@@ -304,18 +334,21 @@ describe('ReactCompositeComponent-state', () => {
     }
 
     const container = document.createElement('div');
-    const outer = ReactDOM.render(<Outer />, container);
+    const root = ReactDOMClient.createRoot(container);
+    await act(() => {
+      root.render(<Outer />);
+    });
+
     expect(() => {
-      ReactDOM.unmountComponentAtNode(container);
+      root.unmount();
     }).not.toThrow();
   });
 
-  it('should update state when called from child cWRP', function () {
-    const log = [];
+  it('should update state when called from child cWRP', async () => {
     class Parent extends React.Component {
       state = {value: 'one'};
       render() {
-        log.push('parent render ' + this.state.value);
+        Scheduler.log('parent render ' + this.state.value);
         return <Child parent={this} value={this.state.value} />;
       }
     }
@@ -325,20 +358,28 @@ describe('ReactCompositeComponent-state', () => {
         if (updated) {
           return;
         }
-        log.push('child componentWillReceiveProps ' + this.props.value);
+        Scheduler.log('child componentWillReceiveProps ' + this.props.value);
         this.props.parent.setState({value: 'two'});
-        log.push('child componentWillReceiveProps done ' + this.props.value);
+        Scheduler.log(
+          'child componentWillReceiveProps done ' + this.props.value,
+        );
         updated = true;
       }
       render() {
-        log.push('child render ' + this.props.value);
+        Scheduler.log('child render ' + this.props.value);
         return <div>{this.props.value}</div>;
       }
     }
     const container = document.createElement('div');
-    ReactDOM.render(<Parent />, container);
-    ReactDOM.render(<Parent />, container);
-    expect(log).toEqual([
+    const root = ReactDOMClient.createRoot(container);
+    await act(() => {
+      root.render(<Parent />);
+    });
+    await act(() => {
+      root.render(<Parent />);
+    });
+
+    assertLog([
       'parent render one',
       'child render one',
       'parent render one',
@@ -350,15 +391,19 @@ describe('ReactCompositeComponent-state', () => {
     ]);
   });
 
-  it('should merge state when sCU returns false', function () {
-    const log = [];
+  it('should merge state when sCU returns false', async () => {
+    let test;
     class Test extends React.Component {
       state = {a: 0};
+      componentDidMount() {
+        test = this;
+      }
+
       render() {
         return null;
       }
       shouldComponentUpdate(nextProps, nextState) {
-        log.push(
+        Scheduler.log(
           'scu from ' +
             Object.keys(this.state) +
             ' to ' +
@@ -369,22 +414,28 @@ describe('ReactCompositeComponent-state', () => {
     }
 
     const container = document.createElement('div');
-    const test = ReactDOM.render(<Test />, container);
-    test.setState({b: 0});
-    expect(log.length).toBe(1);
-    test.setState({c: 0});
-    expect(log.length).toBe(2);
-    expect(log).toEqual(['scu from a to a,b', 'scu from a,b to a,b,c']);
+    const root = ReactDOMClient.createRoot(container);
+    await act(() => {
+      root.render(<Test />);
+    });
+    await act(() => {
+      test.setState({b: 0});
+    });
+
+    assertLog(['scu from a to a,b']);
+    await act(() => {
+      test.setState({c: 0});
+    });
+    assertLog(['scu from a,b to a,b,c']);
   });
 
-  it('should treat assigning to this.state inside cWRP as a replaceState, with a warning', () => {
-    const ops = [];
+  it('should treat assigning to this.state inside cWRP as a replaceState, with a warning', async () => {
     class Test extends React.Component {
       state = {step: 1, extra: true};
       UNSAFE_componentWillReceiveProps() {
         this.setState({step: 2}, () => {
           // Tests that earlier setState callbacks are not dropped
-          ops.push(
+          Scheduler.log(
             `callback -- step: ${this.state.step}, extra: ${!!this.state
               .extra}`,
           );
@@ -393,7 +444,7 @@ describe('ReactCompositeComponent-state', () => {
         this.state = {step: 3};
       }
       render() {
-        ops.push(
+        Scheduler.log(
           `render -- step: ${this.state.step}, extra: ${!!this.state.extra}`,
         );
         return null;
@@ -402,32 +453,42 @@ describe('ReactCompositeComponent-state', () => {
 
     // Mount
     const container = document.createElement('div');
-    ReactDOM.render(<Test />, container);
+    const root = ReactDOMClient.createRoot(container);
+    await act(() => {
+      root.render(<Test />);
+    });
     // Update
-    expect(() => ReactDOM.render(<Test />, container)).toErrorDev(
+    expect(() => {
+      ReactDOM.flushSync(() => {
+        root.render(<Test />);
+      });
+    }).toErrorDev(
       'Warning: Test.componentWillReceiveProps(): Assigning directly to ' +
         "this.state is deprecated (except inside a component's constructor). " +
         'Use setState instead.',
     );
 
-    expect(ops).toEqual([
+    assertLog([
       'render -- step: 1, extra: true',
       'render -- step: 3, extra: false',
       'callback -- step: 3, extra: false',
     ]);
 
     // Check deduplication; (no additional warnings are expected)
-    ReactDOM.render(<Test />, container);
+    expect(() => {
+      ReactDOM.flushSync(() => {
+        root.render(<Test />);
+      });
+    }).not.toThrow();
   });
 
   it('should treat assigning to this.state inside cWM as a replaceState, with a warning', () => {
-    const ops = [];
     class Test extends React.Component {
       state = {step: 1, extra: true};
       UNSAFE_componentWillMount() {
         this.setState({step: 2}, () => {
           // Tests that earlier setState callbacks are not dropped
-          ops.push(
+          Scheduler.log(
             `callback -- step: ${this.state.step}, extra: ${!!this.state
               .extra}`,
           );
@@ -436,7 +497,7 @@ describe('ReactCompositeComponent-state', () => {
         this.state = {step: 3};
       }
       render() {
-        ops.push(
+        Scheduler.log(
           `render -- step: ${this.state.step}, extra: ${!!this.state.extra}`,
         );
         return null;
@@ -445,20 +506,29 @@ describe('ReactCompositeComponent-state', () => {
 
     // Mount
     const container = document.createElement('div');
-    expect(() => ReactDOM.render(<Test />, container)).toErrorDev(
+    const root = ReactDOMClient.createRoot(container);
+    expect(() => {
+      ReactDOM.flushSync(() => {
+        root.render(<Test />);
+      });
+    }).toErrorDev(
       'Warning: Test.componentWillMount(): Assigning directly to ' +
         "this.state is deprecated (except inside a component's constructor). " +
         'Use setState instead.',
     );
 
-    expect(ops).toEqual([
+    assertLog([
+      'render -- step: 3, extra: false',
+      'callback -- step: 3, extra: false',
+
+      // A second time for the retry.
       'render -- step: 3, extra: false',
       'callback -- step: 3, extra: false',
     ]);
   });
 
   if (!require('shared/ReactFeatureFlags').disableModulePatternComponents) {
-    it('should support stateful module pattern components', () => {
+    it('should support stateful module pattern components', async () => {
       function Child() {
         return {
           state: {
@@ -471,7 +541,12 @@ describe('ReactCompositeComponent-state', () => {
       }
 
       const el = document.createElement('div');
-      expect(() => ReactDOM.render(<Child />, el)).toErrorDev(
+      const root = ReactDOMClient.createRoot(el);
+      expect(() => {
+        ReactDOM.flushSync(() => {
+          root.render(<Child />);
+        });
+      }).toErrorDev(
         'Warning: The <Child /> component appears to be a function component that returns a class instance. ' +
           'Change Child to a class that extends React.Component instead. ' +
           "If you can't use a class try assigning the prototype on the function as a workaround. " +
@@ -482,7 +557,7 @@ describe('ReactCompositeComponent-state', () => {
       expect(el.textContent).toBe('count:123');
     });
 
-    it('should support getDerivedStateFromProps for module pattern components', () => {
+    it('should support getDerivedStateFromProps for module pattern components', async () => {
       function Child() {
         return {
           state: {
@@ -500,18 +575,62 @@ describe('ReactCompositeComponent-state', () => {
       };
 
       const el = document.createElement('div');
-      ReactDOM.render(<Child incrementBy={0} />, el);
-      expect(el.textContent).toBe('count:1');
+      const root = ReactDOMClient.createRoot(el);
+      await act(() => {
+        root.render(<Child incrementBy={0} />);
+      });
 
-      ReactDOM.render(<Child incrementBy={2} />, el);
+      expect(el.textContent).toBe('count:1');
+      await act(() => {
+        root.render(<Child incrementBy={2} />);
+      });
       expect(el.textContent).toBe('count:3');
 
-      ReactDOM.render(<Child incrementBy={1} />, el);
+      await act(() => {
+        root.render(<Child incrementBy={1} />);
+      });
       expect(el.textContent).toBe('count:4');
     });
   }
 
-  it('should support setState in componentWillUnmount', () => {
+  it('should not support setState in componentWillUnmount', async () => {
+    let subscription;
+    class A extends React.Component {
+      componentWillUnmount() {
+        subscription();
+      }
+      render() {
+        return 'A';
+      }
+    }
+
+    class B extends React.Component {
+      state = {siblingUnmounted: false};
+      UNSAFE_componentWillMount() {
+        subscription = () => this.setState({siblingUnmounted: true});
+      }
+      render() {
+        return 'B' + (this.state.siblingUnmounted ? ' No Sibling' : '');
+      }
+    }
+
+    const el = document.createElement('div');
+    const root = ReactDOMClient.createRoot(el);
+    await act(() => {
+      root.render(<A />);
+    });
+    expect(el.textContent).toBe('A');
+
+    expect(() => {
+      ReactDOM.flushSync(() => {
+        root.render(<B />);
+      });
+    }).toErrorDev(
+      "Warning: Can't perform a React state update on a component that hasn't mounted yet",
+    );
+  });
+
+  it('Legacy mode should support setState in componentWillUnmount (#18851)', () => {
     let subscription;
     class A extends React.Component {
       componentWillUnmount() {

commit 30e2938e04c8cf51688509a457a494d36bcc4269
Author: Rick Hanlon <rickhanlonii@gmail.com>
Date:   Tue Feb 6 12:43:27 2024 -0500

    [Tests] Reset modules by default (#28254)
    
    ## Overview
    
    Sets `resetModules: true` in the base Jest config, and deletes all the
    `jest.resetModule()` calls we don't need.

diff --git a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
index a2894b2ca7..299efe1672 100644
--- a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
+++ b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
@@ -520,78 +520,82 @@ describe('ReactCompositeComponent-state', () => {
     assertLog([
       'render -- step: 3, extra: false',
       'callback -- step: 3, extra: false',
-
-      // A second time for the retry.
-      'render -- step: 3, extra: false',
-      'callback -- step: 3, extra: false',
     ]);
   });
 
-  if (!require('shared/ReactFeatureFlags').disableModulePatternComponents) {
-    it('should support stateful module pattern components', async () => {
-      function Child() {
-        return {
-          state: {
-            count: 123,
-          },
-          render() {
-            return <div>{`count:${this.state.count}`}</div>;
-          },
-        };
-      }
-
-      const el = document.createElement('div');
-      const root = ReactDOMClient.createRoot(el);
-      expect(() => {
-        ReactDOM.flushSync(() => {
-          root.render(<Child />);
-        });
-      }).toErrorDev(
-        'Warning: The <Child /> component appears to be a function component that returns a class instance. ' +
-          'Change Child to a class that extends React.Component instead. ' +
-          "If you can't use a class try assigning the prototype on the function as a workaround. " +
-          '`Child.prototype = React.Component.prototype`. ' +
-          "Don't use an arrow function since it cannot be called with `new` by React.",
-      );
+  // @gate !disableModulePatternComponents
+  it('should support stateful module pattern components', async () => {
+    function Child() {
+      return {
+        state: {
+          count: 123,
+        },
+        render() {
+          return <div>{`count:${this.state.count}`}</div>;
+        },
+      };
+    }
 
-      expect(el.textContent).toBe('count:123');
-    });
+    const el = document.createElement('div');
+    const root = ReactDOMClient.createRoot(el);
+    expect(() => {
+      ReactDOM.flushSync(() => {
+        root.render(<Child />);
+      });
+    }).toErrorDev(
+      'Warning: The <Child /> component appears to be a function component that returns a class instance. ' +
+        'Change Child to a class that extends React.Component instead. ' +
+        "If you can't use a class try assigning the prototype on the function as a workaround. " +
+        '`Child.prototype = React.Component.prototype`. ' +
+        "Don't use an arrow function since it cannot be called with `new` by React.",
+    );
+
+    expect(el.textContent).toBe('count:123');
+  });
 
-    it('should support getDerivedStateFromProps for module pattern components', async () => {
-      function Child() {
-        return {
-          state: {
-            count: 1,
-          },
-          render() {
-            return <div>{`count:${this.state.count}`}</div>;
-          },
-        };
-      }
-      Child.getDerivedStateFromProps = (props, prevState) => {
-        return {
-          count: prevState.count + props.incrementBy,
-        };
+  // @gate !disableModulePatternComponents
+  it('should support getDerivedStateFromProps for module pattern components', async () => {
+    function Child() {
+      return {
+        state: {
+          count: 1,
+        },
+        render() {
+          return <div>{`count:${this.state.count}`}</div>;
+        },
+      };
+    }
+    Child.getDerivedStateFromProps = (props, prevState) => {
+      return {
+        count: prevState.count + props.incrementBy,
       };
+    };
 
-      const el = document.createElement('div');
-      const root = ReactDOMClient.createRoot(el);
-      await act(() => {
+    const el = document.createElement('div');
+    const root = ReactDOMClient.createRoot(el);
+    expect(() => {
+      ReactDOM.flushSync(() => {
         root.render(<Child incrementBy={0} />);
       });
+    }).toErrorDev(
+      'Warning: The <Child /> component appears to be a function component that returns a class instance. ' +
+        'Change Child to a class that extends React.Component instead. ' +
+        "If you can't use a class try assigning the prototype on the function as a workaround. " +
+        '`Child.prototype = React.Component.prototype`. ' +
+        "Don't use an arrow function since it cannot be called with `new` by React.",
+    );
 
-      expect(el.textContent).toBe('count:1');
-      await act(() => {
-        root.render(<Child incrementBy={2} />);
-      });
-      expect(el.textContent).toBe('count:3');
+    expect(el.textContent).toBe('count:1');
+    await act(() => {
+      root.render(<Child incrementBy={2} />);
+    });
+    expect(el.textContent).toBe('count:3');
 
-      await act(() => {
-        root.render(<Child incrementBy={1} />);
-      });
-      expect(el.textContent).toBe('count:4');
+    await act(() => {
+      root.render(<Child incrementBy={1} />);
     });
-  }
+    expect(el.textContent).toBe('count:4');
+  });
 
   it('should not support setState in componentWillUnmount', async () => {
     let subscription;

commit 015ff2ed66c1d164111752263682d1d757c97f3e
Author: Andrew Clark <git@andrewclark.io>
Date:   Tue Feb 13 11:39:45 2024 -0500

    Revert "[Tests] Reset modules by default" (#28318)
    
    This was causing a slowdown in one of the tests
    ESLintRuleExhaustiveDeps-test.js. Reverting until we figure out why.

diff --git a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
index 299efe1672..a2894b2ca7 100644
--- a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
+++ b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
@@ -520,82 +520,78 @@ describe('ReactCompositeComponent-state', () => {
     assertLog([
       'render -- step: 3, extra: false',
       'callback -- step: 3, extra: false',
+
+      // A second time for the retry.
+      'render -- step: 3, extra: false',
+      'callback -- step: 3, extra: false',
     ]);
   });
 
-  // @gate !disableModulePatternComponents
-  it('should support stateful module pattern components', async () => {
-    function Child() {
-      return {
-        state: {
-          count: 123,
-        },
-        render() {
-          return <div>{`count:${this.state.count}`}</div>;
-        },
-      };
-    }
-
-    const el = document.createElement('div');
-    const root = ReactDOMClient.createRoot(el);
-    expect(() => {
-      ReactDOM.flushSync(() => {
-        root.render(<Child />);
-      });
-    }).toErrorDev(
-      'Warning: The <Child /> component appears to be a function component that returns a class instance. ' +
-        'Change Child to a class that extends React.Component instead. ' +
-        "If you can't use a class try assigning the prototype on the function as a workaround. " +
-        '`Child.prototype = React.Component.prototype`. ' +
-        "Don't use an arrow function since it cannot be called with `new` by React.",
-    );
+  if (!require('shared/ReactFeatureFlags').disableModulePatternComponents) {
+    it('should support stateful module pattern components', async () => {
+      function Child() {
+        return {
+          state: {
+            count: 123,
+          },
+          render() {
+            return <div>{`count:${this.state.count}`}</div>;
+          },
+        };
+      }
+
+      const el = document.createElement('div');
+      const root = ReactDOMClient.createRoot(el);
+      expect(() => {
+        ReactDOM.flushSync(() => {
+          root.render(<Child />);
+        });
+      }).toErrorDev(
+        'Warning: The <Child /> component appears to be a function component that returns a class instance. ' +
+          'Change Child to a class that extends React.Component instead. ' +
+          "If you can't use a class try assigning the prototype on the function as a workaround. " +
+          '`Child.prototype = React.Component.prototype`. ' +
+          "Don't use an arrow function since it cannot be called with `new` by React.",
+      );
 
-    expect(el.textContent).toBe('count:123');
-  });
+      expect(el.textContent).toBe('count:123');
+    });
 
-  // @gate !disableModulePatternComponents
-  it('should support getDerivedStateFromProps for module pattern components', async () => {
-    function Child() {
-      return {
-        state: {
-          count: 1,
-        },
-        render() {
-          return <div>{`count:${this.state.count}`}</div>;
-        },
-      };
-    }
-    Child.getDerivedStateFromProps = (props, prevState) => {
-      return {
-        count: prevState.count + props.incrementBy,
+    it('should support getDerivedStateFromProps for module pattern components', async () => {
+      function Child() {
+        return {
+          state: {
+            count: 1,
+          },
+          render() {
+            return <div>{`count:${this.state.count}`}</div>;
+          },
+        };
+      }
+      Child.getDerivedStateFromProps = (props, prevState) => {
+        return {
+          count: prevState.count + props.incrementBy,
+        };
       };
-    };
 
-    const el = document.createElement('div');
-    const root = ReactDOMClient.createRoot(el);
-    expect(() => {
-      ReactDOM.flushSync(() => {
+      const el = document.createElement('div');
+      const root = ReactDOMClient.createRoot(el);
+      await act(() => {
         root.render(<Child incrementBy={0} />);
       });
-    }).toErrorDev(
-      'Warning: The <Child /> component appears to be a function component that returns a class instance. ' +
-        'Change Child to a class that extends React.Component instead. ' +
-        "If you can't use a class try assigning the prototype on the function as a workaround. " +
-        '`Child.prototype = React.Component.prototype`. ' +
-        "Don't use an arrow function since it cannot be called with `new` by React.",
-    );
 
-    expect(el.textContent).toBe('count:1');
-    await act(() => {
-      root.render(<Child incrementBy={2} />);
-    });
-    expect(el.textContent).toBe('count:3');
+      expect(el.textContent).toBe('count:1');
+      await act(() => {
+        root.render(<Child incrementBy={2} />);
+      });
+      expect(el.textContent).toBe('count:3');
 
-    await act(() => {
-      root.render(<Child incrementBy={1} />);
+      await act(() => {
+        root.render(<Child incrementBy={1} />);
+      });
+      expect(el.textContent).toBe('count:4');
     });
-    expect(el.textContent).toBe('count:4');
-  });
+  }
 
   it('should not support setState in componentWillUnmount', async () => {
     let subscription;

commit 1c02b9d2bdc18091cc6afec810fc1b361f00abdd
Author: Josh Story <story@hey.com>
Date:   Mon Mar 4 08:19:17 2024 -0800

    [DOM] disable legacy mode behind flag (#28468)
    
    Adds a flag to disable legacy mode. Currently this flag is used to cause
    legacy mode apis like render and hydrate to throw. This change also
    removes render, hydrate, unmountComponentAtNode, and
    unstable_renderSubtreeIntoContainer from the experiemntal entrypoint.
    Right now for Meta builds this flag is off (legacy mode is still
    supported). In OSS builds this flag matches __NEXT_MAJOR__ which means
    it currently is on in experiemental. This means that after merging
    legacy mode is effectively removed from experimental builds. While this
    is a breaking change, experimental builds are not stable and users can
    pin to older versions or update their use of react-dom to no longer use
    legacy mode APIs.

diff --git a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
index a2894b2ca7..a1d3d28533 100644
--- a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
+++ b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
@@ -630,6 +630,7 @@ describe('ReactCompositeComponent-state', () => {
     );
   });
 
+  // @gate !disableLegacyMode
   it('Legacy mode should support setState in componentWillUnmount (#18851)', () => {
     let subscription;
     class A extends React.Component {

commit cc56bed38cbe5a5c76dfdc4e9c642fab4884a3fc
Author: Josh Story <story@hey.com>
Date:   Thu Mar 28 13:08:08 2024 -0700

    Remove module pattern function component support (#27742)
    
    The module pattern
    
    ```
    function MyComponent() {
      return {
        render() {
          return this.state.foo
        }
      }
    }
    ```
    
    has been deprecated for approximately 5 years now. This PR removes
    support for this pattern. It also simplifies a number of code paths in
    particular related to the concept of `IndeterminateComponent` types.

diff --git a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
index a1d3d28533..ecb30f0f1d 100644
--- a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
+++ b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
@@ -527,72 +527,6 @@ describe('ReactCompositeComponent-state', () => {
     ]);
   });
 
-  if (!require('shared/ReactFeatureFlags').disableModulePatternComponents) {
-    it('should support stateful module pattern components', async () => {
-      function Child() {
-        return {
-          state: {
-            count: 123,
-          },
-          render() {
-            return <div>{`count:${this.state.count}`}</div>;
-          },
-        };
-      }
-
-      const el = document.createElement('div');
-      const root = ReactDOMClient.createRoot(el);
-      expect(() => {
-        ReactDOM.flushSync(() => {
-          root.render(<Child />);
-        });
-      }).toErrorDev(
-        'Warning: The <Child /> component appears to be a function component that returns a class instance. ' +
-          'Change Child to a class that extends React.Component instead. ' +
-          "If you can't use a class try assigning the prototype on the function as a workaround. " +
-          '`Child.prototype = React.Component.prototype`. ' +
-          "Don't use an arrow function since it cannot be called with `new` by React.",
-      );
-
-      expect(el.textContent).toBe('count:123');
-    });
-
-    it('should support getDerivedStateFromProps for module pattern components', async () => {
-      function Child() {
-        return {
-          state: {
-            count: 1,
-          },
-          render() {
-            return <div>{`count:${this.state.count}`}</div>;
-          },
-        };
-      }
-      Child.getDerivedStateFromProps = (props, prevState) => {
-        return {
-          count: prevState.count + props.incrementBy,
-        };
-      };
-
-      const el = document.createElement('div');
-      const root = ReactDOMClient.createRoot(el);
-      await act(() => {
-        root.render(<Child incrementBy={0} />);
-      });
-
-      expect(el.textContent).toBe('count:1');
-      await act(() => {
-        root.render(<Child incrementBy={2} />);
-      });
-      expect(el.textContent).toBe('count:3');
-
-      await act(() => {
-        root.render(<Child incrementBy={1} />);
-      });
-      expect(el.textContent).toBe('count:4');
-    });
-  }
-
   it('should not support setState in componentWillUnmount', async () => {
     let subscription;
     class A extends React.Component {

commit f2690747239533fa266612d2d4dd9ae88ea92fbc
Author: Rick Hanlon <rickhanlonii@gmail.com>
Date:   Fri Mar 29 10:10:11 2024 -0400

    Revert "Remove module pattern function component support" (#28670)
    
    This breaks internal tests, so must be something in the refactor. Since
    it's the top commit let's revert and split into two PRs, one that
    removes the flag and one that does the refactor, so we can find the bug.

diff --git a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
index ecb30f0f1d..a1d3d28533 100644
--- a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
+++ b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
@@ -527,6 +527,72 @@ describe('ReactCompositeComponent-state', () => {
     ]);
   });
 
+  if (!require('shared/ReactFeatureFlags').disableModulePatternComponents) {
+    it('should support stateful module pattern components', async () => {
+      function Child() {
+        return {
+          state: {
+            count: 123,
+          },
+          render() {
+            return <div>{`count:${this.state.count}`}</div>;
+          },
+        };
+      }
+
+      const el = document.createElement('div');
+      const root = ReactDOMClient.createRoot(el);
+      expect(() => {
+        ReactDOM.flushSync(() => {
+          root.render(<Child />);
+        });
+      }).toErrorDev(
+        'Warning: The <Child /> component appears to be a function component that returns a class instance. ' +
+          'Change Child to a class that extends React.Component instead. ' +
+          "If you can't use a class try assigning the prototype on the function as a workaround. " +
+          '`Child.prototype = React.Component.prototype`. ' +
+          "Don't use an arrow function since it cannot be called with `new` by React.",
+      );
+
+      expect(el.textContent).toBe('count:123');
+    });
+
+    it('should support getDerivedStateFromProps for module pattern components', async () => {
+      function Child() {
+        return {
+          state: {
+            count: 1,
+          },
+          render() {
+            return <div>{`count:${this.state.count}`}</div>;
+          },
+        };
+      }
+      Child.getDerivedStateFromProps = (props, prevState) => {
+        return {
+          count: prevState.count + props.incrementBy,
+        };
+      };
+
+      const el = document.createElement('div');
+      const root = ReactDOMClient.createRoot(el);
+      await act(() => {
+        root.render(<Child incrementBy={0} />);
+      });
+
+      expect(el.textContent).toBe('count:1');
+      await act(() => {
+        root.render(<Child incrementBy={2} />);
+      });
+      expect(el.textContent).toBe('count:3');
+
+      await act(() => {
+        root.render(<Child incrementBy={1} />);
+      });
+      expect(el.textContent).toBe('count:4');
+    });
+  }
+
   it('should not support setState in componentWillUnmount', async () => {
     let subscription;
     class A extends React.Component {

commit a73c3450e1b528fa6cb3e94fa4d4359c7a4b61f1
Author: Jan Kassens <jkassens@meta.com>
Date:   Fri Mar 29 11:16:17 2024 -0400

    Remove module pattern function component support (flag only) (#28671)
    
    Remove module pattern function component support (flag only)
    
    > This is a redo of #27742, but only including the flag removal,
    excluding further simplifications.
    
    The module pattern
    
    ```
    function MyComponent() {
      return {
        render() {
          return this.state.foo
        }
      }
    }
    ```
    
    has been deprecated for approximately 5 years now. This PR removes
    support for this pattern.

diff --git a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
index a1d3d28533..ecb30f0f1d 100644
--- a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
+++ b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
@@ -527,72 +527,6 @@ describe('ReactCompositeComponent-state', () => {
     ]);
   });
 
-  if (!require('shared/ReactFeatureFlags').disableModulePatternComponents) {
-    it('should support stateful module pattern components', async () => {
-      function Child() {
-        return {
-          state: {
-            count: 123,
-          },
-          render() {
-            return <div>{`count:${this.state.count}`}</div>;
-          },
-        };
-      }
-
-      const el = document.createElement('div');
-      const root = ReactDOMClient.createRoot(el);
-      expect(() => {
-        ReactDOM.flushSync(() => {
-          root.render(<Child />);
-        });
-      }).toErrorDev(
-        'Warning: The <Child /> component appears to be a function component that returns a class instance. ' +
-          'Change Child to a class that extends React.Component instead. ' +
-          "If you can't use a class try assigning the prototype on the function as a workaround. " +
-          '`Child.prototype = React.Component.prototype`. ' +
-          "Don't use an arrow function since it cannot be called with `new` by React.",
-      );
-
-      expect(el.textContent).toBe('count:123');
-    });
-
-    it('should support getDerivedStateFromProps for module pattern components', async () => {
-      function Child() {
-        return {
-          state: {
-            count: 1,
-          },
-          render() {
-            return <div>{`count:${this.state.count}`}</div>;
-          },
-        };
-      }
-      Child.getDerivedStateFromProps = (props, prevState) => {
-        return {
-          count: prevState.count + props.incrementBy,
-        };
-      };
-
-      const el = document.createElement('div');
-      const root = ReactDOMClient.createRoot(el);
-      await act(() => {
-        root.render(<Child incrementBy={0} />);
-      });
-
-      expect(el.textContent).toBe('count:1');
-      await act(() => {
-        root.render(<Child incrementBy={2} />);
-      });
-      expect(el.textContent).toBe('count:3');
-
-      await act(() => {
-        root.render(<Child incrementBy={1} />);
-      });
-      expect(el.textContent).toBe('count:4');
-    });
-  }
-
   it('should not support setState in componentWillUnmount', async () => {
     let subscription;
     class A extends React.Component {

commit e36ee763faf9f273f162ad3292b36382834bdf30
Author: Rick Hanlon <rickhanlonii@gmail.com>
Date:   Wed Apr 10 10:33:51 2024 -0400

    [tests] assertLog before act in ReactCompositeComponentState (#28758)
    
    Fixes tests blocking https://github.com/facebook/react/pull/28737

diff --git a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
index ecb30f0f1d..bd11d1ab6d 100644
--- a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
+++ b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
@@ -152,21 +152,6 @@ describe('ReactCompositeComponent-state', () => {
       root.render(<TestComponent />);
     });
 
-    await act(() => {
-      root.render(<TestComponent nextColor="green" />);
-    });
-
-    await act(() => {
-      testComponentInstance.setFavoriteColor('blue');
-    });
-    await act(() => {
-      testComponentInstance.forceUpdate(
-        testComponentInstance.peekAtCallback('forceUpdate'),
-      );
-    });
-
-    root.unmount();
-
     assertLog([
       // there is no state when getInitialState() is called
       'getInitialState undefined',
@@ -198,6 +183,13 @@ describe('ReactCompositeComponent-state', () => {
       'componentDidUpdate-prevState orange',
       'setState-yellow yellow',
       'commit yellow',
+    ]);
+
+    await act(() => {
+      root.render(<TestComponent nextColor="green" />);
+    });
+
+    assertLog([
       'componentWillReceiveProps-start yellow',
       // setState({color:'green'}) only enqueues a pending state.
       'componentWillReceiveProps-end yellow',
@@ -216,6 +208,13 @@ describe('ReactCompositeComponent-state', () => {
       'componentDidUpdate-prevState yellow',
       'setState-receiveProps green',
       'commit green',
+    ]);
+
+    await act(() => {
+      testComponentInstance.setFavoriteColor('blue');
+    });
+
+    assertLog([
       // setFavoriteColor('blue')
       'shouldComponentUpdate-currentState green',
       'shouldComponentUpdate-nextState blue',
@@ -226,6 +225,13 @@ describe('ReactCompositeComponent-state', () => {
       'componentDidUpdate-prevState green',
       'setFavoriteColor blue',
       'commit blue',
+    ]);
+    await act(() => {
+      testComponentInstance.forceUpdate(
+        testComponentInstance.peekAtCallback('forceUpdate'),
+      );
+    });
+    assertLog([
       // forceUpdate()
       'componentWillUpdate-currentState blue',
       'componentWillUpdate-nextState blue',
@@ -234,7 +240,12 @@ describe('ReactCompositeComponent-state', () => {
       'componentDidUpdate-prevState blue',
       'forceUpdate blue',
       'commit blue',
-      // unmountComponent()
+    ]);
+
+    root.unmount();
+
+    assertLog([
+      // unmount()
       // state is available within `componentWillUnmount()`
       'componentWillUnmount blue',
     ]);
@@ -375,13 +386,13 @@ describe('ReactCompositeComponent-state', () => {
     await act(() => {
       root.render(<Parent />);
     });
+
+    assertLog(['parent render one', 'child render one']);
     await act(() => {
       root.render(<Parent />);
     });
 
     assertLog([
-      'parent render one',
-      'child render one',
       'parent render one',
       'child componentWillReceiveProps one',
       'child componentWillReceiveProps done one',

commit 277420803947724b43c47bbc47d3a353553868f1
Author: Sebastian Markbåge <sebastian@calyptus.eu>
Date:   Mon Jun 10 18:41:56 2024 -0400

    Remove Warning: prefix and toString on console Arguments (#29839)
    
    Basically make `console.error` and `console.warn` behave like normal -
    when a component stack isn't appended. I need this because I need to be
    able to print rich logs with the component stack option and to be able
    to disable instrumentation completely in `console.createTask`
    environments that don't need it.
    
    Currently we can't print logs with richer objects because they're
    toString:ed first. In practice, pretty much all arguments we log are
    already toString:ed so it's not necessary anyway. Some might be like a
    number. So it would only be a problem if some environment can't handle
    proper consoles but then it's up to that environment to toString it
    before logging.
    
    The `Warning: ` prefix is historic and is both noisy and confusing. It's
    mostly unnecessary since the UI surrounding `console.error` and
    `console.warn` tend to have visual treatment around it anyway. However,
    it's actively misleading when `console.error` gets prefixed with a
    Warning that we consider an error level. There's an argument to be made
    that some of our `console.error` don't make the bar for an error but
    then the argument is to downgrade each of those to `console.warn` - not
    to brand all our actual error logging with `Warning: `.
    
    Apparently something needs to change in React Native before landing this
    because it depends on the prefix somehow which probably doesn't make
    sense already.

diff --git a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
index bd11d1ab6d..a651a477a8 100644
--- a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
+++ b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
@@ -474,7 +474,7 @@ describe('ReactCompositeComponent-state', () => {
         root.render(<Test />);
       });
     }).toErrorDev(
-      'Warning: Test.componentWillReceiveProps(): Assigning directly to ' +
+      'Test.componentWillReceiveProps(): Assigning directly to ' +
         "this.state is deprecated (except inside a component's constructor). " +
         'Use setState instead.',
     );
@@ -523,7 +523,7 @@ describe('ReactCompositeComponent-state', () => {
         root.render(<Test />);
       });
     }).toErrorDev(
-      'Warning: Test.componentWillMount(): Assigning directly to ' +
+      'Test.componentWillMount(): Assigning directly to ' +
         "this.state is deprecated (except inside a component's constructor). " +
         'Use setState instead.',
     );
@@ -571,7 +571,7 @@ describe('ReactCompositeComponent-state', () => {
         root.render(<B />);
       });
     }).toErrorDev(
-      "Warning: Can't perform a React state update on a component that hasn't mounted yet",
+      "Can't perform a React state update on a component that hasn't mounted yet",
     );
   });
 

commit a7c898d83a991c48f3981fcc65d969f1d90d80a1
Author: Rick Hanlon <rickhanlonii@gmail.com>
Date:   Thu Jan 2 15:28:06 2025 -0500

    [assert helpers] react-dom (pt 1) (#31897)
    
    Converts ~half of react-dom tests

diff --git a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
index a651a477a8..d0d1c36e51 100644
--- a/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
+++ b/packages/react-dom/src/__tests__/ReactCompositeComponentState-test.js
@@ -17,13 +17,14 @@ let Scheduler;
 let assertLog;
 let TestComponent;
 let testComponentInstance;
+let assertConsoleErrorDev;
 
 describe('ReactCompositeComponent-state', () => {
   beforeEach(() => {
     React = require('react');
     ReactDOM = require('react-dom');
     ReactDOMClient = require('react-dom/client');
-    act = require('internal-test-utils').act;
+    ({act, assertConsoleErrorDev} = require('internal-test-utils'));
     Scheduler = require('scheduler');
 
     const InternalTestUtils = require('internal-test-utils');
@@ -469,15 +470,15 @@ describe('ReactCompositeComponent-state', () => {
       root.render(<Test />);
     });
     // Update
-    expect(() => {
-      ReactDOM.flushSync(() => {
-        root.render(<Test />);
-      });
-    }).toErrorDev(
+    ReactDOM.flushSync(() => {
+      root.render(<Test />);
+    });
+    assertConsoleErrorDev([
       'Test.componentWillReceiveProps(): Assigning directly to ' +
         "this.state is deprecated (except inside a component's constructor). " +
-        'Use setState instead.',
-    );
+        'Use setState instead.\n' +
+        '    in Test (at **)',
+    ]);
 
     assertLog([
       'render -- step: 1, extra: true',
@@ -518,15 +519,15 @@ describe('ReactCompositeComponent-state', () => {
     // Mount
     const container = document.createElement('div');
     const root = ReactDOMClient.createRoot(container);
-    expect(() => {
-      ReactDOM.flushSync(() => {
-        root.render(<Test />);
-      });
-    }).toErrorDev(
+    ReactDOM.flushSync(() => {
+      root.render(<Test />);
+    });
+    assertConsoleErrorDev([
       'Test.componentWillMount(): Assigning directly to ' +
         "this.state is deprecated (except inside a component's constructor). " +
-        'Use setState instead.',
-    );
+        'Use setState instead.\n' +
+        '    in Test (at **)',
+    ]);
 
     assertLog([
       'render -- step: 3, extra: false',
@@ -566,13 +567,16 @@ describe('ReactCompositeComponent-state', () => {
     });
     expect(el.textContent).toBe('A');
 
-    expect(() => {
-      ReactDOM.flushSync(() => {
-        root.render(<B />);
-      });
-    }).toErrorDev(
-      "Can't perform a React state update on a component that hasn't mounted yet",
-    );
+    ReactDOM.flushSync(() => {
+      root.render(<B />);
+    });
+    assertConsoleErrorDev([
+      "Can't perform a React state update on a component that hasn't mounted yet. " +
+        'This indicates that you have a side-effect in your render function that ' +
+        'asynchronously later calls tries to update the component. ' +
+        'Move this work to useEffect instead.\n' +
+        '    in B (at **)',
+    ]);
   });
 
   // @gate !disableLegacyMode

