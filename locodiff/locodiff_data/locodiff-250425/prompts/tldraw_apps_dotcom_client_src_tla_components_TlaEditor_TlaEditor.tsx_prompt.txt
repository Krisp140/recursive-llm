# Instructions

You are being benchmarked. You will see the output of a git log command, and from that must infer the current state of a file. Think carefully, as you must output the exact state of the file to earn full marks.

**Important:** Your goal is to reproduce the file's content *exactly* as it exists at the final commit, even if the code appears broken, buggy, or contains obvious errors. Do **not** try to "fix" the code. Attempting to correct issues will result in a poor score, as this benchmark evaluates your ability to reproduce the precise state of the file based on its history.

# Required Response Format

Wrap the content of the file in triple backticks (```). Any text outside the final closing backticks will be ignored. End your response after outputting the closing backticks.

# Example Response

```python
#!/usr/bin/env python
print('Hello, world!')
```

# File History

> git log -p --cc --topo-order --reverse -- apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx

commit f6413e3e7d32c8cb7276b9059040bea0de77d3ea
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Fri Sep 27 18:32:51 2024 -0400

    [botcom] Share menu (#4604)
    
    This PR adds UI for the share menu.
    
    Fun fact: while writing this I found a much better way for us to do our
    QR codes with SVGs, if we want it!
    
    ![localhost_3000_q_f_0
    (1)](https://github.com/user-attachments/assets/ed1353c8-f2a9-4e86-992f-eedb3a48827f)
    
    ![localhost_3000_q_f_0
    (2)](https://github.com/user-attachments/assets/6bc7cf32-5ce7-4b50-addb-65e7669a0a4b)
    
    
    ![localhost_3000_q_f_0](https://github.com/user-attachments/assets/89c434c6-273f-4b14-b778-d6c10bc779ef)
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [x] `other`

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
new file mode 100644
index 000000000..fb6502807
--- /dev/null
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -0,0 +1,252 @@
+import { useCallback, useEffect, useRef, useState } from 'react'
+import {
+	DefaultDebugMenu,
+	DefaultDebugMenuContent,
+	DefaultKeyboardShortcutsDialog,
+	DefaultKeyboardShortcutsDialogContent,
+	DefaultMainMenu,
+	EditSubmenu,
+	Editor,
+	ExportFileContentSubMenu,
+	ExtrasGroup,
+	PreferencesGroup,
+	TLComponents,
+	Tldraw,
+	ViewSubmenu,
+	useBreakpoint,
+	useEditor,
+	useReactor,
+	useTldrawUiComponents,
+} from 'tldraw'
+import { Links } from '../../../components/Links'
+import { SneakyOnDropOverride } from '../../../components/SneakyOnDropOverride'
+import { ThemeUpdater } from '../../../components/ThemeUpdater/ThemeUpdater'
+import { assetUrls } from '../../../utils/assetUrls'
+import { createAssetFromUrl } from '../../../utils/createAssetFromUrl'
+import { globalEditor } from '../../../utils/globalEditor'
+import { DebugMenuItems } from '../../../utils/migration/DebugMenuItems'
+import { LocalMigration } from '../../../utils/migration/LocalMigration'
+import { useSharing } from '../../../utils/sharing'
+import { useFileSystem } from '../../../utils/useFileSystem'
+import { useHandleUiEvents } from '../../../utils/useHandleUiEvent'
+import { useApp } from '../../hooks/useAppState'
+import { TldrawApp } from '../../utils/TldrawApp'
+import { TldrawAppFile } from '../../utils/schema/TldrawAppFile'
+import styles from './editor.module.css'
+// const shittyOfflineAtom = atom('shitty offline atom', false)
+
+const components: TLComponents = {
+	ErrorFallback: ({ error }) => {
+		throw error
+	},
+	// HelpMenu: () => (
+	// 	<DefaultHelpMenu>
+	// 		<TldrawUiMenuGroup id="help">
+	// 			<DefaultHelpMenuContent />
+	// 		</TldrawUiMenuGroup>
+	// 		<Links />
+	// 	</DefaultHelpMenu>
+	// ),
+	MainMenu: () => (
+		<DefaultMainMenu>
+			{/* <MultiplayerFileMenu /> */}
+			<EditSubmenu />
+			<ViewSubmenu />
+			<ExportFileContentSubMenu />
+			<ExtrasGroup />
+			<PreferencesGroup />
+			<Links />
+		</DefaultMainMenu>
+	),
+	MenuPanel: function MenuPanel() {
+		const breakpoint = useBreakpoint()
+
+		const { MainMenu, QuickActions, ActionsMenu, PageMenu } = useTldrawUiComponents()
+
+		if (!MainMenu && !PageMenu && breakpoint < 6) return null
+
+		return (
+			<div className="tlui-menu-zone">
+				<div className="tlui-buttons__horizontal">
+					{MainMenu && <MainMenu />}
+					{breakpoint < 6 ? null : (
+						<>
+							{QuickActions && <QuickActions />}
+							{ActionsMenu && <ActionsMenu />}
+						</>
+					)}
+				</div>
+			</div>
+		)
+	},
+	KeyboardShortcutsDialog: (props) => {
+		// const actions = useActions()
+		return (
+			<DefaultKeyboardShortcutsDialog {...props}>
+				{/* <TldrawUiMenuGroup label="shortcuts-dialog.file" id="file">
+					<TldrawUiMenuItem {...actions[SAVE_FILE_COPY_ACTION]} />
+					<TldrawUiMenuItem {...actions[OPEN_FILE_ACTION]} />
+				</TldrawUiMenuGroup> */}
+				<DefaultKeyboardShortcutsDialogContent />
+				{/* <TldrawUiMenuGroup label="shortcuts-dialog.collaboration" id="collaboration">
+					<TldrawUiMenuItem {...actions[CURSOR_CHAT_ACTION]} />
+				</TldrawUiMenuGroup> */}
+			</DefaultKeyboardShortcutsDialog>
+		)
+	},
+	DebugMenu: () => {
+		return (
+			<DefaultDebugMenu>
+				<DefaultDebugMenuContent />
+				<DebugMenuItems />
+			</DefaultDebugMenu>
+		)
+	},
+	// TopPanel: () => {
+	// 	const isOffline = useValue('offline', () => shittyOfflineAtom.get(), [])
+	// 	return <TlaDocumentTopZone isOffline={isOffline} />
+	// },
+	SharePanel: () => {
+		return null
+		// return (
+		// 	<div className="tlui-share-zone" draggable={false}>
+		// 		<PeopleMenu />
+		// 		<ShareMenu />
+		// 	</div>
+		// )
+	},
+}
+
+export function TlaEditor({
+	file,
+	onDocumentChange,
+}: {
+	file: TldrawAppFile
+	onDocumentChange?(): void
+}) {
+	const handleUiEvent = useHandleUiEvents()
+	const app = useApp()
+
+	const { id: fileId } = file
+
+	const [ready, setReady] = useState(false)
+	const rPrevFileId = useRef(fileId)
+	useEffect(() => {
+		if (rPrevFileId.current !== fileId) {
+			setReady(false)
+			rPrevFileId.current = fileId
+		}
+	}, [fileId])
+
+	const persistenceKey = `tla-2_${fileId}`
+
+	const sharingUiOverrides = useSharing()
+	const fileSystemUiOverrides = useFileSystem({ isMultiplayer: false })
+
+	const handleMount = useCallback(
+		(editor: Editor) => {
+			;(window as any).app = editor
+			;(window as any).editor = editor
+			globalEditor.set(editor)
+			editor.registerExternalAssetHandler('url', createAssetFromUrl)
+			app.setCurrentEditor(editor)
+			editor.timers.setTimeout(() => {
+				setReady(true)
+			}, 200)
+
+			const fileStartTime = Date.now()
+
+			editor.store.listen(
+				() => {
+					// Update the user's edited session date for this file
+					const sessionState = app.getSessionState()
+					if (!sessionState.auth) throw Error('Auth not found')
+					const user = app.getUser(sessionState.auth.userId)
+					if (!user) throw Error('User not found')
+
+					app.onFileEdit(user.id, fileId, sessionState.createdAt, fileStartTime)
+
+					if (onDocumentChange) {
+						onDocumentChange()
+					}
+				},
+				{ scope: 'document', source: 'user' }
+			)
+		},
+		[app, onDocumentChange, fileId]
+	)
+
+	useEffect(() => {
+		const { auth } = app.getSessionState()
+		if (!auth) throw Error('Auth not found')
+
+		const user = app.getUser(auth.userId)
+		if (!user) throw Error('User not found')
+
+		if (user.presence.fileIds.includes(fileId)) {
+			return
+		}
+
+		let cancelled = false
+		let didEnter = false
+
+		const timeout = setTimeout(() => {
+			if (cancelled) return
+			didEnter = true
+			app.onFileEnter(auth.userId, fileId)
+		}, 1000)
+
+		return () => {
+			cancelled = true
+			clearTimeout(timeout)
+
+			if (didEnter) {
+				app.onFileExit(auth.userId, fileId)
+			}
+		}
+	}, [app, fileId])
+
+	return (
+		<div className={styles.editor}>
+			<Tldraw
+				key={persistenceKey}
+				assetUrls={assetUrls}
+				persistenceKey={persistenceKey}
+				onMount={handleMount}
+				overrides={[sharingUiOverrides, fileSystemUiOverrides]}
+				onUiEvent={handleUiEvent}
+				components={components}
+			>
+				<LocalMigration />
+				<SneakyOnDropOverride isMultiplayer={false} />
+				<ThemeUpdater />
+				{/* <CursorChatBubble /> */}
+				<SneakyDarkModeSync />
+			</Tldraw>
+			{ready ? null : <div key={persistenceKey + 'overlay'} className={styles.overlay} />}
+		</div>
+	)
+}
+
+function SneakyDarkModeSync() {
+	const app = useApp()
+	const editor = useEditor()
+
+	useReactor(
+		'dark mode sync',
+		() => {
+			const appIsDark =
+				app.store.unsafeGetWithoutCapture(TldrawApp.SessionStateId)!.theme === 'dark'
+			const editorIsDark = editor.user.getIsDarkMode()
+
+			if (appIsDark && !editorIsDark) {
+				app.setSessionState({ ...app.getSessionState(), theme: 'light' })
+			} else if (!appIsDark && editorIsDark) {
+				app.setSessionState({ ...app.getSessionState(), theme: 'dark' })
+			}
+		},
+		[app, editor]
+	)
+
+	return null
+}

commit e3ca52603451ccbe4ae99c2ce9e066d6af5e043c
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Mon Sep 30 12:36:52 2024 +0100

    [botcom] use tlsync as prototype backend (#4617)
    
    phew that was a beefy one.
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [x] `other`
    
    ---------
    
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index fb6502807..3b3164cb3 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -1,3 +1,5 @@
+import { TldrawAppFileRecordType } from '@tldraw/dotcom-shared'
+import { useSync } from '@tldraw/sync'
 import { useCallback, useEffect, useRef, useState } from 'react'
 import {
 	DefaultDebugMenu,
@@ -22,17 +24,18 @@ import { Links } from '../../../components/Links'
 import { SneakyOnDropOverride } from '../../../components/SneakyOnDropOverride'
 import { ThemeUpdater } from '../../../components/ThemeUpdater/ThemeUpdater'
 import { assetUrls } from '../../../utils/assetUrls'
+import { MULTIPLAYER_SERVER } from '../../../utils/config'
 import { createAssetFromUrl } from '../../../utils/createAssetFromUrl'
 import { globalEditor } from '../../../utils/globalEditor'
 import { DebugMenuItems } from '../../../utils/migration/DebugMenuItems'
 import { LocalMigration } from '../../../utils/migration/LocalMigration'
+import { multiplayerAssetStore } from '../../../utils/multiplayerAssetStore'
 import { useSharing } from '../../../utils/sharing'
-import { useFileSystem } from '../../../utils/useFileSystem'
 import { useHandleUiEvents } from '../../../utils/useHandleUiEvent'
-import { useApp } from '../../hooks/useAppState'
+import { useMaybeApp } from '../../hooks/useAppState'
 import { TldrawApp } from '../../utils/TldrawApp'
-import { TldrawAppFile } from '../../utils/schema/TldrawAppFile'
 import styles from './editor.module.css'
+
 // const shittyOfflineAtom = atom('shitty offline atom', false)
 
 const components: TLComponents = {
@@ -118,18 +121,18 @@ const components: TLComponents = {
 }
 
 export function TlaEditor({
-	file,
+	fileSlug,
 	onDocumentChange,
 }: {
-	file: TldrawAppFile
+	fileSlug: string
 	onDocumentChange?(): void
 }) {
 	const handleUiEvent = useHandleUiEvents()
-	const app = useApp()
-
-	const { id: fileId } = file
+	const app = useMaybeApp()
 
 	const [ready, setReady] = useState(false)
+	const fileId = TldrawAppFileRecordType.createId(fileSlug)
+
 	const rPrevFileId = useRef(fileId)
 	useEffect(() => {
 		if (rPrevFileId.current !== fileId) {
@@ -138,10 +141,7 @@ export function TlaEditor({
 		}
 	}, [fileId])
 
-	const persistenceKey = `tla-2_${fileId}`
-
 	const sharingUiOverrides = useSharing()
-	const fileSystemUiOverrides = useFileSystem({ isMultiplayer: false })
 
 	const handleMount = useCallback(
 		(editor: Editor) => {
@@ -149,7 +149,7 @@ export function TlaEditor({
 			;(window as any).editor = editor
 			globalEditor.set(editor)
 			editor.registerExternalAssetHandler('url', createAssetFromUrl)
-			app.setCurrentEditor(editor)
+			app?.setCurrentEditor(editor)
 			editor.timers.setTimeout(() => {
 				setReady(true)
 			}, 200)
@@ -159,16 +159,15 @@ export function TlaEditor({
 			editor.store.listen(
 				() => {
 					// Update the user's edited session date for this file
-					const sessionState = app.getSessionState()
-					if (!sessionState.auth) throw Error('Auth not found')
-					const user = app.getUser(sessionState.auth.userId)
-					if (!user) throw Error('User not found')
-
-					app.onFileEdit(user.id, fileId, sessionState.createdAt, fileStartTime)
-
-					if (onDocumentChange) {
-						onDocumentChange()
+					if (app) {
+						const sessionState = app.getSessionState()
+						if (!sessionState.auth) throw Error('Auth not found')
+						const user = app.getUser(sessionState.auth.userId)
+						if (!user) throw Error('User not found')
+						app.onFileEdit(user.id, fileId, sessionState.createdAt, fileStartTime)
 					}
+
+					onDocumentChange?.()
 				},
 				{ scope: 'document', source: 'user' }
 			)
@@ -177,6 +176,7 @@ export function TlaEditor({
 	)
 
 	useEffect(() => {
+		if (!app) return
 		const { auth } = app.getSessionState()
 		if (!auth) throw Error('Auth not found')
 
@@ -206,14 +206,18 @@ export function TlaEditor({
 		}
 	}, [app, fileId])
 
+	const store = useSync({
+		uri: `${MULTIPLAYER_SERVER}/app/file/${fileSlug}`,
+		assets: multiplayerAssetStore,
+	})
+
 	return (
 		<div className={styles.editor}>
 			<Tldraw
-				key={persistenceKey}
+				store={store}
 				assetUrls={assetUrls}
-				persistenceKey={persistenceKey}
 				onMount={handleMount}
-				overrides={[sharingUiOverrides, fileSystemUiOverrides]}
+				overrides={[sharingUiOverrides]}
 				onUiEvent={handleUiEvent}
 				components={components}
 			>
@@ -223,18 +227,19 @@ export function TlaEditor({
 				{/* <CursorChatBubble /> */}
 				<SneakyDarkModeSync />
 			</Tldraw>
-			{ready ? null : <div key={persistenceKey + 'overlay'} className={styles.overlay} />}
+			{ready ? null : <div key={fileId + 'overlay'} className={styles.overlay} />}
 		</div>
 	)
 }
 
 function SneakyDarkModeSync() {
-	const app = useApp()
+	const app = useMaybeApp()
 	const editor = useEditor()
 
 	useReactor(
 		'dark mode sync',
 		() => {
+			if (!app) return
 			const appIsDark =
 				app.store.unsafeGetWithoutCapture(TldrawApp.SessionStateId)!.theme === 'dark'
 			const editorIsDark = editor.user.getIsDarkMode()

commit 09f89a60f403ff704c1372eff9fecba6cd5ce361
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon Sep 30 16:27:45 2024 -0400

    [dotcom] Menus, dialogs, toasts, etc. (#4624)
    
    This PR brings tldraw's ui into the application layer: dialogs, menus,
    etc.
    
    It:
    - brings our dialogs to the application layer
    - brings our toasts to the application layer
    - brings our translations to the application layer
    - brings our assets to the application layer
    - creates a "file menu"
    - creates a "rename file" dialog
    - creates the UI for changing the title of a file in the header
    - adjusts some text sizes
    
    In order to do that, I've had to:
    - create a global `tlmenus` system for menus
    - create a global `tltime` system for timers
    - create a global `tlenv` for environment"
    - create a `useMaybeEditor` hook
    
    ### Change type
    
    - [x] `other`
    
    ### Release notes
    - exports dialogs system
    - exports toasts system
    - exports translations system
    - create a global `tlmenus` system for menus
    - create a global `tltime` system for timers
    - create a global `tlenv` for environment"
    - create a `useMaybeEditor` hook
    
    ---------
    
    Co-authored-by: Mitja Bezenšek <mitja.bezensek@gmail.com>

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index 3b3164cb3..72367dcb5 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -72,6 +72,7 @@ const components: TLComponents = {
 			<div className="tlui-menu-zone">
 				<div className="tlui-buttons__horizontal">
 					{MainMenu && <MainMenu />}
+					{PageMenu && <PageMenu />}
 					{breakpoint < 6 ? null : (
 						<>
 							{QuickActions && <QuickActions />}

commit 0ec64b2500006beb91eb78efa4b80e8b65c6cd7b
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Wed Oct 2 15:41:22 2024 +0100

    [botcom] Use auth on backend (#4639)
    
    This PR
    
    - Renames the socket endpoint `/app/:userId` to just `/app`, and uses
    the access token to get the user id from clerk
    - Uses the access token to gate 'owned' files.
    
    
    TO DO in follow ups
    - Allow shared files (will require asking the owner's DO for permission
    to establish a socket connection, and figuring out a way to revoke an
    already-established connection.
    - Add web hook to update a user's info if they change it on
    google/whatever.
    
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [x] `feature`
    - [ ] `api`
    - [ ] `other`

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index 72367dcb5..971ba07b0 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -33,6 +33,7 @@ import { multiplayerAssetStore } from '../../../utils/multiplayerAssetStore'
 import { useSharing } from '../../../utils/sharing'
 import { useHandleUiEvents } from '../../../utils/useHandleUiEvent'
 import { useMaybeApp } from '../../hooks/useAppState'
+import { useTldrawUser } from '../../hooks/useUser'
 import { TldrawApp } from '../../utils/TldrawApp'
 import styles from './editor.module.css'
 
@@ -124,9 +125,11 @@ const components: TLComponents = {
 export function TlaEditor({
 	fileSlug,
 	onDocumentChange,
+	temporary,
 }: {
 	fileSlug: string
 	onDocumentChange?(): void
+	temporary?: boolean
 }) {
 	const handleUiEvent = useHandleUiEvents()
 	const app = useMaybeApp()
@@ -207,8 +210,19 @@ export function TlaEditor({
 		}
 	}, [app, fileId])
 
+	const user = useTldrawUser()
+
 	const store = useSync({
-		uri: `${MULTIPLAYER_SERVER}/app/file/${fileSlug}`,
+		uri: useCallback(async () => {
+			const url = new URL(`${MULTIPLAYER_SERVER}/app/file/${fileSlug}`)
+			if (user) {
+				url.searchParams.set('accessToken', await user.getToken())
+			}
+			if (temporary) {
+				url.searchParams.set('temporary', 'true')
+			}
+			return url.toString()
+		}, [user, fileSlug, temporary]),
 		assets: multiplayerAssetStore,
 	})
 

commit 62046f6be902ded8cab9e77d2f135ef4ad771ae5
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Sat Oct 5 18:38:19 2024 +0100

    dotcom top bar / .tldr file drops (#4661)
    
    This PR adds a few somewhat random features to dotcom and tldraw:
    
    ### New botcom header
    
    This PR removes the header from botcom and places the title and page
    menu on the canvas. It adds a temporary menu that we can modify later to
    include other items from the menu. I'm actually tempted to bring back
    the help menu for some of these.
    
    ### .tldr frile dropping
    
    This PR adds support for dropping tldraw files onto the side menu,
    though it does not implement actual file uploading.
    
    ### Change type
    
    - [x] `internal`

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index 971ba07b0..51ec2dc45 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -6,22 +6,15 @@ import {
 	DefaultDebugMenuContent,
 	DefaultKeyboardShortcutsDialog,
 	DefaultKeyboardShortcutsDialogContent,
-	DefaultMainMenu,
-	EditSubmenu,
 	Editor,
-	ExportFileContentSubMenu,
-	ExtrasGroup,
-	PreferencesGroup,
 	TLComponents,
 	Tldraw,
-	ViewSubmenu,
-	useBreakpoint,
+	TldrawUiMenuGroup,
+	TldrawUiMenuItem,
+	useActions,
 	useEditor,
 	useReactor,
-	useTldrawUiComponents,
 } from 'tldraw'
-import { Links } from '../../../components/Links'
-import { SneakyOnDropOverride } from '../../../components/SneakyOnDropOverride'
 import { ThemeUpdater } from '../../../components/ThemeUpdater/ThemeUpdater'
 import { assetUrls } from '../../../utils/assetUrls'
 import { MULTIPLAYER_SERVER } from '../../../utils/config'
@@ -31,10 +24,14 @@ import { DebugMenuItems } from '../../../utils/migration/DebugMenuItems'
 import { LocalMigration } from '../../../utils/migration/LocalMigration'
 import { multiplayerAssetStore } from '../../../utils/multiplayerAssetStore'
 import { useSharing } from '../../../utils/sharing'
+import { SAVE_FILE_COPY_ACTION } from '../../../utils/useFileSystem'
 import { useHandleUiEvents } from '../../../utils/useHandleUiEvent'
-import { useMaybeApp } from '../../hooks/useAppState'
+import { useApp, useMaybeApp } from '../../hooks/useAppState'
+import { handleDroppedTldrawFiles } from '../../hooks/useTldrFileDrop'
 import { useTldrawUser } from '../../hooks/useUser'
 import { TldrawApp } from '../../utils/TldrawApp'
+import { TlaEditorTopLeftPanel } from './TlaEditorTopLeftPanel'
+import { TlaEditorTopRightPanel } from './TlaEditorTopRightPanel'
 import styles from './editor.module.css'
 
 // const shittyOfflineAtom = atom('shitty offline atom', false)
@@ -51,54 +48,23 @@ const components: TLComponents = {
 	// 		<Links />
 	// 	</DefaultHelpMenu>
 	// ),
-	MainMenu: () => (
-		<DefaultMainMenu>
-			{/* <MultiplayerFileMenu /> */}
-			<EditSubmenu />
-			<ViewSubmenu />
-			<ExportFileContentSubMenu />
-			<ExtrasGroup />
-			<PreferencesGroup />
-			<Links />
-		</DefaultMainMenu>
-	),
-	MenuPanel: function MenuPanel() {
-		const breakpoint = useBreakpoint()
-
-		const { MainMenu, QuickActions, ActionsMenu, PageMenu } = useTldrawUiComponents()
-
-		if (!MainMenu && !PageMenu && breakpoint < 6) return null
-
-		return (
-			<div className="tlui-menu-zone">
-				<div className="tlui-buttons__horizontal">
-					{MainMenu && <MainMenu />}
-					{PageMenu && <PageMenu />}
-					{breakpoint < 6 ? null : (
-						<>
-							{QuickActions && <QuickActions />}
-							{ActionsMenu && <ActionsMenu />}
-						</>
-					)}
-				</div>
-			</div>
-		)
-	},
 	KeyboardShortcutsDialog: (props) => {
-		// const actions = useActions()
+		const actions = useActions()
 		return (
 			<DefaultKeyboardShortcutsDialog {...props}>
-				{/* <TldrawUiMenuGroup label="shortcuts-dialog.file" id="file">
+				<TldrawUiMenuGroup label="shortcuts-dialog.file" id="file">
 					<TldrawUiMenuItem {...actions[SAVE_FILE_COPY_ACTION]} />
-					<TldrawUiMenuItem {...actions[OPEN_FILE_ACTION]} />
-				</TldrawUiMenuGroup> */}
+				</TldrawUiMenuGroup>
 				<DefaultKeyboardShortcutsDialogContent />
-				{/* <TldrawUiMenuGroup label="shortcuts-dialog.collaboration" id="collaboration">
-					<TldrawUiMenuItem {...actions[CURSOR_CHAT_ACTION]} />
-				</TldrawUiMenuGroup> */}
 			</DefaultKeyboardShortcutsDialog>
 		)
 	},
+	MenuPanel: () => {
+		return <TlaEditorTopLeftPanel />
+	},
+	SharePanel: () => {
+		return <TlaEditorTopRightPanel />
+	},
 	DebugMenu: () => {
 		return (
 			<DefaultDebugMenu>
@@ -111,15 +77,6 @@ const components: TLComponents = {
 	// 	const isOffline = useValue('offline', () => shittyOfflineAtom.get(), [])
 	// 	return <TlaDocumentTopZone isOffline={isOffline} />
 	// },
-	SharePanel: () => {
-		return null
-		// return (
-		// 	<div className="tlui-share-zone" draggable={false}>
-		// 		<PeopleMenu />
-		// 		<ShareMenu />
-		// 	</div>
-		// )
-	},
 }
 
 export function TlaEditor({
@@ -237,10 +194,10 @@ export function TlaEditor({
 				components={components}
 			>
 				<LocalMigration />
-				<SneakyOnDropOverride isMultiplayer={false} />
 				<ThemeUpdater />
 				{/* <CursorChatBubble /> */}
 				<SneakyDarkModeSync />
+				<SneakyTldrawFileDropHandler />
 			</Tldraw>
 			{ready ? null : <div key={fileId + 'overlay'} className={styles.overlay} />}
 		</div>
@@ -270,3 +227,23 @@ function SneakyDarkModeSync() {
 
 	return null
 }
+
+function SneakyTldrawFileDropHandler() {
+	const editor = useEditor()
+	const app = useApp()
+	useEffect(() => {
+		const defaultOnDrop = editor.externalContentHandlers['files']
+		editor.registerExternalContentHandler('files', async (content) => {
+			const { files } = content
+			const tldrawFiles = files.filter((file) => file.name.endsWith('.tldr'))
+			if (tldrawFiles.length > 0) {
+				const snapshots = await handleDroppedTldrawFiles(editor, tldrawFiles)
+				if (!snapshots.length) return
+				await app.createFilesFromTldrFiles(snapshots)
+			} else {
+				defaultOnDrop?.(content)
+			}
+		})
+	}, [editor, app])
+	return null
+}

commit 75b4994d67c3c9829be2bb0f640b09f1dad44918
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Sun Oct 6 17:55:59 2024 +0100

    [botcom] Pass through wheel events in menus (#4670)
    
    This PR adds the wheel passthrough events to the custom panels.
    
    ### Change type
    
    - [x] `other`

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index 51ec2dc45..70e1c8b93 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -27,7 +27,7 @@ import { useSharing } from '../../../utils/sharing'
 import { SAVE_FILE_COPY_ACTION } from '../../../utils/useFileSystem'
 import { useHandleUiEvents } from '../../../utils/useHandleUiEvent'
 import { useApp, useMaybeApp } from '../../hooks/useAppState'
-import { handleDroppedTldrawFiles } from '../../hooks/useTldrFileDrop'
+import { getSnapshotsFromDroppedTldrawFiles } from '../../hooks/useTldrFileDrop'
 import { useTldrawUser } from '../../hooks/useUser'
 import { TldrawApp } from '../../utils/TldrawApp'
 import { TlaEditorTopLeftPanel } from './TlaEditorTopLeftPanel'
@@ -192,6 +192,7 @@ export function TlaEditor({
 				overrides={[sharingUiOverrides]}
 				onUiEvent={handleUiEvent}
 				components={components}
+				options={{ actionShortcutsLocation: 'toolbar' }}
 			>
 				<LocalMigration />
 				<ThemeUpdater />
@@ -237,7 +238,7 @@ function SneakyTldrawFileDropHandler() {
 			const { files } = content
 			const tldrawFiles = files.filter((file) => file.name.endsWith('.tldr'))
 			if (tldrawFiles.length > 0) {
-				const snapshots = await handleDroppedTldrawFiles(editor, tldrawFiles)
+				const snapshots = await getSnapshotsFromDroppedTldrawFiles(editor, tldrawFiles)
 				if (!snapshots.length) return
 				await app.createFilesFromTldrFiles(snapshots)
 			} else {

commit 84aa63572c40dbe22ae2b1a457963fe098f76108
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon Oct 7 13:58:11 2024 +0100

    Fix logged out editor items (#4678)
    
    This PR fixes the bugs introduced by the editor components for logged
    out users. It moves some providers higher up.
    
    ### Change type
    
    - [x] `other`

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index 70e1c8b93..45c5e98ea 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -6,12 +6,17 @@ import {
 	DefaultDebugMenuContent,
 	DefaultKeyboardShortcutsDialog,
 	DefaultKeyboardShortcutsDialogContent,
+	DefaultMainMenu,
+	DefaultQuickActions,
+	DefaultQuickActionsContent,
 	Editor,
+	OfflineIndicator,
 	TLComponents,
 	Tldraw,
 	TldrawUiMenuGroup,
 	TldrawUiMenuItem,
 	useActions,
+	useCollaborationStatus,
 	useEditor,
 	useReactor,
 } from 'tldraw'
@@ -26,7 +31,7 @@ import { multiplayerAssetStore } from '../../../utils/multiplayerAssetStore'
 import { useSharing } from '../../../utils/sharing'
 import { SAVE_FILE_COPY_ACTION } from '../../../utils/useFileSystem'
 import { useHandleUiEvents } from '../../../utils/useHandleUiEvent'
-import { useApp, useMaybeApp } from '../../hooks/useAppState'
+import { useMaybeApp } from '../../hooks/useAppState'
 import { getSnapshotsFromDroppedTldrawFiles } from '../../hooks/useTldrFileDrop'
 import { useTldrawUser } from '../../hooks/useUser'
 import { TldrawApp } from '../../utils/TldrawApp'
@@ -34,20 +39,10 @@ import { TlaEditorTopLeftPanel } from './TlaEditorTopLeftPanel'
 import { TlaEditorTopRightPanel } from './TlaEditorTopRightPanel'
 import styles from './editor.module.css'
 
-// const shittyOfflineAtom = atom('shitty offline atom', false)
-
 const components: TLComponents = {
 	ErrorFallback: ({ error }) => {
 		throw error
 	},
-	// HelpMenu: () => (
-	// 	<DefaultHelpMenu>
-	// 		<TldrawUiMenuGroup id="help">
-	// 			<DefaultHelpMenuContent />
-	// 		</TldrawUiMenuGroup>
-	// 		<Links />
-	// 	</DefaultHelpMenu>
-	// ),
 	KeyboardShortcutsDialog: (props) => {
 		const actions = useActions()
 		return (
@@ -63,6 +58,8 @@ const components: TLComponents = {
 		return <TlaEditorTopLeftPanel />
 	},
 	SharePanel: () => {
+		const app = useMaybeApp()
+		if (!app) return null
 		return <TlaEditorTopRightPanel />
 	},
 	DebugMenu: () => {
@@ -73,10 +70,19 @@ const components: TLComponents = {
 			</DefaultDebugMenu>
 		)
 	},
-	// TopPanel: () => {
-	// 	const isOffline = useValue('offline', () => shittyOfflineAtom.get(), [])
-	// 	return <TlaDocumentTopZone isOffline={isOffline} />
-	// },
+	TopPanel: () => {
+		const collaborationStatus = useCollaborationStatus()
+		if (collaborationStatus === 'offline') return null
+		return <OfflineIndicator />
+	},
+	QuickActions: () => {
+		return (
+			<DefaultQuickActions>
+				<DefaultMainMenu />
+				<DefaultQuickActionsContent />
+			</DefaultQuickActions>
+		)
+	},
 }
 
 export function TlaEditor({
@@ -231,8 +237,9 @@ function SneakyDarkModeSync() {
 
 function SneakyTldrawFileDropHandler() {
 	const editor = useEditor()
-	const app = useApp()
+	const app = useMaybeApp()
 	useEffect(() => {
+		if (!app) return
 		const defaultOnDrop = editor.externalContentHandlers['files']
 		editor.registerExternalContentHandler('files', async (content) => {
 			const { files } = content

commit 4b3e740c65ad05491a445e9a5ef58079ca8adc8d
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon Oct 7 14:26:14 2024 +0100

    [botcom] Move file update handler, remove tldrawApp.currentEditor (#4679)
    
    This PR cleans up the TlaEditor file a bit, removing the `currentEditor`
    and some other unused code.
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [x] `other`

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index 45c5e98ea..44307ac78 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -1,6 +1,6 @@
-import { TldrawAppFileRecordType } from '@tldraw/dotcom-shared'
+import { TldrawAppFileId, TldrawAppFileRecordType } from '@tldraw/dotcom-shared'
 import { useSync } from '@tldraw/sync'
-import { useCallback, useEffect, useRef, useState } from 'react'
+import { useCallback, useEffect, useState } from 'react'
 import {
 	DefaultDebugMenu,
 	DefaultDebugMenuContent,
@@ -15,6 +15,7 @@ import {
 	Tldraw,
 	TldrawUiMenuGroup,
 	TldrawUiMenuItem,
+	tltime,
 	useActions,
 	useCollaborationStatus,
 	useEditor,
@@ -28,10 +29,9 @@ import { globalEditor } from '../../../utils/globalEditor'
 import { DebugMenuItems } from '../../../utils/migration/DebugMenuItems'
 import { LocalMigration } from '../../../utils/migration/LocalMigration'
 import { multiplayerAssetStore } from '../../../utils/multiplayerAssetStore'
-import { useSharing } from '../../../utils/sharing'
 import { SAVE_FILE_COPY_ACTION } from '../../../utils/useFileSystem'
 import { useHandleUiEvents } from '../../../utils/useHandleUiEvent'
-import { useMaybeApp } from '../../hooks/useAppState'
+import { useApp, useMaybeApp } from '../../hooks/useAppState'
 import { getSnapshotsFromDroppedTldrawFiles } from '../../hooks/useTldrFileDrop'
 import { useTldrawUser } from '../../hooks/useUser'
 import { TldrawApp } from '../../utils/TldrawApp'
@@ -98,70 +98,45 @@ export function TlaEditor({
 	const app = useMaybeApp()
 
 	const [ready, setReady] = useState(false)
-	const fileId = TldrawAppFileRecordType.createId(fileSlug)
-
-	const rPrevFileId = useRef(fileId)
-	useEffect(() => {
-		if (rPrevFileId.current !== fileId) {
-			setReady(false)
-			rPrevFileId.current = fileId
-		}
-	}, [fileId])
-
-	const sharingUiOverrides = useSharing()
 
-	const handleMount = useCallback(
-		(editor: Editor) => {
-			;(window as any).app = editor
-			;(window as any).editor = editor
-			globalEditor.set(editor)
-			editor.registerExternalAssetHandler('url', createAssetFromUrl)
-			app?.setCurrentEditor(editor)
-			editor.timers.setTimeout(() => {
-				setReady(true)
-			}, 200)
+	const fileId = TldrawAppFileRecordType.createId(fileSlug)
 
-			const fileStartTime = Date.now()
+	const handleMount = useCallback((editor: Editor) => {
+		;(window as any).app = editor
+		;(window as any).editor = editor
+		// Register the editor globally
+		globalEditor.set(editor)
 
-			editor.store.listen(
-				() => {
-					// Update the user's edited session date for this file
-					if (app) {
-						const sessionState = app.getSessionState()
-						if (!sessionState.auth) throw Error('Auth not found')
-						const user = app.getUser(sessionState.auth.userId)
-						if (!user) throw Error('User not found')
-						app.onFileEdit(user.id, fileId, sessionState.createdAt, fileStartTime)
-					}
+		// Register the external asset handler
+		editor.registerExternalAssetHandler('url', createAssetFromUrl)
 
-					onDocumentChange?.()
-				},
-				{ scope: 'document', source: 'user' }
-			)
-		},
-		[app, onDocumentChange, fileId]
-	)
+		// Set the editor to ready after a short delay
+		editor.timers.setTimeout(() => setReady(true), 200)
+	}, [])
 
+	// Handle entering and exiting the file
 	useEffect(() => {
 		if (!app) return
+
 		const { auth } = app.getSessionState()
 		if (!auth) throw Error('Auth not found')
 
 		const user = app.getUser(auth.userId)
 		if (!user) throw Error('User not found')
 
-		if (user.presence.fileIds.includes(fileId)) {
-			return
-		}
-
 		let cancelled = false
 		let didEnter = false
 
-		const timeout = setTimeout(() => {
-			if (cancelled) return
-			didEnter = true
-			app.onFileEnter(auth.userId, fileId)
-		}, 1000)
+		// Only mark as entered after one second
+		const timeout = tltime.setTimeout(
+			'app',
+			() => {
+				if (cancelled) return
+				didEnter = true
+				app.onFileEnter(auth.userId, fileId)
+			},
+			1000
+		)
 
 		return () => {
 			cancelled = true
@@ -195,7 +170,6 @@ export function TlaEditor({
 				store={store}
 				assetUrls={assetUrls}
 				onMount={handleMount}
-				overrides={[sharingUiOverrides]}
 				onUiEvent={handleUiEvent}
 				components={components}
 				options={{ actionShortcutsLocation: 'toolbar' }}
@@ -205,6 +179,7 @@ export function TlaEditor({
 				{/* <CursorChatBubble /> */}
 				<SneakyDarkModeSync />
 				<SneakyTldrawFileDropHandler />
+				<SneakyFileUpdateHandler fileId={fileId} onDocumentChange={onDocumentChange} />
 			</Tldraw>
 			{ready ? null : <div key={fileId + 'overlay'} className={styles.overlay} />}
 		</div>
@@ -255,3 +230,31 @@ function SneakyTldrawFileDropHandler() {
 	}, [editor, app])
 	return null
 }
+
+function SneakyFileUpdateHandler({
+	onDocumentChange,
+	fileId,
+}: {
+	onDocumentChange?(): void
+	fileId: TldrawAppFileId
+}) {
+	const app = useApp()
+	const editor = useEditor()
+	useEffect(() => {
+		const fileStartTime = Date.now()
+		return editor.store.listen(
+			() => {
+				if (!app) return
+				const sessionState = app.getSessionState()
+				if (!sessionState.auth) throw Error('Auth not found')
+				const user = app.getUser(sessionState.auth.userId)
+				if (!user) throw Error('User not found')
+				app.onFileEdit(user.id, fileId, sessionState.createdAt, fileStartTime)
+				onDocumentChange?.()
+			},
+			{ scope: 'document', source: 'user' }
+		)
+	}, [app, onDocumentChange, fileId, editor])
+
+	return null
+}

commit 1879c3a4b41529bb6b42992410ec5cf0ba3b6492
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon Oct 7 14:50:16 2024 +0100

    [botcom] one last logged out fix (#4680)
    
    This PR fixes a logged-out error that snuck through.
    
    ### Change type
    
    - [x] `other`

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index 44307ac78..be663ce53 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -31,7 +31,7 @@ import { LocalMigration } from '../../../utils/migration/LocalMigration'
 import { multiplayerAssetStore } from '../../../utils/multiplayerAssetStore'
 import { SAVE_FILE_COPY_ACTION } from '../../../utils/useFileSystem'
 import { useHandleUiEvents } from '../../../utils/useHandleUiEvent'
-import { useApp, useMaybeApp } from '../../hooks/useAppState'
+import { useMaybeApp } from '../../hooks/useAppState'
 import { getSnapshotsFromDroppedTldrawFiles } from '../../hooks/useTldrFileDrop'
 import { useTldrawUser } from '../../hooks/useUser'
 import { TldrawApp } from '../../utils/TldrawApp'
@@ -238,7 +238,7 @@ function SneakyFileUpdateHandler({
 	onDocumentChange?(): void
 	fileId: TldrawAppFileId
 }) {
-	const app = useApp()
+	const app = useMaybeApp()
 	const editor = useEditor()
 	useEffect(() => {
 		const fileStartTime = Date.now()

commit 3a3d6c5de857260bb5dc7c8ba493172f507a9b3a
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Tue Oct 8 13:08:54 2024 +0100

    [botcom] sharing (#4654)
    
    This PR adds initial support for sharing.
    
    - Using the file's `shared` flag to gate access to guests
    https://github.com/tldraw/tldraw/blob/1879c3a4b41529bb6b42992410ec5cf0ba3b6492/packages/dotcom-shared/src/tla-schema/TldrawAppFile.ts#L16
    - Kicking guests out of the room if the `shared` flips from `true` to
    `false`
    - Allow guests to not be logged in
    - Changing between readonly and readwrite changes the UI and editor mode
    on guests' machines.
    - Simplified routing
      - `/q/local` -> `/q`
      - Remove defunct redirect pages
    - Renamed `'temporary'` flag to `'isCreateMode'` and use it to fix the
    race condition when creating new rooms
    - (temporary fix) allow guests to see the document's file name
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [x] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Test plan
    
    1. Create a shape...
    2.
    
    - [ ] Unit tests
    - [ ] End to end tests
    
    ### Release notes
    
    - Fixed a bug with…
    
    ---------
    
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index be663ce53..bf362392d 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -1,6 +1,6 @@
 import { TldrawAppFileId, TldrawAppFileRecordType } from '@tldraw/dotcom-shared'
 import { useSync } from '@tldraw/sync'
-import { useCallback, useEffect, useState } from 'react'
+import { useCallback, useEffect, useLayoutEffect, useState } from 'react'
 import {
 	DefaultDebugMenu,
 	DefaultDebugMenuContent,
@@ -88,11 +88,11 @@ const components: TLComponents = {
 export function TlaEditor({
 	fileSlug,
 	onDocumentChange,
-	temporary,
+	isCreateMode,
 }: {
 	fileSlug: string
 	onDocumentChange?(): void
-	temporary?: boolean
+	isCreateMode?: boolean
 }) {
 	const handleUiEvent = useHandleUiEvents()
 	const app = useMaybeApp()
@@ -101,6 +101,15 @@ export function TlaEditor({
 
 	const fileId = TldrawAppFileRecordType.createId(fileSlug)
 
+	useLayoutEffect(() => {
+		setReady(false)
+		// Set the editor to ready after a short delay
+		const timeout = setTimeout(() => setReady(true), 200)
+		return () => {
+			clearTimeout(timeout)
+		}
+	}, [fileId])
+
 	const handleMount = useCallback((editor: Editor) => {
 		;(window as any).app = editor
 		;(window as any).editor = editor
@@ -109,9 +118,6 @@ export function TlaEditor({
 
 		// Register the external asset handler
 		editor.registerExternalAssetHandler('url', createAssetFromUrl)
-
-		// Set the editor to ready after a short delay
-		editor.timers.setTimeout(() => setReady(true), 200)
 	}, [])
 
 	// Handle entering and exiting the file
@@ -156,11 +162,11 @@ export function TlaEditor({
 			if (user) {
 				url.searchParams.set('accessToken', await user.getToken())
 			}
-			if (temporary) {
-				url.searchParams.set('temporary', 'true')
+			if (isCreateMode) {
+				url.searchParams.set('isCreateMode', 'true')
 			}
 			return url.toString()
-		}, [user, fileSlug, temporary]),
+		}, [user, fileSlug, isCreateMode]),
 		assets: multiplayerAssetStore,
 	})
 

commit de6f6867ce6005d8e7a75c6dd85fdd681e1db5d1
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Thu Oct 10 14:51:55 2024 +0100

    Remove v1 migration from dotcom (#4693)
    
    This PR removes v1 migration from dotcom. It's been over 18 months, if
    for some reason someone has important tldraw content on tldraw.com that
    they haven't accessed since then, then we can point them to an earlier
    preview branch to rescue it. But I would be very surprised if this case
    actually still exists!
    
    ### Change type
    
    - [x] `other`

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index bf362392d..fe809fdb8 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -2,8 +2,6 @@ import { TldrawAppFileId, TldrawAppFileRecordType } from '@tldraw/dotcom-shared'
 import { useSync } from '@tldraw/sync'
 import { useCallback, useEffect, useLayoutEffect, useState } from 'react'
 import {
-	DefaultDebugMenu,
-	DefaultDebugMenuContent,
 	DefaultKeyboardShortcutsDialog,
 	DefaultKeyboardShortcutsDialogContent,
 	DefaultMainMenu,
@@ -26,8 +24,6 @@ import { assetUrls } from '../../../utils/assetUrls'
 import { MULTIPLAYER_SERVER } from '../../../utils/config'
 import { createAssetFromUrl } from '../../../utils/createAssetFromUrl'
 import { globalEditor } from '../../../utils/globalEditor'
-import { DebugMenuItems } from '../../../utils/migration/DebugMenuItems'
-import { LocalMigration } from '../../../utils/migration/LocalMigration'
 import { multiplayerAssetStore } from '../../../utils/multiplayerAssetStore'
 import { SAVE_FILE_COPY_ACTION } from '../../../utils/useFileSystem'
 import { useHandleUiEvents } from '../../../utils/useHandleUiEvent'
@@ -62,14 +58,6 @@ const components: TLComponents = {
 		if (!app) return null
 		return <TlaEditorTopRightPanel />
 	},
-	DebugMenu: () => {
-		return (
-			<DefaultDebugMenu>
-				<DefaultDebugMenuContent />
-				<DebugMenuItems />
-			</DefaultDebugMenu>
-		)
-	},
 	TopPanel: () => {
 		const collaborationStatus = useCollaborationStatus()
 		if (collaborationStatus === 'offline') return null
@@ -180,7 +168,6 @@ export function TlaEditor({
 				components={components}
 				options={{ actionShortcutsLocation: 'toolbar' }}
 			>
-				<LocalMigration />
 				<ThemeUpdater />
 				{/* <CursorChatBubble /> */}
 				<SneakyDarkModeSync />

commit 576b3822cbbffd984f49fa239d621bacea3cf7e4
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Sun Oct 20 16:37:08 2024 +0100

    [botcom] local session state, logged out view of files (#4711)
    
    This PR implements a few changes inspired by the instantdb branch.
    
    ## Providers
    
    I've flattened the component tree for react context providers in
    `TlaProviders`, which were getting complex. This should make it easier
    in the future to do clean diffs as we adjust providers. I started it,
    but we should avoid having too many components that return other
    wrappers and providers in this file.
    
    ## Local session state
    
    The `TldrawAppSessionsState` is ignored. I have not removed it from the
    schema, as I don't want to handle that right now, but we no longer read
    it or update it. Instead, we keep a local atom that tracks data that was
    previously in the session record: ie sidebars, theme, auth user id, etc.
    
    ## Removing dependencies on `app`
    
    The change to `localSessionStorage` removes several places where we
    depended on the `app`, as well as all of the places where we updated it.
    
    ## Offline preferences for export settings
    
    Export settings are currently sitting on the `TldrawAppUser` record. In
    this PR, they also are at `localSessionStorage.exportSetttings` as a
    backup for signed-out users.
    
    ## Offline editor changes
    
    When visiting a file while logged out, the editor now displays the
    `AnonLayout`, i.e. a framing around the editor.
    
    
    ![image](https://github.com/user-attachments/assets/9c607fac-a376-412a-afe2-c93c971d58ef)
    
    ### People menu
    
    When visiting another user's file while logged out, I've included the
    `PeopleMenu` in a location next to the Style Panel.
    
    
    ![image](https://github.com/user-attachments/assets/d173d4d3-1ce6-4144-beb0-b47ec922eae8)
    
    ### Export menu
    
    For logged out users, I've (perhaps temporarily) replaced the toggle
    sidebar button with a button that opens an export menu.
    
    
    ![image](https://github.com/user-attachments/assets/f6ae4856-9377-4acb-928c-ed8558b155b8)
    
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [x] `other`

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index fe809fdb8..e9bd035e8 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -1,14 +1,17 @@
 import { TldrawAppFileId, TldrawAppFileRecordType } from '@tldraw/dotcom-shared'
 import { useSync } from '@tldraw/sync'
 import { useCallback, useEffect, useLayoutEffect, useState } from 'react'
+import { useParams } from 'react-router-dom'
 import {
 	DefaultKeyboardShortcutsDialog,
 	DefaultKeyboardShortcutsDialogContent,
 	DefaultMainMenu,
 	DefaultQuickActions,
 	DefaultQuickActionsContent,
+	DefaultStylePanel,
 	Editor,
 	OfflineIndicator,
+	PeopleMenu,
 	TLComponents,
 	Tldraw,
 	TldrawUiMenuGroup,
@@ -30,7 +33,11 @@ import { useHandleUiEvents } from '../../../utils/useHandleUiEvent'
 import { useMaybeApp } from '../../hooks/useAppState'
 import { getSnapshotsFromDroppedTldrawFiles } from '../../hooks/useTldrFileDrop'
 import { useTldrawUser } from '../../hooks/useUser'
-import { TldrawApp } from '../../utils/TldrawApp'
+import {
+	getLocalSessionState,
+	getLocalSessionStateUnsafe,
+	updateLocalSessionState,
+} from '../../utils/local-session-state'
 import { TlaEditorTopLeftPanel } from './TlaEditorTopLeftPanel'
 import { TlaEditorTopRightPanel } from './TlaEditorTopRightPanel'
 import styles from './editor.module.css'
@@ -51,11 +58,10 @@ const components: TLComponents = {
 		)
 	},
 	MenuPanel: () => {
-		return <TlaEditorTopLeftPanel />
+		const app = useMaybeApp()
+		return <TlaEditorTopLeftPanel isAnonUser={!app} />
 	},
 	SharePanel: () => {
-		const app = useMaybeApp()
-		if (!app) return null
 		return <TlaEditorTopRightPanel />
 	},
 	TopPanel: () => {
@@ -73,6 +79,24 @@ const components: TLComponents = {
 	},
 }
 
+const anonComponents = {
+	...components,
+	SharePanel: null,
+	StylePanel: () => {
+		// When on a temporary file, we don't want to show the people menu or file share menu, just the regular style panel
+		const { fileSlug } = useParams()
+		if (!fileSlug) return <DefaultStylePanel />
+
+		// ...but when an anonymous user is on a shared file, we do want to show the people menu next to the style panel
+		return (
+			<div className={styles.anonStylePanel}>
+				<PeopleMenu />
+				<DefaultStylePanel />
+			</div>
+		)
+	},
+}
+
 export function TlaEditor({
 	fileSlug,
 	onDocumentChange,
@@ -112,7 +136,7 @@ export function TlaEditor({
 	useEffect(() => {
 		if (!app) return
 
-		const { auth } = app.getSessionState()
+		const { auth } = getLocalSessionState()
 		if (!auth) throw Error('Auth not found')
 
 		const user = app.getUser(auth.userId)
@@ -165,7 +189,7 @@ export function TlaEditor({
 				assetUrls={assetUrls}
 				onMount={handleMount}
 				onUiEvent={handleUiEvent}
-				components={components}
+				components={!app ? anonComponents : components}
 				options={{ actionShortcutsLocation: 'toolbar' }}
 			>
 				<ThemeUpdater />
@@ -187,14 +211,13 @@ function SneakyDarkModeSync() {
 		'dark mode sync',
 		() => {
 			if (!app) return
-			const appIsDark =
-				app.store.unsafeGetWithoutCapture(TldrawApp.SessionStateId)!.theme === 'dark'
+			const appIsDark = getLocalSessionStateUnsafe()!.theme === 'dark'
 			const editorIsDark = editor.user.getIsDarkMode()
 
 			if (appIsDark && !editorIsDark) {
-				app.setSessionState({ ...app.getSessionState(), theme: 'light' })
+				updateLocalSessionState(() => ({ theme: 'light' }))
 			} else if (!appIsDark && editorIsDark) {
-				app.setSessionState({ ...app.getSessionState(), theme: 'dark' })
+				updateLocalSessionState(() => ({ theme: 'dark' }))
 			}
 		},
 		[app, editor]
@@ -238,7 +261,7 @@ function SneakyFileUpdateHandler({
 		return editor.store.listen(
 			() => {
 				if (!app) return
-				const sessionState = app.getSessionState()
+				const sessionState = getLocalSessionState()
 				if (!sessionState.auth) throw Error('Auth not found')
 				const user = app.getUser(sessionState.auth.userId)
 				if (!user) throw Error('User not found')

commit 68920e553386fa757a071fb051929f7e7e4e12d6
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Sun Oct 20 19:20:27 2024 +0100

    [botcom] use single DurableObject for whole app (#4698)
    
    This PR moves the backend to a single DO.
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [x] `other`
    
    ---------
    
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index e9bd035e8..3f8f55f09 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -151,7 +151,7 @@ export function TlaEditor({
 			() => {
 				if (cancelled) return
 				didEnter = true
-				app.onFileEnter(auth.userId, fileId)
+				app.onFileEnter(fileId)
 			},
 			1000
 		)
@@ -161,7 +161,7 @@ export function TlaEditor({
 			clearTimeout(timeout)
 
 			if (didEnter) {
-				app.onFileExit(auth.userId, fileId)
+				app.onFileExit(fileId)
 			}
 		}
 	}, [app, fileId])
@@ -263,9 +263,7 @@ function SneakyFileUpdateHandler({
 				if (!app) return
 				const sessionState = getLocalSessionState()
 				if (!sessionState.auth) throw Error('Auth not found')
-				const user = app.getUser(sessionState.auth.userId)
-				if (!user) throw Error('User not found')
-				app.onFileEdit(user.id, fileId, sessionState.createdAt, fileStartTime)
+				app.onFileEdit(fileId, sessionState.createdAt, fileStartTime)
 				onDocumentChange?.()
 			},
 			{ scope: 'document', source: 'user' }

commit 9894eb43b99ee673f0d42cd4a7069c83865ded7d
Author: Mime Čuvalo <mimecuvalo@gmail.com>
Date:   Mon Oct 21 14:26:32 2024 +0100

    botcom: account menu [bk] (#4683)
    
    [bk=burger king, as Alex says] kinda funky b/c i'm doing these
    MaybeProviders in `TlaRootProviders.tsx`. but it does work. lemme know
    what you think — we can rework from here.
    
    <img width="708" alt="Screenshot 2024-10-07 at 22 12 33"
    src="https://github.com/user-attachments/assets/554be50a-1842-4659-adff-dfed8fc4e0a5">
    
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [x] `other`

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index 3f8f55f09..25c3794e7 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -9,13 +9,17 @@ import {
 	DefaultQuickActions,
 	DefaultQuickActionsContent,
 	DefaultStylePanel,
+	EditSubmenu,
 	Editor,
+	ExportFileContentSubMenu,
+	ExtrasGroup,
 	OfflineIndicator,
 	PeopleMenu,
 	TLComponents,
 	Tldraw,
 	TldrawUiMenuGroup,
 	TldrawUiMenuItem,
+	ViewSubmenu,
 	tltime,
 	useActions,
 	useCollaborationStatus,
@@ -42,7 +46,8 @@ import { TlaEditorTopLeftPanel } from './TlaEditorTopLeftPanel'
 import { TlaEditorTopRightPanel } from './TlaEditorTopRightPanel'
 import styles from './editor.module.css'
 
-const components: TLComponents = {
+/** @internal */
+export const components: TLComponents = {
 	ErrorFallback: ({ error }) => {
 		throw error
 	},
@@ -72,7 +77,12 @@ const components: TLComponents = {
 	QuickActions: () => {
 		return (
 			<DefaultQuickActions>
-				<DefaultMainMenu />
+				<DefaultMainMenu>
+					<EditSubmenu />
+					<ViewSubmenu />
+					<ExportFileContentSubMenu />
+					<ExtrasGroup />
+				</DefaultMainMenu>
 				<DefaultQuickActionsContent />
 			</DefaultQuickActions>
 		)
@@ -146,6 +156,7 @@ export function TlaEditor({
 		let didEnter = false
 
 		// Only mark as entered after one second
+		// TODO TODO but why though...? b/c it's trying to create the file?
 		const timeout = tltime.setTimeout(
 			'app',
 			() => {
@@ -187,6 +198,7 @@ export function TlaEditor({
 			<Tldraw
 				store={store}
 				assetUrls={assetUrls}
+				user={app?.tlUser}
 				onMount={handleMount}
 				onUiEvent={handleUiEvent}
 				components={!app ? anonComponents : components}

commit 42812e6141b09480393c2d48c017abf33af09b93
Author: Mitja Bezenšek <mitja.bezensek@gmail.com>
Date:   Wed Oct 23 17:31:53 2024 +0200

    [botcom] Publishing (#4688)
    
    Adds publishing to botcom.
    
    This allows the users to publish the existing document. This is a point
    in time snapshot, which they can then update or delete at a later time.
    Only the owner of the file has the permission to do that, while everyone
    with a link can view the published document.
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [x] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Release notes
    
    - Add publishing to botcom.
    
    ---------
    
    Co-authored-by: David Sheldrick <d.j.sheldrick@gmail.com>
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index 25c3794e7..668f24227 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -24,7 +24,6 @@ import {
 	useActions,
 	useCollaborationStatus,
 	useEditor,
-	useReactor,
 } from 'tldraw'
 import { ThemeUpdater } from '../../../components/ThemeUpdater/ThemeUpdater'
 import { assetUrls } from '../../../utils/assetUrls'
@@ -37,11 +36,8 @@ import { useHandleUiEvents } from '../../../utils/useHandleUiEvent'
 import { useMaybeApp } from '../../hooks/useAppState'
 import { getSnapshotsFromDroppedTldrawFiles } from '../../hooks/useTldrFileDrop'
 import { useTldrawUser } from '../../hooks/useUser'
-import {
-	getLocalSessionState,
-	getLocalSessionStateUnsafe,
-	updateLocalSessionState,
-} from '../../utils/local-session-state'
+import { getLocalSessionState } from '../../utils/local-session-state'
+import { SneakyDarkModeSync } from './SneakyDarkModeSync'
 import { TlaEditorTopLeftPanel } from './TlaEditorTopLeftPanel'
 import { TlaEditorTopRightPanel } from './TlaEditorTopRightPanel'
 import styles from './editor.module.css'
@@ -215,29 +211,6 @@ export function TlaEditor({
 	)
 }
 
-function SneakyDarkModeSync() {
-	const app = useMaybeApp()
-	const editor = useEditor()
-
-	useReactor(
-		'dark mode sync',
-		() => {
-			if (!app) return
-			const appIsDark = getLocalSessionStateUnsafe()!.theme === 'dark'
-			const editorIsDark = editor.user.getIsDarkMode()
-
-			if (appIsDark && !editorIsDark) {
-				updateLocalSessionState(() => ({ theme: 'light' }))
-			} else if (!appIsDark && editorIsDark) {
-				updateLocalSessionState(() => ({ theme: 'dark' }))
-			}
-		},
-		[app, editor]
-	)
-
-	return null
-}
-
 function SneakyTldrawFileDropHandler() {
 	const editor = useEditor()
 	const app = useMaybeApp()

commit 8123e95b7fd9b66fb14fa3160134069e9e98edbc
Author: Mime Čuvalo <mimecuvalo@gmail.com>
Date:   Thu Oct 24 12:36:29 2024 +0100

    botcom: alternative to multi-menu items (#4764)
    
    We talked today about an alternative to the multi-menu options, an
    alternative to this PR https://github.com/tldraw/tldraw/pull/4699 .
    Instead of the hamburger menu being a QuickActions area, that we could
    combine it with the vertical dot menu at the top, like so:
    
    <img width="546" alt="Screenshot 2024-10-23 at 17 40 10"
    src="https://github.com/user-attachments/assets/045e5af8-0b75-4346-b6b8-43d9bfb2582e">
    
    This might be a good compromise of the two worlds.
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [x] `other`

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index 668f24227..01710b447 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -5,21 +5,14 @@ import { useParams } from 'react-router-dom'
 import {
 	DefaultKeyboardShortcutsDialog,
 	DefaultKeyboardShortcutsDialogContent,
-	DefaultMainMenu,
-	DefaultQuickActions,
-	DefaultQuickActionsContent,
 	DefaultStylePanel,
-	EditSubmenu,
 	Editor,
-	ExportFileContentSubMenu,
-	ExtrasGroup,
 	OfflineIndicator,
 	PeopleMenu,
 	TLComponents,
 	Tldraw,
 	TldrawUiMenuGroup,
 	TldrawUiMenuItem,
-	ViewSubmenu,
 	tltime,
 	useActions,
 	useCollaborationStatus,
@@ -70,19 +63,6 @@ export const components: TLComponents = {
 		if (collaborationStatus === 'offline') return null
 		return <OfflineIndicator />
 	},
-	QuickActions: () => {
-		return (
-			<DefaultQuickActions>
-				<DefaultMainMenu>
-					<EditSubmenu />
-					<ViewSubmenu />
-					<ExportFileContentSubMenu />
-					<ExtrasGroup />
-				</DefaultMainMenu>
-				<DefaultQuickActionsContent />
-			</DefaultQuickActions>
-		)
-	},
 }
 
 const anonComponents = {

commit 99c63cefddd2d51c68fbbf79dd262ddd98da064b
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Thu Oct 24 14:36:36 2024 +0100

    [botcom] deep links (#4768)
    
    This PR sets up deep links for the file route, and makes the
    share/publish urls contain the deep links too.
    
    ### Change type
    
    - [x] `other`

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index 01710b447..c70af00a9 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -87,10 +87,12 @@ export function TlaEditor({
 	fileSlug,
 	onDocumentChange,
 	isCreateMode,
+	deepLinks,
 }: {
 	fileSlug: string
 	onDocumentChange?(): void
 	isCreateMode?: boolean
+	deepLinks?: boolean
 }) {
 	const handleUiEvent = useHandleUiEvents()
 	const app = useMaybeApp()
@@ -179,6 +181,7 @@ export function TlaEditor({
 				onUiEvent={handleUiEvent}
 				components={!app ? anonComponents : components}
 				options={{ actionShortcutsLocation: 'toolbar' }}
+				deepLinks={deepLinks || undefined}
 			>
 				<ThemeUpdater />
 				{/* <CursorChatBubble /> */}

commit 275d500ca9eba0c9da632344a094e1c5b82d7ad4
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Thu Oct 24 14:50:28 2024 +0100

    [botcom] file state (#4766)
    
    This PR
    
    - Replaces the file-edit and file-view records with a single record
    called `file-state` that has timestamps for first view and most recent
    edit.
    - Uses the above to simplify the recent files sorting (maintains the
    same behaviour, just achieves it with simpler code)
    - removes unused presence stuff (should have been removed back in that
    burn-it-all-down pr after we merged the prototype), we can add the UI
    bits back when we work on file-level presence.
    - Stores the UI state in the db so you go back to where you were before
    in the file next time you open the file
    
    implements INT-342
    
    ### Change type
    
    - [x] `other`

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index c70af00a9..5e42b6a0e 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -10,10 +10,13 @@ import {
 	OfflineIndicator,
 	PeopleMenu,
 	TLComponents,
+	TLSessionStateSnapshot,
 	Tldraw,
 	TldrawUiMenuGroup,
 	TldrawUiMenuItem,
-	tltime,
+	createSessionStateSnapshotSignal,
+	react,
+	throttle,
 	useActions,
 	useCollaborationStatus,
 	useEditor,
@@ -29,7 +32,6 @@ import { useHandleUiEvents } from '../../../utils/useHandleUiEvent'
 import { useMaybeApp } from '../../hooks/useAppState'
 import { getSnapshotsFromDroppedTldrawFiles } from '../../hooks/useTldrFileDrop'
 import { useTldrawUser } from '../../hooks/useUser'
-import { getLocalSessionState } from '../../utils/local-session-state'
 import { SneakyDarkModeSync } from './SneakyDarkModeSync'
 import { TlaEditorTopLeftPanel } from './TlaEditorTopLeftPanel'
 import { TlaEditorTopRightPanel } from './TlaEditorTopRightPanel'
@@ -110,50 +112,43 @@ export function TlaEditor({
 		}
 	}, [fileId])
 
-	const handleMount = useCallback((editor: Editor) => {
-		;(window as any).app = editor
-		;(window as any).editor = editor
-		// Register the editor globally
-		globalEditor.set(editor)
+	const handleMount = useCallback(
+		(editor: Editor) => {
+			;(window as any).app = app
+			;(window as any).editor = editor
+			// Register the editor globally
+			globalEditor.set(editor)
 
-		// Register the external asset handler
-		editor.registerExternalAssetHandler('url', createAssetFromUrl)
-	}, [])
+			// Register the external asset handler
+			editor.registerExternalAssetHandler('url', createAssetFromUrl)
 
-	// Handle entering and exiting the file
-	useEffect(() => {
-		if (!app) return
-
-		const { auth } = getLocalSessionState()
-		if (!auth) throw Error('Auth not found')
-
-		const user = app.getUser(auth.userId)
-		if (!user) throw Error('User not found')
-
-		let cancelled = false
-		let didEnter = false
-
-		// Only mark as entered after one second
-		// TODO TODO but why though...? b/c it's trying to create the file?
-		const timeout = tltime.setTimeout(
-			'app',
-			() => {
-				if (cancelled) return
-				didEnter = true
-				app.onFileEnter(fileId)
-			},
-			1000
-		)
-
-		return () => {
-			cancelled = true
-			clearTimeout(timeout)
-
-			if (didEnter) {
-				app.onFileExit(fileId)
+			if (!app) return
+			const fileState = app.getFileState(fileId)
+			if (fileState?.lastSessionState) {
+				editor.loadSnapshot({ session: fileState.lastSessionState })
 			}
-		}
-	}, [app, fileId])
+			const sessionState$ = createSessionStateSnapshotSignal(editor.store)
+			const updateSessionState = throttle((state: TLSessionStateSnapshot) => {
+				app.onFileSessionStateUpdate(fileId, state)
+			}, 500)
+			// don't want to update if they only open the file and didn't look around
+			let firstTime = true
+			const cleanup = react('update session state', () => {
+				const state = sessionState$.get()
+				if (!state) return
+				if (firstTime) {
+					firstTime = false
+					return
+				}
+				updateSessionState(state)
+			})
+			return () => {
+				cleanup()
+				updateSessionState.cancel()
+			}
+		},
+		[app, fileId]
+	)
 
 	const user = useTldrawUser()
 
@@ -171,6 +166,17 @@ export function TlaEditor({
 		assets: multiplayerAssetStore,
 	})
 
+	// Handle entering and exiting the file
+	useEffect(() => {
+		if (!app) return
+		if (store.status !== 'synced-remote') return
+
+		app.onFileEnter(fileId)
+		return () => {
+			app.onFileExit(fileId)
+		}
+	}, [app, fileId, store.status])
+
 	return (
 		<div className={styles.editor}>
 			<Tldraw
@@ -225,13 +231,10 @@ function SneakyFileUpdateHandler({
 	const app = useMaybeApp()
 	const editor = useEditor()
 	useEffect(() => {
-		const fileStartTime = Date.now()
 		return editor.store.listen(
 			() => {
 				if (!app) return
-				const sessionState = getLocalSessionState()
-				if (!sessionState.auth) throw Error('Auth not found')
-				app.onFileEdit(fileId, sessionState.createdAt, fileStartTime)
+				app.onFileEdit(fileId)
 				onDocumentChange?.()
 			},
 			{ scope: 'document', source: 'user' }

commit 63e868b81785007fd9371442fd084ed2535525a7
Author: Mitja Bezenšek <mitja.bezensek@gmail.com>
Date:   Fri Oct 25 15:53:13 2024 +0200

    e2e scaffolding (#4760)
    
    Adds e2e scaffolding (playwright):
    - Tests depend on `auth-setup` so the tests run as a signed in user by
    default. There's an example spec of showing how to test not logged in
    functionality.
    - These were a bit tricky to setup up, especially the sidebar toggle.
    Let's see if they'll be flaky 🤞
    - I created a separate `e2e-dotcom` environment, so that we can use
    development version of clerk api keys (other existing environments use
    the live ones). Clerk has some special dev mode features which allow for
    easier signing in during testing.
    - Also had some issues with `examples` `e2e` tests failing (bookmark
    exports on dark were failing). Seems like it was caused if I used
    playwright version 1.48, so I went back to 1.46. We might face this
    issue in the future.
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [x] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Release notes
    
    - e2e scaffolding for botcom.

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index 5e42b6a0e..40c3bf6e6 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -178,7 +178,7 @@ export function TlaEditor({
 	}, [app, fileId, store.status])
 
 	return (
-		<div className={styles.editor}>
+		<div className={styles.editor} data-testid="tla-editor">
 			<Tldraw
 				store={store}
 				assetUrls={assetUrls}

commit bc1a4d8c98f20460685fae3c28f34a630c9e2be7
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon Oct 28 14:11:39 2024 +0000

    [botcom] Duplicate / Publish / Create / Delete files on the server  (#4798)
    
    This PR improves and creates functionality on the backend.
    
    For the most part, simple changes such as creating a file or changing
    its name rely on optimistic updates. However, some actions rely on
    either sending information to the server directly. While we can make
    optimistic updates in these situations, we also need to revert those
    changes if the request fails.
    
    ## Duplicating files
    
    This PR adds duplication on the server. Previously, the duplicate
    feature required that the duplicating file be open, so duplicating other
    files (from the sidebar) would duplicate the current open file instead.
    Now the server will pull the latest file from the tldraw worker and
    duplicate that instead.
    
    If the user is viewing the duplicated page, we redirect them to the new
    page.
    
    ## Deleting / forgetting files
    
    This PR adds deletion on the server. If the user owns a file, they will
    optimistically delete the file and all states associated with the file;
    if the user does not, then they'll only "forget" the file by
    optimistically deleting all of their own states associated with the
    file. Meanwhile, the server will actually delete the file and the file's
    published snapshot. If the delete fails, the user's optimistic updates
    will be reversed.
    
    If the user is viewing the deleted / forgotten file, we redirect them to
    the root.
    
    ## Publishing / un-publishing files
    
    This PR adds publishing on the server. Previously, the user would upload
    the current editor state to the server. Now, the server pulls the latest
    file from the tldraw worker and creates a published snapshot based on
    that instead.
    
    I'd still like to build the "publish history" of versions that a user
    has published for a given file, rather than overwriting the single
    published snapshot file.
    
    ## Creating files
    
    This PR adds support for .tldr file drops. Files are created on the
    server and then added to the user's own files.
    
    ## Cleanup
    
    The sync-worker was getting pretty messy so I did some cleanup. Mostly,
    I've moved the endpoints that are related to the app to a `tla` folder,
    as I've done elsewhere. It wasn't clear to me which endpoints were
    "purely" working for the app layer and which weren't.
    
    ### Change type
    
    - [x] `other`
    
    ---------
    
    Co-authored-by: David Sheldrick <d.j.sheldrick@gmail.com>

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index 40c3bf6e6..84acf0703 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -1,3 +1,4 @@
+import { useAuth } from '@clerk/clerk-react'
 import { TldrawAppFileId, TldrawAppFileRecordType } from '@tldraw/dotcom-shared'
 import { useSync } from '@tldraw/sync'
 import { useCallback, useEffect, useLayoutEffect, useState } from 'react'
@@ -192,7 +193,7 @@ export function TlaEditor({
 				<ThemeUpdater />
 				{/* <CursorChatBubble /> */}
 				<SneakyDarkModeSync />
-				<SneakyTldrawFileDropHandler />
+				{app && <SneakyTldrawFileDropHandler />}
 				<SneakyFileUpdateHandler fileId={fileId} onDocumentChange={onDocumentChange} />
 			</Tldraw>
 			{ready ? null : <div key={fileId + 'overlay'} className={styles.overlay} />}
@@ -203,7 +204,9 @@ export function TlaEditor({
 function SneakyTldrawFileDropHandler() {
 	const editor = useEditor()
 	const app = useMaybeApp()
+	const auth = useAuth()
 	useEffect(() => {
+		if (!auth) return
 		if (!app) return
 		const defaultOnDrop = editor.externalContentHandlers['files']
 		editor.registerExternalContentHandler('files', async (content) => {
@@ -212,12 +215,14 @@ function SneakyTldrawFileDropHandler() {
 			if (tldrawFiles.length > 0) {
 				const snapshots = await getSnapshotsFromDroppedTldrawFiles(editor, tldrawFiles)
 				if (!snapshots.length) return
-				await app.createFilesFromTldrFiles(snapshots)
+				const token = await auth.getToken()
+				if (!token) return
+				await app.createFilesFromTldrFiles(snapshots, token)
 			} else {
 				defaultOnDrop?.(content)
 			}
 		})
-	}, [editor, app])
+	}, [editor, app, auth])
 	return null
 }
 

commit 573b60ce705d1dbc74441f87f7c6b4296385124b
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Mon Oct 28 15:41:40 2024 +0000

    [botcom] improve error UX (#4790)
    
    This PR makes it so that
    
    - if you visit a URL for a private file and you are signed out, you see
    this
    <img width="546" alt="image"
    src="https://github.com/user-attachments/assets/1cd546e2-6b95-478f-be8e-51166635de1c">
    Before this PR you'd be redirected immediately to a sign in page, which
    is disorienting and not necessarily what the user should have to do.
    - If you visit a URL for a private file and you are signed in, you see
    this.
    <img width="1137" alt="image"
    src="https://github.com/user-attachments/assets/39bd8f5c-ad31-4571-b923-be4a766d3e20">
    Before this PR you would see a flash of the sidebar and then it'd
    immediately disappear, after which you'd only see the error message with
    a 'return to tldraw' link that took you back to `/`.
    
    In order to achieve all this I had to do some minor refactorings which
    I'll write up on monday.
    
    
    
    ### Change type
    
    
    - [x] `other`

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index 84acf0703..d1d050fc8 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -1,7 +1,7 @@
 import { useAuth } from '@clerk/clerk-react'
 import { TldrawAppFileId, TldrawAppFileRecordType } from '@tldraw/dotcom-shared'
 import { useSync } from '@tldraw/sync'
-import { useCallback, useEffect, useLayoutEffect, useState } from 'react'
+import { useCallback, useEffect } from 'react'
 import { useParams } from 'react-router-dom'
 import {
 	DefaultKeyboardShortcutsDialog,
@@ -31,6 +31,7 @@ import { multiplayerAssetStore } from '../../../utils/multiplayerAssetStore'
 import { SAVE_FILE_COPY_ACTION } from '../../../utils/useFileSystem'
 import { useHandleUiEvents } from '../../../utils/useHandleUiEvent'
 import { useMaybeApp } from '../../hooks/useAppState'
+import { ReadyWrapper, useSetIsReady } from '../../hooks/useIsReady'
 import { getSnapshotsFromDroppedTldrawFiles } from '../../hooks/useTldrFileDrop'
 import { useTldrawUser } from '../../hooks/useUser'
 import { SneakyDarkModeSync } from './SneakyDarkModeSync'
@@ -86,32 +87,28 @@ const anonComponents = {
 	},
 }
 
-export function TlaEditor({
-	fileSlug,
-	onDocumentChange,
-	isCreateMode,
-	deepLinks,
-}: {
+interface TlaEditorProps {
 	fileSlug: string
 	onDocumentChange?(): void
 	isCreateMode?: boolean
 	deepLinks?: boolean
-}) {
+}
+export function TlaEditor(props: TlaEditorProps) {
+	// force re-mount when the file slug changes to prevent state from leaking between files
+	return (
+		<ReadyWrapper key={props.fileSlug}>
+			<TlaEditorInner {...props} key={props.fileSlug} />
+		</ReadyWrapper>
+	)
+}
+
+function TlaEditorInner({ fileSlug, onDocumentChange, isCreateMode, deepLinks }: TlaEditorProps) {
 	const handleUiEvent = useHandleUiEvents()
 	const app = useMaybeApp()
 
-	const [ready, setReady] = useState(false)
-
 	const fileId = TldrawAppFileRecordType.createId(fileSlug)
 
-	useLayoutEffect(() => {
-		setReady(false)
-		// Set the editor to ready after a short delay
-		const timeout = setTimeout(() => setReady(true), 200)
-		return () => {
-			clearTimeout(timeout)
-		}
-	}, [fileId])
+	const setIsReady = useSetIsReady()
 
 	const handleMount = useCallback(
 		(editor: Editor) => {
@@ -119,6 +116,7 @@ export function TlaEditor({
 			;(window as any).editor = editor
 			// Register the editor globally
 			globalEditor.set(editor)
+			setIsReady()
 
 			// Register the external asset handler
 			editor.registerExternalAssetHandler('url', createAssetFromUrl)
@@ -148,7 +146,7 @@ export function TlaEditor({
 				updateSessionState.cancel()
 			}
 		},
-		[app, fileId]
+		[app, fileId, setIsReady]
 	)
 
 	const user = useTldrawUser()
@@ -196,7 +194,6 @@ export function TlaEditor({
 				{app && <SneakyTldrawFileDropHandler />}
 				<SneakyFileUpdateHandler fileId={fileId} onDocumentChange={onDocumentChange} />
 			</Tldraw>
-			{ready ? null : <div key={fileId + 'overlay'} className={styles.overlay} />}
 		</div>
 	)
 }

commit d6246511b82c17ffe7c18333726ab865b82b0caf
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Tue Oct 29 11:21:34 2024 +0000

    [botcom] Fix double presence (#4819)
    
    The user thing wasn't hooked up to sync properly
    
    ### Change type
    
    - [x] `other`

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index d1d050fc8..6fbf6f2f8 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -163,6 +163,7 @@ function TlaEditorInner({ fileSlug, onDocumentChange, isCreateMode, deepLinks }:
 			return url.toString()
 		}, [user, fileSlug, isCreateMode]),
 		assets: multiplayerAssetStore,
+		userInfo: app?.tlUser.userPreferences,
 	})
 
 	// Handle entering and exiting the file

commit c23639118ad9c77d1574e25a2217c3b7bf9f70fb
Author: Mime Čuvalo <mimecuvalo@gmail.com>
Date:   Wed Oct 30 12:40:39 2024 +0000

    botcom: scaffolding for i18n (#4719)
    
    This starts rethinking our i18n story, at least at the botcom level.
    - introduces (brings back) `react-intl` which lets start doing more
    complex translations (being able to include HTML in sentences), do
    pluralization, time, etc.
    - adds a i18n middle layer to auto-generate ID's based on their hash,
    otherwise annoying to do this.
    - you can see the different uses, there is the `<F>` tag for translated
    React items
    - in other cases, you use `defineMessages`/`formatMessage` for things
    like alt/aria-labels/tooltips.
    - adds some hidden languages like "accented" to show which where things
    are untranslated.
    - similarly, adds a debug mode to add an annoying red text shadow to
    highlight things that are untranslated.
    - also adds a looooooong language for languages like German where things
    start breaking the UI (basically tests UI to where we should have some
    ellipsis or other considerations)
    
    - i18n cheat sheet:
    https://www.notion.so/tldraw/i18n-cheat-sheet-1223e4c324c080cf8e64c2b67f47378f
    
    This has a new App-level set of debug items btw:
    <img width="1500" alt="Screenshot 2024-10-25 at 23 02 44"
    src="https://github.com/user-attachments/assets/f0c24503-42aa-4dd5-8047-64ebffb661c0">
    
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [x] `other`
    
    ---------
    
    Co-authored-by: alex <alex@dytry.ch>

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index 6fbf6f2f8..e2b591054 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -180,6 +180,7 @@ function TlaEditorInner({ fileSlug, onDocumentChange, isCreateMode, deepLinks }:
 	return (
 		<div className={styles.editor} data-testid="tla-editor">
 			<Tldraw
+				className="tla-editor"
 				store={store}
 				assetUrls={assetUrls}
 				user={app?.tlUser}

commit 5c2fba38c0b11471f14399d9d57920d9d557e645
Author: Mime Čuvalo <mimecuvalo@gmail.com>
Date:   Wed Nov 6 11:40:43 2024 +0000

    i18n: wire up strings (#4834)
    
    finds all the strings in botcom and integrates them into the new system
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [x] `other`

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index e2b591054..b797713cb 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -30,6 +30,7 @@ import { globalEditor } from '../../../utils/globalEditor'
 import { multiplayerAssetStore } from '../../../utils/multiplayerAssetStore'
 import { SAVE_FILE_COPY_ACTION } from '../../../utils/useFileSystem'
 import { useHandleUiEvents } from '../../../utils/useHandleUiEvent'
+import { defineMessages, useIntl } from '../../app/i18n'
 import { useMaybeApp } from '../../hooks/useAppState'
 import { ReadyWrapper, useSetIsReady } from '../../hooks/useIsReady'
 import { getSnapshotsFromDroppedTldrawFiles } from '../../hooks/useTldrFileDrop'
@@ -39,6 +40,10 @@ import { TlaEditorTopLeftPanel } from './TlaEditorTopLeftPanel'
 import { TlaEditorTopRightPanel } from './TlaEditorTopRightPanel'
 import styles from './editor.module.css'
 
+const messages = defineMessages({
+	file: { defaultMessage: 'File' },
+})
+
 /** @internal */
 export const components: TLComponents = {
 	ErrorFallback: ({ error }) => {
@@ -46,9 +51,10 @@ export const components: TLComponents = {
 	},
 	KeyboardShortcutsDialog: (props) => {
 		const actions = useActions()
+		const intl = useIntl()
 		return (
 			<DefaultKeyboardShortcutsDialog {...props}>
-				<TldrawUiMenuGroup label="shortcuts-dialog.file" id="file">
+				<TldrawUiMenuGroup label={intl.formatMessage(messages.file)} id="file">
 					<TldrawUiMenuItem {...actions[SAVE_FILE_COPY_ACTION]} />
 				</TldrawUiMenuGroup>
 				<DefaultKeyboardShortcutsDialogContent />

commit 51310c28a1933528586ca540c039289c3e7de496
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Mon Nov 11 11:10:41 2024 +0000

    [wip] custom botcom backend (#4879)
    
    Describe what your pull request does. If you can, add GIFs or images
    showing the before and after of your change.
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [x] `other`
    
    ### Test plan
    
    1. Create a shape...
    2.
    
    - [ ] Unit tests
    - [ ] End to end tests
    
    ### Release notes
    
    - Fixed a bug with…
    
    ---------
    
    Co-authored-by: Mitja Bezenšek <mitja.bezensek@gmail.com>

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index b797713cb..913d70da5 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -1,5 +1,5 @@
 import { useAuth } from '@clerk/clerk-react'
-import { TldrawAppFileId, TldrawAppFileRecordType } from '@tldraw/dotcom-shared'
+import { TlaFileOpenMode } from '@tldraw/dotcom-shared'
 import { useSync } from '@tldraw/sync'
 import { useCallback, useEffect } from 'react'
 import { useParams } from 'react-router-dom'
@@ -15,6 +15,7 @@ import {
 	Tldraw,
 	TldrawUiMenuGroup,
 	TldrawUiMenuItem,
+	assert,
 	createSessionStateSnapshotSignal,
 	react,
 	throttle,
@@ -96,10 +97,17 @@ const anonComponents = {
 interface TlaEditorProps {
 	fileSlug: string
 	onDocumentChange?(): void
-	isCreateMode?: boolean
+	mode?: TlaFileOpenMode
+	duplicateId?: string
 	deepLinks?: boolean
 }
+
 export function TlaEditor(props: TlaEditorProps) {
+	if (props.mode === 'duplicate') {
+		assert(props.duplicateId, 'duplicateId is required when mode is duplicate')
+	} else {
+		assert(!props.duplicateId, 'duplicateId is not allowed when mode is not duplicate')
+	}
 	// force re-mount when the file slug changes to prevent state from leaking between files
 	return (
 		<ReadyWrapper key={props.fileSlug}>
@@ -108,11 +116,17 @@ export function TlaEditor(props: TlaEditorProps) {
 	)
 }
 
-function TlaEditorInner({ fileSlug, onDocumentChange, isCreateMode, deepLinks }: TlaEditorProps) {
+function TlaEditorInner({
+	fileSlug,
+	onDocumentChange,
+	mode,
+	deepLinks,
+	duplicateId,
+}: TlaEditorProps) {
 	const handleUiEvent = useHandleUiEvents()
 	const app = useMaybeApp()
 
-	const fileId = TldrawAppFileRecordType.createId(fileSlug)
+	const fileId = fileSlug
 
 	const setIsReady = useSetIsReady()
 
@@ -130,12 +144,12 @@ function TlaEditorInner({ fileSlug, onDocumentChange, isCreateMode, deepLinks }:
 			if (!app) return
 			const fileState = app.getFileState(fileId)
 			if (fileState?.lastSessionState) {
-				editor.loadSnapshot({ session: fileState.lastSessionState })
+				editor.loadSnapshot({ session: JSON.parse(fileState.lastSessionState.trim() || 'null') })
 			}
 			const sessionState$ = createSessionStateSnapshotSignal(editor.store)
 			const updateSessionState = throttle((state: TLSessionStateSnapshot) => {
 				app.onFileSessionStateUpdate(fileId, state)
-			}, 500)
+			}, 1000)
 			// don't want to update if they only open the file and didn't look around
 			let firstTime = true
 			const cleanup = react('update session state', () => {
@@ -163,11 +177,15 @@ function TlaEditorInner({ fileSlug, onDocumentChange, isCreateMode, deepLinks }:
 			if (user) {
 				url.searchParams.set('accessToken', await user.getToken())
 			}
-			if (isCreateMode) {
-				url.searchParams.set('isCreateMode', 'true')
+			if (mode) {
+				url.searchParams.set('mode', mode)
+				if (mode === 'duplicate') {
+					assert(duplicateId, 'duplicateId is required when mode is duplicate')
+					url.searchParams.set('duplicateId', duplicateId)
+				}
 			}
 			return url.toString()
-		}, [user, fileSlug, isCreateMode]),
+		}, [fileSlug, user, mode, duplicateId]),
 		assets: multiplayerAssetStore,
 		userInfo: app?.tlUser.userPreferences,
 	})
@@ -236,19 +254,27 @@ function SneakyFileUpdateHandler({
 	fileId,
 }: {
 	onDocumentChange?(): void
-	fileId: TldrawAppFileId
+	fileId: string
 }) {
 	const app = useMaybeApp()
 	const editor = useEditor()
 	useEffect(() => {
-		return editor.store.listen(
+		const onChange = throttle(
 			() => {
 				if (!app) return
 				app.onFileEdit(fileId)
 				onDocumentChange?.()
 			},
-			{ scope: 'document', source: 'user' }
+			// This is used to update the lastEditAt time in the database, and to let the local
+			// room know that an edit ahs been made.
+			// It doesn't need to be super fast or accurate so we can throttle it a lot
+			5000
 		)
+		const unsub = editor.store.listen(onChange, { scope: 'document', source: 'user' })
+		return () => {
+			unsub()
+			onChange.cancel()
+		}
 	}, [app, onDocumentChange, fileId, editor])
 
 	return null

commit 2e534b6f70c2950a1b754e12359bd786a62890f3
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Mon Nov 11 11:39:22 2024 +0000

    Revert "[wip] custom botcom backend" (#4883)
    
    Reverts tldraw/tldraw#487
    
    - [x] other

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index 913d70da5..b797713cb 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -1,5 +1,5 @@
 import { useAuth } from '@clerk/clerk-react'
-import { TlaFileOpenMode } from '@tldraw/dotcom-shared'
+import { TldrawAppFileId, TldrawAppFileRecordType } from '@tldraw/dotcom-shared'
 import { useSync } from '@tldraw/sync'
 import { useCallback, useEffect } from 'react'
 import { useParams } from 'react-router-dom'
@@ -15,7 +15,6 @@ import {
 	Tldraw,
 	TldrawUiMenuGroup,
 	TldrawUiMenuItem,
-	assert,
 	createSessionStateSnapshotSignal,
 	react,
 	throttle,
@@ -97,17 +96,10 @@ const anonComponents = {
 interface TlaEditorProps {
 	fileSlug: string
 	onDocumentChange?(): void
-	mode?: TlaFileOpenMode
-	duplicateId?: string
+	isCreateMode?: boolean
 	deepLinks?: boolean
 }
-
 export function TlaEditor(props: TlaEditorProps) {
-	if (props.mode === 'duplicate') {
-		assert(props.duplicateId, 'duplicateId is required when mode is duplicate')
-	} else {
-		assert(!props.duplicateId, 'duplicateId is not allowed when mode is not duplicate')
-	}
 	// force re-mount when the file slug changes to prevent state from leaking between files
 	return (
 		<ReadyWrapper key={props.fileSlug}>
@@ -116,17 +108,11 @@ export function TlaEditor(props: TlaEditorProps) {
 	)
 }
 
-function TlaEditorInner({
-	fileSlug,
-	onDocumentChange,
-	mode,
-	deepLinks,
-	duplicateId,
-}: TlaEditorProps) {
+function TlaEditorInner({ fileSlug, onDocumentChange, isCreateMode, deepLinks }: TlaEditorProps) {
 	const handleUiEvent = useHandleUiEvents()
 	const app = useMaybeApp()
 
-	const fileId = fileSlug
+	const fileId = TldrawAppFileRecordType.createId(fileSlug)
 
 	const setIsReady = useSetIsReady()
 
@@ -144,12 +130,12 @@ function TlaEditorInner({
 			if (!app) return
 			const fileState = app.getFileState(fileId)
 			if (fileState?.lastSessionState) {
-				editor.loadSnapshot({ session: JSON.parse(fileState.lastSessionState.trim() || 'null') })
+				editor.loadSnapshot({ session: fileState.lastSessionState })
 			}
 			const sessionState$ = createSessionStateSnapshotSignal(editor.store)
 			const updateSessionState = throttle((state: TLSessionStateSnapshot) => {
 				app.onFileSessionStateUpdate(fileId, state)
-			}, 1000)
+			}, 500)
 			// don't want to update if they only open the file and didn't look around
 			let firstTime = true
 			const cleanup = react('update session state', () => {
@@ -177,15 +163,11 @@ function TlaEditorInner({
 			if (user) {
 				url.searchParams.set('accessToken', await user.getToken())
 			}
-			if (mode) {
-				url.searchParams.set('mode', mode)
-				if (mode === 'duplicate') {
-					assert(duplicateId, 'duplicateId is required when mode is duplicate')
-					url.searchParams.set('duplicateId', duplicateId)
-				}
+			if (isCreateMode) {
+				url.searchParams.set('isCreateMode', 'true')
 			}
 			return url.toString()
-		}, [fileSlug, user, mode, duplicateId]),
+		}, [user, fileSlug, isCreateMode]),
 		assets: multiplayerAssetStore,
 		userInfo: app?.tlUser.userPreferences,
 	})
@@ -254,27 +236,19 @@ function SneakyFileUpdateHandler({
 	fileId,
 }: {
 	onDocumentChange?(): void
-	fileId: string
+	fileId: TldrawAppFileId
 }) {
 	const app = useMaybeApp()
 	const editor = useEditor()
 	useEffect(() => {
-		const onChange = throttle(
+		return editor.store.listen(
 			() => {
 				if (!app) return
 				app.onFileEdit(fileId)
 				onDocumentChange?.()
 			},
-			// This is used to update the lastEditAt time in the database, and to let the local
-			// room know that an edit ahs been made.
-			// It doesn't need to be super fast or accurate so we can throttle it a lot
-			5000
+			{ scope: 'document', source: 'user' }
 		)
-		const unsub = editor.store.listen(onChange, { scope: 'document', source: 'user' })
-		return () => {
-			unsub()
-			onChange.cancel()
-		}
 	}, [app, onDocumentChange, fileId, editor])
 
 	return null

commit 8d8471f530a48377b3223b8cb64647ef3e590a36
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Mon Nov 11 11:49:21 2024 +0000

    [botcom] New backend (again) (#4884)
    
    re-attempt at #4879
    So it turns out you have to delete a durable object class in two
    deploys:
    
    1. stop using it
    2. add the 'delete' migration in wrangler.toml
    
    - [x] `other`
    
    ---------
    
    Co-authored-by: Mitja Bezenšek <mitja.bezensek@gmail.com>

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index b797713cb..913d70da5 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -1,5 +1,5 @@
 import { useAuth } from '@clerk/clerk-react'
-import { TldrawAppFileId, TldrawAppFileRecordType } from '@tldraw/dotcom-shared'
+import { TlaFileOpenMode } from '@tldraw/dotcom-shared'
 import { useSync } from '@tldraw/sync'
 import { useCallback, useEffect } from 'react'
 import { useParams } from 'react-router-dom'
@@ -15,6 +15,7 @@ import {
 	Tldraw,
 	TldrawUiMenuGroup,
 	TldrawUiMenuItem,
+	assert,
 	createSessionStateSnapshotSignal,
 	react,
 	throttle,
@@ -96,10 +97,17 @@ const anonComponents = {
 interface TlaEditorProps {
 	fileSlug: string
 	onDocumentChange?(): void
-	isCreateMode?: boolean
+	mode?: TlaFileOpenMode
+	duplicateId?: string
 	deepLinks?: boolean
 }
+
 export function TlaEditor(props: TlaEditorProps) {
+	if (props.mode === 'duplicate') {
+		assert(props.duplicateId, 'duplicateId is required when mode is duplicate')
+	} else {
+		assert(!props.duplicateId, 'duplicateId is not allowed when mode is not duplicate')
+	}
 	// force re-mount when the file slug changes to prevent state from leaking between files
 	return (
 		<ReadyWrapper key={props.fileSlug}>
@@ -108,11 +116,17 @@ export function TlaEditor(props: TlaEditorProps) {
 	)
 }
 
-function TlaEditorInner({ fileSlug, onDocumentChange, isCreateMode, deepLinks }: TlaEditorProps) {
+function TlaEditorInner({
+	fileSlug,
+	onDocumentChange,
+	mode,
+	deepLinks,
+	duplicateId,
+}: TlaEditorProps) {
 	const handleUiEvent = useHandleUiEvents()
 	const app = useMaybeApp()
 
-	const fileId = TldrawAppFileRecordType.createId(fileSlug)
+	const fileId = fileSlug
 
 	const setIsReady = useSetIsReady()
 
@@ -130,12 +144,12 @@ function TlaEditorInner({ fileSlug, onDocumentChange, isCreateMode, deepLinks }:
 			if (!app) return
 			const fileState = app.getFileState(fileId)
 			if (fileState?.lastSessionState) {
-				editor.loadSnapshot({ session: fileState.lastSessionState })
+				editor.loadSnapshot({ session: JSON.parse(fileState.lastSessionState.trim() || 'null') })
 			}
 			const sessionState$ = createSessionStateSnapshotSignal(editor.store)
 			const updateSessionState = throttle((state: TLSessionStateSnapshot) => {
 				app.onFileSessionStateUpdate(fileId, state)
-			}, 500)
+			}, 1000)
 			// don't want to update if they only open the file and didn't look around
 			let firstTime = true
 			const cleanup = react('update session state', () => {
@@ -163,11 +177,15 @@ function TlaEditorInner({ fileSlug, onDocumentChange, isCreateMode, deepLinks }:
 			if (user) {
 				url.searchParams.set('accessToken', await user.getToken())
 			}
-			if (isCreateMode) {
-				url.searchParams.set('isCreateMode', 'true')
+			if (mode) {
+				url.searchParams.set('mode', mode)
+				if (mode === 'duplicate') {
+					assert(duplicateId, 'duplicateId is required when mode is duplicate')
+					url.searchParams.set('duplicateId', duplicateId)
+				}
 			}
 			return url.toString()
-		}, [user, fileSlug, isCreateMode]),
+		}, [fileSlug, user, mode, duplicateId]),
 		assets: multiplayerAssetStore,
 		userInfo: app?.tlUser.userPreferences,
 	})
@@ -236,19 +254,27 @@ function SneakyFileUpdateHandler({
 	fileId,
 }: {
 	onDocumentChange?(): void
-	fileId: TldrawAppFileId
+	fileId: string
 }) {
 	const app = useMaybeApp()
 	const editor = useEditor()
 	useEffect(() => {
-		return editor.store.listen(
+		const onChange = throttle(
 			() => {
 				if (!app) return
 				app.onFileEdit(fileId)
 				onDocumentChange?.()
 			},
-			{ scope: 'document', source: 'user' }
+			// This is used to update the lastEditAt time in the database, and to let the local
+			// room know that an edit ahs been made.
+			// It doesn't need to be super fast or accurate so we can throttle it a lot
+			5000
 		)
+		const unsub = editor.store.listen(onChange, { scope: 'document', source: 'user' })
+		return () => {
+			unsub()
+			onChange.cancel()
+		}
 	}, [app, onDocumentChange, fileId, editor])
 
 	return null

commit 73f6dccd86f2a06575be2e8c64920959adf5537a
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Sun Nov 24 14:07:38 2024 +0000

    Add eslint rule for react-intl. (#4983)
    
    We want all of our files to use our wrapped version of react-intl. This
    _should_ fix auto imports resolving to react-int by mistake.
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [x] `other`

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index 913d70da5..41748771c 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -31,11 +31,11 @@ import { globalEditor } from '../../../utils/globalEditor'
 import { multiplayerAssetStore } from '../../../utils/multiplayerAssetStore'
 import { SAVE_FILE_COPY_ACTION } from '../../../utils/useFileSystem'
 import { useHandleUiEvents } from '../../../utils/useHandleUiEvent'
-import { defineMessages, useIntl } from '../../app/i18n'
 import { useMaybeApp } from '../../hooks/useAppState'
 import { ReadyWrapper, useSetIsReady } from '../../hooks/useIsReady'
 import { getSnapshotsFromDroppedTldrawFiles } from '../../hooks/useTldrFileDrop'
 import { useTldrawUser } from '../../hooks/useUser'
+import { defineMessages, useIntl } from '../../utils/i18n'
 import { SneakyDarkModeSync } from './SneakyDarkModeSync'
 import { TlaEditorTopLeftPanel } from './TlaEditorTopLeftPanel'
 import { TlaEditorTopRightPanel } from './TlaEditorTopRightPanel'

commit 68491f0ffc96f801d17620680b738173dec29e20
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Sun Nov 24 21:14:33 2024 +0000

    Revert "Add eslint rule for react-intl." (#4985)
    
    Reverts tldraw/tldraw#4983

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index 41748771c..913d70da5 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -31,11 +31,11 @@ import { globalEditor } from '../../../utils/globalEditor'
 import { multiplayerAssetStore } from '../../../utils/multiplayerAssetStore'
 import { SAVE_FILE_COPY_ACTION } from '../../../utils/useFileSystem'
 import { useHandleUiEvents } from '../../../utils/useHandleUiEvent'
+import { defineMessages, useIntl } from '../../app/i18n'
 import { useMaybeApp } from '../../hooks/useAppState'
 import { ReadyWrapper, useSetIsReady } from '../../hooks/useIsReady'
 import { getSnapshotsFromDroppedTldrawFiles } from '../../hooks/useTldrFileDrop'
 import { useTldrawUser } from '../../hooks/useUser'
-import { defineMessages, useIntl } from '../../utils/i18n'
 import { SneakyDarkModeSync } from './SneakyDarkModeSync'
 import { TlaEditorTopLeftPanel } from './TlaEditorTopLeftPanel'
 import { TlaEditorTopRightPanel } from './TlaEditorTopRightPanel'

commit 5bcd5873e53853dbf0603292f2a3aadca23aa3db
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon Nov 25 17:12:29 2024 +0000

    [botcom] Pre-launch design / UX pass (#4984)
    
    Are you ready to go? I'm ready to go! This PR does a few design and UX
    changes ahead of the launch.
    
    Logged out, root page
    
    <img width="1241" alt="Screenshot 2024-11-24 at 21 05 17"
    src="https://github.com/user-attachments/assets/b4b0dea7-5140-417e-b9fd-986a571eeaba">
    
    Logged out, published page
    
    <img width="1241" alt="image"
    src="https://github.com/user-attachments/assets/fb7435b4-9713-43c8-991d-e6db60f18237">
    
    Logged out, file page
    
    <img width="1241" alt="Screenshot 2024-11-24 at 21 05 59"
    src="https://github.com/user-attachments/assets/afebe371-8808-400a-bac8-d5055cf53698">
    
    Logged in, file page
    
    <img width="1241" alt="Screenshot 2024-11-24 at 21 01 05"
    src="https://github.com/user-attachments/assets/1da95e8d-e000-4fab-95c4-1beb58ea372c">
    
    Logged in, guest file
    
    <img width="1241" alt="Screenshot 2024-11-24 at 21 02 33"
    src="https://github.com/user-attachments/assets/2a5a3ff5-11e1-46db-af2d-7d3ac9eb3778">
    
    Logged in, published file
    
    <img width="1241" alt="Screenshot 2024-11-24 at 21 03 26"
    src="https://github.com/user-attachments/assets/d832775e-ac55-43a4-8f93-35e1793a92a7">
    
    
    ### General sidebar / editor
    - parts sidebar components into their own files
    - cleans up some weird props in sidebar items
    - fixes spacing in the "workspace header"
    - fixes spacing in the file editor top left
    - fix icon weight difference in file editor top left
    - set mobile sidebar width to max(220px, 100%-100px)
    - animate desktop sidebar open/close
    - move menu items into the file menu (except for app-level things)
    - adds sidebar items to menu for logged out users
    - adds sign in to menu for logged out users
    - adds shortcut (Cmd + \) to toggle sidebar on desktop
    
    <img width="1241" alt="Screenshot 2024-11-24 at 21 03 43"
    src="https://github.com/user-attachments/assets/5e32019b-ef7f-457a-9d76-c94710e8c832">
    
    <img width="577" alt="image"
    src="https://github.com/user-attachments/assets/426b718d-d788-4503-bcdb-d5d1ce269e92">
    
    
    ### Anon layout
    - redesign anonymous layout
    - remove share menu / export options from anon pages
    
    ### Publish menu
    - redesign share menu for published projects
    
    ### Guest file
    - adds a temporary "collaborator" in sidebar for guest files
    - fix a bug where a user could edit the name of a file they don't own
    
    ### Creating too many pages
    - adds 1s timeout for creating new files
    
    ### Published file
    - fix document name in published files
    
    ### Sidebar user link
    - moved editor-related preferences into the editor
    - extracted the theme and language (they appear in both menus)
    
    <img width="417" alt="image"
    src="https://github.com/user-attachments/assets/550dcbbe-7b3a-46e4-b29a-d1ceff313b11">
    
    ### useMsg
    
    Add a `useMsg` hook that calls `useIntl().formatMessage`.
    
    ### Playground
    - creates a very small playground route where we can view components in
    different states. I don't like committing to this kind of storybook
    style documentation, so let's just use this when needed.
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [x] `other`
    
    ---------
    
    Co-authored-by: Mitja Bezenšek <mitja.bezensek@gmail.com>

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index 913d70da5..397e81bcf 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -6,10 +6,8 @@ import { useParams } from 'react-router-dom'
 import {
 	DefaultKeyboardShortcutsDialog,
 	DefaultKeyboardShortcutsDialogContent,
-	DefaultStylePanel,
 	Editor,
 	OfflineIndicator,
-	PeopleMenu,
 	TLComponents,
 	TLSessionStateSnapshot,
 	Tldraw,
@@ -31,11 +29,11 @@ import { globalEditor } from '../../../utils/globalEditor'
 import { multiplayerAssetStore } from '../../../utils/multiplayerAssetStore'
 import { SAVE_FILE_COPY_ACTION } from '../../../utils/useFileSystem'
 import { useHandleUiEvents } from '../../../utils/useHandleUiEvent'
-import { defineMessages, useIntl } from '../../app/i18n'
 import { useMaybeApp } from '../../hooks/useAppState'
 import { ReadyWrapper, useSetIsReady } from '../../hooks/useIsReady'
 import { getSnapshotsFromDroppedTldrawFiles } from '../../hooks/useTldrFileDrop'
 import { useTldrawUser } from '../../hooks/useUser'
+import { defineMessages, useMsg } from '../../utils/i18n'
 import { SneakyDarkModeSync } from './SneakyDarkModeSync'
 import { TlaEditorTopLeftPanel } from './TlaEditorTopLeftPanel'
 import { TlaEditorTopRightPanel } from './TlaEditorTopRightPanel'
@@ -52,10 +50,9 @@ export const components: TLComponents = {
 	},
 	KeyboardShortcutsDialog: (props) => {
 		const actions = useActions()
-		const intl = useIntl()
 		return (
 			<DefaultKeyboardShortcutsDialog {...props}>
-				<TldrawUiMenuGroup label={intl.formatMessage(messages.file)} id="file">
+				<TldrawUiMenuGroup label={useMsg(messages.file)} id="file">
 					<TldrawUiMenuItem {...actions[SAVE_FILE_COPY_ACTION]} />
 				</TldrawUiMenuGroup>
 				<DefaultKeyboardShortcutsDialogContent />
@@ -67,7 +64,9 @@ export const components: TLComponents = {
 		return <TlaEditorTopLeftPanel isAnonUser={!app} />
 	},
 	SharePanel: () => {
-		return <TlaEditorTopRightPanel />
+		const app = useMaybeApp()
+		const fileSlug = useParams<{ fileSlug: string }>().fileSlug
+		return <TlaEditorTopRightPanel isAnonUser={!app} context={fileSlug ? 'file' : 'scratch'} />
 	},
 	TopPanel: () => {
 		const collaborationStatus = useCollaborationStatus()
@@ -78,20 +77,6 @@ export const components: TLComponents = {
 
 const anonComponents = {
 	...components,
-	SharePanel: null,
-	StylePanel: () => {
-		// When on a temporary file, we don't want to show the people menu or file share menu, just the regular style panel
-		const { fileSlug } = useParams()
-		if (!fileSlug) return <DefaultStylePanel />
-
-		// ...but when an anonymous user is on a shared file, we do want to show the people menu next to the style panel
-		return (
-			<div className={styles.anonStylePanel}>
-				<PeopleMenu />
-				<DefaultStylePanel />
-			</div>
-		)
-	},
 }
 
 interface TlaEditorProps {
@@ -224,6 +209,13 @@ function TlaEditorInner({
 	)
 }
 
+// function SneakyThemeUpdater() {
+// 	const editor = useEditor()
+// 	useEffect(() => {
+// 		editor.setTheme('dark')
+// 	}, [editor])
+// }
+
 function SneakyTldrawFileDropHandler() {
 	const editor = useEditor()
 	const app = useMaybeApp()

commit 95be969c13d2e35dc022d2a703e7f375f82f90dc
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Sat Nov 30 22:34:22 2024 +0000

    [botcom] Wait 1000s before marking a file as re-visited  (#4998)
    
    This PR fixes a minor problem where we would rapidly mark a file as
    entered and exited when it loads. This is mostly a development problem,
    but it's good to address it anyway.
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [x] `other`
    
    ---------
    
    Co-authored-by: Mitja Bezenšek <mitja.bezensek@gmail.com>

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index 397e81bcf..24d4f5785 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -17,6 +17,7 @@ import {
 	createSessionStateSnapshotSignal,
 	react,
 	throttle,
+	tltime,
 	useActions,
 	useCollaborationStatus,
 	useEditor,
@@ -175,14 +176,36 @@ function TlaEditorInner({
 		userInfo: app?.tlUser.userPreferences,
 	})
 
-	// Handle entering and exiting the file
+	// Handle entering and exiting the file, with some protection against rapid enters/exits
 	useEffect(() => {
 		if (!app) return
 		if (store.status !== 'synced-remote') return
+		let didEnter = false
+		let timer: any
+
+		const fileState = app.getFileState(fileId)
+
+		if (fileState && fileState.firstVisitAt) {
+			// If there's a file state already then wait a second before marking it as entered
+			timer = tltime.setTimeout(
+				'file enter timer',
+				() => {
+					app.onFileEnter(fileId)
+					didEnter = true
+				},
+				1000
+			)
+		} else {
+			// If there's not a file state yet (i.e. if we're visiting this for the first time) then do an enter
+			app.onFileEnter(fileId)
+			didEnter = true
+		}
 
-		app.onFileEnter(fileId)
 		return () => {
-			app.onFileExit(fileId)
+			clearTimeout(timer)
+			if (didEnter) {
+				app.onFileExit(fileId)
+			}
 		}
 	}, [app, fileId, store.status])
 

commit 991d5fe228c9e8bd5df200c4406e9621a78cf552
Author: Mitja Bezenšek <mitja.bezensek@gmail.com>
Date:   Mon Dec 2 15:27:53 2024 +0100

    Fix the offline indicator (#5046)
    
    Fix the offline indicator.
    
    ### Change type
    
    - [x] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [ ] `other`

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index 24d4f5785..4f0af74dd 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -71,8 +71,14 @@ export const components: TLComponents = {
 	},
 	TopPanel: () => {
 		const collaborationStatus = useCollaborationStatus()
-		if (collaborationStatus === 'offline') return null
-		return <OfflineIndicator />
+		if (collaborationStatus === 'offline') {
+			return (
+				<div className={styles.offlineIndicatorWrapper}>
+					<OfflineIndicator />{' '}
+				</div>
+			)
+		}
+		return null
 	},
 }
 

commit dcd4d4f3d17123cb4d18ae8f99f62180f3b3aed6
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Mon Dec 2 17:00:24 2024 +0000

    [botcom] Set document title from file name (#5042)
    
    This PR copies Chat GPT's behavior of replacing the `document.title`
    with the name of the current file.
    
    ### Change type
    
    - [x] `other`
    
    ---------
    
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index 4f0af74dd..ff68f265a 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -2,6 +2,7 @@ import { useAuth } from '@clerk/clerk-react'
 import { TlaFileOpenMode } from '@tldraw/dotcom-shared'
 import { useSync } from '@tldraw/sync'
 import { useCallback, useEffect } from 'react'
+import { Helmet } from 'react-helmet-async'
 import { useParams } from 'react-router-dom'
 import {
 	DefaultKeyboardShortcutsDialog,
@@ -21,6 +22,7 @@ import {
 	useActions,
 	useCollaborationStatus,
 	useEditor,
+	useValue,
 } from 'tldraw'
 import { ThemeUpdater } from '../../../components/ThemeUpdater/ThemeUpdater'
 import { assetUrls } from '../../../utils/assetUrls'
@@ -102,9 +104,12 @@ export function TlaEditor(props: TlaEditorProps) {
 	}
 	// force re-mount when the file slug changes to prevent state from leaking between files
 	return (
-		<ReadyWrapper key={props.fileSlug}>
-			<TlaEditorInner {...props} key={props.fileSlug} />
-		</ReadyWrapper>
+		<>
+			<SetDocumentTitle />
+			<ReadyWrapper key={props.fileSlug}>
+				<TlaEditorInner {...props} key={props.fileSlug} />
+			</ReadyWrapper>
+		</>
 	)
 }
 
@@ -300,3 +305,20 @@ function SneakyFileUpdateHandler({
 
 	return null
 }
+
+function SetDocumentTitle() {
+	const { fileSlug } = useParams<{ fileSlug: string }>()
+	const app = useMaybeApp()
+	const editor = useValue('editor', () => globalEditor.get(), [])
+	const title = useValue(
+		'title',
+		() =>
+			((fileSlug ? app?.getFileName(fileSlug, false) : null) ??
+				editor?.getDocumentSettings().name) ||
+			// rather than displaying the date for the project here, display Untitled project
+			'Untitled project',
+		[app, editor, fileSlug]
+	)
+	if (!title) return null
+	return <Helmet title={title} />
+}

commit 9a1912515a80896189d5354e141361706420e4e2
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon Dec 2 18:01:14 2024 +0000

    [botcom] Add import / save as tldr file. (#5049)
    
    This PR adds an `Import file...` item to the sidebar account menu and a
    `Save a copy...` item to the file menu in the editor.
    
    <img width="432" alt="image"
    src="https://github.com/user-attachments/assets/a8f3358a-eb4f-471e-ad31-baf2fa67fa10">
    
    <img width="642" alt="image"
    src="https://github.com/user-attachments/assets/cdf38d01-b2e3-4748-bcf2-a72cb0c87c7e">
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [x] `other`

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index ff68f265a..b3f379bfe 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -1,7 +1,8 @@
 import { useAuth } from '@clerk/clerk-react'
 import { TlaFileOpenMode } from '@tldraw/dotcom-shared'
 import { useSync } from '@tldraw/sync'
-import { useCallback, useEffect } from 'react'
+import { fileSave } from 'browser-fs-access'
+import { useCallback, useEffect, useMemo } from 'react'
 import { Helmet } from 'react-helmet-async'
 import { useParams } from 'react-router-dom'
 import {
@@ -10,13 +11,17 @@ import {
 	Editor,
 	OfflineIndicator,
 	TLComponents,
+	TLDRAW_FILE_EXTENSION,
 	TLSessionStateSnapshot,
+	TLStore,
+	TLUiOverrides,
 	Tldraw,
 	TldrawUiMenuGroup,
 	TldrawUiMenuItem,
 	assert,
 	createSessionStateSnapshotSignal,
 	react,
+	serializeTldrawJsonBlob,
 	throttle,
 	tltime,
 	useActions,
@@ -220,6 +225,54 @@ function TlaEditorInner({
 		}
 	}, [app, fileId, store.status])
 
+	const overrides = useMemo<TLUiOverrides>(() => {
+		if (!app) return {}
+
+		return {
+			actions(editor, actions) {
+				actions['save-file-copy'] = {
+					id: 'save-file-copy',
+					label: 'action.save-copy',
+					readonlyOk: true,
+					kbd: '$s',
+					async onSelect() {
+						handleUiEvent('save-project-to-file', { source: '' })
+						const documentName =
+							((fileSlug ? app?.getFileName(fileSlug, false) : null) ??
+								editor?.getDocumentSettings().name) ||
+							// rather than displaying the date for the project here, display Untitled project
+							'Untitled project'
+						const defaultName =
+							saveFileNames.get(editor.store) || `${documentName}${TLDRAW_FILE_EXTENSION}`
+
+						const blobToSave = serializeTldrawJsonBlob(editor)
+						let handle
+						try {
+							handle = await fileSave(blobToSave, {
+								fileName: defaultName,
+								extensions: [TLDRAW_FILE_EXTENSION],
+								description: 'tldraw project',
+							})
+						} catch {
+							// user cancelled
+							return
+						}
+
+						if (handle) {
+							// we deliberately don't store the handle for re-use
+							// next time. we always want to save a copy, but to
+							// help the user out we'll remember the last name
+							// they used
+							saveFileNames.set(editor.store, handle.name)
+						}
+					},
+				}
+
+				return actions
+			},
+		}
+	}, [app, fileSlug, handleUiEvent])
+
 	return (
 		<div className={styles.editor} data-testid="tla-editor">
 			<Tldraw
@@ -232,6 +285,7 @@ function TlaEditorInner({
 				components={!app ? anonComponents : components}
 				options={{ actionShortcutsLocation: 'toolbar' }}
 				deepLinks={deepLinks || undefined}
+				overrides={overrides}
 			>
 				<ThemeUpdater />
 				{/* <CursorChatBubble /> */}
@@ -322,3 +376,6 @@ function SetDocumentTitle() {
 	if (!title) return null
 	return <Helmet title={title} />
 }
+
+// A map of previously saved tldr file names, so we can suggest the same name next time
+const saveFileNames = new WeakMap<TLStore, string>()

commit 3683601e879e4531acb39a92b3dffd4d92beb01d
Author: Mime Čuvalo <mimecuvalo@gmail.com>
Date:   Wed Dec 4 16:57:06 2024 +0000

    i18n: cleanup some missings strings; rework automation (#5068)
    
    just some translations updates. also, change the automation flow to
    create a PR once a week instead of trying to commit to main.
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [x] `other`

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index b3f379bfe..1d5062c57 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -49,6 +49,7 @@ import styles from './editor.module.css'
 
 const messages = defineMessages({
 	file: { defaultMessage: 'File' },
+	untitledProject: { defaultMessage: 'Untitled project' },
 })
 
 /** @internal */
@@ -225,6 +226,7 @@ function TlaEditorInner({
 		}
 	}, [app, fileId, store.status])
 
+	const untitledProject = useMsg(messages.untitledProject)
 	const overrides = useMemo<TLUiOverrides>(() => {
 		if (!app) return {}
 
@@ -241,7 +243,7 @@ function TlaEditorInner({
 							((fileSlug ? app?.getFileName(fileSlug, false) : null) ??
 								editor?.getDocumentSettings().name) ||
 							// rather than displaying the date for the project here, display Untitled project
-							'Untitled project'
+							untitledProject
 						const defaultName =
 							saveFileNames.get(editor.store) || `${documentName}${TLDRAW_FILE_EXTENSION}`
 
@@ -271,7 +273,7 @@ function TlaEditorInner({
 				return actions
 			},
 		}
-	}, [app, fileSlug, handleUiEvent])
+	}, [app, fileSlug, handleUiEvent, untitledProject])
 
 	return (
 		<div className={styles.editor} data-testid="tla-editor">
@@ -364,14 +366,15 @@ function SetDocumentTitle() {
 	const { fileSlug } = useParams<{ fileSlug: string }>()
 	const app = useMaybeApp()
 	const editor = useValue('editor', () => globalEditor.get(), [])
+	const untitledProject = useMsg(messages.untitledProject)
 	const title = useValue(
 		'title',
 		() =>
 			((fileSlug ? app?.getFileName(fileSlug, false) : null) ??
 				editor?.getDocumentSettings().name) ||
 			// rather than displaying the date for the project here, display Untitled project
-			'Untitled project',
-		[app, editor, fileSlug]
+			untitledProject,
+		[app, editor, fileSlug, untitledProject]
 	)
 	if (!title) return null
 	return <Helmet title={title} />

commit 4ecbef54a7fe82634fe682ed148165bc496b7b56
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Fri Dec 6 13:52:44 2024 +0000

    [botcom] slurp local files on sign in (#5059)
    
    This PR replaces the temporary multiplayer room from the logged out root
    page with the previous local editor, and 'slurps' the data into a new
    room during the sign in flow.
    
    If something goes wrong the user sees this:
    <img width="541" alt="image"
    src="https://github.com/user-attachments/assets/92413d9a-a90c-43b6-b05d-4e0acdc7db30">
    
    follow up work:
    
    - [ ] e2e tests
    - [ ] add Terms and conditions checkbox to sign in
    
    I'll create tickets for these upon merging.
    
    
    ### Change type
    
    
    - [x] `other`

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index 1d5062c57..9fff8ebf0 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -14,6 +14,7 @@ import {
 	TLDRAW_FILE_EXTENSION,
 	TLSessionStateSnapshot,
 	TLStore,
+	TLUiDialogsContextType,
 	TLUiOverrides,
 	Tldraw,
 	TldrawUiMenuGroup,
@@ -25,8 +26,11 @@ import {
 	throttle,
 	tltime,
 	useActions,
+	useAtom,
 	useCollaborationStatus,
+	useDialogs,
 	useEditor,
+	useEvent,
 	useValue,
 } from 'tldraw'
 import { ThemeUpdater } from '../../../components/ThemeUpdater/ThemeUpdater'
@@ -42,6 +46,7 @@ import { ReadyWrapper, useSetIsReady } from '../../hooks/useIsReady'
 import { getSnapshotsFromDroppedTldrawFiles } from '../../hooks/useTldrFileDrop'
 import { useTldrawUser } from '../../hooks/useUser'
 import { defineMessages, useMsg } from '../../utils/i18n'
+import { maybeSlurp } from '../../utils/slurping'
 import { SneakyDarkModeSync } from './SneakyDarkModeSync'
 import { TlaEditorTopLeftPanel } from './TlaEditorTopLeftPanel'
 import { TlaEditorTopRightPanel } from './TlaEditorTopRightPanel'
@@ -90,13 +95,8 @@ export const components: TLComponents = {
 	},
 }
 
-const anonComponents = {
-	...components,
-}
-
 interface TlaEditorProps {
 	fileSlug: string
-	onDocumentChange?(): void
 	mode?: TlaFileOpenMode
 	duplicateId?: string
 	deepLinks?: boolean
@@ -119,13 +119,7 @@ export function TlaEditor(props: TlaEditorProps) {
 	)
 }
 
-function TlaEditorInner({
-	fileSlug,
-	onDocumentChange,
-	mode,
-	deepLinks,
-	duplicateId,
-}: TlaEditorProps) {
+function TlaEditorInner({ fileSlug, mode, deepLinks, duplicateId }: TlaEditorProps) {
 	const handleUiEvent = useHandleUiEvents()
 	const app = useMaybeApp()
 
@@ -133,18 +127,40 @@ function TlaEditorInner({
 
 	const setIsReady = useSetIsReady()
 
+	const dialogs = useDialogs()
+	// need to wrap this in a useEvent to prevent the context id from changing on us
+	const addDialog: TLUiDialogsContextType['addDialog'] = useEvent((dialog) =>
+		dialogs.addDialog(dialog)
+	)
+
+	// We cycle this flag to cause shapes to remount when slurping images/videos fails.
+	// Because in that case we want to show the failure state for the images/videos.
+	// i.e. where it appears that they are not present. so the user knows which ones failed.
+	// There's probably a better way of doing this but I couldn't think of one.
+	const hideAllShapes = useAtom('hideAllShapes', false)
+	const isShapeHidden = useCallback(() => hideAllShapes.get(), [hideAllShapes])
+	const remountImageShapes = useCallback(() => {
+		hideAllShapes.set(true)
+		requestAnimationFrame(() => {
+			hideAllShapes.set(false)
+		})
+	}, [hideAllShapes])
+
 	const handleMount = useCallback(
 		(editor: Editor) => {
 			;(window as any).app = app
 			;(window as any).editor = editor
 			// Register the editor globally
 			globalEditor.set(editor)
-			setIsReady()
 
 			// Register the external asset handler
 			editor.registerExternalAssetHandler('url', createAssetFromUrl)
 
-			if (!app) return
+			if (!app) {
+				setIsReady()
+				return
+			}
+
 			const fileState = app.getFileState(fileId)
 			if (fileState?.lastSessionState) {
 				editor.loadSnapshot({ session: JSON.parse(fileState.lastSessionState.trim() || 'null') })
@@ -164,12 +180,24 @@ function TlaEditorInner({
 				}
 				updateSessionState(state)
 			})
+
+			const abortController = new AbortController()
+			maybeSlurp({
+				app,
+				editor,
+				fileId,
+				abortSignal: abortController.signal,
+				addDialog,
+				remountImageShapes,
+			}).then(setIsReady)
+
 			return () => {
+				abortController.abort()
 				cleanup()
 				updateSessionState.cancel()
 			}
 		},
-		[app, fileId, setIsReady]
+		[addDialog, app, fileId, remountImageShapes, setIsReady]
 	)
 
 	const user = useTldrawUser()
@@ -284,16 +312,16 @@ function TlaEditorInner({
 				user={app?.tlUser}
 				onMount={handleMount}
 				onUiEvent={handleUiEvent}
-				components={!app ? anonComponents : components}
+				components={components}
 				options={{ actionShortcutsLocation: 'toolbar' }}
 				deepLinks={deepLinks || undefined}
 				overrides={overrides}
+				isShapeHidden={isShapeHidden}
 			>
 				<ThemeUpdater />
-				{/* <CursorChatBubble /> */}
 				<SneakyDarkModeSync />
 				{app && <SneakyTldrawFileDropHandler />}
-				<SneakyFileUpdateHandler fileId={fileId} onDocumentChange={onDocumentChange} />
+				<SneakyFileUpdateHandler fileId={fileId} />
 			</Tldraw>
 		</div>
 	)
@@ -331,13 +359,7 @@ function SneakyTldrawFileDropHandler() {
 	return null
 }
 
-function SneakyFileUpdateHandler({
-	onDocumentChange,
-	fileId,
-}: {
-	onDocumentChange?(): void
-	fileId: string
-}) {
+function SneakyFileUpdateHandler({ fileId }: { fileId: string }) {
 	const app = useMaybeApp()
 	const editor = useEditor()
 	useEffect(() => {
@@ -345,7 +367,6 @@ function SneakyFileUpdateHandler({
 			() => {
 				if (!app) return
 				app.onFileEdit(fileId)
-				onDocumentChange?.()
 			},
 			// This is used to update the lastEditAt time in the database, and to let the local
 			// room know that an edit ahs been made.
@@ -357,7 +378,7 @@ function SneakyFileUpdateHandler({
 			unsub()
 			onChange.cancel()
 		}
-	}, [app, onDocumentChange, fileId, editor])
+	}, [app, fileId, editor])
 
 	return null
 }

commit a6ea6b217471895664138c696d7df3ba90f3d42e
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Sun Dec 8 14:06:42 2024 +0000

    [botcom] Update default title (#5085)
    
    This PR updates the title on tldraw.com (when logged out).
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [x] `other`

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index 9fff8ebf0..e834edbe9 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -398,7 +398,7 @@ function SetDocumentTitle() {
 		[app, editor, fileSlug, untitledProject]
 	)
 	if (!title) return null
-	return <Helmet title={title} />
+	return <Helmet title={app ? title : `${title} • tldraw`} />
 }
 
 // A map of previously saved tldr file names, so we can suggest the same name next time

commit 6aa293217b0ca73a7a7dfeaadcd8d823f7a124a6
Author: Mitja Bezenšek <mitja.bezensek@gmail.com>
Date:   Mon Dec 9 18:19:04 2024 +0100

    Copywriting consolidate on file (#5097)
    
    This also changes it from the `tldraw` package. It's definitely what
    we'd want for dotcom, but unsure if we want to make this change for
    other users of the package? I also didn't rename the keys for the
    `tldraw` package so that we don't break existing translations.
    
    Created a separate commit for the two changes.
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [x] `other`

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index e834edbe9..96dbff525 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -54,7 +54,7 @@ import styles from './editor.module.css'
 
 const messages = defineMessages({
 	file: { defaultMessage: 'File' },
-	untitledProject: { defaultMessage: 'Untitled project' },
+	untitledProject: { defaultMessage: 'Untitled file' },
 })
 
 /** @internal */

commit ad5917e619b9ff7c55ef536ddb7cb335549bdb86
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Tue Dec 17 10:22:41 2024 +0000

    [botcom] Support legacy routes (#5123)
    
    This PR adds (stubs) support for legacy routes in botcom. Those are:
    - shared room
    - shared room (readonly)
    - shared room (readonly, old url)
    - snapshot
    - history
    - history snapshot
    - touchscreen sidebar (maybe)
    
    I think it's better for us to treat these as "new routes" within botcom
    so that we can develop out the ways that these routes should be handled.
    Many routes need new UI and interactions, while the more rare internal
    routes can be mostly left as they are.
    
    We don't want to break shared rooms etc for people, however we do want
    to have the prompts to sign in, etc, present on these rooms, similar to
    what we display to signed out users for files. And for signed in users,
    we should have a way to "claim" or "slurp" the file into your account's
    files.
    
    Some notes:
    
    - titles appear in title bar for legacy routes
    - legacy routes support copy tab in share menu
    
    
    ### Change type
    
    - [x] `other`

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index 96dbff525..97bf0c75a 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -1,37 +1,21 @@
-import { useAuth } from '@clerk/clerk-react'
 import { TlaFileOpenMode } from '@tldraw/dotcom-shared'
 import { useSync } from '@tldraw/sync'
-import { fileSave } from 'browser-fs-access'
-import { useCallback, useEffect, useMemo } from 'react'
-import { Helmet } from 'react-helmet-async'
-import { useParams } from 'react-router-dom'
+import { useCallback, useEffect } from 'react'
 import {
-	DefaultKeyboardShortcutsDialog,
-	DefaultKeyboardShortcutsDialogContent,
 	Editor,
-	OfflineIndicator,
 	TLComponents,
-	TLDRAW_FILE_EXTENSION,
 	TLSessionStateSnapshot,
-	TLStore,
 	TLUiDialogsContextType,
-	TLUiOverrides,
 	Tldraw,
-	TldrawUiMenuGroup,
-	TldrawUiMenuItem,
 	assert,
 	createSessionStateSnapshotSignal,
 	react,
-	serializeTldrawJsonBlob,
 	throttle,
 	tltime,
-	useActions,
 	useAtom,
-	useCollaborationStatus,
 	useDialogs,
 	useEditor,
 	useEvent,
-	useValue,
 } from 'tldraw'
 import { ThemeUpdater } from '../../../components/ThemeUpdater/ThemeUpdater'
 import { assetUrls } from '../../../utils/assetUrls'
@@ -39,60 +23,29 @@ import { MULTIPLAYER_SERVER } from '../../../utils/config'
 import { createAssetFromUrl } from '../../../utils/createAssetFromUrl'
 import { globalEditor } from '../../../utils/globalEditor'
 import { multiplayerAssetStore } from '../../../utils/multiplayerAssetStore'
-import { SAVE_FILE_COPY_ACTION } from '../../../utils/useFileSystem'
 import { useHandleUiEvents } from '../../../utils/useHandleUiEvent'
 import { useMaybeApp } from '../../hooks/useAppState'
 import { ReadyWrapper, useSetIsReady } from '../../hooks/useIsReady'
-import { getSnapshotsFromDroppedTldrawFiles } from '../../hooks/useTldrFileDrop'
 import { useTldrawUser } from '../../hooks/useUser'
-import { defineMessages, useMsg } from '../../utils/i18n'
 import { maybeSlurp } from '../../utils/slurping'
 import { SneakyDarkModeSync } from './SneakyDarkModeSync'
-import { TlaEditorTopLeftPanel } from './TlaEditorTopLeftPanel'
-import { TlaEditorTopRightPanel } from './TlaEditorTopRightPanel'
-import styles from './editor.module.css'
-
-const messages = defineMessages({
-	file: { defaultMessage: 'File' },
-	untitledProject: { defaultMessage: 'Untitled file' },
-})
+import { TlaEditorWrapper } from './TlaEditorWrapper'
+import { TlaEditorErrorFallback } from './editor-components/TlaEditorErrorFallback'
+import { TlaEditorKeyboardShortcutsDialog } from './editor-components/TlaEditorKeyboardShortcutsDialog'
+import { TlaEditorMenuPanel } from './editor-components/TlaEditorMenuPanel'
+import { TlaEditorSharePanel } from './editor-components/TlaEditorSharePanel'
+import { TlaEditorTopPanel } from './editor-components/TlaEditorTopPanel'
+import { SneakyTldrawFileDropHandler } from './sneaky/SneakyFileDropHandler'
+import { SneakySetDocumentTitle } from './sneaky/SneakySetDocumentTitle'
+import { useFileEditorOverrides } from './useFileEditorOverrides'
 
 /** @internal */
 export const components: TLComponents = {
-	ErrorFallback: ({ error }) => {
-		throw error
-	},
-	KeyboardShortcutsDialog: (props) => {
-		const actions = useActions()
-		return (
-			<DefaultKeyboardShortcutsDialog {...props}>
-				<TldrawUiMenuGroup label={useMsg(messages.file)} id="file">
-					<TldrawUiMenuItem {...actions[SAVE_FILE_COPY_ACTION]} />
-				</TldrawUiMenuGroup>
-				<DefaultKeyboardShortcutsDialogContent />
-			</DefaultKeyboardShortcutsDialog>
-		)
-	},
-	MenuPanel: () => {
-		const app = useMaybeApp()
-		return <TlaEditorTopLeftPanel isAnonUser={!app} />
-	},
-	SharePanel: () => {
-		const app = useMaybeApp()
-		const fileSlug = useParams<{ fileSlug: string }>().fileSlug
-		return <TlaEditorTopRightPanel isAnonUser={!app} context={fileSlug ? 'file' : 'scratch'} />
-	},
-	TopPanel: () => {
-		const collaborationStatus = useCollaborationStatus()
-		if (collaborationStatus === 'offline') {
-			return (
-				<div className={styles.offlineIndicatorWrapper}>
-					<OfflineIndicator />{' '}
-				</div>
-			)
-		}
-		return null
-	},
+	ErrorFallback: TlaEditorErrorFallback,
+	KeyboardShortcutsDialog: TlaEditorKeyboardShortcutsDialog,
+	MenuPanel: TlaEditorMenuPanel,
+	TopPanel: TlaEditorTopPanel,
+	SharePanel: TlaEditorSharePanel,
 }
 
 interface TlaEditorProps {
@@ -111,7 +64,7 @@ export function TlaEditor(props: TlaEditorProps) {
 	// force re-mount when the file slug changes to prevent state from leaking between files
 	return (
 		<>
-			<SetDocumentTitle />
+			<SneakySetDocumentTitle />
 			<ReadyWrapper key={props.fileSlug}>
 				<TlaEditorInner {...props} key={props.fileSlug} />
 			</ReadyWrapper>
@@ -254,57 +207,10 @@ function TlaEditorInner({ fileSlug, mode, deepLinks, duplicateId }: TlaEditorPro
 		}
 	}, [app, fileId, store.status])
 
-	const untitledProject = useMsg(messages.untitledProject)
-	const overrides = useMemo<TLUiOverrides>(() => {
-		if (!app) return {}
-
-		return {
-			actions(editor, actions) {
-				actions['save-file-copy'] = {
-					id: 'save-file-copy',
-					label: 'action.save-copy',
-					readonlyOk: true,
-					kbd: '$s',
-					async onSelect() {
-						handleUiEvent('save-project-to-file', { source: '' })
-						const documentName =
-							((fileSlug ? app?.getFileName(fileSlug, false) : null) ??
-								editor?.getDocumentSettings().name) ||
-							// rather than displaying the date for the project here, display Untitled project
-							untitledProject
-						const defaultName =
-							saveFileNames.get(editor.store) || `${documentName}${TLDRAW_FILE_EXTENSION}`
-
-						const blobToSave = serializeTldrawJsonBlob(editor)
-						let handle
-						try {
-							handle = await fileSave(blobToSave, {
-								fileName: defaultName,
-								extensions: [TLDRAW_FILE_EXTENSION],
-								description: 'tldraw project',
-							})
-						} catch {
-							// user cancelled
-							return
-						}
-
-						if (handle) {
-							// we deliberately don't store the handle for re-use
-							// next time. we always want to save a copy, but to
-							// help the user out we'll remember the last name
-							// they used
-							saveFileNames.set(editor.store, handle.name)
-						}
-					},
-				}
-
-				return actions
-			},
-		}
-	}, [app, fileSlug, handleUiEvent, untitledProject])
+	const overrides = useFileEditorOverrides({ fileSlug })
 
 	return (
-		<div className={styles.editor} data-testid="tla-editor">
+		<TlaEditorWrapper>
 			<Tldraw
 				className="tla-editor"
 				store={store}
@@ -323,42 +229,10 @@ function TlaEditorInner({ fileSlug, mode, deepLinks, duplicateId }: TlaEditorPro
 				{app && <SneakyTldrawFileDropHandler />}
 				<SneakyFileUpdateHandler fileId={fileId} />
 			</Tldraw>
-		</div>
+		</TlaEditorWrapper>
 	)
 }
 
-// function SneakyThemeUpdater() {
-// 	const editor = useEditor()
-// 	useEffect(() => {
-// 		editor.setTheme('dark')
-// 	}, [editor])
-// }
-
-function SneakyTldrawFileDropHandler() {
-	const editor = useEditor()
-	const app = useMaybeApp()
-	const auth = useAuth()
-	useEffect(() => {
-		if (!auth) return
-		if (!app) return
-		const defaultOnDrop = editor.externalContentHandlers['files']
-		editor.registerExternalContentHandler('files', async (content) => {
-			const { files } = content
-			const tldrawFiles = files.filter((file) => file.name.endsWith('.tldr'))
-			if (tldrawFiles.length > 0) {
-				const snapshots = await getSnapshotsFromDroppedTldrawFiles(editor, tldrawFiles)
-				if (!snapshots.length) return
-				const token = await auth.getToken()
-				if (!token) return
-				await app.createFilesFromTldrFiles(snapshots, token)
-			} else {
-				defaultOnDrop?.(content)
-			}
-		})
-	}, [editor, app, auth])
-	return null
-}
-
 function SneakyFileUpdateHandler({ fileId }: { fileId: string }) {
 	const app = useMaybeApp()
 	const editor = useEditor()
@@ -382,24 +256,3 @@ function SneakyFileUpdateHandler({ fileId }: { fileId: string }) {
 
 	return null
 }
-
-function SetDocumentTitle() {
-	const { fileSlug } = useParams<{ fileSlug: string }>()
-	const app = useMaybeApp()
-	const editor = useValue('editor', () => globalEditor.get(), [])
-	const untitledProject = useMsg(messages.untitledProject)
-	const title = useValue(
-		'title',
-		() =>
-			((fileSlug ? app?.getFileName(fileSlug, false) : null) ??
-				editor?.getDocumentSettings().name) ||
-			// rather than displaying the date for the project here, display Untitled project
-			untitledProject,
-		[app, editor, fileSlug, untitledProject]
-	)
-	if (!title) return null
-	return <Helmet title={app ? title : `${title} • tldraw`} />
-}
-
-// A map of previously saved tldr file names, so we can suggest the same name next time
-const saveFileNames = new WeakMap<TLStore, string>()

commit e81e3057aaacae9064c64f62e7e998a92380e4ef
Author: Mitja Bezenšek <mitja.bezensek@gmail.com>
Date:   Tue Jan 14 15:07:07 2025 +0100

    Allow slurping of legacy multiplayer routes. (#5181)
    
    When a logged in user visits a legacy multiplayer room (`/q/r/roomId`)
    they can now click the `Copy to my files` button to slurp the
    multiplayer room to a file that gets created.
    
    This currently reuses all the existing assets - the files don't get
    re-uploaded. We will need to re-upload them so that we will be able to
    associate them with the user. Decided to skip this step for now and come
    back to it once we have the assets/user/file associations ready.
    
    ### Change type
    
    - [ ] `bugfix`
    - [x] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Test plan
    
    1. Create a legacy multiplayer room.
    2. Login to the app and use the multiplayer room link, but prefix it
    with `/q` (so something like `/q/r/roomId`
    3. Click the `Copy to my files` button.
    4. You should now see the same contents in the newly created file.

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index 97bf0c75a..7c01235a9 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -1,4 +1,4 @@
-import { TlaFileOpenMode } from '@tldraw/dotcom-shared'
+import { TlaFileOpenState } from '@tldraw/dotcom-shared'
 import { useSync } from '@tldraw/sync'
 import { useCallback, useEffect } from 'react'
 import {
@@ -50,16 +50,13 @@ export const components: TLComponents = {
 
 interface TlaEditorProps {
 	fileSlug: string
-	mode?: TlaFileOpenMode
-	duplicateId?: string
+	fileOpenState?: TlaFileOpenState
 	deepLinks?: boolean
 }
 
 export function TlaEditor(props: TlaEditorProps) {
-	if (props.mode === 'duplicate') {
-		assert(props.duplicateId, 'duplicateId is required when mode is duplicate')
-	} else {
-		assert(!props.duplicateId, 'duplicateId is not allowed when mode is not duplicate')
+	if (props.fileOpenState?.mode === 'duplicate') {
+		assert(props.fileOpenState.duplicateId, 'duplicateId is required when mode is duplicate')
 	}
 	// force re-mount when the file slug changes to prevent state from leaking between files
 	return (
@@ -72,9 +69,10 @@ export function TlaEditor(props: TlaEditorProps) {
 	)
 }
 
-function TlaEditorInner({ fileSlug, mode, deepLinks, duplicateId }: TlaEditorProps) {
+function TlaEditorInner({ fileSlug, fileOpenState, deepLinks }: TlaEditorProps) {
 	const handleUiEvent = useHandleUiEvents()
 	const app = useMaybeApp()
+	const mode = fileOpenState?.mode
 
 	const fileId = fileSlug
 
@@ -144,13 +142,18 @@ function TlaEditorInner({ fileSlug, mode, deepLinks, duplicateId }: TlaEditorPro
 				remountImageShapes,
 			}).then(setIsReady)
 
+			if (mode === 'slurp-legacy-file') {
+				assert(fileOpenState?.snapshot, 'snapshot is required when mode is slurp-legacy-file')
+				editor.loadSnapshot(fileOpenState.snapshot)
+			}
+
 			return () => {
 				abortController.abort()
 				cleanup()
 				updateSessionState.cancel()
 			}
 		},
-		[addDialog, app, fileId, remountImageShapes, setIsReady]
+		[addDialog, app, fileId, fileOpenState, mode, remountImageShapes, setIsReady]
 	)
 
 	const user = useTldrawUser()
@@ -164,12 +167,13 @@ function TlaEditorInner({ fileSlug, mode, deepLinks, duplicateId }: TlaEditorPro
 			if (mode) {
 				url.searchParams.set('mode', mode)
 				if (mode === 'duplicate') {
+					const duplicateId = fileOpenState.duplicateId
 					assert(duplicateId, 'duplicateId is required when mode is duplicate')
 					url.searchParams.set('duplicateId', duplicateId)
 				}
 			}
 			return url.toString()
-		}, [fileSlug, user, mode, duplicateId]),
+		}, [fileSlug, user, mode, fileOpenState]),
 		assets: multiplayerAssetStore,
 		userInfo: app?.tlUser.userPreferences,
 	})

commit 46ed9df28e1c91d8fa25103e8e8fb32cf321b46b
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Mon Jan 20 11:46:50 2025 +0000

    Always override session state on initial load (#5233)
    
    closes #4391 too
    
    ### Change type
    
    - [x] `bugfix`
    
    ### Release notes
    
    - Fixed a bug where grid mode and other settings would not persist
    across page reloads.

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index 7c01235a9..606fad1ac 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -114,7 +114,10 @@ function TlaEditorInner({ fileSlug, fileOpenState, deepLinks }: TlaEditorProps)
 
 			const fileState = app.getFileState(fileId)
 			if (fileState?.lastSessionState) {
-				editor.loadSnapshot({ session: JSON.parse(fileState.lastSessionState.trim() || 'null') })
+				editor.loadSnapshot(
+					{ session: JSON.parse(fileState.lastSessionState.trim() || 'null') },
+					{ forceOverwriteSessionState: true }
+				)
 			}
 			const sessionState$ = createSessionStateSnapshotSignal(editor.store)
 			const updateSessionState = throttle((state: TLSessionStateSnapshot) => {

commit 5c4b0489690d5cc4fe1f444c015b9d0fba51f0e8
Author: Mitja Bezenšek <mitja.bezensek@gmail.com>
Date:   Wed Jan 22 14:05:00 2025 +0100

    Asset uploads (#5218)
    
    Changes:
    * We now use the main sync worker for tldraw app asset uploads. For old
    assets we still continue to use the assets worker.
    * Image resize worker is now deployed as part of our deploy dotcom
    action. It receives the multiplayer worker url. If the asset origin is
    same as the multiplayer url (we are fetching tldraw app asset) it uses a
    service binding to request the asset. This is to avoid some permissions
    issues we encountered when the image worker fetched directly from the
    multiplayer worker. The fetching for existing assets should remain the
    same. I added `IMAGE_WORKER` env variable to different environments for
    our github actions.
    * We now associate assets with files. We do this in two ways: 1. when
    users upload the files we immediately add the `fileId` to the asset's
    `meta` property. We then also write an entry into a new postgres table
    called `asset`. 2. in some cases we do this server side (duplicating a
    room, copy pasting tldraw content, slurping legacy multiplayer rooms).
    The way it works is that the server checks all the tldraw app assets and
    makes sure their meta is associated to the correct file. If it is not it
    re-uploads the file to the uploads bucket and it updates the asset. It
    does this when persisting a file and also on restore.
    * There are some public API changes listed that were necessary to make
    this work. They are listed below.
    
    ### Change type
    
    - [ ] `bugfix`
    - [x] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Release notes
    
    **Breaking change**
    
    - `@tldraw/tlschema`: `TLAssetStore.upload` used to return just the
    `src` of the uploaded asset. It now returns `{src: string, meta?:
    JsonObject}`. The returned metadata will be added to the asset record
    and thus allows the users to add some additional data to them when
    uploading.
    - `@tldraw/editor`: `Editor.uploadAsset` used to return
    `Promise<string>` and now returns `Promise<{ src: string; meta?:
    JsonObject }> `

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index 606fad1ac..25ac98b85 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -1,6 +1,6 @@
 import { TlaFileOpenState } from '@tldraw/dotcom-shared'
 import { useSync } from '@tldraw/sync'
-import { useCallback, useEffect } from 'react'
+import { useCallback, useEffect, useMemo } from 'react'
 import {
 	Editor,
 	TLComponents,
@@ -160,6 +160,9 @@ function TlaEditorInner({ fileSlug, fileOpenState, deepLinks }: TlaEditorProps)
 	)
 
 	const user = useTldrawUser()
+	const assets = useMemo(() => {
+		return multiplayerAssetStore(() => fileId)
+	}, [fileId])
 
 	const store = useSync({
 		uri: useCallback(async () => {
@@ -177,7 +180,7 @@ function TlaEditorInner({ fileSlug, fileOpenState, deepLinks }: TlaEditorProps)
 			}
 			return url.toString()
 		}, [fileSlug, user, mode, fileOpenState]),
-		assets: multiplayerAssetStore,
+		assets,
 		userInfo: app?.tlUser.userPreferences,
 	})
 

commit 16f08007a19e63e3fab31265a8730a1578ecedf3
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Thu Jan 23 09:36:06 2025 +0000

    Welcome dialog for preview users (#5263)
    
    - for new users we show a welcome dialog that says
      - this is a preview
      - log out to get back to the old experience
    - (if they have content in indexeddb) would you like us to slurp your
    local data
    
    - add an option for dialogs to prevent clicking the background to
    dismiss
    - refactor the dialog/toasts system to not duplicate UI/context,
    allowing people to implement their own dialog/toast ui wherever they
    want. I think this is what steve originally wanted to do back when tla
    first landed. This was necessary to get a full-screen dialog with the
    useDialogs() hook and it just makes a lot more sense in general.
    
    ### Change type
    
    - [x] `api`
    
    ### Release notes
    
    - Breaking SDK Changes
      - TldrawUiToasts renamed to DefaultToasts
      - TldrawUiDialogs renamed to DefaultDialogs
    - New SDK stuff
      - Toasts overridable component added
      - Dialogs overridable component added

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index 25ac98b85..0491e1b59 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -28,6 +28,7 @@ import { useMaybeApp } from '../../hooks/useAppState'
 import { ReadyWrapper, useSetIsReady } from '../../hooks/useIsReady'
 import { useTldrawUser } from '../../hooks/useUser'
 import { maybeSlurp } from '../../utils/slurping'
+import { PreviewWelcomeDialog, RemountImagesContext } from './PreviewWelcomeDialog'
 import { SneakyDarkModeSync } from './SneakyDarkModeSync'
 import { TlaEditorWrapper } from './TlaEditorWrapper'
 import { TlaEditorErrorFallback } from './editor-components/TlaEditorErrorFallback'
@@ -46,6 +47,8 @@ export const components: TLComponents = {
 	MenuPanel: TlaEditorMenuPanel,
 	TopPanel: TlaEditorTopPanel,
 	SharePanel: TlaEditorSharePanel,
+	Dialogs: null,
+	Toasts: null,
 }
 
 interface TlaEditorProps {
@@ -238,6 +241,10 @@ function TlaEditorInner({ fileSlug, fileOpenState, deepLinks }: TlaEditorProps)
 				<SneakyDarkModeSync />
 				{app && <SneakyTldrawFileDropHandler />}
 				<SneakyFileUpdateHandler fileId={fileId} />
+				{/* Temporary junk for making the preview experience a bit better */}
+				<RemountImagesContext.Provider value={remountImageShapes}>
+					<PreviewWelcomeDialog />
+				</RemountImagesContext.Provider>
 			</Tldraw>
 		</TlaEditorWrapper>
 	)

commit 86aae29d7f4a3bfb258730c51f051c8889e20e2c
Author: Mitja Bezenšek <mitja.bezensek@gmail.com>
Date:   Wed Feb 5 09:01:10 2025 +0100

    Move to server side slurping. (#5348)
    
    This moves duplication and legacy room slurping to the backend:
    * It removes the the file open mode logic (no more setting it when
    navigating, no more sending search params to the backend).
    * We now insert a file into the db with an additional column called
    `createSource` which is in the form of `f/kZTr6Zdx6TClE6I4qExV4`. In
    this case this means duplication of an existing app file. For legacy
    files we'd similarly use `/r|ro|v|s/kZTr6Zdx6TClE6I4qExV4` to use that
    existing legacy file as a starting point.
    * Room DO then sees this column and reads the data from the appropriate
    source and initializes the room.
    * We now retry getting the file record from the db, because otherwise we
    could still end up with a "Not found" issue since the navigation might
    happen before the replicator tells the room DO about the file creation.
    * Assets will get re-uploaded with our existing
    `maybeAssociateFileAssets` logic, that makes sure all the assets are
    associated with the file.
    
    We had to do this because in some cases the file got created in the db,
    then an file update was dispatched to the replicator (due to the trigger
    we have on the file table), which incorrectly the set room DO (its
    document info was set to a non app file without the creation params). If
    this happened before the user navigation hit the worker it would mean
    that duplication as well as slurping legacy files end up in a "Not
    found" error, even though the file was correctly inserted into the db.
    
    ### Change type
    - [x] `improvement`
    
    ### Release notes
    
    - Move duplicating and legacy file slurping to the server.

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index 0491e1b59..bdf8f3b71 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -1,4 +1,3 @@
-import { TlaFileOpenState } from '@tldraw/dotcom-shared'
 import { useSync } from '@tldraw/sync'
 import { useCallback, useEffect, useMemo } from 'react'
 import {
@@ -7,7 +6,6 @@ import {
 	TLSessionStateSnapshot,
 	TLUiDialogsContextType,
 	Tldraw,
-	assert,
 	createSessionStateSnapshotSignal,
 	react,
 	throttle,
@@ -53,14 +51,10 @@ export const components: TLComponents = {
 
 interface TlaEditorProps {
 	fileSlug: string
-	fileOpenState?: TlaFileOpenState
 	deepLinks?: boolean
 }
 
 export function TlaEditor(props: TlaEditorProps) {
-	if (props.fileOpenState?.mode === 'duplicate') {
-		assert(props.fileOpenState.duplicateId, 'duplicateId is required when mode is duplicate')
-	}
 	// force re-mount when the file slug changes to prevent state from leaking between files
 	return (
 		<>
@@ -72,10 +66,9 @@ export function TlaEditor(props: TlaEditorProps) {
 	)
 }
 
-function TlaEditorInner({ fileSlug, fileOpenState, deepLinks }: TlaEditorProps) {
+function TlaEditorInner({ fileSlug, deepLinks }: TlaEditorProps) {
 	const handleUiEvent = useHandleUiEvents()
 	const app = useMaybeApp()
-	const mode = fileOpenState?.mode
 
 	const fileId = fileSlug
 
@@ -148,18 +141,13 @@ function TlaEditorInner({ fileSlug, fileOpenState, deepLinks }: TlaEditorProps)
 				remountImageShapes,
 			}).then(setIsReady)
 
-			if (mode === 'slurp-legacy-file') {
-				assert(fileOpenState?.snapshot, 'snapshot is required when mode is slurp-legacy-file')
-				editor.loadSnapshot(fileOpenState.snapshot)
-			}
-
 			return () => {
 				abortController.abort()
 				cleanup()
 				updateSessionState.cancel()
 			}
 		},
-		[addDialog, app, fileId, fileOpenState, mode, remountImageShapes, setIsReady]
+		[addDialog, app, fileId, remountImageShapes, setIsReady]
 	)
 
 	const user = useTldrawUser()
@@ -173,16 +161,8 @@ function TlaEditorInner({ fileSlug, fileOpenState, deepLinks }: TlaEditorProps)
 			if (user) {
 				url.searchParams.set('accessToken', await user.getToken())
 			}
-			if (mode) {
-				url.searchParams.set('mode', mode)
-				if (mode === 'duplicate') {
-					const duplicateId = fileOpenState.duplicateId
-					assert(duplicateId, 'duplicateId is required when mode is duplicate')
-					url.searchParams.set('duplicateId', duplicateId)
-				}
-			}
 			return url.toString()
-		}, [fileSlug, user, mode, fileOpenState]),
+		}, [fileSlug, user]),
 		assets,
 		userInfo: app?.tlUser.userPreferences,
 	})

commit 6e734d8d72f10c45da9c66b0a16cbca04996692e
Author: Mitja Bezenšek <mitja.bezensek@gmail.com>
Date:   Mon Feb 10 14:38:07 2025 +0100

    Make updates less frequent  (#5397)
    
    Updates to `fileState` `sessionState` and `file` `updatedAt` fields are
    by far the most frequent queries in our DB. Make them a bit less
    frequent and also make sure we do flush any pending updates if we
    navigate to a different file.
    
    ### Change type
    
    - [x] `improvement`
    
    ### Release notes
    
    - Make updates to file and file state a bit less frequent. Make sure we
    flush and pending updates before navigating though.

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index bdf8f3b71..4e5ef031d 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -118,7 +118,7 @@ function TlaEditorInner({ fileSlug, deepLinks }: TlaEditorProps) {
 			const sessionState$ = createSessionStateSnapshotSignal(editor.store)
 			const updateSessionState = throttle((state: TLSessionStateSnapshot) => {
 				app.onFileSessionStateUpdate(fileId, state)
-			}, 1000)
+			}, 5000)
 			// don't want to update if they only open the file and didn't look around
 			let firstTime = true
 			const cleanup = react('update session state', () => {
@@ -142,9 +142,9 @@ function TlaEditorInner({ fileSlug, deepLinks }: TlaEditorProps) {
 			}).then(setIsReady)
 
 			return () => {
+				updateSessionState.flush()
 				abortController.abort()
 				cleanup()
-				updateSessionState.cancel()
 			}
 		},
 		[addDialog, app, fileId, remountImageShapes, setIsReady]
@@ -240,14 +240,14 @@ function SneakyFileUpdateHandler({ fileId }: { fileId: string }) {
 				app.onFileEdit(fileId)
 			},
 			// This is used to update the lastEditAt time in the database, and to let the local
-			// room know that an edit ahs been made.
+			// room know that an edit has been made.
 			// It doesn't need to be super fast or accurate so we can throttle it a lot
-			5000
+			10_000
 		)
 		const unsub = editor.store.listen(onChange, { scope: 'document', source: 'user' })
 		return () => {
+			onChange.flush()
 			unsub()
-			onChange.cancel()
 		}
 	}, [app, fileId, editor])
 

commit dcbfd1934840afc22a7783b75edc699adebf29f4
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Mon Feb 10 15:32:37 2025 +0000

    yeet legacy pages into sun (#5385)
    
    # 🔪
    
    This PR gets rid of all the old versions of the legacy routes like
    /r/whatever and such.
    The new app-enhanced versions still exist obvs.
    
    ### Change type
    
    - [x] `other`

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index 4e5ef031d..1998f6a72 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -26,11 +26,9 @@ import { useMaybeApp } from '../../hooks/useAppState'
 import { ReadyWrapper, useSetIsReady } from '../../hooks/useIsReady'
 import { useTldrawUser } from '../../hooks/useUser'
 import { maybeSlurp } from '../../utils/slurping'
-import { PreviewWelcomeDialog, RemountImagesContext } from './PreviewWelcomeDialog'
 import { SneakyDarkModeSync } from './SneakyDarkModeSync'
 import { TlaEditorWrapper } from './TlaEditorWrapper'
 import { TlaEditorErrorFallback } from './editor-components/TlaEditorErrorFallback'
-import { TlaEditorKeyboardShortcutsDialog } from './editor-components/TlaEditorKeyboardShortcutsDialog'
 import { TlaEditorMenuPanel } from './editor-components/TlaEditorMenuPanel'
 import { TlaEditorSharePanel } from './editor-components/TlaEditorSharePanel'
 import { TlaEditorTopPanel } from './editor-components/TlaEditorTopPanel'
@@ -41,7 +39,6 @@ import { useFileEditorOverrides } from './useFileEditorOverrides'
 /** @internal */
 export const components: TLComponents = {
 	ErrorFallback: TlaEditorErrorFallback,
-	KeyboardShortcutsDialog: TlaEditorKeyboardShortcutsDialog,
 	MenuPanel: TlaEditorMenuPanel,
 	TopPanel: TlaEditorTopPanel,
 	SharePanel: TlaEditorSharePanel,
@@ -221,10 +218,6 @@ function TlaEditorInner({ fileSlug, deepLinks }: TlaEditorProps) {
 				<SneakyDarkModeSync />
 				{app && <SneakyTldrawFileDropHandler />}
 				<SneakyFileUpdateHandler fileId={fileId} />
-				{/* Temporary junk for making the preview experience a bit better */}
-				<RemountImagesContext.Provider value={remountImageShapes}>
-					<PreviewWelcomeDialog />
-				</RemountImagesContext.Provider>
 			</Tldraw>
 		</TlaEditorWrapper>
 	)

commit ffd70616b52c0ad0c5a19765d9dda825a107c38a
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Thu Feb 27 11:59:11 2025 +0000

    Stabilize useSync invocation (#5512)
    
    Phil reported an issue
    
    > Created new page in the "sales" project called Sales Funnel v3
    
    > Noticed it was called "untitled"...and when I clicked on the pages
    view the site refreshed and the page had gone.
    
    I reckon this was the same kind of thing that started happening randomly
    a couple of months ago where clerk, upon token refresh or something,
    would return a new object from the useAuth hook which in turn would
    invalidate our useTldrawUser hook, which in turn would invalidate our
    useSync invocation and cause the entire editor to remount.
    
    So here I've stabilized the useSync invocation so that it only
    invalidates when the file slug changes or the auth status (isSignedIn vs
    not) changes, and then we use a useEvent to handle fetching the token.
    
    ### Change type
    
    - [x] `other`

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index 1998f6a72..e039dc6ed 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -148,6 +148,10 @@ function TlaEditorInner({ fileSlug, deepLinks }: TlaEditorProps) {
 	)
 
 	const user = useTldrawUser()
+	const getUserToken = useEvent(async () => {
+		return (await user?.getToken()) ?? 'not-logged-in'
+	})
+	const hasUser = !!user
 	const assets = useMemo(() => {
 		return multiplayerAssetStore(() => fileId)
 	}, [fileId])
@@ -155,11 +159,11 @@ function TlaEditorInner({ fileSlug, deepLinks }: TlaEditorProps) {
 	const store = useSync({
 		uri: useCallback(async () => {
 			const url = new URL(`${MULTIPLAYER_SERVER}/app/file/${fileSlug}`)
-			if (user) {
-				url.searchParams.set('accessToken', await user.getToken())
+			if (hasUser) {
+				url.searchParams.set('accessToken', await getUserToken())
 			}
 			return url.toString()
-		}, [fileSlug, user]),
+		}, [fileSlug, hasUser, getUserToken]),
 		assets,
 		userInfo: app?.tlUser.userPreferences,
 	})

commit a0ae7debbb86477f16329aba7a7be04d953b182f
Author: Mitja Bezenšek <mitja.bezensek@gmail.com>
Date:   Sat Mar 15 17:13:15 2025 +0100

    Allow embedding other multiplayer routes and also tldraw app routes (#5326)
    
    Looks like we only allowed embeding of `/r` routes. This adds support
    for other multiplayer routes (like the readonly routes, snapshots
    routes) as well as the new tldraw app routes (`/f`, `/p`).
    
    We might also want to hide the sidebar for the tldraw app routes?
    
    ### Change type
    
    - [x] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [x] `other`
    
    ### Release notes
    
    - Fixed a bug with…
    
    ---------
    
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index e039dc6ed..09b997da6 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -48,6 +48,7 @@ export const components: TLComponents = {
 
 interface TlaEditorProps {
 	fileSlug: string
+	isEmbed?: boolean
 	deepLinks?: boolean
 }
 

commit abefd067ae60f67383ca45ba5afbf05546f03391
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Thu Mar 20 16:04:46 2025 +0000

    [dotcom] fix deep link handling for previously-seen files (#5707)
    
    We were overriding the deep links default behavior with the state from
    the database when the user had visited the file before. This fixes that.
    
    ### Change type
    
    - [x] `other`

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index 09b997da6..b52e9add9 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -7,6 +7,7 @@ import {
 	TLUiDialogsContextType,
 	Tldraw,
 	createSessionStateSnapshotSignal,
+	parseDeepLinkString,
 	react,
 	throttle,
 	tltime,
@@ -107,11 +108,14 @@ function TlaEditorInner({ fileSlug, deepLinks }: TlaEditorProps) {
 			}
 
 			const fileState = app.getFileState(fileId)
-			if (fileState?.lastSessionState) {
+			const deepLink = new URLSearchParams(window.location.search).get('d')
+			if (fileState?.lastSessionState && !deepLink) {
 				editor.loadSnapshot(
 					{ session: JSON.parse(fileState.lastSessionState.trim() || 'null') },
 					{ forceOverwriteSessionState: true }
 				)
+			} else if (deepLink) {
+				editor.navigateToDeepLink(parseDeepLinkString(deepLink))
 			}
 			const sessionState$ = createSessionStateSnapshotSignal(editor.store)
 			const updateSessionState = throttle((state: TLSessionStateSnapshot) => {

commit 71368dc000db19924eec6c4d6d5e23ec3e49d89f
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Thu Apr 3 10:24:59 2025 +0100

    isShapeHidden => getShapeVisibility, to allow children of hidden shapes to be visible (#5762)
    
    This PR was motivated by a very reasonable [discord request
    
    ](https://discord.com/channels/859816885297741824/1353628236487327857/1353628236487327857)
    
    > We are working on a feature where we need to hide all of the shapes
    except for the "focused shape" (we are using isShapeHidden prop) - this
    is largely working as expected, except for one challenge - when the
    "focused shape" is child of a frame/ group shape, then hiding the parent
    shape also hides the "focused shape", which makes sense in general
    context, but we need the ability to hide the parent shape without hiding
    the "focused shape".
    
    Ended up being a fairly small diff.
    
    ![Kapture 2025-03-27 at 12 00
    09](https://github.com/user-attachments/assets/e2423d49-9908-4a7b-bdb0-fed96c3b25f5)
    
    I'm not crazy about this 'force_show' API and would appreciate
    alternative suggestions if you have any.
    
    ### Change type
    
    - [x] `other`
    
    ### Release notes
    
    - Allow the children of a hidden shape to show themselves by returning a
    'force_show' override from the `isShapeHidden` predicate.

diff --git a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
index b52e9add9..9b86ddb83 100644
--- a/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
+++ b/apps/dotcom/client/src/tla/components/TlaEditor/TlaEditor.tsx
@@ -84,7 +84,10 @@ function TlaEditorInner({ fileSlug, deepLinks }: TlaEditorProps) {
 	// i.e. where it appears that they are not present. so the user knows which ones failed.
 	// There's probably a better way of doing this but I couldn't think of one.
 	const hideAllShapes = useAtom('hideAllShapes', false)
-	const isShapeHidden = useCallback(() => hideAllShapes.get(), [hideAllShapes])
+	const getShapeVisibility = useCallback(
+		() => (hideAllShapes.get() ? 'hidden' : 'inherit'),
+		[hideAllShapes]
+	)
 	const remountImageShapes = useCallback(() => {
 		hideAllShapes.set(true)
 		requestAnimationFrame(() => {
@@ -221,7 +224,7 @@ function TlaEditorInner({ fileSlug, deepLinks }: TlaEditorProps) {
 				options={{ actionShortcutsLocation: 'toolbar' }}
 				deepLinks={deepLinks || undefined}
 				overrides={overrides}
-				isShapeHidden={isShapeHidden}
+				getShapeVisibility={getShapeVisibility}
 			>
 				<ThemeUpdater />
 				<SneakyDarkModeSync />

