# Instructions

You are being benchmarked. You will see the output of a git log command, and from that must infer the current state of a file. Think carefully, as you must output the exact state of the file to earn full marks.

**Important:** Your goal is to reproduce the file's content *exactly* as it exists at the final commit, even if the code appears broken, buggy, or contains obvious errors. Do **not** try to "fix" the code. Attempting to correct issues will result in a poor score, as this benchmark evaluates your ability to reproduce the precise state of the file based on its history.

# Required Response Format

Wrap the content of the file in triple backticks (```). Any text outside the final closing backticks will be ignored. End your response after outputting the closing backticks.

# Example Response

```python
#!/usr/bin/env python
print('Hello, world!')
```

# File History

> git log -p --cc --topo-order --reverse -- src/main.zig

commit b8cee0a39eaeda11622d4e2ced44fccfcd702203
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Tue Mar 29 10:38:10 2022 -0700

    initial glfw stuff working

diff --git a/src/main.zig b/src/main.zig
new file mode 100644
index 00000000..f10f3f0e
--- /dev/null
+++ b/src/main.zig
@@ -0,0 +1,7 @@
+const std = @import("std");
+const c = @import("glfw/c.zig");
+
+pub fn main() !void {
+    if (c.glfwInit() != c.GLFW_TRUE) return error.GlfwInitFailed;
+    defer c.glfwTerminate();
+}

commit cc4d37804f7a5298551acaffe361ceced83cc323
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Tue Mar 29 11:04:30 2022 -0700

    rendering a window

diff --git a/src/main.zig b/src/main.zig
index f10f3f0e..fd8a7894 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -1,7 +1,20 @@
 const std = @import("std");
-const c = @import("glfw/c.zig");
+const glfw = @import("glfw/glfw.zig");
 
 pub fn main() !void {
-    if (c.glfwInit() != c.GLFW_TRUE) return error.GlfwInitFailed;
-    defer c.glfwTerminate();
+    // Iniialize GLFW
+    if (glfw.c.glfwInit() != glfw.c.GLFW_TRUE) return glfw.errors.getError();
+    defer glfw.c.glfwTerminate();
+
+    // Create our initial window
+    const window = glfw.c.glfwCreateWindow(640, 480, "My Title", null, null) orelse
+        return glfw.errors.getError();
+    defer glfw.c.glfwDestroyWindow(window);
+
+    // Setup OpenGL
+    glfw.c.glfwMakeContextCurrent(window);
+
+    while (glfw.c.glfwWindowShouldClose(window) == glfw.c.GLFW_FALSE) {
+        glfw.c.glfwWaitEvents();
+    }
 }

commit 112b13ae4d57ed967af98b50dd19cfd4d4aba670
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Wed Mar 30 11:36:58 2022 -0700

    build mach-glfw

diff --git a/src/main.zig b/src/main.zig
index fd8a7894..49d02861 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -1,20 +1,16 @@
 const std = @import("std");
-const glfw = @import("glfw/glfw.zig");
+const glfw = @import("glfw");
 
 pub fn main() !void {
-    // Iniialize GLFW
-    if (glfw.c.glfwInit() != glfw.c.GLFW_TRUE) return glfw.errors.getError();
-    defer glfw.c.glfwTerminate();
+    try glfw.init(.{});
+    defer glfw.terminate();
 
-    // Create our initial window
-    const window = glfw.c.glfwCreateWindow(640, 480, "My Title", null, null) orelse
-        return glfw.errors.getError();
-    defer glfw.c.glfwDestroyWindow(window);
+    // Create our window
+    const window = try glfw.Window.create(640, 480, "Hello, mach-glfw!", null, null, .{});
+    defer window.destroy();
 
-    // Setup OpenGL
-    glfw.c.glfwMakeContextCurrent(window);
-
-    while (glfw.c.glfwWindowShouldClose(window) == glfw.c.GLFW_FALSE) {
-        glfw.c.glfwWaitEvents();
+    // Wait for the user to close the window.
+    while (!window.shouldClose()) {
+        try glfw.pollEvents();
     }
 }

commit b23136fdaa972ba1ecf28dae26c79d406317c713
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Wed Mar 30 17:36:18 2022 -0700

    build gpu-dawn

diff --git a/src/main.zig b/src/main.zig
index 49d02861..b64bdf64 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -6,7 +6,7 @@ pub fn main() !void {
     defer glfw.terminate();
 
     // Create our window
-    const window = try glfw.Window.create(640, 480, "Hello, mach-glfw!", null, null, .{});
+    const window = try glfw.Window.create(640, 480, "ghostty", null, null, .{});
     defer window.destroy();
 
     // Wait for the user to close the window.

commit 83e5252c522d5bd7a159b802589c679df7ec037e
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Wed Mar 30 21:07:21 2022 -0700

    basics of setting up webgpu are up

diff --git a/src/main.zig b/src/main.zig
index b64bdf64..3e10a5b9 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -1,16 +1,19 @@
 const std = @import("std");
+const dawn = @import("dawn");
 const glfw = @import("glfw");
+const gpu = @import("gpu");
+
+const setup = @import("setup.zig");
 
 pub fn main() !void {
-    try glfw.init(.{});
-    defer glfw.terminate();
+    var gpa = std.heap.GeneralPurposeAllocator(.{}){};
+    var allocator = gpa.allocator();
 
-    // Create our window
-    const window = try glfw.Window.create(640, 480, "ghostty", null, null, .{});
-    defer window.destroy();
+    const s = try setup.setup(allocator);
+    defer glfw.terminate();
 
     // Wait for the user to close the window.
-    while (!window.shouldClose()) {
+    while (!s.window.shouldClose()) {
         try glfw.pollEvents();
     }
 }

commit a78e1894f894535b20c1af7cf65678d924ae4296
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Thu Mar 31 17:27:07 2022 -0700

    minimal raylib window

diff --git a/src/main.zig b/src/main.zig
index 3e10a5b9..2e3e94d3 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -1,19 +1,10 @@
 const std = @import("std");
-const dawn = @import("dawn");
-const glfw = @import("glfw");
-const gpu = @import("gpu");
-
-const setup = @import("setup.zig");
+const c = @import("c.zig");
 
 pub fn main() !void {
-    var gpa = std.heap.GeneralPurposeAllocator(.{}){};
-    var allocator = gpa.allocator();
-
-    const s = try setup.setup(allocator);
-    defer glfw.terminate();
+    c.InitWindow(640, 480, "ghostty");
+    c.SetTargetFPS(60);
+    defer c.CloseWindow();
 
-    // Wait for the user to close the window.
-    while (!s.window.shouldClose()) {
-        try glfw.pollEvents();
-    }
+    while (!c.WindowShouldClose()) {}
 }

commit cf956575c4331e566d24cbf07d0995af5f370122
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Thu Mar 31 17:51:00 2022 -0700

    use waiting rather than polling on window

diff --git a/src/main.zig b/src/main.zig
index 2e3e94d3..f6fbcacd 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -2,9 +2,20 @@ const std = @import("std");
 const c = @import("c.zig");
 
 pub fn main() !void {
+    // Set the window as resizable. This is particularly important for
+    // tiling window managers such as i3 since if they are not resizable they
+    // usually default to floating and we do not want to float by default!
+    c.SetConfigFlags(c.FLAG_WINDOW_RESIZABLE | c.FLAG_VSYNC_HINT);
+
+    // Create our window
     c.InitWindow(640, 480, "ghostty");
     c.SetTargetFPS(60);
     defer c.CloseWindow();
 
-    while (!c.WindowShouldClose()) {}
+    // Draw
+    while (!c.WindowShouldClose()) {
+        c.BeginDrawing();
+        c.ClearBackground(c.BLACK);
+        c.EndDrawing();
+    }
 }

commit 387b0ff4a8548f3b1012c8ae9a5df950657b115b
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Fri Apr 1 10:49:54 2022 -0700

    setup opengl

diff --git a/src/main.zig b/src/main.zig
index f6fbcacd..05d23fa7 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -1,21 +1,30 @@
 const std = @import("std");
-const c = @import("c.zig");
+const glfw = @import("glfw");
+const c = @cImport({
+    @cInclude("epoxy/gl.h");
+});
 
 pub fn main() !void {
-    // Set the window as resizable. This is particularly important for
-    // tiling window managers such as i3 since if they are not resizable they
-    // usually default to floating and we do not want to float by default!
-    c.SetConfigFlags(c.FLAG_WINDOW_RESIZABLE | c.FLAG_VSYNC_HINT);
+    try glfw.init(.{});
+    defer glfw.terminate();
 
     // Create our window
-    c.InitWindow(640, 480, "ghostty");
-    c.SetTargetFPS(60);
-    defer c.CloseWindow();
+    const window = try glfw.Window.create(640, 480, "ghostty", null, null, .{});
+    defer window.destroy();
 
-    // Draw
-    while (!c.WindowShouldClose()) {
-        c.BeginDrawing();
-        c.ClearBackground(c.BLACK);
-        c.EndDrawing();
+    // Setup OpenGL
+    try glfw.makeContextCurrent(window);
+    try glfw.swapInterval(1);
+
+    // Setup basic OpenGL settings
+    c.glClearColor(0.0, 0.0, 0.0, 0.0);
+
+    // Wait for the user to close the window.
+    while (!window.shouldClose()) {
+        const pos = try window.getCursorPos();
+        std.log.info("CURSOR: {}", .{pos});
+
+        try window.swapBuffers();
+        try glfw.waitEvents();
     }
 }

commit dc3d2d65d0406188791a3cb3728345d995b034ba
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Fri Apr 1 14:25:55 2022 -0700

    draw a triangle with opengl

diff --git a/src/main.zig b/src/main.zig
index 05d23fa7..6083561f 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -9,22 +9,140 @@ pub fn main() !void {
     defer glfw.terminate();
 
     // Create our window
-    const window = try glfw.Window.create(640, 480, "ghostty", null, null, .{});
+    const window = try glfw.Window.create(640, 480, "ghostty", null, null, .{
+        .context_version_major = 3,
+        .context_version_minor = 3,
+        .opengl_profile = .opengl_core_profile,
+        .opengl_forward_compat = true,
+    });
     defer window.destroy();
 
     // Setup OpenGL
     try glfw.makeContextCurrent(window);
     try glfw.swapInterval(1);
+    window.setSizeCallback((struct {
+        fn callback(_: glfw.Window, width: i32, height: i32) void {
+            std.log.info("set viewport {} {}", .{ width, height });
+            c.glViewport(0, 0, width, height);
+        }
+    }).callback);
 
-    // Setup basic OpenGL settings
-    c.glClearColor(0.0, 0.0, 0.0, 0.0);
+    // Create our vertex shader
+    const vs = c.glCreateShader(c.GL_VERTEX_SHADER);
+    c.glShaderSource(
+        vs,
+        1,
+        &@ptrCast([*c]const u8, vs_source),
+        null,
+    );
+    c.glCompileShader(vs);
+    var success: c_int = undefined;
+    c.glGetShaderiv(vs, c.GL_COMPILE_STATUS, &success);
+    if (success != c.GL_TRUE) {
+        var msg: [512]u8 = undefined;
+        c.glGetShaderInfoLog(vs, 512, null, &msg);
+        std.log.err("Fail: {s}\n", .{std.mem.sliceTo(&msg, 0)});
+        return;
+    }
+
+    const fs = c.glCreateShader(c.GL_FRAGMENT_SHADER);
+    c.glShaderSource(
+        fs,
+        1,
+        &@ptrCast([*c]const u8, fs_source),
+        null,
+    );
+    c.glCompileShader(fs);
+    c.glGetShaderiv(fs, c.GL_COMPILE_STATUS, &success);
+    if (success != c.GL_TRUE) {
+        var msg: [512]u8 = undefined;
+        c.glGetShaderInfoLog(fs, 512, null, &msg);
+        std.log.err("FS fail: {s}\n", .{std.mem.sliceTo(&msg, 0)});
+        return;
+    }
+
+    // Shader program
+    const program = c.glCreateProgram();
+    c.glAttachShader(program, vs);
+    c.glAttachShader(program, fs);
+    c.glLinkProgram(program);
+    c.glGetProgramiv(program, c.GL_LINK_STATUS, &success);
+    if (success != c.GL_TRUE) {
+        var msg: [512]u8 = undefined;
+        c.glGetProgramInfoLog(program, 512, null, &msg);
+        std.log.err("program fail: {s}\n", .{std.mem.sliceTo(&msg, 0)});
+        return;
+    }
+    c.glDeleteShader(vs);
+    c.glDeleteShader(fs);
+
+    // Create our bufer or vertices
+    const vertices = [_]f32{
+        -0.5, -0.5, 0.0, // left
+        0.5, -0.5, 0.0, // right
+        0.0, 0.5, 0.0, // top
+    };
+    var vao: c_uint = undefined;
+    var vbo: c_uint = undefined;
+    c.glGenVertexArrays(1, &vao);
+    c.glGenBuffers(1, &vbo);
+    c.glBindVertexArray(vao);
+
+    c.glBindBuffer(c.GL_ARRAY_BUFFER, vbo);
+    c.glBufferData(
+        c.GL_ARRAY_BUFFER,
+        @as(isize, @sizeOf(@TypeOf(vertices))),
+        &vertices,
+        c.GL_STATIC_DRAW,
+    );
+
+    c.glVertexAttribPointer(
+        0,
+        3,
+        c.GL_FLOAT,
+        c.GL_FALSE,
+        3 * @sizeOf(f32),
+        null,
+    );
+    c.glEnableVertexAttribArray(0);
+
+    c.glBindBuffer(c.GL_ARRAY_BUFFER, 0);
+    c.glBindVertexArray(0);
 
     // Wait for the user to close the window.
     while (!window.shouldClose()) {
-        const pos = try window.getCursorPos();
-        std.log.info("CURSOR: {}", .{pos});
+        // Setup basic OpenGL settings
+        c.glClearColor(0.2, 0.3, 0.3, 1.0);
+        c.glClear(c.GL_COLOR_BUFFER_BIT);
+
+        c.glUseProgram(program);
+        c.glBindVertexArray(vao);
+        c.glDrawArrays(c.GL_TRIANGLES, 0, 3);
+
+        // const pos = try window.getCursorPos();
+        // std.log.info("CURSOR: {}", .{pos});
 
         try window.swapBuffers();
         try glfw.waitEvents();
     }
 }
+
+const vs_source =
+    \\#version 330 core
+    \\layout (location = 0) in vec3 aPos;
+    \\
+    \\void main()
+    \\{
+    \\    gl_Position = vec4(aPos.x, aPos.y, aPos.z, 1.0);
+    \\}
+;
+
+const fs_source =
+    \\#version 330 core
+    \\out vec4 FragColor;
+    \\
+    \\void main()
+    \\{
+    \\    FragColor = vec4(1.0f, 0.5f, 0.2f, 1.0f);
+    \\}
+;

commit 847867ce9dd3d08091348bc7360ba4ffb0f7e144
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Fri Apr 1 15:25:29 2022 -0700

    abstract shaders

diff --git a/src/main.zig b/src/main.zig
index 6083561f..eac21cdc 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -1,8 +1,7 @@
 const std = @import("std");
 const glfw = @import("glfw");
-const c = @cImport({
-    @cInclude("epoxy/gl.h");
-});
+const c = @import("c.zig");
+const gl = @import("opengl.zig");
 
 pub fn main() !void {
     try glfw.init(.{});
@@ -28,44 +27,20 @@ pub fn main() !void {
     }).callback);
 
     // Create our vertex shader
-    const vs = c.glCreateShader(c.GL_VERTEX_SHADER);
-    c.glShaderSource(
-        vs,
-        1,
-        &@ptrCast([*c]const u8, vs_source),
-        null,
-    );
-    c.glCompileShader(vs);
-    var success: c_int = undefined;
-    c.glGetShaderiv(vs, c.GL_COMPILE_STATUS, &success);
-    if (success != c.GL_TRUE) {
-        var msg: [512]u8 = undefined;
-        c.glGetShaderInfoLog(vs, 512, null, &msg);
-        std.log.err("Fail: {s}\n", .{std.mem.sliceTo(&msg, 0)});
-        return;
-    }
+    const vs = try gl.Shader.create(gl.c.GL_VERTEX_SHADER);
+    try vs.setSourceAndCompile(vs_source);
+    defer vs.destroy();
 
-    const fs = c.glCreateShader(c.GL_FRAGMENT_SHADER);
-    c.glShaderSource(
-        fs,
-        1,
-        &@ptrCast([*c]const u8, fs_source),
-        null,
-    );
-    c.glCompileShader(fs);
-    c.glGetShaderiv(fs, c.GL_COMPILE_STATUS, &success);
-    if (success != c.GL_TRUE) {
-        var msg: [512]u8 = undefined;
-        c.glGetShaderInfoLog(fs, 512, null, &msg);
-        std.log.err("FS fail: {s}\n", .{std.mem.sliceTo(&msg, 0)});
-        return;
-    }
+    const fs = try gl.Shader.create(gl.c.GL_FRAGMENT_SHADER);
+    try fs.setSourceAndCompile(fs_source);
+    defer fs.destroy();
 
     // Shader program
     const program = c.glCreateProgram();
-    c.glAttachShader(program, vs);
-    c.glAttachShader(program, fs);
+    c.glAttachShader(program, vs.handle);
+    c.glAttachShader(program, fs.handle);
     c.glLinkProgram(program);
+    var success: c_int = undefined;
     c.glGetProgramiv(program, c.GL_LINK_STATUS, &success);
     if (success != c.GL_TRUE) {
         var msg: [512]u8 = undefined;
@@ -73,8 +48,8 @@ pub fn main() !void {
         std.log.err("program fail: {s}\n", .{std.mem.sliceTo(&msg, 0)});
         return;
     }
-    c.glDeleteShader(vs);
-    c.glDeleteShader(fs);
+    c.glDeleteShader(vs.handle);
+    c.glDeleteShader(fs.handle);
 
     // Create our bufer or vertices
     const vertices = [_]f32{

commit de0f707c96ecb46b4b03836023953555f1f9d635
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Fri Apr 1 15:34:03 2022 -0700

    opengl: programs

diff --git a/src/main.zig b/src/main.zig
index eac21cdc..351d342a 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -36,20 +36,13 @@ pub fn main() !void {
     defer fs.destroy();
 
     // Shader program
-    const program = c.glCreateProgram();
-    c.glAttachShader(program, vs.handle);
-    c.glAttachShader(program, fs.handle);
-    c.glLinkProgram(program);
-    var success: c_int = undefined;
-    c.glGetProgramiv(program, c.GL_LINK_STATUS, &success);
-    if (success != c.GL_TRUE) {
-        var msg: [512]u8 = undefined;
-        c.glGetProgramInfoLog(program, 512, null, &msg);
-        std.log.err("program fail: {s}\n", .{std.mem.sliceTo(&msg, 0)});
-        return;
-    }
-    c.glDeleteShader(vs.handle);
-    c.glDeleteShader(fs.handle);
+    const program = try gl.Program.create();
+    defer program.destroy();
+    try program.attachShader(vs);
+    try program.attachShader(fs);
+    try program.link();
+    vs.destroy();
+    fs.destroy();
 
     // Create our bufer or vertices
     const vertices = [_]f32{
@@ -90,7 +83,7 @@ pub fn main() !void {
         c.glClearColor(0.2, 0.3, 0.3, 1.0);
         c.glClear(c.GL_COLOR_BUFFER_BIT);
 
-        c.glUseProgram(program);
+        c.glUseProgram(program.id);
         c.glBindVertexArray(vao);
         c.glDrawArrays(c.GL_TRIANGLES, 0, 3);
 

commit 91cb86395bc0e8741e39b5e0b33a4c124bc8079f
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Fri Apr 1 15:38:47 2022 -0700

    opengl: extract into folder

diff --git a/src/main.zig b/src/main.zig
index 351d342a..12454c6e 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -1,7 +1,7 @@
 const std = @import("std");
 const glfw = @import("glfw");
-const c = @import("c.zig");
 const gl = @import("opengl.zig");
+const c = gl.c;
 
 pub fn main() !void {
     try glfw.init(.{});

commit 10369f564365c7dfd523a861c46b4eff3347572f
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Fri Apr 1 15:52:40 2022 -0700

    opengl: VertexArray

diff --git a/src/main.zig b/src/main.zig
index 12454c6e..cc0f1478 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -50,11 +50,11 @@ pub fn main() !void {
         0.5, -0.5, 0.0, // right
         0.0, 0.5, 0.0, // top
     };
-    var vao: c_uint = undefined;
+    const vao = try gl.VertexArray.create();
+    defer vao.destroy();
     var vbo: c_uint = undefined;
-    c.glGenVertexArrays(1, &vao);
     c.glGenBuffers(1, &vbo);
-    c.glBindVertexArray(vao);
+    try vao.bind();
 
     c.glBindBuffer(c.GL_ARRAY_BUFFER, vbo);
     c.glBufferData(
@@ -83,8 +83,8 @@ pub fn main() !void {
         c.glClearColor(0.2, 0.3, 0.3, 1.0);
         c.glClear(c.GL_COLOR_BUFFER_BIT);
 
-        c.glUseProgram(program.id);
-        c.glBindVertexArray(vao);
+        try program.use();
+        try vao.bind();
         c.glDrawArrays(c.GL_TRIANGLES, 0, 3);
 
         // const pos = try window.getCursorPos();

commit f1cffea9448ac65735ccca35e49f5efe703117b6
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Fri Apr 1 17:44:54 2022 -0700

    opengl: buffers

diff --git a/src/main.zig b/src/main.zig
index cc0f1478..69214a0a 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -52,17 +52,11 @@ pub fn main() !void {
     };
     const vao = try gl.VertexArray.create();
     defer vao.destroy();
-    var vbo: c_uint = undefined;
-    c.glGenBuffers(1, &vbo);
+    const vbo = try gl.Buffer.create();
+    defer vbo.destroy();
     try vao.bind();
-
-    c.glBindBuffer(c.GL_ARRAY_BUFFER, vbo);
-    c.glBufferData(
-        c.GL_ARRAY_BUFFER,
-        @as(isize, @sizeOf(@TypeOf(vertices))),
-        &vertices,
-        c.GL_STATIC_DRAW,
-    );
+    try vbo.bind(c.GL_ARRAY_BUFFER);
+    try vbo.setData(c.GL_ARRAY_BUFFER, vertices[0..], c.GL_STATIC_DRAW);
 
     c.glVertexAttribPointer(
         0,
@@ -74,8 +68,8 @@ pub fn main() !void {
     );
     c.glEnableVertexAttribArray(0);
 
-    c.glBindBuffer(c.GL_ARRAY_BUFFER, 0);
-    c.glBindVertexArray(0);
+    try gl.Buffer.unbind(c.GL_ARRAY_BUFFER);
+    try gl.VertexArray.unbind();
 
     // Wait for the user to close the window.
     while (!window.shouldClose()) {

commit 63673287f606311d7b3198254e83e95ea11504b9
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Fri Apr 1 17:52:36 2022 -0700

    opengl: more generic setData for buffer

diff --git a/src/main.zig b/src/main.zig
index 69214a0a..a882463d 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -56,7 +56,7 @@ pub fn main() !void {
     defer vbo.destroy();
     try vao.bind();
     try vbo.bind(c.GL_ARRAY_BUFFER);
-    try vbo.setData(c.GL_ARRAY_BUFFER, vertices[0..], c.GL_STATIC_DRAW);
+    try vbo.setData(c.GL_ARRAY_BUFFER, vertices, c.GL_STATIC_DRAW);
 
     c.glVertexAttribPointer(
         0,

commit a5a2196d527ff348397d543c1753de16599616bf
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Fri Apr 1 18:00:15 2022 -0700

    opengl: bound buffers

diff --git a/src/main.zig b/src/main.zig
index a882463d..21ed0cba 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -55,8 +55,8 @@ pub fn main() !void {
     const vbo = try gl.Buffer.create();
     defer vbo.destroy();
     try vao.bind();
-    try vbo.bind(c.GL_ARRAY_BUFFER);
-    try vbo.setData(c.GL_ARRAY_BUFFER, vertices, c.GL_STATIC_DRAW);
+    var binding = try vbo.bind(c.GL_ARRAY_BUFFER);
+    try binding.setData(&vertices, c.GL_STATIC_DRAW);
 
     c.glVertexAttribPointer(
         0,
@@ -68,7 +68,7 @@ pub fn main() !void {
     );
     c.glEnableVertexAttribArray(0);
 
-    try gl.Buffer.unbind(c.GL_ARRAY_BUFFER);
+    binding.unbind();
     try gl.VertexArray.unbind();
 
     // Wait for the user to close the window.

commit 045dd704ec0522252637735a41787db91736c053
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Fri Apr 1 18:44:18 2022 -0700

    opengl: more bindings

diff --git a/src/main.zig b/src/main.zig
index 21ed0cba..c01d6fc3 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -57,16 +57,8 @@ pub fn main() !void {
     try vao.bind();
     var binding = try vbo.bind(c.GL_ARRAY_BUFFER);
     try binding.setData(&vertices, c.GL_STATIC_DRAW);
-
-    c.glVertexAttribPointer(
-        0,
-        3,
-        c.GL_FLOAT,
-        c.GL_FALSE,
-        3 * @sizeOf(f32),
-        null,
-    );
-    c.glEnableVertexAttribArray(0);
+    try binding.vertexAttribPointer(0, 3, c.GL_FLOAT, false, 3 * @sizeOf(f32), null);
+    try binding.enableVertexAttribArray(0);
 
     binding.unbind();
     try gl.VertexArray.unbind();

commit 80d064ed5151786a33b023bb97f2d9afe9ee7790
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Fri Apr 1 19:05:16 2022 -0700

    opengl: uniforms

diff --git a/src/main.zig b/src/main.zig
index c01d6fc3..f71cd6ba 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -70,6 +70,8 @@ pub fn main() !void {
         c.glClear(c.GL_COLOR_BUFFER_BIT);
 
         try program.use();
+        try program.setUniform("vertexColor", @Vector(4, f32){ 0.0, 1.0, 0.0, 1.0 });
+
         try vao.bind();
         c.glDrawArrays(c.GL_TRIANGLES, 0, 3);
 
@@ -95,8 +97,10 @@ const fs_source =
     \\#version 330 core
     \\out vec4 FragColor;
     \\
+    \\uniform vec4 vertexColor;
+    \\
     \\void main()
     \\{
-    \\    FragColor = vec4(1.0f, 0.5f, 0.2f, 1.0f);
+    \\    FragColor = vertexColor;
     \\}
 ;

commit 02848a053584add42e0729d59000f7c8d1fcab10
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Fri Apr 1 19:45:05 2022 -0700

    stb

diff --git a/src/main.zig b/src/main.zig
index f71cd6ba..e6ce3328 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -1,12 +1,27 @@
 const std = @import("std");
 const glfw = @import("glfw");
 const gl = @import("opengl.zig");
-const c = gl.c;
+const stb = @import("stb.zig");
 
 pub fn main() !void {
     try glfw.init(.{});
     defer glfw.terminate();
 
+    // Load our image
+    var imgwidth: c_int = 0;
+    var imgheight: c_int = 0;
+    var imgchannels: c_int = 0;
+    const data = stb.c.stbi_load_from_memory(
+        texsrc,
+        texsrc.len,
+        &imgwidth,
+        &imgheight,
+        &imgchannels,
+        0,
+    );
+    if (data == null) return error.TexFail;
+    stb.c.stbi_image_free(data);
+
     // Create our window
     const window = try glfw.Window.create(640, 480, "ghostty", null, null, .{
         .context_version_major = 3,
@@ -22,7 +37,7 @@ pub fn main() !void {
     window.setSizeCallback((struct {
         fn callback(_: glfw.Window, width: i32, height: i32) void {
             std.log.info("set viewport {} {}", .{ width, height });
-            c.glViewport(0, 0, width, height);
+            gl.c.glViewport(0, 0, width, height);
         }
     }).callback);
 
@@ -55,9 +70,9 @@ pub fn main() !void {
     const vbo = try gl.Buffer.create();
     defer vbo.destroy();
     try vao.bind();
-    var binding = try vbo.bind(c.GL_ARRAY_BUFFER);
-    try binding.setData(&vertices, c.GL_STATIC_DRAW);
-    try binding.vertexAttribPointer(0, 3, c.GL_FLOAT, false, 3 * @sizeOf(f32), null);
+    var binding = try vbo.bind(gl.c.GL_ARRAY_BUFFER);
+    try binding.setData(&vertices, gl.c.GL_STATIC_DRAW);
+    try binding.vertexAttribPointer(0, 3, gl.c.GL_FLOAT, false, 3 * @sizeOf(f32), null);
     try binding.enableVertexAttribArray(0);
 
     binding.unbind();
@@ -66,14 +81,14 @@ pub fn main() !void {
     // Wait for the user to close the window.
     while (!window.shouldClose()) {
         // Setup basic OpenGL settings
-        c.glClearColor(0.2, 0.3, 0.3, 1.0);
-        c.glClear(c.GL_COLOR_BUFFER_BIT);
+        gl.c.glClearColor(0.2, 0.3, 0.3, 1.0);
+        gl.c.glClear(gl.c.GL_COLOR_BUFFER_BIT);
 
         try program.use();
         try program.setUniform("vertexColor", @Vector(4, f32){ 0.0, 1.0, 0.0, 1.0 });
 
         try vao.bind();
-        c.glDrawArrays(c.GL_TRIANGLES, 0, 3);
+        gl.c.glDrawArrays(gl.c.GL_TRIANGLES, 0, 3);
 
         // const pos = try window.getCursorPos();
         // std.log.info("CURSOR: {}", .{pos});
@@ -83,6 +98,8 @@ pub fn main() !void {
     }
 }
 
+const texsrc = @embedFile("tex.png");
+
 const vs_source =
     \\#version 330 core
     \\layout (location = 0) in vec3 aPos;

commit 9f9357d21bdd2b2dc272386812b91e91d525aef6
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Fri Apr 1 20:05:59 2022 -0700

    textures

diff --git a/src/main.zig b/src/main.zig
index e6ce3328..33a0ff68 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -7,21 +7,6 @@ pub fn main() !void {
     try glfw.init(.{});
     defer glfw.terminate();
 
-    // Load our image
-    var imgwidth: c_int = 0;
-    var imgheight: c_int = 0;
-    var imgchannels: c_int = 0;
-    const data = stb.c.stbi_load_from_memory(
-        texsrc,
-        texsrc.len,
-        &imgwidth,
-        &imgheight,
-        &imgchannels,
-        0,
-    );
-    if (data == null) return error.TexFail;
-    stb.c.stbi_image_free(data);
-
     // Create our window
     const window = try glfw.Window.create(640, 480, "ghostty", null, null, .{
         .context_version_major = 3,
@@ -41,6 +26,43 @@ pub fn main() !void {
         }
     }).callback);
 
+    // Load our image
+    var imgwidth: c_int = 0;
+    var imgheight: c_int = 0;
+    var imgchannels: c_int = 0;
+    const data = stb.c.stbi_load_from_memory(
+        texsrc,
+        texsrc.len,
+        &imgwidth,
+        &imgheight,
+        &imgchannels,
+        0,
+    );
+    if (data == null) return error.TexFail;
+    defer stb.c.stbi_image_free(data);
+
+    // Setup a texture
+    const tex = try gl.Texture.create();
+    defer tex.destroy();
+    var texbind = try tex.bind(gl.c.GL_TEXTURE_2D);
+    defer texbind.unbind();
+    gl.c.glTexParameteri(gl.c.GL_TEXTURE_2D, gl.c.GL_TEXTURE_WRAP_S, gl.c.GL_REPEAT);
+    gl.c.glTexParameteri(gl.c.GL_TEXTURE_2D, gl.c.GL_TEXTURE_WRAP_T, gl.c.GL_REPEAT);
+    gl.c.glTexParameteri(gl.c.GL_TEXTURE_2D, gl.c.GL_TEXTURE_MIN_FILTER, gl.c.GL_LINEAR);
+    gl.c.glTexParameteri(gl.c.GL_TEXTURE_2D, gl.c.GL_TEXTURE_MAG_FILTER, gl.c.GL_LINEAR);
+    gl.c.glTexImage2D(
+        gl.c.GL_TEXTURE_2D,
+        0,
+        gl.c.GL_RGB,
+        imgwidth,
+        imgheight,
+        0,
+        gl.c.GL_RGB,
+        gl.c.GL_UNSIGNED_BYTE,
+        data,
+    );
+    gl.c.glGenerateMipmap(gl.c.GL_TEXTURE_2D);
+
     // Create our vertex shader
     const vs = try gl.Shader.create(gl.c.GL_VERTEX_SHADER);
     try vs.setSourceAndCompile(vs_source);
@@ -61,9 +83,9 @@ pub fn main() !void {
 
     // Create our bufer or vertices
     const vertices = [_]f32{
-        -0.5, -0.5, 0.0, // left
-        0.5, -0.5, 0.0, // right
-        0.0, 0.5, 0.0, // top
+        -0.5, -0.5, 0.0, 0.0, 0.0, // left
+        0.5, -0.5, 0.0, 1.0, 0.0, // right
+        0.0, 0.5, 0.0, 0.5, 1.0, // top
     };
     const vao = try gl.VertexArray.create();
     defer vao.destroy();
@@ -72,8 +94,17 @@ pub fn main() !void {
     try vao.bind();
     var binding = try vbo.bind(gl.c.GL_ARRAY_BUFFER);
     try binding.setData(&vertices, gl.c.GL_STATIC_DRAW);
-    try binding.vertexAttribPointer(0, 3, gl.c.GL_FLOAT, false, 3 * @sizeOf(f32), null);
+    try binding.vertexAttribPointer(0, 3, gl.c.GL_FLOAT, false, 5 * @sizeOf(f32), null);
     try binding.enableVertexAttribArray(0);
+    try binding.vertexAttribPointer(
+        1,
+        2,
+        gl.c.GL_FLOAT,
+        false,
+        5 * @sizeOf(f32),
+        @intToPtr(*const anyopaque, 3 * @sizeOf(f32)),
+    );
+    try binding.enableVertexAttribArray(1);
 
     binding.unbind();
     try gl.VertexArray.unbind();
@@ -85,8 +116,8 @@ pub fn main() !void {
         gl.c.glClear(gl.c.GL_COLOR_BUFFER_BIT);
 
         try program.use();
-        try program.setUniform("vertexColor", @Vector(4, f32){ 0.0, 1.0, 0.0, 1.0 });
 
+        gl.c.glBindTexture(gl.c.GL_TEXTURE_2D, tex.id);
         try vao.bind();
         gl.c.glDrawArrays(gl.c.GL_TRIANGLES, 0, 3);
 
@@ -103,10 +134,14 @@ const texsrc = @embedFile("tex.png");
 const vs_source =
     \\#version 330 core
     \\layout (location = 0) in vec3 aPos;
+    \\layout (location = 1) in vec2 aTexCoord;
+    \\
+    \\out vec2 TexCoord;
     \\
     \\void main()
     \\{
     \\    gl_Position = vec4(aPos.x, aPos.y, aPos.z, 1.0);
+    \\    TexCoord = aTexCoord;
     \\}
 ;
 
@@ -114,10 +149,12 @@ const fs_source =
     \\#version 330 core
     \\out vec4 FragColor;
     \\
-    \\uniform vec4 vertexColor;
+    \\in vec2 TexCoord;
+    \\
+    \\uniform sampler2D ourTexture;
     \\
     \\void main()
     \\{
-    \\    FragColor = vertexColor;
+    \\    FragColor = texture(ourTexture, TexCoord);
     \\}
 ;

commit 63ce7114a487f93591095241748e723212ed9dd4
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sat Apr 2 20:17:53 2022 -0700

    opengl: draw functions

diff --git a/src/main.zig b/src/main.zig
index 33a0ff68..34fe82f0 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -83,9 +83,9 @@ pub fn main() !void {
 
     // Create our bufer or vertices
     const vertices = [_]f32{
-        -0.5, -0.5, 0.0, 0.0, 0.0, // left
-        0.5, -0.5, 0.0, 1.0, 0.0, // right
-        0.0, 0.5, 0.0, 0.5, 1.0, // top
+        -0.8, -0.8, 0.0, 0.0, 0.0, // left
+        0.8, -0.8, 0.0, 1.0, 0.0, // right
+        0.0, 0.8, 0.0, 0.5, 1.0, // top
     };
     const vao = try gl.VertexArray.create();
     defer vao.destroy();
@@ -112,14 +112,14 @@ pub fn main() !void {
     // Wait for the user to close the window.
     while (!window.shouldClose()) {
         // Setup basic OpenGL settings
-        gl.c.glClearColor(0.2, 0.3, 0.3, 1.0);
-        gl.c.glClear(gl.c.GL_COLOR_BUFFER_BIT);
+        gl.clearColor(0.2, 0.3, 0.3, 1.0);
+        gl.clear(gl.c.GL_COLOR_BUFFER_BIT);
 
         try program.use();
 
-        gl.c.glBindTexture(gl.c.GL_TEXTURE_2D, tex.id);
+        _ = try tex.bind(gl.c.GL_TEXTURE_2D);
         try vao.bind();
-        gl.c.glDrawArrays(gl.c.GL_TRIANGLES, 0, 3);
+        try gl.drawArrays(gl.c.GL_TRIANGLES, 0, 3);
 
         // const pos = try window.getCursorPos();
         // std.log.info("CURSOR: {}", .{pos});

commit 049004e6de7139dc2bc74b0a37ffd2f49cea0bec
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sat Apr 2 20:35:39 2022 -0700

    opengl: more funcs

diff --git a/src/main.zig b/src/main.zig
index 34fe82f0..f5f4b6eb 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -22,7 +22,7 @@ pub fn main() !void {
     window.setSizeCallback((struct {
         fn callback(_: glfw.Window, width: i32, height: i32) void {
             std.log.info("set viewport {} {}", .{ width, height });
-            gl.c.glViewport(0, 0, width, height);
+            try gl.viewport(0, 0, width, height);
         }
     }).callback);
 
@@ -46,12 +46,11 @@ pub fn main() !void {
     defer tex.destroy();
     var texbind = try tex.bind(gl.c.GL_TEXTURE_2D);
     defer texbind.unbind();
-    gl.c.glTexParameteri(gl.c.GL_TEXTURE_2D, gl.c.GL_TEXTURE_WRAP_S, gl.c.GL_REPEAT);
-    gl.c.glTexParameteri(gl.c.GL_TEXTURE_2D, gl.c.GL_TEXTURE_WRAP_T, gl.c.GL_REPEAT);
-    gl.c.glTexParameteri(gl.c.GL_TEXTURE_2D, gl.c.GL_TEXTURE_MIN_FILTER, gl.c.GL_LINEAR);
-    gl.c.glTexParameteri(gl.c.GL_TEXTURE_2D, gl.c.GL_TEXTURE_MAG_FILTER, gl.c.GL_LINEAR);
-    gl.c.glTexImage2D(
-        gl.c.GL_TEXTURE_2D,
+    try texbind.parameter(gl.c.GL_TEXTURE_WRAP_S, gl.c.GL_REPEAT);
+    try texbind.parameter(gl.c.GL_TEXTURE_WRAP_T, gl.c.GL_REPEAT);
+    try texbind.parameter(gl.c.GL_TEXTURE_MIN_FILTER, gl.c.GL_LINEAR);
+    try texbind.parameter(gl.c.GL_TEXTURE_MAG_FILTER, gl.c.GL_LINEAR);
+    try texbind.image2D(
         0,
         gl.c.GL_RGB,
         imgwidth,
@@ -61,7 +60,7 @@ pub fn main() !void {
         gl.c.GL_UNSIGNED_BYTE,
         data,
     );
-    gl.c.glGenerateMipmap(gl.c.GL_TEXTURE_2D);
+    texbind.generateMipmap();
 
     // Create our vertex shader
     const vs = try gl.Shader.create(gl.c.GL_VERTEX_SHADER);

commit 3cb5dae9d86c680aaada3be22b9cbdefad505cc6
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sun Apr 3 20:08:29 2022 -0700

    fontconfig example

diff --git a/src/main.zig b/src/main.zig
index f5f4b6eb..b5d17e50 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -2,8 +2,12 @@ const std = @import("std");
 const glfw = @import("glfw");
 const gl = @import("opengl.zig");
 const stb = @import("stb.zig");
+const fonts = @import("fonts.zig");
 
 pub fn main() !void {
+    // List our fonts
+    try fonts.list();
+
     try glfw.init(.{});
     defer glfw.terminate();
 

commit 5bbdd75d70c5108e3e01701cd70424bb24cbb158
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sun Apr 3 20:39:32 2022 -0700

    clean up the main App

diff --git a/src/main.zig b/src/main.zig
index b5d17e50..81ab80c4 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -4,160 +4,15 @@ const gl = @import("opengl.zig");
 const stb = @import("stb.zig");
 const fonts = @import("fonts.zig");
 
+const App = @import("App.zig");
+
 pub fn main() !void {
     // List our fonts
-    try fonts.list();
-
     try glfw.init(.{});
     defer glfw.terminate();
 
-    // Create our window
-    const window = try glfw.Window.create(640, 480, "ghostty", null, null, .{
-        .context_version_major = 3,
-        .context_version_minor = 3,
-        .opengl_profile = .opengl_core_profile,
-        .opengl_forward_compat = true,
-    });
-    defer window.destroy();
-
-    // Setup OpenGL
-    try glfw.makeContextCurrent(window);
-    try glfw.swapInterval(1);
-    window.setSizeCallback((struct {
-        fn callback(_: glfw.Window, width: i32, height: i32) void {
-            std.log.info("set viewport {} {}", .{ width, height });
-            try gl.viewport(0, 0, width, height);
-        }
-    }).callback);
-
-    // Load our image
-    var imgwidth: c_int = 0;
-    var imgheight: c_int = 0;
-    var imgchannels: c_int = 0;
-    const data = stb.c.stbi_load_from_memory(
-        texsrc,
-        texsrc.len,
-        &imgwidth,
-        &imgheight,
-        &imgchannels,
-        0,
-    );
-    if (data == null) return error.TexFail;
-    defer stb.c.stbi_image_free(data);
-
-    // Setup a texture
-    const tex = try gl.Texture.create();
-    defer tex.destroy();
-    var texbind = try tex.bind(gl.c.GL_TEXTURE_2D);
-    defer texbind.unbind();
-    try texbind.parameter(gl.c.GL_TEXTURE_WRAP_S, gl.c.GL_REPEAT);
-    try texbind.parameter(gl.c.GL_TEXTURE_WRAP_T, gl.c.GL_REPEAT);
-    try texbind.parameter(gl.c.GL_TEXTURE_MIN_FILTER, gl.c.GL_LINEAR);
-    try texbind.parameter(gl.c.GL_TEXTURE_MAG_FILTER, gl.c.GL_LINEAR);
-    try texbind.image2D(
-        0,
-        gl.c.GL_RGB,
-        imgwidth,
-        imgheight,
-        0,
-        gl.c.GL_RGB,
-        gl.c.GL_UNSIGNED_BYTE,
-        data,
-    );
-    texbind.generateMipmap();
-
-    // Create our vertex shader
-    const vs = try gl.Shader.create(gl.c.GL_VERTEX_SHADER);
-    try vs.setSourceAndCompile(vs_source);
-    defer vs.destroy();
-
-    const fs = try gl.Shader.create(gl.c.GL_FRAGMENT_SHADER);
-    try fs.setSourceAndCompile(fs_source);
-    defer fs.destroy();
-
-    // Shader program
-    const program = try gl.Program.create();
-    defer program.destroy();
-    try program.attachShader(vs);
-    try program.attachShader(fs);
-    try program.link();
-    vs.destroy();
-    fs.destroy();
-
-    // Create our bufer or vertices
-    const vertices = [_]f32{
-        -0.8, -0.8, 0.0, 0.0, 0.0, // left
-        0.8, -0.8, 0.0, 1.0, 0.0, // right
-        0.0, 0.8, 0.0, 0.5, 1.0, // top
-    };
-    const vao = try gl.VertexArray.create();
-    defer vao.destroy();
-    const vbo = try gl.Buffer.create();
-    defer vbo.destroy();
-    try vao.bind();
-    var binding = try vbo.bind(gl.c.GL_ARRAY_BUFFER);
-    try binding.setData(&vertices, gl.c.GL_STATIC_DRAW);
-    try binding.vertexAttribPointer(0, 3, gl.c.GL_FLOAT, false, 5 * @sizeOf(f32), null);
-    try binding.enableVertexAttribArray(0);
-    try binding.vertexAttribPointer(
-        1,
-        2,
-        gl.c.GL_FLOAT,
-        false,
-        5 * @sizeOf(f32),
-        @intToPtr(*const anyopaque, 3 * @sizeOf(f32)),
-    );
-    try binding.enableVertexAttribArray(1);
-
-    binding.unbind();
-    try gl.VertexArray.unbind();
-
-    // Wait for the user to close the window.
-    while (!window.shouldClose()) {
-        // Setup basic OpenGL settings
-        gl.clearColor(0.2, 0.3, 0.3, 1.0);
-        gl.clear(gl.c.GL_COLOR_BUFFER_BIT);
-
-        try program.use();
-
-        _ = try tex.bind(gl.c.GL_TEXTURE_2D);
-        try vao.bind();
-        try gl.drawArrays(gl.c.GL_TRIANGLES, 0, 3);
-
-        // const pos = try window.getCursorPos();
-        // std.log.info("CURSOR: {}", .{pos});
-
-        try window.swapBuffers();
-        try glfw.waitEvents();
-    }
+    // Run our app
+    var app = try App.init();
+    defer app.deinit();
+    try app.run();
 }
-
-const texsrc = @embedFile("tex.png");
-
-const vs_source =
-    \\#version 330 core
-    \\layout (location = 0) in vec3 aPos;
-    \\layout (location = 1) in vec2 aTexCoord;
-    \\
-    \\out vec2 TexCoord;
-    \\
-    \\void main()
-    \\{
-    \\    gl_Position = vec4(aPos.x, aPos.y, aPos.z, 1.0);
-    \\    TexCoord = aTexCoord;
-    \\}
-;
-
-const fs_source =
-    \\#version 330 core
-    \\out vec4 FragColor;
-    \\
-    \\in vec2 TexCoord;
-    \\
-    \\uniform sampler2D ourTexture;
-    \\
-    \\void main()
-    \\{
-    \\    FragColor = texture(ourTexture, TexCoord);
-    \\}
-;

commit 670af17a1b10a1ff3a84674e4e1b31097dbcb0bb
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sun Apr 3 22:04:42 2022 -0700

    getting closer to dumb font rendering

diff --git a/src/main.zig b/src/main.zig
index 81ab80c4..2e3a041b 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -1,18 +1,19 @@
 const std = @import("std");
 const glfw = @import("glfw");
-const gl = @import("opengl.zig");
-const stb = @import("stb.zig");
-const fonts = @import("fonts.zig");
 
 const App = @import("App.zig");
 
 pub fn main() !void {
+    var general_purpose_allocator = std.heap.GeneralPurposeAllocator(.{}){};
+    const gpa = general_purpose_allocator.allocator();
+    defer _ = general_purpose_allocator.deinit();
+
     // List our fonts
     try glfw.init(.{});
     defer glfw.terminate();
 
     // Run our app
-    var app = try App.init();
+    var app = try App.init(gpa);
     defer app.deinit();
     try app.run();
 }

commit c4fb335a6b99466e520b3f48a1c1930ee66253d5
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Tue Apr 5 12:04:10 2022 -0700

    zig native atlas implementation

diff --git a/src/main.zig b/src/main.zig
index 2e3a041b..1360b2c5 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -17,3 +17,7 @@ pub fn main() !void {
     defer app.deinit();
     try app.run();
 }
+
+test {
+    _ = @import("Atlas.zig");
+}

commit e33aeea72372cafcea8ab36984a3e0116c40ab77
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Tue Apr 5 17:57:09 2022 -0700

    starting FontAtlas

diff --git a/src/main.zig b/src/main.zig
index 1360b2c5..e799c821 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -20,4 +20,5 @@ pub fn main() !void {
 
 test {
     _ = @import("Atlas.zig");
+    _ = @import("FontAtlas.zig");
 }

commit bb902cf4e315a8ccfb6103c73e4d8f440bef1d6d
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Thu Apr 14 21:07:16 2022 -0700

    new Window abstraction

diff --git a/src/main.zig b/src/main.zig
index e799c821..3599615a 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -8,7 +8,7 @@ pub fn main() !void {
     const gpa = general_purpose_allocator.allocator();
     defer _ = general_purpose_allocator.deinit();
 
-    // List our fonts
+    // Initialize glfw
     try glfw.init(.{});
     defer glfw.terminate();
 

commit e672c9d7d51c65eeaf0eff2d330383ab7cf8ae1d
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Fri Apr 15 08:16:22 2022 -0700

    calculate grid size in dedicated struct, tests

diff --git a/src/main.zig b/src/main.zig
index 3599615a..432033cd 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -21,4 +21,5 @@ pub fn main() !void {
 test {
     _ = @import("Atlas.zig");
     _ = @import("FontAtlas.zig");
+    _ = @import("Grid.zig");
 }

commit 2cd51f0cc450fc05848201edbd777629a3c310ed
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Fri Apr 15 13:09:35 2022 -0700

    basic pty opening

diff --git a/src/main.zig b/src/main.zig
index 432033cd..4e65b823 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -22,4 +22,5 @@ test {
     _ = @import("Atlas.zig");
     _ = @import("FontAtlas.zig");
     _ = @import("Grid.zig");
+    _ = @import("Pty.zig");
 }

commit 992d52fe81a3c8c6bbaff18273db15bce6941499
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sat Apr 16 10:22:18 2022 -0700

    working on subprocessing

diff --git a/src/main.zig b/src/main.zig
index 4e65b823..c4edf99b 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -23,4 +23,5 @@ test {
     _ = @import("FontAtlas.zig");
     _ = @import("Grid.zig");
     _ = @import("Pty.zig");
+    _ = @import("Command.zig");
 }

commit 82a4aef1fa5d52631ee0d56ec9e421dc20a45afb
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sat Apr 16 11:07:27 2022 -0700

    TempDir implementation

diff --git a/src/main.zig b/src/main.zig
index c4edf99b..e3874e92 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -24,4 +24,5 @@ test {
     _ = @import("Grid.zig");
     _ = @import("Pty.zig");
     _ = @import("Command.zig");
+    _ = @import("TempDir.zig");
 }

commit dc788ce5b2ca24b3a97eb4d762dc0d3acde9e2ea
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sun Apr 17 09:40:09 2022 -0700

    terminal stuff

diff --git a/src/main.zig b/src/main.zig
index e3874e92..c7f94761 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -25,4 +25,5 @@ test {
     _ = @import("Pty.zig");
     _ = @import("Command.zig");
     _ = @import("TempDir.zig");
+    _ = @import("terminal/Terminal.zig");
 }

commit 21ee510471e75cbc778258e3fb90408f1d76198c
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Thu Apr 21 09:33:32 2022 -0700

    starting libuv bindings

diff --git a/src/main.zig b/src/main.zig
index c7f94761..36c492f2 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -26,4 +26,7 @@ test {
     _ = @import("Command.zig");
     _ = @import("TempDir.zig");
     _ = @import("terminal/Terminal.zig");
+
+    // TEMP
+    _ = @import("libuv/main.zig");
 }

commit a2a22791ee2472c5df0ca8ddcface3c1e45a58cb
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Tue Apr 26 16:18:34 2022 -0700

    SegmentedPool

diff --git a/src/main.zig b/src/main.zig
index 36c492f2..557aa85f 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -27,6 +27,7 @@ test {
     _ = @import("TempDir.zig");
     _ = @import("terminal/Terminal.zig");
 
-    // TEMP
+    // Libraries
+    _ = @import("segmented_pool.zig");
     _ = @import("libuv/main.zig");
 }

commit cbd6505d25b0ce8f5ebda6b8be7a97749db4df18
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Thu Apr 28 21:18:27 2022 -0700

    terminal: scrolling

diff --git a/src/main.zig b/src/main.zig
index 557aa85f..2c0aaa02 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -30,4 +30,5 @@ test {
     // Libraries
     _ = @import("segmented_pool.zig");
     _ = @import("libuv/main.zig");
+    _ = @import("terminal/main.zig");
 }

commit 10736e2eb422a8cb0b0e80e8965febc009727826
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Fri Apr 29 09:15:49 2022 -0700

    initial tracy support

diff --git a/src/main.zig b/src/main.zig
index 2c0aaa02..ac1076c5 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -1,9 +1,14 @@
+const options = @import("build_options");
 const std = @import("std");
 const glfw = @import("glfw");
 
 const App = @import("App.zig");
+const trace = @import("tracy/tracy.zig").trace;
 
 pub fn main() !void {
+    const tracy = trace(@src());
+    defer tracy.end();
+
     var general_purpose_allocator = std.heap.GeneralPurposeAllocator(.{}){};
     const gpa = general_purpose_allocator.allocator();
     defer _ = general_purpose_allocator.deinit();
@@ -18,6 +23,11 @@ pub fn main() !void {
     try app.run();
 }
 
+// Required by tracy/tracy.zig to enable/disable tracy support.
+pub fn tracy_enabled() bool {
+    return options.tracy_enabled;
+}
+
 test {
     _ = @import("Atlas.zig");
     _ = @import("FontAtlas.zig");

commit 330d2ea270fffc63123de42784897a088d8998b6
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Fri Apr 29 13:39:56 2022 -0700

    integrate tracy more deeply

diff --git a/src/main.zig b/src/main.zig
index ac1076c5..69feb796 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -6,9 +6,6 @@ const App = @import("App.zig");
 const trace = @import("tracy/tracy.zig").trace;
 
 pub fn main() !void {
-    const tracy = trace(@src());
-    defer tracy.end();
-
     var general_purpose_allocator = std.heap.GeneralPurposeAllocator(.{}){};
     const gpa = general_purpose_allocator.allocator();
     defer _ = general_purpose_allocator.deinit();

commit cfcc72e0e80d5356737b9110c7ea6fe4801ef726
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Fri Apr 29 14:37:16 2022 -0700

    tracy: support allocation wrapping

diff --git a/src/main.zig b/src/main.zig
index 69feb796..34f8c64c 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -3,19 +3,22 @@ const std = @import("std");
 const glfw = @import("glfw");
 
 const App = @import("App.zig");
-const trace = @import("tracy/tracy.zig").trace;
+const tracy = @import("tracy/tracy.zig");
 
 pub fn main() !void {
     var general_purpose_allocator = std.heap.GeneralPurposeAllocator(.{}){};
     const gpa = general_purpose_allocator.allocator();
     defer _ = general_purpose_allocator.deinit();
 
+    // If we're tracing, then wrap memory so we can trace allocations
+    const alloc = if (!tracy.enabled) gpa else tracy.allocator(gpa, null).allocator();
+
     // Initialize glfw
     try glfw.init(.{});
     defer glfw.terminate();
 
     // Run our app
-    var app = try App.init(gpa);
+    var app = try App.init(alloc);
     defer app.deinit();
     try app.run();
 }

commit 3b54d05aeca9b3fe1116a975e0c7df470722e0e6
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Thu May 19 14:00:35 2022 -0700

    CLI parsing, can set default foreground/background color

diff --git a/src/main.zig b/src/main.zig
index 34f8c64c..4ef31ce6 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -3,7 +3,9 @@ const std = @import("std");
 const glfw = @import("glfw");
 
 const App = @import("App.zig");
+const cli_args = @import("cli_args.zig");
 const tracy = @import("tracy/tracy.zig");
+const Config = @import("config.zig").Config;
 
 pub fn main() !void {
     var general_purpose_allocator = std.heap.GeneralPurposeAllocator(.{}){};
@@ -13,12 +15,21 @@ pub fn main() !void {
     // If we're tracing, then wrap memory so we can trace allocations
     const alloc = if (!tracy.enabled) gpa else tracy.allocator(gpa, null).allocator();
 
+    // Parse the config from the CLI args
+    const config = config: {
+        var result: Config = .{};
+        var iter = try std.process.argsWithAllocator(alloc);
+        defer iter.deinit();
+        try cli_args.parse(Config, &result, &iter);
+        break :config result;
+    };
+
     // Initialize glfw
     try glfw.init(.{});
     defer glfw.terminate();
 
     // Run our app
-    var app = try App.init(alloc);
+    var app = try App.init(alloc, &config);
     defer app.deinit();
     try app.run();
 }
@@ -41,4 +52,8 @@ test {
     _ = @import("segmented_pool.zig");
     _ = @import("libuv/main.zig");
     _ = @import("terminal/main.zig");
+
+    // TODO
+    _ = @import("config.zig");
+    _ = @import("cli_args.zig");
 }

commit da359b8e3664ded902d7287bcb9832e6db45de4f
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Thu May 19 15:49:26 2022 -0700

    properly copy string cli flags

diff --git a/src/main.zig b/src/main.zig
index 4ef31ce6..5d715b0b 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -16,13 +16,14 @@ pub fn main() !void {
     const alloc = if (!tracy.enabled) gpa else tracy.allocator(gpa, null).allocator();
 
     // Parse the config from the CLI args
-    const config = config: {
+    var config = config: {
         var result: Config = .{};
         var iter = try std.process.argsWithAllocator(alloc);
         defer iter.deinit();
-        try cli_args.parse(Config, &result, &iter);
+        try cli_args.parse(Config, alloc, &result, &iter);
         break :config result;
     };
+    defer config.deinit();
 
     // Initialize glfw
     try glfw.init(.{});

commit 7069917e6acd45f4192feaa974d99188e7547982
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Tue Jun 21 10:32:39 2022 -0700

    use c allocator in release modes if available

diff --git a/src/main.zig b/src/main.zig
index 5d715b0b..cdc3c3fb 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -1,3 +1,4 @@
+const builtin = @import("builtin");
 const options = @import("build_options");
 const std = @import("std");
 const glfw = @import("glfw");
@@ -8,9 +9,25 @@ const tracy = @import("tracy/tracy.zig");
 const Config = @import("config.zig").Config;
 
 pub fn main() !void {
-    var general_purpose_allocator = std.heap.GeneralPurposeAllocator(.{}){};
-    const gpa = general_purpose_allocator.allocator();
-    defer _ = general_purpose_allocator.deinit();
+    const gpa = gpa: {
+        // Use the libc allocator if it is available beacuse it is WAY
+        // faster than GPA. We only do this in release modes so that we
+        // can get easy memory leak detection in debug modes.
+        if (builtin.link_libc) {
+            switch (builtin.mode) {
+                .ReleaseSafe, .ReleaseFast => break :gpa std.heap.c_allocator,
+                else => {},
+            }
+        }
+
+        // We don't ever deinit our GPA because the process cleanup will
+        // clean it up. This defer isn't in the right location anyways because
+        // it'll deinit on return from blk.
+        // defer _ = general_purpose_allocator.deinit();
+
+        var general_purpose_allocator = std.heap.GeneralPurposeAllocator(.{}){};
+        break :gpa general_purpose_allocator.allocator();
+    };
 
     // If we're tracing, then wrap memory so we can trace allocations
     const alloc = if (!tracy.enabled) gpa else tracy.allocator(gpa, null).allocator();

commit 385a682b24e643f620a7c58e65a8cb134aee8ba0
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Tue Jun 28 10:31:11 2022 -0700

    move towards font family management to prep for bold/italic

diff --git a/src/main.zig b/src/main.zig
index cdc3c3fb..36f7fefb 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -59,11 +59,11 @@ pub fn tracy_enabled() bool {
 
 test {
     _ = @import("Atlas.zig");
-    _ = @import("FontAtlas.zig");
     _ = @import("Grid.zig");
     _ = @import("Pty.zig");
     _ = @import("Command.zig");
     _ = @import("TempDir.zig");
+    _ = @import("font/font.zig");
     _ = @import("terminal/Terminal.zig");
 
     // Libraries

commit 2453b40e5d5a503f744ff057f6576783f9520ed8
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Tue Jul 26 13:05:57 2022 -0700

    log glfw errors globally

diff --git a/src/main.zig b/src/main.zig
index 36f7fefb..be4b633d 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -8,6 +8,8 @@ const cli_args = @import("cli_args.zig");
 const tracy = @import("tracy/tracy.zig");
 const Config = @import("config.zig").Config;
 
+const log = std.log.scoped(.main);
+
 pub fn main() !void {
     const gpa = gpa: {
         // Use the libc allocator if it is available beacuse it is WAY
@@ -42,6 +44,9 @@ pub fn main() !void {
     };
     defer config.deinit();
 
+    // We want to log all our errors
+    glfw.setErrorCallback(glfwErrorCallback);
+
     // Initialize glfw
     try glfw.init(.{});
     defer glfw.terminate();
@@ -57,6 +62,10 @@ pub fn tracy_enabled() bool {
     return options.tracy_enabled;
 }
 
+fn glfwErrorCallback(code: glfw.Error, desc: [:0]const u8) void {
+    log.warn("glfw error={} message={s}", .{ code, desc });
+}
+
 test {
     _ = @import("Atlas.zig");
     _ = @import("Grid.zig");

commit 0249f3c174907ca8fdfe966c98c2a355d760e68f
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Mon Aug 1 11:54:51 2022 -0700

    cli parsing supports modification, add "RepeatableString" as example
    
    This lets values modify themselves, which we use to make a repeatable
    string implementation. We will use this initially to specify config
    files to load.

diff --git a/src/main.zig b/src/main.zig
index be4b633d..f958ebc0 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -43,6 +43,7 @@ pub fn main() !void {
         break :config result;
     };
     defer config.deinit();
+    log.info("config={}", .{config});
 
     // We want to log all our errors
     glfw.setErrorCallback(glfwErrorCallback);

commit 782ddfe722dd6aa145a72f5b7d85a347b59c0b26
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Mon Aug 1 18:04:39 2022 -0700

    --config-file to load a config file
    
    The config file is just CLI args one per line.

diff --git a/src/main.zig b/src/main.zig
index f958ebc0..d179f0f9 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -43,6 +43,22 @@ pub fn main() !void {
         break :config result;
     };
     defer config.deinit();
+
+    // Parse the config files
+    // TODO(mitchellh): support nesting (config-file in a config file)
+    // TODO(mitchellh): detect cycles when nesting
+    if (config.@"config-file".list.items.len > 0) {
+        const cwd = std.fs.cwd();
+        for (config.@"config-file".list.items) |path| {
+            var file = try cwd.openFile(path, .{});
+            defer file.close();
+
+            var buf_reader = std.io.bufferedReader(file.reader());
+            var iter = cli_args.lineIterator(buf_reader.reader());
+
+            try cli_args.parse(Config, alloc, &config, &iter);
+        }
+    }
     log.info("config={}", .{config});
 
     // We want to log all our errors

commit 84af11e1eb3fd88c64818feb58570886c74fc3a5
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Tue Aug 2 09:25:36 2022 -0700

    detect config file load in config file

diff --git a/src/main.zig b/src/main.zig
index d179f0f9..7ac52310 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -48,6 +48,7 @@ pub fn main() !void {
     // TODO(mitchellh): support nesting (config-file in a config file)
     // TODO(mitchellh): detect cycles when nesting
     if (config.@"config-file".list.items.len > 0) {
+        const len = config.@"config-file".list.items.len;
         const cwd = std.fs.cwd();
         for (config.@"config-file".list.items) |path| {
             var file = try cwd.openFile(path, .{});
@@ -57,6 +58,12 @@ pub fn main() !void {
             var iter = cli_args.lineIterator(buf_reader.reader());
 
             try cli_args.parse(Config, alloc, &config, &iter);
+
+            // We don't currently support adding more config files to load
+            // from within a loaded config file. This can be supported
+            // later.
+            if (config.@"config-file".list.items.len > len)
+                return error.ConfigFileInConfigFile;
         }
     }
     log.info("config={}", .{config});

commit b2192ea8f79167121df566d2b8f024e161da5368
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Tue Aug 16 17:47:44 2022 -0700

    move libuv into pkg

diff --git a/src/main.zig b/src/main.zig
index 7ac52310..576a489f 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -100,8 +100,8 @@ test {
     _ = @import("terminal/Terminal.zig");
 
     // Libraries
+    _ = @import("libuv");
     _ = @import("segmented_pool.zig");
-    _ = @import("libuv/main.zig");
     _ = @import("terminal/main.zig");
 
     // TODO

commit 2f36d5f715518e3f857c548c8c855164ab287f7e
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Wed Aug 17 14:03:49 2022 -0700

    pkg/tracy

diff --git a/src/main.zig b/src/main.zig
index 576a489f..212454f7 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -2,10 +2,10 @@ const builtin = @import("builtin");
 const options = @import("build_options");
 const std = @import("std");
 const glfw = @import("glfw");
+const tracy = @import("tracy");
 
 const App = @import("App.zig");
 const cli_args = @import("cli_args.zig");
-const tracy = @import("tracy/tracy.zig");
 const Config = @import("config.zig").Config;
 
 const log = std.log.scoped(.main);

commit a36ae221ae584dde5b786c251937f09a4f47228a
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Fri Aug 19 09:56:01 2022 -0700

    rename font/font.zig to font/main.zig

diff --git a/src/main.zig b/src/main.zig
index 212454f7..34987eab 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -96,7 +96,7 @@ test {
     _ = @import("Pty.zig");
     _ = @import("Command.zig");
     _ = @import("TempDir.zig");
-    _ = @import("font/font.zig");
+    _ = @import("font/main.zig");
     _ = @import("terminal/Terminal.zig");
 
     // Libraries

commit 5c61bfbe8fb69bc0358194cf0f87e26ae4e0b2c8
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sun Aug 21 21:38:24 2022 -0700

    fix stage2 compiler error

diff --git a/src/main.zig b/src/main.zig
index 34987eab..748d4f85 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -32,7 +32,10 @@ pub fn main() !void {
     };
 
     // If we're tracing, then wrap memory so we can trace allocations
-    const alloc = if (!tracy.enabled) gpa else tracy.allocator(gpa, null).allocator();
+    const alloc = if (!tracy.enabled) gpa else alloc: {
+        var tracy_alloc = tracy.allocator(gpa, null);
+        break :alloc tracy_alloc.allocator();
+    };
 
     // Parse the config from the CLI args
     var config = config: {

commit 7303909d0143f4f762eb4e07a89ab77ff0c607ce
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Tue Aug 23 17:40:36 2022 -0700

    key.Binding and basic parsing

diff --git a/src/main.zig b/src/main.zig
index 748d4f85..fcd839cc 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -110,4 +110,5 @@ test {
     // TODO
     _ = @import("config.zig");
     _ = @import("cli_args.zig");
+    _ = @import("key.zig");
 }

commit 222f70857a0b0670c2b84e8809e0592af4e1b51d
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Tue Aug 23 19:52:14 2022 -0700

    move input stuff to src/input

diff --git a/src/main.zig b/src/main.zig
index fcd839cc..282375cd 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -110,5 +110,5 @@ test {
     // TODO
     _ = @import("config.zig");
     _ = @import("cli_args.zig");
-    _ = @import("key.zig");
+    _ = @import("input.zig");
 }

commit 80376ce6da94e44d6d7e62ebc083ff32ae1b30ed
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Wed Aug 24 11:08:39 2022 -0700

    hook up keybindings for copy/paste and arrow keys

diff --git a/src/main.zig b/src/main.zig
index 282375cd..24fd0d8d 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -39,7 +39,8 @@ pub fn main() !void {
 
     // Parse the config from the CLI args
     var config = config: {
-        var result: Config = .{};
+        var result = try Config.default(alloc);
+        errdefer result.deinit();
         var iter = try std.process.argsWithAllocator(alloc);
         defer iter.deinit();
         try cli_args.parse(Config, alloc, &result, &iter);

commit 5713c2f468a1fd6cbf23345454438404efd78da1
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Wed Aug 24 11:17:28 2022 -0700

    move input test to qualified

diff --git a/src/main.zig b/src/main.zig
index 24fd0d8d..9585274f 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -102,6 +102,7 @@ test {
     _ = @import("TempDir.zig");
     _ = @import("font/main.zig");
     _ = @import("terminal/Terminal.zig");
+    _ = @import("input.zig");
 
     // Libraries
     _ = @import("libuv");
@@ -111,5 +112,4 @@ test {
     // TODO
     _ = @import("config.zig");
     _ = @import("cli_args.zig");
-    _ = @import("input.zig");
 }

commit 44dfe54fe87dd7c529e97b8c2bfc3b1d8bf677a8
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sun Aug 28 10:26:49 2022 -0700

    output harfbuzz version on startup

diff --git a/src/main.zig b/src/main.zig
index 9585274f..e1230f8a 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -2,6 +2,7 @@ const builtin = @import("builtin");
 const options = @import("build_options");
 const std = @import("std");
 const glfw = @import("glfw");
+const harfbuzz = @import("harfbuzz");
 const tracy = @import("tracy");
 
 const App = @import("App.zig");
@@ -11,6 +12,11 @@ const Config = @import("config.zig").Config;
 const log = std.log.scoped(.main);
 
 pub fn main() !void {
+    // Output some debug information right away
+    log.info("dependency versions harfbuzz={s}", .{
+        harfbuzz.versionString(),
+    });
+
     const gpa = gpa: {
         // Use the libc allocator if it is available beacuse it is WAY
         // faster than GPA. We only do this in release modes so that we

commit 7af90914971c02be9dc63cac281c8c10878d82d5
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sun Aug 28 17:07:27 2022 -0700

    pkg/freetype: Library and Face

diff --git a/src/main.zig b/src/main.zig
index e1230f8a..188ff1fe 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -2,6 +2,7 @@ const builtin = @import("builtin");
 const options = @import("build_options");
 const std = @import("std");
 const glfw = @import("glfw");
+const freetype = @import("freetype");
 const harfbuzz = @import("harfbuzz");
 const tracy = @import("tracy");
 

commit 4f6c67fe9d7c5922eecb5a9fbfd1968552fe1bc3
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Mon Sep 12 10:21:18 2022 -0700

    add LRU

diff --git a/src/main.zig b/src/main.zig
index 188ff1fe..53c401d2 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -119,4 +119,5 @@ test {
     // TODO
     _ = @import("config.zig");
     _ = @import("cli_args.zig");
+    _ = @import("lru.zig");
 }

commit 59191b05cd0711dfc54bbf1c1f900bab594b87a5
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Tue Sep 13 14:34:40 2022 -0700

    build fontconfig

diff --git a/src/main.zig b/src/main.zig
index 53c401d2..c01c6cbd 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -2,6 +2,7 @@ const builtin = @import("builtin");
 const options = @import("build_options");
 const std = @import("std");
 const glfw = @import("glfw");
+const fontconfig = @import("fontconfig");
 const freetype = @import("freetype");
 const harfbuzz = @import("harfbuzz");
 const tracy = @import("tracy");
@@ -14,9 +15,10 @@ const log = std.log.scoped(.main);
 
 pub fn main() !void {
     // Output some debug information right away
-    log.info("dependency versions harfbuzz={s}", .{
-        harfbuzz.versionString(),
-    });
+    log.info("dependency harfbuzz={s}", .{harfbuzz.versionString()});
+    if (builtin.os.tag == .linux) {
+        log.info("dependency fontconfig={d}", .{fontconfig.version()});
+    }
 
     const gpa = gpa: {
         // Use the libc allocator if it is available beacuse it is WAY

commit 141182aa1371f356b9c6115fc05eba64ff75894c
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Fri Sep 16 15:06:00 2022 -0700

    start adding fontconfig conditional compilation

diff --git a/src/main.zig b/src/main.zig
index c01c6cbd..b543215c 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -16,7 +16,7 @@ const log = std.log.scoped(.main);
 pub fn main() !void {
     // Output some debug information right away
     log.info("dependency harfbuzz={s}", .{harfbuzz.versionString()});
-    if (builtin.os.tag == .linux) {
+    if (options.fontconfig) {
         log.info("dependency fontconfig={d}", .{fontconfig.version()});
     }
 

commit de9731da1f372b2d9141657716cc513d22284b0b
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sun Oct 23 16:47:34 2022 -0700

    rename grid to a renderer, extract to subfolder
    
    "Grid" was a really antiquated name when it had both the screen state
    AND the renderering functionality tied together. This hasn't been true
    for a LONG time and it is long overdue that this is renamed to its
    proper name.
    
    This also begins setting up a folder structure to anticipate future
    renderers and rendering functionality. I'm not working on any alternate
    renderers right now so the interface isn't expected to be good, just
    laying out the files in this way.

diff --git a/src/main.zig b/src/main.zig
index b543215c..7371fb81 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -105,16 +105,15 @@ fn glfwErrorCallback(code: glfw.Error, desc: [:0]const u8) void {
 
 test {
     _ = @import("Atlas.zig");
-    _ = @import("Grid.zig");
     _ = @import("Pty.zig");
     _ = @import("Command.zig");
     _ = @import("TempDir.zig");
     _ = @import("font/main.zig");
+    _ = @import("renderer.zig");
     _ = @import("terminal/Terminal.zig");
     _ = @import("input.zig");
 
     // Libraries
-    _ = @import("libuv");
     _ = @import("segmented_pool.zig");
     _ = @import("terminal/main.zig");
 

commit cf14ea506f3c292db7d46ec4118958a3de1b0147
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Mon Oct 24 14:35:42 2022 -0700

    update zig

diff --git a/src/main.zig b/src/main.zig
index 7371fb81..990d1f35 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -99,6 +99,8 @@ pub fn tracy_enabled() bool {
     return options.tracy_enabled;
 }
 
+//pub const log_level: std.log.Level = .debug;
+
 fn glfwErrorCallback(code: glfw.Error, desc: [:0]const u8) void {
     log.warn("glfw error={} message={s}", .{ code, desc });
 }

commit 9ef431c632cb931ecaf1409e88a63217ba52df8a
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Mon Oct 24 15:34:30 2022 -0700

    use the c allocator when running under valgrind

diff --git a/src/main.zig b/src/main.zig
index 990d1f35..076b75e8 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -25,10 +25,13 @@ pub fn main() !void {
         // faster than GPA. We only do this in release modes so that we
         // can get easy memory leak detection in debug modes.
         if (builtin.link_libc) {
-            switch (builtin.mode) {
-                .ReleaseSafe, .ReleaseFast => break :gpa std.heap.c_allocator,
-                else => {},
-            }
+            if (switch (builtin.mode) {
+                .ReleaseSafe, .ReleaseFast => true,
+
+                // We also use it if we can detect we're running under
+                // Valgrind since Valgrind only instruments the C allocator
+                else => std.valgrind.runningOnValgrind() > 0,
+            }) break :gpa std.heap.c_allocator;
         }
 
         // We don't ever deinit our GPA because the process cleanup will

commit e7ffb823afc8ab4b840a6791637e2b96900afb64
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Tue Oct 25 15:49:21 2022 -0700

    propertly deinit the GPA so we can detect leaks in debug

diff --git a/src/main.zig b/src/main.zig
index 076b75e8..dd543d71 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -20,7 +20,8 @@ pub fn main() !void {
         log.info("dependency fontconfig={d}", .{fontconfig.version()});
     }
 
-    const gpa = gpa: {
+    const GPA = std.heap.GeneralPurposeAllocator(.{});
+    var gpa: ?GPA = gpa: {
         // Use the libc allocator if it is available beacuse it is WAY
         // faster than GPA. We only do this in release modes so that we
         // can get easy memory leak detection in debug modes.
@@ -31,21 +32,28 @@ pub fn main() !void {
                 // We also use it if we can detect we're running under
                 // Valgrind since Valgrind only instruments the C allocator
                 else => std.valgrind.runningOnValgrind() > 0,
-            }) break :gpa std.heap.c_allocator;
+            }) break :gpa null;
         }
 
-        // We don't ever deinit our GPA because the process cleanup will
-        // clean it up. This defer isn't in the right location anyways because
-        // it'll deinit on return from blk.
-        // defer _ = general_purpose_allocator.deinit();
-
-        var general_purpose_allocator = std.heap.GeneralPurposeAllocator(.{}){};
-        break :gpa general_purpose_allocator.allocator();
+        break :gpa GPA{};
+    };
+    defer if (gpa) |*value| {
+        // We want to ensure that we deinit the GPA because this is
+        // the point at which it will output if there were safety violations.
+        _ = value.deinit();
     };
 
-    // If we're tracing, then wrap memory so we can trace allocations
-    const alloc = if (!tracy.enabled) gpa else alloc: {
-        var tracy_alloc = tracy.allocator(gpa, null);
+    const alloc = alloc: {
+        const base = if (gpa) |*value|
+            value.allocator()
+        else if (builtin.link_libc)
+            std.heap.c_allocator
+        else
+            unreachable;
+
+        // If we're tracing, wrap the allocator
+        if (!tracy.enabled) break :alloc base;
+        var tracy_alloc = tracy.allocator(base, null);
         break :alloc tracy_alloc.allocator();
     };
 

commit 901ff199c8c0bc771cdd18e8776d7a9da41402db
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sun Oct 30 22:20:17 2022 -0700

    log the renderer on startup

diff --git a/src/main.zig b/src/main.zig
index dd543d71..ebfc68da 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -6,6 +6,7 @@ const fontconfig = @import("fontconfig");
 const freetype = @import("freetype");
 const harfbuzz = @import("harfbuzz");
 const tracy = @import("tracy");
+const renderer = @import("renderer.zig");
 
 const App = @import("App.zig");
 const cli_args = @import("cli_args.zig");
@@ -19,6 +20,7 @@ pub fn main() !void {
     if (options.fontconfig) {
         log.info("dependency fontconfig={d}", .{fontconfig.version()});
     }
+    log.info("renderer={}", .{renderer.Renderer});
 
     const GPA = std.heap.GeneralPurposeAllocator(.{});
     var gpa: ?GPA = gpa: {

commit 9e3bbc1598a335bfacb4e2f519e39cdf79ac5ae4
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Mon Oct 31 15:15:32 2022 -0700

    macos: send logs to unified logging

diff --git a/src/main.zig b/src/main.zig
index ebfc68da..ab85343f 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -5,6 +5,7 @@ const glfw = @import("glfw");
 const fontconfig = @import("fontconfig");
 const freetype = @import("freetype");
 const harfbuzz = @import("harfbuzz");
+const macos = @import("macos");
 const tracy = @import("tracy");
 const renderer = @import("renderer.zig");
 
@@ -12,15 +13,13 @@ const App = @import("App.zig");
 const cli_args = @import("cli_args.zig");
 const Config = @import("config.zig").Config;
 
-const log = std.log.scoped(.main);
-
 pub fn main() !void {
     // Output some debug information right away
-    log.info("dependency harfbuzz={s}", .{harfbuzz.versionString()});
+    std.log.info("dependency harfbuzz={s}", .{harfbuzz.versionString()});
     if (options.fontconfig) {
-        log.info("dependency fontconfig={d}", .{fontconfig.version()});
+        std.log.info("dependency fontconfig={d}", .{fontconfig.version()});
     }
-    log.info("renderer={}", .{renderer.Renderer});
+    std.log.info("renderer={}", .{renderer.Renderer});
 
     const GPA = std.heap.GeneralPurposeAllocator(.{});
     var gpa: ?GPA = gpa: {
@@ -92,7 +91,7 @@ pub fn main() !void {
                 return error.ConfigFileInConfigFile;
         }
     }
-    log.info("config={}", .{config});
+    std.log.info("config={}", .{config});
 
     // We want to log all our errors
     glfw.setErrorCallback(glfwErrorCallback);
@@ -112,10 +111,54 @@ pub fn tracy_enabled() bool {
     return options.tracy_enabled;
 }
 
-//pub const log_level: std.log.Level = .debug;
+// Our log level is always at least info in every build mode.
+pub const log_level: std.log.Level = switch (builtin.mode) {
+    .Debug => .debug,
+    else => .info,
+};
+
+// The function std.log will call.
+pub fn log(
+    comptime level: std.log.Level,
+    comptime scope: @TypeOf(.EnumLiteral),
+    comptime format: []const u8,
+    args: anytype,
+) void {
+    // Stuff we can do before the lock
+    const level_txt = comptime level.asText();
+    const prefix = if (scope == .default) ": " else "(" ++ @tagName(scope) ++ "): ";
+
+    // Lock so we are thread-safe
+    std.debug.getStderrMutex().lock();
+    defer std.debug.getStderrMutex().unlock();
+
+    // On Mac, we use unified logging. To view this:
+    //
+    //   sudo log stream --level debug --predicate 'subsystem=="com.mitchellh.ghostty"'
+    //
+    if (builtin.os.tag == .macos) {
+        // Convert our levels to Mac levels
+        const mac_level: macos.os.LogType = switch (level) {
+            .debug => .debug,
+            .info => .info,
+            .warn => .err,
+            .err => .fault,
+        };
+
+        // Initialize a logger. This is slow to do on every operation
+        // but we shouldn't be logging too much.
+        const logger = macos.os.Log.create("com.mitchellh.ghostty", @tagName(scope));
+        defer logger.release();
+        logger.log(std.heap.c_allocator, mac_level, format, args);
+    }
+
+    // Always try default to send to stderr
+    const stderr = std.io.getStdErr().writer();
+    nosuspend stderr.print(level_txt ++ prefix ++ format ++ "\n", args) catch return;
+}
 
 fn glfwErrorCallback(code: glfw.Error, desc: [:0]const u8) void {
-    log.warn("glfw error={} message={s}", .{ code, desc });
+    std.log.warn("glfw error={} message={s}", .{ code, desc });
 }
 
 test {

commit be1fa7851131b55465bd921dab09327f7a1d200a
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Tue Nov 1 17:47:34 2022 -0700

    extract passwd to its own file so its easier to test

diff --git a/src/main.zig b/src/main.zig
index ab85343f..9dd38844 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -177,6 +177,7 @@ test {
 
     // TODO
     _ = @import("config.zig");
+    _ = @import("passwd.zig");
     _ = @import("cli_args.zig");
     _ = @import("lru.zig");
 }

commit d75e869b4eca91fce08bb60d0d1e3f3a16547f7e
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Wed Nov 2 16:12:50 2022 -0700

    Load `$XDG_CONFIG_HOME/ghostty/config` if it exists (#25)
    
    Ghostty now loads the config file in `$XDG_CONFIG_HOME/ghostty/config` if it exists on startup. This follows the XDG base dir specification so if $XDG_CONFIG_HOME is not set, we default to `$HOME/.config/ghostty/config`.

diff --git a/src/main.zig b/src/main.zig
index 9dd38844..cd92fd76 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -8,6 +8,7 @@ const harfbuzz = @import("harfbuzz");
 const macos = @import("macos");
 const tracy = @import("tracy");
 const renderer = @import("renderer.zig");
+const xdg = @import("xdg.zig");
 
 const App = @import("App.zig");
 const cli_args = @import("cli_args.zig");
@@ -58,23 +59,48 @@ pub fn main() !void {
         break :alloc tracy_alloc.allocator();
     };
 
+    // Try reading our config
+    var config = try Config.default(alloc);
+    defer config.deinit();
+
+    // If we have a configuration file in our home directory, parse that first.
+    const cwd = std.fs.cwd();
+    {
+        const home_config_path = try xdg.config(alloc, .{ .subdir = "ghostty/config" });
+        defer alloc.free(home_config_path);
+
+        if (cwd.openFile(home_config_path, .{})) |file| {
+            defer file.close();
+
+            var buf_reader = std.io.bufferedReader(file.reader());
+            var iter = cli_args.lineIterator(buf_reader.reader());
+            try cli_args.parse(Config, alloc, &config, &iter);
+        } else |err| switch (err) {
+            error.FileNotFound => std.log.info(
+                "homedir config not found, not loading path={s}",
+                .{home_config_path},
+            ),
+
+            else => std.log.warn(
+                "error reading homedir config file, not loading err={} path={s}",
+                .{ err, home_config_path },
+            ),
+        }
+    }
+
     // Parse the config from the CLI args
-    var config = config: {
-        var result = try Config.default(alloc);
-        errdefer result.deinit();
+    {
         var iter = try std.process.argsWithAllocator(alloc);
         defer iter.deinit();
-        try cli_args.parse(Config, alloc, &result, &iter);
-        break :config result;
-    };
-    defer config.deinit();
+        try cli_args.parse(Config, alloc, &config, &iter);
+    }
 
-    // Parse the config files
+    // Parse the config files that were added from our file and CLI args.
+    // TODO(mitchellh): we should parse the files form the homedir first
     // TODO(mitchellh): support nesting (config-file in a config file)
     // TODO(mitchellh): detect cycles when nesting
     if (config.@"config-file".list.items.len > 0) {
         const len = config.@"config-file".list.items.len;
-        const cwd = std.fs.cwd();
         for (config.@"config-file".list.items) |path| {
             var file = try cwd.openFile(path, .{});
             defer file.close();
@@ -91,6 +117,7 @@ pub fn main() !void {
                 return error.ConfigFileInConfigFile;
         }
     }
+    try config.finalize();
     std.log.info("config={}", .{config});
 
     // We want to log all our errors
@@ -177,7 +204,9 @@ test {
 
     // TODO
     _ = @import("config.zig");
+    _ = @import("homedir.zig");
     _ = @import("passwd.zig");
+    _ = @import("xdg.zig");
     _ = @import("cli_args.zig");
     _ = @import("lru.zig");
 }

commit 8dd67662b32464671352cf9fe46f178109455168
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Thu Nov 3 10:51:55 2022 -0700

    Blocking queue implementation for thread message passing

diff --git a/src/main.zig b/src/main.zig
index cd92fd76..1f92efbe 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -203,6 +203,7 @@ test {
     _ = @import("terminal/main.zig");
 
     // TODO
+    _ = @import("blocking_queue.zig");
     _ = @import("config.zig");
     _ = @import("homedir.zig");
     _ = @import("passwd.zig");

commit 989046a06cda2b915e487b4bc63f8bb062eafcd3
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Fri Nov 4 22:13:37 2022 -0700

    More IO events

diff --git a/src/main.zig b/src/main.zig
index 1f92efbe..a985416c 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -196,6 +196,7 @@ test {
     _ = @import("font/main.zig");
     _ = @import("renderer.zig");
     _ = @import("terminal/Terminal.zig");
+    _ = @import("termio.zig");
     _ = @import("input.zig");
 
     // Libraries

commit ecbd119654e7846fb9931ad3445c9625a0f3414e
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sun Nov 6 10:34:43 2022 -0800

    Hook up new window, modify renderers

diff --git a/src/main.zig b/src/main.zig
index a985416c..41d03e5a 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -128,8 +128,8 @@ pub fn main() !void {
     defer glfw.terminate();
 
     // Run our app
-    var app = try App.init(alloc, &config);
-    defer app.deinit();
+    var app = try App.create(alloc, &config);
+    defer app.destroy();
     try app.run();
 }
 

commit 135b859b8f2033172455c860dc5683747b220543
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sun Nov 6 16:38:33 2022 -0800

    raise max file descriptors on launch

diff --git a/src/main.zig b/src/main.zig
index 41d03e5a..2346e24f 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -22,6 +22,9 @@ pub fn main() !void {
     }
     std.log.info("renderer={}", .{renderer.Renderer});
 
+    // First things first, we fix our file descriptors
+    fixMaxFiles();
+
     const GPA = std.heap.GeneralPurposeAllocator(.{});
     var gpa: ?GPA = gpa: {
         // Use the libc allocator if it is available beacuse it is WAY
@@ -188,6 +191,54 @@ fn glfwErrorCallback(code: glfw.Error, desc: [:0]const u8) void {
     std.log.warn("glfw error={} message={s}", .{ code, desc });
 }
 
+/// This maximizes the number of file descriptors we can have open. We
+/// need to do this because each window consumes at least a handful of fds.
+/// This is extracted from the Zig compiler source code.
+fn fixMaxFiles() void {
+    if (!@hasDecl(std.os.system, "rlimit")) return;
+    const posix = std.os;
+
+    var lim = posix.getrlimit(.NOFILE) catch {
+        std.log.warn("failed to query file handle limit, may limit max windows", .{});
+        return; // Oh well; we tried.
+    };
+    if (comptime builtin.target.isDarwin()) {
+        // On Darwin, `NOFILE` is bounded by a hardcoded value `OPEN_MAX`.
+        // According to the man pages for setrlimit():
+        //   setrlimit() now returns with errno set to EINVAL in places that historically succeeded.
+        //   It no longer accepts "rlim_cur = RLIM.INFINITY" for RLIM.NOFILE.
+        //   Use "rlim_cur = min(OPEN_MAX, rlim_max)".
+        lim.max = std.math.min(std.os.darwin.OPEN_MAX, lim.max);
+    }
+
+    // If we're already at the max, we're done.
+    if (lim.cur >= lim.max) {
+        std.log.debug("file handle limit already maximized value={}", .{lim.cur});
+        return;
+    }
+
+    // Do a binary search for the limit.
+    var min: posix.rlim_t = lim.cur;
+    var max: posix.rlim_t = 1 << 20;
+    // But if there's a defined upper bound, don't search, just set it.
+    if (lim.max != posix.RLIM.INFINITY) {
+        min = lim.max;
+        max = lim.max;
+    }
+
+    while (true) {
+        lim.cur = min + @divTrunc(max - min, 2); // on freebsd rlim_t is signed
+        if (posix.setrlimit(.NOFILE, lim)) |_| {
+            min = lim.cur;
+        } else |_| {
+            max = lim.cur;
+        }
+        if (min + 1 >= max) break;
+    }
+
+    std.log.debug("file handle limit raised value={}", .{lim.cur});
+}
+
 test {
     _ = @import("Atlas.zig");
     _ = @import("Pty.zig");

commit f39484541f80ef537a3de67a07811363ed222614
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Mon Nov 14 09:59:22 2022 -0800

    set system locale on startup, read Mac locale from OS preferences

diff --git a/src/main.zig b/src/main.zig
index 2346e24f..2b245baa 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -1,6 +1,6 @@
+const std = @import("std");
 const builtin = @import("builtin");
 const options = @import("build_options");
-const std = @import("std");
 const glfw = @import("glfw");
 const fontconfig = @import("fontconfig");
 const freetype = @import("freetype");
@@ -9,6 +9,7 @@ const macos = @import("macos");
 const tracy = @import("tracy");
 const renderer = @import("renderer.zig");
 const xdg = @import("xdg.zig");
+const internal_os = @import("os/main.zig");
 
 const App = @import("App.zig");
 const cli_args = @import("cli_args.zig");
@@ -23,7 +24,11 @@ pub fn main() !void {
     std.log.info("renderer={}", .{renderer.Renderer});
 
     // First things first, we fix our file descriptors
-    fixMaxFiles();
+    internal_os.fixMaxFiles();
+
+    // We need to make sure the process locale is set properly. Locale
+    // affects a lot of behaviors in a shell.
+    internal_os.ensureLocale();
 
     const GPA = std.heap.GeneralPurposeAllocator(.{});
     var gpa: ?GPA = gpa: {
@@ -191,54 +196,6 @@ fn glfwErrorCallback(code: glfw.Error, desc: [:0]const u8) void {
     std.log.warn("glfw error={} message={s}", .{ code, desc });
 }
 
-/// This maximizes the number of file descriptors we can have open. We
-/// need to do this because each window consumes at least a handful of fds.
-/// This is extracted from the Zig compiler source code.
-fn fixMaxFiles() void {
-    if (!@hasDecl(std.os.system, "rlimit")) return;
-    const posix = std.os;
-
-    var lim = posix.getrlimit(.NOFILE) catch {
-        std.log.warn("failed to query file handle limit, may limit max windows", .{});
-        return; // Oh well; we tried.
-    };
-    if (comptime builtin.target.isDarwin()) {
-        // On Darwin, `NOFILE` is bounded by a hardcoded value `OPEN_MAX`.
-        // According to the man pages for setrlimit():
-        //   setrlimit() now returns with errno set to EINVAL in places that historically succeeded.
-        //   It no longer accepts "rlim_cur = RLIM.INFINITY" for RLIM.NOFILE.
-        //   Use "rlim_cur = min(OPEN_MAX, rlim_max)".
-        lim.max = std.math.min(std.os.darwin.OPEN_MAX, lim.max);
-    }
-
-    // If we're already at the max, we're done.
-    if (lim.cur >= lim.max) {
-        std.log.debug("file handle limit already maximized value={}", .{lim.cur});
-        return;
-    }
-
-    // Do a binary search for the limit.
-    var min: posix.rlim_t = lim.cur;
-    var max: posix.rlim_t = 1 << 20;
-    // But if there's a defined upper bound, don't search, just set it.
-    if (lim.max != posix.RLIM.INFINITY) {
-        min = lim.max;
-        max = lim.max;
-    }
-
-    while (true) {
-        lim.cur = min + @divTrunc(max - min, 2); // on freebsd rlim_t is signed
-        if (posix.setrlimit(.NOFILE, lim)) |_| {
-            min = lim.cur;
-        } else |_| {
-            max = lim.cur;
-        }
-        if (min + 1 >= max) break;
-    }
-
-    std.log.debug("file handle limit raised value={}", .{lim.cur});
-}
-
 test {
     _ = @import("Atlas.zig");
     _ = @import("Pty.zig");

commit d213c1a939710a26672e4711bbb1337610f32a37
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sun Nov 20 20:05:07 2022 -0800

    fix selection regression caused by screen copy optimization

diff --git a/src/main.zig b/src/main.zig
index 2b245baa..00d198f7 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -203,7 +203,6 @@ test {
     _ = @import("TempDir.zig");
     _ = @import("font/main.zig");
     _ = @import("renderer.zig");
-    _ = @import("terminal/Terminal.zig");
     _ = @import("termio.zig");
     _ = @import("input.zig");
 

commit c2e2f69989fcc4f61e229aab21706422cd79abaf
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sun Nov 20 20:17:05 2022 -0800

    change config write to be debug

diff --git a/src/main.zig b/src/main.zig
index 00d198f7..b67dd5d5 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -126,7 +126,7 @@ pub fn main() !void {
         }
     }
     try config.finalize();
-    std.log.info("config={}", .{config});
+    std.log.debug("config={}", .{config});
 
     // We want to log all our errors
     glfw.setErrorCallback(glfwErrorCallback);

commit 9ae2df7bae2dc3d9dd2a145c2272e3282c0fdb6c
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Tue Nov 22 08:45:09 2022 -0800

    Don't crash when fn key pressed on mac (workaround upstream issue)

diff --git a/src/main.zig b/src/main.zig
index b67dd5d5..13fd654b 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -194,6 +194,16 @@ pub fn log(
 
 fn glfwErrorCallback(code: glfw.Error, desc: [:0]const u8) void {
     std.log.warn("glfw error={} message={s}", .{ code, desc });
+
+    // Workaround for: https://github.com/ocornut/imgui/issues/5908
+    // If we get an invalid value with "scancode" in the message we assume
+    // it is from the glfw key callback that imgui sets and we clear the
+    // error so that our future code doesn't crash.
+    if (code == glfw.Error.InvalidValue and
+        std.mem.indexOf(u8, desc, "scancode") != null)
+    {
+        glfw.errors.getError() catch {};
+    }
 }
 
 test {

commit f871630fa40e6dbe035d55376a90d33c4470e5f6
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Mon Nov 28 10:35:46 2022 -0800

    move Atlas to font

diff --git a/src/main.zig b/src/main.zig
index 13fd654b..fd25118f 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -207,7 +207,6 @@ fn glfwErrorCallback(code: glfw.Error, desc: [:0]const u8) void {
 }
 
 test {
-    _ = @import("Atlas.zig");
     _ = @import("Pty.zig");
     _ = @import("Command.zig");
     _ = @import("TempDir.zig");

commit 83f5d29ae2c87c06958737a026f7d8506561daaf
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Fri Dec 30 15:48:45 2022 -0800

    initialize glfw in app

diff --git a/src/main.zig b/src/main.zig
index fd25118f..8a74c085 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -131,10 +131,6 @@ pub fn main() !void {
     // We want to log all our errors
     glfw.setErrorCallback(glfwErrorCallback);
 
-    // Initialize glfw
-    try glfw.init(.{});
-    defer glfw.terminate();
-
     // Run our app
     var app = try App.create(alloc, &config);
     defer app.destroy();

commit e438539a145b49c85019f600dfa78230411b1125
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Thu Jan 26 09:10:09 2023 -0800

    Fix new log function options for zig

diff --git a/src/main.zig b/src/main.zig
index 8a74c085..89f7e9ef 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -142,51 +142,53 @@ pub fn tracy_enabled() bool {
     return options.tracy_enabled;
 }
 
-// Our log level is always at least info in every build mode.
-pub const log_level: std.log.Level = switch (builtin.mode) {
-    .Debug => .debug,
-    else => .info,
-};
+pub const std_options = struct {
+    // Our log level is always at least info in every build mode.
+    pub const log_level: std.log.Level = switch (builtin.mode) {
+        .Debug => .debug,
+        else => .info,
+    };
 
-// The function std.log will call.
-pub fn log(
-    comptime level: std.log.Level,
-    comptime scope: @TypeOf(.EnumLiteral),
-    comptime format: []const u8,
-    args: anytype,
-) void {
-    // Stuff we can do before the lock
-    const level_txt = comptime level.asText();
-    const prefix = if (scope == .default) ": " else "(" ++ @tagName(scope) ++ "): ";
-
-    // Lock so we are thread-safe
-    std.debug.getStderrMutex().lock();
-    defer std.debug.getStderrMutex().unlock();
-
-    // On Mac, we use unified logging. To view this:
-    //
-    //   sudo log stream --level debug --predicate 'subsystem=="com.mitchellh.ghostty"'
-    //
-    if (builtin.os.tag == .macos) {
-        // Convert our levels to Mac levels
-        const mac_level: macos.os.LogType = switch (level) {
-            .debug => .debug,
-            .info => .info,
-            .warn => .err,
-            .err => .fault,
-        };
-
-        // Initialize a logger. This is slow to do on every operation
-        // but we shouldn't be logging too much.
-        const logger = macos.os.Log.create("com.mitchellh.ghostty", @tagName(scope));
-        defer logger.release();
-        logger.log(std.heap.c_allocator, mac_level, format, args);
-    }
+    // The function std.log will call.
+    pub fn logFn(
+        comptime level: std.log.Level,
+        comptime scope: @TypeOf(.EnumLiteral),
+        comptime format: []const u8,
+        args: anytype,
+    ) void {
+        // Stuff we can do before the lock
+        const level_txt = comptime level.asText();
+        const prefix = if (scope == .default) ": " else "(" ++ @tagName(scope) ++ "): ";
+
+        // Lock so we are thread-safe
+        std.debug.getStderrMutex().lock();
+        defer std.debug.getStderrMutex().unlock();
+
+        // On Mac, we use unified logging. To view this:
+        //
+        //   sudo log stream --level debug --predicate 'subsystem=="com.mitchellh.ghostty"'
+        //
+        if (builtin.os.tag == .macos) {
+            // Convert our levels to Mac levels
+            const mac_level: macos.os.LogType = switch (level) {
+                .debug => .debug,
+                .info => .info,
+                .warn => .err,
+                .err => .fault,
+            };
+
+            // Initialize a logger. This is slow to do on every operation
+            // but we shouldn't be logging too much.
+            const logger = macos.os.Log.create("com.mitchellh.ghostty", @tagName(scope));
+            defer logger.release();
+            logger.log(std.heap.c_allocator, mac_level, format, args);
+        }
 
-    // Always try default to send to stderr
-    const stderr = std.io.getStdErr().writer();
-    nosuspend stderr.print(level_txt ++ prefix ++ format ++ "\n", args) catch return;
-}
+        // Always try default to send to stderr
+        const stderr = std.io.getStdErr().writer();
+        nosuspend stderr.print(level_txt ++ prefix ++ format ++ "\n", args) catch return;
+    }
+};
 
 fn glfwErrorCallback(code: glfw.Error, desc: [:0]const u8) void {
     std.log.warn("glfw error={} message={s}", .{ code, desc });

commit 11d6e9122845ab55d4e28d0114c7a24b1b4c0c76
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Mon Feb 6 14:52:24 2023 -0800

    termio: reader thread is thread-safe for writing to writer

diff --git a/src/main.zig b/src/main.zig
index 89f7e9ef..0fd4b1a7 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -7,6 +7,7 @@ const freetype = @import("freetype");
 const harfbuzz = @import("harfbuzz");
 const macos = @import("macos");
 const tracy = @import("tracy");
+const xev = @import("xev");
 const renderer = @import("renderer.zig");
 const xdg = @import("xdg.zig");
 const internal_os = @import("os/main.zig");
@@ -22,6 +23,7 @@ pub fn main() !void {
         std.log.info("dependency fontconfig={d}", .{fontconfig.version()});
     }
     std.log.info("renderer={}", .{renderer.Renderer});
+    std.log.info("libxev backend={}", .{xev.backend});
 
     // First things first, we fix our file descriptors
     internal_os.fixMaxFiles();

commit be75109a1dcc2add39f9b868f67f620728986717
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Tue Feb 14 20:58:33 2023 -0800

    new build system

diff --git a/src/main.zig b/src/main.zig
index 0fd4b1a7..61dc5e2b 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -192,17 +192,17 @@ pub const std_options = struct {
     }
 };
 
-fn glfwErrorCallback(code: glfw.Error, desc: [:0]const u8) void {
+fn glfwErrorCallback(code: glfw.ErrorCode, desc: [:0]const u8) void {
     std.log.warn("glfw error={} message={s}", .{ code, desc });
 
     // Workaround for: https://github.com/ocornut/imgui/issues/5908
     // If we get an invalid value with "scancode" in the message we assume
     // it is from the glfw key callback that imgui sets and we clear the
     // error so that our future code doesn't crash.
-    if (code == glfw.Error.InvalidValue and
+    if (code == glfw.ErrorCode.InvalidValue and
         std.mem.indexOf(u8, desc, "scancode") != null)
     {
-        glfw.errors.getError() catch {};
+        _ = glfw.getError();
     }
 }
 

commit 8b80e65928c8e38d9243d423eabdb164b7b1a4a0
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Tue Feb 14 13:56:43 2023 -0800

    lots of broken stuff

diff --git a/src/main.zig b/src/main.zig
index 61dc5e2b..dad323b3 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -16,58 +16,88 @@ const App = @import("App.zig");
 const cli_args = @import("cli_args.zig");
 const Config = @import("config.zig").Config;
 
-pub fn main() !void {
-    // Output some debug information right away
-    std.log.info("dependency harfbuzz={s}", .{harfbuzz.versionString()});
-    if (options.fontconfig) {
-        std.log.info("dependency fontconfig={d}", .{fontconfig.version()});
-    }
-    std.log.info("renderer={}", .{renderer.Renderer});
-    std.log.info("libxev backend={}", .{xev.backend});
-
-    // First things first, we fix our file descriptors
-    internal_os.fixMaxFiles();
+/// ProcessState represents the global process state. There should only
+/// be one of these at any given moment. This is extracted into a dedicated
+/// struct because it is reused by main and the static C lib.
+///
+/// ProcessState.init should be one of the first things ever called
+/// when using Ghostty. Ghostty calls this for you so this is more of a note
+/// for maintainers.
+pub const ProcessState = struct {
+    const GPA = std.heap.GeneralPurposeAllocator(.{});
 
-    // We need to make sure the process locale is set properly. Locale
-    // affects a lot of behaviors in a shell.
-    internal_os.ensureLocale();
+    gpa: ?GPA,
+    alloc: std.mem.Allocator,
 
-    const GPA = std.heap.GeneralPurposeAllocator(.{});
-    var gpa: ?GPA = gpa: {
-        // Use the libc allocator if it is available beacuse it is WAY
-        // faster than GPA. We only do this in release modes so that we
-        // can get easy memory leak detection in debug modes.
-        if (builtin.link_libc) {
-            if (switch (builtin.mode) {
-                .ReleaseSafe, .ReleaseFast => true,
-
-                // We also use it if we can detect we're running under
-                // Valgrind since Valgrind only instruments the C allocator
-                else => std.valgrind.runningOnValgrind() > 0,
-            }) break :gpa null;
+    pub fn init(self: *ProcessState) void {
+        // Output some debug information right away
+        std.log.info("dependency harfbuzz={s}", .{harfbuzz.versionString()});
+        if (options.fontconfig) {
+            std.log.info("dependency fontconfig={d}", .{fontconfig.version()});
         }
+        std.log.info("renderer={}", .{renderer.Renderer});
+        std.log.info("libxev backend={}", .{xev.backend});
+
+        // First things first, we fix our file descriptors
+        internal_os.fixMaxFiles();
+
+        // We need to make sure the process locale is set properly. Locale
+        // affects a lot of behaviors in a shell.
+        internal_os.ensureLocale();
+
+        // Initialize ourself to nothing so we don't have any extra state.
+        self.* = .{
+            .gpa = null,
+            .alloc = undefined,
+        };
+        errdefer self.deinit();
+
+        self.gpa = gpa: {
+            // Use the libc allocator if it is available beacuse it is WAY
+            // faster than GPA. We only do this in release modes so that we
+            // can get easy memory leak detection in debug modes.
+            if (builtin.link_libc) {
+                if (switch (builtin.mode) {
+                    .ReleaseSafe, .ReleaseFast => true,
+
+                    // We also use it if we can detect we're running under
+                    // Valgrind since Valgrind only instruments the C allocator
+                    else => std.valgrind.runningOnValgrind() > 0,
+                }) break :gpa null;
+            }
+
+            break :gpa GPA{};
+        };
+
+        self.alloc = alloc: {
+            const base = if (self.gpa) |*value|
+                value.allocator()
+            else if (builtin.link_libc)
+                std.heap.c_allocator
+            else
+                unreachable;
+
+            // If we're tracing, wrap the allocator
+            if (!tracy.enabled) break :alloc base;
+            var tracy_alloc = tracy.allocator(base, null);
+            break :alloc tracy_alloc.allocator();
+        };
+    }
 
-        break :gpa GPA{};
-    };
-    defer if (gpa) |*value| {
-        // We want to ensure that we deinit the GPA because this is
-        // the point at which it will output if there were safety violations.
-        _ = value.deinit();
-    };
+    pub fn deinit(self: *ProcessState) void {
+        if (self.gpa) |*value| {
+            // We want to ensure that we deinit the GPA because this is
+            // the point at which it will output if there were safety violations.
+            _ = value.deinit();
+        }
+    }
+};
 
-    const alloc = alloc: {
-        const base = if (gpa) |*value|
-            value.allocator()
-        else if (builtin.link_libc)
-            std.heap.c_allocator
-        else
-            unreachable;
-
-        // If we're tracing, wrap the allocator
-        if (!tracy.enabled) break :alloc base;
-        var tracy_alloc = tracy.allocator(base, null);
-        break :alloc tracy_alloc.allocator();
-    };
+pub fn main() !void {
+    var state: ProcessState = undefined;
+    ProcessState.init(&state);
+    defer state.deinit();
+    const alloc = state.alloc;
 
     // Try reading our config
     var config = try Config.default(alloc);

commit 9bd527fe00a89aa34f396e82609e8913c2410e31
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Tue Feb 14 15:53:28 2023 -0800

    macos: config API

diff --git a/src/main.zig b/src/main.zig
index dad323b3..b4b1b7ba 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -2,100 +2,17 @@ const std = @import("std");
 const builtin = @import("builtin");
 const options = @import("build_options");
 const glfw = @import("glfw");
-const fontconfig = @import("fontconfig");
-const freetype = @import("freetype");
-const harfbuzz = @import("harfbuzz");
 const macos = @import("macos");
-const tracy = @import("tracy");
-const xev = @import("xev");
-const renderer = @import("renderer.zig");
 const xdg = @import("xdg.zig");
-const internal_os = @import("os/main.zig");
 
 const App = @import("App.zig");
 const cli_args = @import("cli_args.zig");
 const Config = @import("config.zig").Config;
-
-/// ProcessState represents the global process state. There should only
-/// be one of these at any given moment. This is extracted into a dedicated
-/// struct because it is reused by main and the static C lib.
-///
-/// ProcessState.init should be one of the first things ever called
-/// when using Ghostty. Ghostty calls this for you so this is more of a note
-/// for maintainers.
-pub const ProcessState = struct {
-    const GPA = std.heap.GeneralPurposeAllocator(.{});
-
-    gpa: ?GPA,
-    alloc: std.mem.Allocator,
-
-    pub fn init(self: *ProcessState) void {
-        // Output some debug information right away
-        std.log.info("dependency harfbuzz={s}", .{harfbuzz.versionString()});
-        if (options.fontconfig) {
-            std.log.info("dependency fontconfig={d}", .{fontconfig.version()});
-        }
-        std.log.info("renderer={}", .{renderer.Renderer});
-        std.log.info("libxev backend={}", .{xev.backend});
-
-        // First things first, we fix our file descriptors
-        internal_os.fixMaxFiles();
-
-        // We need to make sure the process locale is set properly. Locale
-        // affects a lot of behaviors in a shell.
-        internal_os.ensureLocale();
-
-        // Initialize ourself to nothing so we don't have any extra state.
-        self.* = .{
-            .gpa = null,
-            .alloc = undefined,
-        };
-        errdefer self.deinit();
-
-        self.gpa = gpa: {
-            // Use the libc allocator if it is available beacuse it is WAY
-            // faster than GPA. We only do this in release modes so that we
-            // can get easy memory leak detection in debug modes.
-            if (builtin.link_libc) {
-                if (switch (builtin.mode) {
-                    .ReleaseSafe, .ReleaseFast => true,
-
-                    // We also use it if we can detect we're running under
-                    // Valgrind since Valgrind only instruments the C allocator
-                    else => std.valgrind.runningOnValgrind() > 0,
-                }) break :gpa null;
-            }
-
-            break :gpa GPA{};
-        };
-
-        self.alloc = alloc: {
-            const base = if (self.gpa) |*value|
-                value.allocator()
-            else if (builtin.link_libc)
-                std.heap.c_allocator
-            else
-                unreachable;
-
-            // If we're tracing, wrap the allocator
-            if (!tracy.enabled) break :alloc base;
-            var tracy_alloc = tracy.allocator(base, null);
-            break :alloc tracy_alloc.allocator();
-        };
-    }
-
-    pub fn deinit(self: *ProcessState) void {
-        if (self.gpa) |*value| {
-            // We want to ensure that we deinit the GPA because this is
-            // the point at which it will output if there were safety violations.
-            _ = value.deinit();
-        }
-    }
-};
+const Ghostty = @import("main_c.zig").Ghostty;
 
 pub fn main() !void {
-    var state: ProcessState = undefined;
-    ProcessState.init(&state);
+    var state: Ghostty = undefined;
+    Ghostty.init(&state);
     defer state.deinit();
     const alloc = state.alloc;
 

commit 26182611c616f6c5dd9f8bfb080c5b0c7a8c6729
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Wed Feb 15 15:38:51 2023 -0800

    move allocator to global state

diff --git a/src/main.zig b/src/main.zig
index b4b1b7ba..fc9b4d30 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -3,6 +3,12 @@ const builtin = @import("builtin");
 const options = @import("build_options");
 const glfw = @import("glfw");
 const macos = @import("macos");
+const tracy = @import("tracy");
+const internal_os = @import("os/main.zig");
+const xev = @import("xev");
+const fontconfig = @import("fontconfig");
+const harfbuzz = @import("harfbuzz");
+const renderer = @import("renderer.zig");
 const xdg = @import("xdg.zig");
 
 const App = @import("App.zig");
@@ -10,9 +16,14 @@ const cli_args = @import("cli_args.zig");
 const Config = @import("config.zig").Config;
 const Ghostty = @import("main_c.zig").Ghostty;
 
+/// Global process state. This is initialized in main() for exe artifacts
+/// and by ghostty_init() for lib artifacts. This should ONLY be used by
+/// the C API. The Zig API should NOT use any global state and should
+/// rely on allocators being passed in as parameters.
+pub var state: GlobalState = undefined;
+
 pub fn main() !void {
-    var state: Ghostty = undefined;
-    Ghostty.init(&state);
+    state.init();
     defer state.deinit();
     const alloc = state.alloc;
 
@@ -153,6 +164,80 @@ fn glfwErrorCallback(code: glfw.ErrorCode, desc: [:0]const u8) void {
     }
 }
 
+/// This represents the global process state. There should only
+/// be one of these at any given moment. This is extracted into a dedicated
+/// struct because it is reused by main and the static C lib.
+pub const GlobalState = struct {
+    const GPA = std.heap.GeneralPurposeAllocator(.{});
+
+    gpa: ?GPA,
+    alloc: std.mem.Allocator,
+
+    pub fn init(self: *GlobalState) void {
+        // Output some debug information right away
+        std.log.info("dependency harfbuzz={s}", .{harfbuzz.versionString()});
+        if (options.fontconfig) {
+            std.log.info("dependency fontconfig={d}", .{fontconfig.version()});
+        }
+        std.log.info("renderer={}", .{renderer.Renderer});
+        std.log.info("libxev backend={}", .{xev.backend});
+
+        // First things first, we fix our file descriptors
+        internal_os.fixMaxFiles();
+
+        // We need to make sure the process locale is set properly. Locale
+        // affects a lot of behaviors in a shell.
+        internal_os.ensureLocale();
+
+        // Initialize ourself to nothing so we don't have any extra state.
+        self.* = .{
+            .gpa = null,
+            .alloc = undefined,
+        };
+        errdefer self.deinit();
+
+        self.gpa = gpa: {
+            // Use the libc allocator if it is available beacuse it is WAY
+            // faster than GPA. We only do this in release modes so that we
+            // can get easy memory leak detection in debug modes.
+            if (builtin.link_libc) {
+                if (switch (builtin.mode) {
+                    .ReleaseSafe, .ReleaseFast => true,
+
+                    // We also use it if we can detect we're running under
+                    // Valgrind since Valgrind only instruments the C allocator
+                    else => std.valgrind.runningOnValgrind() > 0,
+                }) break :gpa null;
+            }
+
+            break :gpa GPA{};
+        };
+
+        self.alloc = alloc: {
+            const base = if (self.gpa) |*value|
+                value.allocator()
+            else if (builtin.link_libc)
+                std.heap.c_allocator
+            else
+                unreachable;
+
+            // If we're tracing, wrap the allocator
+            if (!tracy.enabled) break :alloc base;
+            var tracy_alloc = tracy.allocator(base, null);
+            break :alloc tracy_alloc.allocator();
+        };
+    }
+
+    /// Cleans up the global state. This doesn't _need_ to be called but
+    /// doing so in dev modes will check for memory leaks.
+    pub fn deinit(self: *GlobalState) void {
+        if (self.gpa) |*value| {
+            // We want to ensure that we deinit the GPA because this is
+            // the point at which it will output if there were safety violations.
+            _ = value.deinit();
+        }
+    }
+};
 test {
     _ = @import("Pty.zig");
     _ = @import("Command.zig");

commit ba8f142770a1103adc9ad799ffc566729af18972
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Wed Feb 15 21:53:14 2023 -0800

    app: only create first window in exe mode

diff --git a/src/main.zig b/src/main.zig
index fc9b4d30..24f0b76d 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -91,7 +91,7 @@ pub fn main() !void {
     // We want to log all our errors
     glfw.setErrorCallback(glfwErrorCallback);
 
-    // Run our app
+    // Run our app with a single initial window to start.
     var app = try App.create(alloc, &config);
     defer app.destroy();
     try app.run();

commit eed6979868573df6786406c568204bf02d01a27d
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Thu Feb 16 08:52:40 2023 -0800

    apprt: start embedded implement, make App API available to C

diff --git a/src/main.zig b/src/main.zig
index 24f0b76d..8ad3186b 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -92,7 +92,7 @@ pub fn main() !void {
     glfw.setErrorCallback(glfwErrorCallback);
 
     // Run our app with a single initial window to start.
-    var app = try App.create(alloc, &config);
+    var app = try App.create(alloc, .{}, &config);
     defer app.destroy();
     try app.run();
 }

commit 55b05b22bb9c3f83eafc55ab80f3819d741f68eb
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Fri Feb 17 12:31:35 2023 -0800

    c: create/destroy surface API

diff --git a/src/main.zig b/src/main.zig
index 8ad3186b..b84322af 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -94,6 +94,7 @@ pub fn main() !void {
     // Run our app with a single initial window to start.
     var app = try App.create(alloc, .{}, &config);
     defer app.destroy();
+    _ = try app.newWindow(.{});
     try app.run();
 }
 

commit d8dd0be32ae2c55c5fdf5b165a00482bdcf13f5d
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sun Feb 19 11:11:06 2023 -0800

    main: fix tracy allocator in GlobalState

diff --git a/src/main.zig b/src/main.zig
index b84322af..48c4d2a7 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -173,6 +173,7 @@ pub const GlobalState = struct {
 
     gpa: ?GPA,
     alloc: std.mem.Allocator,
+    tracy: if (tracy.enabled) ?tracy.Allocator(null) else void,
 
     pub fn init(self: *GlobalState) void {
         // Output some debug information right away
@@ -194,6 +195,7 @@ pub const GlobalState = struct {
         self.* = .{
             .gpa = null,
             .alloc = undefined,
+            .tracy = undefined,
         };
         errdefer self.deinit();
 
@@ -224,8 +226,8 @@ pub const GlobalState = struct {
 
             // If we're tracing, wrap the allocator
             if (!tracy.enabled) break :alloc base;
-            var tracy_alloc = tracy.allocator(base, null);
-            break :alloc tracy_alloc.allocator();
+            self.tracy = tracy.allocator(base, null);
+            break :alloc self.tracy.?.allocator();
         };
     }
 
@@ -237,6 +239,10 @@ pub const GlobalState = struct {
             // the point at which it will output if there were safety violations.
             _ = value.deinit();
         }
+
+        if (tracy.enabled) {
+            self.tracy = null;
+        }
     }
 };
 test {

commit 48c9c6591522c92296c3bf16d3dbdcec436378db
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Mon Feb 20 15:13:06 2023 -0800

    add app runtime option, add gtk backend

diff --git a/src/main.zig b/src/main.zig
index 48c4d2a7..ef75d1f7 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -1,5 +1,6 @@
 const std = @import("std");
 const builtin = @import("builtin");
+const build_config = @import("build_config.zig");
 const options = @import("build_options");
 const glfw = @import("glfw");
 const macos = @import("macos");
@@ -88,12 +89,19 @@ pub fn main() !void {
     try config.finalize();
     std.log.debug("config={}", .{config});
 
-    // We want to log all our errors
-    glfw.setErrorCallback(glfwErrorCallback);
+    switch (build_config.app_runtime) {
+        .none => {},
+        .glfw => {
+            // We want to log all our errors
+            glfw.setErrorCallback(glfwErrorCallback);
+        },
+        .gtk => {},
+    }
 
     // Run our app with a single initial window to start.
     var app = try App.create(alloc, .{}, &config);
     defer app.destroy();
+    if (build_config.app_runtime == .gtk) return;
     _ = try app.newWindow(.{});
     try app.run();
 }

commit f268f3955e4b64fcc201c1aec5a40a390ed35bf5
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Tue Feb 21 08:20:13 2023 -0800

    init gtk app

diff --git a/src/main.zig b/src/main.zig
index ef75d1f7..b880c211 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -101,9 +101,9 @@ pub fn main() !void {
     // Run our app with a single initial window to start.
     var app = try App.create(alloc, .{}, &config);
     defer app.destroy();
+    try app.run();
     if (build_config.app_runtime == .gtk) return;
     _ = try app.newWindow(.{});
-    try app.run();
 }
 
 // Required by tracy/tracy.zig to enable/disable tracy support.

commit d368b8e7278a0c6a844be592d5c7977bb88ddaf7
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Tue Feb 21 10:18:04 2023 -0800

    setup app, run works but crashes in OpenGL

diff --git a/src/main.zig b/src/main.zig
index b880c211..a29f1505 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -101,9 +101,8 @@ pub fn main() !void {
     // Run our app with a single initial window to start.
     var app = try App.create(alloc, .{}, &config);
     defer app.destroy();
-    try app.run();
-    if (build_config.app_runtime == .gtk) return;
     _ = try app.newWindow(.{});
+    try app.run();
 }
 
 // Required by tracy/tracy.zig to enable/disable tracy support.

commit 3d8c62c41ff673a5156388863db8f70680d3e05e
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Wed Feb 22 12:24:22 2023 -0800

    apprt refactor in progress, launches glfw no window

diff --git a/src/main.zig b/src/main.zig
index a29f1505..35c24ccb 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -11,6 +11,7 @@ const fontconfig = @import("fontconfig");
 const harfbuzz = @import("harfbuzz");
 const renderer = @import("renderer.zig");
 const xdg = @import("xdg.zig");
+const apprt = @import("apprt.zig");
 
 const App = @import("App.zig");
 const cli_args = @import("cli_args.zig");
@@ -89,18 +90,30 @@ pub fn main() !void {
     try config.finalize();
     std.log.debug("config={}", .{config});
 
-    switch (build_config.app_runtime) {
-        .none => {},
-        .glfw => {
-            // We want to log all our errors
-            glfw.setErrorCallback(glfwErrorCallback);
-        },
-        .gtk => {},
+    if (true) {
+        // Create our app state
+        var app = try App.create(alloc, &config);
+        defer app.destroy();
+
+        // Create our runtime app
+        var app_runtime = try apprt.App.init(app, .{});
+        defer app_runtime.terminate();
+
+        // Create an initial window
+
+        // Run the GUI event loop
+        try app_runtime.run();
+        return;
     }
 
     // Run our app with a single initial window to start.
     var app = try App.create(alloc, .{}, &config);
     defer app.destroy();
+    if (build_config.app_runtime == .gtk) {
+        try app.runtime.newWindow();
+        while (true) try app.runtime.wait();
+        return;
+    }
     _ = try app.newWindow(.{});
     try app.run();
 }
@@ -158,20 +171,6 @@ pub const std_options = struct {
     }
 };
 
-fn glfwErrorCallback(code: glfw.ErrorCode, desc: [:0]const u8) void {
-    std.log.warn("glfw error={} message={s}", .{ code, desc });
-
-    // Workaround for: https://github.com/ocornut/imgui/issues/5908
-    // If we get an invalid value with "scancode" in the message we assume
-    // it is from the glfw key callback that imgui sets and we clear the
-    // error so that our future code doesn't crash.
-    if (code == glfw.ErrorCode.InvalidValue and
-        std.mem.indexOf(u8, desc, "scancode") != null)
-    {
-        _ = glfw.getError();
-    }
-}
-
 /// This represents the global process state. There should only
 /// be one of these at any given moment. This is extracted into a dedicated
 /// struct because it is reused by main and the static C lib.

commit fbe35c226bf354d7c256d2bb5970f434d567889a
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Wed Feb 22 14:37:37 2023 -0800

    Integrating new surface

diff --git a/src/main.zig b/src/main.zig
index 35c24ccb..8d50d304 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -100,6 +100,7 @@ pub fn main() !void {
         defer app_runtime.terminate();
 
         // Create an initial window
+        try app_runtime.newWindow();
 
         // Run the GUI event loop
         try app_runtime.run();

commit 053748481aed950536692f4a2e2b5e86a3391489
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Wed Feb 22 15:16:17 2023 -0800

    more crap

diff --git a/src/main.zig b/src/main.zig
index 8d50d304..e7d0e7b1 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -100,7 +100,7 @@ pub fn main() !void {
         defer app_runtime.terminate();
 
         // Create an initial window
-        try app_runtime.newWindow();
+        _ = try app_runtime.newWindow();
 
         // Run the GUI event loop
         try app_runtime.run();

commit 2dda1d65a41093f43d34125ceee5d9249325346d
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Wed Feb 22 21:11:59 2023 -0800

    main update to new runtime API

diff --git a/src/main.zig b/src/main.zig
index e7d0e7b1..143fa0cc 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -90,33 +90,19 @@ pub fn main() !void {
     try config.finalize();
     std.log.debug("config={}", .{config});
 
-    if (true) {
-        // Create our app state
-        var app = try App.create(alloc, &config);
-        defer app.destroy();
-
-        // Create our runtime app
-        var app_runtime = try apprt.App.init(app, .{});
-        defer app_runtime.terminate();
+    // Create our app state
+    var app = try App.create(alloc, &config);
+    defer app.destroy();
 
-        // Create an initial window
-        _ = try app_runtime.newWindow();
+    // Create our runtime app
+    var app_runtime = try apprt.App.init(app, .{});
+    defer app_runtime.terminate();
 
-        // Run the GUI event loop
-        try app_runtime.run();
-        return;
-    }
+    // Create an initial window
+    _ = try app_runtime.newWindow();
 
-    // Run our app with a single initial window to start.
-    var app = try App.create(alloc, .{}, &config);
-    defer app.destroy();
-    if (build_config.app_runtime == .gtk) {
-        try app.runtime.newWindow();
-        while (true) try app.runtime.wait();
-        return;
-    }
-    _ = try app.newWindow(.{});
-    try app.run();
+    // Run the GUI event loop
+    try app_runtime.run();
 }
 
 // Required by tracy/tracy.zig to enable/disable tracy support.

commit fb13838532fed17ad0695728c776e4f2aefec32a
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Thu Feb 23 08:44:01 2023 -0800

    apprt newWindow/newTab do not have to return a surface

diff --git a/src/main.zig b/src/main.zig
index 143fa0cc..52447f45 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -99,7 +99,7 @@ pub fn main() !void {
     defer app_runtime.terminate();
 
     // Create an initial window
-    _ = try app_runtime.newWindow();
+    try app_runtime.newWindow(null);
 
     // Run the GUI event loop
     try app_runtime.run();

commit c8e0b0c6f377b18b9d079f89a65bfc9c1d52202d
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Thu Feb 23 21:34:17 2023 -0800

    don't log config its too noisy

diff --git a/src/main.zig b/src/main.zig
index 52447f45..7489d69f 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -88,7 +88,7 @@ pub fn main() !void {
         }
     }
     try config.finalize();
-    std.log.debug("config={}", .{config});
+    //std.log.debug("config={}", .{config});
 
     // Create our app state
     var app = try App.create(alloc, &config);

commit d1a1ba4cb67ece0cf0e6dcfb257086fb67d93b28
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sat Feb 25 15:09:26 2023 -0800

    output runtime at startup

diff --git a/src/main.zig b/src/main.zig
index 7489d69f..4c9c5ec7 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -170,6 +170,7 @@ pub const GlobalState = struct {
 
     pub fn init(self: *GlobalState) void {
         // Output some debug information right away
+        std.log.info("runtime={}", .{build_config.app_runtime});
         std.log.info("dependency harfbuzz={s}", .{harfbuzz.versionString()});
         if (options.fontconfig) {
             std.log.info("dependency fontconfig={d}", .{fontconfig.version()});

commit e775c434fbb99f5ac05be53fe204543619888143
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Thu Mar 2 21:22:37 2023 -0800

    add log when config file is successfully read

diff --git a/src/main.zig b/src/main.zig
index 4c9c5ec7..35f9626b 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -41,6 +41,7 @@ pub fn main() !void {
 
         if (cwd.openFile(home_config_path, .{})) |file| {
             defer file.close();
+            std.log.info("reading configuration file path={s}", .{home_config_path});
 
             var buf_reader = std.io.bufferedReader(file.reader());
             var iter = cli_args.lineIterator(buf_reader.reader());

commit d8537732dde396441db54aa72f858852a7bf0544
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Fri Mar 3 08:57:21 2023 -0800

    config: add functions to load from home and load configured

diff --git a/src/main.zig b/src/main.zig
index 35f9626b..5a256857 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -34,30 +34,7 @@ pub fn main() !void {
     defer config.deinit();
 
     // If we have a configuration file in our home directory, parse that first.
-    const cwd = std.fs.cwd();
-    {
-        const home_config_path = try xdg.config(alloc, .{ .subdir = "ghostty/config" });
-        defer alloc.free(home_config_path);
-
-        if (cwd.openFile(home_config_path, .{})) |file| {
-            defer file.close();
-            std.log.info("reading configuration file path={s}", .{home_config_path});
-
-            var buf_reader = std.io.bufferedReader(file.reader());
-            var iter = cli_args.lineIterator(buf_reader.reader());
-            try cli_args.parse(Config, alloc, &config, &iter);
-        } else |err| switch (err) {
-            error.FileNotFound => std.log.info(
-                "homedir config not found, not loading path={s}",
-                .{home_config_path},
-            ),
-
-            else => std.log.warn(
-                "error reading homedir config file, not loading err={} path={s}",
-                .{ err, home_config_path },
-            ),
-        }
-    }
+    try config.loadDefaultFiles(alloc);
 
     // Parse the config from the CLI args
     {
@@ -67,27 +44,7 @@ pub fn main() !void {
     }
 
     // Parse the config files that were added from our file and CLI args.
-    // TODO(mitchellh): we should parse the files form the homedir first
-    // TODO(mitchellh): support nesting (config-file in a config file)
-    // TODO(mitchellh): detect cycles when nesting
-    if (config.@"config-file".list.items.len > 0) {
-        const len = config.@"config-file".list.items.len;
-        for (config.@"config-file".list.items) |path| {
-            var file = try cwd.openFile(path, .{});
-            defer file.close();
-
-            var buf_reader = std.io.bufferedReader(file.reader());
-            var iter = cli_args.lineIterator(buf_reader.reader());
-
-            try cli_args.parse(Config, alloc, &config, &iter);
-
-            // We don't currently support adding more config files to load
-            // from within a loaded config file. This can be supported
-            // later.
-            if (config.@"config-file".list.items.len > len)
-                return error.ConfigFileInConfigFile;
-        }
-    }
+    try config.loadRecursive(alloc);
     try config.finalize();
     //std.log.debug("config={}", .{config});
 

commit 2a40bdabca96c7cc0a99b6c9c878da33d9fc7716
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Fri Mar 3 09:01:13 2023 -0800

    macos: load config file default file locations

diff --git a/src/main.zig b/src/main.zig
index 5a256857..af92726d 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -44,7 +44,7 @@ pub fn main() !void {
     }
 
     // Parse the config files that were added from our file and CLI args.
-    try config.loadRecursive(alloc);
+    try config.loadRecursiveFiles(alloc);
     try config.finalize();
     //std.log.debug("config={}", .{config});
 

commit 06035e2f953017ed0a84a4268ff7f71fb4584a0a
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sat Mar 4 10:50:13 2023 -0800

    can now use -Dfont-backend to choose the font backend to use

diff --git a/src/main.zig b/src/main.zig
index af92726d..5242e033 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -129,8 +129,9 @@ pub const GlobalState = struct {
     pub fn init(self: *GlobalState) void {
         // Output some debug information right away
         std.log.info("runtime={}", .{build_config.app_runtime});
+        std.log.info("font_backend={}", .{build_config.font_backend});
         std.log.info("dependency harfbuzz={s}", .{harfbuzz.versionString()});
-        if (options.fontconfig) {
+        if (comptime build_config.font_backend.hasFontconfig()) {
             std.log.info("dependency fontconfig={d}", .{fontconfig.version()});
         }
         std.log.info("renderer={}", .{renderer.Renderer});

commit 0907da4ebab8ef9dfa386e88bca8130869934b29
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sat Mar 4 20:34:15 2023 -0800

    build: generate a version number, show in log on startup

diff --git a/src/main.zig b/src/main.zig
index 5242e033..abd9dfde 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -128,6 +128,7 @@ pub const GlobalState = struct {
 
     pub fn init(self: *GlobalState) void {
         // Output some debug information right away
+        std.log.info("ghostty version={s}", .{build_config.version_string});
         std.log.info("runtime={}", .{build_config.app_runtime});
         std.log.info("font_backend={}", .{build_config.font_backend});
         std.log.info("dependency harfbuzz={s}", .{harfbuzz.versionString()});

commit 3ce7baf30e4540a8bfbc71b593638858ce9a797c
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sun Mar 12 22:03:20 2023 -0700

    config: dedicated load func so we can reload

diff --git a/src/main.zig b/src/main.zig
index abd9dfde..899f0494 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -30,22 +30,8 @@ pub fn main() !void {
     const alloc = state.alloc;
 
     // Try reading our config
-    var config = try Config.default(alloc);
+    var config = try Config.load(alloc);
     defer config.deinit();
-
-    // If we have a configuration file in our home directory, parse that first.
-    try config.loadDefaultFiles(alloc);
-
-    // Parse the config from the CLI args
-    {
-        var iter = try std.process.argsWithAllocator(alloc);
-        defer iter.deinit();
-        try cli_args.parse(Config, alloc, &config, &iter);
-    }
-
-    // Parse the config files that were added from our file and CLI args.
-    try config.loadRecursiveFiles(alloc);
-    try config.finalize();
     //std.log.debug("config={}", .{config});
 
     // Create our app state

commit 3e1f975551c2258b82dbc4bb747fef3a5d5d1910
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Mon Mar 13 21:44:45 2023 -0700

    move config loading into apprt to prep for reloading

diff --git a/src/main.zig b/src/main.zig
index 899f0494..9600a4a6 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -14,8 +14,6 @@ const xdg = @import("xdg.zig");
 const apprt = @import("apprt.zig");
 
 const App = @import("App.zig");
-const cli_args = @import("cli_args.zig");
-const Config = @import("config.zig").Config;
 const Ghostty = @import("main_c.zig").Ghostty;
 
 /// Global process state. This is initialized in main() for exe artifacts
@@ -29,13 +27,8 @@ pub fn main() !void {
     defer state.deinit();
     const alloc = state.alloc;
 
-    // Try reading our config
-    var config = try Config.load(alloc);
-    defer config.deinit();
-    //std.log.debug("config={}", .{config});
-
     // Create our app state
-    var app = try App.create(alloc, &config);
+    var app = try App.create(alloc);
     defer app.destroy();
 
     // Create our runtime app

commit 3ec8ce8063f48b63b4888a3382d4836f867446ff
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Fri Jun 23 19:22:16 2023 -0700

    terminfo: basic Source structure and can encode

diff --git a/src/main.zig b/src/main.zig
index 9600a4a6..f9160a28 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -190,6 +190,7 @@ test {
     // Libraries
     _ = @import("segmented_pool.zig");
     _ = @import("terminal/main.zig");
+    _ = @import("terminfo/main.zig");
 
     // TODO
     _ = @import("blocking_queue.zig");

commit 9a0d131b5b942164fc3029b8d7bb1f1d408bc011
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sun Jul 9 12:14:05 2023 -0700

    move TempDir to src/os and use the real tmpDir

diff --git a/src/main.zig b/src/main.zig
index f9160a28..d93683d0 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -181,7 +181,6 @@ pub const GlobalState = struct {
 test {
     _ = @import("Pty.zig");
     _ = @import("Command.zig");
-    _ = @import("TempDir.zig");
     _ = @import("font/main.zig");
     _ = @import("renderer.zig");
     _ = @import("termio.zig");

commit bf25bf0a6a6b506241eaff337e1f41628eee23b5
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Mon Jul 10 16:48:22 2023 -0700

    move a bunch of files to src/os

diff --git a/src/main.zig b/src/main.zig
index d93683d0..2ba800b0 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -10,7 +10,6 @@ const xev = @import("xev");
 const fontconfig = @import("fontconfig");
 const harfbuzz = @import("harfbuzz");
 const renderer = @import("renderer.zig");
-const xdg = @import("xdg.zig");
 const apprt = @import("apprt.zig");
 
 const App = @import("App.zig");
@@ -194,9 +193,6 @@ test {
     // TODO
     _ = @import("blocking_queue.zig");
     _ = @import("config.zig");
-    _ = @import("homedir.zig");
-    _ = @import("passwd.zig");
-    _ = @import("xdg.zig");
     _ = @import("cli_args.zig");
     _ = @import("lru.zig");
 }

commit 60a36ca5cc8e96658ad2349420f4076d21c65c76
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Mon Aug 7 19:26:57 2023 -0700

    apprt/gtk: enable single instance mode

diff --git a/src/main.zig b/src/main.zig
index 2ba800b0..1f030a15 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -34,9 +34,6 @@ pub fn main() !void {
     var app_runtime = try apprt.App.init(app, .{});
     defer app_runtime.terminate();
 
-    // Create an initial window
-    try app_runtime.newWindow(null);
-
     // Run the GUI event loop
     try app_runtime.run();
 }

commit 22b81731649bd1aca3e6fd33f215747d29ba1f72
Author: Kevin Hovster <kevin@hovsater.com>
Date:   Tue Aug 8 14:27:34 2023 +0200

    Fix typos

diff --git a/src/main.zig b/src/main.zig
index 1f030a15..8356f27b 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -129,7 +129,7 @@ pub const GlobalState = struct {
         errdefer self.deinit();
 
         self.gpa = gpa: {
-            // Use the libc allocator if it is available beacuse it is WAY
+            // Use the libc allocator if it is available because it is WAY
             // faster than GPA. We only do this in release modes so that we
             // can get easy memory leak detection in debug modes.
             if (builtin.link_libc) {

commit 2704b54bc58f8913aeecaf6d2fe25b22378957b5
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Wed Aug 9 15:18:22 2023 -0700

    warn if the binary is a debug build

diff --git a/src/main.zig b/src/main.zig
index 8356f27b..03603392 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -22,6 +22,12 @@ const Ghostty = @import("main_c.zig").Ghostty;
 pub var state: GlobalState = undefined;
 
 pub fn main() !void {
+    if (comptime builtin.mode == .Debug) {
+        std.log.warn("This is a debug build. Performance will be very poor.", .{});
+        std.log.warn("You should only use a debug build for developing Ghostty.", .{});
+        std.log.warn("Otherwise, please rebuild in a release mode.", .{});
+    }
+
     state.init();
     defer state.deinit();
     const alloc = state.alloc;

commit dbfedd240056001bf86e1b1121ab18dcc9fdc62a
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Fri Sep 15 09:17:58 2023 -0700

    Add --version for outputting version, framework for more actions

diff --git a/src/main.zig b/src/main.zig
index 03603392..da7eb665 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -1,10 +1,12 @@
 const std = @import("std");
 const builtin = @import("builtin");
+const Allocator = std.mem.Allocator;
 const build_config = @import("build_config.zig");
 const options = @import("build_options");
 const glfw = @import("glfw");
 const macos = @import("macos");
 const tracy = @import("tracy");
+const cli_action = @import("cli_action.zig");
 const internal_os = @import("os/main.zig");
 const xev = @import("xev");
 const fontconfig = @import("fontconfig");
@@ -32,6 +34,38 @@ pub fn main() !void {
     defer state.deinit();
     const alloc = state.alloc;
 
+    // Before we do anything else, we need to check for special commands
+    // via the CLI flags.
+    if (cli_action.Action.detectCLI(alloc)) |action_| {
+        if (action_) |action| {
+            std.log.info("executing CLI action={}", .{action});
+            std.os.exit(action.run(alloc) catch |err| err: {
+                std.log.err("CLI action failed error={}", .{err});
+                break :err 1;
+            });
+            return;
+        }
+    } else |err| {
+        const stderr = std.io.getStdErr().writer();
+        defer std.os.exit(1);
+        const ErrSet = @TypeOf(err) || error{Unknown};
+        switch (@as(ErrSet, @errSetCast(err))) {
+            error.MultipleActions => try stderr.print(
+                "Error: multiple CLI actions specified. You must specify only one\n" ++
+                    "action starting with the `+` character.\n",
+                .{},
+            ),
+
+            error.InvalidAction => try stderr.print(
+                "Error: unknown CLI action specified. CLI actions are specified with\n" ++
+                    "the '+' character.\n",
+                .{},
+            ),
+
+            else => try stderr.print("invalid CLI invocation err={}\n", .{err}),
+        }
+    }
+
     // Create our app state
     var app = try App.create(alloc);
     defer app.destroy();
@@ -187,6 +221,7 @@ test {
     _ = @import("renderer.zig");
     _ = @import("termio.zig");
     _ = @import("input.zig");
+    _ = @import("cli_action.zig");
 
     // Libraries
     _ = @import("segmented_pool.zig");

commit 26313bc85df85d027fa813a0252d0b7f2f1d374d
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Fri Sep 15 09:27:48 2023 -0700

    do not write logs to stderr for cli actions

diff --git a/src/main.zig b/src/main.zig
index da7eb665..3716d698 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -24,28 +24,11 @@ const Ghostty = @import("main_c.zig").Ghostty;
 pub var state: GlobalState = undefined;
 
 pub fn main() !void {
-    if (comptime builtin.mode == .Debug) {
-        std.log.warn("This is a debug build. Performance will be very poor.", .{});
-        std.log.warn("You should only use a debug build for developing Ghostty.", .{});
-        std.log.warn("Otherwise, please rebuild in a release mode.", .{});
-    }
-
-    state.init();
-    defer state.deinit();
-    const alloc = state.alloc;
-
-    // Before we do anything else, we need to check for special commands
-    // via the CLI flags.
-    if (cli_action.Action.detectCLI(alloc)) |action_| {
-        if (action_) |action| {
-            std.log.info("executing CLI action={}", .{action});
-            std.os.exit(action.run(alloc) catch |err| err: {
-                std.log.err("CLI action failed error={}", .{err});
-                break :err 1;
-            });
-            return;
-        }
-    } else |err| {
+    // We first start by initializing our global state. This will setup
+    // process-level state we need to run the terminal. The reason we use
+    // a global is because the C API needs to be able to access this state;
+    // no other Zig code should EVER access the global state.
+    state.init() catch |err| {
         const stderr = std.io.getStdErr().writer();
         defer std.os.exit(1);
         const ErrSet = @TypeOf(err) || error{Unknown};
@@ -64,6 +47,24 @@ pub fn main() !void {
 
             else => try stderr.print("invalid CLI invocation err={}\n", .{err}),
         }
+    };
+    defer state.deinit();
+    const alloc = state.alloc;
+
+    if (comptime builtin.mode == .Debug) {
+        std.log.warn("This is a debug build. Performance will be very poor.", .{});
+        std.log.warn("You should only use a debug build for developing Ghostty.", .{});
+        std.log.warn("Otherwise, please rebuild in a release mode.", .{});
+    }
+
+    // Execute our action if we have one
+    if (state.action) |action| {
+        std.log.info("executing CLI action={}", .{action});
+        std.os.exit(action.run(alloc) catch |err| err: {
+            std.log.err("CLI action failed error={}", .{err});
+            break :err 1;
+        });
+        return;
     }
 
     // Create our app state
@@ -125,6 +126,11 @@ pub const std_options = struct {
             logger.log(std.heap.c_allocator, mac_level, format, args);
         }
 
+        // If we have an action executing, we don't log to stderr.
+        // TODO(mitchellh): flag to enable logs
+        // TODO(mitchellh): flag to send logs to file
+        if (state.action != null) return;
+
         // Always try default to send to stderr
         const stderr = std.io.getStdErr().writer();
         nosuspend stderr.print(level_txt ++ prefix ++ format ++ "\n", args) catch return;
@@ -140,31 +146,17 @@ pub const GlobalState = struct {
     gpa: ?GPA,
     alloc: std.mem.Allocator,
     tracy: if (tracy.enabled) ?tracy.Allocator(null) else void,
+    action: ?cli_action.Action,
 
-    pub fn init(self: *GlobalState) void {
-        // Output some debug information right away
-        std.log.info("ghostty version={s}", .{build_config.version_string});
-        std.log.info("runtime={}", .{build_config.app_runtime});
-        std.log.info("font_backend={}", .{build_config.font_backend});
-        std.log.info("dependency harfbuzz={s}", .{harfbuzz.versionString()});
-        if (comptime build_config.font_backend.hasFontconfig()) {
-            std.log.info("dependency fontconfig={d}", .{fontconfig.version()});
-        }
-        std.log.info("renderer={}", .{renderer.Renderer});
-        std.log.info("libxev backend={}", .{xev.backend});
-
-        // First things first, we fix our file descriptors
-        internal_os.fixMaxFiles();
-
-        // We need to make sure the process locale is set properly. Locale
-        // affects a lot of behaviors in a shell.
-        internal_os.ensureLocale();
-
+    pub fn init(self: *GlobalState) !void {
         // Initialize ourself to nothing so we don't have any extra state.
+        // IMPORTANT: this MUST be initialized before any log output because
+        // the log function uses the global state.
         self.* = .{
             .gpa = null,
             .alloc = undefined,
             .tracy = undefined,
+            .action = null,
         };
         errdefer self.deinit();
 
@@ -198,6 +190,27 @@ pub const GlobalState = struct {
             self.tracy = tracy.allocator(base, null);
             break :alloc self.tracy.?.allocator();
         };
+
+        // We first try to parse any action that we may be executing.
+        self.action = try cli_action.Action.detectCLI(self.alloc);
+
+        // Output some debug information right away
+        std.log.info("ghostty version={s}", .{build_config.version_string});
+        std.log.info("runtime={}", .{build_config.app_runtime});
+        std.log.info("font_backend={}", .{build_config.font_backend});
+        std.log.info("dependency harfbuzz={s}", .{harfbuzz.versionString()});
+        if (comptime build_config.font_backend.hasFontconfig()) {
+            std.log.info("dependency fontconfig={d}", .{fontconfig.version()});
+        }
+        std.log.info("renderer={}", .{renderer.Renderer});
+        std.log.info("libxev backend={}", .{xev.backend});
+
+        // First things first, we fix our file descriptors
+        internal_os.fixMaxFiles();
+
+        // We need to make sure the process locale is set properly. Locale
+        // affects a lot of behaviors in a shell.
+        internal_os.ensureLocale();
     }
 
     /// Cleans up the global state. This doesn't _need_ to be called but

commit bcd88619c6d34c8c3e3899421565dfd1d6386078
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Fri Sep 15 12:15:12 2023 -0700

    can enable logging for CLI actions with GHOSTTY_LOG env var

diff --git a/src/main.zig b/src/main.zig
index 3716d698..936c167d 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -126,14 +126,15 @@ pub const std_options = struct {
             logger.log(std.heap.c_allocator, mac_level, format, args);
         }
 
-        // If we have an action executing, we don't log to stderr.
-        // TODO(mitchellh): flag to enable logs
-        // TODO(mitchellh): flag to send logs to file
-        if (state.action != null) return;
-
-        // Always try default to send to stderr
-        const stderr = std.io.getStdErr().writer();
-        nosuspend stderr.print(level_txt ++ prefix ++ format ++ "\n", args) catch return;
+        switch (state.logging) {
+            .disabled => {},
+
+            .stderr => {
+                // Always try default to send to stderr
+                const stderr = std.io.getStdErr().writer();
+                nosuspend stderr.print(level_txt ++ prefix ++ format ++ "\n", args) catch return;
+            },
+        }
     }
 };
 
@@ -147,6 +148,13 @@ pub const GlobalState = struct {
     alloc: std.mem.Allocator,
     tracy: if (tracy.enabled) ?tracy.Allocator(null) else void,
     action: ?cli_action.Action,
+    logging: Logging,
+
+    /// Where logging should go
+    pub const Logging = union(enum) {
+        disabled: void,
+        stderr: void,
+    };
 
     pub fn init(self: *GlobalState) !void {
         // Initialize ourself to nothing so we don't have any extra state.
@@ -157,6 +165,7 @@ pub const GlobalState = struct {
             .alloc = undefined,
             .tracy = undefined,
             .action = null,
+            .logging = .{ .stderr = {} },
         };
         errdefer self.deinit();
 
@@ -194,6 +203,22 @@ pub const GlobalState = struct {
         // We first try to parse any action that we may be executing.
         self.action = try cli_action.Action.detectCLI(self.alloc);
 
+        // If we have an action executing, we disable logging by default
+        // since we write to stderr we don't want logs messing up our
+        // output.
+        if (self.action != null) self.logging = .{ .disabled = {} };
+
+        // I don't love the env var name but I don't have it in my heart
+        // to parse CLI args 3 times (once for actions, once for config,
+        // maybe once for logging) so for now this is an easy way to do
+        // this. Env vars are useful for logging too because they are
+        // easy to set.
+        if (std.os.getenv("GHOSTTY_LOG")) |v| {
+            if (v.len > 0) {
+                self.logging = .{ .stderr = {} };
+            }
+        }
+
         // Output some debug information right away
         std.log.info("ghostty version={s}", .{build_config.version_string});
         std.log.info("runtime={}", .{build_config.app_runtime});

commit 23054dc393feac813c4cddecf59b164cd3e77e63
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Fri Sep 15 17:14:12 2023 -0700

    main: only check for CLI actions on non-lib builds

diff --git a/src/main.zig b/src/main.zig
index 936c167d..10a9d62a 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -201,12 +201,15 @@ pub const GlobalState = struct {
         };
 
         // We first try to parse any action that we may be executing.
-        self.action = try cli_action.Action.detectCLI(self.alloc);
-
-        // If we have an action executing, we disable logging by default
-        // since we write to stderr we don't want logs messing up our
-        // output.
-        if (self.action != null) self.logging = .{ .disabled = {} };
+        // We do not execute this in the lib because os.argv is not set.
+        if (comptime build_config.artifact != .lib) {
+            self.action = try cli_action.Action.detectCLI(self.alloc);
+
+            // If we have an action executing, we disable logging by default
+            // since we write to stderr we don't want logs messing up our
+            // output.
+            if (self.action != null) self.logging = .{ .disabled = {} };
+        }
 
         // I don't love the env var name but I don't have it in my heart
         // to parse CLI args 3 times (once for actions, once for config,

commit dcf615022ea7a9d6bee3683859cb312eccb59ec0
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Mon Sep 18 14:27:05 2023 -0700

    apprt/gtk: key file for logic related to keys

diff --git a/src/main.zig b/src/main.zig
index 10a9d62a..c61f94c5 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -259,6 +259,7 @@ test {
     _ = @import("Pty.zig");
     _ = @import("Command.zig");
     _ = @import("font/main.zig");
+    _ = @import("apprt.zig");
     _ = @import("renderer.zig");
     _ = @import("termio.zig");
     _ = @import("input.zig");

commit 7059b4f74d674e70590e65d7ad35921ea001521a
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Wed Sep 20 12:35:52 2023 -0700

    apprt/embedded: ghostty_cli_main

diff --git a/src/main.zig b/src/main.zig
index c61f94c5..37e35e49 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -23,7 +23,13 @@ const Ghostty = @import("main_c.zig").Ghostty;
 /// rely on allocators being passed in as parameters.
 pub var state: GlobalState = undefined;
 
-pub fn main() !void {
+/// The return type for main() depends on the build artifact.
+const MainReturn = switch (build_config.artifact) {
+    .lib => noreturn,
+    else => void,
+};
+
+pub fn main() !MainReturn {
     // We first start by initializing our global state. This will setup
     // process-level state we need to run the terminal. The reason we use
     // a global is because the C API needs to be able to access this state;
@@ -67,6 +73,24 @@ pub fn main() !void {
         return;
     }
 
+    if (comptime build_config.app_runtime == .none) {
+        const stdout = std.io.getStdOut().writer();
+        try stdout.print("Usage: ghostty +<action> [flags]\n\n", .{});
+        try stdout.print(
+            \\This is the Ghostty helper CLI that accompanies the graphical Ghostty app.
+            \\To launch the terminal directly, please launch the graphical app
+            \\(i.e. Ghostty.app on macOS). This CLI can be used to perform various
+            \\actions such as inspecting the version, listing fonts, etc.
+            \\
+            \\We don't have proper help output yet, sorry! Please refer to the
+            \\source code or Discord community for help for now. We'll fix this in time.
+        ,
+            .{},
+        );
+
+        std.os.exit(0);
+    }
+
     // Create our app state
     var app = try App.create(alloc);
     defer app.destroy();
@@ -156,6 +180,7 @@ pub const GlobalState = struct {
         stderr: void,
     };
 
+    /// Initialize the global state.
     pub fn init(self: *GlobalState) !void {
         // Initialize ourself to nothing so we don't have any extra state.
         // IMPORTANT: this MUST be initialized before any log output because
@@ -201,15 +226,12 @@ pub const GlobalState = struct {
         };
 
         // We first try to parse any action that we may be executing.
-        // We do not execute this in the lib because os.argv is not set.
-        if (comptime build_config.artifact != .lib) {
-            self.action = try cli_action.Action.detectCLI(self.alloc);
-
-            // If we have an action executing, we disable logging by default
-            // since we write to stderr we don't want logs messing up our
-            // output.
-            if (self.action != null) self.logging = .{ .disabled = {} };
-        }
+        self.action = try cli_action.Action.detectCLI(self.alloc);
+
+        // If we have an action executing, we disable logging by default
+        // since we write to stderr we don't want logs messing up our
+        // output.
+        if (self.action != null) self.logging = .{ .disabled = {} };
 
         // I don't love the env var name but I don't have it in my heart
         // to parse CLI args 3 times (once for actions, once for config,

commit 718c8d7ac88d609b1798e01c9e6846eafb0326a9
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Wed Sep 20 12:38:26 2023 -0700

    main: disable stderr logging by default for lib

diff --git a/src/main.zig b/src/main.zig
index 37e35e49..bd0a25bd 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -233,6 +233,11 @@ pub const GlobalState = struct {
         // output.
         if (self.action != null) self.logging = .{ .disabled = {} };
 
+        // For lib mode we always disable stderr logging by default.
+        if (comptime build_config.app_runtime == .none) {
+            self.logging = .{ .disabled = {} };
+        }
+
         // I don't love the env var name but I don't have it in my heart
         // to parse CLI args 3 times (once for actions, once for config,
         // maybe once for logging) so for now this is an easy way to do

commit 7fc66f3851f947ef1e80655d4cb61129bcc553ff
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sat Sep 23 22:42:09 2023 -0700

    cli: dedicated directory

diff --git a/src/main.zig b/src/main.zig
index bd0a25bd..e44c3f9d 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -6,7 +6,7 @@ const options = @import("build_options");
 const glfw = @import("glfw");
 const macos = @import("macos");
 const tracy = @import("tracy");
-const cli_action = @import("cli_action.zig");
+const cli = @import("cli.zig");
 const internal_os = @import("os/main.zig");
 const xev = @import("xev");
 const fontconfig = @import("fontconfig");
@@ -171,7 +171,7 @@ pub const GlobalState = struct {
     gpa: ?GPA,
     alloc: std.mem.Allocator,
     tracy: if (tracy.enabled) ?tracy.Allocator(null) else void,
-    action: ?cli_action.Action,
+    action: ?cli.Action,
     logging: Logging,
 
     /// Where logging should go
@@ -226,7 +226,7 @@ pub const GlobalState = struct {
         };
 
         // We first try to parse any action that we may be executing.
-        self.action = try cli_action.Action.detectCLI(self.alloc);
+        self.action = try cli.Action.detectCLI(self.alloc);
 
         // If we have an action executing, we disable logging by default
         // since we write to stderr we don't want logs messing up our
@@ -290,7 +290,7 @@ test {
     _ = @import("renderer.zig");
     _ = @import("termio.zig");
     _ = @import("input.zig");
-    _ = @import("cli_action.zig");
+    _ = @import("cli.zig");
 
     // Libraries
     _ = @import("segmented_pool.zig");

commit 9421bec3a1d17f4a8b63f5467f2d78f6e877545a
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sat Sep 23 22:46:16 2023 -0700

    cli: move cli_args.zig to cli

diff --git a/src/main.zig b/src/main.zig
index e44c3f9d..bcd3711b 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -300,6 +300,5 @@ test {
     // TODO
     _ = @import("blocking_queue.zig");
     _ = @import("config.zig");
-    _ = @import("cli_args.zig");
     _ = @import("lru.zig");
 }

commit 2b281068374eab491c92fa9b6ddb2cdd706001cd
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Mon Oct 2 08:17:42 2023 -0700

    update zig

diff --git a/src/main.zig b/src/main.zig
index bcd3711b..b697b05c 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -38,7 +38,7 @@ pub fn main() !MainReturn {
         const stderr = std.io.getStdErr().writer();
         defer std.os.exit(1);
         const ErrSet = @TypeOf(err) || error{Unknown};
-        switch (@as(ErrSet, @errSetCast(err))) {
+        switch (@as(ErrSet, @errorCast(err))) {
             error.MultipleActions => try stderr.print(
                 "Error: multiple CLI actions specified. You must specify only one\n" ++
                     "action starting with the `+` character.\n",

commit 4ed6112e6db56e0f210a0356dbfc89828f5ed557
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Mon Oct 23 12:18:23 2023 -0700

    move circular buffer to src/

diff --git a/src/main.zig b/src/main.zig
index b697b05c..4eadcefa 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -283,6 +283,7 @@ pub const GlobalState = struct {
     }
 };
 test {
+    _ = @import("circ_buf.zig");
     _ = @import("Pty.zig");
     _ = @import("Command.zig");
     _ = @import("font/main.zig");

commit 00ed6069f68fe48963051e4fb0c8c056e5665946
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Mon Oct 23 14:46:10 2023 -0700

    inspector: render basic key inspector

diff --git a/src/main.zig b/src/main.zig
index 4eadcefa..af669de9 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -295,6 +295,7 @@ test {
 
     // Libraries
     _ = @import("segmented_pool.zig");
+    _ = @import("inspector/main.zig");
     _ = @import("terminal/main.zig");
     _ = @import("terminfo/main.zig");
 

commit 232df8de8ff23ca6f3bd65516224df0f80ddf6ad
Author: kcbanner <kcbanner@gmail.com>
Date:   Sun Oct 29 04:03:06 2023 -0400

    windows: add support for the glfw backend on Windows
    
    Changes:
    - Add WindowsPty, which uses the ConPTY API to create a pseudo console
    - Pty now selects between PosixPty and WindowsPty
    - Windows support in Command, including the ability to launch a process with a pseudo console
    - Enable Command tests on windows
    - Add some environment variable abstractions to handle the missing libc APIs on Windows
    - Windows version of ReadThread

diff --git a/src/main.zig b/src/main.zig
index af669de9..e7dd6c63 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -243,7 +243,8 @@ pub const GlobalState = struct {
         // maybe once for logging) so for now this is an easy way to do
         // this. Env vars are useful for logging too because they are
         // easy to set.
-        if (std.os.getenv("GHOSTTY_LOG")) |v| {
+        if ((try internal_os.getEnvVarOwned(self.alloc, "GHOSTTY_LOG"))) |v| {
+            defer self.alloc.free(v);
             if (v.len > 0) {
                 self.logging = .{ .stderr = {} };
             }
@@ -265,7 +266,7 @@ pub const GlobalState = struct {
 
         // We need to make sure the process locale is set properly. Locale
         // affects a lot of behaviors in a shell.
-        internal_os.ensureLocale();
+        try internal_os.ensureLocale(self.alloc);
     }
 
     /// Cleans up the global state. This doesn't _need_ to be called but

commit 8f35d5251e8417556e397ad0f4f1d9aa3f0e10ae
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sun Nov 5 15:39:25 2023 -0800

    os: rename env to be posix-like, do not allocate on posix

diff --git a/src/main.zig b/src/main.zig
index e7dd6c63..17ec5b0f 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -243,9 +243,9 @@ pub const GlobalState = struct {
         // maybe once for logging) so for now this is an easy way to do
         // this. Env vars are useful for logging too because they are
         // easy to set.
-        if ((try internal_os.getEnvVarOwned(self.alloc, "GHOSTTY_LOG"))) |v| {
-            defer self.alloc.free(v);
-            if (v.len > 0) {
+        if ((try internal_os.getenv(self.alloc, "GHOSTTY_LOG"))) |v| {
+            defer v.deinit(self.alloc);
+            if (v.value.len > 0) {
                 self.logging = .{ .stderr = {} };
             }
         }

commit 74b840df8e18f9d82932ac538b0a1e485b360eae
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sun Nov 5 23:41:45 2023 +0000

    rename Pty.zig to pty.zig

diff --git a/src/main.zig b/src/main.zig
index 17ec5b0f..16ad70ef 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -285,7 +285,7 @@ pub const GlobalState = struct {
 };
 test {
     _ = @import("circ_buf.zig");
-    _ = @import("Pty.zig");
+    _ = @import("pty.zig");
     _ = @import("Command.zig");
     _ = @import("font/main.zig");
     _ = @import("apprt.zig");

commit 1e572fb10b4c29e6b060269c8e272105173824a1
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Thu Nov 16 15:19:54 2023 -0800

    renderer/metal: load custom shaders

diff --git a/src/main.zig b/src/main.zig
index 16ad70ef..3ef42d13 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -4,6 +4,7 @@ const Allocator = std.mem.Allocator;
 const build_config = @import("build_config.zig");
 const options = @import("build_options");
 const glfw = @import("glfw");
+const glslang = @import("glslang");
 const macos = @import("macos");
 const tracy = @import("tracy");
 const cli = @import("cli.zig");
@@ -267,6 +268,9 @@ pub const GlobalState = struct {
         // We need to make sure the process locale is set properly. Locale
         // affects a lot of behaviors in a shell.
         try internal_os.ensureLocale(self.alloc);
+
+        // Initialize glslang for shader compilation
+        try glslang.init();
     }
 
     /// Cleans up the global state. This doesn't _need_ to be called but

commit 45a4be68736aebb23d9bac5c7f7ab72dcadf5bc0
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Wed Nov 22 21:12:01 2023 -0800

    core: move resources dir to main global state

diff --git a/src/main.zig b/src/main.zig
index 3ef42d13..6d8ac9ad 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -175,6 +175,10 @@ pub const GlobalState = struct {
     action: ?cli.Action,
     logging: Logging,
 
+    /// The app resources directory, equivalent to zig-out/share when we build
+    /// from source. This is null if we can't detect it.
+    resources_dir: ?[]const u8,
+
     /// Where logging should go
     pub const Logging = union(enum) {
         disabled: void,
@@ -192,6 +196,7 @@ pub const GlobalState = struct {
             .tracy = undefined,
             .action = null,
             .logging = .{ .stderr = {} },
+            .resources_dir = null,
         };
         errdefer self.deinit();
 
@@ -271,11 +276,18 @@ pub const GlobalState = struct {
 
         // Initialize glslang for shader compilation
         try glslang.init();
+
+        // Find our resources directory once for the app so every launch
+        // hereafter can use this cached value.
+        self.resources_dir = try internal_os.resourcesDir(self.alloc);
+        errdefer if (self.resources_dir) |dir| self.alloc.free(dir);
     }
 
     /// Cleans up the global state. This doesn't _need_ to be called but
     /// doing so in dev modes will check for memory leaks.
     pub fn deinit(self: *GlobalState) void {
+        if (self.resources_dir) |dir| self.alloc.free(dir);
+
         if (self.gpa) |*value| {
             // We want to ensure that we deinit the GPA because this is
             // the point at which it will output if there were safety violations.

commit 5db002cb12e876381a653789bb27dfea128ca2f1
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sun Nov 26 12:51:25 2023 -0800

    renderer/metal: underline urls

diff --git a/src/main.zig b/src/main.zig
index 6d8ac9ad..91167e72 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -6,6 +6,7 @@ const options = @import("build_options");
 const glfw = @import("glfw");
 const glslang = @import("glslang");
 const macos = @import("macos");
+const oni = @import("oniguruma");
 const tracy = @import("tracy");
 const cli = @import("cli.zig");
 const internal_os = @import("os/main.zig");
@@ -277,6 +278,9 @@ pub const GlobalState = struct {
         // Initialize glslang for shader compilation
         try glslang.init();
 
+        // Initialize oniguruma for regex
+        try oni.init(&.{oni.Encoding.utf8});
+
         // Find our resources directory once for the app so every launch
         // hereafter can use this cached value.
         self.resources_dir = try internal_os.resourcesDir(self.alloc);

commit 6e8ed4e8b37919e7f17d46f9260d78ed1ce0874f
Author: Chris Marchesi <chrism@vancluevertech.com>
Date:   Fri Dec 1 12:15:43 2023 -0800

    Surface: set crosshair, change event processing logic for mouse tracking
    
    This work is mainly targeted at adding the crosshair for when
    ctrl/super+alt is pressed. We also add this for when mouse tracking is
    enabled so that we show the crosshair when ctrl/super+alt+shift is
    pressed at the same time.
    
    I've also changed the event processing logic here because the amount of
    keys we have to process has greatly increased. Instead of processing
    each individual event, we now process the modifier state.
    
    Additionally, some refactoring has been done geared at starting to
    re-work the mouse for the core surface into a something stateful. My
    hope is that we can continue to unravel some of this from the core
    surface so that we can process key inputs, motion events, and anything
    else relevant as inputs to transitions for shape display, click
    behavior, etc.
    
    This commit now also moves the ctrlOrSuper handlers to respective parts
    in the Key hierarchy, while also adding additional helpers for other
    modifiers.

diff --git a/src/main.zig b/src/main.zig
index 91167e72..66e39131 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -313,6 +313,7 @@ test {
     _ = @import("termio.zig");
     _ = @import("input.zig");
     _ = @import("cli.zig");
+    _ = @import("surface_mouse.zig");
 
     // Libraries
     _ = @import("segmented_pool.zig");

commit 29717269cabb2adc97e2e278b545f211bc0376da
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sat Jan 13 14:30:56 2024 -0800

    build: remove tracy completely

diff --git a/src/main.zig b/src/main.zig
index 66e39131..74690a27 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -105,11 +105,6 @@ pub fn main() !MainReturn {
     try app_runtime.run();
 }
 
-// Required by tracy/tracy.zig to enable/disable tracy support.
-pub fn tracy_enabled() bool {
-    return options.tracy_enabled;
-}
-
 pub const std_options = struct {
     // Our log level is always at least info in every build mode.
     pub const log_level: std.log.Level = switch (builtin.mode) {

commit adb7958f6177dfe5df69bc2202da98c566f389b9
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sat Jan 13 15:06:08 2024 -0800

    remove tracy usage from all files

diff --git a/src/main.zig b/src/main.zig
index 74690a27..a761f359 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -7,7 +7,6 @@ const glfw = @import("glfw");
 const glslang = @import("glslang");
 const macos = @import("macos");
 const oni = @import("oniguruma");
-const tracy = @import("tracy");
 const cli = @import("cli.zig");
 const internal_os = @import("os/main.zig");
 const xev = @import("xev");
@@ -167,7 +166,6 @@ pub const GlobalState = struct {
 
     gpa: ?GPA,
     alloc: std.mem.Allocator,
-    tracy: if (tracy.enabled) ?tracy.Allocator(null) else void,
     action: ?cli.Action,
     logging: Logging,
 
@@ -189,7 +187,6 @@ pub const GlobalState = struct {
         self.* = .{
             .gpa = null,
             .alloc = undefined,
-            .tracy = undefined,
             .action = null,
             .logging = .{ .stderr = {} },
             .resources_dir = null,
@@ -213,19 +210,12 @@ pub const GlobalState = struct {
             break :gpa GPA{};
         };
 
-        self.alloc = alloc: {
-            const base = if (self.gpa) |*value|
-                value.allocator()
-            else if (builtin.link_libc)
-                std.heap.c_allocator
-            else
-                unreachable;
-
-            // If we're tracing, wrap the allocator
-            if (!tracy.enabled) break :alloc base;
-            self.tracy = tracy.allocator(base, null);
-            break :alloc self.tracy.?.allocator();
-        };
+        self.alloc = if (self.gpa) |*value|
+            value.allocator()
+        else if (builtin.link_libc)
+            std.heap.c_allocator
+        else
+            unreachable;
 
         // We first try to parse any action that we may be executing.
         self.action = try cli.Action.detectCLI(self.alloc);
@@ -292,10 +282,6 @@ pub const GlobalState = struct {
             // the point at which it will output if there were safety violations.
             _ = value.deinit();
         }
-
-        if (tracy.enabled) {
-            self.tracy = null;
-        }
     }
 };
 test {

commit 8c8838542f508d5fec910fa5d3e1d6e9a89cb734
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sun Jan 14 14:48:39 2024 -0800

    use Apple logging subsystem on all Darwin targets

diff --git a/src/main.zig b/src/main.zig
index a761f359..fe3c2492 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -130,7 +130,7 @@ pub const std_options = struct {
         //
         //   sudo log stream --level debug --predicate 'subsystem=="com.mitchellh.ghostty"'
         //
-        if (builtin.os.tag == .macos) {
+        if (builtin.target.isDarwin()) {
             // Convert our levels to Mac levels
             const mac_level: macos.os.LogType = switch (level) {
                 .debug => .debug,

commit 1f2b30496bee223a78548e1f1468343d5aab05ce
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sun Feb 4 20:04:18 2024 -0800

    move mdgen main to build dir

diff --git a/src/main.zig b/src/main.zig
index fe3c2492..9038fc35 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -24,13 +24,26 @@ const Ghostty = @import("main_c.zig").Ghostty;
 /// rely on allocators being passed in as parameters.
 pub var state: GlobalState = undefined;
 
-/// The return type for main() depends on the build artifact.
+/// The return type for main() depends on the build artifact. The lib build
+/// also calls "main" in order to run the CLI actions, but it calls it as
+/// an API and not an entrypoint.
 const MainReturn = switch (build_config.artifact) {
     .lib => noreturn,
     else => void,
 };
 
 pub fn main() !MainReturn {
+    // Load the proper main() function based on build config.
+    if (comptime build_config.artifact == .exe) entrypoint: {
+        switch (comptime build_config.exe_entrypoint) {
+            .ghostty => break :entrypoint, // This function
+            .mdgen_ghostty_1 => try @import("build/mdgen/main_ghostty_1.zig").main(),
+            .mdgen_ghostty_5 => try @import("build/mdgen/main_ghostty_5.zig").main(),
+        }
+
+        return;
+    }
+
     // We first start by initializing our global state. This will setup
     // process-level state we need to run the terminal. The reason we use
     // a global is because the C API needs to be able to access this state;
@@ -284,6 +297,7 @@ pub const GlobalState = struct {
         }
     }
 };
+
 test {
     _ = @import("circ_buf.zig");
     _ = @import("pty.zig");

commit 1a9f80c403fe77a7b6b56afd2ec96b128868d314
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sun Feb 4 20:17:47 2024 -0800

    add helpgen entrypoint

diff --git a/src/main.zig b/src/main.zig
index 9038fc35..d0be97b8 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -37,6 +37,7 @@ pub fn main() !MainReturn {
     if (comptime build_config.artifact == .exe) entrypoint: {
         switch (comptime build_config.exe_entrypoint) {
             .ghostty => break :entrypoint, // This function
+            .helpgen => try @import("helpgen.zig").main(),
             .mdgen_ghostty_1 => try @import("build/mdgen/main_ghostty_1.zig").main(),
             .mdgen_ghostty_5 => try @import("build/mdgen/main_ghostty_5.zig").main(),
         }

commit f1227a3ebd2c1a48c3ce8135320bb68f07d72f98
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sun Feb 4 20:27:53 2024 -0800

    build: get benchmarks building again

diff --git a/src/main.zig b/src/main.zig
index d0be97b8..b5307340 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -1,324 +1,10 @@
-const std = @import("std");
-const builtin = @import("builtin");
-const Allocator = std.mem.Allocator;
 const build_config = @import("build_config.zig");
-const options = @import("build_options");
-const glfw = @import("glfw");
-const glslang = @import("glslang");
-const macos = @import("macos");
-const oni = @import("oniguruma");
-const cli = @import("cli.zig");
-const internal_os = @import("os/main.zig");
-const xev = @import("xev");
-const fontconfig = @import("fontconfig");
-const harfbuzz = @import("harfbuzz");
-const renderer = @import("renderer.zig");
-const apprt = @import("apprt.zig");
 
-const App = @import("App.zig");
-const Ghostty = @import("main_c.zig").Ghostty;
-
-/// Global process state. This is initialized in main() for exe artifacts
-/// and by ghostty_init() for lib artifacts. This should ONLY be used by
-/// the C API. The Zig API should NOT use any global state and should
-/// rely on allocators being passed in as parameters.
-pub var state: GlobalState = undefined;
-
-/// The return type for main() depends on the build artifact. The lib build
-/// also calls "main" in order to run the CLI actions, but it calls it as
-/// an API and not an entrypoint.
-const MainReturn = switch (build_config.artifact) {
-    .lib => noreturn,
-    else => void,
-};
-
-pub fn main() !MainReturn {
-    // Load the proper main() function based on build config.
-    if (comptime build_config.artifact == .exe) entrypoint: {
-        switch (comptime build_config.exe_entrypoint) {
-            .ghostty => break :entrypoint, // This function
-            .helpgen => try @import("helpgen.zig").main(),
-            .mdgen_ghostty_1 => try @import("build/mdgen/main_ghostty_1.zig").main(),
-            .mdgen_ghostty_5 => try @import("build/mdgen/main_ghostty_5.zig").main(),
-        }
-
-        return;
-    }
-
-    // We first start by initializing our global state. This will setup
-    // process-level state we need to run the terminal. The reason we use
-    // a global is because the C API needs to be able to access this state;
-    // no other Zig code should EVER access the global state.
-    state.init() catch |err| {
-        const stderr = std.io.getStdErr().writer();
-        defer std.os.exit(1);
-        const ErrSet = @TypeOf(err) || error{Unknown};
-        switch (@as(ErrSet, @errorCast(err))) {
-            error.MultipleActions => try stderr.print(
-                "Error: multiple CLI actions specified. You must specify only one\n" ++
-                    "action starting with the `+` character.\n",
-                .{},
-            ),
-
-            error.InvalidAction => try stderr.print(
-                "Error: unknown CLI action specified. CLI actions are specified with\n" ++
-                    "the '+' character.\n",
-                .{},
-            ),
-
-            else => try stderr.print("invalid CLI invocation err={}\n", .{err}),
-        }
-    };
-    defer state.deinit();
-    const alloc = state.alloc;
-
-    if (comptime builtin.mode == .Debug) {
-        std.log.warn("This is a debug build. Performance will be very poor.", .{});
-        std.log.warn("You should only use a debug build for developing Ghostty.", .{});
-        std.log.warn("Otherwise, please rebuild in a release mode.", .{});
-    }
-
-    // Execute our action if we have one
-    if (state.action) |action| {
-        std.log.info("executing CLI action={}", .{action});
-        std.os.exit(action.run(alloc) catch |err| err: {
-            std.log.err("CLI action failed error={}", .{err});
-            break :err 1;
-        });
-        return;
-    }
-
-    if (comptime build_config.app_runtime == .none) {
-        const stdout = std.io.getStdOut().writer();
-        try stdout.print("Usage: ghostty +<action> [flags]\n\n", .{});
-        try stdout.print(
-            \\This is the Ghostty helper CLI that accompanies the graphical Ghostty app.
-            \\To launch the terminal directly, please launch the graphical app
-            \\(i.e. Ghostty.app on macOS). This CLI can be used to perform various
-            \\actions such as inspecting the version, listing fonts, etc.
-            \\
-            \\We don't have proper help output yet, sorry! Please refer to the
-            \\source code or Discord community for help for now. We'll fix this in time.
-        ,
-            .{},
-        );
-
-        std.os.exit(0);
-    }
-
-    // Create our app state
-    var app = try App.create(alloc);
-    defer app.destroy();
-
-    // Create our runtime app
-    var app_runtime = try apprt.App.init(app, .{});
-    defer app_runtime.terminate();
-
-    // Run the GUI event loop
-    try app_runtime.run();
-}
-
-pub const std_options = struct {
-    // Our log level is always at least info in every build mode.
-    pub const log_level: std.log.Level = switch (builtin.mode) {
-        .Debug => .debug,
-        else => .info,
-    };
-
-    // The function std.log will call.
-    pub fn logFn(
-        comptime level: std.log.Level,
-        comptime scope: @TypeOf(.EnumLiteral),
-        comptime format: []const u8,
-        args: anytype,
-    ) void {
-        // Stuff we can do before the lock
-        const level_txt = comptime level.asText();
-        const prefix = if (scope == .default) ": " else "(" ++ @tagName(scope) ++ "): ";
-
-        // Lock so we are thread-safe
-        std.debug.getStderrMutex().lock();
-        defer std.debug.getStderrMutex().unlock();
-
-        // On Mac, we use unified logging. To view this:
-        //
-        //   sudo log stream --level debug --predicate 'subsystem=="com.mitchellh.ghostty"'
-        //
-        if (builtin.target.isDarwin()) {
-            // Convert our levels to Mac levels
-            const mac_level: macos.os.LogType = switch (level) {
-                .debug => .debug,
-                .info => .info,
-                .warn => .err,
-                .err => .fault,
-            };
-
-            // Initialize a logger. This is slow to do on every operation
-            // but we shouldn't be logging too much.
-            const logger = macos.os.Log.create("com.mitchellh.ghostty", @tagName(scope));
-            defer logger.release();
-            logger.log(std.heap.c_allocator, mac_level, format, args);
-        }
-
-        switch (state.logging) {
-            .disabled => {},
-
-            .stderr => {
-                // Always try default to send to stderr
-                const stderr = std.io.getStdErr().writer();
-                nosuspend stderr.print(level_txt ++ prefix ++ format ++ "\n", args) catch return;
-            },
-        }
-    }
+// See build_config.ExeEntrypoint for why we do this.
+pub usingnamespace switch (build_config.exe_entrypoint) {
+    .ghostty => @import("main_ghostty.zig"),
+    .helpgen => @import("helpgen.zig"),
+    .mdgen_ghostty_1 => @import("build/mdgen/main_ghostty_1.zig"),
+    .mdgen_ghostty_5 => @import("build/mdgen/main_ghostty_5.zig"),
+    .bench_parser => @import("bench/parser.zig"),
 };
-
-/// This represents the global process state. There should only
-/// be one of these at any given moment. This is extracted into a dedicated
-/// struct because it is reused by main and the static C lib.
-pub const GlobalState = struct {
-    const GPA = std.heap.GeneralPurposeAllocator(.{});
-
-    gpa: ?GPA,
-    alloc: std.mem.Allocator,
-    action: ?cli.Action,
-    logging: Logging,
-
-    /// The app resources directory, equivalent to zig-out/share when we build
-    /// from source. This is null if we can't detect it.
-    resources_dir: ?[]const u8,
-
-    /// Where logging should go
-    pub const Logging = union(enum) {
-        disabled: void,
-        stderr: void,
-    };
-
-    /// Initialize the global state.
-    pub fn init(self: *GlobalState) !void {
-        // Initialize ourself to nothing so we don't have any extra state.
-        // IMPORTANT: this MUST be initialized before any log output because
-        // the log function uses the global state.
-        self.* = .{
-            .gpa = null,
-            .alloc = undefined,
-            .action = null,
-            .logging = .{ .stderr = {} },
-            .resources_dir = null,
-        };
-        errdefer self.deinit();
-
-        self.gpa = gpa: {
-            // Use the libc allocator if it is available because it is WAY
-            // faster than GPA. We only do this in release modes so that we
-            // can get easy memory leak detection in debug modes.
-            if (builtin.link_libc) {
-                if (switch (builtin.mode) {
-                    .ReleaseSafe, .ReleaseFast => true,
-
-                    // We also use it if we can detect we're running under
-                    // Valgrind since Valgrind only instruments the C allocator
-                    else => std.valgrind.runningOnValgrind() > 0,
-                }) break :gpa null;
-            }
-
-            break :gpa GPA{};
-        };
-
-        self.alloc = if (self.gpa) |*value|
-            value.allocator()
-        else if (builtin.link_libc)
-            std.heap.c_allocator
-        else
-            unreachable;
-
-        // We first try to parse any action that we may be executing.
-        self.action = try cli.Action.detectCLI(self.alloc);
-
-        // If we have an action executing, we disable logging by default
-        // since we write to stderr we don't want logs messing up our
-        // output.
-        if (self.action != null) self.logging = .{ .disabled = {} };
-
-        // For lib mode we always disable stderr logging by default.
-        if (comptime build_config.app_runtime == .none) {
-            self.logging = .{ .disabled = {} };
-        }
-
-        // I don't love the env var name but I don't have it in my heart
-        // to parse CLI args 3 times (once for actions, once for config,
-        // maybe once for logging) so for now this is an easy way to do
-        // this. Env vars are useful for logging too because they are
-        // easy to set.
-        if ((try internal_os.getenv(self.alloc, "GHOSTTY_LOG"))) |v| {
-            defer v.deinit(self.alloc);
-            if (v.value.len > 0) {
-                self.logging = .{ .stderr = {} };
-            }
-        }
-
-        // Output some debug information right away
-        std.log.info("ghostty version={s}", .{build_config.version_string});
-        std.log.info("runtime={}", .{build_config.app_runtime});
-        std.log.info("font_backend={}", .{build_config.font_backend});
-        std.log.info("dependency harfbuzz={s}", .{harfbuzz.versionString()});
-        if (comptime build_config.font_backend.hasFontconfig()) {
-            std.log.info("dependency fontconfig={d}", .{fontconfig.version()});
-        }
-        std.log.info("renderer={}", .{renderer.Renderer});
-        std.log.info("libxev backend={}", .{xev.backend});
-
-        // First things first, we fix our file descriptors
-        internal_os.fixMaxFiles();
-
-        // We need to make sure the process locale is set properly. Locale
-        // affects a lot of behaviors in a shell.
-        try internal_os.ensureLocale(self.alloc);
-
-        // Initialize glslang for shader compilation
-        try glslang.init();
-
-        // Initialize oniguruma for regex
-        try oni.init(&.{oni.Encoding.utf8});
-
-        // Find our resources directory once for the app so every launch
-        // hereafter can use this cached value.
-        self.resources_dir = try internal_os.resourcesDir(self.alloc);
-        errdefer if (self.resources_dir) |dir| self.alloc.free(dir);
-    }
-
-    /// Cleans up the global state. This doesn't _need_ to be called but
-    /// doing so in dev modes will check for memory leaks.
-    pub fn deinit(self: *GlobalState) void {
-        if (self.resources_dir) |dir| self.alloc.free(dir);
-
-        if (self.gpa) |*value| {
-            // We want to ensure that we deinit the GPA because this is
-            // the point at which it will output if there were safety violations.
-            _ = value.deinit();
-        }
-    }
-};
-
-test {
-    _ = @import("circ_buf.zig");
-    _ = @import("pty.zig");
-    _ = @import("Command.zig");
-    _ = @import("font/main.zig");
-    _ = @import("apprt.zig");
-    _ = @import("renderer.zig");
-    _ = @import("termio.zig");
-    _ = @import("input.zig");
-    _ = @import("cli.zig");
-    _ = @import("surface_mouse.zig");
-
-    // Libraries
-    _ = @import("segmented_pool.zig");
-    _ = @import("inspector/main.zig");
-    _ = @import("terminal/main.zig");
-    _ = @import("terminfo/main.zig");
-
-    // TODO
-    _ = @import("blocking_queue.zig");
-    _ = @import("config.zig");
-    _ = @import("lru.zig");
-}

commit b030663e0384ed53dea6bff7cacd53a614dc18bd
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Mon Feb 5 11:58:10 2024 -0800

    bench/stream: benchmark for stream processing

diff --git a/src/main.zig b/src/main.zig
index b5307340..393ddd54 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -7,4 +7,5 @@ pub usingnamespace switch (build_config.exe_entrypoint) {
     .mdgen_ghostty_1 => @import("build/mdgen/main_ghostty_1.zig"),
     .mdgen_ghostty_5 => @import("build/mdgen/main_ghostty_5.zig"),
     .bench_parser => @import("bench/parser.zig"),
+    .bench_stream => @import("bench/stream.zig"),
 };

commit d4fa0fcabf314fd8fe066369e7db890753f06e90
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Tue Feb 6 17:06:58 2024 -0800

    bench/codepoint-width

diff --git a/src/main.zig b/src/main.zig
index 393ddd54..46a6d7d3 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -8,4 +8,5 @@ pub usingnamespace switch (build_config.exe_entrypoint) {
     .mdgen_ghostty_5 => @import("build/mdgen/main_ghostty_5.zig"),
     .bench_parser => @import("bench/parser.zig"),
     .bench_stream => @import("bench/stream.zig"),
+    .bench_codepoint_width => @import("bench/codepoint-width.zig"),
 };

commit 64376235002e3b85efdae29700b162d572329f96
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Fri Feb 9 09:12:05 2024 -0800

    bench/grapheme-break

diff --git a/src/main.zig b/src/main.zig
index 46a6d7d3..8cad7ec9 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -9,4 +9,5 @@ pub usingnamespace switch (build_config.exe_entrypoint) {
     .bench_parser => @import("bench/parser.zig"),
     .bench_stream => @import("bench/stream.zig"),
     .bench_codepoint_width => @import("bench/codepoint-width.zig"),
+    .bench_grapheme_break => @import("bench/grapheme-break.zig"),
 };

commit 7ad94caaebf50bc54f2904a2b0a2d975c9947f64
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Thu Feb 22 19:51:38 2024 -0800

    bench/page-init

diff --git a/src/main.zig b/src/main.zig
index 8cad7ec9..3a535747 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -10,4 +10,5 @@ pub usingnamespace switch (build_config.exe_entrypoint) {
     .bench_stream => @import("bench/stream.zig"),
     .bench_codepoint_width => @import("bench/codepoint-width.zig"),
     .bench_grapheme_break => @import("bench/grapheme-break.zig"),
+    .bench_page_init => @import("bench/page-init.zig"),
 };

commit e7bf9dc53c93e3a0dadafc44bde20ab56ae87da2
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sun Feb 25 19:31:23 2024 -0800

    vt-insert-lines bench

diff --git a/src/main.zig b/src/main.zig
index 3a535747..c66c8e22 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -11,4 +11,5 @@ pub usingnamespace switch (build_config.exe_entrypoint) {
     .bench_codepoint_width => @import("bench/codepoint-width.zig"),
     .bench_grapheme_break => @import("bench/grapheme-break.zig"),
     .bench_page_init => @import("bench/page-init.zig"),
+    .bench_vt_insert_lines => @import("bench/vt-insert-lines.zig"),
 };

commit 2725b7d9b2572185e6a45077087c1b6b1fe2dff6
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Wed Feb 28 21:49:11 2024 -0800

    bench/screen-copy

diff --git a/src/main.zig b/src/main.zig
index c66c8e22..5d14e927 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -11,5 +11,6 @@ pub usingnamespace switch (build_config.exe_entrypoint) {
     .bench_codepoint_width => @import("bench/codepoint-width.zig"),
     .bench_grapheme_break => @import("bench/grapheme-break.zig"),
     .bench_page_init => @import("bench/page-init.zig"),
+    .bench_screen_copy => @import("bench/screen-copy.zig"),
     .bench_vt_insert_lines => @import("bench/vt-insert-lines.zig"),
 };

commit 9006a3f43101df07ad511f8a283b68fbc114c364
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Fri Mar 1 14:05:52 2024 -0800

    bench/resize

diff --git a/src/main.zig b/src/main.zig
index 5d14e927..1b83e24d 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -11,6 +11,7 @@ pub usingnamespace switch (build_config.exe_entrypoint) {
     .bench_codepoint_width => @import("bench/codepoint-width.zig"),
     .bench_grapheme_break => @import("bench/grapheme-break.zig"),
     .bench_page_init => @import("bench/page-init.zig"),
+    .bench_resize => @import("bench/resize.zig"),
     .bench_screen_copy => @import("bench/screen-copy.zig"),
     .bench_vt_insert_lines => @import("bench/vt-insert-lines.zig"),
 };

commit a416d4236ae32ff8712ffe88b454f804e4f79256
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Tue Mar 26 16:14:25 2024 -0700

    remove old terminal implementation

diff --git a/src/main.zig b/src/main.zig
index 1b83e24d..3a535747 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -11,7 +11,4 @@ pub usingnamespace switch (build_config.exe_entrypoint) {
     .bench_codepoint_width => @import("bench/codepoint-width.zig"),
     .bench_grapheme_break => @import("bench/grapheme-break.zig"),
     .bench_page_init => @import("bench/page-init.zig"),
-    .bench_resize => @import("bench/resize.zig"),
-    .bench_screen_copy => @import("bench/screen-copy.zig"),
-    .bench_vt_insert_lines => @import("bench/vt-insert-lines.zig"),
 };

commit b65a804bb28c899cca0173a07a9b9e7fb7d5f9d4
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Fri Aug 16 14:42:32 2024 -0700

    almost yeeted it all!

diff --git a/src/main.zig b/src/main.zig
index 3a535747..a1f8d4a4 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -1,7 +1,7 @@
 const build_config = @import("build_config.zig");
 
-// See build_config.ExeEntrypoint for why we do this.
-pub usingnamespace switch (build_config.exe_entrypoint) {
+/// See build_config.ExeEntrypoint for why we do this.
+const entrypoint = switch (build_config.exe_entrypoint) {
     .ghostty => @import("main_ghostty.zig"),
     .helpgen => @import("helpgen.zig"),
     .mdgen_ghostty_1 => @import("build/mdgen/main_ghostty_1.zig"),
@@ -12,3 +12,10 @@ pub usingnamespace switch (build_config.exe_entrypoint) {
     .bench_grapheme_break => @import("bench/grapheme-break.zig"),
     .bench_page_init => @import("bench/page-init.zig"),
 };
+
+/// The main entrypoint for the program.
+pub const main = entrypoint.main;
+
+test {
+    _ = entrypoint;
+}

commit 08ee32b6330ff753b2c49e8bf93de93e6fa6f936
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Fri Sep 27 10:50:43 2024 -0700

    Forward std_options from entrypoint in main.zig

diff --git a/src/main.zig b/src/main.zig
index a1f8d4a4..895ccfe4 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -1,3 +1,4 @@
+const std = @import("std");
 const build_config = @import("build_config.zig");
 
 /// See build_config.ExeEntrypoint for why we do this.
@@ -16,6 +17,12 @@ const entrypoint = switch (build_config.exe_entrypoint) {
 /// The main entrypoint for the program.
 pub const main = entrypoint.main;
 
+/// Standard options such as logger overrides.
+pub const std_options: std.Options = if (@hasDecl(entrypoint, "std_options"))
+    entrypoint.std_options
+else
+    .{};
+
 test {
     _ = entrypoint;
 }

commit 82c9787fd3d9da61baac50831855440a36318a9e
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Tue Dec 17 21:57:34 2024 -0800

    build: generate reference page for config for website

diff --git a/src/main.zig b/src/main.zig
index 895ccfe4..24c5b7a3 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -7,6 +7,7 @@ const entrypoint = switch (build_config.exe_entrypoint) {
     .helpgen => @import("helpgen.zig"),
     .mdgen_ghostty_1 => @import("build/mdgen/main_ghostty_1.zig"),
     .mdgen_ghostty_5 => @import("build/mdgen/main_ghostty_5.zig"),
+    .webgen_config => @import("build/webgen/main_config.zig"),
     .bench_parser => @import("bench/parser.zig"),
     .bench_stream => @import("bench/stream.zig"),
     .bench_codepoint_width => @import("bench/codepoint-width.zig"),

commit 270d454c4e6cf3cfe3755c65f0a77107a161dd62
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Thu Dec 19 16:30:18 2024 -0800

    webgen: update config to support callouts, emit keybind actions

diff --git a/src/main.zig b/src/main.zig
index 24c5b7a3..ecf38fbb 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -8,6 +8,7 @@ const entrypoint = switch (build_config.exe_entrypoint) {
     .mdgen_ghostty_1 => @import("build/mdgen/main_ghostty_1.zig"),
     .mdgen_ghostty_5 => @import("build/mdgen/main_ghostty_5.zig"),
     .webgen_config => @import("build/webgen/main_config.zig"),
+    .webgen_actions => @import("build/webgen/main_actions.zig"),
     .bench_parser => @import("bench/parser.zig"),
     .bench_stream => @import("bench/stream.zig"),
     .bench_codepoint_width => @import("bench/codepoint-width.zig"),

commit 098a46f0773c544b07e8d812247719893f1b6b6d
Author: Anund <anundm@gmail.com>
Date:   Wed Jan 8 17:32:11 2025 +1100

    docs: generate mdx file for cli actions

diff --git a/src/main.zig b/src/main.zig
index ecf38fbb..121a3b7d 100644
--- a/src/main.zig
+++ b/src/main.zig
@@ -9,6 +9,7 @@ const entrypoint = switch (build_config.exe_entrypoint) {
     .mdgen_ghostty_5 => @import("build/mdgen/main_ghostty_5.zig"),
     .webgen_config => @import("build/webgen/main_config.zig"),
     .webgen_actions => @import("build/webgen/main_actions.zig"),
+    .webgen_commands => @import("build/webgen/main_commands.zig"),
     .bench_parser => @import("bench/parser.zig"),
     .bench_stream => @import("bench/stream.zig"),
     .bench_codepoint_width => @import("bench/codepoint-width.zig"),

