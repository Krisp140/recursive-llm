# Instructions

You are being benchmarked. You will see the output of a git log command, and from that must infer the current state of a file. Think carefully, as you must output the exact state of the file to earn full marks.

**Important:** Your goal is to reproduce the file's content *exactly* as it exists at the final commit, even if the code appears broken, buggy, or contains obvious errors. Do **not** try to "fix" the code. Attempting to correct issues will result in a poor score, as this benchmark evaluates your ability to reproduce the precise state of the file based on its history.

# Required Response Format

Wrap the content of the file in triple backticks (```). Any text outside the final closing backticks will be ignored. End your response after outputting the closing backticks.

# Example Response

```python
#!/usr/bin/env python
print('Hello, world!')
```

# File History

> git log -p --cc --topo-order --reverse -- packages/react/src/__tests__/ReactStrictMode-test.js

commit 3d3506d37d6a3b398e29696458f696e86ec5d576
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Thu Jul 19 22:11:59 2018 +0100

    Include Modes in the component stack (#13240)
    
    * Add a test that StrictMode shows up in the component stack
    
    The SSR test passes. The client one doesn't.
    
    * Include Modes in component stack
    
    * Update other tests to include modes

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
new file mode 100644
index 0000000000..f4ba917432
--- /dev/null
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -0,0 +1,65 @@
+/**
+ * Copyright (c) 2013-present, Facebook, Inc.
+ *
+ * This source code is licensed under the MIT license found in the
+ * LICENSE file in the root directory of this source tree.
+ *
+ * @emails react-core
+ */
+
+'use strict';
+
+let React;
+let ReactDOM;
+let ReactDOMServer;
+
+describe('ReactStrictMode', () => {
+  beforeEach(() => {
+    jest.resetModules();
+    React = require('react');
+    ReactDOM = require('react-dom');
+    ReactDOMServer = require('react-dom/server');
+  });
+
+  it('should appear in the client component stack', () => {
+    function Foo() {
+      return <div ariaTypo="" />;
+    }
+
+    const container = document.createElement('div');
+    expect(() => {
+      ReactDOM.render(
+        <React.StrictMode>
+          <Foo />
+        </React.StrictMode>,
+        container,
+      );
+    }).toWarnDev(
+      'Invalid ARIA attribute `ariaTypo`. ' +
+        'ARIA attributes follow the pattern aria-* and must be lowercase.\n' +
+        '    in div (at **)\n' +
+        '    in Foo (at **)\n' +
+        '    in StrictMode (at **)',
+    );
+  });
+
+  it('should appear in the SSR component stack', () => {
+    function Foo() {
+      return <div ariaTypo="" />;
+    }
+
+    expect(() => {
+      ReactDOMServer.renderToString(
+        <React.StrictMode>
+          <Foo />
+        </React.StrictMode>,
+      );
+    }).toWarnDev(
+      'Invalid ARIA attribute `ariaTypo`. ' +
+        'ARIA attributes follow the pattern aria-* and must be lowercase.\n' +
+        '    in div (at **)\n' +
+        '    in Foo (at **)\n' +
+        '    in StrictMode (at **)',
+    );
+  });
+});

commit b87aabdfe1b7461e7331abb3601d9e6bb27544bc
Author: Héctor Ramos <165856+hramos@users.noreply.github.com>
Date:   Fri Sep 7 15:11:23 2018 -0700

    Drop the year from Facebook copyright headers and the LICENSE file. (#13593)

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index f4ba917432..53850a0b81 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -1,5 +1,5 @@
 /**
- * Copyright (c) 2013-present, Facebook, Inc.
+ * Copyright (c) Facebook, Inc. and its affiliates.
  *
  * This source code is licensed under the MIT license found in the
  * LICENSE file in the root directory of this source tree.

commit 0f3838a01b0fda0ac5fd054c6be13166697a113c
Author: Andrew Clark <git@andrewclark.io>
Date:   Mon Nov 4 14:07:05 2019 -0800

    Remove `debugRenderPhaseSideEffects` flag (#17270)
    
    There are two similar flags, `debugRenderPhaseSideEffects` and
    `debugRenderPhaseSideEffectsForStrictMode`. The strict mode one is the
    only one that is actually used. I think originally the theory is that
    we would one day turn it on for all components, even outside strict
    mode. But what we'll do instead is migrate everyone to strict mode.
    
    The only place `debugRenderPhaseSideEffects` was being used was in
    an internal test file. I rewrote those tests to use public APIs.

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index 53850a0b81..07e7b1bd78 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -12,6 +12,8 @@
 let React;
 let ReactDOM;
 let ReactDOMServer;
+let Scheduler;
+let PropTypes;
 
 describe('ReactStrictMode', () => {
   beforeEach(() => {
@@ -62,4 +64,820 @@ describe('ReactStrictMode', () => {
         '    in StrictMode (at **)',
     );
   });
+
+  it('should invoke precommit lifecycle methods twice', () => {
+    let log = [];
+    let shouldComponentUpdate = false;
+    class ClassComponent extends React.Component {
+      state = {};
+      static getDerivedStateFromProps() {
+        log.push('getDerivedStateFromProps');
+        return null;
+      }
+      constructor(props) {
+        super(props);
+        log.push('constructor');
+      }
+      componentDidMount() {
+        log.push('componentDidMount');
+      }
+      componentDidUpdate() {
+        log.push('componentDidUpdate');
+      }
+      componentWillUnmount() {
+        log.push('componentWillUnmount');
+      }
+      shouldComponentUpdate() {
+        log.push('shouldComponentUpdate');
+        return shouldComponentUpdate;
+      }
+      render() {
+        log.push('render');
+        return null;
+      }
+    }
+
+    const container = document.createElement('div');
+    ReactDOM.render(
+      <React.StrictMode>
+        <ClassComponent />
+      </React.StrictMode>,
+      container,
+    );
+
+    if (__DEV__) {
+      expect(log).toEqual([
+        'constructor',
+        'constructor',
+        'getDerivedStateFromProps',
+        'getDerivedStateFromProps',
+        'render',
+        'render',
+        'componentDidMount',
+      ]);
+    } else {
+      expect(log).toEqual([
+        'constructor',
+        'getDerivedStateFromProps',
+        'render',
+        'componentDidMount',
+      ]);
+    }
+
+    log = [];
+    shouldComponentUpdate = true;
+
+    ReactDOM.render(
+      <React.StrictMode>
+        <ClassComponent />
+      </React.StrictMode>,
+      container,
+    );
+    if (__DEV__) {
+      expect(log).toEqual([
+        'getDerivedStateFromProps',
+        'getDerivedStateFromProps',
+        'shouldComponentUpdate',
+        'render',
+        'render',
+        'componentDidUpdate',
+      ]);
+    } else {
+      expect(log).toEqual([
+        'getDerivedStateFromProps',
+        'shouldComponentUpdate',
+        'render',
+        'componentDidUpdate',
+      ]);
+    }
+
+    log = [];
+    shouldComponentUpdate = false;
+
+    ReactDOM.render(
+      <React.StrictMode>
+        <ClassComponent />
+      </React.StrictMode>,
+      container,
+    );
+
+    if (__DEV__) {
+      expect(log).toEqual([
+        'getDerivedStateFromProps',
+        'getDerivedStateFromProps',
+        'shouldComponentUpdate',
+      ]);
+    } else {
+      expect(log).toEqual([
+        'getDerivedStateFromProps',
+        'shouldComponentUpdate',
+      ]);
+    }
+  });
+
+  it('should invoke setState callbacks twice', () => {
+    let instance;
+    class ClassComponent extends React.Component {
+      state = {
+        count: 1,
+      };
+      render() {
+        instance = this;
+        return null;
+      }
+    }
+
+    let setStateCount = 0;
+
+    const container = document.createElement('div');
+    ReactDOM.render(
+      <React.StrictMode>
+        <ClassComponent />
+      </React.StrictMode>,
+      container,
+    );
+    instance.setState(state => {
+      setStateCount++;
+      return {
+        count: state.count + 1,
+      };
+    });
+
+    // Callback should be invoked twice in DEV
+    expect(setStateCount).toBe(__DEV__ ? 2 : 1);
+    // But each time `state` should be the previous value
+    expect(instance.state.count).toBe(2);
+  });
+
+  it('should invoke precommit lifecycle methods twice in DEV', () => {
+    const {StrictMode} = React;
+
+    let log = [];
+    let shouldComponentUpdate = false;
+
+    function Root() {
+      return (
+        <StrictMode>
+          <ClassComponent />
+        </StrictMode>
+      );
+    }
+
+    class ClassComponent extends React.Component {
+      state = {};
+      static getDerivedStateFromProps() {
+        log.push('getDerivedStateFromProps');
+        return null;
+      }
+      constructor(props) {
+        super(props);
+        log.push('constructor');
+      }
+      componentDidMount() {
+        log.push('componentDidMount');
+      }
+      componentDidUpdate() {
+        log.push('componentDidUpdate');
+      }
+      componentWillUnmount() {
+        log.push('componentWillUnmount');
+      }
+      shouldComponentUpdate() {
+        log.push('shouldComponentUpdate');
+        return shouldComponentUpdate;
+      }
+      render() {
+        log.push('render');
+        return null;
+      }
+    }
+
+    const container = document.createElement('div');
+    ReactDOM.render(<Root />, container);
+
+    if (__DEV__) {
+      expect(log).toEqual([
+        'constructor',
+        'constructor',
+        'getDerivedStateFromProps',
+        'getDerivedStateFromProps',
+        'render',
+        'render',
+        'componentDidMount',
+      ]);
+    } else {
+      expect(log).toEqual([
+        'constructor',
+        'getDerivedStateFromProps',
+        'render',
+        'componentDidMount',
+      ]);
+    }
+
+    log = [];
+    shouldComponentUpdate = true;
+
+    ReactDOM.render(<Root />, container);
+    if (__DEV__) {
+      expect(log).toEqual([
+        'getDerivedStateFromProps',
+        'getDerivedStateFromProps',
+        'shouldComponentUpdate',
+        'render',
+        'render',
+        'componentDidUpdate',
+      ]);
+    } else {
+      expect(log).toEqual([
+        'getDerivedStateFromProps',
+        'shouldComponentUpdate',
+        'render',
+        'componentDidUpdate',
+      ]);
+    }
+
+    log = [];
+    shouldComponentUpdate = false;
+
+    ReactDOM.render(<Root />, container);
+    if (__DEV__) {
+      expect(log).toEqual([
+        'getDerivedStateFromProps',
+        'getDerivedStateFromProps',
+        'shouldComponentUpdate',
+      ]);
+    } else {
+      expect(log).toEqual([
+        'getDerivedStateFromProps',
+        'shouldComponentUpdate',
+      ]);
+    }
+  });
+
+  it('should invoke setState callbacks twice in DEV', () => {
+    const {StrictMode} = React;
+
+    let instance;
+    class ClassComponent extends React.Component {
+      state = {
+        count: 1,
+      };
+      render() {
+        instance = this;
+        return null;
+      }
+    }
+
+    let setStateCount = 0;
+
+    const container = document.createElement('div');
+    ReactDOM.render(
+      <StrictMode>
+        <ClassComponent />
+      </StrictMode>,
+      container,
+    );
+    instance.setState(state => {
+      setStateCount++;
+      return {
+        count: state.count + 1,
+      };
+    });
+
+    // Callback should be invoked twice (in DEV)
+    expect(setStateCount).toBe(__DEV__ ? 2 : 1);
+    // But each time `state` should be the previous value
+    expect(instance.state.count).toBe(2);
+  });
+});
+
+describe('Concurrent Mode', () => {
+  beforeEach(() => {
+    jest.resetModules();
+
+    React = require('react');
+    ReactDOM = require('react-dom');
+    Scheduler = require('scheduler');
+  });
+
+  it.experimental(
+    'should warn about unsafe legacy lifecycle methods anywhere in the tree',
+    () => {
+      class AsyncRoot extends React.Component {
+        UNSAFE_componentWillMount() {}
+        UNSAFE_componentWillUpdate() {}
+        render() {
+          return (
+            <div>
+              <Wrapper>
+                <Foo />
+              </Wrapper>
+              <div>
+                <Bar />
+                <Foo />
+              </div>
+            </div>
+          );
+        }
+      }
+      function Wrapper({children}) {
+        return <div>{children}</div>;
+      }
+      class Foo extends React.Component {
+        UNSAFE_componentWillReceiveProps() {}
+        render() {
+          return null;
+        }
+      }
+      class Bar extends React.Component {
+        UNSAFE_componentWillReceiveProps() {}
+        render() {
+          return null;
+        }
+      }
+
+      const container = document.createElement('div');
+      const root = ReactDOM.createRoot(container);
+      root.render(<AsyncRoot />);
+      expect(() => Scheduler.unstable_flushAll()).toWarnDev(
+        [
+          /* eslint-disable max-len */
+          `Warning: Using UNSAFE_componentWillMount in strict mode is not recommended and may indicate bugs in your code. See https://fb.me/react-unsafe-component-lifecycles for details.
+
+* Move code with side effects to componentDidMount, and set initial state in the constructor.
+
+Please update the following components: AsyncRoot`,
+          `Warning: Using UNSAFE_componentWillReceiveProps in strict mode is not recommended and may indicate bugs in your code. See https://fb.me/react-unsafe-component-lifecycles for details.
+
+* Move data fetching code or side effects to componentDidUpdate.
+* If you're updating state whenever props change, refactor your code to use memoization techniques or move it to static getDerivedStateFromProps. Learn more at: https://fb.me/react-derived-state
+
+Please update the following components: Bar, Foo`,
+          `Warning: Using UNSAFE_componentWillUpdate in strict mode is not recommended and may indicate bugs in your code. See https://fb.me/react-unsafe-component-lifecycles for details.
+
+* Move data fetching code or side effects to componentDidUpdate.
+
+Please update the following components: AsyncRoot`,
+          /* eslint-enable max-len */
+        ],
+        {withoutStack: true},
+      );
+
+      // Dedupe
+      root.render(<AsyncRoot />);
+      Scheduler.unstable_flushAll();
+    },
+  );
+
+  it.experimental('should coalesce warnings by lifecycle name', () => {
+    class AsyncRoot extends React.Component {
+      UNSAFE_componentWillMount() {}
+      UNSAFE_componentWillUpdate() {}
+      render() {
+        return <Parent />;
+      }
+    }
+    class Parent extends React.Component {
+      componentWillMount() {}
+      componentWillUpdate() {}
+      componentWillReceiveProps() {}
+      render() {
+        return <Child />;
+      }
+    }
+    class Child extends React.Component {
+      UNSAFE_componentWillReceiveProps() {}
+      render() {
+        return null;
+      }
+    }
+
+    const container = document.createElement('div');
+    const root = ReactDOM.createRoot(container);
+    root.render(<AsyncRoot />);
+
+    expect(() => {
+      expect(() => Scheduler.unstable_flushAll()).toWarnDev(
+        [
+          /* eslint-disable max-len */
+          `Warning: Using UNSAFE_componentWillMount in strict mode is not recommended and may indicate bugs in your code. See https://fb.me/react-unsafe-component-lifecycles for details.
+
+* Move code with side effects to componentDidMount, and set initial state in the constructor.
+
+Please update the following components: AsyncRoot`,
+          `Warning: Using UNSAFE_componentWillReceiveProps in strict mode is not recommended and may indicate bugs in your code. See https://fb.me/react-unsafe-component-lifecycles for details.
+
+* Move data fetching code or side effects to componentDidUpdate.
+* If you're updating state whenever props change, refactor your code to use memoization techniques or move it to static getDerivedStateFromProps. Learn more at: https://fb.me/react-derived-state
+
+Please update the following components: Child`,
+          `Warning: Using UNSAFE_componentWillUpdate in strict mode is not recommended and may indicate bugs in your code. See https://fb.me/react-unsafe-component-lifecycles for details.
+
+* Move data fetching code or side effects to componentDidUpdate.
+
+Please update the following components: AsyncRoot`,
+          /* eslint-enable max-len */
+        ],
+        {withoutStack: true},
+      );
+    }).toLowPriorityWarnDev(
+      [
+        /* eslint-disable max-len */
+        `Warning: componentWillMount has been renamed, and is not recommended for use. See https://fb.me/react-unsafe-component-lifecycles for details.
+
+* Move code with side effects to componentDidMount, and set initial state in the constructor.
+* Rename componentWillMount to UNSAFE_componentWillMount to suppress this warning in non-strict mode. In React 17.x, only the UNSAFE_ name will work. To rename all deprecated lifecycles to their new names, you can run \`npx react-codemod rename-unsafe-lifecycles\` in your project source folder.
+
+Please update the following components: Parent`,
+        `Warning: componentWillReceiveProps has been renamed, and is not recommended for use. See https://fb.me/react-unsafe-component-lifecycles for details.
+
+* Move data fetching code or side effects to componentDidUpdate.
+* If you're updating state whenever props change, refactor your code to use memoization techniques or move it to static getDerivedStateFromProps. Learn more at: https://fb.me/react-derived-state
+* Rename componentWillReceiveProps to UNSAFE_componentWillReceiveProps to suppress this warning in non-strict mode. In React 17.x, only the UNSAFE_ name will work. To rename all deprecated lifecycles to their new names, you can run \`npx react-codemod rename-unsafe-lifecycles\` in your project source folder.
+
+Please update the following components: Parent`,
+        `Warning: componentWillUpdate has been renamed, and is not recommended for use. See https://fb.me/react-unsafe-component-lifecycles for details.
+
+* Move data fetching code or side effects to componentDidUpdate.
+* Rename componentWillUpdate to UNSAFE_componentWillUpdate to suppress this warning in non-strict mode. In React 17.x, only the UNSAFE_ name will work. To rename all deprecated lifecycles to their new names, you can run \`npx react-codemod rename-unsafe-lifecycles\` in your project source folder.
+
+Please update the following components: Parent`,
+        /* eslint-enable max-len */
+      ],
+      {withoutStack: true},
+    );
+    // Dedupe
+    root.render(<AsyncRoot />);
+    Scheduler.unstable_flushAll();
+  });
+
+  it.experimental(
+    'should warn about components not present during the initial render',
+    () => {
+      class AsyncRoot extends React.Component {
+        render() {
+          return this.props.foo ? <Foo /> : <Bar />;
+        }
+      }
+      class Foo extends React.Component {
+        UNSAFE_componentWillMount() {}
+        render() {
+          return null;
+        }
+      }
+      class Bar extends React.Component {
+        UNSAFE_componentWillMount() {}
+        render() {
+          return null;
+        }
+      }
+
+      const container = document.createElement('div');
+      const root = ReactDOM.createRoot(container);
+      root.render(<AsyncRoot foo={true} />);
+      expect(() => Scheduler.unstable_flushAll()).toWarnDev(
+        'Using UNSAFE_componentWillMount in strict mode is not recommended',
+        {withoutStack: true},
+      );
+
+      root.render(<AsyncRoot foo={false} />);
+      expect(() => Scheduler.unstable_flushAll()).toWarnDev(
+        'Using UNSAFE_componentWillMount in strict mode is not recommended',
+        {withoutStack: true},
+      );
+
+      // Dedupe
+      root.render(<AsyncRoot foo={true} />);
+      Scheduler.unstable_flushAll();
+      root.render(<AsyncRoot foo={false} />);
+      Scheduler.unstable_flushAll();
+    },
+  );
+
+  it('should also warn inside of "strict" mode trees', () => {
+    const {StrictMode} = React;
+
+    class SyncRoot extends React.Component {
+      UNSAFE_componentWillMount() {}
+      UNSAFE_componentWillUpdate() {}
+      UNSAFE_componentWillReceiveProps() {}
+      render() {
+        return (
+          <StrictMode>
+            <Wrapper />
+          </StrictMode>
+        );
+      }
+    }
+    function Wrapper({children}) {
+      return (
+        <div>
+          <Bar />
+          <Foo />
+        </div>
+      );
+    }
+    class Foo extends React.Component {
+      UNSAFE_componentWillReceiveProps() {}
+      render() {
+        return null;
+      }
+    }
+    class Bar extends React.Component {
+      UNSAFE_componentWillReceiveProps() {}
+      render() {
+        return null;
+      }
+    }
+
+    const container = document.createElement('div');
+
+    expect(() => ReactDOM.render(<SyncRoot />, container)).toWarnDev(
+      'Using UNSAFE_componentWillReceiveProps in strict mode is not recommended',
+      {withoutStack: true},
+    );
+
+    // Dedupe
+    ReactDOM.render(<SyncRoot />, container);
+  });
+});
+
+describe('symbol checks', () => {
+  beforeEach(() => {
+    jest.resetModules();
+    React = require('react');
+    ReactDOM = require('react-dom');
+  });
+
+  it('should switch from StrictMode to a Fragment and reset state', () => {
+    const {Fragment, StrictMode} = React;
+
+    function ParentComponent({useFragment}) {
+      return useFragment ? (
+        <Fragment>
+          <ChildComponent />
+        </Fragment>
+      ) : (
+        <StrictMode>
+          <ChildComponent />
+        </StrictMode>
+      );
+    }
+
+    class ChildComponent extends React.Component {
+      state = {
+        count: 0,
+      };
+      static getDerivedStateFromProps(nextProps, prevState) {
+        return {
+          count: prevState.count + 1,
+        };
+      }
+      render() {
+        return `count:${this.state.count}`;
+      }
+    }
+
+    const container = document.createElement('div');
+    ReactDOM.render(<ParentComponent useFragment={false} />, container);
+    expect(container.textContent).toBe('count:1');
+    ReactDOM.render(<ParentComponent useFragment={true} />, container);
+    expect(container.textContent).toBe('count:1');
+  });
+
+  it('should switch from a Fragment to StrictMode and reset state', () => {
+    const {Fragment, StrictMode} = React;
+
+    function ParentComponent({useFragment}) {
+      return useFragment ? (
+        <Fragment>
+          <ChildComponent />
+        </Fragment>
+      ) : (
+        <StrictMode>
+          <ChildComponent />
+        </StrictMode>
+      );
+    }
+
+    class ChildComponent extends React.Component {
+      state = {
+        count: 0,
+      };
+      static getDerivedStateFromProps(nextProps, prevState) {
+        return {
+          count: prevState.count + 1,
+        };
+      }
+      render() {
+        return `count:${this.state.count}`;
+      }
+    }
+
+    const container = document.createElement('div');
+    ReactDOM.render(<ParentComponent useFragment={true} />, container);
+    expect(container.textContent).toBe('count:1');
+    ReactDOM.render(<ParentComponent useFragment={false} />, container);
+    expect(container.textContent).toBe('count:1');
+  });
+
+  it('should update with StrictMode without losing state', () => {
+    const {StrictMode} = React;
+
+    function ParentComponent() {
+      return (
+        <StrictMode>
+          <ChildComponent />
+        </StrictMode>
+      );
+    }
+
+    class ChildComponent extends React.Component {
+      state = {
+        count: 0,
+      };
+      static getDerivedStateFromProps(nextProps, prevState) {
+        return {
+          count: prevState.count + 1,
+        };
+      }
+      render() {
+        return `count:${this.state.count}`;
+      }
+    }
+
+    const container = document.createElement('div');
+    ReactDOM.render(<ParentComponent />, container);
+    expect(container.textContent).toBe('count:1');
+    ReactDOM.render(<ParentComponent />, container);
+    expect(container.textContent).toBe('count:2');
+  });
+});
+
+describe('string refs', () => {
+  beforeEach(() => {
+    jest.resetModules();
+    React = require('react');
+    ReactDOM = require('react-dom');
+  });
+
+  it('should warn within a strict tree', () => {
+    const {StrictMode} = React;
+
+    class OuterComponent extends React.Component {
+      render() {
+        return (
+          <StrictMode>
+            <InnerComponent ref="somestring" />
+          </StrictMode>
+        );
+      }
+    }
+
+    class InnerComponent extends React.Component {
+      render() {
+        return null;
+      }
+    }
+
+    const container = document.createElement('div');
+    expect(() => {
+      ReactDOM.render(<OuterComponent />, container);
+    }).toWarnDev(
+      'Warning: A string ref, "somestring", has been found within a strict mode tree. ' +
+        'String refs are a source of potential bugs and should be avoided. ' +
+        'We recommend using useRef() or createRef() instead. ' +
+        'Learn more about using refs safely here: ' +
+        'https://fb.me/react-strict-mode-string-ref\n' +
+        '    in StrictMode (at **)\n' +
+        '    in OuterComponent (at **)',
+    );
+
+    // Dedup
+    ReactDOM.render(<OuterComponent />, container);
+  });
+
+  it('should warn within a strict tree', () => {
+    const {StrictMode} = React;
+
+    class OuterComponent extends React.Component {
+      render() {
+        return (
+          <StrictMode>
+            <InnerComponent />
+          </StrictMode>
+        );
+      }
+    }
+
+    class InnerComponent extends React.Component {
+      render() {
+        return <MiddleComponent ref="somestring" />;
+      }
+    }
+
+    class MiddleComponent extends React.Component {
+      render() {
+        return null;
+      }
+    }
+
+    const container = document.createElement('div');
+    expect(() => {
+      ReactDOM.render(<OuterComponent />, container);
+    }).toWarnDev(
+      'Warning: A string ref, "somestring", has been found within a strict mode tree. ' +
+        'String refs are a source of potential bugs and should be avoided. ' +
+        'We recommend using useRef() or createRef() instead. ' +
+        'Learn more about using refs safely here: ' +
+        'https://fb.me/react-strict-mode-string-ref\n' +
+        '    in InnerComponent (at **)\n' +
+        '    in StrictMode (at **)\n' +
+        '    in OuterComponent (at **)',
+    );
+
+    // Dedup
+    ReactDOM.render(<OuterComponent />, container);
+  });
+});
+
+describe('context legacy', () => {
+  beforeEach(() => {
+    jest.resetModules();
+    React = require('react');
+    ReactDOM = require('react-dom');
+    PropTypes = require('prop-types');
+  });
+
+  it('should warn if the legacy context API have been used in strict mode', () => {
+    class LegacyContextProvider extends React.Component {
+      getChildContext() {
+        return {color: 'purple'};
+      }
+
+      render() {
+        return (
+          <div>
+            <LegacyContextConsumer />
+            <FunctionalLegacyContextConsumer />
+          </div>
+        );
+      }
+    }
+
+    function FunctionalLegacyContextConsumer() {
+      return null;
+    }
+
+    LegacyContextProvider.childContextTypes = {
+      color: PropTypes.string,
+    };
+
+    class LegacyContextConsumer extends React.Component {
+      render() {
+        return null;
+      }
+    }
+
+    const {StrictMode} = React;
+
+    class Root extends React.Component {
+      render() {
+        return (
+          <div>
+            <StrictMode>
+              <LegacyContextProvider />
+            </StrictMode>
+          </div>
+        );
+      }
+    }
+
+    LegacyContextConsumer.contextTypes = {
+      color: PropTypes.string,
+    };
+
+    FunctionalLegacyContextConsumer.contextTypes = {
+      color: PropTypes.string,
+    };
+
+    const container = document.createElement('div');
+    expect(() => {
+      ReactDOM.render(<Root />, container);
+    }).toWarnDev(
+      'Warning: Legacy context API has been detected within a strict-mode tree.' +
+        '\n\nThe old API will be supported in all 16.x releases, but applications ' +
+        'using it should migrate to the new version.' +
+        '\n\nPlease update the following components: ' +
+        'FunctionalLegacyContextConsumer, LegacyContextConsumer, LegacyContextProvider' +
+        '\n\nLearn more about this warning here: ' +
+        'https://fb.me/react-legacy-context' +
+        '\n    in StrictMode (at **)' +
+        '\n    in div (at **)' +
+        '\n    in Root (at **)',
+    );
+
+    // Dedupe
+    ReactDOM.render(<Root />, container);
+  });
 });

commit 0b5a26a4895261894f04e50d5a700e83b9c0dcf6
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Mon Dec 16 12:48:16 2019 +0000

    Rename toWarnDev -> toErrorDev, toLowPriorityWarnDev -> toWarnDev (#17605)
    
    * Rename toWarnDev -> toErrorDev in tests
    
    * Rename toWarnDev matcher implementation to toErrorDev
    
    * Rename toLowPriorityWarnDev -> toWarnDev in tests and implementation

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index 07e7b1bd78..3f7cde6ec5 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -36,7 +36,7 @@ describe('ReactStrictMode', () => {
         </React.StrictMode>,
         container,
       );
-    }).toWarnDev(
+    }).toErrorDev(
       'Invalid ARIA attribute `ariaTypo`. ' +
         'ARIA attributes follow the pattern aria-* and must be lowercase.\n' +
         '    in div (at **)\n' +
@@ -56,7 +56,7 @@ describe('ReactStrictMode', () => {
           <Foo />
         </React.StrictMode>,
       );
-    }).toWarnDev(
+    }).toErrorDev(
       'Invalid ARIA attribute `ariaTypo`. ' +
         'ARIA attributes follow the pattern aria-* and must be lowercase.\n' +
         '    in div (at **)\n' +
@@ -399,7 +399,7 @@ describe('Concurrent Mode', () => {
       const container = document.createElement('div');
       const root = ReactDOM.createRoot(container);
       root.render(<AsyncRoot />);
-      expect(() => Scheduler.unstable_flushAll()).toWarnDev(
+      expect(() => Scheduler.unstable_flushAll()).toErrorDev(
         [
           /* eslint-disable max-len */
           `Warning: Using UNSAFE_componentWillMount in strict mode is not recommended and may indicate bugs in your code. See https://fb.me/react-unsafe-component-lifecycles for details.
@@ -457,7 +457,7 @@ Please update the following components: AsyncRoot`,
     root.render(<AsyncRoot />);
 
     expect(() => {
-      expect(() => Scheduler.unstable_flushAll()).toWarnDev(
+      expect(() => Scheduler.unstable_flushAll()).toErrorDev(
         [
           /* eslint-disable max-len */
           `Warning: Using UNSAFE_componentWillMount in strict mode is not recommended and may indicate bugs in your code. See https://fb.me/react-unsafe-component-lifecycles for details.
@@ -480,7 +480,7 @@ Please update the following components: AsyncRoot`,
         ],
         {withoutStack: true},
       );
-    }).toLowPriorityWarnDev(
+    }).toWarnDev(
       [
         /* eslint-disable max-len */
         `Warning: componentWillMount has been renamed, and is not recommended for use. See https://fb.me/react-unsafe-component-lifecycles for details.
@@ -535,13 +535,13 @@ Please update the following components: Parent`,
       const container = document.createElement('div');
       const root = ReactDOM.createRoot(container);
       root.render(<AsyncRoot foo={true} />);
-      expect(() => Scheduler.unstable_flushAll()).toWarnDev(
+      expect(() => Scheduler.unstable_flushAll()).toErrorDev(
         'Using UNSAFE_componentWillMount in strict mode is not recommended',
         {withoutStack: true},
       );
 
       root.render(<AsyncRoot foo={false} />);
-      expect(() => Scheduler.unstable_flushAll()).toWarnDev(
+      expect(() => Scheduler.unstable_flushAll()).toErrorDev(
         'Using UNSAFE_componentWillMount in strict mode is not recommended',
         {withoutStack: true},
       );
@@ -592,7 +592,7 @@ Please update the following components: Parent`,
 
     const container = document.createElement('div');
 
-    expect(() => ReactDOM.render(<SyncRoot />, container)).toWarnDev(
+    expect(() => ReactDOM.render(<SyncRoot />, container)).toErrorDev(
       'Using UNSAFE_componentWillReceiveProps in strict mode is not recommended',
       {withoutStack: true},
     );
@@ -743,7 +743,7 @@ describe('string refs', () => {
     const container = document.createElement('div');
     expect(() => {
       ReactDOM.render(<OuterComponent />, container);
-    }).toWarnDev(
+    }).toErrorDev(
       'Warning: A string ref, "somestring", has been found within a strict mode tree. ' +
         'String refs are a source of potential bugs and should be avoided. ' +
         'We recommend using useRef() or createRef() instead. ' +
@@ -785,7 +785,7 @@ describe('string refs', () => {
     const container = document.createElement('div');
     expect(() => {
       ReactDOM.render(<OuterComponent />, container);
-    }).toWarnDev(
+    }).toErrorDev(
       'Warning: A string ref, "somestring", has been found within a strict mode tree. ' +
         'String refs are a source of potential bugs and should be avoided. ' +
         'We recommend using useRef() or createRef() instead. ' +
@@ -864,7 +864,7 @@ describe('context legacy', () => {
     const container = document.createElement('div');
     expect(() => {
       ReactDOM.render(<Root />, container);
-    }).toWarnDev(
+    }).toErrorDev(
       'Warning: Legacy context API has been detected within a strict-mode tree.' +
         '\n\nThe old API will be supported in all 16.x releases, but applications ' +
         'using it should migrate to the new version.' +

commit b979db4e7215957f03c4221622f0b115a868439a
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Thu Jan 9 13:54:11 2020 +0000

    Bump Prettier (#17811)
    
    * Bump Prettier
    
    * Reformat
    
    * Use non-deprecated option

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index 3f7cde6ec5..15b2ce719c 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -535,13 +535,17 @@ Please update the following components: Parent`,
       const container = document.createElement('div');
       const root = ReactDOM.createRoot(container);
       root.render(<AsyncRoot foo={true} />);
-      expect(() => Scheduler.unstable_flushAll()).toErrorDev(
+      expect(() =>
+        Scheduler.unstable_flushAll(),
+      ).toErrorDev(
         'Using UNSAFE_componentWillMount in strict mode is not recommended',
         {withoutStack: true},
       );
 
       root.render(<AsyncRoot foo={false} />);
-      expect(() => Scheduler.unstable_flushAll()).toErrorDev(
+      expect(() =>
+        Scheduler.unstable_flushAll(),
+      ).toErrorDev(
         'Using UNSAFE_componentWillMount in strict mode is not recommended',
         {withoutStack: true},
       );
@@ -592,7 +596,9 @@ Please update the following components: Parent`,
 
     const container = document.createElement('div');
 
-    expect(() => ReactDOM.render(<SyncRoot />, container)).toErrorDev(
+    expect(() =>
+      ReactDOM.render(<SyncRoot />, container),
+    ).toErrorDev(
       'Using UNSAFE_componentWillReceiveProps in strict mode is not recommended',
       {withoutStack: true},
     );

commit 57333ca33a0619ff2334e4eb19139b4c7e9830f7
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Wed Jan 29 14:57:52 2020 +0000

    Show first component stack in context warning (#17922)
    
    * Update tests
    
    * Show first component stack in context warning
    
    Co-authored-by: Dominic Gannaway <trueadm@users.noreply.github.com>

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index 15b2ce719c..3acdab4ac3 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -878,6 +878,7 @@ describe('context legacy', () => {
         'FunctionalLegacyContextConsumer, LegacyContextConsumer, LegacyContextProvider' +
         '\n\nLearn more about this warning here: ' +
         'https://fb.me/react-legacy-context' +
+        '\n    in LegacyContextProvider (at **)' +
         '\n    in StrictMode (at **)' +
         '\n    in div (at **)' +
         '\n    in Root (at **)',

commit 6ae2c33a759e8f44622795603c84da9a2ebddf43
Author: Brian Vaughn <bvaughn@fb.com>
Date:   Thu Jan 30 13:03:44 2020 -0800

    StrictMode should call sCU twice in DEV (#17942)

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index 3acdab4ac3..5382fcd33d 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -138,6 +138,7 @@ describe('ReactStrictMode', () => {
         'getDerivedStateFromProps',
         'getDerivedStateFromProps',
         'shouldComponentUpdate',
+        'shouldComponentUpdate',
         'render',
         'render',
         'componentDidUpdate',
@@ -166,6 +167,7 @@ describe('ReactStrictMode', () => {
         'getDerivedStateFromProps',
         'getDerivedStateFromProps',
         'shouldComponentUpdate',
+        'shouldComponentUpdate',
       ]);
     } else {
       expect(log).toEqual([
@@ -283,6 +285,7 @@ describe('ReactStrictMode', () => {
         'getDerivedStateFromProps',
         'getDerivedStateFromProps',
         'shouldComponentUpdate',
+        'shouldComponentUpdate',
         'render',
         'render',
         'componentDidUpdate',
@@ -305,6 +308,7 @@ describe('ReactStrictMode', () => {
         'getDerivedStateFromProps',
         'getDerivedStateFromProps',
         'shouldComponentUpdate',
+        'shouldComponentUpdate',
       ]);
     } else {
       expect(log).toEqual([

commit 41694201988c5e651f0c3bc69921d5c9717be88b
Author: Sebastian Markbåge <sebastian@calyptus.eu>
Date:   Mon Apr 6 15:43:39 2020 -0700

    Refactor Component Stack Traces (#18495)
    
    * Add feature flag
    
    * Split stack from current fiber
    
    You can get stack from any fiber, not just current.
    
    * Refactor description of component frames
    
    These should use fiber tags for switching. This also puts the relevant code
    behind DEV flags.
    
    * We no longer expose StrictMode in component stacks
    
    They're not super useful and will go away later anyway.
    
    * Update tests
    
    Context is no longer part of SSR stacks. This was already the case on the
    client.
    
    forwardRef no longer is wrapped on the stack. It's still in getComponentName
    but it's probably just noise in stacks. Eventually we'll remove the wrapper
    so it'll go away anyway. If we use native stack frames they won't have this
    extra wrapper.
    
    It also doesn't pick up displayName from the outer wrapper. We could maybe
    transfer it but this will also be fixed by removing the wrapper.
    
    * Forward displayName onto the inner function for forwardRef and memo in DEV
    
    This allows them to show up in stack traces.
    
    I'm not doing this for lazy because lazy is supposed to be called on the
    consuming side so you shouldn't assign it a name on that end. Especially
    not one that mutates the inner.
    
    * Use multiple instances of the fake component
    
    We mutate the inner component for its name so we need multiple copies.

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index 5382fcd33d..bbd419b1d3 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -40,8 +40,7 @@ describe('ReactStrictMode', () => {
       'Invalid ARIA attribute `ariaTypo`. ' +
         'ARIA attributes follow the pattern aria-* and must be lowercase.\n' +
         '    in div (at **)\n' +
-        '    in Foo (at **)\n' +
-        '    in StrictMode (at **)',
+        '    in Foo (at **)',
     );
   });
 
@@ -60,8 +59,7 @@ describe('ReactStrictMode', () => {
       'Invalid ARIA attribute `ariaTypo`. ' +
         'ARIA attributes follow the pattern aria-* and must be lowercase.\n' +
         '    in div (at **)\n' +
-        '    in Foo (at **)\n' +
-        '    in StrictMode (at **)',
+        '    in Foo (at **)',
     );
   });
 
@@ -759,7 +757,6 @@ describe('string refs', () => {
         'We recommend using useRef() or createRef() instead. ' +
         'Learn more about using refs safely here: ' +
         'https://fb.me/react-strict-mode-string-ref\n' +
-        '    in StrictMode (at **)\n' +
         '    in OuterComponent (at **)',
     );
 
@@ -802,7 +799,6 @@ describe('string refs', () => {
         'Learn more about using refs safely here: ' +
         'https://fb.me/react-strict-mode-string-ref\n' +
         '    in InnerComponent (at **)\n' +
-        '    in StrictMode (at **)\n' +
         '    in OuterComponent (at **)',
     );
 
@@ -883,7 +879,6 @@ describe('context legacy', () => {
         '\n\nLearn more about this warning here: ' +
         'https://fb.me/react-legacy-context' +
         '\n    in LegacyContextProvider (at **)' +
-        '\n    in StrictMode (at **)' +
         '\n    in div (at **)' +
         '\n    in Root (at **)',
     );

commit 65237a237e15af3b3c983d46b401c6af988c5f74
Author: Andrew Clark <git@andrewclark.io>
Date:   Mon Apr 13 10:28:59 2020 -0700

    Codemod it.experimental to gate pragma (#18582)
    
    * Codemod it.experimental to gate pragma
    
    Find-and-replace followed by Prettier
    
    * Delete it.experimental
    
    Removes the API from our test setup script

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index bbd419b1d3..a9eecf6127 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -362,76 +362,75 @@ describe('Concurrent Mode', () => {
     Scheduler = require('scheduler');
   });
 
-  it.experimental(
-    'should warn about unsafe legacy lifecycle methods anywhere in the tree',
-    () => {
-      class AsyncRoot extends React.Component {
-        UNSAFE_componentWillMount() {}
-        UNSAFE_componentWillUpdate() {}
-        render() {
-          return (
+  // @gate experimental
+  it('should warn about unsafe legacy lifecycle methods anywhere in the tree', () => {
+    class AsyncRoot extends React.Component {
+      UNSAFE_componentWillMount() {}
+      UNSAFE_componentWillUpdate() {}
+      render() {
+        return (
+          <div>
+            <Wrapper>
+              <Foo />
+            </Wrapper>
             <div>
-              <Wrapper>
-                <Foo />
-              </Wrapper>
-              <div>
-                <Bar />
-                <Foo />
-              </div>
+              <Bar />
+              <Foo />
             </div>
-          );
-        }
-      }
-      function Wrapper({children}) {
-        return <div>{children}</div>;
+          </div>
+        );
       }
-      class Foo extends React.Component {
-        UNSAFE_componentWillReceiveProps() {}
-        render() {
-          return null;
-        }
+    }
+    function Wrapper({children}) {
+      return <div>{children}</div>;
+    }
+    class Foo extends React.Component {
+      UNSAFE_componentWillReceiveProps() {}
+      render() {
+        return null;
       }
-      class Bar extends React.Component {
-        UNSAFE_componentWillReceiveProps() {}
-        render() {
-          return null;
-        }
+    }
+    class Bar extends React.Component {
+      UNSAFE_componentWillReceiveProps() {}
+      render() {
+        return null;
       }
+    }
 
-      const container = document.createElement('div');
-      const root = ReactDOM.createRoot(container);
-      root.render(<AsyncRoot />);
-      expect(() => Scheduler.unstable_flushAll()).toErrorDev(
-        [
-          /* eslint-disable max-len */
-          `Warning: Using UNSAFE_componentWillMount in strict mode is not recommended and may indicate bugs in your code. See https://fb.me/react-unsafe-component-lifecycles for details.
+    const container = document.createElement('div');
+    const root = ReactDOM.createRoot(container);
+    root.render(<AsyncRoot />);
+    expect(() => Scheduler.unstable_flushAll()).toErrorDev(
+      [
+        /* eslint-disable max-len */
+        `Warning: Using UNSAFE_componentWillMount in strict mode is not recommended and may indicate bugs in your code. See https://fb.me/react-unsafe-component-lifecycles for details.
 
 * Move code with side effects to componentDidMount, and set initial state in the constructor.
 
 Please update the following components: AsyncRoot`,
-          `Warning: Using UNSAFE_componentWillReceiveProps in strict mode is not recommended and may indicate bugs in your code. See https://fb.me/react-unsafe-component-lifecycles for details.
+        `Warning: Using UNSAFE_componentWillReceiveProps in strict mode is not recommended and may indicate bugs in your code. See https://fb.me/react-unsafe-component-lifecycles for details.
 
 * Move data fetching code or side effects to componentDidUpdate.
 * If you're updating state whenever props change, refactor your code to use memoization techniques or move it to static getDerivedStateFromProps. Learn more at: https://fb.me/react-derived-state
 
 Please update the following components: Bar, Foo`,
-          `Warning: Using UNSAFE_componentWillUpdate in strict mode is not recommended and may indicate bugs in your code. See https://fb.me/react-unsafe-component-lifecycles for details.
+        `Warning: Using UNSAFE_componentWillUpdate in strict mode is not recommended and may indicate bugs in your code. See https://fb.me/react-unsafe-component-lifecycles for details.
 
 * Move data fetching code or side effects to componentDidUpdate.
 
 Please update the following components: AsyncRoot`,
-          /* eslint-enable max-len */
-        ],
-        {withoutStack: true},
-      );
+        /* eslint-enable max-len */
+      ],
+      {withoutStack: true},
+    );
 
-      // Dedupe
-      root.render(<AsyncRoot />);
-      Scheduler.unstable_flushAll();
-    },
-  );
+    // Dedupe
+    root.render(<AsyncRoot />);
+    Scheduler.unstable_flushAll();
+  });
 
-  it.experimental('should coalesce warnings by lifecycle name', () => {
+  // @gate experimental
+  it('should coalesce warnings by lifecycle name', () => {
     class AsyncRoot extends React.Component {
       UNSAFE_componentWillMount() {}
       UNSAFE_componentWillUpdate() {}
@@ -513,52 +512,50 @@ Please update the following components: Parent`,
     Scheduler.unstable_flushAll();
   });
 
-  it.experimental(
-    'should warn about components not present during the initial render',
-    () => {
-      class AsyncRoot extends React.Component {
-        render() {
-          return this.props.foo ? <Foo /> : <Bar />;
-        }
-      }
-      class Foo extends React.Component {
-        UNSAFE_componentWillMount() {}
-        render() {
-          return null;
-        }
-      }
-      class Bar extends React.Component {
-        UNSAFE_componentWillMount() {}
-        render() {
-          return null;
-        }
-      }
-
-      const container = document.createElement('div');
-      const root = ReactDOM.createRoot(container);
-      root.render(<AsyncRoot foo={true} />);
-      expect(() =>
-        Scheduler.unstable_flushAll(),
-      ).toErrorDev(
-        'Using UNSAFE_componentWillMount in strict mode is not recommended',
-        {withoutStack: true},
-      );
+  // @gate experimental
+  it('should warn about components not present during the initial render', () => {
+    class AsyncRoot extends React.Component {
+      render() {
+        return this.props.foo ? <Foo /> : <Bar />;
+      }
+    }
+    class Foo extends React.Component {
+      UNSAFE_componentWillMount() {}
+      render() {
+        return null;
+      }
+    }
+    class Bar extends React.Component {
+      UNSAFE_componentWillMount() {}
+      render() {
+        return null;
+      }
+    }
 
-      root.render(<AsyncRoot foo={false} />);
-      expect(() =>
-        Scheduler.unstable_flushAll(),
-      ).toErrorDev(
-        'Using UNSAFE_componentWillMount in strict mode is not recommended',
-        {withoutStack: true},
-      );
+    const container = document.createElement('div');
+    const root = ReactDOM.createRoot(container);
+    root.render(<AsyncRoot foo={true} />);
+    expect(() =>
+      Scheduler.unstable_flushAll(),
+    ).toErrorDev(
+      'Using UNSAFE_componentWillMount in strict mode is not recommended',
+      {withoutStack: true},
+    );
+
+    root.render(<AsyncRoot foo={false} />);
+    expect(() =>
+      Scheduler.unstable_flushAll(),
+    ).toErrorDev(
+      'Using UNSAFE_componentWillMount in strict mode is not recommended',
+      {withoutStack: true},
+    );
 
-      // Dedupe
-      root.render(<AsyncRoot foo={true} />);
-      Scheduler.unstable_flushAll();
-      root.render(<AsyncRoot foo={false} />);
-      Scheduler.unstable_flushAll();
-    },
-  );
+    // Dedupe
+    root.render(<AsyncRoot foo={true} />);
+    Scheduler.unstable_flushAll();
+    root.render(<AsyncRoot foo={false} />);
+    Scheduler.unstable_flushAll();
+  });
 
   it('should also warn inside of "strict" mode trees', () => {
     const {StrictMode} = React;

commit fe7163e73dadceda2655736d97cdd745d7abc8ea
Author: Andrew Clark <git@andrewclark.io>
Date:   Mon May 4 22:25:41 2020 -0700

    Add unstable prefix to experimental APIs (#18825)
    
    We've been shipping unprefixed experimental APIs (like `createRoot` and
    `useTransition`) to the Experimental release channel, with the rationale
    that because these APIs do not appear in any stable release, we're free
    to change or remove them later without breaking any downstream projects.
    
    What we didn't consider is that downstream projects might be tempted to
    use feature detection:
    
    ```js
    const useTransition = React.useTransition || fallbackUseTransition;
    ```
    
    This pattern assumes that the version of `useTransition` that exists in
    the Experimental channel today has the same API contract as the final
    `useTransition` API that we'll eventually ship to stable.
    
    To discourage feature detection, I've added an `unstable_` prefix to
    all of our unstable APIs.
    
    The Facebook builds still have the unprefixed APIs, though. We will
    continue to support those; if we make any breaking changes, we'll
    migrate the internal callers like we usually do. To make testing easier,
    I added the `unstable_`-prefixed APIs to the www builds, too. That way
    our tests can always use the prefixed ones without gating on the
    release channel.

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index a9eecf6127..55e473f2b6 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -398,7 +398,7 @@ describe('Concurrent Mode', () => {
     }
 
     const container = document.createElement('div');
-    const root = ReactDOM.createRoot(container);
+    const root = ReactDOM.unstable_createRoot(container);
     root.render(<AsyncRoot />);
     expect(() => Scheduler.unstable_flushAll()).toErrorDev(
       [
@@ -454,7 +454,7 @@ Please update the following components: AsyncRoot`,
     }
 
     const container = document.createElement('div');
-    const root = ReactDOM.createRoot(container);
+    const root = ReactDOM.unstable_createRoot(container);
     root.render(<AsyncRoot />);
 
     expect(() => {
@@ -533,7 +533,7 @@ Please update the following components: Parent`,
     }
 
     const container = document.createElement('div');
-    const root = ReactDOM.createRoot(container);
+    const root = ReactDOM.unstable_createRoot(container);
     root.render(<AsyncRoot foo={true} />);
     expect(() =>
       Scheduler.unstable_flushAll(),

commit 4985bb0a80f5cbeaa61d21a7daf7da5ecff2d892
Author: Sebastian Markbåge <sebastian@calyptus.eu>
Date:   Thu May 28 10:25:39 2020 -0700

    Rename 17 to 18 in warnings (#19031)
    
    We're not really supposed to refer to future versions by numbers.
    
    These will all slip so these numbers don't make sense anymore.

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index 55e473f2b6..055b71d8c7 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -487,20 +487,20 @@ Please update the following components: AsyncRoot`,
         `Warning: componentWillMount has been renamed, and is not recommended for use. See https://fb.me/react-unsafe-component-lifecycles for details.
 
 * Move code with side effects to componentDidMount, and set initial state in the constructor.
-* Rename componentWillMount to UNSAFE_componentWillMount to suppress this warning in non-strict mode. In React 17.x, only the UNSAFE_ name will work. To rename all deprecated lifecycles to their new names, you can run \`npx react-codemod rename-unsafe-lifecycles\` in your project source folder.
+* Rename componentWillMount to UNSAFE_componentWillMount to suppress this warning in non-strict mode. In React 18.x, only the UNSAFE_ name will work. To rename all deprecated lifecycles to their new names, you can run \`npx react-codemod rename-unsafe-lifecycles\` in your project source folder.
 
 Please update the following components: Parent`,
         `Warning: componentWillReceiveProps has been renamed, and is not recommended for use. See https://fb.me/react-unsafe-component-lifecycles for details.
 
 * Move data fetching code or side effects to componentDidUpdate.
 * If you're updating state whenever props change, refactor your code to use memoization techniques or move it to static getDerivedStateFromProps. Learn more at: https://fb.me/react-derived-state
-* Rename componentWillReceiveProps to UNSAFE_componentWillReceiveProps to suppress this warning in non-strict mode. In React 17.x, only the UNSAFE_ name will work. To rename all deprecated lifecycles to their new names, you can run \`npx react-codemod rename-unsafe-lifecycles\` in your project source folder.
+* Rename componentWillReceiveProps to UNSAFE_componentWillReceiveProps to suppress this warning in non-strict mode. In React 18.x, only the UNSAFE_ name will work. To rename all deprecated lifecycles to their new names, you can run \`npx react-codemod rename-unsafe-lifecycles\` in your project source folder.
 
 Please update the following components: Parent`,
         `Warning: componentWillUpdate has been renamed, and is not recommended for use. See https://fb.me/react-unsafe-component-lifecycles for details.
 
 * Move data fetching code or side effects to componentDidUpdate.
-* Rename componentWillUpdate to UNSAFE_componentWillUpdate to suppress this warning in non-strict mode. In React 17.x, only the UNSAFE_ name will work. To rename all deprecated lifecycles to their new names, you can run \`npx react-codemod rename-unsafe-lifecycles\` in your project source folder.
+* Rename componentWillUpdate to UNSAFE_componentWillUpdate to suppress this warning in non-strict mode. In React 18.x, only the UNSAFE_ name will work. To rename all deprecated lifecycles to their new names, you can run \`npx react-codemod rename-unsafe-lifecycles\` in your project source folder.
 
 Please update the following components: Parent`,
         /* eslint-enable max-len */

commit 702fad4b1b48ac8f626ed3f35e8f86f5ea728084
Author: CY Lim <5622951+cylim@users.noreply.github.com>
Date:   Mon Aug 17 20:25:50 2020 +0800

    refactor fb.me redirect link to reactjs.org/link (#19598)
    
    * refactor fb.me url to reactjs.org/link
    
    * Update ESLintRuleExhaustiveDeps-test.js
    
    * Update ReactDOMServerIntegrationUntrustedURL-test.internal.js
    
    * Update createReactClassIntegration-test.js
    
    * Update ReactDOMServerIntegrationUntrustedURL-test.internal.js
    
    Co-authored-by: Dan Abramov <dan.abramov@gmail.com>

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index 055b71d8c7..60862d12a9 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -403,18 +403,18 @@ describe('Concurrent Mode', () => {
     expect(() => Scheduler.unstable_flushAll()).toErrorDev(
       [
         /* eslint-disable max-len */
-        `Warning: Using UNSAFE_componentWillMount in strict mode is not recommended and may indicate bugs in your code. See https://fb.me/react-unsafe-component-lifecycles for details.
+        `Warning: Using UNSAFE_componentWillMount in strict mode is not recommended and may indicate bugs in your code. See https://reactjs.org/link/unsafe-component-lifecycles for details.
 
 * Move code with side effects to componentDidMount, and set initial state in the constructor.
 
 Please update the following components: AsyncRoot`,
-        `Warning: Using UNSAFE_componentWillReceiveProps in strict mode is not recommended and may indicate bugs in your code. See https://fb.me/react-unsafe-component-lifecycles for details.
+        `Warning: Using UNSAFE_componentWillReceiveProps in strict mode is not recommended and may indicate bugs in your code. See https://reactjs.org/link/unsafe-component-lifecycles for details.
 
 * Move data fetching code or side effects to componentDidUpdate.
-* If you're updating state whenever props change, refactor your code to use memoization techniques or move it to static getDerivedStateFromProps. Learn more at: https://fb.me/react-derived-state
+* If you're updating state whenever props change, refactor your code to use memoization techniques or move it to static getDerivedStateFromProps. Learn more at: https://reactjs.org/link/derived-state
 
 Please update the following components: Bar, Foo`,
-        `Warning: Using UNSAFE_componentWillUpdate in strict mode is not recommended and may indicate bugs in your code. See https://fb.me/react-unsafe-component-lifecycles for details.
+        `Warning: Using UNSAFE_componentWillUpdate in strict mode is not recommended and may indicate bugs in your code. See https://reactjs.org/link/unsafe-component-lifecycles for details.
 
 * Move data fetching code or side effects to componentDidUpdate.
 
@@ -461,18 +461,18 @@ Please update the following components: AsyncRoot`,
       expect(() => Scheduler.unstable_flushAll()).toErrorDev(
         [
           /* eslint-disable max-len */
-          `Warning: Using UNSAFE_componentWillMount in strict mode is not recommended and may indicate bugs in your code. See https://fb.me/react-unsafe-component-lifecycles for details.
+          `Warning: Using UNSAFE_componentWillMount in strict mode is not recommended and may indicate bugs in your code. See https://reactjs.org/link/unsafe-component-lifecycles for details.
 
 * Move code with side effects to componentDidMount, and set initial state in the constructor.
 
 Please update the following components: AsyncRoot`,
-          `Warning: Using UNSAFE_componentWillReceiveProps in strict mode is not recommended and may indicate bugs in your code. See https://fb.me/react-unsafe-component-lifecycles for details.
+          `Warning: Using UNSAFE_componentWillReceiveProps in strict mode is not recommended and may indicate bugs in your code. See https://reactjs.org/link/unsafe-component-lifecycles for details.
 
 * Move data fetching code or side effects to componentDidUpdate.
-* If you're updating state whenever props change, refactor your code to use memoization techniques or move it to static getDerivedStateFromProps. Learn more at: https://fb.me/react-derived-state
+* If you're updating state whenever props change, refactor your code to use memoization techniques or move it to static getDerivedStateFromProps. Learn more at: https://reactjs.org/link/derived-state
 
 Please update the following components: Child`,
-          `Warning: Using UNSAFE_componentWillUpdate in strict mode is not recommended and may indicate bugs in your code. See https://fb.me/react-unsafe-component-lifecycles for details.
+          `Warning: Using UNSAFE_componentWillUpdate in strict mode is not recommended and may indicate bugs in your code. See https://reactjs.org/link/unsafe-component-lifecycles for details.
 
 * Move data fetching code or side effects to componentDidUpdate.
 
@@ -484,20 +484,20 @@ Please update the following components: AsyncRoot`,
     }).toWarnDev(
       [
         /* eslint-disable max-len */
-        `Warning: componentWillMount has been renamed, and is not recommended for use. See https://fb.me/react-unsafe-component-lifecycles for details.
+        `Warning: componentWillMount has been renamed, and is not recommended for use. See https://reactjs.org/link/unsafe-component-lifecycles for details.
 
 * Move code with side effects to componentDidMount, and set initial state in the constructor.
 * Rename componentWillMount to UNSAFE_componentWillMount to suppress this warning in non-strict mode. In React 18.x, only the UNSAFE_ name will work. To rename all deprecated lifecycles to their new names, you can run \`npx react-codemod rename-unsafe-lifecycles\` in your project source folder.
 
 Please update the following components: Parent`,
-        `Warning: componentWillReceiveProps has been renamed, and is not recommended for use. See https://fb.me/react-unsafe-component-lifecycles for details.
+        `Warning: componentWillReceiveProps has been renamed, and is not recommended for use. See https://reactjs.org/link/unsafe-component-lifecycles for details.
 
 * Move data fetching code or side effects to componentDidUpdate.
-* If you're updating state whenever props change, refactor your code to use memoization techniques or move it to static getDerivedStateFromProps. Learn more at: https://fb.me/react-derived-state
+* If you're updating state whenever props change, refactor your code to use memoization techniques or move it to static getDerivedStateFromProps. Learn more at: https://reactjs.org/link/derived-state
 * Rename componentWillReceiveProps to UNSAFE_componentWillReceiveProps to suppress this warning in non-strict mode. In React 18.x, only the UNSAFE_ name will work. To rename all deprecated lifecycles to their new names, you can run \`npx react-codemod rename-unsafe-lifecycles\` in your project source folder.
 
 Please update the following components: Parent`,
-        `Warning: componentWillUpdate has been renamed, and is not recommended for use. See https://fb.me/react-unsafe-component-lifecycles for details.
+        `Warning: componentWillUpdate has been renamed, and is not recommended for use. See https://reactjs.org/link/unsafe-component-lifecycles for details.
 
 * Move data fetching code or side effects to componentDidUpdate.
 * Rename componentWillUpdate to UNSAFE_componentWillUpdate to suppress this warning in non-strict mode. In React 18.x, only the UNSAFE_ name will work. To rename all deprecated lifecycles to their new names, you can run \`npx react-codemod rename-unsafe-lifecycles\` in your project source folder.
@@ -753,7 +753,7 @@ describe('string refs', () => {
         'String refs are a source of potential bugs and should be avoided. ' +
         'We recommend using useRef() or createRef() instead. ' +
         'Learn more about using refs safely here: ' +
-        'https://fb.me/react-strict-mode-string-ref\n' +
+        'https://reactjs.org/link/strict-mode-string-ref\n' +
         '    in OuterComponent (at **)',
     );
 
@@ -794,7 +794,7 @@ describe('string refs', () => {
         'String refs are a source of potential bugs and should be avoided. ' +
         'We recommend using useRef() or createRef() instead. ' +
         'Learn more about using refs safely here: ' +
-        'https://fb.me/react-strict-mode-string-ref\n' +
+        'https://reactjs.org/link/strict-mode-string-ref\n' +
         '    in InnerComponent (at **)\n' +
         '    in OuterComponent (at **)',
     );
@@ -874,7 +874,7 @@ describe('context legacy', () => {
         '\n\nPlease update the following components: ' +
         'FunctionalLegacyContextConsumer, LegacyContextConsumer, LegacyContextProvider' +
         '\n\nLearn more about this warning here: ' +
-        'https://fb.me/react-legacy-context' +
+        'https://reactjs.org/link/legacy-context' +
         '\n    in LegacyContextProvider (at **)' +
         '\n    in div (at **)' +
         '\n    in Root (at **)',

commit 15fb8c3045064e13e81706a36bf0e4e419803c97
Author: Brian Vaughn <bvaughn@fb.com>
Date:   Mon May 3 16:57:03 2021 -0400

    createRoot API is no longer strict by default (#21417)

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index 60862d12a9..c6d1f7ee72 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -363,8 +363,15 @@ describe('Concurrent Mode', () => {
   });
 
   // @gate experimental
-  it('should warn about unsafe legacy lifecycle methods anywhere in the tree', () => {
-    class AsyncRoot extends React.Component {
+  it('should warn about unsafe legacy lifecycle methods anywhere in a StrictMode tree', () => {
+    function StrictRoot() {
+      return (
+        <React.StrictMode>
+          <App />
+        </React.StrictMode>
+      );
+    }
+    class App extends React.Component {
       UNSAFE_componentWillMount() {}
       UNSAFE_componentWillUpdate() {}
       render() {
@@ -399,7 +406,7 @@ describe('Concurrent Mode', () => {
 
     const container = document.createElement('div');
     const root = ReactDOM.unstable_createRoot(container);
-    root.render(<AsyncRoot />);
+    root.render(<StrictRoot />);
     expect(() => Scheduler.unstable_flushAll()).toErrorDev(
       [
         /* eslint-disable max-len */
@@ -407,7 +414,7 @@ describe('Concurrent Mode', () => {
 
 * Move code with side effects to componentDidMount, and set initial state in the constructor.
 
-Please update the following components: AsyncRoot`,
+Please update the following components: App`,
         `Warning: Using UNSAFE_componentWillReceiveProps in strict mode is not recommended and may indicate bugs in your code. See https://reactjs.org/link/unsafe-component-lifecycles for details.
 
 * Move data fetching code or side effects to componentDidUpdate.
@@ -418,20 +425,27 @@ Please update the following components: Bar, Foo`,
 
 * Move data fetching code or side effects to componentDidUpdate.
 
-Please update the following components: AsyncRoot`,
+Please update the following components: App`,
         /* eslint-enable max-len */
       ],
       {withoutStack: true},
     );
 
     // Dedupe
-    root.render(<AsyncRoot />);
+    root.render(<App />);
     Scheduler.unstable_flushAll();
   });
 
   // @gate experimental
   it('should coalesce warnings by lifecycle name', () => {
-    class AsyncRoot extends React.Component {
+    function StrictRoot() {
+      return (
+        <React.StrictMode>
+          <App />
+        </React.StrictMode>
+      );
+    }
+    class App extends React.Component {
       UNSAFE_componentWillMount() {}
       UNSAFE_componentWillUpdate() {}
       render() {
@@ -455,7 +469,7 @@ Please update the following components: AsyncRoot`,
 
     const container = document.createElement('div');
     const root = ReactDOM.unstable_createRoot(container);
-    root.render(<AsyncRoot />);
+    root.render(<StrictRoot />);
 
     expect(() => {
       expect(() => Scheduler.unstable_flushAll()).toErrorDev(
@@ -465,7 +479,7 @@ Please update the following components: AsyncRoot`,
 
 * Move code with side effects to componentDidMount, and set initial state in the constructor.
 
-Please update the following components: AsyncRoot`,
+Please update the following components: App`,
           `Warning: Using UNSAFE_componentWillReceiveProps in strict mode is not recommended and may indicate bugs in your code. See https://reactjs.org/link/unsafe-component-lifecycles for details.
 
 * Move data fetching code or side effects to componentDidUpdate.
@@ -476,7 +490,7 @@ Please update the following components: Child`,
 
 * Move data fetching code or side effects to componentDidUpdate.
 
-Please update the following components: AsyncRoot`,
+Please update the following components: App`,
           /* eslint-enable max-len */
         ],
         {withoutStack: true},
@@ -508,16 +522,14 @@ Please update the following components: Parent`,
       {withoutStack: true},
     );
     // Dedupe
-    root.render(<AsyncRoot />);
+    root.render(<StrictRoot />);
     Scheduler.unstable_flushAll();
   });
 
   // @gate experimental
   it('should warn about components not present during the initial render', () => {
-    class AsyncRoot extends React.Component {
-      render() {
-        return this.props.foo ? <Foo /> : <Bar />;
-      }
+    function StrictRoot({foo}) {
+      return <React.StrictMode>{foo ? <Foo /> : <Bar />}</React.StrictMode>;
     }
     class Foo extends React.Component {
       UNSAFE_componentWillMount() {}
@@ -534,7 +546,7 @@ Please update the following components: Parent`,
 
     const container = document.createElement('div');
     const root = ReactDOM.unstable_createRoot(container);
-    root.render(<AsyncRoot foo={true} />);
+    root.render(<StrictRoot foo={true} />);
     expect(() =>
       Scheduler.unstable_flushAll(),
     ).toErrorDev(
@@ -542,7 +554,7 @@ Please update the following components: Parent`,
       {withoutStack: true},
     );
 
-    root.render(<AsyncRoot foo={false} />);
+    root.render(<StrictRoot foo={false} />);
     expect(() =>
       Scheduler.unstable_flushAll(),
     ).toErrorDev(
@@ -551,9 +563,9 @@ Please update the following components: Parent`,
     );
 
     // Dedupe
-    root.render(<AsyncRoot foo={true} />);
+    root.render(<StrictRoot foo={true} />);
     Scheduler.unstable_flushAll();
-    root.render(<AsyncRoot foo={false} />);
+    root.render(<StrictRoot foo={false} />);
     Scheduler.unstable_flushAll();
   });
 

commit 2bf4805e4bd63dab45cd7f5e1ad32ef8fed3f6ab
Author: Brian Vaughn <bvaughn@fb.com>
Date:   Wed May 12 11:28:14 2021 -0400

    Update entry point exports (#21488)
    
    The following APIs have been added to the `react` stable entry point:
    * `SuspenseList`
    * `startTransition`
    * `unstable_createMutableSource`
    * `unstable_useMutableSource`
    * `useDeferredValue`
    * `useTransition`
    
    The following APIs have been added or removed from the `react-dom` stable entry point:
    * `createRoot`
    * `unstable_createPortal` (removed)
    
    The following APIs have been added to the `react-is` stable entry point:
    * `SuspenseList`
    * `isSuspenseList`
    
    The following feature flags have been changed from experimental to true:
    * `enableLazyElements`
    * `enableSelectiveHydration`
    * `enableSuspenseServerRenderer`

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index c6d1f7ee72..a41f2ef2cc 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -362,7 +362,6 @@ describe('Concurrent Mode', () => {
     Scheduler = require('scheduler');
   });
 
-  // @gate experimental
   it('should warn about unsafe legacy lifecycle methods anywhere in a StrictMode tree', () => {
     function StrictRoot() {
       return (
@@ -405,7 +404,7 @@ describe('Concurrent Mode', () => {
     }
 
     const container = document.createElement('div');
-    const root = ReactDOM.unstable_createRoot(container);
+    const root = ReactDOM.createRoot(container);
     root.render(<StrictRoot />);
     expect(() => Scheduler.unstable_flushAll()).toErrorDev(
       [
@@ -436,7 +435,6 @@ Please update the following components: App`,
     Scheduler.unstable_flushAll();
   });
 
-  // @gate experimental
   it('should coalesce warnings by lifecycle name', () => {
     function StrictRoot() {
       return (
@@ -468,7 +466,7 @@ Please update the following components: App`,
     }
 
     const container = document.createElement('div');
-    const root = ReactDOM.unstable_createRoot(container);
+    const root = ReactDOM.createRoot(container);
     root.render(<StrictRoot />);
 
     expect(() => {
@@ -526,7 +524,6 @@ Please update the following components: Parent`,
     Scheduler.unstable_flushAll();
   });
 
-  // @gate experimental
   it('should warn about components not present during the initial render', () => {
     function StrictRoot({foo}) {
       return <React.StrictMode>{foo ? <Foo /> : <Bar />}</React.StrictMode>;
@@ -545,7 +542,7 @@ Please update the following components: Parent`,
     }
 
     const container = document.createElement('div');
-    const root = ReactDOM.unstable_createRoot(container);
+    const root = ReactDOM.createRoot(container);
     root.render(<StrictRoot foo={true} />);
     expect(() =>
       Scheduler.unstable_flushAll(),

commit 51b0becf3e8a8084d8a2ee85ce8b3a1d9ace6ecd
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Thu Jun 24 19:50:07 2021 +0100

    Always keep disabled logs in the second pass (#21739)
    
    * Add tests for disabled logs
    
    * Always keep disabled logs in the second pass
    
    * Jest nit
    
    * Always use the second result

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index a41f2ef2cc..5bd16f9c54 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -892,4 +892,196 @@ describe('context legacy', () => {
     // Dedupe
     ReactDOM.render(<Root />, container);
   });
+
+  describe('disableLogs', () => {
+    it('disables logs once for class double render', () => {
+      spyOnDevAndProd(console, 'log');
+
+      let count = 0;
+      class Foo extends React.Component {
+        render() {
+          count++;
+          console.log('foo ' + count);
+          return null;
+        }
+      }
+
+      const container = document.createElement('div');
+      ReactDOM.render(
+        <React.StrictMode>
+          <Foo />
+        </React.StrictMode>,
+        container,
+      );
+
+      expect(count).toBe(__DEV__ ? 2 : 1);
+      expect(console.log).toBeCalledTimes(1);
+      // Note: we should display the first log because otherwise
+      // there is a risk of suppressing warnings when they happen,
+      // and on the next render they'd get deduplicated and ignored.
+      expect(console.log).toBeCalledWith('foo 1');
+    });
+
+    it('disables logs once for class double ctor', () => {
+      spyOnDevAndProd(console, 'log');
+
+      let count = 0;
+      class Foo extends React.Component {
+        constructor(props) {
+          super(props);
+          count++;
+          console.log('foo ' + count);
+        }
+        render() {
+          return null;
+        }
+      }
+
+      const container = document.createElement('div');
+      ReactDOM.render(
+        <React.StrictMode>
+          <Foo />
+        </React.StrictMode>,
+        container,
+      );
+
+      expect(count).toBe(__DEV__ ? 2 : 1);
+      expect(console.log).toBeCalledTimes(1);
+      // Note: we should display the first log because otherwise
+      // there is a risk of suppressing warnings when they happen,
+      // and on the next render they'd get deduplicated and ignored.
+      expect(console.log).toBeCalledWith('foo 1');
+    });
+
+    it('disables logs once for class double getDerivedStateFromProps', () => {
+      spyOnDevAndProd(console, 'log');
+
+      let count = 0;
+      class Foo extends React.Component {
+        state = {};
+        static getDerivedStateFromProps() {
+          count++;
+          console.log('foo ' + count);
+          return {};
+        }
+        render() {
+          return null;
+        }
+      }
+
+      const container = document.createElement('div');
+      ReactDOM.render(
+        <React.StrictMode>
+          <Foo />
+        </React.StrictMode>,
+        container,
+      );
+
+      expect(count).toBe(__DEV__ ? 2 : 1);
+      expect(console.log).toBeCalledTimes(1);
+      // Note: we should display the first log because otherwise
+      // there is a risk of suppressing warnings when they happen,
+      // and on the next render they'd get deduplicated and ignored.
+      expect(console.log).toBeCalledWith('foo 1');
+    });
+
+    it('disables logs once for class double shouldComponentUpdate', () => {
+      spyOnDevAndProd(console, 'log');
+
+      let count = 0;
+      class Foo extends React.Component {
+        state = {};
+        shouldComponentUpdate() {
+          count++;
+          console.log('foo ' + count);
+          return {};
+        }
+        render() {
+          return null;
+        }
+      }
+
+      const container = document.createElement('div');
+      ReactDOM.render(
+        <React.StrictMode>
+          <Foo />
+        </React.StrictMode>,
+        container,
+      );
+      // Trigger sCU:
+      ReactDOM.render(
+        <React.StrictMode>
+          <Foo />
+        </React.StrictMode>,
+        container,
+      );
+
+      expect(count).toBe(__DEV__ ? 2 : 1);
+      expect(console.log).toBeCalledTimes(1);
+      // Note: we should display the first log because otherwise
+      // there is a risk of suppressing warnings when they happen,
+      // and on the next render they'd get deduplicated and ignored.
+      expect(console.log).toBeCalledWith('foo 1');
+    });
+
+    it('disables logs once for class state updaters', () => {
+      spyOnDevAndProd(console, 'log');
+
+      let inst;
+      let count = 0;
+      class Foo extends React.Component {
+        state = {};
+        render() {
+          inst = this;
+          return null;
+        }
+      }
+
+      const container = document.createElement('div');
+      ReactDOM.render(
+        <React.StrictMode>
+          <Foo />
+        </React.StrictMode>,
+        container,
+      );
+      inst.setState(() => {
+        count++;
+        console.log('foo ' + count);
+        return {};
+      });
+
+      expect(count).toBe(__DEV__ ? 2 : 1);
+      expect(console.log).toBeCalledTimes(1);
+      // Note: we should display the first log because otherwise
+      // there is a risk of suppressing warnings when they happen,
+      // and on the next render they'd get deduplicated and ignored.
+      expect(console.log).toBeCalledWith('foo 1');
+    });
+
+    it('disables logs once for function double render', () => {
+      spyOnDevAndProd(console, 'log');
+
+      let count = 0;
+      function Foo() {
+        count++;
+        console.log('foo ' + count);
+        return null;
+      }
+
+      const container = document.createElement('div');
+      ReactDOM.render(
+        <React.StrictMode>
+          <Foo />
+        </React.StrictMode>,
+        container,
+      );
+
+      expect(count).toBe(__DEV__ ? 2 : 1);
+      expect(console.log).toBeCalledTimes(1);
+      // Note: we should display the first log because otherwise
+      // there is a risk of suppressing warnings when they happen,
+      // and on the next render they'd get deduplicated and ignored.
+      expect(console.log).toBeCalledWith('foo 1');
+    });
+  });
 });

commit 60a30cf32e1f974b82f0c7da9d8a03822e5b5208
Author: Luna Ruan <lunaris.ruan@gmail.com>
Date:   Wed Aug 25 15:35:38 2021 -0700

    Console Logging for StrictMode Double Rendering (#22030)
    
    React currently suppress console logs in StrictMode during double rendering. However, this causes a lot of confusion. This PR moves the console suppression logic from React into React Devtools. Now by default, we no longer suppress console logs. Instead, we gray out the logs in console during double render. We also add a setting in React Devtools to allow developers to hide console logs during double render if they choose.

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index 5bd16f9c54..3676d5719a 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -893,8 +893,8 @@ describe('context legacy', () => {
     ReactDOM.render(<Root />, container);
   });
 
-  describe('disableLogs', () => {
-    it('disables logs once for class double render', () => {
+  describe('logging', () => {
+    it('does not disable logs for class double render', () => {
       spyOnDevAndProd(console, 'log');
 
       let count = 0;
@@ -915,14 +915,14 @@ describe('context legacy', () => {
       );
 
       expect(count).toBe(__DEV__ ? 2 : 1);
-      expect(console.log).toBeCalledTimes(1);
+      expect(console.log).toBeCalledTimes(__DEV__ ? 2 : 1);
       // Note: we should display the first log because otherwise
       // there is a risk of suppressing warnings when they happen,
       // and on the next render they'd get deduplicated and ignored.
       expect(console.log).toBeCalledWith('foo 1');
     });
 
-    it('disables logs once for class double ctor', () => {
+    it('does not disable logs for class double ctor', () => {
       spyOnDevAndProd(console, 'log');
 
       let count = 0;
@@ -946,14 +946,14 @@ describe('context legacy', () => {
       );
 
       expect(count).toBe(__DEV__ ? 2 : 1);
-      expect(console.log).toBeCalledTimes(1);
+      expect(console.log).toBeCalledTimes(__DEV__ ? 2 : 1);
       // Note: we should display the first log because otherwise
       // there is a risk of suppressing warnings when they happen,
       // and on the next render they'd get deduplicated and ignored.
       expect(console.log).toBeCalledWith('foo 1');
     });
 
-    it('disables logs once for class double getDerivedStateFromProps', () => {
+    it('does not disable logs for class double getDerivedStateFromProps', () => {
       spyOnDevAndProd(console, 'log');
 
       let count = 0;
@@ -978,14 +978,14 @@ describe('context legacy', () => {
       );
 
       expect(count).toBe(__DEV__ ? 2 : 1);
-      expect(console.log).toBeCalledTimes(1);
+      expect(console.log).toBeCalledTimes(__DEV__ ? 2 : 1);
       // Note: we should display the first log because otherwise
       // there is a risk of suppressing warnings when they happen,
       // and on the next render they'd get deduplicated and ignored.
       expect(console.log).toBeCalledWith('foo 1');
     });
 
-    it('disables logs once for class double shouldComponentUpdate', () => {
+    it('does not disable logs for class double shouldComponentUpdate', () => {
       spyOnDevAndProd(console, 'log');
 
       let count = 0;
@@ -1017,14 +1017,14 @@ describe('context legacy', () => {
       );
 
       expect(count).toBe(__DEV__ ? 2 : 1);
-      expect(console.log).toBeCalledTimes(1);
+      expect(console.log).toBeCalledTimes(__DEV__ ? 2 : 1);
       // Note: we should display the first log because otherwise
       // there is a risk of suppressing warnings when they happen,
       // and on the next render they'd get deduplicated and ignored.
       expect(console.log).toBeCalledWith('foo 1');
     });
 
-    it('disables logs once for class state updaters', () => {
+    it('does not disable logs for class state updaters', () => {
       spyOnDevAndProd(console, 'log');
 
       let inst;
@@ -1051,14 +1051,14 @@ describe('context legacy', () => {
       });
 
       expect(count).toBe(__DEV__ ? 2 : 1);
-      expect(console.log).toBeCalledTimes(1);
+      expect(console.log).toBeCalledTimes(__DEV__ ? 2 : 1);
       // Note: we should display the first log because otherwise
       // there is a risk of suppressing warnings when they happen,
       // and on the next render they'd get deduplicated and ignored.
       expect(console.log).toBeCalledWith('foo 1');
     });
 
-    it('disables logs once for function double render', () => {
+    it('does not disable logs for function double render', () => {
       spyOnDevAndProd(console, 'log');
 
       let count = 0;
@@ -1077,7 +1077,7 @@ describe('context legacy', () => {
       );
 
       expect(count).toBe(__DEV__ ? 2 : 1);
-      expect(console.log).toBeCalledTimes(1);
+      expect(console.log).toBeCalledTimes(__DEV__ ? 2 : 1);
       // Note: we should display the first log because otherwise
       // there is a risk of suppressing warnings when they happen,
       // and on the next render they'd get deduplicated and ignored.

commit fc40f02adb2d11e4936cc31119c7a45acc471a7a
Author: Luna Ruan <lunaris.ruan@gmail.com>
Date:   Wed Sep 1 11:56:52 2021 -0700

    Add consoleManagedByDevToolsDuringStrictMode feature flag in React Reconciler (#22196)

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index 3676d5719a..84fbead1f4 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -15,6 +15,8 @@ let ReactDOMServer;
 let Scheduler;
 let PropTypes;
 
+const ReactFeatureFlags = require('shared/ReactFeatureFlags');
+
 describe('ReactStrictMode', () => {
   beforeEach(() => {
     jest.resetModules();
@@ -893,195 +895,393 @@ describe('context legacy', () => {
     ReactDOM.render(<Root />, container);
   });
 
-  describe('logging', () => {
-    it('does not disable logs for class double render', () => {
-      spyOnDevAndProd(console, 'log');
+  describe('console logs logging', () => {
+    beforeEach(() => {
+      jest.resetModules();
+      React = require('react');
+      ReactDOM = require('react-dom');
+    });
 
-      let count = 0;
-      class Foo extends React.Component {
-        render() {
-          count++;
-          console.log('foo ' + count);
-          return null;
+    if (ReactFeatureFlags.consoleManagedByDevToolsDuringStrictMode) {
+      it('does not disable logs for class double render', () => {
+        spyOnDevAndProd(console, 'log');
+
+        let count = 0;
+        class Foo extends React.Component {
+          render() {
+            count++;
+            console.log('foo ' + count);
+            return null;
+          }
         }
-      }
 
-      const container = document.createElement('div');
-      ReactDOM.render(
-        <React.StrictMode>
-          <Foo />
-        </React.StrictMode>,
-        container,
-      );
+        const container = document.createElement('div');
+        ReactDOM.render(
+          <React.StrictMode>
+            <Foo />
+          </React.StrictMode>,
+          container,
+        );
 
-      expect(count).toBe(__DEV__ ? 2 : 1);
-      expect(console.log).toBeCalledTimes(__DEV__ ? 2 : 1);
-      // Note: we should display the first log because otherwise
-      // there is a risk of suppressing warnings when they happen,
-      // and on the next render they'd get deduplicated and ignored.
-      expect(console.log).toBeCalledWith('foo 1');
-    });
+        expect(count).toBe(__DEV__ ? 2 : 1);
+        expect(console.log).toBeCalledTimes(__DEV__ ? 2 : 1);
+        // Note: we should display the first log because otherwise
+        // there is a risk of suppressing warnings when they happen,
+        // and on the next render they'd get deduplicated and ignored.
+        expect(console.log).toBeCalledWith('foo 1');
+      });
 
-    it('does not disable logs for class double ctor', () => {
-      spyOnDevAndProd(console, 'log');
+      it('does not disable logs for class double ctor', () => {
+        spyOnDevAndProd(console, 'log');
+
+        let count = 0;
+        class Foo extends React.Component {
+          constructor(props) {
+            super(props);
+            count++;
+            console.log('foo ' + count);
+          }
+          render() {
+            return null;
+          }
+        }
 
-      let count = 0;
-      class Foo extends React.Component {
-        constructor(props) {
-          super(props);
-          count++;
-          console.log('foo ' + count);
+        const container = document.createElement('div');
+        ReactDOM.render(
+          <React.StrictMode>
+            <Foo />
+          </React.StrictMode>,
+          container,
+        );
+
+        expect(count).toBe(__DEV__ ? 2 : 1);
+        expect(console.log).toBeCalledTimes(__DEV__ ? 2 : 1);
+        // Note: we should display the first log because otherwise
+        // there is a risk of suppressing warnings when they happen,
+        // and on the next render they'd get deduplicated and ignored.
+        expect(console.log).toBeCalledWith('foo 1');
+      });
+
+      it('does not disable logs for class double getDerivedStateFromProps', () => {
+        spyOnDevAndProd(console, 'log');
+
+        let count = 0;
+        class Foo extends React.Component {
+          state = {};
+          static getDerivedStateFromProps() {
+            count++;
+            console.log('foo ' + count);
+            return {};
+          }
+          render() {
+            return null;
+          }
         }
-        render() {
-          return null;
+
+        const container = document.createElement('div');
+        ReactDOM.render(
+          <React.StrictMode>
+            <Foo />
+          </React.StrictMode>,
+          container,
+        );
+
+        expect(count).toBe(__DEV__ ? 2 : 1);
+        expect(console.log).toBeCalledTimes(__DEV__ ? 2 : 1);
+        // Note: we should display the first log because otherwise
+        // there is a risk of suppressing warnings when they happen,
+        // and on the next render they'd get deduplicated and ignored.
+        expect(console.log).toBeCalledWith('foo 1');
+      });
+
+      it('does not disable logs for class double shouldComponentUpdate', () => {
+        spyOnDevAndProd(console, 'log');
+
+        let count = 0;
+        class Foo extends React.Component {
+          state = {};
+          shouldComponentUpdate() {
+            count++;
+            console.log('foo ' + count);
+            return {};
+          }
+          render() {
+            return null;
+          }
         }
-      }
 
-      const container = document.createElement('div');
-      ReactDOM.render(
-        <React.StrictMode>
-          <Foo />
-        </React.StrictMode>,
-        container,
-      );
+        const container = document.createElement('div');
+        ReactDOM.render(
+          <React.StrictMode>
+            <Foo />
+          </React.StrictMode>,
+          container,
+        );
+        // Trigger sCU:
+        ReactDOM.render(
+          <React.StrictMode>
+            <Foo />
+          </React.StrictMode>,
+          container,
+        );
 
-      expect(count).toBe(__DEV__ ? 2 : 1);
-      expect(console.log).toBeCalledTimes(__DEV__ ? 2 : 1);
-      // Note: we should display the first log because otherwise
-      // there is a risk of suppressing warnings when they happen,
-      // and on the next render they'd get deduplicated and ignored.
-      expect(console.log).toBeCalledWith('foo 1');
-    });
+        expect(count).toBe(__DEV__ ? 2 : 1);
+        expect(console.log).toBeCalledTimes(__DEV__ ? 2 : 1);
+        // Note: we should display the first log because otherwise
+        // there is a risk of suppressing warnings when they happen,
+        // and on the next render they'd get deduplicated and ignored.
+        expect(console.log).toBeCalledWith('foo 1');
+      });
 
-    it('does not disable logs for class double getDerivedStateFromProps', () => {
-      spyOnDevAndProd(console, 'log');
+      it('does not disable logs for class state updaters', () => {
+        spyOnDevAndProd(console, 'log');
+
+        let inst;
+        let count = 0;
+        class Foo extends React.Component {
+          state = {};
+          render() {
+            inst = this;
+            return null;
+          }
+        }
 
-      let count = 0;
-      class Foo extends React.Component {
-        state = {};
-        static getDerivedStateFromProps() {
+        const container = document.createElement('div');
+        ReactDOM.render(
+          <React.StrictMode>
+            <Foo />
+          </React.StrictMode>,
+          container,
+        );
+        inst.setState(() => {
           count++;
           console.log('foo ' + count);
           return {};
-        }
-        render() {
+        });
+
+        expect(count).toBe(__DEV__ ? 2 : 1);
+        expect(console.log).toBeCalledTimes(__DEV__ ? 2 : 1);
+        // Note: we should display the first log because otherwise
+        // there is a risk of suppressing warnings when they happen,
+        // and on the next render they'd get deduplicated and ignored.
+        expect(console.log).toBeCalledWith('foo 1');
+      });
+
+      it('does not disable logs for function double render', () => {
+        spyOnDevAndProd(console, 'log');
+
+        let count = 0;
+        function Foo() {
+          count++;
+          console.log('foo ' + count);
           return null;
         }
-      }
 
-      const container = document.createElement('div');
-      ReactDOM.render(
-        <React.StrictMode>
-          <Foo />
-        </React.StrictMode>,
-        container,
-      );
+        const container = document.createElement('div');
+        ReactDOM.render(
+          <React.StrictMode>
+            <Foo />
+          </React.StrictMode>,
+          container,
+        );
 
-      expect(count).toBe(__DEV__ ? 2 : 1);
-      expect(console.log).toBeCalledTimes(__DEV__ ? 2 : 1);
-      // Note: we should display the first log because otherwise
-      // there is a risk of suppressing warnings when they happen,
-      // and on the next render they'd get deduplicated and ignored.
-      expect(console.log).toBeCalledWith('foo 1');
-    });
+        expect(count).toBe(__DEV__ ? 2 : 1);
+        expect(console.log).toBeCalledTimes(__DEV__ ? 2 : 1);
+        // Note: we should display the first log because otherwise
+        // there is a risk of suppressing warnings when they happen,
+        // and on the next render they'd get deduplicated and ignored.
+        expect(console.log).toBeCalledWith('foo 1');
+      });
+    } else {
+      it('disable logs for class double render', () => {
+        spyOnDevAndProd(console, 'log');
+
+        let count = 0;
+        class Foo extends React.Component {
+          render() {
+            count++;
+            console.log('foo ' + count);
+            return null;
+          }
+        }
 
-    it('does not disable logs for class double shouldComponentUpdate', () => {
-      spyOnDevAndProd(console, 'log');
+        const container = document.createElement('div');
+        ReactDOM.render(
+          <React.StrictMode>
+            <Foo />
+          </React.StrictMode>,
+          container,
+        );
 
-      let count = 0;
-      class Foo extends React.Component {
-        state = {};
-        shouldComponentUpdate() {
-          count++;
-          console.log('foo ' + count);
-          return {};
-        }
-        render() {
-          return null;
+        expect(count).toBe(__DEV__ ? 2 : 1);
+        expect(console.log).toBeCalledTimes(1);
+        // Note: we should display the first log because otherwise
+        // there is a risk of suppressing warnings when they happen,
+        // and on the next render they'd get deduplicated and ignored.
+        expect(console.log).toBeCalledWith('foo 1');
+      });
+
+      it('disables logs for class double ctor', () => {
+        spyOnDevAndProd(console, 'log');
+
+        let count = 0;
+        class Foo extends React.Component {
+          constructor(props) {
+            super(props);
+            count++;
+            console.log('foo ' + count);
+          }
+          render() {
+            return null;
+          }
         }
-      }
 
-      const container = document.createElement('div');
-      ReactDOM.render(
-        <React.StrictMode>
-          <Foo />
-        </React.StrictMode>,
-        container,
-      );
-      // Trigger sCU:
-      ReactDOM.render(
-        <React.StrictMode>
-          <Foo />
-        </React.StrictMode>,
-        container,
-      );
+        const container = document.createElement('div');
+        ReactDOM.render(
+          <React.StrictMode>
+            <Foo />
+          </React.StrictMode>,
+          container,
+        );
 
-      expect(count).toBe(__DEV__ ? 2 : 1);
-      expect(console.log).toBeCalledTimes(__DEV__ ? 2 : 1);
-      // Note: we should display the first log because otherwise
-      // there is a risk of suppressing warnings when they happen,
-      // and on the next render they'd get deduplicated and ignored.
-      expect(console.log).toBeCalledWith('foo 1');
-    });
+        expect(count).toBe(__DEV__ ? 2 : 1);
+        expect(console.log).toBeCalledTimes(1);
+        // Note: we should display the first log because otherwise
+        // there is a risk of suppressing warnings when they happen,
+        // and on the next render they'd get deduplicated and ignored.
+        expect(console.log).toBeCalledWith('foo 1');
+      });
 
-    it('does not disable logs for class state updaters', () => {
-      spyOnDevAndProd(console, 'log');
+      it('disable logs for class double getDerivedStateFromProps', () => {
+        spyOnDevAndProd(console, 'log');
+
+        let count = 0;
+        class Foo extends React.Component {
+          state = {};
+          static getDerivedStateFromProps() {
+            count++;
+            console.log('foo ' + count);
+            return {};
+          }
+          render() {
+            return null;
+          }
+        }
 
-      let inst;
-      let count = 0;
-      class Foo extends React.Component {
-        state = {};
-        render() {
-          inst = this;
-          return null;
+        const container = document.createElement('div');
+        ReactDOM.render(
+          <React.StrictMode>
+            <Foo />
+          </React.StrictMode>,
+          container,
+        );
+
+        expect(count).toBe(__DEV__ ? 2 : 1);
+        expect(console.log).toBeCalledTimes(1);
+        // Note: we should display the first log because otherwise
+        // there is a risk of suppressing warnings when they happen,
+        // and on the next render they'd get deduplicated and ignored.
+        expect(console.log).toBeCalledWith('foo 1');
+      });
+
+      it('disable logs for class double shouldComponentUpdate', () => {
+        spyOnDevAndProd(console, 'log');
+
+        let count = 0;
+        class Foo extends React.Component {
+          state = {};
+          shouldComponentUpdate() {
+            count++;
+            console.log('foo ' + count);
+            return {};
+          }
+          render() {
+            return null;
+          }
         }
-      }
 
-      const container = document.createElement('div');
-      ReactDOM.render(
-        <React.StrictMode>
-          <Foo />
-        </React.StrictMode>,
-        container,
-      );
-      inst.setState(() => {
-        count++;
-        console.log('foo ' + count);
-        return {};
+        const container = document.createElement('div');
+        ReactDOM.render(
+          <React.StrictMode>
+            <Foo />
+          </React.StrictMode>,
+          container,
+        );
+        // Trigger sCU:
+        ReactDOM.render(
+          <React.StrictMode>
+            <Foo />
+          </React.StrictMode>,
+          container,
+        );
+
+        expect(count).toBe(__DEV__ ? 2 : 1);
+        expect(console.log).toBeCalledTimes(1);
+        // Note: we should display the first log because otherwise
+        // there is a risk of suppressing warnings when they happen,
+        // and on the next render they'd get deduplicated and ignored.
+        expect(console.log).toBeCalledWith('foo 1');
       });
 
-      expect(count).toBe(__DEV__ ? 2 : 1);
-      expect(console.log).toBeCalledTimes(__DEV__ ? 2 : 1);
-      // Note: we should display the first log because otherwise
-      // there is a risk of suppressing warnings when they happen,
-      // and on the next render they'd get deduplicated and ignored.
-      expect(console.log).toBeCalledWith('foo 1');
-    });
+      it('disable logs for class state updaters', () => {
+        spyOnDevAndProd(console, 'log');
+
+        let inst;
+        let count = 0;
+        class Foo extends React.Component {
+          state = {};
+          render() {
+            inst = this;
+            return null;
+          }
+        }
 
-    it('does not disable logs for function double render', () => {
-      spyOnDevAndProd(console, 'log');
+        const container = document.createElement('div');
+        ReactDOM.render(
+          <React.StrictMode>
+            <Foo />
+          </React.StrictMode>,
+          container,
+        );
+        inst.setState(() => {
+          count++;
+          console.log('foo ' + count);
+          return {};
+        });
+
+        expect(count).toBe(__DEV__ ? 2 : 1);
+        expect(console.log).toBeCalledTimes(1);
+        // Note: we should display the first log because otherwise
+        // there is a risk of suppressing warnings when they happen,
+        // and on the next render they'd get deduplicated and ignored.
+        expect(console.log).toBeCalledWith('foo 1');
+      });
 
-      let count = 0;
-      function Foo() {
-        count++;
-        console.log('foo ' + count);
-        return null;
-      }
+      it('disable logs for function double render', () => {
+        spyOnDevAndProd(console, 'log');
 
-      const container = document.createElement('div');
-      ReactDOM.render(
-        <React.StrictMode>
-          <Foo />
-        </React.StrictMode>,
-        container,
-      );
+        let count = 0;
+        function Foo() {
+          count++;
+          console.log('foo ' + count);
+          return null;
+        }
 
-      expect(count).toBe(__DEV__ ? 2 : 1);
-      expect(console.log).toBeCalledTimes(__DEV__ ? 2 : 1);
-      // Note: we should display the first log because otherwise
-      // there is a risk of suppressing warnings when they happen,
-      // and on the next render they'd get deduplicated and ignored.
-      expect(console.log).toBeCalledWith('foo 1');
-    });
+        const container = document.createElement('div');
+        ReactDOM.render(
+          <React.StrictMode>
+            <Foo />
+          </React.StrictMode>,
+          container,
+        );
+
+        expect(count).toBe(__DEV__ ? 2 : 1);
+        expect(console.log).toBeCalledTimes(1);
+        // Note: we should display the first log because otherwise
+        // there is a risk of suppressing warnings when they happen,
+        // and on the next render they'd get deduplicated and ignored.
+        expect(console.log).toBeCalledWith('foo 1');
+      });
+    }
   });
 });

commit 17806594cc28284fe195f918e8d77de3516848ec
Author: Sebastian Markbåge <sebastian@calyptus.eu>
Date:   Tue Mar 1 00:13:28 2022 -0500

    Move createRoot/hydrateRoot to react-dom/client (#23385)
    
    * Move createRoot/hydrateRoot to /client
    
    We want these APIs ideally to be imported separately from things you
    might use in arbitrary components (like flushSync). Those other methods
    are "isomorphic" to how the ReactDOM tree is rendered. Similar to hooks.
    
    E.g. importing flushSync into a component that only uses it on the client
    should ideally not also pull in the entry client implementation on the
    server.
    
    This also creates a nicer parity with /server where the roots are in a
    separate entry point.
    
    Unfortunately, I can't quite do this yet because we have some legacy APIs
    that we plan on removing (like findDOMNode) and we also haven't implemented
    flushSync using a flag like startTransition does yet.
    
    Another problem is that we currently encourage these APIs to be aliased by
    /profiling (or unstable_testing). In the future you don't have to alias
    them because you can just change your roots to just import those APIs and
    they'll still work with the isomorphic forms. Although we might also just
    use export conditions for them.
    
    For that all to work, I went with a different strategy for now where the
    real API is in / but it comes with a warning if you use it. If you instead
    import /client it disables the warning in a wrapper. That means that if you
    alias / then import /client that will inturn import the alias and it'll
    just work.
    
    In a future breaking changes (likely when we switch to ESM) we can just
    remove createRoot/hydrateRoot from / and move away from the aliasing
    strategy.
    
    * Update tests to import from react-dom/client
    
    * Fix fixtures
    
    * Update warnings
    
    * Add test for the warning
    
    * Update devtools
    
    * Change order of react-dom, react-dom/client alias
    
    I think the order matters here. The first one takes precedence.
    
    * Require react-dom through client so it can be aliased
    
    Co-authored-by: Andrew Clark <git@andrewclark.io>

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index 84fbead1f4..81416f260a 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -11,6 +11,7 @@
 
 let React;
 let ReactDOM;
+let ReactDOMClient;
 let ReactDOMServer;
 let Scheduler;
 let PropTypes;
@@ -22,6 +23,7 @@ describe('ReactStrictMode', () => {
     jest.resetModules();
     React = require('react');
     ReactDOM = require('react-dom');
+    ReactDOMClient = require('react-dom/client');
     ReactDOMServer = require('react-dom/server');
   });
 
@@ -361,6 +363,7 @@ describe('Concurrent Mode', () => {
 
     React = require('react');
     ReactDOM = require('react-dom');
+    ReactDOMClient = require('react-dom/client');
     Scheduler = require('scheduler');
   });
 
@@ -406,7 +409,7 @@ describe('Concurrent Mode', () => {
     }
 
     const container = document.createElement('div');
-    const root = ReactDOM.createRoot(container);
+    const root = ReactDOMClient.createRoot(container);
     root.render(<StrictRoot />);
     expect(() => Scheduler.unstable_flushAll()).toErrorDev(
       [
@@ -468,7 +471,7 @@ Please update the following components: App`,
     }
 
     const container = document.createElement('div');
-    const root = ReactDOM.createRoot(container);
+    const root = ReactDOMClient.createRoot(container);
     root.render(<StrictRoot />);
 
     expect(() => {
@@ -544,7 +547,7 @@ Please update the following components: Parent`,
     }
 
     const container = document.createElement('div');
-    const root = ReactDOM.createRoot(container);
+    const root = ReactDOMClient.createRoot(container);
     root.render(<StrictRoot foo={true} />);
     expect(() =>
       Scheduler.unstable_flushAll(),
@@ -623,6 +626,7 @@ describe('symbol checks', () => {
     jest.resetModules();
     React = require('react');
     ReactDOM = require('react-dom');
+    ReactDOMClient = require('react-dom/client');
   });
 
   it('should switch from StrictMode to a Fragment and reset state', () => {
@@ -735,6 +739,7 @@ describe('string refs', () => {
     jest.resetModules();
     React = require('react');
     ReactDOM = require('react-dom');
+    ReactDOMClient = require('react-dom/client');
   });
 
   it('should warn within a strict tree', () => {
@@ -820,6 +825,7 @@ describe('context legacy', () => {
     jest.resetModules();
     React = require('react');
     ReactDOM = require('react-dom');
+    ReactDOMClient = require('react-dom/client');
     PropTypes = require('prop-types');
   });
 
@@ -900,6 +906,7 @@ describe('context legacy', () => {
       jest.resetModules();
       React = require('react');
       ReactDOM = require('react-dom');
+      ReactDOMClient = require('react-dom/client');
     });
 
     if (ReactFeatureFlags.consoleManagedByDevToolsDuringStrictMode) {

commit 5d1ce651393524639a3b4b1e861a0413a4d25629
Author: Samuel Susla <samuel.susla@gmail.com>
Date:   Tue Aug 23 18:19:07 2022 +0100

    Align StrictMode behaviour with production (#25049)
    
    * Skip double invoking effects in Offscreen
    
    * Run yarn replace-fork
    
    * Use executionContext to disable profiler timer
    
    * Restructure recursion into two functions
    
    * Fix ReactStrictMode test
    
    * Use gate pragma in ReacetOffscreenStrictMode test
    
    * Set and reset current debug fiber in dev
    
    * Skip over paths that don't include any insertions
    
    * Extract common logic to check for profiling to a helper function
    
    * Remove hasPassiveEffects flag from StrictMode
    
    * Fix flow issues
    
    * Revert "Skip over paths that don't include any insertions"

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index 81416f260a..8aebe33426 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -67,6 +67,7 @@ describe('ReactStrictMode', () => {
     );
   });
 
+  // @gate __DEV__ && !enableStrictEffects
   it('should invoke precommit lifecycle methods twice', () => {
     let log = [];
     let shouldComponentUpdate = false;
@@ -107,24 +108,15 @@ describe('ReactStrictMode', () => {
       container,
     );
 
-    if (__DEV__) {
-      expect(log).toEqual([
-        'constructor',
-        'constructor',
-        'getDerivedStateFromProps',
-        'getDerivedStateFromProps',
-        'render',
-        'render',
-        'componentDidMount',
-      ]);
-    } else {
-      expect(log).toEqual([
-        'constructor',
-        'getDerivedStateFromProps',
-        'render',
-        'componentDidMount',
-      ]);
-    }
+    expect(log).toEqual([
+      'constructor',
+      'constructor',
+      'getDerivedStateFromProps',
+      'getDerivedStateFromProps',
+      'render',
+      'render',
+      'componentDidMount',
+    ]);
 
     log = [];
     shouldComponentUpdate = true;
@@ -135,24 +127,15 @@ describe('ReactStrictMode', () => {
       </React.StrictMode>,
       container,
     );
-    if (__DEV__) {
-      expect(log).toEqual([
-        'getDerivedStateFromProps',
-        'getDerivedStateFromProps',
-        'shouldComponentUpdate',
-        'shouldComponentUpdate',
-        'render',
-        'render',
-        'componentDidUpdate',
-      ]);
-    } else {
-      expect(log).toEqual([
-        'getDerivedStateFromProps',
-        'shouldComponentUpdate',
-        'render',
-        'componentDidUpdate',
-      ]);
-    }
+    expect(log).toEqual([
+      'getDerivedStateFromProps',
+      'getDerivedStateFromProps',
+      'shouldComponentUpdate',
+      'shouldComponentUpdate',
+      'render',
+      'render',
+      'componentDidUpdate',
+    ]);
 
     log = [];
     shouldComponentUpdate = false;
@@ -164,19 +147,12 @@ describe('ReactStrictMode', () => {
       container,
     );
 
-    if (__DEV__) {
-      expect(log).toEqual([
-        'getDerivedStateFromProps',
-        'getDerivedStateFromProps',
-        'shouldComponentUpdate',
-        'shouldComponentUpdate',
-      ]);
-    } else {
-      expect(log).toEqual([
-        'getDerivedStateFromProps',
-        'shouldComponentUpdate',
-      ]);
-    }
+    expect(log).toEqual([
+      'getDerivedStateFromProps',
+      'getDerivedStateFromProps',
+      'shouldComponentUpdate',
+      'shouldComponentUpdate',
+    ]);
   });
 
   it('should invoke setState callbacks twice', () => {

commit abbbdf4cec992666885cc67344563795a333d4a2
Author: Samuel Susla <samuel.susla@gmail.com>
Date:   Fri Sep 30 17:06:11 2022 +0100

    Put modern StrictMode behind a feature flag (#25365)
    
    * Put modern StrictMode behind a feature flag
    
    * Remove unneeded flag

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index 8aebe33426..0f3ba9a9e1 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -67,7 +67,7 @@ describe('ReactStrictMode', () => {
     );
   });
 
-  // @gate __DEV__ && !enableStrictEffects
+  // @gate __DEV__
   it('should invoke precommit lifecycle methods twice', () => {
     let log = [];
     let shouldComponentUpdate = false;

commit 9cdf8a99edcfd94d7420835ea663edca04237527
Author: Andrew Clark <git@andrewclark.io>
Date:   Tue Oct 18 11:19:24 2022 -0400

    [Codemod] Update copyright header to Meta (#25315)
    
    * Facebook -> Meta in copyright
    
    rg --files | xargs sed -i 's#Copyright (c) Facebook, Inc. and its affiliates.#Copyright (c) Meta Platforms, Inc. and affiliates.#g'
    
    * Manual tweaks

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index 0f3ba9a9e1..5f92f40946 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -1,5 +1,5 @@
 /**
- * Copyright (c) Facebook, Inc. and its affiliates.
+ * Copyright (c) Meta Platforms, Inc. and affiliates.
  *
  * This source code is licensed under the MIT license found in the
  * LICENSE file in the root directory of this source tree.

commit 5450dd409863b31fa7ef4dfcf8aeb06ac16c4c10
Author: Andrew Clark <git@andrewclark.io>
Date:   Fri Oct 28 14:46:20 2022 -0700

    Strict Mode: Reuse memoized result from first pass (#25583)
    
    In Strict Mode, during development, user functions are double invoked to
    help detect side effects. Currently, the way we implement this is to
    completely discard the first pass and start over. Theoretically this
    should be fine because components are idempotent. However, it's a bit
    tricky to get right because our implementation (i.e. `renderWithHooks`)
    is not completely idempotent with respect to internal data structures,
    like the work-in-progress fiber. In the past we've had to be really
    careful to avoid subtle bugs — for example, during the initial mount,
    `setState` functions are bound to the particular hook instances that
    were created during that render. If we compute new hook instances, we
    must also compute new children, and they must correspond to each other.
    
    This commit addresses a similar issue that came up related to `use`:
    when something suspends, `use` reuses the promise that was passed during
    the first attempt. This is itself a form of memoization. We need to be
    able to memoize the reactive inputs to the `use` call using a hook (i.e.
    `useMemo`), which means, the reactive inputs to `use` must come from the
    same component invocation as the output.
    
    The solution I've chosen is, rather than double invoke the entire
    `renderWithHook` function, we should double invoke each individual user
    function. It's a bit confusing but here's how it works:
    
    We will invoke the entire component function twice. However, during the
    second invocation of the component, the hook state from the first
    invocation will be reused. That means things like `useMemo` functions
    won't run again, because the deps will match and the memoized result
    will be reused.
    
    We want memoized functions to run twice, too, so account for this, user
    functions are double invoked during the *first* invocation of the
    component function, and are *not* double invoked during the second
    incovation:
    
    - First execution of component function: user functions are double
    invoked
    - Second execution of component function (in Strict Mode, during
    development): user functions are not double invoked.
    
    It's hard to explain verbally but much clearer when you run the test
    cases I've added.

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index 5f92f40946..a266af4575 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -15,6 +15,10 @@ let ReactDOMClient;
 let ReactDOMServer;
 let Scheduler;
 let PropTypes;
+let act;
+let useMemo;
+let useState;
+let useReducer;
 
 const ReactFeatureFlags = require('shared/ReactFeatureFlags');
 
@@ -25,6 +29,10 @@ describe('ReactStrictMode', () => {
     ReactDOM = require('react-dom');
     ReactDOMClient = require('react-dom/client');
     ReactDOMServer = require('react-dom/server');
+    act = require('jest-react').act;
+    useMemo = React.useMemo;
+    useState = React.useState;
+    useReducer = React.useReducer;
   });
 
   it('should appear in the client component stack', () => {
@@ -331,6 +339,183 @@ describe('ReactStrictMode', () => {
     // But each time `state` should be the previous value
     expect(instance.state.count).toBe(2);
   });
+
+  // @gate debugRenderPhaseSideEffectsForStrictMode
+  it('double invokes useMemo functions', async () => {
+    let log = [];
+
+    function Uppercased({text}) {
+      return useMemo(() => {
+        const uppercased = text.toUpperCase();
+        log.push('Compute toUpperCase: ' + uppercased);
+        return uppercased;
+      }, [text]);
+    }
+
+    const container = document.createElement('div');
+    const root = ReactDOMClient.createRoot(container);
+
+    // Mount
+    await act(() => {
+      root.render(
+        <React.StrictMode>
+          <Uppercased text="hello" />
+        </React.StrictMode>,
+      );
+    });
+    expect(container.textContent).toBe('HELLO');
+    expect(log).toEqual([
+      'Compute toUpperCase: HELLO',
+      'Compute toUpperCase: HELLO',
+    ]);
+
+    log = [];
+
+    // Update
+    await act(() => {
+      root.render(
+        <React.StrictMode>
+          <Uppercased text="goodbye" />
+        </React.StrictMode>,
+      );
+    });
+    expect(container.textContent).toBe('GOODBYE');
+    expect(log).toEqual([
+      'Compute toUpperCase: GOODBYE',
+      'Compute toUpperCase: GOODBYE',
+    ]);
+  });
+
+  // @gate debugRenderPhaseSideEffectsForStrictMode
+  it('double invokes useMemo functions', async () => {
+    let log = [];
+    function Uppercased({text}) {
+      const memoizedResult = useMemo(() => {
+        const uppercased = text.toUpperCase();
+        log.push('Compute toUpperCase: ' + uppercased);
+        return {uppercased};
+      }, [text]);
+
+      // Push this to the log so we can check whether the same memoized result
+      // it returned during both invocations.
+      log.push(memoizedResult);
+
+      return memoizedResult.uppercased;
+    }
+
+    const container = document.createElement('div');
+    const root = ReactDOMClient.createRoot(container);
+
+    // Mount
+    await act(() => {
+      root.render(
+        <React.StrictMode>
+          <Uppercased text="hello" />
+        </React.StrictMode>,
+      );
+    });
+    expect(container.textContent).toBe('HELLO');
+    expect(log).toEqual([
+      'Compute toUpperCase: HELLO',
+      'Compute toUpperCase: HELLO',
+      {uppercased: 'HELLO'},
+      {uppercased: 'HELLO'},
+    ]);
+
+    // Even though the memoized function is invoked twice, the same object
+    // is returned both times.
+    expect(log[2]).toBe(log[3]);
+
+    log = [];
+
+    // Update
+    await act(() => {
+      root.render(
+        <React.StrictMode>
+          <Uppercased text="goodbye" />
+        </React.StrictMode>,
+      );
+    });
+    expect(container.textContent).toBe('GOODBYE');
+    expect(log).toEqual([
+      'Compute toUpperCase: GOODBYE',
+      'Compute toUpperCase: GOODBYE',
+      {uppercased: 'GOODBYE'},
+      {uppercased: 'GOODBYE'},
+    ]);
+
+    // Even though the memoized function is invoked twice, the same object
+    // is returned both times.
+    expect(log[2]).toBe(log[3]);
+  });
+
+  // @gate debugRenderPhaseSideEffectsForStrictMode
+  it('double invokes setState updater functions', async () => {
+    const log = [];
+
+    let setCount;
+    function App() {
+      const [count, _setCount] = useState(0);
+      setCount = _setCount;
+      return count;
+    }
+
+    const container = document.createElement('div');
+    const root = ReactDOMClient.createRoot(container);
+
+    await act(() => {
+      root.render(
+        <React.StrictMode>
+          <App />
+        </React.StrictMode>,
+      );
+    });
+    expect(container.textContent).toBe('0');
+
+    await act(() => {
+      setCount(() => {
+        log.push('Compute count: 1');
+        return 1;
+      });
+    });
+    expect(container.textContent).toBe('1');
+    expect(log).toEqual(['Compute count: 1', 'Compute count: 1']);
+  });
+
+  // @gate debugRenderPhaseSideEffectsForStrictMode
+  it('double invokes reducer functions', async () => {
+    const log = [];
+
+    function reducer(prevState, action) {
+      log.push('Compute new state: ' + action);
+      return action;
+    }
+
+    let dispatch;
+    function App() {
+      const [count, _dispatch] = useReducer(reducer, 0);
+      dispatch = _dispatch;
+      return count;
+    }
+
+    const container = document.createElement('div');
+    const root = ReactDOMClient.createRoot(container);
+
+    await act(() => {
+      root.render(
+        <React.StrictMode>
+          <App />
+        </React.StrictMode>,
+      );
+    });
+    expect(container.textContent).toBe('0');
+
+    await act(() => {
+      dispatch(1);
+    });
+    expect(container.textContent).toBe('1');
+    expect(log).toEqual(['Compute new state: 1', 'Compute new state: 1']);
+  });
 });
 
 describe('Concurrent Mode', () => {

commit 6fb8133ed3aa6b23063375dd345c6e413b05f0fe
Author: Sebastian Silbermann <silbermann.sebastian@gmail.com>
Date:   Thu Nov 17 01:15:57 2022 +0100

    Turn on string ref deprecation warning for everybody (not codemoddable) (#25383)
    
    ## Summary
    
    Alternate to https://github.com/facebook/react/pull/25334 without any
    prod runtime changes i.e. the proposed codemod in
    https://github.com/reactjs/rfcs/blob/createlement-rfc/text/0000-create-element-changes.md#deprecate-string-refs-and-remove-production-mode-_owner-field
    would not work.
    
    ## How did you test this change?
    
    - [x] CI
    - [x] `yarn test` with and without `warnAboutStringRefs`

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index a266af4575..b41497ae3a 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -926,12 +926,18 @@ describe('string refs', () => {
     expect(() => {
       ReactDOM.render(<OuterComponent />, container);
     }).toErrorDev(
-      'Warning: A string ref, "somestring", has been found within a strict mode tree. ' +
-        'String refs are a source of potential bugs and should be avoided. ' +
-        'We recommend using useRef() or createRef() instead. ' +
-        'Learn more about using refs safely here: ' +
-        'https://reactjs.org/link/strict-mode-string-ref\n' +
-        '    in OuterComponent (at **)',
+      ReactFeatureFlags.warnAboutStringRefs
+        ? 'Warning: Component "StrictMode" contains the string ref "somestring". ' +
+            'Support for string refs will be removed in a future major release. ' +
+            'We recommend using useRef() or createRef() instead. ' +
+            'Learn more about using refs safely here: https://reactjs.org/link/strict-mode-string-ref\n' +
+            '    in OuterComponent (at **)'
+        : 'Warning: A string ref, "somestring", has been found within a strict mode tree. ' +
+            'String refs are a source of potential bugs and should be avoided. ' +
+            'We recommend using useRef() or createRef() instead. ' +
+            'Learn more about using refs safely here: ' +
+            'https://reactjs.org/link/strict-mode-string-ref\n' +
+            '    in OuterComponent (at **)',
     );
 
     // Dedup
@@ -967,13 +973,20 @@ describe('string refs', () => {
     expect(() => {
       ReactDOM.render(<OuterComponent />, container);
     }).toErrorDev(
-      'Warning: A string ref, "somestring", has been found within a strict mode tree. ' +
-        'String refs are a source of potential bugs and should be avoided. ' +
-        'We recommend using useRef() or createRef() instead. ' +
-        'Learn more about using refs safely here: ' +
-        'https://reactjs.org/link/strict-mode-string-ref\n' +
-        '    in InnerComponent (at **)\n' +
-        '    in OuterComponent (at **)',
+      ReactFeatureFlags.warnAboutStringRefs
+        ? 'Warning: Component "InnerComponent" contains the string ref "somestring". ' +
+            'Support for string refs will be removed in a future major release. ' +
+            'We recommend using useRef() or createRef() instead. ' +
+            'Learn more about using refs safely here: https://reactjs.org/link/strict-mode-string-ref\n' +
+            '    in InnerComponent (at **)\n' +
+            '    in OuterComponent (at **)'
+        : 'Warning: A string ref, "somestring", has been found within a strict mode tree. ' +
+            'String refs are a source of potential bugs and should be avoided. ' +
+            'We recommend using useRef() or createRef() instead. ' +
+            'Learn more about using refs safely here: ' +
+            'https://reactjs.org/link/strict-mode-string-ref\n' +
+            '    in InnerComponent (at **)\n' +
+            '    in OuterComponent (at **)',
     );
 
     // Dedup

commit 0fce6bb498357feb4465859912004b2e20fe7084
Author: Jan Kassens <jkassens@meta.com>
Date:   Wed Jan 11 12:19:46 2023 -0500

    [cleanup] remove feature flags warnAboutDefaultPropsOnFunctionComponents and warnAboutStringRefs (#25980)
    
    These feature flags are fully rolled out and easy to clean up. Let's
    remove them!

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index b41497ae3a..e3553e6154 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -926,18 +926,11 @@ describe('string refs', () => {
     expect(() => {
       ReactDOM.render(<OuterComponent />, container);
     }).toErrorDev(
-      ReactFeatureFlags.warnAboutStringRefs
-        ? 'Warning: Component "StrictMode" contains the string ref "somestring". ' +
-            'Support for string refs will be removed in a future major release. ' +
-            'We recommend using useRef() or createRef() instead. ' +
-            'Learn more about using refs safely here: https://reactjs.org/link/strict-mode-string-ref\n' +
-            '    in OuterComponent (at **)'
-        : 'Warning: A string ref, "somestring", has been found within a strict mode tree. ' +
-            'String refs are a source of potential bugs and should be avoided. ' +
-            'We recommend using useRef() or createRef() instead. ' +
-            'Learn more about using refs safely here: ' +
-            'https://reactjs.org/link/strict-mode-string-ref\n' +
-            '    in OuterComponent (at **)',
+      'Warning: Component "StrictMode" contains the string ref "somestring". ' +
+        'Support for string refs will be removed in a future major release. ' +
+        'We recommend using useRef() or createRef() instead. ' +
+        'Learn more about using refs safely here: https://reactjs.org/link/strict-mode-string-ref\n' +
+        '    in OuterComponent (at **)',
     );
 
     // Dedup
@@ -973,20 +966,12 @@ describe('string refs', () => {
     expect(() => {
       ReactDOM.render(<OuterComponent />, container);
     }).toErrorDev(
-      ReactFeatureFlags.warnAboutStringRefs
-        ? 'Warning: Component "InnerComponent" contains the string ref "somestring". ' +
-            'Support for string refs will be removed in a future major release. ' +
-            'We recommend using useRef() or createRef() instead. ' +
-            'Learn more about using refs safely here: https://reactjs.org/link/strict-mode-string-ref\n' +
-            '    in InnerComponent (at **)\n' +
-            '    in OuterComponent (at **)'
-        : 'Warning: A string ref, "somestring", has been found within a strict mode tree. ' +
-            'String refs are a source of potential bugs and should be avoided. ' +
-            'We recommend using useRef() or createRef() instead. ' +
-            'Learn more about using refs safely here: ' +
-            'https://reactjs.org/link/strict-mode-string-ref\n' +
-            '    in InnerComponent (at **)\n' +
-            '    in OuterComponent (at **)',
+      'Warning: Component "InnerComponent" contains the string ref "somestring". ' +
+        'Support for string refs will be removed in a future major release. ' +
+        'We recommend using useRef() or createRef() instead. ' +
+        'Learn more about using refs safely here: https://reactjs.org/link/strict-mode-string-ref\n' +
+        '    in InnerComponent (at **)\n' +
+        '    in OuterComponent (at **)',
     );
 
     // Dedup

commit 6b3083266686f62b29462d32de75c6e71f7ba3e3
Author: Jan Kassens <jkassens@meta.com>
Date:   Tue Jan 31 08:25:05 2023 -0500

    Upgrade prettier (#26081)
    
    The old version of prettier we were using didn't support the Flow syntax
    to access properties in a type using `SomeType['prop']`. This updates
    `prettier` and `rollup-plugin-prettier` to the latest versions.
    
    I added the prettier config `arrowParens: "avoid"` to reduce the diff
    size as the default has changed in Prettier 2.0. The largest amount of
    changes comes from function expressions now having a space. This doesn't
    have an option to preserve the old behavior, so we have to update this.

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index e3553e6154..16491c2533 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -710,17 +710,13 @@ Please update the following components: Parent`,
     const container = document.createElement('div');
     const root = ReactDOMClient.createRoot(container);
     root.render(<StrictRoot foo={true} />);
-    expect(() =>
-      Scheduler.unstable_flushAll(),
-    ).toErrorDev(
+    expect(() => Scheduler.unstable_flushAll()).toErrorDev(
       'Using UNSAFE_componentWillMount in strict mode is not recommended',
       {withoutStack: true},
     );
 
     root.render(<StrictRoot foo={false} />);
-    expect(() =>
-      Scheduler.unstable_flushAll(),
-    ).toErrorDev(
+    expect(() => Scheduler.unstable_flushAll()).toErrorDev(
       'Using UNSAFE_componentWillMount in strict mode is not recommended',
       {withoutStack: true},
     );
@@ -770,9 +766,7 @@ Please update the following components: Parent`,
 
     const container = document.createElement('div');
 
-    expect(() =>
-      ReactDOM.render(<SyncRoot />, container),
-    ).toErrorDev(
+    expect(() => ReactDOM.render(<SyncRoot />, container)).toErrorDev(
       'Using UNSAFE_componentWillReceiveProps in strict mode is not recommended',
       {withoutStack: true},
     );

commit 71cace4d3267e4527964db51ccaf5eab7234f37f
Author: Ming Ye <ymqyit@gmail.com>
Date:   Sat Feb 11 02:39:14 2023 +0800

    Migrate testRunner from jasmine2 to jest-circus (#26144)
    
    ## Summary
    
    In jest v27, jest-circus as default test runner
    (https://github.com/facebook/jest/pull/10686)
    
    ## How did you test this change?
    
    ci green

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index 16491c2533..61d53a7318 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -982,6 +982,10 @@ describe('context legacy', () => {
     PropTypes = require('prop-types');
   });
 
+  afterEach(() => {
+    jest.restoreAllMocks();
+  });
+
   it('should warn if the legacy context API have been used in strict mode', () => {
     class LegacyContextProvider extends React.Component {
       getChildContext() {

commit 703c67560d1b5e5d32170cd513cda52559933527
Author: Andrew Clark <git@andrewclark.io>
Date:   Tue Mar 7 10:15:34 2023 -0500

    Codemod act -> await act (1/?) (#26334)
    
    Similar to the rationale for `waitFor` (see
    https://github.com/facebook/react/pull/26285), we should always await
    the result of an `act` call so that microtasks have a chance to fire.
    
    This only affects the internal `act` that we use in our repo, for now.
    In the public `act` API, we don't yet require this; however, we
    effectively will for any update that triggers suspense once `use` lands.
    So we likely will start warning in an upcoming minor.

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index 61d53a7318..93ad52fe34 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -356,7 +356,7 @@ describe('ReactStrictMode', () => {
     const root = ReactDOMClient.createRoot(container);
 
     // Mount
-    await act(() => {
+    await act(async () => {
       root.render(
         <React.StrictMode>
           <Uppercased text="hello" />
@@ -372,7 +372,7 @@ describe('ReactStrictMode', () => {
     log = [];
 
     // Update
-    await act(() => {
+    await act(async () => {
       root.render(
         <React.StrictMode>
           <Uppercased text="goodbye" />
@@ -407,7 +407,7 @@ describe('ReactStrictMode', () => {
     const root = ReactDOMClient.createRoot(container);
 
     // Mount
-    await act(() => {
+    await act(async () => {
       root.render(
         <React.StrictMode>
           <Uppercased text="hello" />
@@ -429,7 +429,7 @@ describe('ReactStrictMode', () => {
     log = [];
 
     // Update
-    await act(() => {
+    await act(async () => {
       root.render(
         <React.StrictMode>
           <Uppercased text="goodbye" />
@@ -463,7 +463,7 @@ describe('ReactStrictMode', () => {
     const container = document.createElement('div');
     const root = ReactDOMClient.createRoot(container);
 
-    await act(() => {
+    await act(async () => {
       root.render(
         <React.StrictMode>
           <App />
@@ -472,7 +472,7 @@ describe('ReactStrictMode', () => {
     });
     expect(container.textContent).toBe('0');
 
-    await act(() => {
+    await act(async () => {
       setCount(() => {
         log.push('Compute count: 1');
         return 1;
@@ -501,7 +501,7 @@ describe('ReactStrictMode', () => {
     const container = document.createElement('div');
     const root = ReactDOMClient.createRoot(container);
 
-    await act(() => {
+    await act(async () => {
       root.render(
         <React.StrictMode>
           <App />
@@ -510,7 +510,7 @@ describe('ReactStrictMode', () => {
     });
     expect(container.textContent).toBe('0');
 
-    await act(() => {
+    await act(async () => {
       dispatch(1);
     });
     expect(container.textContent).toBe('1');

commit 44d3807945700de8bb6bdbbf5c4d1ba513303747
Author: Andrew Clark <git@andrewclark.io>
Date:   Wed Mar 8 12:58:31 2023 -0500

    Move internalAct to internal-test-utils package (#26344)
    
    This is not a public API. We only use it for our internal tests, the
    ones in this repo. Let's move it to this private package. Practically
    speaking this will also let us use async/await in the implementation.

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index 93ad52fe34..59dad3f5cf 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -29,7 +29,7 @@ describe('ReactStrictMode', () => {
     ReactDOM = require('react-dom');
     ReactDOMClient = require('react-dom/client');
     ReactDOMServer = require('react-dom/server');
-    act = require('jest-react').act;
+    act = require('internal-test-utils').act;
     useMemo = React.useMemo;
     useState = React.useState;
     useReducer = React.useReducer;

commit 62cd5af08e2ac8b1d4691e75252487083cf7a4aa
Author: Andrew Clark <git@andrewclark.io>
Date:   Wed Mar 8 16:40:23 2023 -0500

    Codemod redundant async act scopes (#26350)
    
    Prior to #26347, our internal `act` API (not the public API) behaved
    differently depending on whether the scope function returned a promise
    (i.e. was an async function), for historical reasons that no longer
    apply. Now that this is fixed, I've codemodded all async act scopes that
    don't contain an await to be sync.
    
    No pressing motivation other than it looks nicer and the codemod was
    easy. Might help avoid confusion for new contributors who see async act
    scopes with nothing async inside and infer it must be like that for a
    reason.

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index 59dad3f5cf..e99fe83eac 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -356,7 +356,7 @@ describe('ReactStrictMode', () => {
     const root = ReactDOMClient.createRoot(container);
 
     // Mount
-    await act(async () => {
+    await act(() => {
       root.render(
         <React.StrictMode>
           <Uppercased text="hello" />
@@ -372,7 +372,7 @@ describe('ReactStrictMode', () => {
     log = [];
 
     // Update
-    await act(async () => {
+    await act(() => {
       root.render(
         <React.StrictMode>
           <Uppercased text="goodbye" />
@@ -407,7 +407,7 @@ describe('ReactStrictMode', () => {
     const root = ReactDOMClient.createRoot(container);
 
     // Mount
-    await act(async () => {
+    await act(() => {
       root.render(
         <React.StrictMode>
           <Uppercased text="hello" />
@@ -429,7 +429,7 @@ describe('ReactStrictMode', () => {
     log = [];
 
     // Update
-    await act(async () => {
+    await act(() => {
       root.render(
         <React.StrictMode>
           <Uppercased text="goodbye" />
@@ -463,7 +463,7 @@ describe('ReactStrictMode', () => {
     const container = document.createElement('div');
     const root = ReactDOMClient.createRoot(container);
 
-    await act(async () => {
+    await act(() => {
       root.render(
         <React.StrictMode>
           <App />
@@ -472,7 +472,7 @@ describe('ReactStrictMode', () => {
     });
     expect(container.textContent).toBe('0');
 
-    await act(async () => {
+    await act(() => {
       setCount(() => {
         log.push('Compute count: 1');
         return 1;
@@ -501,7 +501,7 @@ describe('ReactStrictMode', () => {
     const container = document.createElement('div');
     const root = ReactDOMClient.createRoot(container);
 
-    await act(async () => {
+    await act(() => {
       root.render(
         <React.StrictMode>
           <App />
@@ -510,7 +510,7 @@ describe('ReactStrictMode', () => {
     });
     expect(container.textContent).toBe('0');
 
-    await act(async () => {
+    await act(() => {
       dispatch(1);
     });
     expect(container.textContent).toBe('1');

commit a8875eab7f78a453d22370d1061a8bb3cd672b9d
Author: Andrew Clark <git@andrewclark.io>
Date:   Fri Mar 10 11:06:28 2023 -0500

    Update more tests to not rely on sync queuing (#26358)
    
    This fixes a handful of tests that were accidentally relying on React
    synchronously queuing work in the Scheduler after a setState.
    
    Usually this is because they use a lower level SchedulerMock method
    instead of either `act` or one of the `waitFor` helpers. In some cases,
    the solution is to switch to those APIs. In other cases, if we're
    intentionally testing some lower level behavior, we might have to be a
    bit more clever.
    
    Co-authored-by: Tianyu Yao <skyyao@fb.com>

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index e99fe83eac..800607dd95 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -13,7 +13,6 @@ let React;
 let ReactDOM;
 let ReactDOMClient;
 let ReactDOMServer;
-let Scheduler;
 let PropTypes;
 let act;
 let useMemo;
@@ -525,10 +524,10 @@ describe('Concurrent Mode', () => {
     React = require('react');
     ReactDOM = require('react-dom');
     ReactDOMClient = require('react-dom/client');
-    Scheduler = require('scheduler');
+    act = require('internal-test-utils').act;
   });
 
-  it('should warn about unsafe legacy lifecycle methods anywhere in a StrictMode tree', () => {
+  it('should warn about unsafe legacy lifecycle methods anywhere in a StrictMode tree', async () => {
     function StrictRoot() {
       return (
         <React.StrictMode>
@@ -571,8 +570,9 @@ describe('Concurrent Mode', () => {
 
     const container = document.createElement('div');
     const root = ReactDOMClient.createRoot(container);
-    root.render(<StrictRoot />);
-    expect(() => Scheduler.unstable_flushAll()).toErrorDev(
+    await expect(
+      async () => await act(() => root.render(<StrictRoot />)),
+    ).toErrorDev(
       [
         /* eslint-disable max-len */
         `Warning: Using UNSAFE_componentWillMount in strict mode is not recommended and may indicate bugs in your code. See https://reactjs.org/link/unsafe-component-lifecycles for details.
@@ -597,11 +597,10 @@ Please update the following components: App`,
     );
 
     // Dedupe
-    root.render(<App />);
-    Scheduler.unstable_flushAll();
+    await act(() => root.render(<App />));
   });
 
-  it('should coalesce warnings by lifecycle name', () => {
+  it('should coalesce warnings by lifecycle name', async () => {
     function StrictRoot() {
       return (
         <React.StrictMode>
@@ -633,10 +632,11 @@ Please update the following components: App`,
 
     const container = document.createElement('div');
     const root = ReactDOMClient.createRoot(container);
-    root.render(<StrictRoot />);
 
-    expect(() => {
-      expect(() => Scheduler.unstable_flushAll()).toErrorDev(
+    await expect(async () => {
+      await expect(
+        async () => await act(() => root.render(<StrictRoot />)),
+      ).toErrorDev(
         [
           /* eslint-disable max-len */
           `Warning: Using UNSAFE_componentWillMount in strict mode is not recommended and may indicate bugs in your code. See https://reactjs.org/link/unsafe-component-lifecycles for details.
@@ -686,11 +686,10 @@ Please update the following components: Parent`,
       {withoutStack: true},
     );
     // Dedupe
-    root.render(<StrictRoot />);
-    Scheduler.unstable_flushAll();
+    await act(() => root.render(<StrictRoot />));
   });
 
-  it('should warn about components not present during the initial render', () => {
+  it('should warn about components not present during the initial render', async () => {
     function StrictRoot({foo}) {
       return <React.StrictMode>{foo ? <Foo /> : <Bar />}</React.StrictMode>;
     }
@@ -709,23 +708,23 @@ Please update the following components: Parent`,
 
     const container = document.createElement('div');
     const root = ReactDOMClient.createRoot(container);
-    root.render(<StrictRoot foo={true} />);
-    expect(() => Scheduler.unstable_flushAll()).toErrorDev(
+    await expect(async () => {
+      await act(() => root.render(<StrictRoot foo={true} />));
+    }).toErrorDev(
       'Using UNSAFE_componentWillMount in strict mode is not recommended',
       {withoutStack: true},
     );
 
-    root.render(<StrictRoot foo={false} />);
-    expect(() => Scheduler.unstable_flushAll()).toErrorDev(
+    await expect(async () => {
+      await act(() => root.render(<StrictRoot foo={false} />));
+    }).toErrorDev(
       'Using UNSAFE_componentWillMount in strict mode is not recommended',
       {withoutStack: true},
     );
 
     // Dedupe
-    root.render(<StrictRoot foo={true} />);
-    Scheduler.unstable_flushAll();
-    root.render(<StrictRoot foo={false} />);
-    Scheduler.unstable_flushAll();
+    await act(() => root.render(<StrictRoot foo={true} />));
+    await act(() => root.render(<StrictRoot foo={false} />));
   });
 
   it('should also warn inside of "strict" mode trees', () => {

commit 63346148603675f5d03509969007b7937cfddff2
Author: Andrew Clark <git@andrewclark.io>
Date:   Sat Mar 11 15:32:02 2023 -0500

    Add disableLegacyContext test gates where needed (#26371)
    
    The www builds include disableLegacyContext as a dynamic flag, so we
    should be running the tests in that mode, too. Previously we were
    overriding the flag during the test run. This strategy usually doesn't
    work because the flags get compiled out in the final build, but we
    happen to not test www in build mode, only source.
    
    To get of this hacky override, I added a test gate to every test that
    uses legacy context. When we eventually remove legacy context from the
    codebase, this should make it slightly easier to find which tests are
    affected. And removes one more hack from our hack-ridden test config.
    
    Given that sometimes www has features enabled that aren't on in other
    builds, we might want to consider testing its build artifacts in CI,
    rather than just source. That would have forced this cleanup to happen
    sooner. Currently we only test the public builds in CI.

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index 800607dd95..c0d392a61f 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -985,6 +985,7 @@ describe('context legacy', () => {
     jest.restoreAllMocks();
   });
 
+  // @gate !disableLegacyContext || !__DEV__
   it('should warn if the legacy context API have been used in strict mode', () => {
     class LegacyContextProvider extends React.Component {
       getChildContext() {

commit fa8a34bfac9be820269b52f1e55afe9fe89bfcf1
Author: Sebastian Silbermann <silbermann.sebastian@gmail.com>
Date:   Fri Feb 2 08:57:56 2024 +0100

    Convert ReactStrictMode to createRoot (#28162)

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index c0d392a61f..c0a4d59f3d 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -34,19 +34,21 @@ describe('ReactStrictMode', () => {
     useReducer = React.useReducer;
   });
 
-  it('should appear in the client component stack', () => {
+  it('should appear in the client component stack', async () => {
     function Foo() {
       return <div ariaTypo="" />;
     }
 
     const container = document.createElement('div');
-    expect(() => {
-      ReactDOM.render(
-        <React.StrictMode>
-          <Foo />
-        </React.StrictMode>,
-        container,
-      );
+    const root = ReactDOMClient.createRoot(container);
+    await expect(async () => {
+      await act(() => {
+        root.render(
+          <React.StrictMode>
+            <Foo />
+          </React.StrictMode>,
+        );
+      });
     }).toErrorDev(
       'Invalid ARIA attribute `ariaTypo`. ' +
         'ARIA attributes follow the pattern aria-* and must be lowercase.\n' +
@@ -75,7 +77,7 @@ describe('ReactStrictMode', () => {
   });
 
   // @gate __DEV__
-  it('should invoke precommit lifecycle methods twice', () => {
+  it('should invoke only precommit lifecycle methods twice in legacy roots', async () => {
     let log = [];
     let shouldComponentUpdate = false;
     class ClassComponent extends React.Component {
@@ -162,7 +164,7 @@ describe('ReactStrictMode', () => {
     ]);
   });
 
-  it('should invoke setState callbacks twice', () => {
+  it('should invoke setState callbacks twice', async () => {
     let instance;
     class ClassComponent extends React.Component {
       state = {
@@ -177,17 +179,21 @@ describe('ReactStrictMode', () => {
     let setStateCount = 0;
 
     const container = document.createElement('div');
-    ReactDOM.render(
-      <React.StrictMode>
-        <ClassComponent />
-      </React.StrictMode>,
-      container,
-    );
-    instance.setState(state => {
-      setStateCount++;
-      return {
-        count: state.count + 1,
-      };
+    const root = ReactDOMClient.createRoot(container);
+    await act(() => {
+      root.render(
+        <React.StrictMode>
+          <ClassComponent />
+        </React.StrictMode>,
+      );
+    });
+    await act(() => {
+      instance.setState(state => {
+        setStateCount++;
+        return {
+          count: state.count + 1,
+        };
+      });
     });
 
     // Callback should be invoked twice in DEV
@@ -196,7 +202,7 @@ describe('ReactStrictMode', () => {
     expect(instance.state.count).toBe(2);
   });
 
-  it('should invoke precommit lifecycle methods twice in DEV', () => {
+  it('should invoke only precommit lifecycle methods twice in DEV legacy roots', async () => {
     const {StrictMode} = React;
 
     let log = [];
@@ -303,7 +309,7 @@ describe('ReactStrictMode', () => {
     }
   });
 
-  it('should invoke setState callbacks twice in DEV', () => {
+  it('should invoke setState callbacks twice in DEV', async () => {
     const {StrictMode} = React;
 
     let instance;
@@ -320,17 +326,21 @@ describe('ReactStrictMode', () => {
     let setStateCount = 0;
 
     const container = document.createElement('div');
-    ReactDOM.render(
-      <StrictMode>
-        <ClassComponent />
-      </StrictMode>,
-      container,
-    );
-    instance.setState(state => {
-      setStateCount++;
-      return {
-        count: state.count + 1,
-      };
+    const root = ReactDOMClient.createRoot(container);
+    await act(() => {
+      root.render(
+        <StrictMode>
+          <ClassComponent />
+        </StrictMode>,
+      );
+    });
+    await act(() => {
+      instance.setState(state => {
+        setStateCount++;
+        return {
+          count: state.count + 1,
+        };
+      });
     });
 
     // Callback should be invoked twice (in DEV)
@@ -522,7 +532,6 @@ describe('Concurrent Mode', () => {
     jest.resetModules();
 
     React = require('react');
-    ReactDOM = require('react-dom');
     ReactDOMClient = require('react-dom/client');
     act = require('internal-test-utils').act;
   });
@@ -727,7 +736,7 @@ Please update the following components: Parent`,
     await act(() => root.render(<StrictRoot foo={false} />));
   });
 
-  it('should also warn inside of "strict" mode trees', () => {
+  it('should also warn inside of "strict" mode trees', async () => {
     const {StrictMode} = React;
 
     class SyncRoot extends React.Component {
@@ -765,13 +774,20 @@ Please update the following components: Parent`,
 
     const container = document.createElement('div');
 
-    expect(() => ReactDOM.render(<SyncRoot />, container)).toErrorDev(
+    const root = ReactDOMClient.createRoot(container);
+    await expect(async () => {
+      await act(() => {
+        root.render(<SyncRoot />);
+      });
+    }).toErrorDev(
       'Using UNSAFE_componentWillReceiveProps in strict mode is not recommended',
       {withoutStack: true},
     );
 
     // Dedupe
-    ReactDOM.render(<SyncRoot />, container);
+    await act(() => {
+      root.render(<SyncRoot />);
+    });
   });
 });
 
@@ -779,11 +795,11 @@ describe('symbol checks', () => {
   beforeEach(() => {
     jest.resetModules();
     React = require('react');
-    ReactDOM = require('react-dom');
     ReactDOMClient = require('react-dom/client');
+    act = require('internal-test-utils').act;
   });
 
-  it('should switch from StrictMode to a Fragment and reset state', () => {
+  it('should switch from StrictMode to a Fragment and reset state', async () => {
     const {Fragment, StrictMode} = React;
 
     function ParentComponent({useFragment}) {
@@ -813,13 +829,18 @@ describe('symbol checks', () => {
     }
 
     const container = document.createElement('div');
-    ReactDOM.render(<ParentComponent useFragment={false} />, container);
+    const root = ReactDOMClient.createRoot(container);
+    await act(() => {
+      root.render(<ParentComponent useFragment={false} />);
+    });
     expect(container.textContent).toBe('count:1');
-    ReactDOM.render(<ParentComponent useFragment={true} />, container);
+    await act(() => {
+      root.render(<ParentComponent useFragment={true} />);
+    });
     expect(container.textContent).toBe('count:1');
   });
 
-  it('should switch from a Fragment to StrictMode and reset state', () => {
+  it('should switch from a Fragment to StrictMode and reset state', async () => {
     const {Fragment, StrictMode} = React;
 
     function ParentComponent({useFragment}) {
@@ -849,13 +870,18 @@ describe('symbol checks', () => {
     }
 
     const container = document.createElement('div');
-    ReactDOM.render(<ParentComponent useFragment={true} />, container);
+    const root = ReactDOMClient.createRoot(container);
+    await act(() => {
+      root.render(<ParentComponent useFragment={true} />);
+    });
     expect(container.textContent).toBe('count:1');
-    ReactDOM.render(<ParentComponent useFragment={false} />, container);
+    await act(() => {
+      root.render(<ParentComponent useFragment={false} />);
+    });
     expect(container.textContent).toBe('count:1');
   });
 
-  it('should update with StrictMode without losing state', () => {
+  it('should update with StrictMode without losing state', async () => {
     const {StrictMode} = React;
 
     function ParentComponent() {
@@ -881,9 +907,14 @@ describe('symbol checks', () => {
     }
 
     const container = document.createElement('div');
-    ReactDOM.render(<ParentComponent />, container);
+    const root = ReactDOMClient.createRoot(container);
+    await act(() => {
+      root.render(<ParentComponent />);
+    });
     expect(container.textContent).toBe('count:1');
-    ReactDOM.render(<ParentComponent />, container);
+    await act(() => {
+      root.render(<ParentComponent />);
+    });
     expect(container.textContent).toBe('count:2');
   });
 });
@@ -894,9 +925,10 @@ describe('string refs', () => {
     React = require('react');
     ReactDOM = require('react-dom');
     ReactDOMClient = require('react-dom/client');
+    act = require('internal-test-utils').act;
   });
 
-  it('should warn within a strict tree', () => {
+  it('should warn within a strict tree', async () => {
     const {StrictMode} = React;
 
     class OuterComponent extends React.Component {
@@ -916,8 +948,11 @@ describe('string refs', () => {
     }
 
     const container = document.createElement('div');
-    expect(() => {
-      ReactDOM.render(<OuterComponent />, container);
+    const root = ReactDOMClient.createRoot(container);
+    await expect(async () => {
+      await act(() => {
+        root.render(<OuterComponent />);
+      });
     }).toErrorDev(
       'Warning: Component "StrictMode" contains the string ref "somestring". ' +
         'Support for string refs will be removed in a future major release. ' +
@@ -926,49 +961,47 @@ describe('string refs', () => {
         '    in OuterComponent (at **)',
     );
 
-    // Dedup
-    ReactDOM.render(<OuterComponent />, container);
+    await act(() => {
+      root.render(<OuterComponent />);
+    });
   });
 
-  it('should warn within a strict tree', () => {
+  it('should warn within a strict tree', async () => {
     const {StrictMode} = React;
 
     class OuterComponent extends React.Component {
       render() {
         return (
           <StrictMode>
-            <InnerComponent />
+            <InnerComponent ref="somestring" />
           </StrictMode>
         );
       }
     }
 
     class InnerComponent extends React.Component {
-      render() {
-        return <MiddleComponent ref="somestring" />;
-      }
-    }
-
-    class MiddleComponent extends React.Component {
       render() {
         return null;
       }
     }
 
     const container = document.createElement('div');
-    expect(() => {
-      ReactDOM.render(<OuterComponent />, container);
+    const root = ReactDOMClient.createRoot(container);
+    await expect(async () => {
+      await act(() => {
+        root.render(<OuterComponent />);
+      });
     }).toErrorDev(
-      'Warning: Component "InnerComponent" contains the string ref "somestring". ' +
+      'Warning: Component "StrictMode" contains the string ref "somestring". ' +
         'Support for string refs will be removed in a future major release. ' +
         'We recommend using useRef() or createRef() instead. ' +
         'Learn more about using refs safely here: https://reactjs.org/link/strict-mode-string-ref\n' +
-        '    in InnerComponent (at **)\n' +
         '    in OuterComponent (at **)',
     );
 
-    // Dedup
-    ReactDOM.render(<OuterComponent />, container);
+    await act(() => {
+      root.render(<OuterComponent />);
+    });
   });
 });
 
@@ -976,8 +1009,8 @@ describe('context legacy', () => {
   beforeEach(() => {
     jest.resetModules();
     React = require('react');
-    ReactDOM = require('react-dom');
     ReactDOMClient = require('react-dom/client');
+    act = require('internal-test-utils').act;
     PropTypes = require('prop-types');
   });
 
@@ -986,7 +1019,7 @@ describe('context legacy', () => {
   });
 
   // @gate !disableLegacyContext || !__DEV__
-  it('should warn if the legacy context API have been used in strict mode', () => {
+  it('should warn if the legacy context API have been used in strict mode', async () => {
     class LegacyContextProvider extends React.Component {
       getChildContext() {
         return {color: 'purple'};
@@ -1039,8 +1072,11 @@ describe('context legacy', () => {
     };
 
     const container = document.createElement('div');
-    expect(() => {
-      ReactDOM.render(<Root />, container);
+    const root = ReactDOMClient.createRoot(container);
+    await expect(async () => {
+      await act(() => {
+        root.render(<Root />);
+      });
     }).toErrorDev(
       'Warning: Legacy context API has been detected within a strict-mode tree.' +
         '\n\nThe old API will be supported in all 16.x releases, but applications ' +
@@ -1055,19 +1091,21 @@ describe('context legacy', () => {
     );
 
     // Dedupe
-    ReactDOM.render(<Root />, container);
+    await act(() => {
+      root.render(<Root />);
+    });
   });
 
   describe('console logs logging', () => {
     beforeEach(() => {
       jest.resetModules();
       React = require('react');
-      ReactDOM = require('react-dom');
       ReactDOMClient = require('react-dom/client');
+      act = require('internal-test-utils').act;
     });
 
     if (ReactFeatureFlags.consoleManagedByDevToolsDuringStrictMode) {
-      it('does not disable logs for class double render', () => {
+      it('does not disable logs for class double render', async () => {
         spyOnDevAndProd(console, 'log');
 
         let count = 0;
@@ -1080,13 +1118,14 @@ describe('context legacy', () => {
         }
 
         const container = document.createElement('div');
-        ReactDOM.render(
-          <React.StrictMode>
-            <Foo />
-          </React.StrictMode>,
-          container,
-        );
-
+        const root = ReactDOMClient.createRoot(container);
+        await act(() => {
+          root.render(
+            <React.StrictMode>
+              <Foo />
+            </React.StrictMode>,
+          );
+        });
         expect(count).toBe(__DEV__ ? 2 : 1);
         expect(console.log).toBeCalledTimes(__DEV__ ? 2 : 1);
         // Note: we should display the first log because otherwise
@@ -1095,7 +1134,7 @@ describe('context legacy', () => {
         expect(console.log).toBeCalledWith('foo 1');
       });
 
-      it('does not disable logs for class double ctor', () => {
+      it('does not disable logs for class double ctor', async () => {
         spyOnDevAndProd(console, 'log');
 
         let count = 0;
@@ -1111,13 +1150,14 @@ describe('context legacy', () => {
         }
 
         const container = document.createElement('div');
-        ReactDOM.render(
-          <React.StrictMode>
-            <Foo />
-          </React.StrictMode>,
-          container,
-        );
-
+        const root = ReactDOMClient.createRoot(container);
+        await act(() => {
+          root.render(
+            <React.StrictMode>
+              <Foo />
+            </React.StrictMode>,
+          );
+        });
         expect(count).toBe(__DEV__ ? 2 : 1);
         expect(console.log).toBeCalledTimes(__DEV__ ? 2 : 1);
         // Note: we should display the first log because otherwise
@@ -1126,7 +1166,7 @@ describe('context legacy', () => {
         expect(console.log).toBeCalledWith('foo 1');
       });
 
-      it('does not disable logs for class double getDerivedStateFromProps', () => {
+      it('does not disable logs for class double getDerivedStateFromProps', async () => {
         spyOnDevAndProd(console, 'log');
 
         let count = 0;
@@ -1143,13 +1183,14 @@ describe('context legacy', () => {
         }
 
         const container = document.createElement('div');
-        ReactDOM.render(
-          <React.StrictMode>
-            <Foo />
-          </React.StrictMode>,
-          container,
-        );
-
+        const root = ReactDOMClient.createRoot(container);
+        await act(() => {
+          root.render(
+            <React.StrictMode>
+              <Foo />
+            </React.StrictMode>,
+          );
+        });
         expect(count).toBe(__DEV__ ? 2 : 1);
         expect(console.log).toBeCalledTimes(__DEV__ ? 2 : 1);
         // Note: we should display the first log because otherwise
@@ -1158,7 +1199,7 @@ describe('context legacy', () => {
         expect(console.log).toBeCalledWith('foo 1');
       });
 
-      it('does not disable logs for class double shouldComponentUpdate', () => {
+      it('does not disable logs for class double shouldComponentUpdate', async () => {
         spyOnDevAndProd(console, 'log');
 
         let count = 0;
@@ -1175,19 +1216,21 @@ describe('context legacy', () => {
         }
 
         const container = document.createElement('div');
-        ReactDOM.render(
-          <React.StrictMode>
-            <Foo />
-          </React.StrictMode>,
-          container,
-        );
-        // Trigger sCU:
-        ReactDOM.render(
-          <React.StrictMode>
-            <Foo />
-          </React.StrictMode>,
-          container,
-        );
+        const root = ReactDOMClient.createRoot(container);
+        await act(() => {
+          root.render(
+            <React.StrictMode>
+              <Foo />
+            </React.StrictMode>,
+          );
+        });
+        await act(() => {
+          root.render(
+            <React.StrictMode>
+              <Foo />
+            </React.StrictMode>,
+          );
+        });
 
         expect(count).toBe(__DEV__ ? 2 : 1);
         expect(console.log).toBeCalledTimes(__DEV__ ? 2 : 1);
@@ -1197,7 +1240,7 @@ describe('context legacy', () => {
         expect(console.log).toBeCalledWith('foo 1');
       });
 
-      it('does not disable logs for class state updaters', () => {
+      it('does not disable logs for class state updaters', async () => {
         spyOnDevAndProd(console, 'log');
 
         let inst;
@@ -1211,16 +1254,20 @@ describe('context legacy', () => {
         }
 
         const container = document.createElement('div');
-        ReactDOM.render(
-          <React.StrictMode>
-            <Foo />
-          </React.StrictMode>,
-          container,
-        );
-        inst.setState(() => {
-          count++;
-          console.log('foo ' + count);
-          return {};
+        const root = ReactDOMClient.createRoot(container);
+        await act(() => {
+          root.render(
+            <React.StrictMode>
+              <Foo />
+            </React.StrictMode>,
+          );
+        });
+        await act(() => {
+          inst.setState(() => {
+            count++;
+            console.log('foo ' + count);
+            return {};
+          });
         });
 
         expect(count).toBe(__DEV__ ? 2 : 1);
@@ -1231,7 +1278,7 @@ describe('context legacy', () => {
         expect(console.log).toBeCalledWith('foo 1');
       });
 
-      it('does not disable logs for function double render', () => {
+      it('does not disable logs for function double render', async () => {
         spyOnDevAndProd(console, 'log');
 
         let count = 0;
@@ -1242,13 +1289,14 @@ describe('context legacy', () => {
         }
 
         const container = document.createElement('div');
-        ReactDOM.render(
-          <React.StrictMode>
-            <Foo />
-          </React.StrictMode>,
-          container,
-        );
-
+        const root = ReactDOMClient.createRoot(container);
+        await act(() => {
+          root.render(
+            <React.StrictMode>
+              <Foo />
+            </React.StrictMode>,
+          );
+        });
         expect(count).toBe(__DEV__ ? 2 : 1);
         expect(console.log).toBeCalledTimes(__DEV__ ? 2 : 1);
         // Note: we should display the first log because otherwise
@@ -1257,7 +1305,7 @@ describe('context legacy', () => {
         expect(console.log).toBeCalledWith('foo 1');
       });
     } else {
-      it('disable logs for class double render', () => {
+      it('disable logs for class double render', async () => {
         spyOnDevAndProd(console, 'log');
 
         let count = 0;
@@ -1270,13 +1318,14 @@ describe('context legacy', () => {
         }
 
         const container = document.createElement('div');
-        ReactDOM.render(
-          <React.StrictMode>
-            <Foo />
-          </React.StrictMode>,
-          container,
-        );
-
+        const root = ReactDOMClient.createRoot(container);
+        await act(() => {
+          root.render(
+            <React.StrictMode>
+              <Foo />
+            </React.StrictMode>,
+          );
+        });
         expect(count).toBe(__DEV__ ? 2 : 1);
         expect(console.log).toBeCalledTimes(1);
         // Note: we should display the first log because otherwise
@@ -1285,7 +1334,7 @@ describe('context legacy', () => {
         expect(console.log).toBeCalledWith('foo 1');
       });
 
-      it('disables logs for class double ctor', () => {
+      it('disables logs for class double ctor', async () => {
         spyOnDevAndProd(console, 'log');
 
         let count = 0;
@@ -1301,13 +1350,14 @@ describe('context legacy', () => {
         }
 
         const container = document.createElement('div');
-        ReactDOM.render(
-          <React.StrictMode>
-            <Foo />
-          </React.StrictMode>,
-          container,
-        );
-
+        const root = ReactDOMClient.createRoot(container);
+        await act(() => {
+          root.render(
+            <React.StrictMode>
+              <Foo />
+            </React.StrictMode>,
+          );
+        });
         expect(count).toBe(__DEV__ ? 2 : 1);
         expect(console.log).toBeCalledTimes(1);
         // Note: we should display the first log because otherwise
@@ -1316,7 +1366,7 @@ describe('context legacy', () => {
         expect(console.log).toBeCalledWith('foo 1');
       });
 
-      it('disable logs for class double getDerivedStateFromProps', () => {
+      it('disable logs for class double getDerivedStateFromProps', async () => {
         spyOnDevAndProd(console, 'log');
 
         let count = 0;
@@ -1333,13 +1383,14 @@ describe('context legacy', () => {
         }
 
         const container = document.createElement('div');
-        ReactDOM.render(
-          <React.StrictMode>
-            <Foo />
-          </React.StrictMode>,
-          container,
-        );
-
+        const root = ReactDOMClient.createRoot(container);
+        await act(() => {
+          root.render(
+            <React.StrictMode>
+              <Foo />
+            </React.StrictMode>,
+          );
+        });
         expect(count).toBe(__DEV__ ? 2 : 1);
         expect(console.log).toBeCalledTimes(1);
         // Note: we should display the first log because otherwise
@@ -1348,7 +1399,7 @@ describe('context legacy', () => {
         expect(console.log).toBeCalledWith('foo 1');
       });
 
-      it('disable logs for class double shouldComponentUpdate', () => {
+      it('disable logs for class double shouldComponentUpdate', async () => {
         spyOnDevAndProd(console, 'log');
 
         let count = 0;
@@ -1365,20 +1416,21 @@ describe('context legacy', () => {
         }
 
         const container = document.createElement('div');
-        ReactDOM.render(
-          <React.StrictMode>
-            <Foo />
-          </React.StrictMode>,
-          container,
-        );
-        // Trigger sCU:
-        ReactDOM.render(
-          <React.StrictMode>
-            <Foo />
-          </React.StrictMode>,
-          container,
-        );
-
+        const root = ReactDOMClient.createRoot(container);
+        await act(() => {
+          root.render(
+            <React.StrictMode>
+              <Foo />
+            </React.StrictMode>,
+          );
+        });
+        await act(() => {
+          root.render(
+            <React.StrictMode>
+              <Foo />
+            </React.StrictMode>,
+          );
+        });
         expect(count).toBe(__DEV__ ? 2 : 1);
         expect(console.log).toBeCalledTimes(1);
         // Note: we should display the first log because otherwise
@@ -1387,7 +1439,7 @@ describe('context legacy', () => {
         expect(console.log).toBeCalledWith('foo 1');
       });
 
-      it('disable logs for class state updaters', () => {
+      it('disable logs for class state updaters', async () => {
         spyOnDevAndProd(console, 'log');
 
         let inst;
@@ -1401,16 +1453,20 @@ describe('context legacy', () => {
         }
 
         const container = document.createElement('div');
-        ReactDOM.render(
-          <React.StrictMode>
-            <Foo />
-          </React.StrictMode>,
-          container,
-        );
-        inst.setState(() => {
-          count++;
-          console.log('foo ' + count);
-          return {};
+        const root = ReactDOMClient.createRoot(container);
+        await act(() => {
+          root.render(
+            <React.StrictMode>
+              <Foo />
+            </React.StrictMode>,
+          );
+        });
+        await act(() => {
+          inst.setState(() => {
+            count++;
+            console.log('foo ' + count);
+            return {};
+          });
         });
 
         expect(count).toBe(__DEV__ ? 2 : 1);
@@ -1421,7 +1477,7 @@ describe('context legacy', () => {
         expect(console.log).toBeCalledWith('foo 1');
       });
 
-      it('disable logs for function double render', () => {
+      it('disable logs for function double render', async () => {
         spyOnDevAndProd(console, 'log');
 
         let count = 0;
@@ -1432,13 +1488,14 @@ describe('context legacy', () => {
         }
 
         const container = document.createElement('div');
-        ReactDOM.render(
-          <React.StrictMode>
-            <Foo />
-          </React.StrictMode>,
-          container,
-        );
-
+        const root = ReactDOMClient.createRoot(container);
+        await act(() => {
+          root.render(
+            <React.StrictMode>
+              <Foo />
+            </React.StrictMode>,
+          );
+        });
         expect(count).toBe(__DEV__ ? 2 : 1);
         expect(console.log).toBeCalledTimes(1);
         // Note: we should display the first log because otherwise

commit 97fd3e7064b162f05b1bac3962ed10c6559c346c
Author: Sebastian Silbermann <silbermann.sebastian@gmail.com>
Date:   Tue Feb 6 17:53:08 2024 +0100

    Ensure useState and useReducer initializer functions are double invoked in StrictMode (#28248)

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index c0a4d59f3d..28dd94ad06 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -202,6 +202,46 @@ describe('ReactStrictMode', () => {
     expect(instance.state.count).toBe(2);
   });
 
+  // @gate debugRenderPhaseSideEffectsForStrictMode
+  it('double invokes useState and useReducer initializers functions', async () => {
+    const log = [];
+
+    function App() {
+      React.useState(() => {
+        log.push('Compute initial state count: 1');
+        return 1;
+      });
+      React.useReducer(
+        s => s,
+        2,
+        s => {
+          log.push('Compute initial reducer count: 2');
+          return s;
+        },
+      );
+
+      return 3;
+    }
+
+    const container = document.createElement('div');
+    const root = ReactDOMClient.createRoot(container);
+    await act(() => {
+      root.render(
+        <React.StrictMode>
+          <App />
+        </React.StrictMode>,
+      );
+    });
+    expect(container.textContent).toBe('3');
+
+    expect(log).toEqual([
+      'Compute initial state count: 1',
+      'Compute initial state count: 1',
+      'Compute initial reducer count: 2',
+      'Compute initial reducer count: 2',
+    ]);
+  });
+
   it('should invoke only precommit lifecycle methods twice in DEV legacy roots', async () => {
     const {StrictMode} = React;
 

commit 30e2938e04c8cf51688509a457a494d36bcc4269
Author: Rick Hanlon <rickhanlonii@gmail.com>
Date:   Tue Feb 6 12:43:27 2024 -0500

    [Tests] Reset modules by default (#28254)
    
    ## Overview
    
    Sets `resetModules: true` in the base Jest config, and deletes all the
    `jest.resetModule()` calls we don't need.

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index 28dd94ad06..4ccc9a2687 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -23,7 +23,6 @@ const ReactFeatureFlags = require('shared/ReactFeatureFlags');
 
 describe('ReactStrictMode', () => {
   beforeEach(() => {
-    jest.resetModules();
     React = require('react');
     ReactDOM = require('react-dom');
     ReactDOMClient = require('react-dom/client');
@@ -569,8 +568,6 @@ describe('ReactStrictMode', () => {
 
 describe('Concurrent Mode', () => {
   beforeEach(() => {
-    jest.resetModules();
-
     React = require('react');
     ReactDOMClient = require('react-dom/client');
     act = require('internal-test-utils').act;
@@ -833,7 +830,6 @@ Please update the following components: Parent`,
 
 describe('symbol checks', () => {
   beforeEach(() => {
-    jest.resetModules();
     React = require('react');
     ReactDOMClient = require('react-dom/client');
     act = require('internal-test-utils').act;
@@ -961,7 +957,6 @@ describe('symbol checks', () => {
 
 describe('string refs', () => {
   beforeEach(() => {
-    jest.resetModules();
     React = require('react');
     ReactDOM = require('react-dom');
     ReactDOMClient = require('react-dom/client');
@@ -1047,7 +1042,6 @@ describe('string refs', () => {
 
 describe('context legacy', () => {
   beforeEach(() => {
-    jest.resetModules();
     React = require('react');
     ReactDOMClient = require('react-dom/client');
     act = require('internal-test-utils').act;
@@ -1138,7 +1132,6 @@ describe('context legacy', () => {
 
   describe('console logs logging', () => {
     beforeEach(() => {
-      jest.resetModules();
       React = require('react');
       ReactDOMClient = require('react-dom/client');
       act = require('internal-test-utils').act;

commit 015ff2ed66c1d164111752263682d1d757c97f3e
Author: Andrew Clark <git@andrewclark.io>
Date:   Tue Feb 13 11:39:45 2024 -0500

    Revert "[Tests] Reset modules by default" (#28318)
    
    This was causing a slowdown in one of the tests
    ESLintRuleExhaustiveDeps-test.js. Reverting until we figure out why.

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index 4ccc9a2687..28dd94ad06 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -23,6 +23,7 @@ const ReactFeatureFlags = require('shared/ReactFeatureFlags');
 
 describe('ReactStrictMode', () => {
   beforeEach(() => {
+    jest.resetModules();
     React = require('react');
     ReactDOM = require('react-dom');
     ReactDOMClient = require('react-dom/client');
@@ -568,6 +569,8 @@ describe('ReactStrictMode', () => {
 
 describe('Concurrent Mode', () => {
   beforeEach(() => {
+    jest.resetModules();
+
     React = require('react');
     ReactDOMClient = require('react-dom/client');
     act = require('internal-test-utils').act;
@@ -830,6 +833,7 @@ Please update the following components: Parent`,
 
 describe('symbol checks', () => {
   beforeEach(() => {
+    jest.resetModules();
     React = require('react');
     ReactDOMClient = require('react-dom/client');
     act = require('internal-test-utils').act;
@@ -957,6 +961,7 @@ describe('symbol checks', () => {
 
 describe('string refs', () => {
   beforeEach(() => {
+    jest.resetModules();
     React = require('react');
     ReactDOM = require('react-dom');
     ReactDOMClient = require('react-dom/client');
@@ -1042,6 +1047,7 @@ describe('string refs', () => {
 
 describe('context legacy', () => {
   beforeEach(() => {
+    jest.resetModules();
     React = require('react');
     ReactDOMClient = require('react-dom/client');
     act = require('internal-test-utils').act;
@@ -1132,6 +1138,7 @@ describe('context legacy', () => {
 
   describe('console logs logging', () => {
     beforeEach(() => {
+      jest.resetModules();
       React = require('react');
       ReactDOMClient = require('react-dom/client');
       act = require('internal-test-utils').act;

commit c9798954e26a2354a951cc65607f2901a45bf035
Author: Andrew Clark <git@andrewclark.io>
Date:   Tue Feb 27 11:43:04 2024 -0500

    Remove string refs (behind flag)  (#28322)
    
    Depends on:
    
    - https://github.com/facebook/react/pull/28398
    
    ---
    
    This removes string refs, which has been deprecated in Strict Mode for
    seven years.
    
    I've left them behind a flag for Meta, but in open source this fully
    removes the feature.

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index 28dd94ad06..32f4682385 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -968,6 +968,7 @@ describe('string refs', () => {
     act = require('internal-test-utils').act;
   });
 
+  // @gate !disableStringRefs
   it('should warn within a strict tree', async () => {
     const {StrictMode} = React;
 
@@ -1006,6 +1007,7 @@ describe('string refs', () => {
     });
   });
 
+  // @gate !disableStringRefs
   it('should warn within a strict tree', async () => {
     const {StrictMode} = React;
 

commit 1940cb27b260c2eab79c76763d1151ba18353ff8
Author: Rick Hanlon <rickhanlonii@gmail.com>
Date:   Sun Mar 3 17:34:33 2024 -0500

    Update /link URLs to react.dev (#28477)
    
    Depends on https://github.com/reactjs/react.dev/pull/6670 [merged]

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index 32f4682385..dbc7bb36ff 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -624,18 +624,18 @@ describe('Concurrent Mode', () => {
     ).toErrorDev(
       [
         /* eslint-disable max-len */
-        `Warning: Using UNSAFE_componentWillMount in strict mode is not recommended and may indicate bugs in your code. See https://reactjs.org/link/unsafe-component-lifecycles for details.
+        `Warning: Using UNSAFE_componentWillMount in strict mode is not recommended and may indicate bugs in your code. See https://react.dev/link/unsafe-component-lifecycles for details.
 
 * Move code with side effects to componentDidMount, and set initial state in the constructor.
 
 Please update the following components: App`,
-        `Warning: Using UNSAFE_componentWillReceiveProps in strict mode is not recommended and may indicate bugs in your code. See https://reactjs.org/link/unsafe-component-lifecycles for details.
+        `Warning: Using UNSAFE_componentWillReceiveProps in strict mode is not recommended and may indicate bugs in your code. See https://react.dev/link/unsafe-component-lifecycles for details.
 
 * Move data fetching code or side effects to componentDidUpdate.
-* If you're updating state whenever props change, refactor your code to use memoization techniques or move it to static getDerivedStateFromProps. Learn more at: https://reactjs.org/link/derived-state
+* If you're updating state whenever props change, refactor your code to use memoization techniques or move it to static getDerivedStateFromProps. Learn more at: https://react.dev/link/derived-state
 
 Please update the following components: Bar, Foo`,
-        `Warning: Using UNSAFE_componentWillUpdate in strict mode is not recommended and may indicate bugs in your code. See https://reactjs.org/link/unsafe-component-lifecycles for details.
+        `Warning: Using UNSAFE_componentWillUpdate in strict mode is not recommended and may indicate bugs in your code. See https://react.dev/link/unsafe-component-lifecycles for details.
 
 * Move data fetching code or side effects to componentDidUpdate.
 
@@ -688,18 +688,18 @@ Please update the following components: App`,
       ).toErrorDev(
         [
           /* eslint-disable max-len */
-          `Warning: Using UNSAFE_componentWillMount in strict mode is not recommended and may indicate bugs in your code. See https://reactjs.org/link/unsafe-component-lifecycles for details.
+          `Warning: Using UNSAFE_componentWillMount in strict mode is not recommended and may indicate bugs in your code. See https://react.dev/link/unsafe-component-lifecycles for details.
 
 * Move code with side effects to componentDidMount, and set initial state in the constructor.
 
 Please update the following components: App`,
-          `Warning: Using UNSAFE_componentWillReceiveProps in strict mode is not recommended and may indicate bugs in your code. See https://reactjs.org/link/unsafe-component-lifecycles for details.
+          `Warning: Using UNSAFE_componentWillReceiveProps in strict mode is not recommended and may indicate bugs in your code. See https://react.dev/link/unsafe-component-lifecycles for details.
 
 * Move data fetching code or side effects to componentDidUpdate.
-* If you're updating state whenever props change, refactor your code to use memoization techniques or move it to static getDerivedStateFromProps. Learn more at: https://reactjs.org/link/derived-state
+* If you're updating state whenever props change, refactor your code to use memoization techniques or move it to static getDerivedStateFromProps. Learn more at: https://react.dev/link/derived-state
 
 Please update the following components: Child`,
-          `Warning: Using UNSAFE_componentWillUpdate in strict mode is not recommended and may indicate bugs in your code. See https://reactjs.org/link/unsafe-component-lifecycles for details.
+          `Warning: Using UNSAFE_componentWillUpdate in strict mode is not recommended and may indicate bugs in your code. See https://react.dev/link/unsafe-component-lifecycles for details.
 
 * Move data fetching code or side effects to componentDidUpdate.
 
@@ -711,20 +711,20 @@ Please update the following components: App`,
     }).toWarnDev(
       [
         /* eslint-disable max-len */
-        `Warning: componentWillMount has been renamed, and is not recommended for use. See https://reactjs.org/link/unsafe-component-lifecycles for details.
+        `Warning: componentWillMount has been renamed, and is not recommended for use. See https://react.dev/link/unsafe-component-lifecycles for details.
 
 * Move code with side effects to componentDidMount, and set initial state in the constructor.
 * Rename componentWillMount to UNSAFE_componentWillMount to suppress this warning in non-strict mode. In React 18.x, only the UNSAFE_ name will work. To rename all deprecated lifecycles to their new names, you can run \`npx react-codemod rename-unsafe-lifecycles\` in your project source folder.
 
 Please update the following components: Parent`,
-        `Warning: componentWillReceiveProps has been renamed, and is not recommended for use. See https://reactjs.org/link/unsafe-component-lifecycles for details.
+        `Warning: componentWillReceiveProps has been renamed, and is not recommended for use. See https://react.dev/link/unsafe-component-lifecycles for details.
 
 * Move data fetching code or side effects to componentDidUpdate.
-* If you're updating state whenever props change, refactor your code to use memoization techniques or move it to static getDerivedStateFromProps. Learn more at: https://reactjs.org/link/derived-state
+* If you're updating state whenever props change, refactor your code to use memoization techniques or move it to static getDerivedStateFromProps. Learn more at: https://react.dev/link/derived-state
 * Rename componentWillReceiveProps to UNSAFE_componentWillReceiveProps to suppress this warning in non-strict mode. In React 18.x, only the UNSAFE_ name will work. To rename all deprecated lifecycles to their new names, you can run \`npx react-codemod rename-unsafe-lifecycles\` in your project source folder.
 
 Please update the following components: Parent`,
-        `Warning: componentWillUpdate has been renamed, and is not recommended for use. See https://reactjs.org/link/unsafe-component-lifecycles for details.
+        `Warning: componentWillUpdate has been renamed, and is not recommended for use. See https://react.dev/link/unsafe-component-lifecycles for details.
 
 * Move data fetching code or side effects to componentDidUpdate.
 * Rename componentWillUpdate to UNSAFE_componentWillUpdate to suppress this warning in non-strict mode. In React 18.x, only the UNSAFE_ name will work. To rename all deprecated lifecycles to their new names, you can run \`npx react-codemod rename-unsafe-lifecycles\` in your project source folder.
@@ -998,7 +998,7 @@ describe('string refs', () => {
       'Warning: Component "StrictMode" contains the string ref "somestring". ' +
         'Support for string refs will be removed in a future major release. ' +
         'We recommend using useRef() or createRef() instead. ' +
-        'Learn more about using refs safely here: https://reactjs.org/link/strict-mode-string-ref\n' +
+        'Learn more about using refs safely here: https://react.dev/link/strict-mode-string-ref\n' +
         '    in OuterComponent (at **)',
     );
 
@@ -1037,7 +1037,7 @@ describe('string refs', () => {
       'Warning: Component "StrictMode" contains the string ref "somestring". ' +
         'Support for string refs will be removed in a future major release. ' +
         'We recommend using useRef() or createRef() instead. ' +
-        'Learn more about using refs safely here: https://reactjs.org/link/strict-mode-string-ref\n' +
+        'Learn more about using refs safely here: https://react.dev/link/strict-mode-string-ref\n' +
         '    in OuterComponent (at **)',
     );
 
@@ -1126,7 +1126,7 @@ describe('context legacy', () => {
         '\n\nPlease update the following components: ' +
         'FunctionalLegacyContextConsumer, LegacyContextConsumer, LegacyContextProvider' +
         '\n\nLearn more about this warning here: ' +
-        'https://reactjs.org/link/legacy-context' +
+        'https://react.dev/link/legacy-context' +
         '\n    in LegacyContextProvider (at **)' +
         '\n    in div (at **)' +
         '\n    in Root (at **)',

commit 1c02b9d2bdc18091cc6afec810fc1b361f00abdd
Author: Josh Story <story@hey.com>
Date:   Mon Mar 4 08:19:17 2024 -0800

    [DOM] disable legacy mode behind flag (#28468)
    
    Adds a flag to disable legacy mode. Currently this flag is used to cause
    legacy mode apis like render and hydrate to throw. This change also
    removes render, hydrate, unmountComponentAtNode, and
    unstable_renderSubtreeIntoContainer from the experiemntal entrypoint.
    Right now for Meta builds this flag is off (legacy mode is still
    supported). In OSS builds this flag matches __NEXT_MAJOR__ which means
    it currently is on in experiemental. This means that after merging
    legacy mode is effectively removed from experimental builds. While this
    is a breaking change, experimental builds are not stable and users can
    pin to older versions or update their use of react-dom to no longer use
    legacy mode APIs.

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index dbc7bb36ff..59351fe6a0 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -77,6 +77,7 @@ describe('ReactStrictMode', () => {
   });
 
   // @gate __DEV__
+  // @gate !disableLegacyMode
   it('should invoke only precommit lifecycle methods twice in legacy roots', async () => {
     let log = [];
     let shouldComponentUpdate = false;
@@ -242,6 +243,7 @@ describe('ReactStrictMode', () => {
     ]);
   });
 
+  // @gate !disableLegacyMode
   it('should invoke only precommit lifecycle methods twice in DEV legacy roots', async () => {
     const {StrictMode} = React;
 

commit 9f835e69ab1c87192b5da4421519b69785c12f69
Author: Timothy Yung <yungsters@meta.com>
Date:   Sat Mar 30 09:36:23 2024 -0700

    Suppress console output in unit tests (#28680)

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index 59351fe6a0..cce952e39e 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -1150,7 +1150,7 @@ describe('context legacy', () => {
 
     if (ReactFeatureFlags.consoleManagedByDevToolsDuringStrictMode) {
       it('does not disable logs for class double render', async () => {
-        spyOnDevAndProd(console, 'log');
+        spyOnDevAndProd(console, 'log').mockImplementation(() => {});
 
         let count = 0;
         class Foo extends React.Component {
@@ -1179,7 +1179,7 @@ describe('context legacy', () => {
       });
 
       it('does not disable logs for class double ctor', async () => {
-        spyOnDevAndProd(console, 'log');
+        spyOnDevAndProd(console, 'log').mockImplementation(() => {});
 
         let count = 0;
         class Foo extends React.Component {
@@ -1211,7 +1211,7 @@ describe('context legacy', () => {
       });
 
       it('does not disable logs for class double getDerivedStateFromProps', async () => {
-        spyOnDevAndProd(console, 'log');
+        spyOnDevAndProd(console, 'log').mockImplementation(() => {});
 
         let count = 0;
         class Foo extends React.Component {
@@ -1244,7 +1244,7 @@ describe('context legacy', () => {
       });
 
       it('does not disable logs for class double shouldComponentUpdate', async () => {
-        spyOnDevAndProd(console, 'log');
+        spyOnDevAndProd(console, 'log').mockImplementation(() => {});
 
         let count = 0;
         class Foo extends React.Component {
@@ -1285,7 +1285,7 @@ describe('context legacy', () => {
       });
 
       it('does not disable logs for class state updaters', async () => {
-        spyOnDevAndProd(console, 'log');
+        spyOnDevAndProd(console, 'log').mockImplementation(() => {});
 
         let inst;
         let count = 0;
@@ -1323,7 +1323,7 @@ describe('context legacy', () => {
       });
 
       it('does not disable logs for function double render', async () => {
-        spyOnDevAndProd(console, 'log');
+        spyOnDevAndProd(console, 'log').mockImplementation(() => {});
 
         let count = 0;
         function Foo() {
@@ -1350,7 +1350,7 @@ describe('context legacy', () => {
       });
     } else {
       it('disable logs for class double render', async () => {
-        spyOnDevAndProd(console, 'log');
+        spyOnDevAndProd(console, 'log').mockImplementation(() => {});
 
         let count = 0;
         class Foo extends React.Component {
@@ -1379,7 +1379,7 @@ describe('context legacy', () => {
       });
 
       it('disables logs for class double ctor', async () => {
-        spyOnDevAndProd(console, 'log');
+        spyOnDevAndProd(console, 'log').mockImplementation(() => {});
 
         let count = 0;
         class Foo extends React.Component {
@@ -1411,7 +1411,7 @@ describe('context legacy', () => {
       });
 
       it('disable logs for class double getDerivedStateFromProps', async () => {
-        spyOnDevAndProd(console, 'log');
+        spyOnDevAndProd(console, 'log').mockImplementation(() => {});
 
         let count = 0;
         class Foo extends React.Component {
@@ -1444,7 +1444,7 @@ describe('context legacy', () => {
       });
 
       it('disable logs for class double shouldComponentUpdate', async () => {
-        spyOnDevAndProd(console, 'log');
+        spyOnDevAndProd(console, 'log').mockImplementation(() => {});
 
         let count = 0;
         class Foo extends React.Component {
@@ -1484,7 +1484,7 @@ describe('context legacy', () => {
       });
 
       it('disable logs for class state updaters', async () => {
-        spyOnDevAndProd(console, 'log');
+        spyOnDevAndProd(console, 'log').mockImplementation(() => {});
 
         let inst;
         let count = 0;
@@ -1522,7 +1522,7 @@ describe('context legacy', () => {
       });
 
       it('disable logs for function double render', async () => {
-        spyOnDevAndProd(console, 'log');
+        spyOnDevAndProd(console, 'log').mockImplementation(() => {});
 
         let count = 0;
         function Foo() {

commit e9ae2c8f352289a8c942b4271b9afe7af68dd5c0
Author: Rick Hanlon <rickhanlonii@gmail.com>
Date:   Mon Apr 1 10:50:48 2024 -0400

    Clean up console.log tests (#28693)
    
    Followups to https://github.com/facebook/react/pull/28680
    
    One of these test don't need to use `console.log`.
    
    The others are specifically testing `console.log` behavior, so I added a
    comment.

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index cce952e39e..588b65f139 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -1146,12 +1146,17 @@ describe('context legacy', () => {
       React = require('react');
       ReactDOMClient = require('react-dom/client');
       act = require('internal-test-utils').act;
+
+      // These tests are specifically testing console.log.
+      spyOnDevAndProd(console, 'log').mockImplementation(() => {});
+    });
+
+    afterEach(() => {
+      console.log.mockRestore();
     });
 
     if (ReactFeatureFlags.consoleManagedByDevToolsDuringStrictMode) {
       it('does not disable logs for class double render', async () => {
-        spyOnDevAndProd(console, 'log').mockImplementation(() => {});
-
         let count = 0;
         class Foo extends React.Component {
           render() {
@@ -1179,8 +1184,6 @@ describe('context legacy', () => {
       });
 
       it('does not disable logs for class double ctor', async () => {
-        spyOnDevAndProd(console, 'log').mockImplementation(() => {});
-
         let count = 0;
         class Foo extends React.Component {
           constructor(props) {
@@ -1211,8 +1214,6 @@ describe('context legacy', () => {
       });
 
       it('does not disable logs for class double getDerivedStateFromProps', async () => {
-        spyOnDevAndProd(console, 'log').mockImplementation(() => {});
-
         let count = 0;
         class Foo extends React.Component {
           state = {};
@@ -1244,8 +1245,6 @@ describe('context legacy', () => {
       });
 
       it('does not disable logs for class double shouldComponentUpdate', async () => {
-        spyOnDevAndProd(console, 'log').mockImplementation(() => {});
-
         let count = 0;
         class Foo extends React.Component {
           state = {};
@@ -1285,8 +1284,6 @@ describe('context legacy', () => {
       });
 
       it('does not disable logs for class state updaters', async () => {
-        spyOnDevAndProd(console, 'log').mockImplementation(() => {});
-
         let inst;
         let count = 0;
         class Foo extends React.Component {
@@ -1323,8 +1320,6 @@ describe('context legacy', () => {
       });
 
       it('does not disable logs for function double render', async () => {
-        spyOnDevAndProd(console, 'log').mockImplementation(() => {});
-
         let count = 0;
         function Foo() {
           count++;
@@ -1350,8 +1345,6 @@ describe('context legacy', () => {
       });
     } else {
       it('disable logs for class double render', async () => {
-        spyOnDevAndProd(console, 'log').mockImplementation(() => {});
-
         let count = 0;
         class Foo extends React.Component {
           render() {
@@ -1379,8 +1372,6 @@ describe('context legacy', () => {
       });
 
       it('disables logs for class double ctor', async () => {
-        spyOnDevAndProd(console, 'log').mockImplementation(() => {});
-
         let count = 0;
         class Foo extends React.Component {
           constructor(props) {
@@ -1411,8 +1402,6 @@ describe('context legacy', () => {
       });
 
       it('disable logs for class double getDerivedStateFromProps', async () => {
-        spyOnDevAndProd(console, 'log').mockImplementation(() => {});
-
         let count = 0;
         class Foo extends React.Component {
           state = {};
@@ -1444,8 +1433,6 @@ describe('context legacy', () => {
       });
 
       it('disable logs for class double shouldComponentUpdate', async () => {
-        spyOnDevAndProd(console, 'log').mockImplementation(() => {});
-
         let count = 0;
         class Foo extends React.Component {
           state = {};
@@ -1484,8 +1471,6 @@ describe('context legacy', () => {
       });
 
       it('disable logs for class state updaters', async () => {
-        spyOnDevAndProd(console, 'log').mockImplementation(() => {});
-
         let inst;
         let count = 0;
         class Foo extends React.Component {
@@ -1522,8 +1507,6 @@ describe('context legacy', () => {
       });
 
       it('disable logs for function double render', async () => {
-        spyOnDevAndProd(console, 'log').mockImplementation(() => {});
-
         let count = 0;
         function Foo() {
           count++;

commit e3ebcd54b98a4f8f5a9f7e63982fa75578b648ed
Author: Andrew Clark <git@andrewclark.io>
Date:   Fri Apr 5 10:53:11 2024 -0400

    Move string ref coercion to JSX runtime (#28473)
    
    Based on:
    
    - #28464
    
    ---
    
    This moves the entire string ref implementation out Fiber and into the
    JSX runtime. The string is converted to a callback ref during element
    creation. This is a subtle change in behavior, because it will have
    already been converted to a callback ref if you access element.prop.ref
    or element.ref. But this is only for Meta, because string refs are
    disabled entirely in open source. And if it leads to an issue in
    practice, the solution is to switch to a different ref type, which Meta
    is going to do regardless.

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index 588b65f139..eabf2a7bd5 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -997,11 +997,11 @@ describe('string refs', () => {
         root.render(<OuterComponent />);
       });
     }).toErrorDev(
-      'Warning: Component "StrictMode" contains the string ref "somestring". ' +
+      'Warning: Component "OuterComponent" contains the string ref "somestring". ' +
         'Support for string refs will be removed in a future major release. ' +
         'We recommend using useRef() or createRef() instead. ' +
         'Learn more about using refs safely here: https://react.dev/link/strict-mode-string-ref\n' +
-        '    in OuterComponent (at **)',
+        '    in InnerComponent (at **)',
     );
 
     await act(() => {
@@ -1036,11 +1036,11 @@ describe('string refs', () => {
         root.render(<OuterComponent />);
       });
     }).toErrorDev(
-      'Warning: Component "StrictMode" contains the string ref "somestring". ' +
+      'Warning: Component "OuterComponent" contains the string ref "somestring". ' +
         'Support for string refs will be removed in a future major release. ' +
         'We recommend using useRef() or createRef() instead. ' +
         'Learn more about using refs safely here: https://react.dev/link/strict-mode-string-ref\n' +
-        '    in OuterComponent (at **)',
+        '    in InnerComponent (at **)',
     );
 
     await act(() => {

commit 3ac551e855f9bec3161da2fc8787958aa62113db
Author: Sebastian Silbermann <silbermann.sebastian@gmail.com>
Date:   Wed May 22 11:39:54 2024 +0200

    Dim `console` calls on additional Effect invocations due to `StrictMode` (#29007)

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index eabf2a7bd5..d9d6815b88 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -1343,6 +1343,42 @@ describe('context legacy', () => {
         // and on the next render they'd get deduplicated and ignored.
         expect(console.log).toBeCalledWith('foo 1');
       });
+
+      it('does not disable logs for effect double invoke', async () => {
+        let create = 0;
+        let cleanup = 0;
+        function Foo() {
+          React.useEffect(() => {
+            create++;
+            console.log('foo create ' + create);
+            return () => {
+              cleanup++;
+              console.log('foo cleanup ' + cleanup);
+            };
+          });
+          return null;
+        }
+
+        const container = document.createElement('div');
+        const root = ReactDOMClient.createRoot(container);
+        await act(() => {
+          root.render(
+            <React.StrictMode>
+              <Foo />
+            </React.StrictMode>,
+          );
+        });
+        expect(create).toBe(__DEV__ ? 2 : 1);
+        expect(cleanup).toBe(__DEV__ ? 1 : 0);
+        expect(console.log).toBeCalledTimes(__DEV__ ? 3 : 1);
+        // Note: we should display the first log because otherwise
+        // there is a risk of suppressing warnings when they happen,
+        // and on the next render they'd get deduplicated and ignored.
+        expect(console.log).toBeCalledWith('foo create 1');
+        if (__DEV__) {
+          expect(console.log).toBeCalledWith('foo cleanup 1');
+        }
+      });
     } else {
       it('disable logs for class double render', async () => {
         let count = 0;
@@ -1530,6 +1566,39 @@ describe('context legacy', () => {
         // and on the next render they'd get deduplicated and ignored.
         expect(console.log).toBeCalledWith('foo 1');
       });
+
+      it('disable logs for effect double invoke', async () => {
+        let create = 0;
+        let cleanup = 0;
+        function Foo() {
+          React.useEffect(() => {
+            create++;
+            console.log('foo create ' + create);
+            return () => {
+              cleanup++;
+              console.log('foo cleanup ' + cleanup);
+            };
+          });
+          return null;
+        }
+
+        const container = document.createElement('div');
+        const root = ReactDOMClient.createRoot(container);
+        await act(() => {
+          root.render(
+            <React.StrictMode>
+              <Foo />
+            </React.StrictMode>,
+          );
+        });
+        expect(create).toBe(__DEV__ ? 2 : 1);
+        expect(cleanup).toBe(__DEV__ ? 1 : 0);
+        expect(console.log).toBeCalledTimes(1);
+        // Note: we should display the first log because otherwise
+        // there is a risk of suppressing warnings when they happen,
+        // and on the next render they'd get deduplicated and ignored.
+        expect(console.log).toBeCalledWith('foo create 1');
+      });
     }
   });
 });

commit d172bdaf95b0be869f7d36b87c95a5f12b229195
Author: Rick Hanlon <rickhanlonii@gmail.com>
Date:   Mon Jun 10 14:31:37 2024 -0400

    Add jest lint rules (#29760)
    
    ## Overview
    
    Updates `eslint-plugin-jest` and enables the recommended rules with some
    turned off that are unhelpful.
    
    The main motivations is:
    a) we have a few duplicated tests, which this found an I deleted
    b) making sure we don't accidentally commit skipped tests

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index d9d6815b88..c36cdf15ed 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -438,7 +438,7 @@ describe('ReactStrictMode', () => {
   });
 
   // @gate debugRenderPhaseSideEffectsForStrictMode
-  it('double invokes useMemo functions', async () => {
+  it('double invokes useMemo functions with first result', async () => {
     let log = [];
     function Uppercased({text}) {
       const memoizedResult = useMemo(() => {
@@ -1008,45 +1008,6 @@ describe('string refs', () => {
       root.render(<OuterComponent />);
     });
   });
-
-  // @gate !disableStringRefs
-  it('should warn within a strict tree', async () => {
-    const {StrictMode} = React;
-
-    class OuterComponent extends React.Component {
-      render() {
-        return (
-          <StrictMode>
-            <InnerComponent ref="somestring" />
-          </StrictMode>
-        );
-      }
-    }
-
-    class InnerComponent extends React.Component {
-      render() {
-        return null;
-      }
-    }
-
-    const container = document.createElement('div');
-    const root = ReactDOMClient.createRoot(container);
-    await expect(async () => {
-      await act(() => {
-        root.render(<OuterComponent />);
-      });
-    }).toErrorDev(
-      'Warning: Component "OuterComponent" contains the string ref "somestring". ' +
-        'Support for string refs will be removed in a future major release. ' +
-        'We recommend using useRef() or createRef() instead. ' +
-        'Learn more about using refs safely here: https://react.dev/link/strict-mode-string-ref\n' +
-        '    in InnerComponent (at **)',
-    );
-
-    await act(() => {
-      root.render(<OuterComponent />);
-    });
-  });
 });
 
 describe('context legacy', () => {

commit 277420803947724b43c47bbc47d3a353553868f1
Author: Sebastian Markbåge <sebastian@calyptus.eu>
Date:   Mon Jun 10 18:41:56 2024 -0400

    Remove Warning: prefix and toString on console Arguments (#29839)
    
    Basically make `console.error` and `console.warn` behave like normal -
    when a component stack isn't appended. I need this because I need to be
    able to print rich logs with the component stack option and to be able
    to disable instrumentation completely in `console.createTask`
    environments that don't need it.
    
    Currently we can't print logs with richer objects because they're
    toString:ed first. In practice, pretty much all arguments we log are
    already toString:ed so it's not necessary anyway. Some might be like a
    number. So it would only be a problem if some environment can't handle
    proper consoles but then it's up to that environment to toString it
    before logging.
    
    The `Warning: ` prefix is historic and is both noisy and confusing. It's
    mostly unnecessary since the UI surrounding `console.error` and
    `console.warn` tend to have visual treatment around it anyway. However,
    it's actively misleading when `console.error` gets prefixed with a
    Warning that we consider an error level. There's an argument to be made
    that some of our `console.error` don't make the bar for an error but
    then the argument is to downgrade each of those to `console.warn` - not
    to brand all our actual error logging with `Warning: `.
    
    Apparently something needs to change in React Native before landing this
    because it depends on the prefix somehow which probably doesn't make
    sense already.

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index c36cdf15ed..201eff9c41 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -626,18 +626,18 @@ describe('Concurrent Mode', () => {
     ).toErrorDev(
       [
         /* eslint-disable max-len */
-        `Warning: Using UNSAFE_componentWillMount in strict mode is not recommended and may indicate bugs in your code. See https://react.dev/link/unsafe-component-lifecycles for details.
+        `Using UNSAFE_componentWillMount in strict mode is not recommended and may indicate bugs in your code. See https://react.dev/link/unsafe-component-lifecycles for details.
 
 * Move code with side effects to componentDidMount, and set initial state in the constructor.
 
 Please update the following components: App`,
-        `Warning: Using UNSAFE_componentWillReceiveProps in strict mode is not recommended and may indicate bugs in your code. See https://react.dev/link/unsafe-component-lifecycles for details.
+        `Using UNSAFE_componentWillReceiveProps in strict mode is not recommended and may indicate bugs in your code. See https://react.dev/link/unsafe-component-lifecycles for details.
 
 * Move data fetching code or side effects to componentDidUpdate.
 * If you're updating state whenever props change, refactor your code to use memoization techniques or move it to static getDerivedStateFromProps. Learn more at: https://react.dev/link/derived-state
 
 Please update the following components: Bar, Foo`,
-        `Warning: Using UNSAFE_componentWillUpdate in strict mode is not recommended and may indicate bugs in your code. See https://react.dev/link/unsafe-component-lifecycles for details.
+        `Using UNSAFE_componentWillUpdate in strict mode is not recommended and may indicate bugs in your code. See https://react.dev/link/unsafe-component-lifecycles for details.
 
 * Move data fetching code or side effects to componentDidUpdate.
 
@@ -690,18 +690,18 @@ Please update the following components: App`,
       ).toErrorDev(
         [
           /* eslint-disable max-len */
-          `Warning: Using UNSAFE_componentWillMount in strict mode is not recommended and may indicate bugs in your code. See https://react.dev/link/unsafe-component-lifecycles for details.
+          `Using UNSAFE_componentWillMount in strict mode is not recommended and may indicate bugs in your code. See https://react.dev/link/unsafe-component-lifecycles for details.
 
 * Move code with side effects to componentDidMount, and set initial state in the constructor.
 
 Please update the following components: App`,
-          `Warning: Using UNSAFE_componentWillReceiveProps in strict mode is not recommended and may indicate bugs in your code. See https://react.dev/link/unsafe-component-lifecycles for details.
+          `Using UNSAFE_componentWillReceiveProps in strict mode is not recommended and may indicate bugs in your code. See https://react.dev/link/unsafe-component-lifecycles for details.
 
 * Move data fetching code or side effects to componentDidUpdate.
 * If you're updating state whenever props change, refactor your code to use memoization techniques or move it to static getDerivedStateFromProps. Learn more at: https://react.dev/link/derived-state
 
 Please update the following components: Child`,
-          `Warning: Using UNSAFE_componentWillUpdate in strict mode is not recommended and may indicate bugs in your code. See https://react.dev/link/unsafe-component-lifecycles for details.
+          `Using UNSAFE_componentWillUpdate in strict mode is not recommended and may indicate bugs in your code. See https://react.dev/link/unsafe-component-lifecycles for details.
 
 * Move data fetching code or side effects to componentDidUpdate.
 
@@ -713,20 +713,20 @@ Please update the following components: App`,
     }).toWarnDev(
       [
         /* eslint-disable max-len */
-        `Warning: componentWillMount has been renamed, and is not recommended for use. See https://react.dev/link/unsafe-component-lifecycles for details.
+        `componentWillMount has been renamed, and is not recommended for use. See https://react.dev/link/unsafe-component-lifecycles for details.
 
 * Move code with side effects to componentDidMount, and set initial state in the constructor.
 * Rename componentWillMount to UNSAFE_componentWillMount to suppress this warning in non-strict mode. In React 18.x, only the UNSAFE_ name will work. To rename all deprecated lifecycles to their new names, you can run \`npx react-codemod rename-unsafe-lifecycles\` in your project source folder.
 
 Please update the following components: Parent`,
-        `Warning: componentWillReceiveProps has been renamed, and is not recommended for use. See https://react.dev/link/unsafe-component-lifecycles for details.
+        `componentWillReceiveProps has been renamed, and is not recommended for use. See https://react.dev/link/unsafe-component-lifecycles for details.
 
 * Move data fetching code or side effects to componentDidUpdate.
 * If you're updating state whenever props change, refactor your code to use memoization techniques or move it to static getDerivedStateFromProps. Learn more at: https://react.dev/link/derived-state
 * Rename componentWillReceiveProps to UNSAFE_componentWillReceiveProps to suppress this warning in non-strict mode. In React 18.x, only the UNSAFE_ name will work. To rename all deprecated lifecycles to their new names, you can run \`npx react-codemod rename-unsafe-lifecycles\` in your project source folder.
 
 Please update the following components: Parent`,
-        `Warning: componentWillUpdate has been renamed, and is not recommended for use. See https://react.dev/link/unsafe-component-lifecycles for details.
+        `componentWillUpdate has been renamed, and is not recommended for use. See https://react.dev/link/unsafe-component-lifecycles for details.
 
 * Move data fetching code or side effects to componentDidUpdate.
 * Rename componentWillUpdate to UNSAFE_componentWillUpdate to suppress this warning in non-strict mode. In React 18.x, only the UNSAFE_ name will work. To rename all deprecated lifecycles to their new names, you can run \`npx react-codemod rename-unsafe-lifecycles\` in your project source folder.
@@ -997,7 +997,7 @@ describe('string refs', () => {
         root.render(<OuterComponent />);
       });
     }).toErrorDev(
-      'Warning: Component "OuterComponent" contains the string ref "somestring". ' +
+      'Component "OuterComponent" contains the string ref "somestring". ' +
         'Support for string refs will be removed in a future major release. ' +
         'We recommend using useRef() or createRef() instead. ' +
         'Learn more about using refs safely here: https://react.dev/link/strict-mode-string-ref\n' +
@@ -1083,7 +1083,7 @@ describe('context legacy', () => {
         root.render(<Root />);
       });
     }).toErrorDev(
-      'Warning: Legacy context API has been detected within a strict-mode tree.' +
+      'Legacy context API has been detected within a strict-mode tree.' +
         '\n\nThe old API will be supported in all 16.x releases, but applications ' +
         'using it should migrate to the new version.' +
         '\n\nPlease update the following components: ' +

commit b565373afd0cc1988497e1107106e851e8cfb261
Author: Jan Kassens <jkassens@meta.com>
Date:   Fri Jun 21 12:24:32 2024 -0400

    lint: enable reportUnusedDisableDirectives and remove unused suppressions (#28721)
    
    This enables linting against unused suppressions and removes the ones
    that were unused.

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index 201eff9c41..6a887fc9d9 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -625,7 +625,6 @@ describe('Concurrent Mode', () => {
       async () => await act(() => root.render(<StrictRoot />)),
     ).toErrorDev(
       [
-        /* eslint-disable max-len */
         `Using UNSAFE_componentWillMount in strict mode is not recommended and may indicate bugs in your code. See https://react.dev/link/unsafe-component-lifecycles for details.
 
 * Move code with side effects to componentDidMount, and set initial state in the constructor.
@@ -642,7 +641,6 @@ Please update the following components: Bar, Foo`,
 * Move data fetching code or side effects to componentDidUpdate.
 
 Please update the following components: App`,
-        /* eslint-enable max-len */
       ],
       {withoutStack: true},
     );
@@ -689,7 +687,6 @@ Please update the following components: App`,
         async () => await act(() => root.render(<StrictRoot />)),
       ).toErrorDev(
         [
-          /* eslint-disable max-len */
           `Using UNSAFE_componentWillMount in strict mode is not recommended and may indicate bugs in your code. See https://react.dev/link/unsafe-component-lifecycles for details.
 
 * Move code with side effects to componentDidMount, and set initial state in the constructor.
@@ -706,13 +703,11 @@ Please update the following components: Child`,
 * Move data fetching code or side effects to componentDidUpdate.
 
 Please update the following components: App`,
-          /* eslint-enable max-len */
         ],
         {withoutStack: true},
       );
     }).toWarnDev(
       [
-        /* eslint-disable max-len */
         `componentWillMount has been renamed, and is not recommended for use. See https://react.dev/link/unsafe-component-lifecycles for details.
 
 * Move code with side effects to componentDidMount, and set initial state in the constructor.
@@ -732,7 +727,6 @@ Please update the following components: Parent`,
 * Rename componentWillUpdate to UNSAFE_componentWillUpdate to suppress this warning in non-strict mode. In React 18.x, only the UNSAFE_ name will work. To rename all deprecated lifecycles to their new names, you can run \`npx react-codemod rename-unsafe-lifecycles\` in your project source folder.
 
 Please update the following components: Parent`,
-        /* eslint-enable max-len */
       ],
       {withoutStack: true},
     );

commit 378b305958eb7259cacfce8ad0e66eec07e07074
Author: Jan Kassens <jkassens@meta.com>
Date:   Wed Jul 10 11:53:00 2024 -0400

    Warn about legacy context when legacy context is not disabled (#30297)
    
    For environments that still have legacy contexts available, this adds a
    warning to make the remaining call sites easier to locate and encourage
    upgrades.

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index 6a887fc9d9..2ab9c3fa18 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -18,6 +18,7 @@ let act;
 let useMemo;
 let useState;
 let useReducer;
+let assertConsoleErrorDev;
 
 const ReactFeatureFlags = require('shared/ReactFeatureFlags');
 
@@ -28,7 +29,7 @@ describe('ReactStrictMode', () => {
     ReactDOM = require('react-dom');
     ReactDOMClient = require('react-dom/client');
     ReactDOMServer = require('react-dom/server');
-    act = require('internal-test-utils').act;
+    ({act, assertConsoleErrorDev} = require('internal-test-utils'));
     useMemo = React.useMemo;
     useState = React.useState;
     useReducer = React.useReducer;
@@ -1072,11 +1073,33 @@ describe('context legacy', () => {
 
     const container = document.createElement('div');
     const root = ReactDOMClient.createRoot(container);
-    await expect(async () => {
-      await act(() => {
-        root.render(<Root />);
-      });
-    }).toErrorDev(
+    await act(() => {
+      root.render(<Root />);
+    });
+
+    assertConsoleErrorDev([
+      'LegacyContextProvider uses the legacy childContextTypes API ' +
+        'which will soon be removed. Use React.createContext() instead. ' +
+        '(https://react.dev/link/legacy-context)' +
+        '\n    in LegacyContextProvider (at **)' +
+        '\n    in div (at **)' +
+        '\n    in Root (at **)',
+      'LegacyContextConsumer uses the legacy contextTypes API which ' +
+        'will soon be removed. Use React.createContext() with static ' +
+        'contextType instead. (https://react.dev/link/legacy-context)' +
+        '\n    in LegacyContextConsumer (at **)' +
+        '\n    in div (at **)' +
+        '\n    in LegacyContextProvider (at **)' +
+        '\n    in div (at **)' +
+        '\n    in Root (at **)',
+      'FunctionalLegacyContextConsumer uses the legacy contextTypes ' +
+        'API which will be removed soon. Use React.createContext() ' +
+        'with React.useContext() instead. (https://react.dev/link/legacy-context)' +
+        '\n    in FunctionalLegacyContextConsumer (at **)' +
+        '\n    in div (at **)' +
+        '\n    in LegacyContextProvider (at **)' +
+        '\n    in div (at **)' +
+        '\n    in Root (at **)',
       'Legacy context API has been detected within a strict-mode tree.' +
         '\n\nThe old API will be supported in all 16.x releases, but applications ' +
         'using it should migrate to the new version.' +
@@ -1087,7 +1110,7 @@ describe('context legacy', () => {
         '\n    in LegacyContextProvider (at **)' +
         '\n    in div (at **)' +
         '\n    in Root (at **)',
-    );
+    ]);
 
     // Dedupe
     await act(() => {

commit e1378902bbb322aa1fe1953780f4b2b5f80d26b1
Author: Jan Kassens <jkassens@meta.com>
Date:   Wed Nov 6 14:00:10 2024 -0500

    [string-refs] cleanup string ref code (#31443)

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index 2ab9c3fa18..97fcc1ec8c 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -956,55 +956,6 @@ describe('symbol checks', () => {
   });
 });
 
-describe('string refs', () => {
-  beforeEach(() => {
-    jest.resetModules();
-    React = require('react');
-    ReactDOM = require('react-dom');
-    ReactDOMClient = require('react-dom/client');
-    act = require('internal-test-utils').act;
-  });
-
-  // @gate !disableStringRefs
-  it('should warn within a strict tree', async () => {
-    const {StrictMode} = React;
-
-    class OuterComponent extends React.Component {
-      render() {
-        return (
-          <StrictMode>
-            <InnerComponent ref="somestring" />
-          </StrictMode>
-        );
-      }
-    }
-
-    class InnerComponent extends React.Component {
-      render() {
-        return null;
-      }
-    }
-
-    const container = document.createElement('div');
-    const root = ReactDOMClient.createRoot(container);
-    await expect(async () => {
-      await act(() => {
-        root.render(<OuterComponent />);
-      });
-    }).toErrorDev(
-      'Component "OuterComponent" contains the string ref "somestring". ' +
-        'Support for string refs will be removed in a future major release. ' +
-        'We recommend using useRef() or createRef() instead. ' +
-        'Learn more about using refs safely here: https://react.dev/link/strict-mode-string-ref\n' +
-        '    in InnerComponent (at **)',
-    );
-
-    await act(() => {
-      root.render(<OuterComponent />);
-    });
-  });
-});
-
 describe('context legacy', () => {
   beforeEach(() => {
     jest.resetModules();

commit a4964987dc140526702e996223fe7ee293def8ac
Author: Noah Lemen <noahlemen@meta.com>
Date:   Wed Dec 11 12:00:25 2024 -0500

    Make enableOwnerStacks dynamic (#31661)
    
    following up on https://github.com/facebook/react/pull/31287, fixing
    tests
    
    ---------
    
    Co-authored-by: Rick Hanlon <rickhanlonii@fb.com>

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index 97fcc1ec8c..db60674ba6 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -1028,40 +1028,67 @@ describe('context legacy', () => {
       root.render(<Root />);
     });
 
-    assertConsoleErrorDev([
-      'LegacyContextProvider uses the legacy childContextTypes API ' +
-        'which will soon be removed. Use React.createContext() instead. ' +
-        '(https://react.dev/link/legacy-context)' +
-        '\n    in LegacyContextProvider (at **)' +
-        '\n    in div (at **)' +
-        '\n    in Root (at **)',
-      'LegacyContextConsumer uses the legacy contextTypes API which ' +
-        'will soon be removed. Use React.createContext() with static ' +
-        'contextType instead. (https://react.dev/link/legacy-context)' +
-        '\n    in LegacyContextConsumer (at **)' +
-        '\n    in div (at **)' +
-        '\n    in LegacyContextProvider (at **)' +
-        '\n    in div (at **)' +
-        '\n    in Root (at **)',
-      'FunctionalLegacyContextConsumer uses the legacy contextTypes ' +
-        'API which will be removed soon. Use React.createContext() ' +
-        'with React.useContext() instead. (https://react.dev/link/legacy-context)' +
-        '\n    in FunctionalLegacyContextConsumer (at **)' +
-        '\n    in div (at **)' +
-        '\n    in LegacyContextProvider (at **)' +
-        '\n    in div (at **)' +
-        '\n    in Root (at **)',
-      'Legacy context API has been detected within a strict-mode tree.' +
-        '\n\nThe old API will be supported in all 16.x releases, but applications ' +
-        'using it should migrate to the new version.' +
-        '\n\nPlease update the following components: ' +
-        'FunctionalLegacyContextConsumer, LegacyContextConsumer, LegacyContextProvider' +
-        '\n\nLearn more about this warning here: ' +
-        'https://react.dev/link/legacy-context' +
-        '\n    in LegacyContextProvider (at **)' +
-        '\n    in div (at **)' +
-        '\n    in Root (at **)',
-    ]);
+    if (gate(flags => flags.enableOwnerStacks)) {
+      assertConsoleErrorDev([
+        'LegacyContextProvider uses the legacy childContextTypes API ' +
+          'which will soon be removed. Use React.createContext() instead. ' +
+          '(https://react.dev/link/legacy-context)' +
+          '\n    in Root (at **)',
+        'LegacyContextConsumer uses the legacy contextTypes API which ' +
+          'will soon be removed. Use React.createContext() with static ' +
+          'contextType instead. (https://react.dev/link/legacy-context)' +
+          '\n    in LegacyContextProvider (at **)' +
+          '\n    in Root (at **)',
+        'FunctionalLegacyContextConsumer uses the legacy contextTypes ' +
+          'API which will be removed soon. Use React.createContext() ' +
+          'with React.useContext() instead. (https://react.dev/link/legacy-context)' +
+          '\n    in LegacyContextProvider (at **)' +
+          '\n    in Root (at **)',
+        'Legacy context API has been detected within a strict-mode tree.' +
+          '\n\nThe old API will be supported in all 16.x releases, but applications ' +
+          'using it should migrate to the new version.' +
+          '\n\nPlease update the following components: ' +
+          'FunctionalLegacyContextConsumer, LegacyContextConsumer, LegacyContextProvider' +
+          '\n\nLearn more about this warning here: ' +
+          'https://react.dev/link/legacy-context' +
+          '\n    in Root (at **)',
+      ]);
+    } else {
+      assertConsoleErrorDev([
+        'LegacyContextProvider uses the legacy childContextTypes API ' +
+          'which will soon be removed. Use React.createContext() instead. ' +
+          '(https://react.dev/link/legacy-context)' +
+          '\n    in LegacyContextProvider (at **)' +
+          '\n    in div (at **)' +
+          '\n    in Root (at **)',
+        'LegacyContextConsumer uses the legacy contextTypes API which ' +
+          'will soon be removed. Use React.createContext() with static ' +
+          'contextType instead. (https://react.dev/link/legacy-context)' +
+          '\n    in LegacyContextConsumer (at **)' +
+          '\n    in div (at **)' +
+          '\n    in LegacyContextProvider (at **)' +
+          '\n    in div (at **)' +
+          '\n    in Root (at **)',
+        'FunctionalLegacyContextConsumer uses the legacy contextTypes ' +
+          'API which will be removed soon. Use React.createContext() ' +
+          'with React.useContext() instead. (https://react.dev/link/legacy-context)' +
+          '\n    in FunctionalLegacyContextConsumer (at **)' +
+          '\n    in div (at **)' +
+          '\n    in LegacyContextProvider (at **)' +
+          '\n    in div (at **)' +
+          '\n    in Root (at **)',
+        'Legacy context API has been detected within a strict-mode tree.' +
+          '\n\nThe old API will be supported in all 16.x releases, but applications ' +
+          'using it should migrate to the new version.' +
+          '\n\nPlease update the following components: ' +
+          'FunctionalLegacyContextConsumer, LegacyContextConsumer, LegacyContextProvider' +
+          '\n\nLearn more about this warning here: ' +
+          'https://react.dev/link/legacy-context' +
+          '\n    in LegacyContextProvider (at **)' +
+          '\n    in div (at **)' +
+          '\n    in Root (at **)',
+      ]);
+    }
 
     // Dedupe
     await act(() => {

commit 4dff0e62b2320d8c97746a16c95efd9c9ad0bc07
Author: Rick Hanlon <rickhanlonii@gmail.com>
Date:   Fri Dec 13 11:05:10 2024 -0500

    Remove consoleManagedByDevToolsDuringStrictMode (#31755)
    
    This is enabled everywhere except the test renderers, which don't use
    it.

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index db60674ba6..863f84ebdb 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -20,8 +20,6 @@ let useState;
 let useReducer;
 let assertConsoleErrorDev;
 
-const ReactFeatureFlags = require('shared/ReactFeatureFlags');
-
 describe('ReactStrictMode', () => {
   beforeEach(() => {
     jest.resetModules();
@@ -1111,450 +1109,228 @@ describe('context legacy', () => {
       console.log.mockRestore();
     });
 
-    if (ReactFeatureFlags.consoleManagedByDevToolsDuringStrictMode) {
-      it('does not disable logs for class double render', async () => {
-        let count = 0;
-        class Foo extends React.Component {
-          render() {
-            count++;
-            console.log('foo ' + count);
-            return null;
-          }
+    it('does not disable logs for class double render', async () => {
+      let count = 0;
+      class Foo extends React.Component {
+        render() {
+          count++;
+          console.log('foo ' + count);
+          return null;
         }
+      }
 
-        const container = document.createElement('div');
-        const root = ReactDOMClient.createRoot(container);
-        await act(() => {
-          root.render(
-            <React.StrictMode>
-              <Foo />
-            </React.StrictMode>,
-          );
-        });
-        expect(count).toBe(__DEV__ ? 2 : 1);
-        expect(console.log).toBeCalledTimes(__DEV__ ? 2 : 1);
-        // Note: we should display the first log because otherwise
-        // there is a risk of suppressing warnings when they happen,
-        // and on the next render they'd get deduplicated and ignored.
-        expect(console.log).toBeCalledWith('foo 1');
+      const container = document.createElement('div');
+      const root = ReactDOMClient.createRoot(container);
+      await act(() => {
+        root.render(
+          <React.StrictMode>
+            <Foo />
+          </React.StrictMode>,
+        );
       });
+      expect(count).toBe(__DEV__ ? 2 : 1);
+      expect(console.log).toBeCalledTimes(__DEV__ ? 2 : 1);
+      // Note: we should display the first log because otherwise
+      // there is a risk of suppressing warnings when they happen,
+      // and on the next render they'd get deduplicated and ignored.
+      expect(console.log).toBeCalledWith('foo 1');
+    });
 
-      it('does not disable logs for class double ctor', async () => {
-        let count = 0;
-        class Foo extends React.Component {
-          constructor(props) {
-            super(props);
-            count++;
-            console.log('foo ' + count);
-          }
-          render() {
-            return null;
-          }
+    it('does not disable logs for class double ctor', async () => {
+      let count = 0;
+      class Foo extends React.Component {
+        constructor(props) {
+          super(props);
+          count++;
+          console.log('foo ' + count);
         }
-
-        const container = document.createElement('div');
-        const root = ReactDOMClient.createRoot(container);
-        await act(() => {
-          root.render(
-            <React.StrictMode>
-              <Foo />
-            </React.StrictMode>,
-          );
-        });
-        expect(count).toBe(__DEV__ ? 2 : 1);
-        expect(console.log).toBeCalledTimes(__DEV__ ? 2 : 1);
-        // Note: we should display the first log because otherwise
-        // there is a risk of suppressing warnings when they happen,
-        // and on the next render they'd get deduplicated and ignored.
-        expect(console.log).toBeCalledWith('foo 1');
-      });
-
-      it('does not disable logs for class double getDerivedStateFromProps', async () => {
-        let count = 0;
-        class Foo extends React.Component {
-          state = {};
-          static getDerivedStateFromProps() {
-            count++;
-            console.log('foo ' + count);
-            return {};
-          }
-          render() {
-            return null;
-          }
+        render() {
+          return null;
         }
+      }
 
-        const container = document.createElement('div');
-        const root = ReactDOMClient.createRoot(container);
-        await act(() => {
-          root.render(
-            <React.StrictMode>
-              <Foo />
-            </React.StrictMode>,
-          );
-        });
-        expect(count).toBe(__DEV__ ? 2 : 1);
-        expect(console.log).toBeCalledTimes(__DEV__ ? 2 : 1);
-        // Note: we should display the first log because otherwise
-        // there is a risk of suppressing warnings when they happen,
-        // and on the next render they'd get deduplicated and ignored.
-        expect(console.log).toBeCalledWith('foo 1');
+      const container = document.createElement('div');
+      const root = ReactDOMClient.createRoot(container);
+      await act(() => {
+        root.render(
+          <React.StrictMode>
+            <Foo />
+          </React.StrictMode>,
+        );
       });
+      expect(count).toBe(__DEV__ ? 2 : 1);
+      expect(console.log).toBeCalledTimes(__DEV__ ? 2 : 1);
+      // Note: we should display the first log because otherwise
+      // there is a risk of suppressing warnings when they happen,
+      // and on the next render they'd get deduplicated and ignored.
+      expect(console.log).toBeCalledWith('foo 1');
+    });
 
-      it('does not disable logs for class double shouldComponentUpdate', async () => {
-        let count = 0;
-        class Foo extends React.Component {
-          state = {};
-          shouldComponentUpdate() {
-            count++;
-            console.log('foo ' + count);
-            return {};
-          }
-          render() {
-            return null;
-          }
+    it('does not disable logs for class double getDerivedStateFromProps', async () => {
+      let count = 0;
+      class Foo extends React.Component {
+        state = {};
+        static getDerivedStateFromProps() {
+          count++;
+          console.log('foo ' + count);
+          return {};
         }
-
-        const container = document.createElement('div');
-        const root = ReactDOMClient.createRoot(container);
-        await act(() => {
-          root.render(
-            <React.StrictMode>
-              <Foo />
-            </React.StrictMode>,
-          );
-        });
-        await act(() => {
-          root.render(
-            <React.StrictMode>
-              <Foo />
-            </React.StrictMode>,
-          );
-        });
-
-        expect(count).toBe(__DEV__ ? 2 : 1);
-        expect(console.log).toBeCalledTimes(__DEV__ ? 2 : 1);
-        // Note: we should display the first log because otherwise
-        // there is a risk of suppressing warnings when they happen,
-        // and on the next render they'd get deduplicated and ignored.
-        expect(console.log).toBeCalledWith('foo 1');
-      });
-
-      it('does not disable logs for class state updaters', async () => {
-        let inst;
-        let count = 0;
-        class Foo extends React.Component {
-          state = {};
-          render() {
-            inst = this;
-            return null;
-          }
+        render() {
+          return null;
         }
+      }
 
-        const container = document.createElement('div');
-        const root = ReactDOMClient.createRoot(container);
-        await act(() => {
-          root.render(
-            <React.StrictMode>
-              <Foo />
-            </React.StrictMode>,
-          );
-        });
-        await act(() => {
-          inst.setState(() => {
-            count++;
-            console.log('foo ' + count);
-            return {};
-          });
-        });
-
-        expect(count).toBe(__DEV__ ? 2 : 1);
-        expect(console.log).toBeCalledTimes(__DEV__ ? 2 : 1);
-        // Note: we should display the first log because otherwise
-        // there is a risk of suppressing warnings when they happen,
-        // and on the next render they'd get deduplicated and ignored.
-        expect(console.log).toBeCalledWith('foo 1');
+      const container = document.createElement('div');
+      const root = ReactDOMClient.createRoot(container);
+      await act(() => {
+        root.render(
+          <React.StrictMode>
+            <Foo />
+          </React.StrictMode>,
+        );
       });
+      expect(count).toBe(__DEV__ ? 2 : 1);
+      expect(console.log).toBeCalledTimes(__DEV__ ? 2 : 1);
+      // Note: we should display the first log because otherwise
+      // there is a risk of suppressing warnings when they happen,
+      // and on the next render they'd get deduplicated and ignored.
+      expect(console.log).toBeCalledWith('foo 1');
+    });
 
-      it('does not disable logs for function double render', async () => {
-        let count = 0;
-        function Foo() {
+    it('does not disable logs for class double shouldComponentUpdate', async () => {
+      let count = 0;
+      class Foo extends React.Component {
+        state = {};
+        shouldComponentUpdate() {
           count++;
           console.log('foo ' + count);
-          return null;
+          return {};
         }
-
-        const container = document.createElement('div');
-        const root = ReactDOMClient.createRoot(container);
-        await act(() => {
-          root.render(
-            <React.StrictMode>
-              <Foo />
-            </React.StrictMode>,
-          );
-        });
-        expect(count).toBe(__DEV__ ? 2 : 1);
-        expect(console.log).toBeCalledTimes(__DEV__ ? 2 : 1);
-        // Note: we should display the first log because otherwise
-        // there is a risk of suppressing warnings when they happen,
-        // and on the next render they'd get deduplicated and ignored.
-        expect(console.log).toBeCalledWith('foo 1');
-      });
-
-      it('does not disable logs for effect double invoke', async () => {
-        let create = 0;
-        let cleanup = 0;
-        function Foo() {
-          React.useEffect(() => {
-            create++;
-            console.log('foo create ' + create);
-            return () => {
-              cleanup++;
-              console.log('foo cleanup ' + cleanup);
-            };
-          });
+        render() {
           return null;
         }
+      }
 
-        const container = document.createElement('div');
-        const root = ReactDOMClient.createRoot(container);
-        await act(() => {
-          root.render(
-            <React.StrictMode>
-              <Foo />
-            </React.StrictMode>,
-          );
-        });
-        expect(create).toBe(__DEV__ ? 2 : 1);
-        expect(cleanup).toBe(__DEV__ ? 1 : 0);
-        expect(console.log).toBeCalledTimes(__DEV__ ? 3 : 1);
-        // Note: we should display the first log because otherwise
-        // there is a risk of suppressing warnings when they happen,
-        // and on the next render they'd get deduplicated and ignored.
-        expect(console.log).toBeCalledWith('foo create 1');
-        if (__DEV__) {
-          expect(console.log).toBeCalledWith('foo cleanup 1');
-        }
+      const container = document.createElement('div');
+      const root = ReactDOMClient.createRoot(container);
+      await act(() => {
+        root.render(
+          <React.StrictMode>
+            <Foo />
+          </React.StrictMode>,
+        );
       });
-    } else {
-      it('disable logs for class double render', async () => {
-        let count = 0;
-        class Foo extends React.Component {
-          render() {
-            count++;
-            console.log('foo ' + count);
-            return null;
-          }
-        }
-
-        const container = document.createElement('div');
-        const root = ReactDOMClient.createRoot(container);
-        await act(() => {
-          root.render(
-            <React.StrictMode>
-              <Foo />
-            </React.StrictMode>,
-          );
-        });
-        expect(count).toBe(__DEV__ ? 2 : 1);
-        expect(console.log).toBeCalledTimes(1);
-        // Note: we should display the first log because otherwise
-        // there is a risk of suppressing warnings when they happen,
-        // and on the next render they'd get deduplicated and ignored.
-        expect(console.log).toBeCalledWith('foo 1');
+      await act(() => {
+        root.render(
+          <React.StrictMode>
+            <Foo />
+          </React.StrictMode>,
+        );
       });
 
-      it('disables logs for class double ctor', async () => {
-        let count = 0;
-        class Foo extends React.Component {
-          constructor(props) {
-            super(props);
-            count++;
-            console.log('foo ' + count);
-          }
-          render() {
-            return null;
-          }
-        }
-
-        const container = document.createElement('div');
-        const root = ReactDOMClient.createRoot(container);
-        await act(() => {
-          root.render(
-            <React.StrictMode>
-              <Foo />
-            </React.StrictMode>,
-          );
-        });
-        expect(count).toBe(__DEV__ ? 2 : 1);
-        expect(console.log).toBeCalledTimes(1);
-        // Note: we should display the first log because otherwise
-        // there is a risk of suppressing warnings when they happen,
-        // and on the next render they'd get deduplicated and ignored.
-        expect(console.log).toBeCalledWith('foo 1');
-      });
+      expect(count).toBe(__DEV__ ? 2 : 1);
+      expect(console.log).toBeCalledTimes(__DEV__ ? 2 : 1);
+      // Note: we should display the first log because otherwise
+      // there is a risk of suppressing warnings when they happen,
+      // and on the next render they'd get deduplicated and ignored.
+      expect(console.log).toBeCalledWith('foo 1');
+    });
 
-      it('disable logs for class double getDerivedStateFromProps', async () => {
-        let count = 0;
-        class Foo extends React.Component {
-          state = {};
-          static getDerivedStateFromProps() {
-            count++;
-            console.log('foo ' + count);
-            return {};
-          }
-          render() {
-            return null;
-          }
+    it('does not disable logs for class state updaters', async () => {
+      let inst;
+      let count = 0;
+      class Foo extends React.Component {
+        state = {};
+        render() {
+          inst = this;
+          return null;
         }
+      }
 
-        const container = document.createElement('div');
-        const root = ReactDOMClient.createRoot(container);
-        await act(() => {
-          root.render(
-            <React.StrictMode>
-              <Foo />
-            </React.StrictMode>,
-          );
-        });
-        expect(count).toBe(__DEV__ ? 2 : 1);
-        expect(console.log).toBeCalledTimes(1);
-        // Note: we should display the first log because otherwise
-        // there is a risk of suppressing warnings when they happen,
-        // and on the next render they'd get deduplicated and ignored.
-        expect(console.log).toBeCalledWith('foo 1');
+      const container = document.createElement('div');
+      const root = ReactDOMClient.createRoot(container);
+      await act(() => {
+        root.render(
+          <React.StrictMode>
+            <Foo />
+          </React.StrictMode>,
+        );
       });
-
-      it('disable logs for class double shouldComponentUpdate', async () => {
-        let count = 0;
-        class Foo extends React.Component {
-          state = {};
-          shouldComponentUpdate() {
-            count++;
-            console.log('foo ' + count);
-            return {};
-          }
-          render() {
-            return null;
-          }
-        }
-
-        const container = document.createElement('div');
-        const root = ReactDOMClient.createRoot(container);
-        await act(() => {
-          root.render(
-            <React.StrictMode>
-              <Foo />
-            </React.StrictMode>,
-          );
-        });
-        await act(() => {
-          root.render(
-            <React.StrictMode>
-              <Foo />
-            </React.StrictMode>,
-          );
+      await act(() => {
+        inst.setState(() => {
+          count++;
+          console.log('foo ' + count);
+          return {};
         });
-        expect(count).toBe(__DEV__ ? 2 : 1);
-        expect(console.log).toBeCalledTimes(1);
-        // Note: we should display the first log because otherwise
-        // there is a risk of suppressing warnings when they happen,
-        // and on the next render they'd get deduplicated and ignored.
-        expect(console.log).toBeCalledWith('foo 1');
       });
 
-      it('disable logs for class state updaters', async () => {
-        let inst;
-        let count = 0;
-        class Foo extends React.Component {
-          state = {};
-          render() {
-            inst = this;
-            return null;
-          }
-        }
+      expect(count).toBe(__DEV__ ? 2 : 1);
+      expect(console.log).toBeCalledTimes(__DEV__ ? 2 : 1);
+      // Note: we should display the first log because otherwise
+      // there is a risk of suppressing warnings when they happen,
+      // and on the next render they'd get deduplicated and ignored.
+      expect(console.log).toBeCalledWith('foo 1');
+    });
 
-        const container = document.createElement('div');
-        const root = ReactDOMClient.createRoot(container);
-        await act(() => {
-          root.render(
-            <React.StrictMode>
-              <Foo />
-            </React.StrictMode>,
-          );
-        });
-        await act(() => {
-          inst.setState(() => {
-            count++;
-            console.log('foo ' + count);
-            return {};
-          });
-        });
+    it('does not disable logs for function double render', async () => {
+      let count = 0;
+      function Foo() {
+        count++;
+        console.log('foo ' + count);
+        return null;
+      }
 
-        expect(count).toBe(__DEV__ ? 2 : 1);
-        expect(console.log).toBeCalledTimes(1);
-        // Note: we should display the first log because otherwise
-        // there is a risk of suppressing warnings when they happen,
-        // and on the next render they'd get deduplicated and ignored.
-        expect(console.log).toBeCalledWith('foo 1');
+      const container = document.createElement('div');
+      const root = ReactDOMClient.createRoot(container);
+      await act(() => {
+        root.render(
+          <React.StrictMode>
+            <Foo />
+          </React.StrictMode>,
+        );
       });
+      expect(count).toBe(__DEV__ ? 2 : 1);
+      expect(console.log).toBeCalledTimes(__DEV__ ? 2 : 1);
+      // Note: we should display the first log because otherwise
+      // there is a risk of suppressing warnings when they happen,
+      // and on the next render they'd get deduplicated and ignored.
+      expect(console.log).toBeCalledWith('foo 1');
+    });
 
-      it('disable logs for function double render', async () => {
-        let count = 0;
-        function Foo() {
-          count++;
-          console.log('foo ' + count);
-          return null;
-        }
-
-        const container = document.createElement('div');
-        const root = ReactDOMClient.createRoot(container);
-        await act(() => {
-          root.render(
-            <React.StrictMode>
-              <Foo />
-            </React.StrictMode>,
-          );
+    it('does not disable logs for effect double invoke', async () => {
+      let create = 0;
+      let cleanup = 0;
+      function Foo() {
+        React.useEffect(() => {
+          create++;
+          console.log('foo create ' + create);
+          return () => {
+            cleanup++;
+            console.log('foo cleanup ' + cleanup);
+          };
         });
-        expect(count).toBe(__DEV__ ? 2 : 1);
-        expect(console.log).toBeCalledTimes(1);
-        // Note: we should display the first log because otherwise
-        // there is a risk of suppressing warnings when they happen,
-        // and on the next render they'd get deduplicated and ignored.
-        expect(console.log).toBeCalledWith('foo 1');
-      });
-
-      it('disable logs for effect double invoke', async () => {
-        let create = 0;
-        let cleanup = 0;
-        function Foo() {
-          React.useEffect(() => {
-            create++;
-            console.log('foo create ' + create);
-            return () => {
-              cleanup++;
-              console.log('foo cleanup ' + cleanup);
-            };
-          });
-          return null;
-        }
+        return null;
+      }
 
-        const container = document.createElement('div');
-        const root = ReactDOMClient.createRoot(container);
-        await act(() => {
-          root.render(
-            <React.StrictMode>
-              <Foo />
-            </React.StrictMode>,
-          );
-        });
-        expect(create).toBe(__DEV__ ? 2 : 1);
-        expect(cleanup).toBe(__DEV__ ? 1 : 0);
-        expect(console.log).toBeCalledTimes(1);
-        // Note: we should display the first log because otherwise
-        // there is a risk of suppressing warnings when they happen,
-        // and on the next render they'd get deduplicated and ignored.
-        expect(console.log).toBeCalledWith('foo create 1');
+      const container = document.createElement('div');
+      const root = ReactDOMClient.createRoot(container);
+      await act(() => {
+        root.render(
+          <React.StrictMode>
+            <Foo />
+          </React.StrictMode>,
+        );
       });
-    }
+      expect(create).toBe(__DEV__ ? 2 : 1);
+      expect(cleanup).toBe(__DEV__ ? 1 : 0);
+      expect(console.log).toBeCalledTimes(__DEV__ ? 3 : 1);
+      // Note: we should display the first log because otherwise
+      // there is a risk of suppressing warnings when they happen,
+      // and on the next render they'd get deduplicated and ignored.
+      expect(console.log).toBeCalledWith('foo create 1');
+      if (__DEV__) {
+        expect(console.log).toBeCalledWith('foo cleanup 1');
+      }
+    });
   });
 });

commit faf6c4dfdcd3c9b3862af6a3afcb3d80abd407c0
Author: Rick Hanlon <rickhanlonii@gmail.com>
Date:   Wed Dec 18 17:51:12 2024 -0500

    [flags] Remove debugRenderPhaseSideEffectsForStrictMode (#31839)
    
    This is enabled everywhere, we can just use the inline `__DEV__` checks.

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index 863f84ebdb..f28c70a871 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -202,7 +202,7 @@ describe('ReactStrictMode', () => {
     expect(instance.state.count).toBe(2);
   });
 
-  // @gate debugRenderPhaseSideEffectsForStrictMode
+  // @gate __DEV__
   it('double invokes useState and useReducer initializers functions', async () => {
     const log = [];
 
@@ -390,7 +390,7 @@ describe('ReactStrictMode', () => {
     expect(instance.state.count).toBe(2);
   });
 
-  // @gate debugRenderPhaseSideEffectsForStrictMode
+  // @gate __DEV__
   it('double invokes useMemo functions', async () => {
     let log = [];
 
@@ -436,7 +436,7 @@ describe('ReactStrictMode', () => {
     ]);
   });
 
-  // @gate debugRenderPhaseSideEffectsForStrictMode
+  // @gate __DEV__
   it('double invokes useMemo functions with first result', async () => {
     let log = [];
     function Uppercased({text}) {
@@ -499,7 +499,7 @@ describe('ReactStrictMode', () => {
     expect(log[2]).toBe(log[3]);
   });
 
-  // @gate debugRenderPhaseSideEffectsForStrictMode
+  // @gate __DEV__
   it('double invokes setState updater functions', async () => {
     const log = [];
 
@@ -532,7 +532,7 @@ describe('ReactStrictMode', () => {
     expect(log).toEqual(['Compute count: 1', 'Compute count: 1']);
   });
 
-  // @gate debugRenderPhaseSideEffectsForStrictMode
+  // @gate __DEV__
   it('double invokes reducer functions', async () => {
     const log = [];
 

commit 94867f33be327a52bfffda89a14c85897180e43e
Author: Rick Hanlon <rickhanlonii@gmail.com>
Date:   Mon Dec 23 14:58:20 2024 -0500

    [asserts helpers] react package (#31853)
    
    Based off https://github.com/facebook/react/pull/31844
    
    Commit to review:
    https://github.com/facebook/react/commit/11aa104e3e70c0accc21f785060b812beb145089
    
    Converts the rest of the `react` package.

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index f28c70a871..6d44a28881 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -19,6 +19,7 @@ let useMemo;
 let useState;
 let useReducer;
 let assertConsoleErrorDev;
+let assertConsoleWarnDev;
 
 describe('ReactStrictMode', () => {
   beforeEach(() => {
@@ -27,7 +28,11 @@ describe('ReactStrictMode', () => {
     ReactDOM = require('react-dom');
     ReactDOMClient = require('react-dom/client');
     ReactDOMServer = require('react-dom/server');
-    ({act, assertConsoleErrorDev} = require('internal-test-utils'));
+    ({
+      act,
+      assertConsoleErrorDev,
+      assertConsoleWarnDev,
+    } = require('internal-test-utils'));
     useMemo = React.useMemo;
     useState = React.useState;
     useReducer = React.useReducer;
@@ -40,20 +45,19 @@ describe('ReactStrictMode', () => {
 
     const container = document.createElement('div');
     const root = ReactDOMClient.createRoot(container);
-    await expect(async () => {
-      await act(() => {
-        root.render(
-          <React.StrictMode>
-            <Foo />
-          </React.StrictMode>,
-        );
-      });
-    }).toErrorDev(
+    await act(() => {
+      root.render(
+        <React.StrictMode>
+          <Foo />
+        </React.StrictMode>,
+      );
+    });
+    assertConsoleErrorDev([
       'Invalid ARIA attribute `ariaTypo`. ' +
         'ARIA attributes follow the pattern aria-* and must be lowercase.\n' +
         '    in div (at **)\n' +
         '    in Foo (at **)',
-    );
+    ]);
   });
 
   it('should appear in the SSR component stack', () => {
@@ -61,18 +65,17 @@ describe('ReactStrictMode', () => {
       return <div ariaTypo="" />;
     }
 
-    expect(() => {
-      ReactDOMServer.renderToString(
-        <React.StrictMode>
-          <Foo />
-        </React.StrictMode>,
-      );
-    }).toErrorDev(
+    ReactDOMServer.renderToString(
+      <React.StrictMode>
+        <Foo />
+      </React.StrictMode>,
+    );
+    assertConsoleErrorDev([
       'Invalid ARIA attribute `ariaTypo`. ' +
         'ARIA attributes follow the pattern aria-* and must be lowercase.\n' +
         '    in div (at **)\n' +
         '    in Foo (at **)',
-    );
+    ]);
   });
 
   // @gate __DEV__
@@ -620,9 +623,8 @@ describe('Concurrent Mode', () => {
 
     const container = document.createElement('div');
     const root = ReactDOMClient.createRoot(container);
-    await expect(
-      async () => await act(() => root.render(<StrictRoot />)),
-    ).toErrorDev(
+    await act(() => root.render(<StrictRoot />));
+    assertConsoleErrorDev(
       [
         `Using UNSAFE_componentWillMount in strict mode is not recommended and may indicate bugs in your code. See https://react.dev/link/unsafe-component-lifecycles for details.
 
@@ -681,31 +683,29 @@ Please update the following components: App`,
     const container = document.createElement('div');
     const root = ReactDOMClient.createRoot(container);
 
-    await expect(async () => {
-      await expect(
-        async () => await act(() => root.render(<StrictRoot />)),
-      ).toErrorDev(
-        [
-          `Using UNSAFE_componentWillMount in strict mode is not recommended and may indicate bugs in your code. See https://react.dev/link/unsafe-component-lifecycles for details.
+    await act(() => root.render(<StrictRoot />));
+    assertConsoleErrorDev(
+      [
+        `Using UNSAFE_componentWillMount in strict mode is not recommended and may indicate bugs in your code. See https://react.dev/link/unsafe-component-lifecycles for details.
 
 * Move code with side effects to componentDidMount, and set initial state in the constructor.
 
 Please update the following components: App`,
-          `Using UNSAFE_componentWillReceiveProps in strict mode is not recommended and may indicate bugs in your code. See https://react.dev/link/unsafe-component-lifecycles for details.
+        `Using UNSAFE_componentWillReceiveProps in strict mode is not recommended and may indicate bugs in your code. See https://react.dev/link/unsafe-component-lifecycles for details.
 
 * Move data fetching code or side effects to componentDidUpdate.
 * If you're updating state whenever props change, refactor your code to use memoization techniques or move it to static getDerivedStateFromProps. Learn more at: https://react.dev/link/derived-state
 
 Please update the following components: Child`,
-          `Using UNSAFE_componentWillUpdate in strict mode is not recommended and may indicate bugs in your code. See https://react.dev/link/unsafe-component-lifecycles for details.
+        `Using UNSAFE_componentWillUpdate in strict mode is not recommended and may indicate bugs in your code. See https://react.dev/link/unsafe-component-lifecycles for details.
 
 * Move data fetching code or side effects to componentDidUpdate.
 
 Please update the following components: App`,
-        ],
-        {withoutStack: true},
-      );
-    }).toWarnDev(
+      ],
+      {withoutStack: true},
+    );
+    assertConsoleWarnDev(
       [
         `componentWillMount has been renamed, and is not recommended for use. See https://react.dev/link/unsafe-component-lifecycles for details.
 
@@ -752,17 +752,25 @@ Please update the following components: Parent`,
 
     const container = document.createElement('div');
     const root = ReactDOMClient.createRoot(container);
-    await expect(async () => {
-      await act(() => root.render(<StrictRoot foo={true} />));
-    }).toErrorDev(
-      'Using UNSAFE_componentWillMount in strict mode is not recommended',
+    await act(() => root.render(<StrictRoot foo={true} />));
+    assertConsoleErrorDev(
+      [
+        'Using UNSAFE_componentWillMount in strict mode is not recommended and may indicate bugs in your code. ' +
+          'See https://react.dev/link/unsafe-component-lifecycles for details.\n\n' +
+          '* Move code with side effects to componentDidMount, and set initial state in the constructor.\n\n' +
+          'Please update the following components: Foo',
+      ],
       {withoutStack: true},
     );
 
-    await expect(async () => {
-      await act(() => root.render(<StrictRoot foo={false} />));
-    }).toErrorDev(
-      'Using UNSAFE_componentWillMount in strict mode is not recommended',
+    await act(() => root.render(<StrictRoot foo={false} />));
+    assertConsoleErrorDev(
+      [
+        'Using UNSAFE_componentWillMount in strict mode is not recommended and may indicate bugs in your code. ' +
+          'See https://react.dev/link/unsafe-component-lifecycles for details.\n\n' +
+          '* Move code with side effects to componentDidMount, and set initial state in the constructor.\n\n' +
+          'Please update the following components: Bar',
+      ],
       {withoutStack: true},
     );
 
@@ -810,12 +818,20 @@ Please update the following components: Parent`,
     const container = document.createElement('div');
 
     const root = ReactDOMClient.createRoot(container);
-    await expect(async () => {
-      await act(() => {
-        root.render(<SyncRoot />);
-      });
-    }).toErrorDev(
-      'Using UNSAFE_componentWillReceiveProps in strict mode is not recommended',
+    await act(() => {
+      root.render(<SyncRoot />);
+    });
+    assertConsoleErrorDev(
+      [
+        'Using UNSAFE_componentWillReceiveProps in strict mode is not recommended ' +
+          'and may indicate bugs in your code. ' +
+          'See https://react.dev/link/unsafe-component-lifecycles for details.\n\n' +
+          '* Move data fetching code or side effects to componentDidUpdate.\n' +
+          "* If you're updating state whenever props change, " +
+          'refactor your code to use memoization techniques or move it to ' +
+          'static getDerivedStateFromProps. Learn more at: https://react.dev/link/derived-state\n\n' +
+          'Please update the following components: Bar, Foo',
+      ],
       {withoutStack: true},
     );
 

commit e0fe3479671555e01531dbc3d2fd85d5bd4c5a56
Author: Rick Hanlon <rickhanlonii@gmail.com>
Date:   Tue Mar 4 12:34:34 2025 -0500

    [flags] remove enableOwnerStacks (#32426)
    
    Bassed off: https://github.com/facebook/react/pull/32425
    
    Wait to land internally.
    
    [Commit to
    review.](https://github.com/facebook/react/pull/32426/commits/66aa6a4dbb78106b4f3d3eb367f5c27eb8f30c66)
    
    This has landed everywhere

diff --git a/packages/react/src/__tests__/ReactStrictMode-test.js b/packages/react/src/__tests__/ReactStrictMode-test.js
index 6d44a28881..04046d8897 100644
--- a/packages/react/src/__tests__/ReactStrictMode-test.js
+++ b/packages/react/src/__tests__/ReactStrictMode-test.js
@@ -1042,67 +1042,30 @@ describe('context legacy', () => {
       root.render(<Root />);
     });
 
-    if (gate(flags => flags.enableOwnerStacks)) {
-      assertConsoleErrorDev([
-        'LegacyContextProvider uses the legacy childContextTypes API ' +
-          'which will soon be removed. Use React.createContext() instead. ' +
-          '(https://react.dev/link/legacy-context)' +
-          '\n    in Root (at **)',
-        'LegacyContextConsumer uses the legacy contextTypes API which ' +
-          'will soon be removed. Use React.createContext() with static ' +
-          'contextType instead. (https://react.dev/link/legacy-context)' +
-          '\n    in LegacyContextProvider (at **)' +
-          '\n    in Root (at **)',
-        'FunctionalLegacyContextConsumer uses the legacy contextTypes ' +
-          'API which will be removed soon. Use React.createContext() ' +
-          'with React.useContext() instead. (https://react.dev/link/legacy-context)' +
-          '\n    in LegacyContextProvider (at **)' +
-          '\n    in Root (at **)',
-        'Legacy context API has been detected within a strict-mode tree.' +
-          '\n\nThe old API will be supported in all 16.x releases, but applications ' +
-          'using it should migrate to the new version.' +
-          '\n\nPlease update the following components: ' +
-          'FunctionalLegacyContextConsumer, LegacyContextConsumer, LegacyContextProvider' +
-          '\n\nLearn more about this warning here: ' +
-          'https://react.dev/link/legacy-context' +
-          '\n    in Root (at **)',
-      ]);
-    } else {
-      assertConsoleErrorDev([
-        'LegacyContextProvider uses the legacy childContextTypes API ' +
-          'which will soon be removed. Use React.createContext() instead. ' +
-          '(https://react.dev/link/legacy-context)' +
-          '\n    in LegacyContextProvider (at **)' +
-          '\n    in div (at **)' +
-          '\n    in Root (at **)',
-        'LegacyContextConsumer uses the legacy contextTypes API which ' +
-          'will soon be removed. Use React.createContext() with static ' +
-          'contextType instead. (https://react.dev/link/legacy-context)' +
-          '\n    in LegacyContextConsumer (at **)' +
-          '\n    in div (at **)' +
-          '\n    in LegacyContextProvider (at **)' +
-          '\n    in div (at **)' +
-          '\n    in Root (at **)',
-        'FunctionalLegacyContextConsumer uses the legacy contextTypes ' +
-          'API which will be removed soon. Use React.createContext() ' +
-          'with React.useContext() instead. (https://react.dev/link/legacy-context)' +
-          '\n    in FunctionalLegacyContextConsumer (at **)' +
-          '\n    in div (at **)' +
-          '\n    in LegacyContextProvider (at **)' +
-          '\n    in div (at **)' +
-          '\n    in Root (at **)',
-        'Legacy context API has been detected within a strict-mode tree.' +
-          '\n\nThe old API will be supported in all 16.x releases, but applications ' +
-          'using it should migrate to the new version.' +
-          '\n\nPlease update the following components: ' +
-          'FunctionalLegacyContextConsumer, LegacyContextConsumer, LegacyContextProvider' +
-          '\n\nLearn more about this warning here: ' +
-          'https://react.dev/link/legacy-context' +
-          '\n    in LegacyContextProvider (at **)' +
-          '\n    in div (at **)' +
-          '\n    in Root (at **)',
-      ]);
-    }
+    assertConsoleErrorDev([
+      'LegacyContextProvider uses the legacy childContextTypes API ' +
+        'which will soon be removed. Use React.createContext() instead. ' +
+        '(https://react.dev/link/legacy-context)' +
+        '\n    in Root (at **)',
+      'LegacyContextConsumer uses the legacy contextTypes API which ' +
+        'will soon be removed. Use React.createContext() with static ' +
+        'contextType instead. (https://react.dev/link/legacy-context)' +
+        '\n    in LegacyContextProvider (at **)' +
+        '\n    in Root (at **)',
+      'FunctionalLegacyContextConsumer uses the legacy contextTypes ' +
+        'API which will be removed soon. Use React.createContext() ' +
+        'with React.useContext() instead. (https://react.dev/link/legacy-context)' +
+        '\n    in LegacyContextProvider (at **)' +
+        '\n    in Root (at **)',
+      'Legacy context API has been detected within a strict-mode tree.' +
+        '\n\nThe old API will be supported in all 16.x releases, but applications ' +
+        'using it should migrate to the new version.' +
+        '\n\nPlease update the following components: ' +
+        'FunctionalLegacyContextConsumer, LegacyContextConsumer, LegacyContextProvider' +
+        '\n\nLearn more about this warning here: ' +
+        'https://react.dev/link/legacy-context' +
+        '\n    in Root (at **)',
+    ]);
 
     // Dedupe
     await act(() => {

