# Instructions

You are being benchmarked. You will see the output of a git log command, and from that must infer the current state of a file. Think carefully, as you must output the exact state of the file to earn full marks.

**Important:** Your goal is to reproduce the file's content *exactly* as it exists at the final commit, even if the code appears broken, buggy, or contains obvious errors. Do **not** try to "fix" the code. Attempting to correct issues will result in a poor score, as this benchmark evaluates your ability to reproduce the precise state of the file based on its history.

# Required Response Format

Wrap the content of the file in triple backticks (```). Any text outside the final closing backticks will be ignored. End your response after outputting the closing backticks.

# Example Response

```python
#!/usr/bin/env python
print('Hello, world!')
```

# File History

> git log -p --cc --topo-order --reverse -- pkg/freetype/build.zig

commit f2d65d4524b60188ef1a7759c31741032453a283
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Wed Aug 17 11:20:31 2022 -0700

    move freetype into pkg

diff --git a/pkg/freetype/build.zig b/pkg/freetype/build.zig
new file mode 100644
index 00000000..348a405c
--- /dev/null
+++ b/pkg/freetype/build.zig
@@ -0,0 +1,109 @@
+const std = @import("std");
+
+/// Directories with our includes.
+const root = thisDir() ++ "../../../vendor/freetype/";
+const include_path = root ++ "include";
+const include_path_self = thisDir();
+
+pub const pkg = std.build.Pkg{
+    .name = "freetype",
+    .source = .{ .path = thisDir() ++ "/main.zig" },
+};
+
+fn thisDir() []const u8 {
+    return std.fs.path.dirname(@src().file) orelse ".";
+}
+
+pub fn link(b: *std.build.Builder, step: *std.build.LibExeObjStep) !void {
+    const lib = try buildFreetype(b, step);
+    step.linkLibrary(lib);
+    step.addIncludePath(include_path);
+    step.addIncludePath(include_path_self);
+}
+
+pub fn buildFreetype(
+    b: *std.build.Builder,
+    step: *std.build.LibExeObjStep,
+) !*std.build.LibExeObjStep {
+    const target = step.target;
+    const lib = b.addStaticLibrary("freetype", null);
+    lib.setTarget(step.target);
+    lib.setBuildMode(step.build_mode);
+
+    // Include
+    lib.addIncludePath(include_path);
+
+    // Link
+    lib.linkLibC();
+
+    // Compile
+    var flags = std.ArrayList([]const u8).init(b.allocator);
+    defer flags.deinit();
+
+    try flags.appendSlice(&.{
+        "-DFT2_BUILD_LIBRARY",
+
+        "-DHAVE_UNISTD_H",
+        "-DHAVE_FCNTL_H",
+    });
+
+    // C files
+    lib.addCSourceFiles(srcs, flags.items);
+    switch (target.getOsTag()) {
+        .linux => lib.addCSourceFile(root ++ "builds/unix/ftsystem.c", flags.items),
+        .windows => lib.addCSourceFile(root ++ "builds/windows/ftsystem.c", flags.items),
+        else => lib.addCSourceFile(root ++ "src/base/ftsystem.c", flags.items),
+    }
+    switch (target.getOsTag()) {
+        .windows => {
+            lib.addCSourceFile(root ++ "builds/windows/ftdebug.c", flags.items);
+            lib.addCSourceFile(root ++ "src/base/ftver.c", flags.items);
+        },
+        else => lib.addCSourceFile(root ++ "src/base/ftdebug.c", flags.items),
+    }
+
+    return lib;
+}
+
+const srcs = &.{
+    root ++ "src/autofit/autofit.c",
+    root ++ "src/base/ftbase.c",
+    root ++ "src/base/ftbbox.c",
+    root ++ "src/base/ftbdf.c",
+    root ++ "src/base/ftbitmap.c",
+    root ++ "src/base/ftcid.c",
+    root ++ "src/base/ftfstype.c",
+    root ++ "src/base/ftgasp.c",
+    root ++ "src/base/ftglyph.c",
+    root ++ "src/base/ftgxval.c",
+    root ++ "src/base/ftinit.c",
+    root ++ "src/base/ftmm.c",
+    root ++ "src/base/ftotval.c",
+    root ++ "src/base/ftpatent.c",
+    root ++ "src/base/ftpfr.c",
+    root ++ "src/base/ftstroke.c",
+    root ++ "src/base/ftsynth.c",
+    root ++ "src/base/fttype1.c",
+    root ++ "src/base/ftwinfnt.c",
+    root ++ "src/bdf/bdf.c",
+    root ++ "src/bzip2/ftbzip2.c",
+    root ++ "src/cache/ftcache.c",
+    root ++ "src/cff/cff.c",
+    root ++ "src/cid/type1cid.c",
+    root ++ "src/gzip/ftgzip.c",
+    root ++ "src/lzw/ftlzw.c",
+    root ++ "src/pcf/pcf.c",
+    root ++ "src/pfr/pfr.c",
+    root ++ "src/psaux/psaux.c",
+    root ++ "src/pshinter/pshinter.c",
+    root ++ "src/psnames/psnames.c",
+    root ++ "src/raster/raster.c",
+    root ++ "src/sdf/sdf.c",
+    root ++ "src/sfnt/sfnt.c",
+    root ++ "src/smooth/smooth.c",
+    root ++ "src/svg/svg.c",
+    root ++ "src/truetype/truetype.c",
+    root ++ "src/type1/type1.c",
+    root ++ "src/type42/type42.c",
+    root ++ "src/winfonts/winfnt.c",
+};

commit 08292e58f3456609f9c64bcc310a56a82cd6d86b
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Wed Aug 17 14:53:34 2022 -0700

    add system SDK to build to enable cross compilation

diff --git a/pkg/freetype/build.zig b/pkg/freetype/build.zig
index 348a405c..7c152d5c 100644
--- a/pkg/freetype/build.zig
+++ b/pkg/freetype/build.zig
@@ -14,11 +14,12 @@ fn thisDir() []const u8 {
     return std.fs.path.dirname(@src().file) orelse ".";
 }
 
-pub fn link(b: *std.build.Builder, step: *std.build.LibExeObjStep) !void {
+pub fn link(b: *std.build.Builder, step: *std.build.LibExeObjStep) !*std.build.LibExeObjStep {
     const lib = try buildFreetype(b, step);
     step.linkLibrary(lib);
     step.addIncludePath(include_path);
     step.addIncludePath(include_path_self);
+    return lib;
 }
 
 pub fn buildFreetype(

commit 728df4af1660a8488a960a94a4704782d1930baf
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sat Aug 20 10:24:49 2022 -0700

    build libpng and link freetype to it

diff --git a/pkg/freetype/build.zig b/pkg/freetype/build.zig
index 7c152d5c..4a407ea7 100644
--- a/pkg/freetype/build.zig
+++ b/pkg/freetype/build.zig
@@ -14,8 +14,22 @@ fn thisDir() []const u8 {
     return std.fs.path.dirname(@src().file) orelse ".";
 }
 
-pub fn link(b: *std.build.Builder, step: *std.build.LibExeObjStep) !*std.build.LibExeObjStep {
-    const lib = try buildFreetype(b, step);
+pub const Options = struct {
+    libpng: Libpng = .{},
+
+    pub const Libpng = struct {
+        enabled: bool = false,
+        step: ?*std.build.LibExeObjStep = null,
+        include: ?[]const u8 = null,
+    };
+};
+
+pub fn link(
+    b: *std.build.Builder,
+    step: *std.build.LibExeObjStep,
+    opt: Options,
+) !*std.build.LibExeObjStep {
+    const lib = try buildFreetype(b, step, opt);
     step.linkLibrary(lib);
     step.addIncludePath(include_path);
     step.addIncludePath(include_path_self);
@@ -25,6 +39,7 @@ pub fn link(b: *std.build.Builder, step: *std.build.LibExeObjStep) !*std.build.L
 pub fn buildFreetype(
     b: *std.build.Builder,
     step: *std.build.LibExeObjStep,
+    opt: Options,
 ) !*std.build.LibExeObjStep {
     const target = step.target;
     const lib = b.addStaticLibrary("freetype", null);
@@ -36,6 +51,15 @@ pub fn buildFreetype(
 
     // Link
     lib.linkLibC();
+    if (opt.libpng.enabled) {
+        if (opt.libpng.step) |libpng|
+            lib.linkLibrary(libpng)
+        else
+            lib.linkSystemLibrary("libpng");
+
+        if (opt.libpng.include) |dir|
+            lib.addIncludePath(dir);
+    }
 
     // Compile
     var flags = std.ArrayList([]const u8).init(b.allocator);
@@ -47,6 +71,7 @@ pub fn buildFreetype(
         "-DHAVE_UNISTD_H",
         "-DHAVE_FCNTL_H",
     });
+    if (opt.libpng.enabled) try flags.append("-DFT_CONFIG_OPTION_USE_PNG");
 
     // C files
     lib.addCSourceFiles(srcs, flags.items);

commit 5ae450099d1802800d25339ef07e149b0be5f88e
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sat Aug 20 10:33:57 2022 -0700

    freetype builds in png support, uses our own zlib

diff --git a/pkg/freetype/build.zig b/pkg/freetype/build.zig
index 4a407ea7..b85bf4a7 100644
--- a/pkg/freetype/build.zig
+++ b/pkg/freetype/build.zig
@@ -16,11 +16,18 @@ fn thisDir() []const u8 {
 
 pub const Options = struct {
     libpng: Libpng = .{},
+    zlib: Zlib = .{},
 
     pub const Libpng = struct {
         enabled: bool = false,
         step: ?*std.build.LibExeObjStep = null,
-        include: ?[]const u8 = null,
+        include: ?[]const []const u8 = null,
+    };
+
+    pub const Zlib = struct {
+        enabled: bool = false,
+        step: ?*std.build.LibExeObjStep = null,
+        include: ?[]const []const u8 = null,
     };
 };
 
@@ -57,8 +64,17 @@ pub fn buildFreetype(
         else
             lib.linkSystemLibrary("libpng");
 
-        if (opt.libpng.include) |dir|
-            lib.addIncludePath(dir);
+        if (opt.libpng.include) |dirs|
+            for (dirs) |dir| lib.addIncludePath(dir);
+    }
+    if (opt.zlib.enabled) {
+        if (opt.zlib.step) |zlib|
+            lib.linkLibrary(zlib)
+        else
+            lib.linkSystemLibrary("z");
+
+        if (opt.zlib.include) |dirs|
+            for (dirs) |dir| lib.addIncludePath(dir);
     }
 
     // Compile
@@ -71,7 +87,8 @@ pub fn buildFreetype(
         "-DHAVE_UNISTD_H",
         "-DHAVE_FCNTL_H",
     });
-    if (opt.libpng.enabled) try flags.append("-DFT_CONFIG_OPTION_USE_PNG");
+    if (opt.libpng.enabled) try flags.append("-DFT_CONFIG_OPTION_USE_PNG=1");
+    if (opt.zlib.enabled) try flags.append("-DFT_CONFIG_OPTION_SYSTEM_ZLIB=1");
 
     // C files
     lib.addCSourceFiles(srcs, flags.items);

commit ecf8353c7441b9b0b573592389ca4dacd3e9e1fb
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sat Aug 20 14:53:53 2022 -0700

    support dynamic linking (not default) test in GH actions

diff --git a/pkg/freetype/build.zig b/pkg/freetype/build.zig
index b85bf4a7..4e7816a5 100644
--- a/pkg/freetype/build.zig
+++ b/pkg/freetype/build.zig
@@ -3,7 +3,7 @@ const std = @import("std");
 /// Directories with our includes.
 const root = thisDir() ++ "../../../vendor/freetype/";
 const include_path = root ++ "include";
-const include_path_self = thisDir();
+pub const include_path_self = thisDir();
 
 pub const pkg = std.build.Pkg{
     .name = "freetype",

commit 367aba62c480dd9755690ba0de6b1154523bc3ef
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sun Aug 28 10:09:39 2022 -0700

    Add harfbuzz build (not used yet)

diff --git a/pkg/freetype/build.zig b/pkg/freetype/build.zig
index 4e7816a5..5c35ae9b 100644
--- a/pkg/freetype/build.zig
+++ b/pkg/freetype/build.zig
@@ -5,6 +5,8 @@ const root = thisDir() ++ "../../../vendor/freetype/";
 const include_path = root ++ "include";
 pub const include_path_self = thisDir();
 
+pub const include_paths = .{ include_path, include_path_self };
+
 pub const pkg = std.build.Pkg{
     .name = "freetype",
     .source = .{ .path = thisDir() ++ "/main.zig" },

commit b4d571e018c386ab9b91ce81e3f711650d842ae4
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Wed Sep 14 09:23:02 2022 -0700

    pkg/fontconfig: disable ubsan (reported upstream)

diff --git a/pkg/freetype/build.zig b/pkg/freetype/build.zig
index 5c35ae9b..c4cf4690 100644
--- a/pkg/freetype/build.zig
+++ b/pkg/freetype/build.zig
@@ -88,6 +88,8 @@ pub fn buildFreetype(
 
         "-DHAVE_UNISTD_H",
         "-DHAVE_FCNTL_H",
+
+        //"-fno-sanitize=undefined",
     });
     if (opt.libpng.enabled) try flags.append("-DFT_CONFIG_OPTION_USE_PNG=1");
     if (opt.zlib.enabled) try flags.append("-DFT_CONFIG_OPTION_SYSTEM_ZLIB=1");

commit fdbf40d3ee484527536a9adfd4c6470ba888d21c
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Thu Sep 29 11:39:09 2022 -0700

    pkg/freetype: disable ubsan

diff --git a/pkg/freetype/build.zig b/pkg/freetype/build.zig
index c4cf4690..04840624 100644
--- a/pkg/freetype/build.zig
+++ b/pkg/freetype/build.zig
@@ -89,7 +89,7 @@ pub fn buildFreetype(
         "-DHAVE_UNISTD_H",
         "-DHAVE_FCNTL_H",
 
-        //"-fno-sanitize=undefined",
+        "-fno-sanitize=undefined",
     });
     if (opt.libpng.enabled) try flags.append("-DFT_CONFIG_OPTION_USE_PNG=1");
     if (opt.zlib.enabled) try flags.append("-DFT_CONFIG_OPTION_SYSTEM_ZLIB=1");

commit be75109a1dcc2add39f9b868f67f620728986717
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Tue Feb 14 20:58:33 2023 -0800

    new build system

diff --git a/pkg/freetype/build.zig b/pkg/freetype/build.zig
index 04840624..6bc5a25b 100644
--- a/pkg/freetype/build.zig
+++ b/pkg/freetype/build.zig
@@ -7,10 +7,11 @@ pub const include_path_self = thisDir();
 
 pub const include_paths = .{ include_path, include_path_self };
 
-pub const pkg = std.build.Pkg{
-    .name = "freetype",
-    .source = .{ .path = thisDir() ++ "/main.zig" },
-};
+pub fn module(b: *std.Build) *std.build.Module {
+    return b.createModule(.{
+        .source_file = .{ .path = (comptime thisDir()) ++ "/main.zig" },
+    });
+}
 
 fn thisDir() []const u8 {
     return std.fs.path.dirname(@src().file) orelse ".";
@@ -34,7 +35,7 @@ pub const Options = struct {
 };
 
 pub fn link(
-    b: *std.build.Builder,
+    b: *std.Build,
     step: *std.build.LibExeObjStep,
     opt: Options,
 ) !*std.build.LibExeObjStep {
@@ -46,14 +47,16 @@ pub fn link(
 }
 
 pub fn buildFreetype(
-    b: *std.build.Builder,
+    b: *std.Build,
     step: *std.build.LibExeObjStep,
     opt: Options,
 ) !*std.build.LibExeObjStep {
     const target = step.target;
-    const lib = b.addStaticLibrary("freetype", null);
-    lib.setTarget(step.target);
-    lib.setBuildMode(step.build_mode);
+    const lib = b.addStaticLibrary(.{
+        .name = "freetype",
+        .target = target,
+        .optimize = step.optimize,
+    });
 
     // Include
     lib.addIncludePath(include_path);

commit d649b3f6d425e37ce521b7bec8c212d13c114f81
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Wed Aug 2 14:39:19 2023 -0700

    update zig

diff --git a/pkg/freetype/build.zig b/pkg/freetype/build.zig
index 6bc5a25b..add99b6f 100644
--- a/pkg/freetype/build.zig
+++ b/pkg/freetype/build.zig
@@ -41,8 +41,8 @@ pub fn link(
 ) !*std.build.LibExeObjStep {
     const lib = try buildFreetype(b, step, opt);
     step.linkLibrary(lib);
-    step.addIncludePath(include_path);
-    step.addIncludePath(include_path_self);
+    step.addIncludePath(.{ .path = include_path });
+    step.addIncludePath(.{ .path = include_path_self });
     return lib;
 }
 
@@ -59,7 +59,7 @@ pub fn buildFreetype(
     });
 
     // Include
-    lib.addIncludePath(include_path);
+    lib.addIncludePath(.{ .path = include_path });
 
     // Link
     lib.linkLibC();
@@ -70,7 +70,7 @@ pub fn buildFreetype(
             lib.linkSystemLibrary("libpng");
 
         if (opt.libpng.include) |dirs|
-            for (dirs) |dir| lib.addIncludePath(dir);
+            for (dirs) |dir| lib.addIncludePath(.{ .path = dir });
     }
     if (opt.zlib.enabled) {
         if (opt.zlib.step) |zlib|
@@ -79,7 +79,7 @@ pub fn buildFreetype(
             lib.linkSystemLibrary("z");
 
         if (opt.zlib.include) |dirs|
-            for (dirs) |dir| lib.addIncludePath(dir);
+            for (dirs) |dir| lib.addIncludePath(.{ .path = dir });
     }
 
     // Compile
@@ -100,16 +100,30 @@ pub fn buildFreetype(
     // C files
     lib.addCSourceFiles(srcs, flags.items);
     switch (target.getOsTag()) {
-        .linux => lib.addCSourceFile(root ++ "builds/unix/ftsystem.c", flags.items),
-        .windows => lib.addCSourceFile(root ++ "builds/windows/ftsystem.c", flags.items),
-        else => lib.addCSourceFile(root ++ "src/base/ftsystem.c", flags.items),
+        .linux => lib.addCSourceFile(.{
+            .file = .{ .path = root ++ "builds/unix/ftsystem.c" },
+            .flags = flags.items,
+        }),
+        .windows => lib.addCSourceFile(.{
+            .file = .{ .path = root ++ "builds/windows/ftsystem.c" },
+            .flags = flags.items,
+        }),
+        else => lib.addCSourceFile(.{
+            .file = .{ .path = root ++ "src/base/ftsystem.c" },
+            .flags = flags.items,
+        }),
     }
     switch (target.getOsTag()) {
         .windows => {
-            lib.addCSourceFile(root ++ "builds/windows/ftdebug.c", flags.items);
-            lib.addCSourceFile(root ++ "src/base/ftver.c", flags.items);
+            lib.addCSourceFiles(&.{
+                root ++ "builds/windows/ftdebug.c",
+                root ++ "src/base/ftver.c",
+            }, flags.items);
         },
-        else => lib.addCSourceFile(root ++ "src/base/ftdebug.c", flags.items),
+        else => lib.addCSourceFile(.{
+            .file = .{ .path = root ++ "src/base/ftdebug.c" },
+            .flags = flags.items,
+        }),
     }
 
     return lib;

commit a2e881ff4ef83792500bb4b985bb70063bb58ea8
Author: Jonathan Marler <johnnymarler@gmail.com>
Date:   Thu Sep 14 02:34:43 2023 -0600

    windows: initial support for zig build test
    
    Makes progress getting "zig build test" to work on windows.  Mostly
    fixed issues around build configuration and added some branches throughout
    the Zig code to return/throw errors for unimplemented parts.
    
    I also added an initial implementation for getting the home dir.

diff --git a/pkg/freetype/build.zig b/pkg/freetype/build.zig
index add99b6f..89534f10 100644
--- a/pkg/freetype/build.zig
+++ b/pkg/freetype/build.zig
@@ -117,7 +117,6 @@ pub fn buildFreetype(
         .windows => {
             lib.addCSourceFiles(&.{
                 root ++ "builds/windows/ftdebug.c",
-                root ++ "src/base/ftver.c",
             }, flags.items);
         },
         else => lib.addCSourceFile(.{

commit 7dc3fcc41e458bb23eadf401c3ba93018ab89e17
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sun Oct 1 12:12:05 2023 -0700

    pkg/freetype

diff --git a/pkg/freetype/build.zig b/pkg/freetype/build.zig
index 89534f10..ad4414ee 100644
--- a/pkg/freetype/build.zig
+++ b/pkg/freetype/build.zig
@@ -1,172 +1,129 @@
 const std = @import("std");
 
-/// Directories with our includes.
-const root = thisDir() ++ "../../../vendor/freetype/";
-const include_path = root ++ "include";
-pub const include_path_self = thisDir();
+pub fn build(b: *std.Build) !void {
+    const target = b.standardTargetOptions(.{});
+    const optimize = b.standardOptimizeOption(.{});
+    const libpng_enabled = b.option(bool, "enable-libpng", "Build libpng") orelse false;
 
-pub const include_paths = .{ include_path, include_path_self };
+    const upstream = b.dependency("freetype", .{});
 
-pub fn module(b: *std.Build) *std.build.Module {
-    return b.createModule(.{
-        .source_file = .{ .path = (comptime thisDir()) ++ "/main.zig" },
-    });
-}
-
-fn thisDir() []const u8 {
-    return std.fs.path.dirname(@src().file) orelse ".";
-}
-
-pub const Options = struct {
-    libpng: Libpng = .{},
-    zlib: Zlib = .{},
-
-    pub const Libpng = struct {
-        enabled: bool = false,
-        step: ?*std.build.LibExeObjStep = null,
-        include: ?[]const []const u8 = null,
-    };
-
-    pub const Zlib = struct {
-        enabled: bool = false,
-        step: ?*std.build.LibExeObjStep = null,
-        include: ?[]const []const u8 = null,
-    };
-};
-
-pub fn link(
-    b: *std.Build,
-    step: *std.build.LibExeObjStep,
-    opt: Options,
-) !*std.build.LibExeObjStep {
-    const lib = try buildFreetype(b, step, opt);
-    step.linkLibrary(lib);
-    step.addIncludePath(.{ .path = include_path });
-    step.addIncludePath(.{ .path = include_path_self });
-    return lib;
-}
-
-pub fn buildFreetype(
-    b: *std.Build,
-    step: *std.build.LibExeObjStep,
-    opt: Options,
-) !*std.build.LibExeObjStep {
-    const target = step.target;
     const lib = b.addStaticLibrary(.{
         .name = "freetype",
         .target = target,
-        .optimize = step.optimize,
+        .optimize = optimize,
     });
-
-    // Include
-    lib.addIncludePath(.{ .path = include_path });
-
-    // Link
     lib.linkLibC();
-    if (opt.libpng.enabled) {
-        if (opt.libpng.step) |libpng|
-            lib.linkLibrary(libpng)
-        else
-            lib.linkSystemLibrary("libpng");
-
-        if (opt.libpng.include) |dirs|
-            for (dirs) |dir| lib.addIncludePath(.{ .path = dir });
-    }
-    if (opt.zlib.enabled) {
-        if (opt.zlib.step) |zlib|
-            lib.linkLibrary(zlib)
-        else
-            lib.linkSystemLibrary("z");
-
-        if (opt.zlib.include) |dirs|
-            for (dirs) |dir| lib.addIncludePath(.{ .path = dir });
+    lib.addIncludePath(upstream.path("include"));
+
+    // Dependencies
+    const zlib_dep = b.dependency("zlib", .{ .target = target, .optimize = optimize });
+    lib.linkLibrary(zlib_dep.artifact("z"));
+    if (libpng_enabled) {
+        const libpng_dep = b.dependency("libpng", .{ .target = target, .optimize = optimize });
+        lib.linkLibrary(libpng_dep.artifact("png"));
     }
 
-    // Compile
     var flags = std.ArrayList([]const u8).init(b.allocator);
     defer flags.deinit();
-
     try flags.appendSlice(&.{
         "-DFT2_BUILD_LIBRARY",
 
+        "-DFT_CONFIG_OPTION_SYSTEM_ZLIB=1",
+
         "-DHAVE_UNISTD_H",
         "-DHAVE_FCNTL_H",
 
         "-fno-sanitize=undefined",
     });
-    if (opt.libpng.enabled) try flags.append("-DFT_CONFIG_OPTION_USE_PNG=1");
-    if (opt.zlib.enabled) try flags.append("-DFT_CONFIG_OPTION_SYSTEM_ZLIB=1");
+    if (libpng_enabled) try flags.append("-DFT_CONFIG_OPTION_USE_PNG=1");
+
+    for (srcs) |src| {
+        lib.addCSourceFile(.{
+            .file = upstream.path(src),
+            .flags = flags.items,
+        });
+    }
 
-    // C files
-    lib.addCSourceFiles(srcs, flags.items);
     switch (target.getOsTag()) {
         .linux => lib.addCSourceFile(.{
-            .file = .{ .path = root ++ "builds/unix/ftsystem.c" },
+            .file = upstream.path("builds/unix/ftsystem.c"),
             .flags = flags.items,
         }),
         .windows => lib.addCSourceFile(.{
-            .file = .{ .path = root ++ "builds/windows/ftsystem.c" },
+            .file = upstream.path("builds/windows/ftsystem.c"),
             .flags = flags.items,
         }),
         else => lib.addCSourceFile(.{
-            .file = .{ .path = root ++ "src/base/ftsystem.c" },
+            .file = upstream.path("src/base/ftsystem.c"),
             .flags = flags.items,
         }),
     }
     switch (target.getOsTag()) {
         .windows => {
-            lib.addCSourceFiles(&.{
-                root ++ "builds/windows/ftdebug.c",
-            }, flags.items);
+            lib.addCSourceFile(.{
+                .file = upstream.path("builds/windows/ftdebug.c"),
+                .flags = flags.items,
+            });
+            lib.addWin32ResourceFile(.{
+                .file = upstream.path("src/base/ftver.rc"),
+            });
         },
         else => lib.addCSourceFile(.{
-            .file = .{ .path = root ++ "src/base/ftdebug.c" },
+            .file = upstream.path("src/base/ftdebug.c"),
             .flags = flags.items,
         }),
     }
 
-    return lib;
+    lib.installHeader("freetype-zig.h", "freetype-zig.h");
+    lib.installHeadersDirectoryOptions(.{
+        .source_dir = upstream.path("include"),
+        .install_dir = .header,
+        .install_subdir = "",
+        .include_extensions = &.{".h"},
+    });
+
+    b.installArtifact(lib);
 }
 
-const srcs = &.{
-    root ++ "src/autofit/autofit.c",
-    root ++ "src/base/ftbase.c",
-    root ++ "src/base/ftbbox.c",
-    root ++ "src/base/ftbdf.c",
-    root ++ "src/base/ftbitmap.c",
-    root ++ "src/base/ftcid.c",
-    root ++ "src/base/ftfstype.c",
-    root ++ "src/base/ftgasp.c",
-    root ++ "src/base/ftglyph.c",
-    root ++ "src/base/ftgxval.c",
-    root ++ "src/base/ftinit.c",
-    root ++ "src/base/ftmm.c",
-    root ++ "src/base/ftotval.c",
-    root ++ "src/base/ftpatent.c",
-    root ++ "src/base/ftpfr.c",
-    root ++ "src/base/ftstroke.c",
-    root ++ "src/base/ftsynth.c",
-    root ++ "src/base/fttype1.c",
-    root ++ "src/base/ftwinfnt.c",
-    root ++ "src/bdf/bdf.c",
-    root ++ "src/bzip2/ftbzip2.c",
-    root ++ "src/cache/ftcache.c",
-    root ++ "src/cff/cff.c",
-    root ++ "src/cid/type1cid.c",
-    root ++ "src/gzip/ftgzip.c",
-    root ++ "src/lzw/ftlzw.c",
-    root ++ "src/pcf/pcf.c",
-    root ++ "src/pfr/pfr.c",
-    root ++ "src/psaux/psaux.c",
-    root ++ "src/pshinter/pshinter.c",
-    root ++ "src/psnames/psnames.c",
-    root ++ "src/raster/raster.c",
-    root ++ "src/sdf/sdf.c",
-    root ++ "src/sfnt/sfnt.c",
-    root ++ "src/smooth/smooth.c",
-    root ++ "src/svg/svg.c",
-    root ++ "src/truetype/truetype.c",
-    root ++ "src/type1/type1.c",
-    root ++ "src/type42/type42.c",
-    root ++ "src/winfonts/winfnt.c",
+const srcs: []const []const u8 = &.{
+    "src/autofit/autofit.c",
+    "src/base/ftbase.c",
+    "src/base/ftbbox.c",
+    "src/base/ftbdf.c",
+    "src/base/ftbitmap.c",
+    "src/base/ftcid.c",
+    "src/base/ftfstype.c",
+    "src/base/ftgasp.c",
+    "src/base/ftglyph.c",
+    "src/base/ftgxval.c",
+    "src/base/ftinit.c",
+    "src/base/ftmm.c",
+    "src/base/ftotval.c",
+    "src/base/ftpatent.c",
+    "src/base/ftpfr.c",
+    "src/base/ftstroke.c",
+    "src/base/ftsynth.c",
+    "src/base/fttype1.c",
+    "src/base/ftwinfnt.c",
+    "src/bdf/bdf.c",
+    "src/bzip2/ftbzip2.c",
+    "src/cache/ftcache.c",
+    "src/cff/cff.c",
+    "src/cid/type1cid.c",
+    "src/gzip/ftgzip.c",
+    "src/lzw/ftlzw.c",
+    "src/pcf/pcf.c",
+    "src/pfr/pfr.c",
+    "src/psaux/psaux.c",
+    "src/pshinter/pshinter.c",
+    "src/psnames/psnames.c",
+    "src/raster/raster.c",
+    "src/sdf/sdf.c",
+    "src/sfnt/sfnt.c",
+    "src/smooth/smooth.c",
+    "src/svg/svg.c",
+    "src/truetype/truetype.c",
+    "src/type1/type1.c",
+    "src/type42/type42.c",
+    "src/winfonts/winfnt.c",
 };

commit 2237b43df08f9c65bc12f7915b4db1e1b2ab8bb3
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sun Oct 1 16:57:45 2023 -0700

    pkg/freetype, harfbuzz modules

diff --git a/pkg/freetype/build.zig b/pkg/freetype/build.zig
index ad4414ee..fb31777b 100644
--- a/pkg/freetype/build.zig
+++ b/pkg/freetype/build.zig
@@ -5,8 +5,9 @@ pub fn build(b: *std.Build) !void {
     const optimize = b.standardOptimizeOption(.{});
     const libpng_enabled = b.option(bool, "enable-libpng", "Build libpng") orelse false;
 
-    const upstream = b.dependency("freetype", .{});
+    _ = b.addModule("freetype", .{ .source_file = .{ .path = "main.zig" } });
 
+    const upstream = b.dependency("freetype", .{});
     const lib = b.addStaticLibrary(.{
         .name = "freetype",
         .target = target,

commit 0021b290cf0961d3cd83c8dde9868fc85520a2f7
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sun Oct 1 18:43:25 2023 -0700

    pkg: add test targets

diff --git a/pkg/freetype/build.zig b/pkg/freetype/build.zig
index fb31777b..24006e17 100644
--- a/pkg/freetype/build.zig
+++ b/pkg/freetype/build.zig
@@ -84,6 +84,19 @@ pub fn build(b: *std.Build) !void {
     });
 
     b.installArtifact(lib);
+
+    {
+        const test_exe = b.addTest(.{
+            .name = "test",
+            .root_source_file = .{ .path = "main.zig" },
+            .target = target,
+            .optimize = optimize,
+        });
+        test_exe.linkLibrary(lib);
+        const tests_run = b.addRunArtifact(test_exe);
+        const test_step = b.step("test", "Run tests");
+        test_step.dependOn(&tests_run.step);
+    }
 }
 
 const srcs: []const []const u8 = &.{

commit 1913243c357a2ceb754756e3f7edde791f2150d9
Author: Krzysztof Wolicki <der.teufel.mail@gmail.com>
Date:   Wed Jan 3 21:50:32 2024 +0100

    WIP: Update to new build module API after Zig PR #18160
    Temporarily change dependency sources to forks until they update

diff --git a/pkg/freetype/build.zig b/pkg/freetype/build.zig
index 24006e17..24a2723d 100644
--- a/pkg/freetype/build.zig
+++ b/pkg/freetype/build.zig
@@ -5,7 +5,7 @@ pub fn build(b: *std.Build) !void {
     const optimize = b.standardOptimizeOption(.{});
     const libpng_enabled = b.option(bool, "enable-libpng", "Build libpng") orelse false;
 
-    _ = b.addModule("freetype", .{ .source_file = .{ .path = "main.zig" } });
+    _ = b.addModule("freetype", .{ .root_source_file = .{ .path = "main.zig" } });
 
     const upstream = b.dependency("freetype", .{});
     const lib = b.addStaticLibrary(.{
@@ -45,7 +45,7 @@ pub fn build(b: *std.Build) !void {
         });
     }
 
-    switch (target.getOsTag()) {
+    switch (target.result.os.tag) {
         .linux => lib.addCSourceFile(.{
             .file = upstream.path("builds/unix/ftsystem.c"),
             .flags = flags.items,
@@ -59,7 +59,7 @@ pub fn build(b: *std.Build) !void {
             .flags = flags.items,
         }),
     }
-    switch (target.getOsTag()) {
+    switch (target.result.os.tag) {
         .windows => {
             lib.addCSourceFile(.{
                 .file = upstream.path("builds/windows/ftdebug.c"),

commit 6c7c5eecce9c3ee34fd2287ca6272da556497d1d
Author: Krzysztof Wolicki <der.teufel.mail@gmail.com>
Date:   Sun Jan 7 18:45:07 2024 +0100

    Add include paths to freetype module

diff --git a/pkg/freetype/build.zig b/pkg/freetype/build.zig
index 24a2723d..1770e3e4 100644
--- a/pkg/freetype/build.zig
+++ b/pkg/freetype/build.zig
@@ -5,7 +5,7 @@ pub fn build(b: *std.Build) !void {
     const optimize = b.standardOptimizeOption(.{});
     const libpng_enabled = b.option(bool, "enable-libpng", "Build libpng") orelse false;
 
-    _ = b.addModule("freetype", .{ .root_source_file = .{ .path = "main.zig" } });
+    const module = b.addModule("freetype", .{ .root_source_file = .{ .path = "main.zig" } });
 
     const upstream = b.dependency("freetype", .{});
     const lib = b.addStaticLibrary(.{
@@ -15,6 +15,8 @@ pub fn build(b: *std.Build) !void {
     });
     lib.linkLibC();
     lib.addIncludePath(upstream.path("include"));
+    module.addIncludePath(upstream.path("include"));
+    module.addIncludePath(.{ .path = "" });
 
     // Dependencies
     const zlib_dep = b.dependency("zlib", .{ .target = target, .optimize = optimize });
@@ -38,12 +40,11 @@ pub fn build(b: *std.Build) !void {
     });
     if (libpng_enabled) try flags.append("-DFT_CONFIG_OPTION_USE_PNG=1");
 
-    for (srcs) |src| {
-        lib.addCSourceFile(.{
-            .file = upstream.path(src),
-            .flags = flags.items,
-        });
-    }
+    lib.addCSourceFiles(.{
+        .dependency = upstream,
+        .files = srcs,
+        .flags = flags.items,
+    });
 
     switch (target.result.os.tag) {
         .linux => lib.addCSourceFile(.{

commit 3360a008cd137b428631fc8052f64d672a660240
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sat Jan 13 20:21:49 2024 -0800

    build: build produces a broken object file for iOS
    
    This gets `zig build -Dtarget=aarch64-ios` working. By "working" I mean
    it produces an object file without compiler errors. However, the object
    file certainly isn't useful since it uses a number of features that will
    not work in the iOS sandbox.
    
    This is just an experiment more than anything to see how hard it would be to
    get libghostty working within iOS to render a terminal. Note iOS doesn't
    support ptys so this wouldn't be a true on-device terminal. The
    challenge right now is to just get a terminal rendering (not usable).

diff --git a/pkg/freetype/build.zig b/pkg/freetype/build.zig
index 1770e3e4..8716c572 100644
--- a/pkg/freetype/build.zig
+++ b/pkg/freetype/build.zig
@@ -15,6 +15,11 @@ pub fn build(b: *std.Build) !void {
     });
     lib.linkLibC();
     lib.addIncludePath(upstream.path("include"));
+    if (target.result.isDarwin()) {
+        const apple_sdk = @import("apple_sdk");
+        try apple_sdk.addPaths(b, &lib.root_module);
+    }
+
     module.addIncludePath(upstream.path("include"));
     module.addIncludePath(.{ .path = "" });
 
@@ -86,7 +91,7 @@ pub fn build(b: *std.Build) !void {
 
     b.installArtifact(lib);
 
-    {
+    if (target.query.isNative()) {
         const test_exe = b.addTest(.{
             .name = "test",
             .root_source_file = .{ .path = "main.zig" },

commit edaafdf57ad413c8e19c9ffbfc9fd039b74ed169
Author: Krzysztof Wolicki <der.teufel.mail@gmail.com>
Date:   Mon Feb 26 18:00:43 2024 +0100

    build API change: update usage of addCSourceFiles

diff --git a/pkg/freetype/build.zig b/pkg/freetype/build.zig
index 8716c572..d330140b 100644
--- a/pkg/freetype/build.zig
+++ b/pkg/freetype/build.zig
@@ -46,7 +46,7 @@ pub fn build(b: *std.Build) !void {
     if (libpng_enabled) try flags.append("-DFT_CONFIG_OPTION_USE_PNG=1");
 
     lib.addCSourceFiles(.{
-        .dependency = upstream,
+        .root = upstream.path(""),
         .files = srcs,
         .flags = flags.items,
     });

commit 595f24585ea8f3f5a40c567d71cb0ea06628d027
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Thu Apr 11 09:21:51 2024 -0400

    working on more zig breaking changes

diff --git a/pkg/freetype/build.zig b/pkg/freetype/build.zig
index d330140b..9819c532 100644
--- a/pkg/freetype/build.zig
+++ b/pkg/freetype/build.zig
@@ -81,13 +81,12 @@ pub fn build(b: *std.Build) !void {
         }),
     }
 
-    lib.installHeader("freetype-zig.h", "freetype-zig.h");
-    lib.installHeadersDirectoryOptions(.{
-        .source_dir = upstream.path("include"),
-        .install_dir = .header,
-        .install_subdir = "",
-        .include_extensions = &.{".h"},
-    });
+    lib.installHeader(.{ .path = "freetype-zig.h" }, "freetype-zig.h");
+    lib.installHeadersDirectory(
+        upstream.path("include"),
+        "",
+        .{ .include_extensions = &.{".h"} },
+    );
 
     b.installArtifact(lib);
 

commit a30e791c8582c33b5950db2fe40abe6215554e5d
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Sat Jun 8 19:51:44 2024 -0700

    begin 0.13 update process -- very broken

diff --git a/pkg/freetype/build.zig b/pkg/freetype/build.zig
index 9819c532..f62c6e48 100644
--- a/pkg/freetype/build.zig
+++ b/pkg/freetype/build.zig
@@ -5,7 +5,7 @@ pub fn build(b: *std.Build) !void {
     const optimize = b.standardOptimizeOption(.{});
     const libpng_enabled = b.option(bool, "enable-libpng", "Build libpng") orelse false;
 
-    const module = b.addModule("freetype", .{ .root_source_file = .{ .path = "main.zig" } });
+    const module = b.addModule("freetype", .{ .root_source_file = b.path("main.zig") });
 
     const upstream = b.dependency("freetype", .{});
     const lib = b.addStaticLibrary(.{
@@ -21,7 +21,7 @@ pub fn build(b: *std.Build) !void {
     }
 
     module.addIncludePath(upstream.path("include"));
-    module.addIncludePath(.{ .path = "" });
+    module.addIncludePath(b.path(""));
 
     // Dependencies
     const zlib_dep = b.dependency("zlib", .{ .target = target, .optimize = optimize });
@@ -81,7 +81,7 @@ pub fn build(b: *std.Build) !void {
         }),
     }
 
-    lib.installHeader(.{ .path = "freetype-zig.h" }, "freetype-zig.h");
+    lib.installHeader(b.path("freetype-zig.h"), "freetype-zig.h");
     lib.installHeadersDirectory(
         upstream.path("include"),
         "",
@@ -93,7 +93,7 @@ pub fn build(b: *std.Build) !void {
     if (target.query.isNative()) {
         const test_exe = b.addTest(.{
             .name = "test",
-            .root_source_file = .{ .path = "main.zig" },
+            .root_source_file = b.path("main.zig"),
             .target = target,
             .optimize = optimize,
         });

commit 8bb8b01e547498b2d6069b0ecc44a0ca4316c80d
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Thu Oct 24 10:03:11 2024 -0700

    build: use Zig system packaging options
    
    This allows dynamically linking against system libraries, which is
    particularly useful for packaging.

diff --git a/pkg/freetype/build.zig b/pkg/freetype/build.zig
index f62c6e48..46458c15 100644
--- a/pkg/freetype/build.zig
+++ b/pkg/freetype/build.zig
@@ -23,13 +23,13 @@ pub fn build(b: *std.Build) !void {
     module.addIncludePath(upstream.path("include"));
     module.addIncludePath(b.path(""));
 
-    // Dependencies
-    const zlib_dep = b.dependency("zlib", .{ .target = target, .optimize = optimize });
-    lib.linkLibrary(zlib_dep.artifact("z"));
-    if (libpng_enabled) {
-        const libpng_dep = b.dependency("libpng", .{ .target = target, .optimize = optimize });
-        lib.linkLibrary(libpng_dep.artifact("png"));
-    }
+    // For dynamic linking, we prefer dynamic linking and to search by
+    // mode first. Mode first will search all paths for a dynamic library
+    // before falling back to static.
+    const dynamic_link_opts: std.Build.Module.LinkSystemLibraryOptions = .{
+        .preferred_link_mode = .dynamic,
+        .search_strategy = .mode_first,
+    };
 
     var flags = std.ArrayList([]const u8).init(b.allocator);
     defer flags.deinit();
@@ -43,7 +43,30 @@ pub fn build(b: *std.Build) !void {
 
         "-fno-sanitize=undefined",
     });
-    if (libpng_enabled) try flags.append("-DFT_CONFIG_OPTION_USE_PNG=1");
+
+    // Zlib
+    if (b.systemIntegrationOption("zlib", .{})) {
+        lib.linkSystemLibrary2("zlib", dynamic_link_opts);
+    } else {
+        const zlib_dep = b.dependency("zlib", .{ .target = target, .optimize = optimize });
+        lib.linkLibrary(zlib_dep.artifact("z"));
+    }
+
+    // Libpng
+    _ = b.systemIntegrationOption("libpng", .{}); // So it shows up in help
+    if (libpng_enabled) {
+        try flags.append("-DFT_CONFIG_OPTION_USE_PNG=1");
+
+        if (b.systemIntegrationOption("libpng", .{})) {
+            lib.linkSystemLibrary2("libpng", dynamic_link_opts);
+        } else {
+            const libpng_dep = b.dependency(
+                "libpng",
+                .{ .target = target, .optimize = optimize },
+            );
+            lib.linkLibrary(libpng_dep.artifact("png"));
+        }
+    }
 
     lib.addCSourceFiles(.{
         .root = upstream.path(""),

commit 72e0fb14fe1cf0453d585c1d58836e3a888107c7
Author: Jan200101 <sentrycraft123@gmail.com>
Date:   Fri Jan 3 22:41:15 2025 +0100

    don't build freetype2 when system integration is enabled

diff --git a/pkg/freetype/build.zig b/pkg/freetype/build.zig
index 46458c15..6ff4f434 100644
--- a/pkg/freetype/build.zig
+++ b/pkg/freetype/build.zig
@@ -5,7 +5,61 @@ pub fn build(b: *std.Build) !void {
     const optimize = b.standardOptimizeOption(.{});
     const libpng_enabled = b.option(bool, "enable-libpng", "Build libpng") orelse false;
 
-    const module = b.addModule("freetype", .{ .root_source_file = b.path("main.zig") });
+    const module = b.addModule("freetype", .{
+        .root_source_file = b.path("main.zig"),
+        .target = target,
+        .optimize = optimize,
+    });
+
+    // For dynamic linking, we prefer dynamic linking and to search by
+    // mode first. Mode first will search all paths for a dynamic library
+    // before falling back to static.
+    const dynamic_link_opts: std.Build.Module.LinkSystemLibraryOptions = .{
+        .preferred_link_mode = .dynamic,
+        .search_strategy = .mode_first,
+    };
+
+    var test_exe: ?*std.Build.Step.Compile = null;
+    if (target.query.isNative()) {
+        test_exe = b.addTest(.{
+            .name = "test",
+            .root_source_file = b.path("main.zig"),
+            .target = target,
+            .optimize = optimize,
+        });
+        const tests_run = b.addRunArtifact(test_exe.?);
+        const test_step = b.step("test", "Run tests");
+        test_step.dependOn(&tests_run.step);
+    }
+
+    module.addIncludePath(b.path(""));
+
+    if (b.systemIntegrationOption("freetype", .{})) {
+        module.linkSystemLibrary("freetype2", dynamic_link_opts);
+        if (test_exe) |exe| {
+            exe.linkSystemLibrary2("freetype2", dynamic_link_opts);
+        }
+    } else {
+        const lib = try buildLib(b, module, .{
+            .target = target,
+            .optimize = optimize,
+
+            .libpng_enabled = libpng_enabled,
+
+            .dynamic_link_opts = dynamic_link_opts,
+        });
+
+        if (test_exe) |exe| {
+            exe.linkLibrary(lib);
+        }
+    }
+}
+
+fn buildLib(b: *std.Build, module: *std.Build.Module, options: anytype) !*std.Build.Step.Compile {
+    const target = options.target;
+    const optimize = options.optimize;
+
+    const libpng_enabled = options.libpng_enabled;
 
     const upstream = b.dependency("freetype", .{});
     const lib = b.addStaticLibrary(.{
@@ -21,16 +75,6 @@ pub fn build(b: *std.Build) !void {
     }
 
     module.addIncludePath(upstream.path("include"));
-    module.addIncludePath(b.path(""));
-
-    // For dynamic linking, we prefer dynamic linking and to search by
-    // mode first. Mode first will search all paths for a dynamic library
-    // before falling back to static.
-    const dynamic_link_opts: std.Build.Module.LinkSystemLibraryOptions = .{
-        .preferred_link_mode = .dynamic,
-        .search_strategy = .mode_first,
-    };
-
     var flags = std.ArrayList([]const u8).init(b.allocator);
     defer flags.deinit();
     try flags.appendSlice(&.{
@@ -44,6 +88,8 @@ pub fn build(b: *std.Build) !void {
         "-fno-sanitize=undefined",
     });
 
+    const dynamic_link_opts = options.dynamic_link_opts;
+
     // Zlib
     if (b.systemIntegrationOption("zlib", .{})) {
         lib.linkSystemLibrary2("zlib", dynamic_link_opts);
@@ -113,18 +159,7 @@ pub fn build(b: *std.Build) !void {
 
     b.installArtifact(lib);
 
-    if (target.query.isNative()) {
-        const test_exe = b.addTest(.{
-            .name = "test",
-            .root_source_file = b.path("main.zig"),
-            .target = target,
-            .optimize = optimize,
-        });
-        test_exe.linkLibrary(lib);
-        const tests_run = b.addRunArtifact(test_exe);
-        const test_step = b.step("test", "Run tests");
-        test_step.dependOn(&tests_run.step);
-    }
+    return lib;
 }
 
 const srcs: []const []const u8 = &.{

commit 7e2286eb8c603ade782a3970911531595d57e280
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Tue Mar 11 14:33:33 2025 -0700

    Zig 0.14

diff --git a/pkg/freetype/build.zig b/pkg/freetype/build.zig
index 6ff4f434..594788b0 100644
--- a/pkg/freetype/build.zig
+++ b/pkg/freetype/build.zig
@@ -69,9 +69,9 @@ fn buildLib(b: *std.Build, module: *std.Build.Module, options: anytype) !*std.Bu
     });
     lib.linkLibC();
     lib.addIncludePath(upstream.path("include"));
-    if (target.result.isDarwin()) {
+    if (target.result.os.tag.isDarwin()) {
         const apple_sdk = @import("apple_sdk");
-        try apple_sdk.addPaths(b, &lib.root_module);
+        try apple_sdk.addPaths(b, lib.root_module);
     }
 
     module.addIncludePath(upstream.path("include"));

commit cfea2ea12cf1ef805659ffeae058f03b4639c788
Author: Mitchell Hashimoto <m@mitchellh.com>
Date:   Thu Mar 13 21:30:24 2025 -0700

    build: mark most dependencies as lazy
    
    Lazy dependencies are only fetched if the build script would actually
    reach a usage of that dependency at runtime (when the `lazyDependency`
    function is called). This can save a lot of network traffic, disk uage,
    and time because we don't have to fetch and build dependencies that we
    don't actually need.
    
    Prior to this commit, Ghostty fetched almost everything for all
    platforms and configurations all the time. This commit reverses that to
    fetching almost nothing until it's actually needed.
    
    There are very little downsides to doing this[1]. One downside is `zig
    build --fetch` doesn't fetch lazy dependencies, but we don't rely on
    this command for packaging and suggest using our custom shell script
    that downloads a cached list of URLs (`build.zig.zon.txt`).
    
    This commit doesn't cover 100% of dependencies, since some provide no
    benefit to make lazy while the complexity to make them lazy is higher
    (in code style typically).
    
    Conversely, some simple dependencies are marked lazy even if they're
    almost always needed if they don't introduce any real complexity to the
    code, because there is very little downside to do so.
    
    [1]: https://ziggit.dev/t/lazy-dependencies-best-dependencies/5509/5

diff --git a/pkg/freetype/build.zig b/pkg/freetype/build.zig
index 594788b0..bfe27e5a 100644
--- a/pkg/freetype/build.zig
+++ b/pkg/freetype/build.zig
@@ -61,20 +61,17 @@ fn buildLib(b: *std.Build, module: *std.Build.Module, options: anytype) !*std.Bu
 
     const libpng_enabled = options.libpng_enabled;
 
-    const upstream = b.dependency("freetype", .{});
     const lib = b.addStaticLibrary(.{
         .name = "freetype",
         .target = target,
         .optimize = optimize,
     });
     lib.linkLibC();
-    lib.addIncludePath(upstream.path("include"));
     if (target.result.os.tag.isDarwin()) {
         const apple_sdk = @import("apple_sdk");
         try apple_sdk.addPaths(b, lib.root_module);
     }
 
-    module.addIncludePath(upstream.path("include"));
     var flags = std.ArrayList([]const u8).init(b.allocator);
     defer flags.deinit();
     try flags.appendSlice(&.{
@@ -114,48 +111,52 @@ fn buildLib(b: *std.Build, module: *std.Build.Module, options: anytype) !*std.Bu
         }
     }
 
-    lib.addCSourceFiles(.{
-        .root = upstream.path(""),
-        .files = srcs,
-        .flags = flags.items,
-    });
-
-    switch (target.result.os.tag) {
-        .linux => lib.addCSourceFile(.{
-            .file = upstream.path("builds/unix/ftsystem.c"),
-            .flags = flags.items,
-        }),
-        .windows => lib.addCSourceFile(.{
-            .file = upstream.path("builds/windows/ftsystem.c"),
-            .flags = flags.items,
-        }),
-        else => lib.addCSourceFile(.{
-            .file = upstream.path("src/base/ftsystem.c"),
+    if (b.lazyDependency("freetype", .{})) |upstream| {
+        lib.addIncludePath(upstream.path("include"));
+        module.addIncludePath(upstream.path("include"));
+        lib.addCSourceFiles(.{
+            .root = upstream.path(""),
+            .files = srcs,
             .flags = flags.items,
-        }),
-    }
-    switch (target.result.os.tag) {
-        .windows => {
-            lib.addCSourceFile(.{
-                .file = upstream.path("builds/windows/ftdebug.c"),
+        });
+
+        switch (target.result.os.tag) {
+            .linux => lib.addCSourceFile(.{
+                .file = upstream.path("builds/unix/ftsystem.c"),
                 .flags = flags.items,
-            });
-            lib.addWin32ResourceFile(.{
-                .file = upstream.path("src/base/ftver.rc"),
-            });
-        },
-        else => lib.addCSourceFile(.{
-            .file = upstream.path("src/base/ftdebug.c"),
-            .flags = flags.items,
-        }),
-    }
+            }),
+            .windows => lib.addCSourceFile(.{
+                .file = upstream.path("builds/windows/ftsystem.c"),
+                .flags = flags.items,
+            }),
+            else => lib.addCSourceFile(.{
+                .file = upstream.path("src/base/ftsystem.c"),
+                .flags = flags.items,
+            }),
+        }
+        switch (target.result.os.tag) {
+            .windows => {
+                lib.addCSourceFile(.{
+                    .file = upstream.path("builds/windows/ftdebug.c"),
+                    .flags = flags.items,
+                });
+                lib.addWin32ResourceFile(.{
+                    .file = upstream.path("src/base/ftver.rc"),
+                });
+            },
+            else => lib.addCSourceFile(.{
+                .file = upstream.path("src/base/ftdebug.c"),
+                .flags = flags.items,
+            }),
+        }
 
-    lib.installHeader(b.path("freetype-zig.h"), "freetype-zig.h");
-    lib.installHeadersDirectory(
-        upstream.path("include"),
-        "",
-        .{ .include_extensions = &.{".h"} },
-    );
+        lib.installHeader(b.path("freetype-zig.h"), "freetype-zig.h");
+        lib.installHeadersDirectory(
+            upstream.path("include"),
+            "",
+            .{ .include_extensions = &.{".h"} },
+        );
+    }
 
     b.installArtifact(lib);
 

