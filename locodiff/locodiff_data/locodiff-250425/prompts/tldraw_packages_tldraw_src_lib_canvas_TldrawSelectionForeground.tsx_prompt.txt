# Instructions

You are being benchmarked. You will see the output of a git log command, and from that must infer the current state of a file. Think carefully, as you must output the exact state of the file to earn full marks.

**Important:** Your goal is to reproduce the file's content *exactly* as it exists at the final commit, even if the code appears broken, buggy, or contains obvious errors. Do **not** try to "fix" the code. Attempting to correct issues will result in a poor score, as this benchmark evaluates your ability to reproduce the precise state of the file based on its history.

# Required Response Format

Wrap the content of the file in triple backticks (```). Any text outside the final closing backticks will be ignored. End your response after outputting the closing backticks.

# Example Response

```python
#!/usr/bin/env python
print('Hello, world!')
```

# File History

> git log -p --cc --topo-order --reverse -- packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx

commit b7d9c8684cb6cf7bd710af5420135ea3516cc3bf
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon Jul 17 22:22:34 2023 +0100

    tldraw zero - package shuffle (#1710)
    
    This PR moves code between our packages so that:
    - @tldraw/editor is a ‚Äúcore‚Äù library with the engine and canvas but no
    shapes, tools, or other things
    - @tldraw/tldraw contains everything particular to the experience we‚Äôve
    built for tldraw
    
    At first look, this might seem like a step away from customization and
    configuration, however I believe it greatly increases the configuration
    potential of the @tldraw/editor while also providing a more accurate
    reflection of what configuration options actually exist for
    @tldraw/tldraw.
    
    ## Library changes
    
    @tldraw/editor re-exports its dependencies and @tldraw/tldraw re-exports
    @tldraw/editor.
    
    - users of @tldraw/editor WITHOUT @tldraw/tldraw should almost always
    only import things from @tldraw/editor.
    - users of @tldraw/tldraw should almost always only import things from
    @tldraw/tldraw.
    
    - @tldraw/polyfills is merged into @tldraw/editor
    - @tldraw/indices is merged into @tldraw/editor
    - @tldraw/primitives is merged mostly into @tldraw/editor, partially
    into @tldraw/tldraw
    - @tldraw/file-format is merged into @tldraw/tldraw
    - @tldraw/ui is merged into @tldraw/tldraw
    
    Many (many) utils and other code is moved from the editor to tldraw. For
    example, embeds now are entirely an feature of @tldraw/tldraw. The only
    big chunk of code left in core is related to arrow handling.
    
    ## API Changes
    
    The editor can now be used without tldraw's assets. We load them in
    @tldraw/tldraw instead, so feel free to use whatever fonts or images or
    whatever that you like with the editor.
    
    All tools and shapes (except for the `Group` shape) are moved to
    @tldraw/tldraw. This includes the `select` tool.
    
    You should use the editor with at least one tool, however, so you now
    also need to send in an `initialState` prop to the Editor /
    <TldrawEditor> component indicating which state the editor should begin
    in.
    
    The `components` prop now also accepts `SelectionForeground`.
    
    The complex selection component that we use for tldraw is moved to
    @tldraw/tldraw. The default component is quite basic but can easily be
    replaced via the `components` prop. We pass down our tldraw-flavored
    SelectionFg via `components`.
    
    Likewise with the `Scribble` component: the `DefaultScribble` no longer
    uses our freehand tech and is a simple path instead. We pass down the
    tldraw-flavored scribble via `components`.
    
    The `ExternalContentManager` (`Editor.externalContentManager`) is
    removed and replaced with a mapping of types to handlers.
    
    - Register new content handlers with
    `Editor.registerExternalContentHandler`.
    - Register new asset creation handlers (for files and URLs) with
    `Editor.registerExternalAssetHandler`
    
    ### Change Type
    
    - [x] `major` ‚Äî Breaking change
    
    ### Test Plan
    
    - [x] Unit Tests
    - [x] End to end tests
    
    ### Release Notes
    
    - [@tldraw/editor] lots, wip
    - [@tldraw/ui] gone, merged to tldraw/tldraw
    - [@tldraw/polyfills] gone, merged to tldraw/editor
    - [@tldraw/primitives] gone, merged to tldraw/editor / tldraw/tldraw
    - [@tldraw/indices] gone, merged to tldraw/editor
    - [@tldraw/file-format] gone, merged to tldraw/tldraw
    
    ---------
    
    Co-authored-by: alex <alex@dytry.ch>

diff --git a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
new file mode 100644
index 000000000..ee357367f
--- /dev/null
+++ b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
@@ -0,0 +1,522 @@
+import {
+	RotateCorner,
+	TLEmbedShape,
+	TLTextShape,
+	getCursor,
+	toDomPrecision,
+	track,
+	useEditor,
+	useSelectionEvents,
+	useTransform,
+} from '@tldraw/editor'
+import classNames from 'classnames'
+import { useRef } from 'react'
+import { CropHandles } from './CropHandles'
+
+const IS_FIREFOX =
+	typeof navigator !== 'undefined' &&
+	navigator.userAgent &&
+	navigator.userAgent.toLowerCase().indexOf('firefox') > -1
+
+export const TldrawSelectionForeground = track(function SelectionFg() {
+	const editor = useEditor()
+	const rSvg = useRef<SVGSVGElement>(null)
+
+	const isReadonlyMode = editor.isReadOnly
+	const topEvents = useSelectionEvents('top')
+	const rightEvents = useSelectionEvents('right')
+	const bottomEvents = useSelectionEvents('bottom')
+	const leftEvents = useSelectionEvents('left')
+	const topLeftEvents = useSelectionEvents('top_left')
+	const topRightEvents = useSelectionEvents('top_right')
+	const bottomRightEvents = useSelectionEvents('bottom_right')
+	const bottomLeftEvents = useSelectionEvents('bottom_left')
+
+	const isDefaultCursor = !editor.isMenuOpen && editor.cursor.type === 'default'
+	const isCoarsePointer = editor.isCoarsePointer
+
+	let bounds = editor.selectionBounds
+	const shapes = editor.selectedShapes
+	const onlyShape = editor.onlySelectedShape
+	const isLockedShape = onlyShape && editor.isShapeOrAncestorLocked(onlyShape)
+
+	// if all shapes have an expandBy for the selection outline, we can expand by the l
+	const expandOutlineBy = onlyShape
+		? editor.getShapeUtil(onlyShape).expandSelectionOutlinePx(onlyShape)
+		: 0
+
+	useTransform(rSvg, bounds?.x, bounds?.y, 1, editor.selectionRotation, {
+		x: -expandOutlineBy,
+		y: -expandOutlineBy,
+	})
+
+	if (!bounds) return null
+	bounds = bounds.clone().expandBy(expandOutlineBy)
+
+	const zoom = editor.zoomLevel
+	const rotation = editor.selectionRotation
+	const isChangingStyles = editor.isChangingStyle
+
+	const width = Math.max(1, bounds.width)
+	const height = Math.max(1, bounds.height)
+
+	const size = 8 / zoom
+	const isTinyX = width < size * 2
+	const isTinyY = height < size * 2
+
+	const isSmallX = width < size * 4
+	const isSmallY = height < size * 4
+	const isSmallCropX = width < size * 5
+	const isSmallCropY = height < size * 5
+
+	const mobileHandleMultiplier = isCoarsePointer ? 1.75 : 1
+	const targetSize = (6 / zoom) * mobileHandleMultiplier
+
+	const targetSizeX = (isSmallX ? targetSize / 2 : targetSize) * (mobileHandleMultiplier * 0.75)
+	const targetSizeY = (isSmallY ? targetSize / 2 : targetSize) * (mobileHandleMultiplier * 0.75)
+
+	const showSelectionBounds =
+		(onlyShape ? !editor.getShapeUtil(onlyShape).hideSelectionBoundsFg(onlyShape) : true) &&
+		!isChangingStyles
+
+	let shouldDisplayBox =
+		(showSelectionBounds &&
+			editor.isInAny(
+				'select.idle',
+				'select.brushing',
+				'select.scribble_brushing',
+				'select.pointing_canvas',
+				'select.pointing_selection',
+				'select.pointing_shape',
+				'select.crop.idle',
+				'select.crop.pointing_crop',
+				'select.pointing_resize_handle',
+				'select.pointing_crop_handle',
+				'select.editing_shape'
+			)) ||
+		(showSelectionBounds &&
+			editor.isIn('select.resizing') &&
+			onlyShape &&
+			editor.isShapeOfType<TLTextShape>(onlyShape, 'text'))
+
+	if (
+		onlyShape &&
+		editor.isShapeOfType<TLEmbedShape>(onlyShape, 'embed') &&
+		shouldDisplayBox &&
+		IS_FIREFOX
+	) {
+		shouldDisplayBox = false
+	}
+
+	const showCropHandles =
+		editor.isInAny(
+			'select.pointing_crop_handle',
+			'select.crop.idle',
+			'select.crop.pointing_crop'
+		) &&
+		!isChangingStyles &&
+		!isReadonlyMode
+
+	const shouldDisplayControls =
+		editor.isInAny(
+			'select.idle',
+			'select.pointing_selection',
+			'select.pointing_shape',
+			'select.crop.idle'
+		) &&
+		!isChangingStyles &&
+		!isReadonlyMode
+
+	const showCornerRotateHandles =
+		!isCoarsePointer &&
+		!(isTinyX || isTinyY) &&
+		(shouldDisplayControls || showCropHandles) &&
+		(onlyShape ? !editor.getShapeUtil(onlyShape).hideRotateHandle(onlyShape) : true) &&
+		!isLockedShape
+
+	const showMobileRotateHandle =
+		isCoarsePointer &&
+		(!isSmallX || !isSmallY) &&
+		(shouldDisplayControls || showCropHandles) &&
+		(onlyShape ? !editor.getShapeUtil(onlyShape).hideRotateHandle(onlyShape) : true) &&
+		!isLockedShape
+
+	const showResizeHandles =
+		shouldDisplayControls &&
+		(onlyShape
+			? editor.getShapeUtil(onlyShape).canResize(onlyShape) &&
+			  !editor.getShapeUtil(onlyShape).hideResizeHandles(onlyShape)
+			: true) &&
+		!showCropHandles &&
+		!isLockedShape
+
+	const hideAlternateCornerHandles = isTinyX || isTinyY
+	const showOnlyOneHandle = isTinyX && isTinyY
+	const hideAlternateCropHandles = isSmallCropX || isSmallCropY
+
+	const showHandles = showResizeHandles || showCropHandles
+	const hideRotateCornerHandles = !showCornerRotateHandles
+	const hideMobileRotateHandle = !shouldDisplayControls || !showMobileRotateHandle
+	const hideTopLeftCorner = !shouldDisplayControls || !showHandles
+	const hideTopRightCorner = !shouldDisplayControls || !showHandles || hideAlternateCornerHandles
+	const hideBottomLeftCorner = !shouldDisplayControls || !showHandles || hideAlternateCornerHandles
+	const hideBottomRightCorner =
+		!shouldDisplayControls || !showHandles || (showOnlyOneHandle && !showCropHandles)
+
+	let hideEdgeTargetsDueToCoarsePointer = isCoarsePointer
+
+	if (
+		hideEdgeTargetsDueToCoarsePointer &&
+		shapes.every((shape) => editor.getShapeUtil(shape).isAspectRatioLocked(shape))
+	) {
+		hideEdgeTargetsDueToCoarsePointer = false
+	}
+
+	// If we're showing crop handles, then show the edges too.
+	// If we're showing resize handles, then show the edges only
+	// if we're not hiding them for some other reason
+	let hideEdgeTargets = true
+
+	if (showCropHandles) {
+		hideEdgeTargets = hideAlternateCropHandles
+	} else if (showResizeHandles) {
+		hideEdgeTargets =
+			hideAlternateCornerHandles || showOnlyOneHandle || hideEdgeTargetsDueToCoarsePointer
+	}
+
+	const textHandleHeight = Math.min(24 / zoom, height - targetSizeY * 3)
+	const showTextResizeHandles =
+		shouldDisplayControls &&
+		isCoarsePointer &&
+		onlyShape &&
+		editor.isShapeOfType<TLTextShape>(onlyShape, 'text') &&
+		textHandleHeight * zoom >= 4
+
+	return (
+		<svg
+			ref={rSvg}
+			className="tl-overlays__item tl-selection__fg"
+			data-testid="selection-foreground"
+		>
+			{shouldDisplayBox && (
+				<rect
+					className={classNames('tl-selection__fg__outline')}
+					width={toDomPrecision(width)}
+					height={toDomPrecision(height)}
+				/>
+			)}
+			<RotateCornerHandle
+				data-testid="selection.rotate.top-left"
+				cx={0}
+				cy={0}
+				targetSize={targetSize}
+				corner="top_left_rotate"
+				cursor={isDefaultCursor ? getCursor('nwse-rotate', rotation) : undefined}
+				isHidden={hideRotateCornerHandles}
+			/>
+			<RotateCornerHandle
+				data-testid="selection.rotate.top-right"
+				cx={width + targetSize * 3}
+				cy={0}
+				targetSize={targetSize}
+				corner="top_right_rotate"
+				cursor={isDefaultCursor ? getCursor('nesw-rotate', rotation) : undefined}
+				isHidden={hideRotateCornerHandles}
+			/>
+			<RotateCornerHandle
+				data-testid="selection.rotate.bottom-left"
+				cx={0}
+				cy={height + targetSize * 3}
+				targetSize={targetSize}
+				corner="bottom_left_rotate"
+				cursor={isDefaultCursor ? getCursor('swne-rotate', rotation) : undefined}
+				isHidden={hideRotateCornerHandles}
+			/>
+			<RotateCornerHandle
+				data-testid="selection.rotate.bottom-right"
+				cx={width + targetSize * 3}
+				cy={height + targetSize * 3}
+				targetSize={targetSize}
+				corner="bottom_right_rotate"
+				cursor={isDefaultCursor ? getCursor('senw-rotate', rotation) : undefined}
+				isHidden={hideRotateCornerHandles}
+			/>{' '}
+			<MobileRotateHandle
+				data-testid="selection.rotate.mobile"
+				cx={isSmallX ? -targetSize * 1.5 : width / 2}
+				cy={isSmallX ? height / 2 : -targetSize * 1.5}
+				size={size}
+				isHidden={hideMobileRotateHandle}
+			/>
+			{/* Targets */}
+			<rect
+				className={classNames('tl-transparent', {
+					'tl-hidden': hideEdgeTargets,
+				})}
+				data-testid="selection.resize.top"
+				aria-label="top target"
+				pointerEvents="all"
+				x={0}
+				y={toDomPrecision(0 - (isSmallY ? targetSizeY * 2 : targetSizeY))}
+				width={toDomPrecision(Math.max(1, width))}
+				height={toDomPrecision(Math.max(1, targetSizeY * 2))}
+				style={isDefaultCursor ? { cursor: getCursor('ns-resize', rotation) } : undefined}
+				{...topEvents}
+			/>
+			<rect
+				className={classNames('tl-transparent', {
+					'tl-hidden': hideEdgeTargets,
+				})}
+				data-testid="selection.resize.right"
+				aria-label="right target"
+				pointerEvents="all"
+				x={toDomPrecision(width - (isSmallX ? 0 : targetSizeX))}
+				y={0}
+				height={toDomPrecision(Math.max(1, height))}
+				width={toDomPrecision(Math.max(1, targetSizeX * 2))}
+				style={isDefaultCursor ? { cursor: getCursor('ew-resize', rotation) } : undefined}
+				{...rightEvents}
+			/>
+			<rect
+				className={classNames('tl-transparent', {
+					'tl-hidden': hideEdgeTargets,
+				})}
+				data-testid="selection.resize.bottom"
+				aria-label="bottom target"
+				pointerEvents="all"
+				x={0}
+				y={toDomPrecision(height - (isSmallY ? 0 : targetSizeY))}
+				width={toDomPrecision(Math.max(1, width))}
+				height={toDomPrecision(Math.max(1, targetSizeY * 2))}
+				style={isDefaultCursor ? { cursor: getCursor('ns-resize', rotation) } : undefined}
+				{...bottomEvents}
+			/>
+			<rect
+				className={classNames('tl-transparent', {
+					'tl-hidden': hideEdgeTargets,
+				})}
+				data-testid="selection.resize.left"
+				aria-label="left target"
+				pointerEvents="all"
+				x={toDomPrecision(0 - (isSmallX ? targetSizeX * 2 : targetSizeX))}
+				y={0}
+				height={toDomPrecision(Math.max(1, height))}
+				width={toDomPrecision(Math.max(1, targetSizeX * 2))}
+				style={isDefaultCursor ? { cursor: getCursor('ew-resize', rotation) } : undefined}
+				{...leftEvents}
+			/>
+			{/* Corner Targets */}
+			<rect
+				className={classNames('tl-transparent', {
+					'tl-hidden': hideTopLeftCorner,
+				})}
+				data-testid="selection.target.top-left"
+				aria-label="top-left target"
+				pointerEvents="all"
+				x={toDomPrecision(0 - (isSmallX ? targetSizeX * 2 : targetSizeX * 1.5))}
+				y={toDomPrecision(0 - (isSmallY ? targetSizeY * 2 : targetSizeY * 1.5))}
+				width={toDomPrecision(targetSizeX * 3)}
+				height={toDomPrecision(targetSizeY * 3)}
+				style={isDefaultCursor ? { cursor: getCursor('nwse-resize', rotation) } : undefined}
+				{...topLeftEvents}
+			/>
+			<rect
+				className={classNames('tl-transparent', {
+					'tl-hidden': hideTopRightCorner,
+				})}
+				data-testid="selection.target.top-right"
+				aria-label="top-right target"
+				pointerEvents="all"
+				x={toDomPrecision(width - (isSmallX ? 0 : targetSizeX * 1.5))}
+				y={toDomPrecision(0 - (isSmallY ? targetSizeY * 2 : targetSizeY * 1.5))}
+				width={toDomPrecision(targetSizeX * 3)}
+				height={toDomPrecision(targetSizeY * 3)}
+				style={isDefaultCursor ? { cursor: getCursor('nesw-resize', rotation) } : undefined}
+				{...topRightEvents}
+			/>
+			<rect
+				className={classNames('tl-transparent', {
+					'tl-hidden': hideBottomRightCorner,
+				})}
+				data-testid="selection.target.bottom-right"
+				aria-label="bottom-right target"
+				pointerEvents="all"
+				x={toDomPrecision(width - (isSmallX ? targetSizeX : targetSizeX * 1.5))}
+				y={toDomPrecision(height - (isSmallY ? targetSizeY : targetSizeY * 1.5))}
+				width={toDomPrecision(targetSizeX * 3)}
+				height={toDomPrecision(targetSizeY * 3)}
+				style={isDefaultCursor ? { cursor: getCursor('nwse-resize', rotation) } : undefined}
+				{...bottomRightEvents}
+			/>
+			<rect
+				className={classNames('tl-transparent', {
+					'tl-hidden': hideBottomLeftCorner,
+				})}
+				data-testid="selection.target.bottom-left"
+				aria-label="bottom-left target"
+				pointerEvents="all"
+				x={toDomPrecision(0 - (isSmallX ? targetSizeX * 3 : targetSizeX * 1.5))}
+				y={toDomPrecision(height - (isSmallY ? 0 : targetSizeY * 1.5))}
+				width={toDomPrecision(targetSizeX * 3)}
+				height={toDomPrecision(targetSizeY * 3)}
+				style={isDefaultCursor ? { cursor: getCursor('nesw-resize', rotation) } : undefined}
+				{...bottomLeftEvents}
+			/>
+			{/* Resize Handles */}
+			{showResizeHandles && (
+				<>
+					<rect
+						data-testid="selection.resize.top-left"
+						className={classNames('tl-corner-handle', {
+							'tl-hidden': hideTopLeftCorner,
+						})}
+						aria-label="top_left handle"
+						x={toDomPrecision(0 - size / 2)}
+						y={toDomPrecision(0 - size / 2)}
+						width={toDomPrecision(size)}
+						height={toDomPrecision(size)}
+					/>
+					<rect
+						data-testid="selection.resize.top-right"
+						className={classNames('tl-corner-handle', {
+							'tl-hidden': hideTopRightCorner,
+						})}
+						aria-label="top_right handle"
+						x={toDomPrecision(width - size / 2)}
+						y={toDomPrecision(0 - size / 2)}
+						width={toDomPrecision(size)}
+						height={toDomPrecision(size)}
+					/>
+					<rect
+						data-testid="selection.resize.bottom-right"
+						className={classNames('tl-corner-handle', {
+							'tl-hidden': hideBottomRightCorner,
+						})}
+						aria-label="bottom_right handle"
+						x={toDomPrecision(width - size / 2)}
+						y={toDomPrecision(height - size / 2)}
+						width={toDomPrecision(size)}
+						height={toDomPrecision(size)}
+					/>
+					<rect
+						data-testid="selection.resize.bottom-left"
+						className={classNames('tl-corner-handle', {
+							'tl-hidden': hideBottomLeftCorner,
+						})}
+						aria-label="bottom_left handle"
+						x={toDomPrecision(0 - size / 2)}
+						y={toDomPrecision(height - size / 2)}
+						width={toDomPrecision(size)}
+						height={toDomPrecision(size)}
+					/>
+				</>
+			)}
+			{showTextResizeHandles && (
+				<>
+					<rect
+						data-testid="selection.text-resize.left.handle"
+						className="tl-text-handle"
+						aria-label="bottom_left handle"
+						x={toDomPrecision(0 - size / 4)}
+						y={toDomPrecision(height / 2 - textHandleHeight / 2)}
+						rx={size / 4}
+						width={toDomPrecision(size / 2)}
+						height={toDomPrecision(textHandleHeight)}
+					/>
+					<rect
+						data-testid="selection.text-resize.right.handle"
+						className="tl-text-handle"
+						aria-label="bottom_left handle"
+						rx={size / 4}
+						x={toDomPrecision(width - size / 4)}
+						y={toDomPrecision(height / 2 - textHandleHeight / 2)}
+						width={toDomPrecision(size / 2)}
+						height={toDomPrecision(textHandleHeight)}
+					/>
+				</>
+			)}
+			{/* Crop Handles */}
+			{showCropHandles && (
+				<CropHandles
+					{...{
+						size,
+						width,
+						height,
+						hideAlternateHandles: hideAlternateCropHandles,
+					}}
+				/>
+			)}
+		</svg>
+	)
+})
+
+export const RotateCornerHandle = function RotateCornerHandle({
+	cx,
+	cy,
+	targetSize,
+	corner,
+	cursor,
+	isHidden,
+	'data-testid': testId,
+}: {
+	cx: number
+	cy: number
+	targetSize: number
+	corner: RotateCorner
+	cursor?: string
+	isHidden: boolean
+	'data-testid'?: string
+}) {
+	const events = useSelectionEvents(corner)
+	return (
+		<rect
+			className={classNames('tl-transparent', 'tl-rotate-corner', { 'tl-hidden': isHidden })}
+			data-testid={testId}
+			aria-label={`${corner} target`}
+			pointerEvents="all"
+			x={toDomPrecision(cx - targetSize * 3)}
+			y={toDomPrecision(cy - targetSize * 3)}
+			width={toDomPrecision(Math.max(1, targetSize * 3))}
+			height={toDomPrecision(Math.max(1, targetSize * 3))}
+			cursor={cursor}
+			{...events}
+		/>
+	)
+}
+
+const SQUARE_ROOT_PI = Math.sqrt(Math.PI)
+
+export const MobileRotateHandle = function RotateHandle({
+	cx,
+	cy,
+	size,
+	isHidden,
+	'data-testid': testId,
+}: {
+	cx: number
+	cy: number
+	size: number
+	isHidden: boolean
+	'data-testid'?: string
+}) {
+	const events = useSelectionEvents('mobile_rotate')
+
+	return (
+		<g>
+			<circle
+				data-testid={testId}
+				pointerEvents="all"
+				className={classNames('tl-transparent', 'tl-mobile-rotate__bg', { 'tl-hidden': isHidden })}
+				cx={cx}
+				cy={cy}
+				{...events}
+			/>
+			<circle
+				className={classNames('tl-mobile-rotate__fg', { 'tl-hidden': isHidden })}
+				cx={cx}
+				cy={cy}
+				r={size / SQUARE_ROOT_PI}
+			/>
+		</g>
+	)
+}

commit 3e31ef2a7d01467ef92ca4f7aed13ee708db73ef
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Tue Jul 18 22:50:23 2023 +0100

    Remove helpers / extraneous API methods. (#1745)
    
    This PR removes several extraneous computed values from the editor. It
    adds some silly instance state onto the instance state record and
    unifies a few methods which were inconsistent. This is fit and finish
    work üßΩ
    
    ## Computed Values
    
    In general, where once we had a getter and setter for `isBlahMode`,
    which really masked either an `_isBlahMode` atom on the editor or
    `instanceState.isBlahMode`, these are merged into `instanceState`; they
    can be accessed / updated via `editor.instanceState` /
    `editor.updateInstanceState`.
    
    ## tldraw select tool specific things
    
    This PR also removes some tldraw specific state checks and creates new
    component overrides to allow us to include them in tldraw/tldraw.
    
    ### Change Type
    
    - [x] `major` ‚Äî Breaking change
    
    ### Test Plan
    
    - [x] Unit Tests
    - [x] End to end tests
    
    ### Release Notes
    
    - [tldraw] rename `useReadonly` to `useReadOnly`
    - [editor] remove `Editor.isDarkMode`
    - [editor] remove `Editor.isChangingStyle`
    - [editor] remove `Editor.isCoarsePointer`
    - [editor] remove `Editor.isDarkMode`
    - [editor] remove `Editor.isFocused`
    - [editor] remove `Editor.isGridMode`
    - [editor] remove `Editor.isPenMode`
    - [editor] remove `Editor.isReadOnly`
    - [editor] remove `Editor.isSnapMode`
    - [editor] remove `Editor.isToolLocked`
    - [editor] remove `Editor.locale`
    - [editor] rename `Editor.pageState` to `Editor.currentPageState`
    - [editor] add `Editor.pageStates`
    - [editor] add `Editor.setErasingIds`
    - [editor] add `Editor.setEditingId`
    - [editor] add several new component overrides

diff --git a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
index ee357367f..0912fdd89 100644
--- a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
+++ b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
@@ -1,6 +1,7 @@
 import {
 	RotateCorner,
 	TLEmbedShape,
+	TLSelectionForegroundComponent,
 	TLTextShape,
 	getCursor,
 	toDomPrecision,
@@ -11,6 +12,7 @@ import {
 } from '@tldraw/editor'
 import classNames from 'classnames'
 import { useRef } from 'react'
+import { useReadOnly } from '../ui/hooks/useReadOnly'
 import { CropHandles } from './CropHandles'
 
 const IS_FIREFOX =
@@ -18,437 +20,440 @@ const IS_FIREFOX =
 	navigator.userAgent &&
 	navigator.userAgent.toLowerCase().indexOf('firefox') > -1
 
-export const TldrawSelectionForeground = track(function SelectionFg() {
-	const editor = useEditor()
-	const rSvg = useRef<SVGSVGElement>(null)
-
-	const isReadonlyMode = editor.isReadOnly
-	const topEvents = useSelectionEvents('top')
-	const rightEvents = useSelectionEvents('right')
-	const bottomEvents = useSelectionEvents('bottom')
-	const leftEvents = useSelectionEvents('left')
-	const topLeftEvents = useSelectionEvents('top_left')
-	const topRightEvents = useSelectionEvents('top_right')
-	const bottomRightEvents = useSelectionEvents('bottom_right')
-	const bottomLeftEvents = useSelectionEvents('bottom_left')
-
-	const isDefaultCursor = !editor.isMenuOpen && editor.cursor.type === 'default'
-	const isCoarsePointer = editor.isCoarsePointer
-
-	let bounds = editor.selectionBounds
-	const shapes = editor.selectedShapes
-	const onlyShape = editor.onlySelectedShape
-	const isLockedShape = onlyShape && editor.isShapeOrAncestorLocked(onlyShape)
-
-	// if all shapes have an expandBy for the selection outline, we can expand by the l
-	const expandOutlineBy = onlyShape
-		? editor.getShapeUtil(onlyShape).expandSelectionOutlinePx(onlyShape)
-		: 0
-
-	useTransform(rSvg, bounds?.x, bounds?.y, 1, editor.selectionRotation, {
-		x: -expandOutlineBy,
-		y: -expandOutlineBy,
-	})
-
-	if (!bounds) return null
-	bounds = bounds.clone().expandBy(expandOutlineBy)
-
-	const zoom = editor.zoomLevel
-	const rotation = editor.selectionRotation
-	const isChangingStyles = editor.isChangingStyle
-
-	const width = Math.max(1, bounds.width)
-	const height = Math.max(1, bounds.height)
-
-	const size = 8 / zoom
-	const isTinyX = width < size * 2
-	const isTinyY = height < size * 2
-
-	const isSmallX = width < size * 4
-	const isSmallY = height < size * 4
-	const isSmallCropX = width < size * 5
-	const isSmallCropY = height < size * 5
-
-	const mobileHandleMultiplier = isCoarsePointer ? 1.75 : 1
-	const targetSize = (6 / zoom) * mobileHandleMultiplier
-
-	const targetSizeX = (isSmallX ? targetSize / 2 : targetSize) * (mobileHandleMultiplier * 0.75)
-	const targetSizeY = (isSmallY ? targetSize / 2 : targetSize) * (mobileHandleMultiplier * 0.75)
-
-	const showSelectionBounds =
-		(onlyShape ? !editor.getShapeUtil(onlyShape).hideSelectionBoundsFg(onlyShape) : true) &&
-		!isChangingStyles
-
-	let shouldDisplayBox =
-		(showSelectionBounds &&
+export const TldrawSelectionForeground: TLSelectionForegroundComponent = track(
+	function SelectionFg() {
+		const editor = useEditor()
+		const rSvg = useRef<SVGSVGElement>(null)
+
+		const isReadonlyMode = useReadOnly()
+		const topEvents = useSelectionEvents('top')
+		const rightEvents = useSelectionEvents('right')
+		const bottomEvents = useSelectionEvents('bottom')
+		const leftEvents = useSelectionEvents('left')
+		const topLeftEvents = useSelectionEvents('top_left')
+		const topRightEvents = useSelectionEvents('top_right')
+		const bottomRightEvents = useSelectionEvents('bottom_right')
+		const bottomLeftEvents = useSelectionEvents('bottom_left')
+
+		const isDefaultCursor = !editor.isMenuOpen && editor.instanceState.cursor.type === 'default'
+		const isCoarsePointer = editor.instanceState.isCoarsePointer
+
+		let bounds = editor.selectionBounds
+		const shapes = editor.selectedShapes
+		const onlyShape = editor.onlySelectedShape
+		const isLockedShape = onlyShape && editor.isShapeOrAncestorLocked(onlyShape)
+
+		// if all shapes have an expandBy for the selection outline, we can expand by the l
+		const expandOutlineBy = onlyShape
+			? editor.getShapeUtil(onlyShape).expandSelectionOutlinePx(onlyShape)
+			: 0
+
+		useTransform(rSvg, bounds?.x, bounds?.y, 1, editor.selectionRotation, {
+			x: -expandOutlineBy,
+			y: -expandOutlineBy,
+		})
+
+		if (!bounds) return null
+		bounds = bounds.clone().expandBy(expandOutlineBy)
+
+		const zoom = editor.zoomLevel
+		const rotation = editor.selectionRotation
+		const isChangingStyle = editor.instanceState.isChangingStyle
+
+		const width = Math.max(1, bounds.width)
+		const height = Math.max(1, bounds.height)
+
+		const size = 8 / zoom
+		const isTinyX = width < size * 2
+		const isTinyY = height < size * 2
+
+		const isSmallX = width < size * 4
+		const isSmallY = height < size * 4
+		const isSmallCropX = width < size * 5
+		const isSmallCropY = height < size * 5
+
+		const mobileHandleMultiplier = isCoarsePointer ? 1.75 : 1
+		const targetSize = (6 / zoom) * mobileHandleMultiplier
+
+		const targetSizeX = (isSmallX ? targetSize / 2 : targetSize) * (mobileHandleMultiplier * 0.75)
+		const targetSizeY = (isSmallY ? targetSize / 2 : targetSize) * (mobileHandleMultiplier * 0.75)
+
+		const showSelectionBounds =
+			(onlyShape ? !editor.getShapeUtil(onlyShape).hideSelectionBoundsFg(onlyShape) : true) &&
+			!isChangingStyle
+
+		let shouldDisplayBox =
+			(showSelectionBounds &&
+				editor.isInAny(
+					'select.idle',
+					'select.brushing',
+					'select.scribble_brushing',
+					'select.pointing_canvas',
+					'select.pointing_selection',
+					'select.pointing_shape',
+					'select.crop.idle',
+					'select.crop.pointing_crop',
+					'select.pointing_resize_handle',
+					'select.pointing_crop_handle',
+					'select.editing_shape'
+				)) ||
+			(showSelectionBounds &&
+				editor.isIn('select.resizing') &&
+				onlyShape &&
+				editor.isShapeOfType<TLTextShape>(onlyShape, 'text'))
+
+		if (
+			onlyShape &&
+			editor.isShapeOfType<TLEmbedShape>(onlyShape, 'embed') &&
+			shouldDisplayBox &&
+			IS_FIREFOX
+		) {
+			shouldDisplayBox = false
+		}
+
+		const showCropHandles =
+			editor.isInAny(
+				'select.pointing_crop_handle',
+				'select.crop.idle',
+				'select.crop.pointing_crop'
+			) &&
+			!isChangingStyle &&
+			!isReadonlyMode
+
+		const shouldDisplayControls =
 			editor.isInAny(
 				'select.idle',
-				'select.brushing',
-				'select.scribble_brushing',
-				'select.pointing_canvas',
 				'select.pointing_selection',
 				'select.pointing_shape',
-				'select.crop.idle',
-				'select.crop.pointing_crop',
-				'select.pointing_resize_handle',
-				'select.pointing_crop_handle',
-				'select.editing_shape'
-			)) ||
-		(showSelectionBounds &&
-			editor.isIn('select.resizing') &&
+				'select.crop.idle'
+			) &&
+			!isChangingStyle &&
+			!isReadonlyMode
+
+		const showCornerRotateHandles =
+			!isCoarsePointer &&
+			!(isTinyX || isTinyY) &&
+			(shouldDisplayControls || showCropHandles) &&
+			(onlyShape ? !editor.getShapeUtil(onlyShape).hideRotateHandle(onlyShape) : true) &&
+			!isLockedShape
+
+		const showMobileRotateHandle =
+			isCoarsePointer &&
+			(!isSmallX || !isSmallY) &&
+			(shouldDisplayControls || showCropHandles) &&
+			(onlyShape ? !editor.getShapeUtil(onlyShape).hideRotateHandle(onlyShape) : true) &&
+			!isLockedShape
+
+		const showResizeHandles =
+			shouldDisplayControls &&
+			(onlyShape
+				? editor.getShapeUtil(onlyShape).canResize(onlyShape) &&
+				  !editor.getShapeUtil(onlyShape).hideResizeHandles(onlyShape)
+				: true) &&
+			!showCropHandles &&
+			!isLockedShape
+
+		const hideAlternateCornerHandles = isTinyX || isTinyY
+		const showOnlyOneHandle = isTinyX && isTinyY
+		const hideAlternateCropHandles = isSmallCropX || isSmallCropY
+
+		const showHandles = showResizeHandles || showCropHandles
+		const hideRotateCornerHandles = !showCornerRotateHandles
+		const hideMobileRotateHandle = !shouldDisplayControls || !showMobileRotateHandle
+		const hideTopLeftCorner = !shouldDisplayControls || !showHandles
+		const hideTopRightCorner = !shouldDisplayControls || !showHandles || hideAlternateCornerHandles
+		const hideBottomLeftCorner =
+			!shouldDisplayControls || !showHandles || hideAlternateCornerHandles
+		const hideBottomRightCorner =
+			!shouldDisplayControls || !showHandles || (showOnlyOneHandle && !showCropHandles)
+
+		let hideEdgeTargetsDueToCoarsePointer = isCoarsePointer
+
+		if (
+			hideEdgeTargetsDueToCoarsePointer &&
+			shapes.every((shape) => editor.getShapeUtil(shape).isAspectRatioLocked(shape))
+		) {
+			hideEdgeTargetsDueToCoarsePointer = false
+		}
+
+		// If we're showing crop handles, then show the edges too.
+		// If we're showing resize handles, then show the edges only
+		// if we're not hiding them for some other reason
+		let hideEdgeTargets = true
+
+		if (showCropHandles) {
+			hideEdgeTargets = hideAlternateCropHandles
+		} else if (showResizeHandles) {
+			hideEdgeTargets =
+				hideAlternateCornerHandles || showOnlyOneHandle || hideEdgeTargetsDueToCoarsePointer
+		}
+
+		const textHandleHeight = Math.min(24 / zoom, height - targetSizeY * 3)
+		const showTextResizeHandles =
+			shouldDisplayControls &&
+			isCoarsePointer &&
 			onlyShape &&
-			editor.isShapeOfType<TLTextShape>(onlyShape, 'text'))
-
-	if (
-		onlyShape &&
-		editor.isShapeOfType<TLEmbedShape>(onlyShape, 'embed') &&
-		shouldDisplayBox &&
-		IS_FIREFOX
-	) {
-		shouldDisplayBox = false
-	}
-
-	const showCropHandles =
-		editor.isInAny(
-			'select.pointing_crop_handle',
-			'select.crop.idle',
-			'select.crop.pointing_crop'
-		) &&
-		!isChangingStyles &&
-		!isReadonlyMode
-
-	const shouldDisplayControls =
-		editor.isInAny(
-			'select.idle',
-			'select.pointing_selection',
-			'select.pointing_shape',
-			'select.crop.idle'
-		) &&
-		!isChangingStyles &&
-		!isReadonlyMode
-
-	const showCornerRotateHandles =
-		!isCoarsePointer &&
-		!(isTinyX || isTinyY) &&
-		(shouldDisplayControls || showCropHandles) &&
-		(onlyShape ? !editor.getShapeUtil(onlyShape).hideRotateHandle(onlyShape) : true) &&
-		!isLockedShape
-
-	const showMobileRotateHandle =
-		isCoarsePointer &&
-		(!isSmallX || !isSmallY) &&
-		(shouldDisplayControls || showCropHandles) &&
-		(onlyShape ? !editor.getShapeUtil(onlyShape).hideRotateHandle(onlyShape) : true) &&
-		!isLockedShape
-
-	const showResizeHandles =
-		shouldDisplayControls &&
-		(onlyShape
-			? editor.getShapeUtil(onlyShape).canResize(onlyShape) &&
-			  !editor.getShapeUtil(onlyShape).hideResizeHandles(onlyShape)
-			: true) &&
-		!showCropHandles &&
-		!isLockedShape
-
-	const hideAlternateCornerHandles = isTinyX || isTinyY
-	const showOnlyOneHandle = isTinyX && isTinyY
-	const hideAlternateCropHandles = isSmallCropX || isSmallCropY
-
-	const showHandles = showResizeHandles || showCropHandles
-	const hideRotateCornerHandles = !showCornerRotateHandles
-	const hideMobileRotateHandle = !shouldDisplayControls || !showMobileRotateHandle
-	const hideTopLeftCorner = !shouldDisplayControls || !showHandles
-	const hideTopRightCorner = !shouldDisplayControls || !showHandles || hideAlternateCornerHandles
-	const hideBottomLeftCorner = !shouldDisplayControls || !showHandles || hideAlternateCornerHandles
-	const hideBottomRightCorner =
-		!shouldDisplayControls || !showHandles || (showOnlyOneHandle && !showCropHandles)
-
-	let hideEdgeTargetsDueToCoarsePointer = isCoarsePointer
-
-	if (
-		hideEdgeTargetsDueToCoarsePointer &&
-		shapes.every((shape) => editor.getShapeUtil(shape).isAspectRatioLocked(shape))
-	) {
-		hideEdgeTargetsDueToCoarsePointer = false
-	}
-
-	// If we're showing crop handles, then show the edges too.
-	// If we're showing resize handles, then show the edges only
-	// if we're not hiding them for some other reason
-	let hideEdgeTargets = true
-
-	if (showCropHandles) {
-		hideEdgeTargets = hideAlternateCropHandles
-	} else if (showResizeHandles) {
-		hideEdgeTargets =
-			hideAlternateCornerHandles || showOnlyOneHandle || hideEdgeTargetsDueToCoarsePointer
-	}
-
-	const textHandleHeight = Math.min(24 / zoom, height - targetSizeY * 3)
-	const showTextResizeHandles =
-		shouldDisplayControls &&
-		isCoarsePointer &&
-		onlyShape &&
-		editor.isShapeOfType<TLTextShape>(onlyShape, 'text') &&
-		textHandleHeight * zoom >= 4
-
-	return (
-		<svg
-			ref={rSvg}
-			className="tl-overlays__item tl-selection__fg"
-			data-testid="selection-foreground"
-		>
-			{shouldDisplayBox && (
-				<rect
-					className={classNames('tl-selection__fg__outline')}
-					width={toDomPrecision(width)}
-					height={toDomPrecision(height)}
-				/>
-			)}
-			<RotateCornerHandle
-				data-testid="selection.rotate.top-left"
-				cx={0}
-				cy={0}
-				targetSize={targetSize}
-				corner="top_left_rotate"
-				cursor={isDefaultCursor ? getCursor('nwse-rotate', rotation) : undefined}
-				isHidden={hideRotateCornerHandles}
-			/>
-			<RotateCornerHandle
-				data-testid="selection.rotate.top-right"
-				cx={width + targetSize * 3}
-				cy={0}
-				targetSize={targetSize}
-				corner="top_right_rotate"
-				cursor={isDefaultCursor ? getCursor('nesw-rotate', rotation) : undefined}
-				isHidden={hideRotateCornerHandles}
-			/>
-			<RotateCornerHandle
-				data-testid="selection.rotate.bottom-left"
-				cx={0}
-				cy={height + targetSize * 3}
-				targetSize={targetSize}
-				corner="bottom_left_rotate"
-				cursor={isDefaultCursor ? getCursor('swne-rotate', rotation) : undefined}
-				isHidden={hideRotateCornerHandles}
-			/>
-			<RotateCornerHandle
-				data-testid="selection.rotate.bottom-right"
-				cx={width + targetSize * 3}
-				cy={height + targetSize * 3}
-				targetSize={targetSize}
-				corner="bottom_right_rotate"
-				cursor={isDefaultCursor ? getCursor('senw-rotate', rotation) : undefined}
-				isHidden={hideRotateCornerHandles}
-			/>{' '}
-			<MobileRotateHandle
-				data-testid="selection.rotate.mobile"
-				cx={isSmallX ? -targetSize * 1.5 : width / 2}
-				cy={isSmallX ? height / 2 : -targetSize * 1.5}
-				size={size}
-				isHidden={hideMobileRotateHandle}
-			/>
-			{/* Targets */}
-			<rect
-				className={classNames('tl-transparent', {
-					'tl-hidden': hideEdgeTargets,
-				})}
-				data-testid="selection.resize.top"
-				aria-label="top target"
-				pointerEvents="all"
-				x={0}
-				y={toDomPrecision(0 - (isSmallY ? targetSizeY * 2 : targetSizeY))}
-				width={toDomPrecision(Math.max(1, width))}
-				height={toDomPrecision(Math.max(1, targetSizeY * 2))}
-				style={isDefaultCursor ? { cursor: getCursor('ns-resize', rotation) } : undefined}
-				{...topEvents}
-			/>
-			<rect
-				className={classNames('tl-transparent', {
-					'tl-hidden': hideEdgeTargets,
-				})}
-				data-testid="selection.resize.right"
-				aria-label="right target"
-				pointerEvents="all"
-				x={toDomPrecision(width - (isSmallX ? 0 : targetSizeX))}
-				y={0}
-				height={toDomPrecision(Math.max(1, height))}
-				width={toDomPrecision(Math.max(1, targetSizeX * 2))}
-				style={isDefaultCursor ? { cursor: getCursor('ew-resize', rotation) } : undefined}
-				{...rightEvents}
-			/>
-			<rect
-				className={classNames('tl-transparent', {
-					'tl-hidden': hideEdgeTargets,
-				})}
-				data-testid="selection.resize.bottom"
-				aria-label="bottom target"
-				pointerEvents="all"
-				x={0}
-				y={toDomPrecision(height - (isSmallY ? 0 : targetSizeY))}
-				width={toDomPrecision(Math.max(1, width))}
-				height={toDomPrecision(Math.max(1, targetSizeY * 2))}
-				style={isDefaultCursor ? { cursor: getCursor('ns-resize', rotation) } : undefined}
-				{...bottomEvents}
-			/>
-			<rect
-				className={classNames('tl-transparent', {
-					'tl-hidden': hideEdgeTargets,
-				})}
-				data-testid="selection.resize.left"
-				aria-label="left target"
-				pointerEvents="all"
-				x={toDomPrecision(0 - (isSmallX ? targetSizeX * 2 : targetSizeX))}
-				y={0}
-				height={toDomPrecision(Math.max(1, height))}
-				width={toDomPrecision(Math.max(1, targetSizeX * 2))}
-				style={isDefaultCursor ? { cursor: getCursor('ew-resize', rotation) } : undefined}
-				{...leftEvents}
-			/>
-			{/* Corner Targets */}
-			<rect
-				className={classNames('tl-transparent', {
-					'tl-hidden': hideTopLeftCorner,
-				})}
-				data-testid="selection.target.top-left"
-				aria-label="top-left target"
-				pointerEvents="all"
-				x={toDomPrecision(0 - (isSmallX ? targetSizeX * 2 : targetSizeX * 1.5))}
-				y={toDomPrecision(0 - (isSmallY ? targetSizeY * 2 : targetSizeY * 1.5))}
-				width={toDomPrecision(targetSizeX * 3)}
-				height={toDomPrecision(targetSizeY * 3)}
-				style={isDefaultCursor ? { cursor: getCursor('nwse-resize', rotation) } : undefined}
-				{...topLeftEvents}
-			/>
-			<rect
-				className={classNames('tl-transparent', {
-					'tl-hidden': hideTopRightCorner,
-				})}
-				data-testid="selection.target.top-right"
-				aria-label="top-right target"
-				pointerEvents="all"
-				x={toDomPrecision(width - (isSmallX ? 0 : targetSizeX * 1.5))}
-				y={toDomPrecision(0 - (isSmallY ? targetSizeY * 2 : targetSizeY * 1.5))}
-				width={toDomPrecision(targetSizeX * 3)}
-				height={toDomPrecision(targetSizeY * 3)}
-				style={isDefaultCursor ? { cursor: getCursor('nesw-resize', rotation) } : undefined}
-				{...topRightEvents}
-			/>
-			<rect
-				className={classNames('tl-transparent', {
-					'tl-hidden': hideBottomRightCorner,
-				})}
-				data-testid="selection.target.bottom-right"
-				aria-label="bottom-right target"
-				pointerEvents="all"
-				x={toDomPrecision(width - (isSmallX ? targetSizeX : targetSizeX * 1.5))}
-				y={toDomPrecision(height - (isSmallY ? targetSizeY : targetSizeY * 1.5))}
-				width={toDomPrecision(targetSizeX * 3)}
-				height={toDomPrecision(targetSizeY * 3)}
-				style={isDefaultCursor ? { cursor: getCursor('nwse-resize', rotation) } : undefined}
-				{...bottomRightEvents}
-			/>
-			<rect
-				className={classNames('tl-transparent', {
-					'tl-hidden': hideBottomLeftCorner,
-				})}
-				data-testid="selection.target.bottom-left"
-				aria-label="bottom-left target"
-				pointerEvents="all"
-				x={toDomPrecision(0 - (isSmallX ? targetSizeX * 3 : targetSizeX * 1.5))}
-				y={toDomPrecision(height - (isSmallY ? 0 : targetSizeY * 1.5))}
-				width={toDomPrecision(targetSizeX * 3)}
-				height={toDomPrecision(targetSizeY * 3)}
-				style={isDefaultCursor ? { cursor: getCursor('nesw-resize', rotation) } : undefined}
-				{...bottomLeftEvents}
-			/>
-			{/* Resize Handles */}
-			{showResizeHandles && (
-				<>
-					<rect
-						data-testid="selection.resize.top-left"
-						className={classNames('tl-corner-handle', {
-							'tl-hidden': hideTopLeftCorner,
-						})}
-						aria-label="top_left handle"
-						x={toDomPrecision(0 - size / 2)}
-						y={toDomPrecision(0 - size / 2)}
-						width={toDomPrecision(size)}
-						height={toDomPrecision(size)}
-					/>
-					<rect
-						data-testid="selection.resize.top-right"
-						className={classNames('tl-corner-handle', {
-							'tl-hidden': hideTopRightCorner,
-						})}
-						aria-label="top_right handle"
-						x={toDomPrecision(width - size / 2)}
-						y={toDomPrecision(0 - size / 2)}
-						width={toDomPrecision(size)}
-						height={toDomPrecision(size)}
-					/>
-					<rect
-						data-testid="selection.resize.bottom-right"
-						className={classNames('tl-corner-handle', {
-							'tl-hidden': hideBottomRightCorner,
-						})}
-						aria-label="bottom_right handle"
-						x={toDomPrecision(width - size / 2)}
-						y={toDomPrecision(height - size / 2)}
-						width={toDomPrecision(size)}
-						height={toDomPrecision(size)}
-					/>
+			editor.isShapeOfType<TLTextShape>(onlyShape, 'text') &&
+			textHandleHeight * zoom >= 4
+
+		return (
+			<svg
+				ref={rSvg}
+				className="tl-overlays__item tl-selection__fg"
+				data-testid="selection-foreground"
+			>
+				{shouldDisplayBox && (
 					<rect
-						data-testid="selection.resize.bottom-left"
-						className={classNames('tl-corner-handle', {
-							'tl-hidden': hideBottomLeftCorner,
-						})}
-						aria-label="bottom_left handle"
-						x={toDomPrecision(0 - size / 2)}
-						y={toDomPrecision(height - size / 2)}
-						width={toDomPrecision(size)}
-						height={toDomPrecision(size)}
+						className={classNames('tl-selection__fg__outline')}
+						width={toDomPrecision(width)}
+						height={toDomPrecision(height)}
 					/>
-				</>
-			)}
-			{showTextResizeHandles && (
-				<>
-					<rect
-						data-testid="selection.text-resize.left.handle"
-						className="tl-text-handle"
-						aria-label="bottom_left handle"
-						x={toDomPrecision(0 - size / 4)}
-						y={toDomPrecision(height / 2 - textHandleHeight / 2)}
-						rx={size / 4}
-						width={toDomPrecision(size / 2)}
-						height={toDomPrecision(textHandleHeight)}
-					/>
-					<rect
-						data-testid="selection.text-resize.right.handle"
-						className="tl-text-handle"
-						aria-label="bottom_left handle"
-						rx={size / 4}
-						x={toDomPrecision(width - size / 4)}
-						y={toDomPrecision(height / 2 - textHandleHeight / 2)}
-						width={toDomPrecision(size / 2)}
-						height={toDomPrecision(textHandleHeight)}
-					/>
-				</>
-			)}
-			{/* Crop Handles */}
-			{showCropHandles && (
-				<CropHandles
-					{...{
-						size,
-						width,
-						height,
-						hideAlternateHandles: hideAlternateCropHandles,
-					}}
+				)}
+				<RotateCornerHandle
+					data-testid="selection.rotate.top-left"
+					cx={0}
+					cy={0}
+					targetSize={targetSize}
+					corner="top_left_rotate"
+					cursor={isDefaultCursor ? getCursor('nwse-rotate', rotation) : undefined}
+					isHidden={hideRotateCornerHandles}
 				/>
-			)}
-		</svg>
-	)
-})
+				<RotateCornerHandle
+					data-testid="selection.rotate.top-right"
+					cx={width + targetSize * 3}
+					cy={0}
+					targetSize={targetSize}
+					corner="top_right_rotate"
+					cursor={isDefaultCursor ? getCursor('nesw-rotate', rotation) : undefined}
+					isHidden={hideRotateCornerHandles}
+				/>
+				<RotateCornerHandle
+					data-testid="selection.rotate.bottom-left"
+					cx={0}
+					cy={height + targetSize * 3}
+					targetSize={targetSize}
+					corner="bottom_left_rotate"
+					cursor={isDefaultCursor ? getCursor('swne-rotate', rotation) : undefined}
+					isHidden={hideRotateCornerHandles}
+				/>
+				<RotateCornerHandle
+					data-testid="selection.rotate.bottom-right"
+					cx={width + targetSize * 3}
+					cy={height + targetSize * 3}
+					targetSize={targetSize}
+					corner="bottom_right_rotate"
+					cursor={isDefaultCursor ? getCursor('senw-rotate', rotation) : undefined}
+					isHidden={hideRotateCornerHandles}
+				/>{' '}
+				<MobileRotateHandle
+					data-testid="selection.rotate.mobile"
+					cx={isSmallX ? -targetSize * 1.5 : width / 2}
+					cy={isSmallX ? height / 2 : -targetSize * 1.5}
+					size={size}
+					isHidden={hideMobileRotateHandle}
+				/>
+				{/* Targets */}
+				<rect
+					className={classNames('tl-transparent', {
+						'tl-hidden': hideEdgeTargets,
+					})}
+					data-testid="selection.resize.top"
+					aria-label="top target"
+					pointerEvents="all"
+					x={0}
+					y={toDomPrecision(0 - (isSmallY ? targetSizeY * 2 : targetSizeY))}
+					width={toDomPrecision(Math.max(1, width))}
+					height={toDomPrecision(Math.max(1, targetSizeY * 2))}
+					style={isDefaultCursor ? { cursor: getCursor('ns-resize', rotation) } : undefined}
+					{...topEvents}
+				/>
+				<rect
+					className={classNames('tl-transparent', {
+						'tl-hidden': hideEdgeTargets,
+					})}
+					data-testid="selection.resize.right"
+					aria-label="right target"
+					pointerEvents="all"
+					x={toDomPrecision(width - (isSmallX ? 0 : targetSizeX))}
+					y={0}
+					height={toDomPrecision(Math.max(1, height))}
+					width={toDomPrecision(Math.max(1, targetSizeX * 2))}
+					style={isDefaultCursor ? { cursor: getCursor('ew-resize', rotation) } : undefined}
+					{...rightEvents}
+				/>
+				<rect
+					className={classNames('tl-transparent', {
+						'tl-hidden': hideEdgeTargets,
+					})}
+					data-testid="selection.resize.bottom"
+					aria-label="bottom target"
+					pointerEvents="all"
+					x={0}
+					y={toDomPrecision(height - (isSmallY ? 0 : targetSizeY))}
+					width={toDomPrecision(Math.max(1, width))}
+					height={toDomPrecision(Math.max(1, targetSizeY * 2))}
+					style={isDefaultCursor ? { cursor: getCursor('ns-resize', rotation) } : undefined}
+					{...bottomEvents}
+				/>
+				<rect
+					className={classNames('tl-transparent', {
+						'tl-hidden': hideEdgeTargets,
+					})}
+					data-testid="selection.resize.left"
+					aria-label="left target"
+					pointerEvents="all"
+					x={toDomPrecision(0 - (isSmallX ? targetSizeX * 2 : targetSizeX))}
+					y={0}
+					height={toDomPrecision(Math.max(1, height))}
+					width={toDomPrecision(Math.max(1, targetSizeX * 2))}
+					style={isDefaultCursor ? { cursor: getCursor('ew-resize', rotation) } : undefined}
+					{...leftEvents}
+				/>
+				{/* Corner Targets */}
+				<rect
+					className={classNames('tl-transparent', {
+						'tl-hidden': hideTopLeftCorner,
+					})}
+					data-testid="selection.target.top-left"
+					aria-label="top-left target"
+					pointerEvents="all"
+					x={toDomPrecision(0 - (isSmallX ? targetSizeX * 2 : targetSizeX * 1.5))}
+					y={toDomPrecision(0 - (isSmallY ? targetSizeY * 2 : targetSizeY * 1.5))}
+					width={toDomPrecision(targetSizeX * 3)}
+					height={toDomPrecision(targetSizeY * 3)}
+					style={isDefaultCursor ? { cursor: getCursor('nwse-resize', rotation) } : undefined}
+					{...topLeftEvents}
+				/>
+				<rect
+					className={classNames('tl-transparent', {
+						'tl-hidden': hideTopRightCorner,
+					})}
+					data-testid="selection.target.top-right"
+					aria-label="top-right target"
+					pointerEvents="all"
+					x={toDomPrecision(width - (isSmallX ? 0 : targetSizeX * 1.5))}
+					y={toDomPrecision(0 - (isSmallY ? targetSizeY * 2 : targetSizeY * 1.5))}
+					width={toDomPrecision(targetSizeX * 3)}
+					height={toDomPrecision(targetSizeY * 3)}
+					style={isDefaultCursor ? { cursor: getCursor('nesw-resize', rotation) } : undefined}
+					{...topRightEvents}
+				/>
+				<rect
+					className={classNames('tl-transparent', {
+						'tl-hidden': hideBottomRightCorner,
+					})}
+					data-testid="selection.target.bottom-right"
+					aria-label="bottom-right target"
+					pointerEvents="all"
+					x={toDomPrecision(width - (isSmallX ? targetSizeX : targetSizeX * 1.5))}
+					y={toDomPrecision(height - (isSmallY ? targetSizeY : targetSizeY * 1.5))}
+					width={toDomPrecision(targetSizeX * 3)}
+					height={toDomPrecision(targetSizeY * 3)}
+					style={isDefaultCursor ? { cursor: getCursor('nwse-resize', rotation) } : undefined}
+					{...bottomRightEvents}
+				/>
+				<rect
+					className={classNames('tl-transparent', {
+						'tl-hidden': hideBottomLeftCorner,
+					})}
+					data-testid="selection.target.bottom-left"
+					aria-label="bottom-left target"
+					pointerEvents="all"
+					x={toDomPrecision(0 - (isSmallX ? targetSizeX * 3 : targetSizeX * 1.5))}
+					y={toDomPrecision(height - (isSmallY ? 0 : targetSizeY * 1.5))}
+					width={toDomPrecision(targetSizeX * 3)}
+					height={toDomPrecision(targetSizeY * 3)}
+					style={isDefaultCursor ? { cursor: getCursor('nesw-resize', rotation) } : undefined}
+					{...bottomLeftEvents}
+				/>
+				{/* Resize Handles */}
+				{showResizeHandles && (
+					<>
+						<rect
+							data-testid="selection.resize.top-left"
+							className={classNames('tl-corner-handle', {
+								'tl-hidden': hideTopLeftCorner,
+							})}
+							aria-label="top_left handle"
+							x={toDomPrecision(0 - size / 2)}
+							y={toDomPrecision(0 - size / 2)}
+							width={toDomPrecision(size)}
+							height={toDomPrecision(size)}
+						/>
+						<rect
+							data-testid="selection.resize.top-right"
+							className={classNames('tl-corner-handle', {
+								'tl-hidden': hideTopRightCorner,
+							})}
+							aria-label="top_right handle"
+							x={toDomPrecision(width - size / 2)}
+							y={toDomPrecision(0 - size / 2)}
+							width={toDomPrecision(size)}
+							height={toDomPrecision(size)}
+						/>
+						<rect
+							data-testid="selection.resize.bottom-right"
+							className={classNames('tl-corner-handle', {
+								'tl-hidden': hideBottomRightCorner,
+							})}
+							aria-label="bottom_right handle"
+							x={toDomPrecision(width - size / 2)}
+							y={toDomPrecision(height - size / 2)}
+							width={toDomPrecision(size)}
+							height={toDomPrecision(size)}
+						/>
+						<rect
+							data-testid="selection.resize.bottom-left"
+							className={classNames('tl-corner-handle', {
+								'tl-hidden': hideBottomLeftCorner,
+							})}
+							aria-label="bottom_left handle"
+							x={toDomPrecision(0 - size / 2)}
+							y={toDomPrecision(height - size / 2)}
+							width={toDomPrecision(size)}
+							height={toDomPrecision(size)}
+						/>
+					</>
+				)}
+				{showTextResizeHandles && (
+					<>
+						<rect
+							data-testid="selection.text-resize.left.handle"
+							className="tl-text-handle"
+							aria-label="bottom_left handle"
+							x={toDomPrecision(0 - size / 4)}
+							y={toDomPrecision(height / 2 - textHandleHeight / 2)}
+							rx={size / 4}
+							width={toDomPrecision(size / 2)}
+							height={toDomPrecision(textHandleHeight)}
+						/>
+						<rect
+							data-testid="selection.text-resize.right.handle"
+							className="tl-text-handle"
+							aria-label="bottom_left handle"
+							rx={size / 4}
+							x={toDomPrecision(width - size / 4)}
+							y={toDomPrecision(height / 2 - textHandleHeight / 2)}
+							width={toDomPrecision(size / 2)}
+							height={toDomPrecision(textHandleHeight)}
+						/>
+					</>
+				)}
+				{/* Crop Handles */}
+				{showCropHandles && (
+					<CropHandles
+						{...{
+							size,
+							width,
+							height,
+							hideAlternateHandles: hideAlternateCropHandles,
+						}}
+					/>
+				)}
+			</svg>
+		)
+	}
+)
 
 export const RotateCornerHandle = function RotateCornerHandle({
 	cx,

commit b22ea7cd4e6c27dcebd6615daa07116ecacbf554
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Wed Jul 19 11:52:21 2023 +0100

    More cleanup, focus bug fixes (#1749)
    
    This PR is another grab bag:
    - renames `readOnly` to `readonly` throughout editor
    - fixes a regression related to focus and keyboard shortcuts
    - adds a small outline for focused editors
    
    ### Change Type
    
    - [x] `major`
    
    ### Test Plan
    
    - [x] End to end tests

diff --git a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
index 0912fdd89..f2d66176f 100644
--- a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
+++ b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
@@ -12,7 +12,7 @@ import {
 } from '@tldraw/editor'
 import classNames from 'classnames'
 import { useRef } from 'react'
-import { useReadOnly } from '../ui/hooks/useReadOnly'
+import { useReadonly } from '../ui/hooks/useReadonly'
 import { CropHandles } from './CropHandles'
 
 const IS_FIREFOX =
@@ -25,7 +25,7 @@ export const TldrawSelectionForeground: TLSelectionForegroundComponent = track(
 		const editor = useEditor()
 		const rSvg = useRef<SVGSVGElement>(null)
 
-		const isReadonlyMode = useReadOnly()
+		const isReadonlyMode = useReadonly()
 		const topEvents = useSelectionEvents('top')
 		const rightEvents = useSelectionEvents('right')
 		const bottomEvents = useSelectionEvents('bottom')

commit d750da8f40efda4b011a91962ef8f30c63d1e5da
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Tue Jul 25 17:10:15 2023 +0100

    `ShapeUtil.getGeometry`, selection rewrite (#1751)
    
    This PR is a significant rewrite of our selection / hit testing logic.
    
    It
    - replaces our current geometric helpers (`getBounds`, `getOutline`,
    `hitTestPoint`, and `hitTestLineSegment`) with a new geometry API
    - moves our hit testing entirely to JS using geometry
    - improves selection logic, especially around editing shapes, groups and
    frames
    - fixes many minor selection bugs (e.g. shapes behind frames)
    - removes hit-testing DOM elements from ShapeFill etc.
    - adds many new tests around selection
    - adds new tests around selection
    - makes several superficial changes to surface editor APIs
    
    This PR is hard to evaluate. The `selection-omnibus` test suite is
    intended to describe all of the selection behavior, however all existing
    tests are also either here preserved and passing or (in a few cases
    around editing shapes) are modified to reflect the new behavior.
    
    ## Geometry
    
    All `ShapeUtils` implement `getGeometry`, which returns a single
    geometry primitive (`Geometry2d`). For example:
    
    ```ts
    class BoxyShapeUtil {
      getGeometry(shape: BoxyShape) {
        return new Rectangle2d({
            width: shape.props.width,
            height: shape.props.height,
            isFilled: true,
            margin: shape.props.strokeWidth
          })
        }
    }
    ```
    
    This geometric primitive is used for all bounds calculation, hit
    testing, intersection with arrows, etc.
    
    There are several geometric primitives that extend `Geometry2d`:
    - `Arc2d`
    - `Circle2d`
    - `CubicBezier2d`
    - `CubicSpline2d`
    - `Edge2d`
    - `Ellipse2d`
    - `Group2d`
    - `Polygon2d`
    - `Rectangle2d`
    - `Stadium2d`
    
    For shapes that have more complicated geometric representations, such as
    an arrow with a label, the `Group2d` can accept other primitives as its
    children.
    
    ## Hit testing
    
    Previously, we did all hit testing via events set on shapes and other
    elements. In this PR, I've replaced those hit tests with our own
    calculation for hit tests in JavaScript. This removed the need for many
    DOM elements, such as hit test area borders and fills which only existed
    to trigger pointer events.
    
    ## Selection
    
    We now support selecting "hollow" shapes by clicking inside of them.
    This involves a lot of new logic but it should work intuitively. See
    `Editor.getShapeAtPoint` for the (thoroughly commented) implementation.
    
    ![Kapture 2023-07-23 at 23 27
    27](https://github.com/tldraw/tldraw/assets/23072548/a743275c-acdb-42d9-a3fe-b3e20dce86b6)
    
    every sunset is actually the sun hiding in fear and respect of tldraw's
    quality of interactions
    
    This PR also fixes several bugs with scribble selection, in particular
    around the shift key modifier.
    
    ![Kapture 2023-07-24 at 23 34
    07](https://github.com/tldraw/tldraw/assets/23072548/871d67d0-8d06-42ae-a2b2-021effba37c5)
    
    ...as well as issues with labels and editing.
    
    There are **over 100 new tests** for selection covering groups, frames,
    brushing, scribbling, hovering, and editing. I'll add a few more before
    I feel comfortable merging this PR.
    
    ## Arrow binding
    
    Using the same "hollow shape" logic as selection, arrow binding is
    significantly improved.
    
    ![Kapture 2023-07-22 at 07 46
    25](https://github.com/tldraw/tldraw/assets/23072548/5aa724b3-b57d-4fb7-92d0-80e34246753c)
    
    a thousand wise men could not improve on this
    
    ## Moving focus between editing shapes
    
    Previously, this was handled in the `editing_shapes` state. This is
    moved to `useEditableText`, and should generally be considered an
    advanced implementation detail on a shape-by-shape basis. This addresses
    a bug that I'd never noticed before, but which can be reproduced by
    selecting an shape‚Äîbut not focusing its input‚Äîwhile editing a different
    shape. Previously, the new shape became the editing shape but its input
    did not focus.
    
    ![Kapture 2023-07-23 at 23 19
    09](https://github.com/tldraw/tldraw/assets/23072548/a5e157fb-24a8-42bd-a692-04ce769b1a9c)
    
    In this PR, you can select a shape by clicking on its edge or body, or
    select its input to transfer editing / focus.
    
    ![Kapture 2023-07-23 at 23 22
    21](https://github.com/tldraw/tldraw/assets/23072548/7384e7ea-9777-4e1a-8f63-15de2166a53a)
    
    tldraw, glorious tldraw
    
    ### Change Type
    
    - [x] `major` ‚Äî Breaking change
    
    ### Test Plan
    
    1. Erase shapes
    2. Select shapes
    3. Calculate their bounding boxes
    
    - [ ] Unit Tests // todo
    - [ ] End to end tests // todo
    
    ### Release Notes
    
    - [editor] Remove `ShapeUtil.getBounds`, `ShapeUtil.getOutline`,
    `ShapeUtil.hitTestPoint`, `ShapeUtil.hitTestLineSegment`
    - [editor] Add `ShapeUtil.getGeometry`
    - [editor] Add `Editor.getShapeGeometry`

diff --git a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
index f2d66176f..24a38aa15 100644
--- a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
+++ b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
@@ -21,7 +21,7 @@ const IS_FIREFOX =
 	navigator.userAgent.toLowerCase().indexOf('firefox') > -1
 
 export const TldrawSelectionForeground: TLSelectionForegroundComponent = track(
-	function SelectionFg() {
+	function TldrawSelectionForeground({ bounds, rotation }) {
 		const editor = useEditor()
 		const rSvg = useRef<SVGSVGElement>(null)
 
@@ -38,7 +38,6 @@ export const TldrawSelectionForeground: TLSelectionForegroundComponent = track(
 		const isDefaultCursor = !editor.isMenuOpen && editor.instanceState.cursor.type === 'default'
 		const isCoarsePointer = editor.instanceState.isCoarsePointer
 
-		let bounds = editor.selectionBounds
 		const shapes = editor.selectedShapes
 		const onlyShape = editor.onlySelectedShape
 		const isLockedShape = onlyShape && editor.isShapeOrAncestorLocked(onlyShape)
@@ -57,7 +56,6 @@ export const TldrawSelectionForeground: TLSelectionForegroundComponent = track(
 		bounds = bounds.clone().expandBy(expandOutlineBy)
 
 		const zoom = editor.zoomLevel
-		const rotation = editor.selectionRotation
 		const isChangingStyle = editor.instanceState.isChangingStyle
 
 		const width = Math.max(1, bounds.width)
@@ -94,8 +92,7 @@ export const TldrawSelectionForeground: TLSelectionForegroundComponent = track(
 					'select.crop.idle',
 					'select.crop.pointing_crop',
 					'select.pointing_resize_handle',
-					'select.pointing_crop_handle',
-					'select.editing_shape'
+					'select.pointing_crop_handle'
 				)) ||
 			(showSelectionBounds &&
 				editor.isIn('select.resizing') &&

commit 28b92c5e764ac8ce8dc1a66cd1d6248e3ddda085
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Wed Jul 26 16:32:33 2023 +0100

    [fix] restore bg option, fix calculations (#1765)
    
    This PR fixes a bug introduced with #1751 where pointing the bounds of
    rotated selections would not correctly hit the bounds background.
    
    ### Change Type
    
    - [x] `patch` ‚Äî Bug fix
    
    ### Test Plan
    
    1. Create a rotated selection.
    2. Point into the bounds background
    
    - [x] Unit Tests

diff --git a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
index 24a38aa15..a9a68ad31 100644
--- a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
+++ b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
@@ -99,13 +99,10 @@ export const TldrawSelectionForeground: TLSelectionForegroundComponent = track(
 				onlyShape &&
 				editor.isShapeOfType<TLTextShape>(onlyShape, 'text'))
 
-		if (
-			onlyShape &&
-			editor.isShapeOfType<TLEmbedShape>(onlyShape, 'embed') &&
-			shouldDisplayBox &&
-			IS_FIREFOX
-		) {
-			shouldDisplayBox = false
+		if (onlyShape && shouldDisplayBox) {
+			if (IS_FIREFOX && editor.isShapeOfType<TLEmbedShape>(onlyShape, 'embed')) {
+				shouldDisplayBox = false
+			}
 		}
 
 		const showCropHandles =

commit b2039673414b6d7e9e8204bfb6053d97d4893476
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Fri Aug 25 18:22:52 2023 +0200

    [fix] remove CSS radius calculations (#1823)
    
    This PR fixes some creative use of CSS in setting the radius property of
    various SVGs. While this use is supported in all browsers, it was
    confusing CSS processors. Moving these out of CSS and into JavaScript
    seems to be a pretty minor trade. Closes
    https://github.com/tldraw/tldraw/issues/1775.
    
    ### Change Type
    
    - [x] `patch` ‚Äî Bug fix
    
    ### Test Plan
    
    1. Ensure that borders and handles adjust their radii correctly when
    zoomed in or out.

diff --git a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
index a9a68ad31..88c71c0e7 100644
--- a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
+++ b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
@@ -9,6 +9,7 @@ import {
 	useEditor,
 	useSelectionEvents,
 	useTransform,
+	useValue,
 } from '@tldraw/editor'
 import classNames from 'classnames'
 import { useRef } from 'react'
@@ -500,6 +501,10 @@ export const MobileRotateHandle = function RotateHandle({
 }) {
 	const events = useSelectionEvents('mobile_rotate')
 
+	const editor = useEditor()
+	const zoom = useValue('zoom level', () => editor.zoomLevel, [editor])
+	const bgRadius = Math.max(14 * (1 / zoom), 20 / Math.max(1, zoom))
+
 	return (
 		<g>
 			<circle
@@ -508,6 +513,7 @@ export const MobileRotateHandle = function RotateHandle({
 				className={classNames('tl-transparent', 'tl-mobile-rotate__bg', { 'tl-hidden': isHidden })}
 				cx={cx}
 				cy={cy}
+				r={bgRadius}
 				{...events}
 			/>
 			<circle

commit f21eaeb4d803da95d12aeaa29e810a0d588b8709
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Fri Sep 8 15:45:30 2023 +0100

    [fix] zero width / height bounds (#1840)
    
    This PR fixes zero width or height on Geometry2d bounds. It adds the
    `zeroFix` helper to the `Box2d` class.
    
    ### Change Type
    
    - [x] `patch` ‚Äî Bug fix
    
    ### Test Plan
    
    1. Create a straight line
    2. Create a straight arrow that binds to the straight line
    
    - [x] Unit Tests
    
    ### Release Notes
    
    - Fix bug with straight lines / arrows

diff --git a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
index 88c71c0e7..e3eaf3fab 100644
--- a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
+++ b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
@@ -1,4 +1,5 @@
 import {
+	Box2d,
 	RotateCorner,
 	TLEmbedShape,
 	TLSelectionForegroundComponent,
@@ -22,7 +23,7 @@ const IS_FIREFOX =
 	navigator.userAgent.toLowerCase().indexOf('firefox') > -1
 
 export const TldrawSelectionForeground: TLSelectionForegroundComponent = track(
-	function TldrawSelectionForeground({ bounds, rotation }) {
+	function TldrawSelectionForeground({ bounds, rotation }: { bounds: Box2d; rotation: number }) {
 		const editor = useEditor()
 		const rSvg = useRef<SVGSVGElement>(null)
 
@@ -54,13 +55,13 @@ export const TldrawSelectionForeground: TLSelectionForegroundComponent = track(
 		})
 
 		if (!bounds) return null
-		bounds = bounds.clone().expandBy(expandOutlineBy)
+		bounds = bounds.clone().expandBy(expandOutlineBy).zeroFix()
 
 		const zoom = editor.zoomLevel
 		const isChangingStyle = editor.instanceState.isChangingStyle
 
-		const width = Math.max(1, bounds.width)
-		const height = Math.max(1, bounds.height)
+		const width = bounds.width
+		const height = bounds.height
 
 		const size = 8 / zoom
 		const isTinyX = width < size * 2
@@ -239,7 +240,7 @@ export const TldrawSelectionForeground: TLSelectionForegroundComponent = track(
 					corner="bottom_right_rotate"
 					cursor={isDefaultCursor ? getCursor('senw-rotate', rotation) : undefined}
 					isHidden={hideRotateCornerHandles}
-				/>{' '}
+				/>
 				<MobileRotateHandle
 					data-testid="selection.rotate.mobile"
 					cx={isSmallX ? -targetSize * 1.5 : width / 2}
@@ -257,7 +258,7 @@ export const TldrawSelectionForeground: TLSelectionForegroundComponent = track(
 					pointerEvents="all"
 					x={0}
 					y={toDomPrecision(0 - (isSmallY ? targetSizeY * 2 : targetSizeY))}
-					width={toDomPrecision(Math.max(1, width))}
+					width={toDomPrecision(width)}
 					height={toDomPrecision(Math.max(1, targetSizeY * 2))}
 					style={isDefaultCursor ? { cursor: getCursor('ns-resize', rotation) } : undefined}
 					{...topEvents}
@@ -271,7 +272,7 @@ export const TldrawSelectionForeground: TLSelectionForegroundComponent = track(
 					pointerEvents="all"
 					x={toDomPrecision(width - (isSmallX ? 0 : targetSizeX))}
 					y={0}
-					height={toDomPrecision(Math.max(1, height))}
+					height={toDomPrecision(height)}
 					width={toDomPrecision(Math.max(1, targetSizeX * 2))}
 					style={isDefaultCursor ? { cursor: getCursor('ew-resize', rotation) } : undefined}
 					{...rightEvents}
@@ -285,7 +286,7 @@ export const TldrawSelectionForeground: TLSelectionForegroundComponent = track(
 					pointerEvents="all"
 					x={0}
 					y={toDomPrecision(height - (isSmallY ? 0 : targetSizeY))}
-					width={toDomPrecision(Math.max(1, width))}
+					width={toDomPrecision(width)}
 					height={toDomPrecision(Math.max(1, targetSizeY * 2))}
 					style={isDefaultCursor ? { cursor: getCursor('ns-resize', rotation) } : undefined}
 					{...bottomEvents}
@@ -299,7 +300,7 @@ export const TldrawSelectionForeground: TLSelectionForegroundComponent = track(
 					pointerEvents="all"
 					x={toDomPrecision(0 - (isSmallX ? targetSizeX * 2 : targetSizeX))}
 					y={0}
-					height={toDomPrecision(Math.max(1, height))}
+					height={toDomPrecision(height)}
 					width={toDomPrecision(Math.max(1, targetSizeX * 2))}
 					style={isDefaultCursor ? { cursor: getCursor('ew-resize', rotation) } : undefined}
 					{...leftEvents}

commit 94f78652cc841d66ee2237c70aba7dbe3c3f8829
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Mon Oct 23 13:32:10 2023 +0100

    fix selection fg transform (#2113)
    
    Uses the dpr trick on the selection foreground. Looks like the
    background doesn't need this.
    
    ### Change Type
    
    - [x] `patch` ‚Äî Bug fix
    - [ ] `minor` ‚Äî New feature
    - [ ] `major` ‚Äî Breaking change
    - [ ] `dependencies` ‚Äî Changes to package dependencies[^1]
    - [ ] `documentation` ‚Äî Changes to the documentation only[^2]
    - [ ] `tests` ‚Äî Changes to any test code only[^2]
    - [ ] `internal` ‚Äî Any other changes that don't affect the published
    package[^2]
    - [ ] I don't know
    
    [^1]: publishes a `patch` release, for devDependencies use `internal`
    [^2]: will not publish a new version
    
    ### Release Notes
    
    - Fixes a small issue causing the selection foreground to be offset when
    the browser is at particular zoom levels.

diff --git a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
index e3eaf3fab..3f530c032 100644
--- a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
+++ b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
@@ -194,258 +194,259 @@ export const TldrawSelectionForeground: TLSelectionForegroundComponent = track(
 
 		return (
 			<svg
-				ref={rSvg}
-				className="tl-overlays__item tl-selection__fg"
+				className="tl-overlays__item tl-selection__fg tl-svg-context"
 				data-testid="selection-foreground"
 			>
-				{shouldDisplayBox && (
+				<g ref={rSvg}>
+					{shouldDisplayBox && (
+						<rect
+							className={classNames('tl-selection__fg__outline')}
+							width={toDomPrecision(width)}
+							height={toDomPrecision(height)}
+						/>
+					)}
+					<RotateCornerHandle
+						data-testid="selection.rotate.top-left"
+						cx={0}
+						cy={0}
+						targetSize={targetSize}
+						corner="top_left_rotate"
+						cursor={isDefaultCursor ? getCursor('nwse-rotate', rotation) : undefined}
+						isHidden={hideRotateCornerHandles}
+					/>
+					<RotateCornerHandle
+						data-testid="selection.rotate.top-right"
+						cx={width + targetSize * 3}
+						cy={0}
+						targetSize={targetSize}
+						corner="top_right_rotate"
+						cursor={isDefaultCursor ? getCursor('nesw-rotate', rotation) : undefined}
+						isHidden={hideRotateCornerHandles}
+					/>
+					<RotateCornerHandle
+						data-testid="selection.rotate.bottom-left"
+						cx={0}
+						cy={height + targetSize * 3}
+						targetSize={targetSize}
+						corner="bottom_left_rotate"
+						cursor={isDefaultCursor ? getCursor('swne-rotate', rotation) : undefined}
+						isHidden={hideRotateCornerHandles}
+					/>
+					<RotateCornerHandle
+						data-testid="selection.rotate.bottom-right"
+						cx={width + targetSize * 3}
+						cy={height + targetSize * 3}
+						targetSize={targetSize}
+						corner="bottom_right_rotate"
+						cursor={isDefaultCursor ? getCursor('senw-rotate', rotation) : undefined}
+						isHidden={hideRotateCornerHandles}
+					/>
+					<MobileRotateHandle
+						data-testid="selection.rotate.mobile"
+						cx={isSmallX ? -targetSize * 1.5 : width / 2}
+						cy={isSmallX ? height / 2 : -targetSize * 1.5}
+						size={size}
+						isHidden={hideMobileRotateHandle}
+					/>
+					{/* Targets */}
 					<rect
-						className={classNames('tl-selection__fg__outline')}
+						className={classNames('tl-transparent', {
+							'tl-hidden': hideEdgeTargets,
+						})}
+						data-testid="selection.resize.top"
+						aria-label="top target"
+						pointerEvents="all"
+						x={0}
+						y={toDomPrecision(0 - (isSmallY ? targetSizeY * 2 : targetSizeY))}
 						width={toDomPrecision(width)}
+						height={toDomPrecision(Math.max(1, targetSizeY * 2))}
+						style={isDefaultCursor ? { cursor: getCursor('ns-resize', rotation) } : undefined}
+						{...topEvents}
+					/>
+					<rect
+						className={classNames('tl-transparent', {
+							'tl-hidden': hideEdgeTargets,
+						})}
+						data-testid="selection.resize.right"
+						aria-label="right target"
+						pointerEvents="all"
+						x={toDomPrecision(width - (isSmallX ? 0 : targetSizeX))}
+						y={0}
 						height={toDomPrecision(height)}
+						width={toDomPrecision(Math.max(1, targetSizeX * 2))}
+						style={isDefaultCursor ? { cursor: getCursor('ew-resize', rotation) } : undefined}
+						{...rightEvents}
 					/>
-				)}
-				<RotateCornerHandle
-					data-testid="selection.rotate.top-left"
-					cx={0}
-					cy={0}
-					targetSize={targetSize}
-					corner="top_left_rotate"
-					cursor={isDefaultCursor ? getCursor('nwse-rotate', rotation) : undefined}
-					isHidden={hideRotateCornerHandles}
-				/>
-				<RotateCornerHandle
-					data-testid="selection.rotate.top-right"
-					cx={width + targetSize * 3}
-					cy={0}
-					targetSize={targetSize}
-					corner="top_right_rotate"
-					cursor={isDefaultCursor ? getCursor('nesw-rotate', rotation) : undefined}
-					isHidden={hideRotateCornerHandles}
-				/>
-				<RotateCornerHandle
-					data-testid="selection.rotate.bottom-left"
-					cx={0}
-					cy={height + targetSize * 3}
-					targetSize={targetSize}
-					corner="bottom_left_rotate"
-					cursor={isDefaultCursor ? getCursor('swne-rotate', rotation) : undefined}
-					isHidden={hideRotateCornerHandles}
-				/>
-				<RotateCornerHandle
-					data-testid="selection.rotate.bottom-right"
-					cx={width + targetSize * 3}
-					cy={height + targetSize * 3}
-					targetSize={targetSize}
-					corner="bottom_right_rotate"
-					cursor={isDefaultCursor ? getCursor('senw-rotate', rotation) : undefined}
-					isHidden={hideRotateCornerHandles}
-				/>
-				<MobileRotateHandle
-					data-testid="selection.rotate.mobile"
-					cx={isSmallX ? -targetSize * 1.5 : width / 2}
-					cy={isSmallX ? height / 2 : -targetSize * 1.5}
-					size={size}
-					isHidden={hideMobileRotateHandle}
-				/>
-				{/* Targets */}
-				<rect
-					className={classNames('tl-transparent', {
-						'tl-hidden': hideEdgeTargets,
-					})}
-					data-testid="selection.resize.top"
-					aria-label="top target"
-					pointerEvents="all"
-					x={0}
-					y={toDomPrecision(0 - (isSmallY ? targetSizeY * 2 : targetSizeY))}
-					width={toDomPrecision(width)}
-					height={toDomPrecision(Math.max(1, targetSizeY * 2))}
-					style={isDefaultCursor ? { cursor: getCursor('ns-resize', rotation) } : undefined}
-					{...topEvents}
-				/>
-				<rect
-					className={classNames('tl-transparent', {
-						'tl-hidden': hideEdgeTargets,
-					})}
-					data-testid="selection.resize.right"
-					aria-label="right target"
-					pointerEvents="all"
-					x={toDomPrecision(width - (isSmallX ? 0 : targetSizeX))}
-					y={0}
-					height={toDomPrecision(height)}
-					width={toDomPrecision(Math.max(1, targetSizeX * 2))}
-					style={isDefaultCursor ? { cursor: getCursor('ew-resize', rotation) } : undefined}
-					{...rightEvents}
-				/>
-				<rect
-					className={classNames('tl-transparent', {
-						'tl-hidden': hideEdgeTargets,
-					})}
-					data-testid="selection.resize.bottom"
-					aria-label="bottom target"
-					pointerEvents="all"
-					x={0}
-					y={toDomPrecision(height - (isSmallY ? 0 : targetSizeY))}
-					width={toDomPrecision(width)}
-					height={toDomPrecision(Math.max(1, targetSizeY * 2))}
-					style={isDefaultCursor ? { cursor: getCursor('ns-resize', rotation) } : undefined}
-					{...bottomEvents}
-				/>
-				<rect
-					className={classNames('tl-transparent', {
-						'tl-hidden': hideEdgeTargets,
-					})}
-					data-testid="selection.resize.left"
-					aria-label="left target"
-					pointerEvents="all"
-					x={toDomPrecision(0 - (isSmallX ? targetSizeX * 2 : targetSizeX))}
-					y={0}
-					height={toDomPrecision(height)}
-					width={toDomPrecision(Math.max(1, targetSizeX * 2))}
-					style={isDefaultCursor ? { cursor: getCursor('ew-resize', rotation) } : undefined}
-					{...leftEvents}
-				/>
-				{/* Corner Targets */}
-				<rect
-					className={classNames('tl-transparent', {
-						'tl-hidden': hideTopLeftCorner,
-					})}
-					data-testid="selection.target.top-left"
-					aria-label="top-left target"
-					pointerEvents="all"
-					x={toDomPrecision(0 - (isSmallX ? targetSizeX * 2 : targetSizeX * 1.5))}
-					y={toDomPrecision(0 - (isSmallY ? targetSizeY * 2 : targetSizeY * 1.5))}
-					width={toDomPrecision(targetSizeX * 3)}
-					height={toDomPrecision(targetSizeY * 3)}
-					style={isDefaultCursor ? { cursor: getCursor('nwse-resize', rotation) } : undefined}
-					{...topLeftEvents}
-				/>
-				<rect
-					className={classNames('tl-transparent', {
-						'tl-hidden': hideTopRightCorner,
-					})}
-					data-testid="selection.target.top-right"
-					aria-label="top-right target"
-					pointerEvents="all"
-					x={toDomPrecision(width - (isSmallX ? 0 : targetSizeX * 1.5))}
-					y={toDomPrecision(0 - (isSmallY ? targetSizeY * 2 : targetSizeY * 1.5))}
-					width={toDomPrecision(targetSizeX * 3)}
-					height={toDomPrecision(targetSizeY * 3)}
-					style={isDefaultCursor ? { cursor: getCursor('nesw-resize', rotation) } : undefined}
-					{...topRightEvents}
-				/>
-				<rect
-					className={classNames('tl-transparent', {
-						'tl-hidden': hideBottomRightCorner,
-					})}
-					data-testid="selection.target.bottom-right"
-					aria-label="bottom-right target"
-					pointerEvents="all"
-					x={toDomPrecision(width - (isSmallX ? targetSizeX : targetSizeX * 1.5))}
-					y={toDomPrecision(height - (isSmallY ? targetSizeY : targetSizeY * 1.5))}
-					width={toDomPrecision(targetSizeX * 3)}
-					height={toDomPrecision(targetSizeY * 3)}
-					style={isDefaultCursor ? { cursor: getCursor('nwse-resize', rotation) } : undefined}
-					{...bottomRightEvents}
-				/>
-				<rect
-					className={classNames('tl-transparent', {
-						'tl-hidden': hideBottomLeftCorner,
-					})}
-					data-testid="selection.target.bottom-left"
-					aria-label="bottom-left target"
-					pointerEvents="all"
-					x={toDomPrecision(0 - (isSmallX ? targetSizeX * 3 : targetSizeX * 1.5))}
-					y={toDomPrecision(height - (isSmallY ? 0 : targetSizeY * 1.5))}
-					width={toDomPrecision(targetSizeX * 3)}
-					height={toDomPrecision(targetSizeY * 3)}
-					style={isDefaultCursor ? { cursor: getCursor('nesw-resize', rotation) } : undefined}
-					{...bottomLeftEvents}
-				/>
-				{/* Resize Handles */}
-				{showResizeHandles && (
-					<>
-						<rect
-							data-testid="selection.resize.top-left"
-							className={classNames('tl-corner-handle', {
-								'tl-hidden': hideTopLeftCorner,
-							})}
-							aria-label="top_left handle"
-							x={toDomPrecision(0 - size / 2)}
-							y={toDomPrecision(0 - size / 2)}
-							width={toDomPrecision(size)}
-							height={toDomPrecision(size)}
-						/>
-						<rect
-							data-testid="selection.resize.top-right"
-							className={classNames('tl-corner-handle', {
-								'tl-hidden': hideTopRightCorner,
-							})}
-							aria-label="top_right handle"
-							x={toDomPrecision(width - size / 2)}
-							y={toDomPrecision(0 - size / 2)}
-							width={toDomPrecision(size)}
-							height={toDomPrecision(size)}
-						/>
-						<rect
-							data-testid="selection.resize.bottom-right"
-							className={classNames('tl-corner-handle', {
-								'tl-hidden': hideBottomRightCorner,
-							})}
-							aria-label="bottom_right handle"
-							x={toDomPrecision(width - size / 2)}
-							y={toDomPrecision(height - size / 2)}
-							width={toDomPrecision(size)}
-							height={toDomPrecision(size)}
-						/>
-						<rect
-							data-testid="selection.resize.bottom-left"
-							className={classNames('tl-corner-handle', {
-								'tl-hidden': hideBottomLeftCorner,
-							})}
-							aria-label="bottom_left handle"
-							x={toDomPrecision(0 - size / 2)}
-							y={toDomPrecision(height - size / 2)}
-							width={toDomPrecision(size)}
-							height={toDomPrecision(size)}
-						/>
-					</>
-				)}
-				{showTextResizeHandles && (
-					<>
-						<rect
-							data-testid="selection.text-resize.left.handle"
-							className="tl-text-handle"
-							aria-label="bottom_left handle"
-							x={toDomPrecision(0 - size / 4)}
-							y={toDomPrecision(height / 2 - textHandleHeight / 2)}
-							rx={size / 4}
-							width={toDomPrecision(size / 2)}
-							height={toDomPrecision(textHandleHeight)}
-						/>
-						<rect
-							data-testid="selection.text-resize.right.handle"
-							className="tl-text-handle"
-							aria-label="bottom_left handle"
-							rx={size / 4}
-							x={toDomPrecision(width - size / 4)}
-							y={toDomPrecision(height / 2 - textHandleHeight / 2)}
-							width={toDomPrecision(size / 2)}
-							height={toDomPrecision(textHandleHeight)}
-						/>
-					</>
-				)}
-				{/* Crop Handles */}
-				{showCropHandles && (
-					<CropHandles
-						{...{
-							size,
-							width,
-							height,
-							hideAlternateHandles: hideAlternateCropHandles,
-						}}
+					<rect
+						className={classNames('tl-transparent', {
+							'tl-hidden': hideEdgeTargets,
+						})}
+						data-testid="selection.resize.bottom"
+						aria-label="bottom target"
+						pointerEvents="all"
+						x={0}
+						y={toDomPrecision(height - (isSmallY ? 0 : targetSizeY))}
+						width={toDomPrecision(width)}
+						height={toDomPrecision(Math.max(1, targetSizeY * 2))}
+						style={isDefaultCursor ? { cursor: getCursor('ns-resize', rotation) } : undefined}
+						{...bottomEvents}
 					/>
-				)}
+					<rect
+						className={classNames('tl-transparent', {
+							'tl-hidden': hideEdgeTargets,
+						})}
+						data-testid="selection.resize.left"
+						aria-label="left target"
+						pointerEvents="all"
+						x={toDomPrecision(0 - (isSmallX ? targetSizeX * 2 : targetSizeX))}
+						y={0}
+						height={toDomPrecision(height)}
+						width={toDomPrecision(Math.max(1, targetSizeX * 2))}
+						style={isDefaultCursor ? { cursor: getCursor('ew-resize', rotation) } : undefined}
+						{...leftEvents}
+					/>
+					{/* Corner Targets */}
+					<rect
+						className={classNames('tl-transparent', {
+							'tl-hidden': hideTopLeftCorner,
+						})}
+						data-testid="selection.target.top-left"
+						aria-label="top-left target"
+						pointerEvents="all"
+						x={toDomPrecision(0 - (isSmallX ? targetSizeX * 2 : targetSizeX * 1.5))}
+						y={toDomPrecision(0 - (isSmallY ? targetSizeY * 2 : targetSizeY * 1.5))}
+						width={toDomPrecision(targetSizeX * 3)}
+						height={toDomPrecision(targetSizeY * 3)}
+						style={isDefaultCursor ? { cursor: getCursor('nwse-resize', rotation) } : undefined}
+						{...topLeftEvents}
+					/>
+					<rect
+						className={classNames('tl-transparent', {
+							'tl-hidden': hideTopRightCorner,
+						})}
+						data-testid="selection.target.top-right"
+						aria-label="top-right target"
+						pointerEvents="all"
+						x={toDomPrecision(width - (isSmallX ? 0 : targetSizeX * 1.5))}
+						y={toDomPrecision(0 - (isSmallY ? targetSizeY * 2 : targetSizeY * 1.5))}
+						width={toDomPrecision(targetSizeX * 3)}
+						height={toDomPrecision(targetSizeY * 3)}
+						style={isDefaultCursor ? { cursor: getCursor('nesw-resize', rotation) } : undefined}
+						{...topRightEvents}
+					/>
+					<rect
+						className={classNames('tl-transparent', {
+							'tl-hidden': hideBottomRightCorner,
+						})}
+						data-testid="selection.target.bottom-right"
+						aria-label="bottom-right target"
+						pointerEvents="all"
+						x={toDomPrecision(width - (isSmallX ? targetSizeX : targetSizeX * 1.5))}
+						y={toDomPrecision(height - (isSmallY ? targetSizeY : targetSizeY * 1.5))}
+						width={toDomPrecision(targetSizeX * 3)}
+						height={toDomPrecision(targetSizeY * 3)}
+						style={isDefaultCursor ? { cursor: getCursor('nwse-resize', rotation) } : undefined}
+						{...bottomRightEvents}
+					/>
+					<rect
+						className={classNames('tl-transparent', {
+							'tl-hidden': hideBottomLeftCorner,
+						})}
+						data-testid="selection.target.bottom-left"
+						aria-label="bottom-left target"
+						pointerEvents="all"
+						x={toDomPrecision(0 - (isSmallX ? targetSizeX * 3 : targetSizeX * 1.5))}
+						y={toDomPrecision(height - (isSmallY ? 0 : targetSizeY * 1.5))}
+						width={toDomPrecision(targetSizeX * 3)}
+						height={toDomPrecision(targetSizeY * 3)}
+						style={isDefaultCursor ? { cursor: getCursor('nesw-resize', rotation) } : undefined}
+						{...bottomLeftEvents}
+					/>
+					{/* Resize Handles */}
+					{showResizeHandles && (
+						<>
+							<rect
+								data-testid="selection.resize.top-left"
+								className={classNames('tl-corner-handle', {
+									'tl-hidden': hideTopLeftCorner,
+								})}
+								aria-label="top_left handle"
+								x={toDomPrecision(0 - size / 2)}
+								y={toDomPrecision(0 - size / 2)}
+								width={toDomPrecision(size)}
+								height={toDomPrecision(size)}
+							/>
+							<rect
+								data-testid="selection.resize.top-right"
+								className={classNames('tl-corner-handle', {
+									'tl-hidden': hideTopRightCorner,
+								})}
+								aria-label="top_right handle"
+								x={toDomPrecision(width - size / 2)}
+								y={toDomPrecision(0 - size / 2)}
+								width={toDomPrecision(size)}
+								height={toDomPrecision(size)}
+							/>
+							<rect
+								data-testid="selection.resize.bottom-right"
+								className={classNames('tl-corner-handle', {
+									'tl-hidden': hideBottomRightCorner,
+								})}
+								aria-label="bottom_right handle"
+								x={toDomPrecision(width - size / 2)}
+								y={toDomPrecision(height - size / 2)}
+								width={toDomPrecision(size)}
+								height={toDomPrecision(size)}
+							/>
+							<rect
+								data-testid="selection.resize.bottom-left"
+								className={classNames('tl-corner-handle', {
+									'tl-hidden': hideBottomLeftCorner,
+								})}
+								aria-label="bottom_left handle"
+								x={toDomPrecision(0 - size / 2)}
+								y={toDomPrecision(height - size / 2)}
+								width={toDomPrecision(size)}
+								height={toDomPrecision(size)}
+							/>
+						</>
+					)}
+					{showTextResizeHandles && (
+						<>
+							<rect
+								data-testid="selection.text-resize.left.handle"
+								className="tl-text-handle"
+								aria-label="bottom_left handle"
+								x={toDomPrecision(0 - size / 4)}
+								y={toDomPrecision(height / 2 - textHandleHeight / 2)}
+								rx={size / 4}
+								width={toDomPrecision(size / 2)}
+								height={toDomPrecision(textHandleHeight)}
+							/>
+							<rect
+								data-testid="selection.text-resize.right.handle"
+								className="tl-text-handle"
+								aria-label="bottom_left handle"
+								rx={size / 4}
+								x={toDomPrecision(width - size / 4)}
+								y={toDomPrecision(height / 2 - textHandleHeight / 2)}
+								width={toDomPrecision(size / 2)}
+								height={toDomPrecision(textHandleHeight)}
+							/>
+						</>
+					)}
+					{/* Crop Handles */}
+					{showCropHandles && (
+						<CropHandles
+							{...{
+								size,
+								width,
+								height,
+								hideAlternateHandles: hideAlternateCropHandles,
+							}}
+						/>
+					)}
+				</g>
 			</svg>
 		)
 	}

commit 3e78b18f728fa364d980c02514c184e7491dd9c3
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Thu Nov 9 16:46:52 2023 +0000

    Add tldraw component exports (#2188)
    
    This PR adds the default tldraw components to the library's exports.
    
    ### Change Type
    
    - [x] `patch` ‚Äî Bug fix

diff --git a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
index 3f530c032..4e88cf847 100644
--- a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
+++ b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
@@ -15,13 +15,9 @@ import {
 import classNames from 'classnames'
 import { useRef } from 'react'
 import { useReadonly } from '../ui/hooks/useReadonly'
-import { CropHandles } from './CropHandles'
-
-const IS_FIREFOX =
-	typeof navigator !== 'undefined' &&
-	navigator.userAgent &&
-	navigator.userAgent.toLowerCase().indexOf('firefox') > -1
+import { TldrawCropHandles } from './TldrawCropHandles'
 
+/** @public */
 export const TldrawSelectionForeground: TLSelectionForegroundComponent = track(
 	function TldrawSelectionForeground({ bounds, rotation }: { bounds: Box2d; rotation: number }) {
 		const editor = useEditor()
@@ -102,7 +98,7 @@ export const TldrawSelectionForeground: TLSelectionForegroundComponent = track(
 				editor.isShapeOfType<TLTextShape>(onlyShape, 'text'))
 
 		if (onlyShape && shouldDisplayBox) {
-			if (IS_FIREFOX && editor.isShapeOfType<TLEmbedShape>(onlyShape, 'embed')) {
+			if (editor.environment.isFirefox && editor.isShapeOfType<TLEmbedShape>(onlyShape, 'embed')) {
 				shouldDisplayBox = false
 			}
 		}
@@ -437,7 +433,7 @@ export const TldrawSelectionForeground: TLSelectionForegroundComponent = track(
 					)}
 					{/* Crop Handles */}
 					{showCropHandles && (
-						<CropHandles
+						<TldrawCropHandles
 							{...{
 								size,
 								width,

commit 5db3c1553e14edd14aa5f7c0fc85fc5efc352335
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon Nov 13 11:51:22 2023 +0000

    Replace Atom.value with Atom.get() (#2189)
    
    This PR replaces the `.value` getter for the atom with `.get()`
    
    ### Change Type
    
    - [x] `major` ‚Äî Breaking change
    
    ---------
    
    Co-authored-by: David Sheldrick <d.j.sheldrick@gmail.com>

diff --git a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
index 4e88cf847..d25f8335c 100644
--- a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
+++ b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
@@ -33,8 +33,9 @@ export const TldrawSelectionForeground: TLSelectionForegroundComponent = track(
 		const bottomRightEvents = useSelectionEvents('bottom_right')
 		const bottomLeftEvents = useSelectionEvents('bottom_left')
 
-		const isDefaultCursor = !editor.isMenuOpen && editor.instanceState.cursor.type === 'default'
-		const isCoarsePointer = editor.instanceState.isCoarsePointer
+		const isDefaultCursor =
+			!editor.isMenuOpen && editor.getInstanceState().cursor.type === 'default'
+		const isCoarsePointer = editor.getInstanceState().isCoarsePointer
 
 		const shapes = editor.selectedShapes
 		const onlyShape = editor.onlySelectedShape
@@ -54,7 +55,7 @@ export const TldrawSelectionForeground: TLSelectionForegroundComponent = track(
 		bounds = bounds.clone().expandBy(expandOutlineBy).zeroFix()
 
 		const zoom = editor.zoomLevel
-		const isChangingStyle = editor.instanceState.isChangingStyle
+		const isChangingStyle = editor.getInstanceState().isChangingStyle
 
 		const width = bounds.width
 		const height = bounds.height

commit 2ca2f81f2aac16790c73bd334eda53a35a9d9f45
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Mon Nov 13 12:42:07 2023 +0000

    No impure getters pt2 (#2202)
    
    follow up to #2189

diff --git a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
index d25f8335c..c7d3d78d7 100644
--- a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
+++ b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
@@ -34,7 +34,7 @@ export const TldrawSelectionForeground: TLSelectionForegroundComponent = track(
 		const bottomLeftEvents = useSelectionEvents('bottom_left')
 
 		const isDefaultCursor =
-			!editor.isMenuOpen && editor.getInstanceState().cursor.type === 'default'
+			!editor.getIsMenuOpen() && editor.getInstanceState().cursor.type === 'default'
 		const isCoarsePointer = editor.getInstanceState().isCoarsePointer
 
 		const shapes = editor.selectedShapes

commit 7ffda2335ce1c9b20e453436db438b08d03e9a87
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Mon Nov 13 14:31:27 2023 +0000

    No impure getters pt3 (#2203)
    
    Follow up to #2189 and #2202
    
    ### Change Type
    
    - [x] `patch` ‚Äî Bug fix
    
    [^1]: publishes a `patch` release, for devDependencies use `internal`
    [^2]: will not publish a new version

diff --git a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
index c7d3d78d7..f66ef80c0 100644
--- a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
+++ b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
@@ -37,8 +37,8 @@ export const TldrawSelectionForeground: TLSelectionForegroundComponent = track(
 			!editor.getIsMenuOpen() && editor.getInstanceState().cursor.type === 'default'
 		const isCoarsePointer = editor.getInstanceState().isCoarsePointer
 
-		const shapes = editor.selectedShapes
-		const onlyShape = editor.onlySelectedShape
+		const shapes = editor.getSelectedShapes()
+		const onlyShape = editor.getOnlySelectedShape()
 		const isLockedShape = onlyShape && editor.isShapeOrAncestorLocked(onlyShape)
 
 		// if all shapes have an expandBy for the selection outline, we can expand by the l

commit daf729d45c879d4e234d9417570149ad854f635b
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Mon Nov 13 16:02:50 2023 +0000

    No impure getters pt4 (#2206)
    
    follow up to #2189 and #2203
    
    ### Change Type
    
    - [x] `patch` ‚Äî Bug fix

diff --git a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
index f66ef80c0..5d24ffdf9 100644
--- a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
+++ b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
@@ -46,7 +46,7 @@ export const TldrawSelectionForeground: TLSelectionForegroundComponent = track(
 			? editor.getShapeUtil(onlyShape).expandSelectionOutlinePx(onlyShape)
 			: 0
 
-		useTransform(rSvg, bounds?.x, bounds?.y, 1, editor.selectionRotation, {
+		useTransform(rSvg, bounds?.x, bounds?.y, 1, editor.getSelectionRotation(), {
 			x: -expandOutlineBy,
 			y: -expandOutlineBy,
 		})

commit 6f872c796afd6cf538ce81d35c5a40dcccbe7013
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Tue Nov 14 11:57:43 2023 +0000

    No impure getters pt6 (#2218)
    
    follow up to #2189
    
    ### Change Type
    
    - [x] `patch` ‚Äî Bug fix

diff --git a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
index 5d24ffdf9..4843bd979 100644
--- a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
+++ b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
@@ -54,7 +54,7 @@ export const TldrawSelectionForeground: TLSelectionForegroundComponent = track(
 		if (!bounds) return null
 		bounds = bounds.clone().expandBy(expandOutlineBy).zeroFix()
 
-		const zoom = editor.zoomLevel
+		const zoom = editor.getZoomLevel()
 		const isChangingStyle = editor.getInstanceState().isChangingStyle
 
 		const width = bounds.width
@@ -501,7 +501,7 @@ export const MobileRotateHandle = function RotateHandle({
 	const events = useSelectionEvents('mobile_rotate')
 
 	const editor = useEditor()
-	const zoom = useValue('zoom level', () => editor.zoomLevel, [editor])
+	const zoom = useValue('zoom level', () => editor.getZoomLevel(), [editor])
 	const bgRadius = Math.max(14 * (1 / zoom), 20 / Math.max(1, zoom))
 
 	return (

commit 2a026504fe27b0c924b4a2f9929ed7111492cce8
Author: Mitja Bezen≈°ek <mitja.bezensek@gmail.com>
Date:   Tue Dec 19 14:45:19 2023 +0100

    Only allow side resizing when we have some shapes that are not aspect ratio locked (#2347)
    
    Only allow edges resizing on mobile when a single text shape is
    selected. Disabled it for all other cases.
    
    Fixes [#2349](https://github.com/tldraw/tldraw/issues/2349)
    
    ### Change Type
    
    - [x] `patch` ‚Äî Bug fix
    - [ ] `minor` ‚Äî New feature
    - [ ] `major` ‚Äî Breaking change
    - [ ] `dependencies` ‚Äî Changes to package dependencies[^1]
    - [ ] `documentation` ‚Äî Changes to the documentation only[^2]
    - [ ] `tests` ‚Äî Changes to any test code only[^2]
    - [ ] `internal` ‚Äî Any other changes that don't affect the published
    package[^2]
    - [ ] I don't know
    
    [^1]: publishes a `patch` release, for devDependencies use `internal`
    [^2]: will not publish a new version
    
    
    ### Release Notes
    
    - Don't allow edges resizing on mobile. The only exception is a single
    text shape.

diff --git a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
index 4843bd979..634fa3f4c 100644
--- a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
+++ b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
@@ -37,7 +37,6 @@ export const TldrawSelectionForeground: TLSelectionForegroundComponent = track(
 			!editor.getIsMenuOpen() && editor.getInstanceState().cursor.type === 'default'
 		const isCoarsePointer = editor.getInstanceState().isCoarsePointer
 
-		const shapes = editor.getSelectedShapes()
 		const onlyShape = editor.getOnlySelectedShape()
 		const isLockedShape = onlyShape && editor.isShapeOrAncestorLocked(onlyShape)
 
@@ -162,10 +161,7 @@ export const TldrawSelectionForeground: TLSelectionForegroundComponent = track(
 
 		let hideEdgeTargetsDueToCoarsePointer = isCoarsePointer
 
-		if (
-			hideEdgeTargetsDueToCoarsePointer &&
-			shapes.every((shape) => editor.getShapeUtil(shape).isAspectRatioLocked(shape))
-		) {
+		if (hideEdgeTargetsDueToCoarsePointer && onlyShape && onlyShape.type === 'text') {
 			hideEdgeTargetsDueToCoarsePointer = false
 		}
 

commit 6b1005ef71a63613a09606310f666487547d5f23
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Wed Jan 3 12:13:15 2024 +0000

    [tech debt] Primitives renaming party / cleanup (#2396)
    
    This PR:
    - renames Vec2d to Vec
    - renames Vec2dModel to VecModel
    - renames Box2d to Box
    - renames Box2dModel to BoxModel
    - renames Matrix2d to Mat
    - renames Matrix2dModel to MatModel
    - removes unused primitive helpers
    - removes unused exports
    - removes a few redundant tests in dgreensp
    
    ### Change Type
    
    - [x] `major` ‚Äî Breaking change
    
    ### Release Notes
    
    - renames Vec2d to Vec
    - renames Vec2dModel to VecModel
    - renames Box2d to Box
    - renames Box2dModel to BoxModel
    - renames Matrix2d to Mat
    - renames Matrix2dModel to MatModel
    - removes unused primitive helpers

diff --git a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
index 634fa3f4c..328bba60d 100644
--- a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
+++ b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
@@ -1,5 +1,5 @@
 import {
-	Box2d,
+	Box,
 	RotateCorner,
 	TLEmbedShape,
 	TLSelectionForegroundComponent,
@@ -19,7 +19,7 @@ import { TldrawCropHandles } from './TldrawCropHandles'
 
 /** @public */
 export const TldrawSelectionForeground: TLSelectionForegroundComponent = track(
-	function TldrawSelectionForeground({ bounds, rotation }: { bounds: Box2d; rotation: number }) {
+	function TldrawSelectionForeground({ bounds, rotation }: { bounds: Box; rotation: number }) {
 		const editor = useEditor()
 		const rSvg = useRef<SVGSVGElement>(null)
 

commit dca7883f89ee3f1e9eedf1bbcf4562899e53f8a4
Author: Mime ƒåuvalo <mimecuvalo@gmail.com>
Date:   Fri Jan 12 09:40:42 2024 +0000

    [fix] disable vertical edge resizing for text on mobile (#2456)
    
    This is a followup to PR #2347 which was addressing #2349.
    This makes sure that vertical resizing is disabled still for the text
    shapes because they get in the way of rotation.
    
    Fixes #2455
    
    ### Change Type
    
    - [x] `patch` ‚Äî Bug fix
    - [ ] `minor` ‚Äî New feature
    - [ ] `major` ‚Äî Breaking change
    - [ ] `dependencies` ‚Äî Changes to package dependencies[^1]
    - [ ] `documentation` ‚Äî Changes to the documentation only[^2]
    - [ ] `tests` ‚Äî Changes to any test code only[^2]
    - [ ] `internal` ‚Äî Any other changes that don't affect the published
    package[^2]
    - [ ] I don't know
    
    [^1]: publishes a `patch` release, for devDependencies use `internal`
    [^2]: will not publish a new version
    
    ### Test Plan
    
    1. Add a step-by-step description of how to test your PR here.
    2.
    
    - [ ] Unit Tests
    - [ ] End to end tests
    
    ### Release Notes
    
    - Add a brief release note for your PR here.

diff --git a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
index 328bba60d..c42e91310 100644
--- a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
+++ b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
@@ -159,22 +159,21 @@ export const TldrawSelectionForeground: TLSelectionForegroundComponent = track(
 		const hideBottomRightCorner =
 			!shouldDisplayControls || !showHandles || (showOnlyOneHandle && !showCropHandles)
 
-		let hideEdgeTargetsDueToCoarsePointer = isCoarsePointer
-
-		if (hideEdgeTargetsDueToCoarsePointer && onlyShape && onlyShape.type === 'text') {
-			hideEdgeTargetsDueToCoarsePointer = false
-		}
-
 		// If we're showing crop handles, then show the edges too.
 		// If we're showing resize handles, then show the edges only
-		// if we're not hiding them for some other reason
-		let hideEdgeTargets = true
+		// if we're not hiding them for some other reason.
+		let hideVerticalEdgeTargets = true
+		// The same logic above applies here, except another nuance is that
+		// we enable resizing for text on mobile (coarse).
+		let hideHorizontalEdgeTargets = true
 
 		if (showCropHandles) {
-			hideEdgeTargets = hideAlternateCropHandles
+			hideVerticalEdgeTargets = hideAlternateCropHandles
+			hideHorizontalEdgeTargets = hideAlternateCropHandles
 		} else if (showResizeHandles) {
-			hideEdgeTargets =
-				hideAlternateCornerHandles || showOnlyOneHandle || hideEdgeTargetsDueToCoarsePointer
+			hideVerticalEdgeTargets = hideAlternateCornerHandles || showOnlyOneHandle || isCoarsePointer
+			const isMobileAndTextShape = isCoarsePointer && onlyShape && onlyShape.type === 'text'
+			hideHorizontalEdgeTargets = hideVerticalEdgeTargets && !isMobileAndTextShape
 		}
 
 		const textHandleHeight = Math.min(24 / zoom, height - targetSizeY * 3)
@@ -244,7 +243,7 @@ export const TldrawSelectionForeground: TLSelectionForegroundComponent = track(
 					{/* Targets */}
 					<rect
 						className={classNames('tl-transparent', {
-							'tl-hidden': hideEdgeTargets,
+							'tl-hidden': hideVerticalEdgeTargets,
 						})}
 						data-testid="selection.resize.top"
 						aria-label="top target"
@@ -258,7 +257,7 @@ export const TldrawSelectionForeground: TLSelectionForegroundComponent = track(
 					/>
 					<rect
 						className={classNames('tl-transparent', {
-							'tl-hidden': hideEdgeTargets,
+							'tl-hidden': hideHorizontalEdgeTargets,
 						})}
 						data-testid="selection.resize.right"
 						aria-label="right target"
@@ -272,7 +271,7 @@ export const TldrawSelectionForeground: TLSelectionForegroundComponent = track(
 					/>
 					<rect
 						className={classNames('tl-transparent', {
-							'tl-hidden': hideEdgeTargets,
+							'tl-hidden': hideVerticalEdgeTargets,
 						})}
 						data-testid="selection.resize.bottom"
 						aria-label="bottom target"
@@ -286,7 +285,7 @@ export const TldrawSelectionForeground: TLSelectionForegroundComponent = track(
 					/>
 					<rect
 						className={classNames('tl-transparent', {
-							'tl-hidden': hideEdgeTargets,
+							'tl-hidden': hideHorizontalEdgeTargets,
 						})}
 						data-testid="selection.resize.left"
 						aria-label="left target"

commit 29044867dd2e49a3711e95c547fa9352e66720b9
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon Jan 15 12:33:15 2024 +0000

    Add docs (#2470)
    
    This PR adds the docs app back into the tldraw monorepo.
    
    ## Deploying
    
    We'll want to update our deploy script to update the SOURCE_SHA to the
    newest release sha... and then deploy the docs pulling api.json files
    from that release. We _could_ update the docs on every push to main, but
    we don't have to unless something has changed. Right now there's no
    automated deployments from this repo.
    
    ## Side effects
    
    To make this one work, I needed to update the lock file. This might be
    ok (new year new lock file), and everything builds as expected, though
    we may want to spend some time with our scripts to be sure that things
    are all good.
    
    I also updated our prettier installation, which decided to add trailing
    commas to every generic type. Which is, I suppose, [correct
    behavior](https://github.com/prettier/prettier-vscode/issues/955)? But
    that caused diffs in every file, which is unfortunate.
    
    ### Change Type
    
    - [x] `internal` ‚Äî Any other changes that don't affect the published
    package[^2]

diff --git a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
index c42e91310..50285399d 100644
--- a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
+++ b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
@@ -140,7 +140,7 @@ export const TldrawSelectionForeground: TLSelectionForegroundComponent = track(
 			shouldDisplayControls &&
 			(onlyShape
 				? editor.getShapeUtil(onlyShape).canResize(onlyShape) &&
-				  !editor.getShapeUtil(onlyShape).hideResizeHandles(onlyShape)
+					!editor.getShapeUtil(onlyShape).hideResizeHandles(onlyShape)
 				: true) &&
 			!showCropHandles &&
 			!isLockedShape

commit e6e4e7f6cbac1cb72c0f530dae703c657dc8b6bf
Author: Dan Groshev <git@dgroshev.com>
Date:   Mon Feb 5 17:54:02 2024 +0000

    [dx] use Biome instead of Prettier, part 2 (#2731)
    
    Biome seems to be MUCH faster than Prettier. Unfortunately, it
    introduces some formatting changes around the ternary operator, so we
    have to update files in the repo. To make revert easier if we need it,
    the change is split into two PRs. This PR introduces a Biome CI check
    and reformats all files accordingly.
    
    ## Change Type
    - [x] `minor` ‚Äî New feature

diff --git a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
index 50285399d..c42e91310 100644
--- a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
+++ b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
@@ -140,7 +140,7 @@ export const TldrawSelectionForeground: TLSelectionForegroundComponent = track(
 			shouldDisplayControls &&
 			(onlyShape
 				? editor.getShapeUtil(onlyShape).canResize(onlyShape) &&
-					!editor.getShapeUtil(onlyShape).hideResizeHandles(onlyShape)
+				  !editor.getShapeUtil(onlyShape).hideResizeHandles(onlyShape)
 				: true) &&
 			!showCropHandles &&
 			!isLockedShape

commit 86cce6d161e2018f02fc4271bbcff803d07fa339
Author: Dan Groshev <git@dgroshev.com>
Date:   Wed Feb 7 16:02:22 2024 +0000

    Unbiome (#2776)
    
    Biome as it is now didn't work out for us üò¢
    
    Summary for posterity:
    
    * it IS much, much faster, fast enough to skip any sort of caching
    * we couldn't fully replace Prettier just yet. We use Prettier
    programmatically to format code in docs, and Biome's JS interface is
    officially alpha and [had legacy peer deps
    set](https://github.com/biomejs/biome/pull/1756) (which would fail our
    CI build as we don't allow installation warnings)
    * ternary formatting differs from Prettier, leading to a large diff
    https://github.com/biomejs/biome/issues/1661
    * import sorting differs from Prettier's
    `prettier-plugin-organize-imports`, making the diff even bigger
    * the deal breaker is a multi-second delay on saving large files (for us
    it's
    [Editor.ts](https://github.com/tldraw/tldraw/blob/main/packages/editor/src/lib/editor/Editor.ts))
    in VSCode when import sorting is enabled. There is a seemingly relevant
    Biome issue where I posted a small summary of our findings:
    https://github.com/biomejs/biome/issues/1569#issuecomment-1930411623
    
    Further actions:
    
    * reevaluate in a few months as Biome matures
    
    ### Change Type
    
    - [x] `internal` ‚Äî Any other changes that don't affect the published
    package

diff --git a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
index c42e91310..50285399d 100644
--- a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
+++ b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
@@ -140,7 +140,7 @@ export const TldrawSelectionForeground: TLSelectionForegroundComponent = track(
 			shouldDisplayControls &&
 			(onlyShape
 				? editor.getShapeUtil(onlyShape).canResize(onlyShape) &&
-				  !editor.getShapeUtil(onlyShape).hideResizeHandles(onlyShape)
+					!editor.getShapeUtil(onlyShape).hideResizeHandles(onlyShape)
 				: true) &&
 			!showCropHandles &&
 			!isLockedShape

commit 3e41c3acd750d99b77adf967439d2f636a1315c2
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Sun Feb 18 23:01:00 2024 +0000

    [fix] grid, other insets (#2858)
    
    Fix the grid and other insets, a few CSS cleanups.
    
    ### Change Type
    
    - [x] `patch` ‚Äî Bug fix
    
    ### Test Plan
    
    1. Turn on the grid.
    
    - [ ] Unit Tests
    - [ ] End to end tests
    
    ### Release Notes
    
    - Fixes a bug with the grid not appearing.

diff --git a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
index 50285399d..244ff5692 100644
--- a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
+++ b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
@@ -185,14 +185,11 @@ export const TldrawSelectionForeground: TLSelectionForegroundComponent = track(
 			textHandleHeight * zoom >= 4
 
 		return (
-			<svg
-				className="tl-overlays__item tl-selection__fg tl-svg-context"
-				data-testid="selection-foreground"
-			>
+			<svg className="tl-overlays__item tl-selection__fg" data-testid="selection-foreground">
 				<g ref={rSvg}>
 					{shouldDisplayBox && (
 						<rect
-							className={classNames('tl-selection__fg__outline')}
+							className="tl-selection__fg__outline"
 							width={toDomPrecision(width)}
 							height={toDomPrecision(height)}
 						/>

commit 9fc5f4459f674b121cc177f8ae99efa9fdb442c8
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon Feb 19 14:52:43 2024 +0000

    Roundup fixes (#2862)
    
    This one is a roundup of superficial changes, apologies for having them
    in a single PR.
    
    This PR:
    - does some chair re-arranging for one of our hotter paths related to
    updating shapes
    - changes our type exports for editor components
    - adds shape indicator to editor components
    - moves canvas to be an editor component
    - fixes a CSS bug with hinted buttons
    - fixes CSS bugs with the menus
    - fixes bad imports in examples
    
    ### Change Type
    
    - [x] `major`

diff --git a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
index 244ff5692..295b4f8cb 100644
--- a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
+++ b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
@@ -1,8 +1,7 @@
 import {
-	Box,
 	RotateCorner,
 	TLEmbedShape,
-	TLSelectionForegroundComponent,
+	TLSelectionForegroundProps,
 	TLTextShape,
 	getCursor,
 	toDomPrecision,
@@ -18,428 +17,428 @@ import { useReadonly } from '../ui/hooks/useReadonly'
 import { TldrawCropHandles } from './TldrawCropHandles'
 
 /** @public */
-export const TldrawSelectionForeground: TLSelectionForegroundComponent = track(
-	function TldrawSelectionForeground({ bounds, rotation }: { bounds: Box; rotation: number }) {
-		const editor = useEditor()
-		const rSvg = useRef<SVGSVGElement>(null)
-
-		const isReadonlyMode = useReadonly()
-		const topEvents = useSelectionEvents('top')
-		const rightEvents = useSelectionEvents('right')
-		const bottomEvents = useSelectionEvents('bottom')
-		const leftEvents = useSelectionEvents('left')
-		const topLeftEvents = useSelectionEvents('top_left')
-		const topRightEvents = useSelectionEvents('top_right')
-		const bottomRightEvents = useSelectionEvents('bottom_right')
-		const bottomLeftEvents = useSelectionEvents('bottom_left')
-
-		const isDefaultCursor =
-			!editor.getIsMenuOpen() && editor.getInstanceState().cursor.type === 'default'
-		const isCoarsePointer = editor.getInstanceState().isCoarsePointer
-
-		const onlyShape = editor.getOnlySelectedShape()
-		const isLockedShape = onlyShape && editor.isShapeOrAncestorLocked(onlyShape)
-
-		// if all shapes have an expandBy for the selection outline, we can expand by the l
-		const expandOutlineBy = onlyShape
-			? editor.getShapeUtil(onlyShape).expandSelectionOutlinePx(onlyShape)
-			: 0
-
-		useTransform(rSvg, bounds?.x, bounds?.y, 1, editor.getSelectionRotation(), {
-			x: -expandOutlineBy,
-			y: -expandOutlineBy,
-		})
-
-		if (!bounds) return null
-		bounds = bounds.clone().expandBy(expandOutlineBy).zeroFix()
-
-		const zoom = editor.getZoomLevel()
-		const isChangingStyle = editor.getInstanceState().isChangingStyle
-
-		const width = bounds.width
-		const height = bounds.height
-
-		const size = 8 / zoom
-		const isTinyX = width < size * 2
-		const isTinyY = height < size * 2
-
-		const isSmallX = width < size * 4
-		const isSmallY = height < size * 4
-		const isSmallCropX = width < size * 5
-		const isSmallCropY = height < size * 5
-
-		const mobileHandleMultiplier = isCoarsePointer ? 1.75 : 1
-		const targetSize = (6 / zoom) * mobileHandleMultiplier
-
-		const targetSizeX = (isSmallX ? targetSize / 2 : targetSize) * (mobileHandleMultiplier * 0.75)
-		const targetSizeY = (isSmallY ? targetSize / 2 : targetSize) * (mobileHandleMultiplier * 0.75)
-
-		const showSelectionBounds =
-			(onlyShape ? !editor.getShapeUtil(onlyShape).hideSelectionBoundsFg(onlyShape) : true) &&
-			!isChangingStyle
-
-		let shouldDisplayBox =
-			(showSelectionBounds &&
-				editor.isInAny(
-					'select.idle',
-					'select.brushing',
-					'select.scribble_brushing',
-					'select.pointing_canvas',
-					'select.pointing_selection',
-					'select.pointing_shape',
-					'select.crop.idle',
-					'select.crop.pointing_crop',
-					'select.pointing_resize_handle',
-					'select.pointing_crop_handle'
-				)) ||
-			(showSelectionBounds &&
-				editor.isIn('select.resizing') &&
-				onlyShape &&
-				editor.isShapeOfType<TLTextShape>(onlyShape, 'text'))
-
-		if (onlyShape && shouldDisplayBox) {
-			if (editor.environment.isFirefox && editor.isShapeOfType<TLEmbedShape>(onlyShape, 'embed')) {
-				shouldDisplayBox = false
-			}
-		}
+export const TldrawSelectionForeground = track(function TldrawSelectionForeground({
+	bounds,
+	rotation,
+}: TLSelectionForegroundProps) {
+	const editor = useEditor()
+	const rSvg = useRef<SVGSVGElement>(null)
 
-		const showCropHandles =
-			editor.isInAny(
-				'select.pointing_crop_handle',
-				'select.crop.idle',
-				'select.crop.pointing_crop'
-			) &&
-			!isChangingStyle &&
-			!isReadonlyMode
+	const isReadonlyMode = useReadonly()
+	const topEvents = useSelectionEvents('top')
+	const rightEvents = useSelectionEvents('right')
+	const bottomEvents = useSelectionEvents('bottom')
+	const leftEvents = useSelectionEvents('left')
+	const topLeftEvents = useSelectionEvents('top_left')
+	const topRightEvents = useSelectionEvents('top_right')
+	const bottomRightEvents = useSelectionEvents('bottom_right')
+	const bottomLeftEvents = useSelectionEvents('bottom_left')
+
+	const isDefaultCursor =
+		!editor.getIsMenuOpen() && editor.getInstanceState().cursor.type === 'default'
+	const isCoarsePointer = editor.getInstanceState().isCoarsePointer
+
+	const onlyShape = editor.getOnlySelectedShape()
+	const isLockedShape = onlyShape && editor.isShapeOrAncestorLocked(onlyShape)
+
+	// if all shapes have an expandBy for the selection outline, we can expand by the l
+	const expandOutlineBy = onlyShape
+		? editor.getShapeUtil(onlyShape).expandSelectionOutlinePx(onlyShape)
+		: 0
+
+	useTransform(rSvg, bounds?.x, bounds?.y, 1, editor.getSelectionRotation(), {
+		x: -expandOutlineBy,
+		y: -expandOutlineBy,
+	})
+
+	if (!bounds) return null
+	bounds = bounds.clone().expandBy(expandOutlineBy).zeroFix()
+
+	const zoom = editor.getZoomLevel()
+	const isChangingStyle = editor.getInstanceState().isChangingStyle
+
+	const width = bounds.width
+	const height = bounds.height
+
+	const size = 8 / zoom
+	const isTinyX = width < size * 2
+	const isTinyY = height < size * 2
+
+	const isSmallX = width < size * 4
+	const isSmallY = height < size * 4
+	const isSmallCropX = width < size * 5
+	const isSmallCropY = height < size * 5
+
+	const mobileHandleMultiplier = isCoarsePointer ? 1.75 : 1
+	const targetSize = (6 / zoom) * mobileHandleMultiplier
+
+	const targetSizeX = (isSmallX ? targetSize / 2 : targetSize) * (mobileHandleMultiplier * 0.75)
+	const targetSizeY = (isSmallY ? targetSize / 2 : targetSize) * (mobileHandleMultiplier * 0.75)
+
+	const showSelectionBounds =
+		(onlyShape ? !editor.getShapeUtil(onlyShape).hideSelectionBoundsFg(onlyShape) : true) &&
+		!isChangingStyle
 
-		const shouldDisplayControls =
+	let shouldDisplayBox =
+		(showSelectionBounds &&
 			editor.isInAny(
 				'select.idle',
+				'select.brushing',
+				'select.scribble_brushing',
+				'select.pointing_canvas',
 				'select.pointing_selection',
 				'select.pointing_shape',
-				'select.crop.idle'
-			) &&
-			!isChangingStyle &&
-			!isReadonlyMode
-
-		const showCornerRotateHandles =
-			!isCoarsePointer &&
-			!(isTinyX || isTinyY) &&
-			(shouldDisplayControls || showCropHandles) &&
-			(onlyShape ? !editor.getShapeUtil(onlyShape).hideRotateHandle(onlyShape) : true) &&
-			!isLockedShape
-
-		const showMobileRotateHandle =
-			isCoarsePointer &&
-			(!isSmallX || !isSmallY) &&
-			(shouldDisplayControls || showCropHandles) &&
-			(onlyShape ? !editor.getShapeUtil(onlyShape).hideRotateHandle(onlyShape) : true) &&
-			!isLockedShape
-
-		const showResizeHandles =
-			shouldDisplayControls &&
-			(onlyShape
-				? editor.getShapeUtil(onlyShape).canResize(onlyShape) &&
-					!editor.getShapeUtil(onlyShape).hideResizeHandles(onlyShape)
-				: true) &&
-			!showCropHandles &&
-			!isLockedShape
-
-		const hideAlternateCornerHandles = isTinyX || isTinyY
-		const showOnlyOneHandle = isTinyX && isTinyY
-		const hideAlternateCropHandles = isSmallCropX || isSmallCropY
-
-		const showHandles = showResizeHandles || showCropHandles
-		const hideRotateCornerHandles = !showCornerRotateHandles
-		const hideMobileRotateHandle = !shouldDisplayControls || !showMobileRotateHandle
-		const hideTopLeftCorner = !shouldDisplayControls || !showHandles
-		const hideTopRightCorner = !shouldDisplayControls || !showHandles || hideAlternateCornerHandles
-		const hideBottomLeftCorner =
-			!shouldDisplayControls || !showHandles || hideAlternateCornerHandles
-		const hideBottomRightCorner =
-			!shouldDisplayControls || !showHandles || (showOnlyOneHandle && !showCropHandles)
-
-		// If we're showing crop handles, then show the edges too.
-		// If we're showing resize handles, then show the edges only
-		// if we're not hiding them for some other reason.
-		let hideVerticalEdgeTargets = true
-		// The same logic above applies here, except another nuance is that
-		// we enable resizing for text on mobile (coarse).
-		let hideHorizontalEdgeTargets = true
-
-		if (showCropHandles) {
-			hideVerticalEdgeTargets = hideAlternateCropHandles
-			hideHorizontalEdgeTargets = hideAlternateCropHandles
-		} else if (showResizeHandles) {
-			hideVerticalEdgeTargets = hideAlternateCornerHandles || showOnlyOneHandle || isCoarsePointer
-			const isMobileAndTextShape = isCoarsePointer && onlyShape && onlyShape.type === 'text'
-			hideHorizontalEdgeTargets = hideVerticalEdgeTargets && !isMobileAndTextShape
+				'select.crop.idle',
+				'select.crop.pointing_crop',
+				'select.pointing_resize_handle',
+				'select.pointing_crop_handle'
+			)) ||
+		(showSelectionBounds &&
+			editor.isIn('select.resizing') &&
+			onlyShape &&
+			editor.isShapeOfType<TLTextShape>(onlyShape, 'text'))
+
+	if (onlyShape && shouldDisplayBox) {
+		if (editor.environment.isFirefox && editor.isShapeOfType<TLEmbedShape>(onlyShape, 'embed')) {
+			shouldDisplayBox = false
 		}
+	}
 
-		const textHandleHeight = Math.min(24 / zoom, height - targetSizeY * 3)
-		const showTextResizeHandles =
-			shouldDisplayControls &&
-			isCoarsePointer &&
-			onlyShape &&
-			editor.isShapeOfType<TLTextShape>(onlyShape, 'text') &&
-			textHandleHeight * zoom >= 4
+	const showCropHandles =
+		editor.isInAny(
+			'select.pointing_crop_handle',
+			'select.crop.idle',
+			'select.crop.pointing_crop'
+		) &&
+		!isChangingStyle &&
+		!isReadonlyMode
+
+	const shouldDisplayControls =
+		editor.isInAny(
+			'select.idle',
+			'select.pointing_selection',
+			'select.pointing_shape',
+			'select.crop.idle'
+		) &&
+		!isChangingStyle &&
+		!isReadonlyMode
+
+	const showCornerRotateHandles =
+		!isCoarsePointer &&
+		!(isTinyX || isTinyY) &&
+		(shouldDisplayControls || showCropHandles) &&
+		(onlyShape ? !editor.getShapeUtil(onlyShape).hideRotateHandle(onlyShape) : true) &&
+		!isLockedShape
+
+	const showMobileRotateHandle =
+		isCoarsePointer &&
+		(!isSmallX || !isSmallY) &&
+		(shouldDisplayControls || showCropHandles) &&
+		(onlyShape ? !editor.getShapeUtil(onlyShape).hideRotateHandle(onlyShape) : true) &&
+		!isLockedShape
+
+	const showResizeHandles =
+		shouldDisplayControls &&
+		(onlyShape
+			? editor.getShapeUtil(onlyShape).canResize(onlyShape) &&
+				!editor.getShapeUtil(onlyShape).hideResizeHandles(onlyShape)
+			: true) &&
+		!showCropHandles &&
+		!isLockedShape
+
+	const hideAlternateCornerHandles = isTinyX || isTinyY
+	const showOnlyOneHandle = isTinyX && isTinyY
+	const hideAlternateCropHandles = isSmallCropX || isSmallCropY
+
+	const showHandles = showResizeHandles || showCropHandles
+	const hideRotateCornerHandles = !showCornerRotateHandles
+	const hideMobileRotateHandle = !shouldDisplayControls || !showMobileRotateHandle
+	const hideTopLeftCorner = !shouldDisplayControls || !showHandles
+	const hideTopRightCorner = !shouldDisplayControls || !showHandles || hideAlternateCornerHandles
+	const hideBottomLeftCorner = !shouldDisplayControls || !showHandles || hideAlternateCornerHandles
+	const hideBottomRightCorner =
+		!shouldDisplayControls || !showHandles || (showOnlyOneHandle && !showCropHandles)
+
+	// If we're showing crop handles, then show the edges too.
+	// If we're showing resize handles, then show the edges only
+	// if we're not hiding them for some other reason.
+	let hideVerticalEdgeTargets = true
+	// The same logic above applies here, except another nuance is that
+	// we enable resizing for text on mobile (coarse).
+	let hideHorizontalEdgeTargets = true
+
+	if (showCropHandles) {
+		hideVerticalEdgeTargets = hideAlternateCropHandles
+		hideHorizontalEdgeTargets = hideAlternateCropHandles
+	} else if (showResizeHandles) {
+		hideVerticalEdgeTargets = hideAlternateCornerHandles || showOnlyOneHandle || isCoarsePointer
+		const isMobileAndTextShape = isCoarsePointer && onlyShape && onlyShape.type === 'text'
+		hideHorizontalEdgeTargets = hideVerticalEdgeTargets && !isMobileAndTextShape
+	}
 
-		return (
-			<svg className="tl-overlays__item tl-selection__fg" data-testid="selection-foreground">
-				<g ref={rSvg}>
-					{shouldDisplayBox && (
-						<rect
-							className="tl-selection__fg__outline"
-							width={toDomPrecision(width)}
-							height={toDomPrecision(height)}
-						/>
-					)}
-					<RotateCornerHandle
-						data-testid="selection.rotate.top-left"
-						cx={0}
-						cy={0}
-						targetSize={targetSize}
-						corner="top_left_rotate"
-						cursor={isDefaultCursor ? getCursor('nwse-rotate', rotation) : undefined}
-						isHidden={hideRotateCornerHandles}
-					/>
-					<RotateCornerHandle
-						data-testid="selection.rotate.top-right"
-						cx={width + targetSize * 3}
-						cy={0}
-						targetSize={targetSize}
-						corner="top_right_rotate"
-						cursor={isDefaultCursor ? getCursor('nesw-rotate', rotation) : undefined}
-						isHidden={hideRotateCornerHandles}
-					/>
-					<RotateCornerHandle
-						data-testid="selection.rotate.bottom-left"
-						cx={0}
-						cy={height + targetSize * 3}
-						targetSize={targetSize}
-						corner="bottom_left_rotate"
-						cursor={isDefaultCursor ? getCursor('swne-rotate', rotation) : undefined}
-						isHidden={hideRotateCornerHandles}
-					/>
-					<RotateCornerHandle
-						data-testid="selection.rotate.bottom-right"
-						cx={width + targetSize * 3}
-						cy={height + targetSize * 3}
-						targetSize={targetSize}
-						corner="bottom_right_rotate"
-						cursor={isDefaultCursor ? getCursor('senw-rotate', rotation) : undefined}
-						isHidden={hideRotateCornerHandles}
-					/>
-					<MobileRotateHandle
-						data-testid="selection.rotate.mobile"
-						cx={isSmallX ? -targetSize * 1.5 : width / 2}
-						cy={isSmallX ? height / 2 : -targetSize * 1.5}
-						size={size}
-						isHidden={hideMobileRotateHandle}
-					/>
-					{/* Targets */}
-					<rect
-						className={classNames('tl-transparent', {
-							'tl-hidden': hideVerticalEdgeTargets,
-						})}
-						data-testid="selection.resize.top"
-						aria-label="top target"
-						pointerEvents="all"
-						x={0}
-						y={toDomPrecision(0 - (isSmallY ? targetSizeY * 2 : targetSizeY))}
-						width={toDomPrecision(width)}
-						height={toDomPrecision(Math.max(1, targetSizeY * 2))}
-						style={isDefaultCursor ? { cursor: getCursor('ns-resize', rotation) } : undefined}
-						{...topEvents}
-					/>
-					<rect
-						className={classNames('tl-transparent', {
-							'tl-hidden': hideHorizontalEdgeTargets,
-						})}
-						data-testid="selection.resize.right"
-						aria-label="right target"
-						pointerEvents="all"
-						x={toDomPrecision(width - (isSmallX ? 0 : targetSizeX))}
-						y={0}
-						height={toDomPrecision(height)}
-						width={toDomPrecision(Math.max(1, targetSizeX * 2))}
-						style={isDefaultCursor ? { cursor: getCursor('ew-resize', rotation) } : undefined}
-						{...rightEvents}
-					/>
+	const textHandleHeight = Math.min(24 / zoom, height - targetSizeY * 3)
+	const showTextResizeHandles =
+		shouldDisplayControls &&
+		isCoarsePointer &&
+		onlyShape &&
+		editor.isShapeOfType<TLTextShape>(onlyShape, 'text') &&
+		textHandleHeight * zoom >= 4
+
+	return (
+		<svg className="tl-overlays__item tl-selection__fg" data-testid="selection-foreground">
+			<g ref={rSvg}>
+				{shouldDisplayBox && (
 					<rect
-						className={classNames('tl-transparent', {
-							'tl-hidden': hideVerticalEdgeTargets,
-						})}
-						data-testid="selection.resize.bottom"
-						aria-label="bottom target"
-						pointerEvents="all"
-						x={0}
-						y={toDomPrecision(height - (isSmallY ? 0 : targetSizeY))}
+						className="tl-selection__fg__outline"
 						width={toDomPrecision(width)}
-						height={toDomPrecision(Math.max(1, targetSizeY * 2))}
-						style={isDefaultCursor ? { cursor: getCursor('ns-resize', rotation) } : undefined}
-						{...bottomEvents}
-					/>
-					<rect
-						className={classNames('tl-transparent', {
-							'tl-hidden': hideHorizontalEdgeTargets,
-						})}
-						data-testid="selection.resize.left"
-						aria-label="left target"
-						pointerEvents="all"
-						x={toDomPrecision(0 - (isSmallX ? targetSizeX * 2 : targetSizeX))}
-						y={0}
 						height={toDomPrecision(height)}
-						width={toDomPrecision(Math.max(1, targetSizeX * 2))}
-						style={isDefaultCursor ? { cursor: getCursor('ew-resize', rotation) } : undefined}
-						{...leftEvents}
-					/>
-					{/* Corner Targets */}
-					<rect
-						className={classNames('tl-transparent', {
-							'tl-hidden': hideTopLeftCorner,
-						})}
-						data-testid="selection.target.top-left"
-						aria-label="top-left target"
-						pointerEvents="all"
-						x={toDomPrecision(0 - (isSmallX ? targetSizeX * 2 : targetSizeX * 1.5))}
-						y={toDomPrecision(0 - (isSmallY ? targetSizeY * 2 : targetSizeY * 1.5))}
-						width={toDomPrecision(targetSizeX * 3)}
-						height={toDomPrecision(targetSizeY * 3)}
-						style={isDefaultCursor ? { cursor: getCursor('nwse-resize', rotation) } : undefined}
-						{...topLeftEvents}
-					/>
-					<rect
-						className={classNames('tl-transparent', {
-							'tl-hidden': hideTopRightCorner,
-						})}
-						data-testid="selection.target.top-right"
-						aria-label="top-right target"
-						pointerEvents="all"
-						x={toDomPrecision(width - (isSmallX ? 0 : targetSizeX * 1.5))}
-						y={toDomPrecision(0 - (isSmallY ? targetSizeY * 2 : targetSizeY * 1.5))}
-						width={toDomPrecision(targetSizeX * 3)}
-						height={toDomPrecision(targetSizeY * 3)}
-						style={isDefaultCursor ? { cursor: getCursor('nesw-resize', rotation) } : undefined}
-						{...topRightEvents}
-					/>
-					<rect
-						className={classNames('tl-transparent', {
-							'tl-hidden': hideBottomRightCorner,
-						})}
-						data-testid="selection.target.bottom-right"
-						aria-label="bottom-right target"
-						pointerEvents="all"
-						x={toDomPrecision(width - (isSmallX ? targetSizeX : targetSizeX * 1.5))}
-						y={toDomPrecision(height - (isSmallY ? targetSizeY : targetSizeY * 1.5))}
-						width={toDomPrecision(targetSizeX * 3)}
-						height={toDomPrecision(targetSizeY * 3)}
-						style={isDefaultCursor ? { cursor: getCursor('nwse-resize', rotation) } : undefined}
-						{...bottomRightEvents}
-					/>
-					<rect
-						className={classNames('tl-transparent', {
-							'tl-hidden': hideBottomLeftCorner,
-						})}
-						data-testid="selection.target.bottom-left"
-						aria-label="bottom-left target"
-						pointerEvents="all"
-						x={toDomPrecision(0 - (isSmallX ? targetSizeX * 3 : targetSizeX * 1.5))}
-						y={toDomPrecision(height - (isSmallY ? 0 : targetSizeY * 1.5))}
-						width={toDomPrecision(targetSizeX * 3)}
-						height={toDomPrecision(targetSizeY * 3)}
-						style={isDefaultCursor ? { cursor: getCursor('nesw-resize', rotation) } : undefined}
-						{...bottomLeftEvents}
 					/>
-					{/* Resize Handles */}
-					{showResizeHandles && (
-						<>
-							<rect
-								data-testid="selection.resize.top-left"
-								className={classNames('tl-corner-handle', {
-									'tl-hidden': hideTopLeftCorner,
-								})}
-								aria-label="top_left handle"
-								x={toDomPrecision(0 - size / 2)}
-								y={toDomPrecision(0 - size / 2)}
-								width={toDomPrecision(size)}
-								height={toDomPrecision(size)}
-							/>
-							<rect
-								data-testid="selection.resize.top-right"
-								className={classNames('tl-corner-handle', {
-									'tl-hidden': hideTopRightCorner,
-								})}
-								aria-label="top_right handle"
-								x={toDomPrecision(width - size / 2)}
-								y={toDomPrecision(0 - size / 2)}
-								width={toDomPrecision(size)}
-								height={toDomPrecision(size)}
-							/>
-							<rect
-								data-testid="selection.resize.bottom-right"
-								className={classNames('tl-corner-handle', {
-									'tl-hidden': hideBottomRightCorner,
-								})}
-								aria-label="bottom_right handle"
-								x={toDomPrecision(width - size / 2)}
-								y={toDomPrecision(height - size / 2)}
-								width={toDomPrecision(size)}
-								height={toDomPrecision(size)}
-							/>
-							<rect
-								data-testid="selection.resize.bottom-left"
-								className={classNames('tl-corner-handle', {
-									'tl-hidden': hideBottomLeftCorner,
-								})}
-								aria-label="bottom_left handle"
-								x={toDomPrecision(0 - size / 2)}
-								y={toDomPrecision(height - size / 2)}
-								width={toDomPrecision(size)}
-								height={toDomPrecision(size)}
-							/>
-						</>
-					)}
-					{showTextResizeHandles && (
-						<>
-							<rect
-								data-testid="selection.text-resize.left.handle"
-								className="tl-text-handle"
-								aria-label="bottom_left handle"
-								x={toDomPrecision(0 - size / 4)}
-								y={toDomPrecision(height / 2 - textHandleHeight / 2)}
-								rx={size / 4}
-								width={toDomPrecision(size / 2)}
-								height={toDomPrecision(textHandleHeight)}
-							/>
-							<rect
-								data-testid="selection.text-resize.right.handle"
-								className="tl-text-handle"
-								aria-label="bottom_left handle"
-								rx={size / 4}
-								x={toDomPrecision(width - size / 4)}
-								y={toDomPrecision(height / 2 - textHandleHeight / 2)}
-								width={toDomPrecision(size / 2)}
-								height={toDomPrecision(textHandleHeight)}
-							/>
-						</>
-					)}
-					{/* Crop Handles */}
-					{showCropHandles && (
-						<TldrawCropHandles
-							{...{
-								size,
-								width,
-								height,
-								hideAlternateHandles: hideAlternateCropHandles,
-							}}
+				)}
+				<RotateCornerHandle
+					data-testid="selection.rotate.top-left"
+					cx={0}
+					cy={0}
+					targetSize={targetSize}
+					corner="top_left_rotate"
+					cursor={isDefaultCursor ? getCursor('nwse-rotate', rotation) : undefined}
+					isHidden={hideRotateCornerHandles}
+				/>
+				<RotateCornerHandle
+					data-testid="selection.rotate.top-right"
+					cx={width + targetSize * 3}
+					cy={0}
+					targetSize={targetSize}
+					corner="top_right_rotate"
+					cursor={isDefaultCursor ? getCursor('nesw-rotate', rotation) : undefined}
+					isHidden={hideRotateCornerHandles}
+				/>
+				<RotateCornerHandle
+					data-testid="selection.rotate.bottom-left"
+					cx={0}
+					cy={height + targetSize * 3}
+					targetSize={targetSize}
+					corner="bottom_left_rotate"
+					cursor={isDefaultCursor ? getCursor('swne-rotate', rotation) : undefined}
+					isHidden={hideRotateCornerHandles}
+				/>
+				<RotateCornerHandle
+					data-testid="selection.rotate.bottom-right"
+					cx={width + targetSize * 3}
+					cy={height + targetSize * 3}
+					targetSize={targetSize}
+					corner="bottom_right_rotate"
+					cursor={isDefaultCursor ? getCursor('senw-rotate', rotation) : undefined}
+					isHidden={hideRotateCornerHandles}
+				/>
+				<MobileRotateHandle
+					data-testid="selection.rotate.mobile"
+					cx={isSmallX ? -targetSize * 1.5 : width / 2}
+					cy={isSmallX ? height / 2 : -targetSize * 1.5}
+					size={size}
+					isHidden={hideMobileRotateHandle}
+				/>
+				{/* Targets */}
+				<rect
+					className={classNames('tl-transparent', {
+						'tl-hidden': hideVerticalEdgeTargets,
+					})}
+					data-testid="selection.resize.top"
+					aria-label="top target"
+					pointerEvents="all"
+					x={0}
+					y={toDomPrecision(0 - (isSmallY ? targetSizeY * 2 : targetSizeY))}
+					width={toDomPrecision(width)}
+					height={toDomPrecision(Math.max(1, targetSizeY * 2))}
+					style={isDefaultCursor ? { cursor: getCursor('ns-resize', rotation) } : undefined}
+					{...topEvents}
+				/>
+				<rect
+					className={classNames('tl-transparent', {
+						'tl-hidden': hideHorizontalEdgeTargets,
+					})}
+					data-testid="selection.resize.right"
+					aria-label="right target"
+					pointerEvents="all"
+					x={toDomPrecision(width - (isSmallX ? 0 : targetSizeX))}
+					y={0}
+					height={toDomPrecision(height)}
+					width={toDomPrecision(Math.max(1, targetSizeX * 2))}
+					style={isDefaultCursor ? { cursor: getCursor('ew-resize', rotation) } : undefined}
+					{...rightEvents}
+				/>
+				<rect
+					className={classNames('tl-transparent', {
+						'tl-hidden': hideVerticalEdgeTargets,
+					})}
+					data-testid="selection.resize.bottom"
+					aria-label="bottom target"
+					pointerEvents="all"
+					x={0}
+					y={toDomPrecision(height - (isSmallY ? 0 : targetSizeY))}
+					width={toDomPrecision(width)}
+					height={toDomPrecision(Math.max(1, targetSizeY * 2))}
+					style={isDefaultCursor ? { cursor: getCursor('ns-resize', rotation) } : undefined}
+					{...bottomEvents}
+				/>
+				<rect
+					className={classNames('tl-transparent', {
+						'tl-hidden': hideHorizontalEdgeTargets,
+					})}
+					data-testid="selection.resize.left"
+					aria-label="left target"
+					pointerEvents="all"
+					x={toDomPrecision(0 - (isSmallX ? targetSizeX * 2 : targetSizeX))}
+					y={0}
+					height={toDomPrecision(height)}
+					width={toDomPrecision(Math.max(1, targetSizeX * 2))}
+					style={isDefaultCursor ? { cursor: getCursor('ew-resize', rotation) } : undefined}
+					{...leftEvents}
+				/>
+				{/* Corner Targets */}
+				<rect
+					className={classNames('tl-transparent', {
+						'tl-hidden': hideTopLeftCorner,
+					})}
+					data-testid="selection.target.top-left"
+					aria-label="top-left target"
+					pointerEvents="all"
+					x={toDomPrecision(0 - (isSmallX ? targetSizeX * 2 : targetSizeX * 1.5))}
+					y={toDomPrecision(0 - (isSmallY ? targetSizeY * 2 : targetSizeY * 1.5))}
+					width={toDomPrecision(targetSizeX * 3)}
+					height={toDomPrecision(targetSizeY * 3)}
+					style={isDefaultCursor ? { cursor: getCursor('nwse-resize', rotation) } : undefined}
+					{...topLeftEvents}
+				/>
+				<rect
+					className={classNames('tl-transparent', {
+						'tl-hidden': hideTopRightCorner,
+					})}
+					data-testid="selection.target.top-right"
+					aria-label="top-right target"
+					pointerEvents="all"
+					x={toDomPrecision(width - (isSmallX ? 0 : targetSizeX * 1.5))}
+					y={toDomPrecision(0 - (isSmallY ? targetSizeY * 2 : targetSizeY * 1.5))}
+					width={toDomPrecision(targetSizeX * 3)}
+					height={toDomPrecision(targetSizeY * 3)}
+					style={isDefaultCursor ? { cursor: getCursor('nesw-resize', rotation) } : undefined}
+					{...topRightEvents}
+				/>
+				<rect
+					className={classNames('tl-transparent', {
+						'tl-hidden': hideBottomRightCorner,
+					})}
+					data-testid="selection.target.bottom-right"
+					aria-label="bottom-right target"
+					pointerEvents="all"
+					x={toDomPrecision(width - (isSmallX ? targetSizeX : targetSizeX * 1.5))}
+					y={toDomPrecision(height - (isSmallY ? targetSizeY : targetSizeY * 1.5))}
+					width={toDomPrecision(targetSizeX * 3)}
+					height={toDomPrecision(targetSizeY * 3)}
+					style={isDefaultCursor ? { cursor: getCursor('nwse-resize', rotation) } : undefined}
+					{...bottomRightEvents}
+				/>
+				<rect
+					className={classNames('tl-transparent', {
+						'tl-hidden': hideBottomLeftCorner,
+					})}
+					data-testid="selection.target.bottom-left"
+					aria-label="bottom-left target"
+					pointerEvents="all"
+					x={toDomPrecision(0 - (isSmallX ? targetSizeX * 3 : targetSizeX * 1.5))}
+					y={toDomPrecision(height - (isSmallY ? 0 : targetSizeY * 1.5))}
+					width={toDomPrecision(targetSizeX * 3)}
+					height={toDomPrecision(targetSizeY * 3)}
+					style={isDefaultCursor ? { cursor: getCursor('nesw-resize', rotation) } : undefined}
+					{...bottomLeftEvents}
+				/>
+				{/* Resize Handles */}
+				{showResizeHandles && (
+					<>
+						<rect
+							data-testid="selection.resize.top-left"
+							className={classNames('tl-corner-handle', {
+								'tl-hidden': hideTopLeftCorner,
+							})}
+							aria-label="top_left handle"
+							x={toDomPrecision(0 - size / 2)}
+							y={toDomPrecision(0 - size / 2)}
+							width={toDomPrecision(size)}
+							height={toDomPrecision(size)}
 						/>
-					)}
-				</g>
-			</svg>
-		)
-	}
-)
+						<rect
+							data-testid="selection.resize.top-right"
+							className={classNames('tl-corner-handle', {
+								'tl-hidden': hideTopRightCorner,
+							})}
+							aria-label="top_right handle"
+							x={toDomPrecision(width - size / 2)}
+							y={toDomPrecision(0 - size / 2)}
+							width={toDomPrecision(size)}
+							height={toDomPrecision(size)}
+						/>
+						<rect
+							data-testid="selection.resize.bottom-right"
+							className={classNames('tl-corner-handle', {
+								'tl-hidden': hideBottomRightCorner,
+							})}
+							aria-label="bottom_right handle"
+							x={toDomPrecision(width - size / 2)}
+							y={toDomPrecision(height - size / 2)}
+							width={toDomPrecision(size)}
+							height={toDomPrecision(size)}
+						/>
+						<rect
+							data-testid="selection.resize.bottom-left"
+							className={classNames('tl-corner-handle', {
+								'tl-hidden': hideBottomLeftCorner,
+							})}
+							aria-label="bottom_left handle"
+							x={toDomPrecision(0 - size / 2)}
+							y={toDomPrecision(height - size / 2)}
+							width={toDomPrecision(size)}
+							height={toDomPrecision(size)}
+						/>
+					</>
+				)}
+				{showTextResizeHandles && (
+					<>
+						<rect
+							data-testid="selection.text-resize.left.handle"
+							className="tl-text-handle"
+							aria-label="bottom_left handle"
+							x={toDomPrecision(0 - size / 4)}
+							y={toDomPrecision(height / 2 - textHandleHeight / 2)}
+							rx={size / 4}
+							width={toDomPrecision(size / 2)}
+							height={toDomPrecision(textHandleHeight)}
+						/>
+						<rect
+							data-testid="selection.text-resize.right.handle"
+							className="tl-text-handle"
+							aria-label="bottom_left handle"
+							rx={size / 4}
+							x={toDomPrecision(width - size / 4)}
+							y={toDomPrecision(height / 2 - textHandleHeight / 2)}
+							width={toDomPrecision(size / 2)}
+							height={toDomPrecision(textHandleHeight)}
+						/>
+					</>
+				)}
+				{/* Crop Handles */}
+				{showCropHandles && (
+					<TldrawCropHandles
+						{...{
+							size,
+							width,
+							height,
+							hideAlternateHandles: hideAlternateCropHandles,
+						}}
+					/>
+				)}
+			</g>
+		</svg>
+	)
+})
 
 export const RotateCornerHandle = function RotateCornerHandle({
 	cx,

commit 25dcc29803938c61f1cebe2fdbb0595e21820677
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Tue Jun 11 07:13:03 2024 +0100

    Cropping undo/redo UX (#3891)
    
    This PR aims to improve the UX around undo/redo and cropping. Before the
    PR if you do some cropping, then stop cropping, then hit `undo`, you
    will end up back in the cropping state and it will undo each of your
    resize/translate cropping operations individually. This is weird üôÖüèº It
    should just undo the whole sequence of changes that happened during
    cropping.
    
    To achieve that, this PR introduces a new history method called
    `squashToMark`, which strips out all the marks between the current head
    of the undo stack and the mark id you pass in.
    
    This PR also makes the default history record mode of
    `updateCurrentPageState` to `ignore` like it already was for
    `updateInstanceState`. The fact that it was recording changes to the
    `croppingShapeId` was the reason that hitting undo would put you back
    into the cropping state.
    
    ### Change Type
    
    <!-- ‚ùó Please select a 'Scope' label ‚ùóÔ∏è -->
    
    - [x] `sdk` ‚Äî Changes the tldraw SDK
    - [ ] `dotcom` ‚Äî Changes the tldraw.com web app
    - [ ] `docs` ‚Äî Changes to the documentation, examples, or templates.
    - [ ] `vs code` ‚Äî Changes to the vscode plugin
    - [ ] `internal` ‚Äî Does not affect user-facing stuff
    
    <!-- ‚ùó Please select a 'Type' label ‚ùóÔ∏è -->
    
    - [ ] `bugfix` ‚Äî Bug fix
    - [ ] `feature` ‚Äî New feature
    - [x] `improvement` ‚Äî Improving existing features
    - [ ] `chore` ‚Äî Updating dependencies, other boring stuff
    - [ ] `galaxy brain` ‚Äî Architectural changes
    - [ ] `tests` ‚Äî Changes to any test code
    - [ ] `tools` ‚Äî Changes to infrastructure, CI, internal scripts,
    debugging tools, etc.
    - [ ] `dunno` ‚Äî I don't know
    
    
    ### Test Plan
    
    1. Add a step-by-step description of how to test your PR here.
    2.
    
    - [ ] Unit Tests
    - [ ] End to end tests
    
    ### Release Notes
    
    - Add a brief release note for your PR here.

diff --git a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
index 295b4f8cb..a3b96d06c 100644
--- a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
+++ b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
@@ -90,8 +90,8 @@ export const TldrawSelectionForeground = track(function TldrawSelectionForegroun
 				'select.pointing_shape',
 				'select.crop.idle',
 				'select.crop.pointing_crop',
-				'select.pointing_resize_handle',
-				'select.pointing_crop_handle'
+				'select.crop.pointing_crop_handle',
+				'select.pointing_resize_handle'
 			)) ||
 		(showSelectionBounds &&
 			editor.isIn('select.resizing') &&
@@ -106,9 +106,9 @@ export const TldrawSelectionForeground = track(function TldrawSelectionForegroun
 
 	const showCropHandles =
 		editor.isInAny(
-			'select.pointing_crop_handle',
 			'select.crop.idle',
-			'select.crop.pointing_crop'
+			'select.crop.pointing_crop',
+			'select.crop.pointing_crop_handle'
 		) &&
 		!isChangingStyle &&
 		!isReadonlyMode

commit b33cc2e6b0f2630ec328018f592e3d301b90efaf
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Mon Sep 23 18:07:34 2024 +0100

    [feature] isShapeHidden option (#4446)
    
    This PR adds an option to the Editor that allows people to control the
    visibility of shapes. This has been requested a couple of times for
    different use-cases:
    
    - A layer panel with a visibility toggle per shape
    - A kind-of 'private' drawing mode in a multiplayer app.
    
    So to test this feature out I've implemented both of those in minimal
    ways as examples.
    
    ### Change type
    
    - [x] `feature`
    
    
    ### Test plan
    
    - [x] Unit tests
    
    
    ### Release notes
    
    - Adds an `isShapeHidden` option, which allows you to provide custom
    logic to decide whether or not a shape should be shown on the canvas.

diff --git a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
index a3b96d06c..a8ceb6012 100644
--- a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
+++ b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
@@ -51,6 +51,8 @@ export const TldrawSelectionForeground = track(function TldrawSelectionForegroun
 		y: -expandOutlineBy,
 	})
 
+	if (onlyShape && editor.isShapeHidden(onlyShape)) return null
+
 	if (!bounds) return null
 	bounds = bounds.clone().expandBy(expandOutlineBy).zeroFix()
 

commit 09f89a60f403ff704c1372eff9fecba6cd5ce361
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon Sep 30 16:27:45 2024 -0400

    [dotcom] Menus, dialogs, toasts, etc. (#4624)
    
    This PR brings tldraw's ui into the application layer: dialogs, menus,
    etc.
    
    It:
    - brings our dialogs to the application layer
    - brings our toasts to the application layer
    - brings our translations to the application layer
    - brings our assets to the application layer
    - creates a "file menu"
    - creates a "rename file" dialog
    - creates the UI for changing the title of a file in the header
    - adjusts some text sizes
    
    In order to do that, I've had to:
    - create a global `tlmenus` system for menus
    - create a global `tltime` system for timers
    - create a global `tlenv` for environment"
    - create a `useMaybeEditor` hook
    
    ### Change type
    
    - [x] `other`
    
    ### Release notes
    - exports dialogs system
    - exports toasts system
    - exports translations system
    - create a global `tlmenus` system for menus
    - create a global `tltime` system for timers
    - create a global `tlenv` for environment"
    - create a `useMaybeEditor` hook
    
    ---------
    
    Co-authored-by: Mitja Bezen≈°ek <mitja.bezensek@gmail.com>

diff --git a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
index a8ceb6012..ed41b3e98 100644
--- a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
+++ b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
@@ -4,6 +4,7 @@ import {
 	TLSelectionForegroundProps,
 	TLTextShape,
 	getCursor,
+	tlenv,
 	toDomPrecision,
 	track,
 	useEditor,
@@ -35,7 +36,7 @@ export const TldrawSelectionForeground = track(function TldrawSelectionForegroun
 	const bottomLeftEvents = useSelectionEvents('bottom_left')
 
 	const isDefaultCursor =
-		!editor.getIsMenuOpen() && editor.getInstanceState().cursor.type === 'default'
+		!editor.menus.hasAnyOpenMenus() && editor.getInstanceState().cursor.type === 'default'
 	const isCoarsePointer = editor.getInstanceState().isCoarsePointer
 
 	const onlyShape = editor.getOnlySelectedShape()
@@ -101,7 +102,7 @@ export const TldrawSelectionForeground = track(function TldrawSelectionForegroun
 			editor.isShapeOfType<TLTextShape>(onlyShape, 'text'))
 
 	if (onlyShape && shouldDisplayBox) {
-		if (editor.environment.isFirefox && editor.isShapeOfType<TLEmbedShape>(onlyShape, 'embed')) {
+		if (tlenv.isFirefox && editor.isShapeOfType<TLEmbedShape>(onlyShape, 'embed')) {
 			shouldDisplayBox = false
 		}
 	}

commit 9d6b5916e83ef758dc7c28d3fc221fd4f0236b14
Author: Mime ƒåuvalo <mimecuvalo@gmail.com>
Date:   Mon Oct 21 13:01:37 2024 +0100

    menus: rework the open menu logic to be in one consistent place (#4642)
    
    We have a lot of logic scattered everywhere to prevent certain logic
    when menus are open. It's a very manual process, easy to forget about
    when adding new shapes/tools/logic. This flips the logic a bit to be
    handled in one place vs. various places trying to account for this.
    
    ### Change type
    
    - [ ] `bugfix`
    - [x] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Release notes
    
    - Rework open menu logic to be centralized.
    
    ---------
    
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
index ed41b3e98..b703e8b14 100644
--- a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
+++ b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
@@ -35,8 +35,7 @@ export const TldrawSelectionForeground = track(function TldrawSelectionForegroun
 	const bottomRightEvents = useSelectionEvents('bottom_right')
 	const bottomLeftEvents = useSelectionEvents('bottom_left')
 
-	const isDefaultCursor =
-		!editor.menus.hasAnyOpenMenus() && editor.getInstanceState().cursor.type === 'default'
+	const isDefaultCursor = editor.getInstanceState().cursor.type === 'default'
 	const isCoarsePointer = editor.getInstanceState().isCoarsePointer
 
 	const onlyShape = editor.getOnlySelectedShape()

commit 48cd187b3a258ea75864e9e572217e990b5a0c00
Author: Trygve Aaberge <trygve.aaberge@autodesk.com>
Date:   Mon Jan 6 18:25:03 2025 +0100

    Allow expandSelectionOutlinePx to return a Box (#5168)
    
    This allows the selection outline to be expanded by different amounts on
    each side by supporting returning a `Box` from
    `expandSelectionOutlinePx`. Currently it only supports returning a
    number which will expand the selection that amount on each side.
    
    Together with #5137 this allows us to implement an alternative cropping
    behavior where the shape size remains fixed while cropping, while the
    uncropped image size is what you change instead. This is useful in
    scenarios where you want to first lay out shapes in a certain layout,
    and afterwards crop them so they display the portion of the image you
    want.
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [x] `api`
    - [ ] `other`
    
    ### Test plan
    
    1. Add a `expandSelectionOutlinePx` function to a shape that returns a
    Box.
    2. Verify that the selection outline is expanded according to this Box.
    
    - [ ] Unit tests
    - [ ] End to end tests
    
    ### Release notes
    
    - Support expanding the selection outline by different amounts on each
    side by returning a `Box` from `expandSelectionOutlinePx`.

diff --git a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
index b703e8b14..1f9d71b39 100644
--- a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
+++ b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
@@ -1,4 +1,5 @@
 import {
+	Box,
 	RotateCorner,
 	TLEmbedShape,
 	TLSelectionForegroundProps,
@@ -46,21 +47,23 @@ export const TldrawSelectionForeground = track(function TldrawSelectionForegroun
 		? editor.getShapeUtil(onlyShape).expandSelectionOutlinePx(onlyShape)
 		: 0
 
+	const expandedBounds =
+		expandOutlineBy instanceof Box
+			? bounds.clone().expand(expandOutlineBy).zeroFix()
+			: bounds.clone().expandBy(expandOutlineBy).zeroFix()
+
 	useTransform(rSvg, bounds?.x, bounds?.y, 1, editor.getSelectionRotation(), {
-		x: -expandOutlineBy,
-		y: -expandOutlineBy,
+		x: expandedBounds.x - bounds.x,
+		y: expandedBounds.y - bounds.y,
 	})
 
 	if (onlyShape && editor.isShapeHidden(onlyShape)) return null
 
-	if (!bounds) return null
-	bounds = bounds.clone().expandBy(expandOutlineBy).zeroFix()
-
 	const zoom = editor.getZoomLevel()
 	const isChangingStyle = editor.getInstanceState().isChangingStyle
 
-	const width = bounds.width
-	const height = bounds.height
+	const width = expandedBounds.width
+	const height = expandedBounds.height
 
 	const size = 8 / zoom
 	const isTinyX = width < size * 2

commit a53f0a3ddf355a787e51bfd58b8e0000d8e60e0e
Author: Mime ƒåuvalo <mimecuvalo@gmail.com>
Date:   Mon Apr 7 23:36:42 2025 +0100

    a11y: add axe to be able to do audits (#5840)
    
    This is just for dev mode.
    
    ![Screenshot 2025-04-07 at 15 38
    01](https://github.com/user-attachments/assets/45076c3d-6ef8-4163-b1c3-4facae08da05)
    
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [x] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Release notes
    
    - a11y: add axe to be able to do audits

diff --git a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
index 1f9d71b39..12059e8bc 100644
--- a/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
+++ b/packages/tldraw/src/lib/canvas/TldrawSelectionForeground.tsx
@@ -248,6 +248,7 @@ export const TldrawSelectionForeground = track(function TldrawSelectionForegroun
 						'tl-hidden': hideVerticalEdgeTargets,
 					})}
 					data-testid="selection.resize.top"
+					role="button"
 					aria-label="top target"
 					pointerEvents="all"
 					x={0}
@@ -262,6 +263,7 @@ export const TldrawSelectionForeground = track(function TldrawSelectionForegroun
 						'tl-hidden': hideHorizontalEdgeTargets,
 					})}
 					data-testid="selection.resize.right"
+					role="button"
 					aria-label="right target"
 					pointerEvents="all"
 					x={toDomPrecision(width - (isSmallX ? 0 : targetSizeX))}
@@ -276,6 +278,7 @@ export const TldrawSelectionForeground = track(function TldrawSelectionForegroun
 						'tl-hidden': hideVerticalEdgeTargets,
 					})}
 					data-testid="selection.resize.bottom"
+					role="button"
 					aria-label="bottom target"
 					pointerEvents="all"
 					x={0}
@@ -290,6 +293,7 @@ export const TldrawSelectionForeground = track(function TldrawSelectionForegroun
 						'tl-hidden': hideHorizontalEdgeTargets,
 					})}
 					data-testid="selection.resize.left"
+					role="button"
 					aria-label="left target"
 					pointerEvents="all"
 					x={toDomPrecision(0 - (isSmallX ? targetSizeX * 2 : targetSizeX))}
@@ -305,6 +309,7 @@ export const TldrawSelectionForeground = track(function TldrawSelectionForegroun
 						'tl-hidden': hideTopLeftCorner,
 					})}
 					data-testid="selection.target.top-left"
+					role="button"
 					aria-label="top-left target"
 					pointerEvents="all"
 					x={toDomPrecision(0 - (isSmallX ? targetSizeX * 2 : targetSizeX * 1.5))}
@@ -319,6 +324,7 @@ export const TldrawSelectionForeground = track(function TldrawSelectionForegroun
 						'tl-hidden': hideTopRightCorner,
 					})}
 					data-testid="selection.target.top-right"
+					role="button"
 					aria-label="top-right target"
 					pointerEvents="all"
 					x={toDomPrecision(width - (isSmallX ? 0 : targetSizeX * 1.5))}
@@ -333,6 +339,7 @@ export const TldrawSelectionForeground = track(function TldrawSelectionForegroun
 						'tl-hidden': hideBottomRightCorner,
 					})}
 					data-testid="selection.target.bottom-right"
+					role="button"
 					aria-label="bottom-right target"
 					pointerEvents="all"
 					x={toDomPrecision(width - (isSmallX ? targetSizeX : targetSizeX * 1.5))}
@@ -347,6 +354,7 @@ export const TldrawSelectionForeground = track(function TldrawSelectionForegroun
 						'tl-hidden': hideBottomLeftCorner,
 					})}
 					data-testid="selection.target.bottom-left"
+					role="button"
 					aria-label="bottom-left target"
 					pointerEvents="all"
 					x={toDomPrecision(0 - (isSmallX ? targetSizeX * 3 : targetSizeX * 1.5))}
@@ -364,6 +372,7 @@ export const TldrawSelectionForeground = track(function TldrawSelectionForegroun
 							className={classNames('tl-corner-handle', {
 								'tl-hidden': hideTopLeftCorner,
 							})}
+							role="button"
 							aria-label="top_left handle"
 							x={toDomPrecision(0 - size / 2)}
 							y={toDomPrecision(0 - size / 2)}
@@ -375,6 +384,7 @@ export const TldrawSelectionForeground = track(function TldrawSelectionForegroun
 							className={classNames('tl-corner-handle', {
 								'tl-hidden': hideTopRightCorner,
 							})}
+							role="button"
 							aria-label="top_right handle"
 							x={toDomPrecision(width - size / 2)}
 							y={toDomPrecision(0 - size / 2)}
@@ -386,6 +396,7 @@ export const TldrawSelectionForeground = track(function TldrawSelectionForegroun
 							className={classNames('tl-corner-handle', {
 								'tl-hidden': hideBottomRightCorner,
 							})}
+							role="button"
 							aria-label="bottom_right handle"
 							x={toDomPrecision(width - size / 2)}
 							y={toDomPrecision(height - size / 2)}
@@ -397,6 +408,7 @@ export const TldrawSelectionForeground = track(function TldrawSelectionForegroun
 							className={classNames('tl-corner-handle', {
 								'tl-hidden': hideBottomLeftCorner,
 							})}
+							role="button"
 							aria-label="bottom_left handle"
 							x={toDomPrecision(0 - size / 2)}
 							y={toDomPrecision(height - size / 2)}
@@ -410,6 +422,7 @@ export const TldrawSelectionForeground = track(function TldrawSelectionForegroun
 						<rect
 							data-testid="selection.text-resize.left.handle"
 							className="tl-text-handle"
+							role="button"
 							aria-label="bottom_left handle"
 							x={toDomPrecision(0 - size / 4)}
 							y={toDomPrecision(height / 2 - textHandleHeight / 2)}
@@ -420,6 +433,7 @@ export const TldrawSelectionForeground = track(function TldrawSelectionForegroun
 						<rect
 							data-testid="selection.text-resize.right.handle"
 							className="tl-text-handle"
+							role="button"
 							aria-label="bottom_left handle"
 							rx={size / 4}
 							x={toDomPrecision(width - size / 4)}
@@ -467,6 +481,7 @@ export const RotateCornerHandle = function RotateCornerHandle({
 		<rect
 			className={classNames('tl-transparent', 'tl-rotate-corner', { 'tl-hidden': isHidden })}
 			data-testid={testId}
+			role="button"
 			aria-label={`${corner} target`}
 			pointerEvents="all"
 			x={toDomPrecision(cx - targetSize * 3)}

