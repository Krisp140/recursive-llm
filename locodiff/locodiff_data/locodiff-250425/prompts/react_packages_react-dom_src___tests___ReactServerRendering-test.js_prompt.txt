# Instructions

You are being benchmarked. You will see the output of a git log command, and from that must infer the current state of a file. Think carefully, as you must output the exact state of the file to earn full marks.

**Important:** Your goal is to reproduce the file's content *exactly* as it exists at the final commit, even if the code appears broken, buggy, or contains obvious errors. Do **not** try to "fix" the code. Attempting to correct issues will result in a poor score, as this benchmark evaluates your ability to reproduce the precise state of the file based on its history.

# Required Response Format

Wrap the content of the file in triple backticks (```). Any text outside the final closing backticks will be ignored. End your response after outputting the closing backticks.

# Example Response

```python
#!/usr/bin/env python
print('Hello, world!')
```

# File History

> git log -p --cc --topo-order --reverse -- packages/react-dom/src/__tests__/ReactServerRendering-test.js

commit 313611572b6567d229367ed20ff63d1bca8610bb
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Thu Oct 19 19:50:24 2017 +0100

    Reorganize code structure (#11288)
    
    * Move files and tests to more meaningful places
    
    * Fix the build
    
    Now that we import reconciler via react-reconciler, I needed to make a few tweaks.
    
    * Update sizes
    
    * Move @preventMunge directive to FB header
    
    * Revert unintentional change
    
    * Fix Flow coverage
    
    I forgot to @flow-ify those files. This uncovered some issues.
    
    * Prettier, I love you but you're bringing me down
    Prettier, I love you but you're bringing me down
    
    Like a rat in a cage
    Pulling minimum wage
    Prettier, I love you but you're bringing me down
    
    Prettier, you're safer and you're wasting my time
    Our records all show you were filthy but fine
    But they shuttered your stores
    When you opened the doors
    To the cops who were bored once they'd run out of crime
    
    Prettier, you're perfect, oh, please don't change a thing
    Your mild billionaire mayor's now convinced he's a king
    So the boring collect
    I mean all disrespect
    In the neighborhood bars I'd once dreamt I would drink
    
    Prettier, I love you but you're freaking me out
    There's a ton of the twist but we're fresh out of shout
    Like a death in the hall
    That you hear through your wall
    Prettier, I love you but you're freaking me out
    
    Prettier, I love you but you're bringing me down
    Prettier, I love you but you're bringing me down
    Like a death of the heart
    Jesus, where do I start?
    But you're still the one pool where I'd happily drown
    
    And oh! Take me off your mailing list
    For kids who think it still exists
    Yes, for those who think it still exists
    Maybe I'm wrong and maybe you're right
    Maybe I'm wrong and maybe you're right
    Maybe you're right, maybe I'm wrong
    And just maybe you're right
    
    And oh! Maybe mother told you true
    And there'll always be somebody there for you
    And you'll never be alone
    But maybe she's wrong and maybe I'm right
    And just maybe she's wrong
    Maybe she's wrong and maybe I'm right
    And if so, here's this song!

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
new file mode 100644
index 0000000000..3e82973ace
--- /dev/null
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -0,0 +1,749 @@
+/**
+ * Copyright (c) 2013-present, Facebook, Inc.
+ *
+ * This source code is licensed under the MIT license found in the
+ * LICENSE file in the root directory of this source tree.
+ *
+ * @emails react-core
+ */
+
+'use strict';
+
+var ExecutionEnvironment;
+var React;
+var ReactDOM;
+var ReactDOMServer;
+var ReactTestUtils;
+var PropTypes;
+
+var ROOT_ATTRIBUTE_NAME;
+
+function normalizeCodeLocInfo(str) {
+  return str && str.replace(/\(at .+?:\d+\)/g, '(at **)');
+}
+
+describe('ReactDOMServer', () => {
+  beforeEach(() => {
+    jest.resetModules();
+    React = require('react');
+    ReactDOM = require('react-dom');
+    ReactTestUtils = require('react-dom/test-utils');
+    PropTypes = require('prop-types');
+
+    ExecutionEnvironment = require('fbjs/lib/ExecutionEnvironment');
+    ExecutionEnvironment.canUseDOM = false;
+    ReactDOMServer = require('react-dom/server');
+
+    var DOMProperty = require('DOMProperty');
+    ROOT_ATTRIBUTE_NAME = DOMProperty.ROOT_ATTRIBUTE_NAME;
+  });
+
+  describe('renderToString', () => {
+    it('should generate simple markup', () => {
+      var response = ReactDOMServer.renderToString(<span>hello world</span>);
+      expect(response).toMatch(
+        new RegExp(
+          '<span ' + ROOT_ATTRIBUTE_NAME + '=""' + '>hello world</span>',
+        ),
+      );
+    });
+
+    it('should generate simple markup for self-closing tags', () => {
+      var response = ReactDOMServer.renderToString(<img />);
+      expect(response).toMatch(
+        new RegExp('<img ' + ROOT_ATTRIBUTE_NAME + '=""' + '/>'),
+      );
+    });
+
+    it('should generate simple markup for attribute with `>` symbol', () => {
+      var response = ReactDOMServer.renderToString(<img data-attr=">" />);
+      expect(response).toMatch(
+        new RegExp(
+          '<img data-attr="&gt;" ' + ROOT_ATTRIBUTE_NAME + '=""' + '/>',
+        ),
+      );
+    });
+
+    it('should generate comment markup for component returns null', () => {
+      class NullComponent extends React.Component {
+        render() {
+          return null;
+        }
+      }
+
+      var response = ReactDOMServer.renderToString(<NullComponent />);
+      expect(response).toBe('');
+    });
+
+    // TODO: Test that listeners are not registered onto any document/container.
+
+    it('should render composite components', () => {
+      class Parent extends React.Component {
+        render() {
+          return <div><Child name="child" /></div>;
+        }
+      }
+
+      class Child extends React.Component {
+        render() {
+          return <span>My name is {this.props.name}</span>;
+        }
+      }
+
+      var response = ReactDOMServer.renderToString(<Parent />);
+      expect(response).toMatch(
+        new RegExp(
+          '<div ' +
+            ROOT_ATTRIBUTE_NAME +
+            '=""' +
+            '>' +
+            '<span' +
+            '>' +
+            'My name is <!-- -->child' +
+            '</span>' +
+            '</div>',
+        ),
+      );
+    });
+
+    it('should only execute certain lifecycle methods', () => {
+      function runTest() {
+        var lifecycle = [];
+
+        class TestComponent extends React.Component {
+          constructor(props) {
+            super(props);
+            lifecycle.push('getInitialState');
+            this.state = {name: 'TestComponent'};
+          }
+
+          componentWillMount() {
+            lifecycle.push('componentWillMount');
+          }
+
+          componentDidMount() {
+            lifecycle.push('componentDidMount');
+          }
+
+          render() {
+            lifecycle.push('render');
+            return <span>Component name: {this.state.name}</span>;
+          }
+
+          componentWillUpdate() {
+            lifecycle.push('componentWillUpdate');
+          }
+
+          componentDidUpdate() {
+            lifecycle.push('componentDidUpdate');
+          }
+
+          shouldComponentUpdate() {
+            lifecycle.push('shouldComponentUpdate');
+          }
+
+          componentWillReceiveProps() {
+            lifecycle.push('componentWillReceiveProps');
+          }
+
+          componentWillUnmount() {
+            lifecycle.push('componentWillUnmount');
+          }
+        }
+
+        var response = ReactDOMServer.renderToString(<TestComponent />);
+
+        expect(response).toMatch(
+          new RegExp(
+            '<span ' +
+              ROOT_ATTRIBUTE_NAME +
+              '=""' +
+              '>' +
+              'Component name: <!-- -->TestComponent' +
+              '</span>',
+          ),
+        );
+        expect(lifecycle).toEqual([
+          'getInitialState',
+          'componentWillMount',
+          'render',
+        ]);
+      }
+
+      runTest();
+
+      // This should work the same regardless of whether you can use DOM or not.
+      ExecutionEnvironment.canUseDOM = true;
+      runTest();
+    });
+
+    it('should have the correct mounting behavior (old hydrate API)', () => {
+      spyOn(console, 'warn');
+      spyOn(console, 'error');
+      // This test is testing client-side behavior.
+      ExecutionEnvironment.canUseDOM = true;
+
+      var mountCount = 0;
+      var numClicks = 0;
+
+      class TestComponent extends React.Component {
+        componentDidMount() {
+          mountCount++;
+        }
+
+        click = () => {
+          numClicks++;
+        };
+
+        render() {
+          return (
+            <span ref="span" onClick={this.click}>Name: {this.props.name}</span>
+          );
+        }
+      }
+
+      var element = document.createElement('div');
+      ReactDOM.render(<TestComponent />, element);
+
+      var lastMarkup = element.innerHTML;
+
+      // Exercise the update path. Markup should not change,
+      // but some lifecycle methods should be run again.
+      ReactDOM.render(<TestComponent name="x" />, element);
+      expect(mountCount).toEqual(1);
+
+      // Unmount and remount. We should get another mount event and
+      // we should get different markup, as the IDs are unique each time.
+      ReactDOM.unmountComponentAtNode(element);
+      expect(element.innerHTML).toEqual('');
+      ReactDOM.render(<TestComponent name="x" />, element);
+      expect(mountCount).toEqual(2);
+      expect(element.innerHTML).not.toEqual(lastMarkup);
+
+      // Now kill the node and render it on top of server-rendered markup, as if
+      // we used server rendering. We should mount again, but the markup should
+      // be unchanged. We will append a sentinel at the end of innerHTML to be
+      // sure that innerHTML was not changed.
+      ReactDOM.unmountComponentAtNode(element);
+      expect(element.innerHTML).toEqual('');
+
+      ExecutionEnvironment.canUseDOM = false;
+      lastMarkup = ReactDOMServer.renderToString(<TestComponent name="x" />);
+      ExecutionEnvironment.canUseDOM = true;
+      element.innerHTML = lastMarkup;
+
+      var instance = ReactDOM.render(<TestComponent name="x" />, element);
+      expect(mountCount).toEqual(3);
+      expectDev(console.warn.calls.count()).toBe(1);
+      expectDev(console.warn.calls.argsFor(0)[0]).toContain(
+        'render(): Calling ReactDOM.render() to hydrate server-rendered markup ' +
+          'will stop working in React v17. Replace the ReactDOM.render() call ' +
+          'with ReactDOM.hydrate() if you want React to attach to the server HTML.',
+      );
+      console.warn.calls.reset();
+      expect(element.innerHTML).toBe(lastMarkup);
+
+      // Ensure the events system works after mount into server markup
+      expect(numClicks).toEqual(0);
+      ReactTestUtils.Simulate.click(ReactDOM.findDOMNode(instance.refs.span));
+      expect(numClicks).toEqual(1);
+
+      ReactDOM.unmountComponentAtNode(element);
+      expect(element.innerHTML).toEqual('');
+
+      // Now simulate a situation where the app is not idempotent. React should
+      // warn but do the right thing.
+      element.innerHTML = lastMarkup;
+      instance = ReactDOM.render(<TestComponent name="y" />, element);
+      expect(mountCount).toEqual(4);
+      expectDev(console.error.calls.count()).toBe(1);
+      expectDev(console.error.calls.argsFor(0)[0]).toContain(
+        'Text content did not match. Server: "x" Client: "y"',
+      );
+      console.error.calls.reset();
+      expect(element.innerHTML.length > 0).toBe(true);
+      expect(element.innerHTML).not.toEqual(lastMarkup);
+
+      // Ensure the events system works after markup mismatch.
+      expect(numClicks).toEqual(1);
+      ReactTestUtils.Simulate.click(ReactDOM.findDOMNode(instance.refs.span));
+      expect(numClicks).toEqual(2);
+      expectDev(console.warn.calls.count()).toBe(0);
+      expectDev(console.error.calls.count()).toBe(0);
+    });
+
+    it('should have the correct mounting behavior (new hydrate API)', () => {
+      spyOn(console, 'error');
+      // This test is testing client-side behavior.
+      ExecutionEnvironment.canUseDOM = true;
+
+      var mountCount = 0;
+      var numClicks = 0;
+
+      class TestComponent extends React.Component {
+        componentDidMount() {
+          mountCount++;
+        }
+
+        click = () => {
+          numClicks++;
+        };
+
+        render() {
+          return (
+            <span ref="span" onClick={this.click}>
+              Name: {this.props.name}
+            </span>
+          );
+        }
+      }
+
+      var element = document.createElement('div');
+      ReactDOM.render(<TestComponent />, element);
+
+      var lastMarkup = element.innerHTML;
+
+      // Exercise the update path. Markup should not change,
+      // but some lifecycle methods should be run again.
+      ReactDOM.render(<TestComponent name="x" />, element);
+      expect(mountCount).toEqual(1);
+
+      // Unmount and remount. We should get another mount event and
+      // we should get different markup, as the IDs are unique each time.
+      ReactDOM.unmountComponentAtNode(element);
+      expect(element.innerHTML).toEqual('');
+      ReactDOM.render(<TestComponent name="x" />, element);
+      expect(mountCount).toEqual(2);
+      expect(element.innerHTML).not.toEqual(lastMarkup);
+
+      // Now kill the node and render it on top of server-rendered markup, as if
+      // we used server rendering. We should mount again, but the markup should
+      // be unchanged. We will append a sentinel at the end of innerHTML to be
+      // sure that innerHTML was not changed.
+      ReactDOM.unmountComponentAtNode(element);
+      expect(element.innerHTML).toEqual('');
+
+      ExecutionEnvironment.canUseDOM = false;
+      lastMarkup = ReactDOMServer.renderToString(<TestComponent name="x" />);
+      ExecutionEnvironment.canUseDOM = true;
+      element.innerHTML = lastMarkup;
+
+      var instance = ReactDOM.hydrate(<TestComponent name="x" />, element);
+      expect(mountCount).toEqual(3);
+      expect(element.innerHTML).toBe(lastMarkup);
+
+      // Ensure the events system works after mount into server markup
+      expect(numClicks).toEqual(0);
+      ReactTestUtils.Simulate.click(ReactDOM.findDOMNode(instance.refs.span));
+      expect(numClicks).toEqual(1);
+
+      ReactDOM.unmountComponentAtNode(element);
+      expect(element.innerHTML).toEqual('');
+
+      // Now simulate a situation where the app is not idempotent. React should
+      // warn but do the right thing.
+      element.innerHTML = lastMarkup;
+      instance = ReactDOM.hydrate(<TestComponent name="y" />, element);
+      expect(mountCount).toEqual(4);
+      expectDev(console.error.calls.count()).toBe(1);
+      expect(element.innerHTML.length > 0).toBe(true);
+      expect(element.innerHTML).not.toEqual(lastMarkup);
+
+      // Ensure the events system works after markup mismatch.
+      expect(numClicks).toEqual(1);
+      ReactTestUtils.Simulate.click(ReactDOM.findDOMNode(instance.refs.span));
+      expect(numClicks).toEqual(2);
+    });
+
+    // We have a polyfill for autoFocus on the client, but we intentionally don't
+    // want it to call focus() when hydrating because this can mess up existing
+    // focus before the JS has loaded.
+    it('should emit autofocus on the server but not focus() when hydrating', () => {
+      var element = document.createElement('div');
+      element.innerHTML = ReactDOMServer.renderToString(
+        <input autoFocus={true} />,
+      );
+      expect(element.firstChild.autofocus).toBe(true);
+
+      // It should not be called on mount.
+      element.firstChild.focus = jest.fn();
+      ReactDOM.hydrate(<input autoFocus={true} />, element);
+      expect(element.firstChild.focus).not.toHaveBeenCalled();
+
+      // Or during an update.
+      ReactDOM.render(<input autoFocus={true} />, element);
+      expect(element.firstChild.focus).not.toHaveBeenCalled();
+    });
+
+    it('should throw with silly args', () => {
+      expect(
+        ReactDOMServer.renderToString.bind(ReactDOMServer, {x: 123}),
+      ).toThrowError(
+        'Objects are not valid as a React child (found: object with keys {x})',
+      );
+    });
+
+    it('should throw prop mapping error for an <iframe /> with invalid props', () => {
+      let caughtErr;
+      try {
+        ReactDOMServer.renderToString(<iframe style="border:none;" />);
+      } catch (err) {
+        caughtErr = err;
+      }
+      expect(caughtErr).not.toBe(undefined);
+      expect(normalizeCodeLocInfo(caughtErr.message)).toContain(
+        'The `style` prop expects a mapping from style properties to values, not ' +
+          "a string. For example, style={{marginRight: spacing + 'em'}} when using JSX." +
+          '\n    in iframe (at **)',
+      );
+    });
+  });
+
+  describe('renderToStaticMarkup', () => {
+    it('should not put checksum and React ID on components', () => {
+      class NestedComponent extends React.Component {
+        render() {
+          return <div>inner text</div>;
+        }
+      }
+
+      class TestComponent extends React.Component {
+        render() {
+          return <span><NestedComponent /></span>;
+        }
+      }
+
+      var response = ReactDOMServer.renderToStaticMarkup(<TestComponent />);
+
+      expect(response).toBe('<span><div>inner text</div></span>');
+    });
+
+    it('should not put checksum and React ID on text components', () => {
+      class TestComponent extends React.Component {
+        render() {
+          return <span>{'hello'} {'world'}</span>;
+        }
+      }
+
+      var response = ReactDOMServer.renderToStaticMarkup(<TestComponent />);
+
+      expect(response).toBe('<span>hello world</span>');
+    });
+
+    it('should not use comments for empty nodes', () => {
+      class TestComponent extends React.Component {
+        render() {
+          return null;
+        }
+      }
+
+      var response = ReactDOMServer.renderToStaticMarkup(<TestComponent />);
+
+      expect(response).toBe('');
+    });
+
+    it('should only execute certain lifecycle methods', () => {
+      function runTest() {
+        var lifecycle = [];
+
+        class TestComponent extends React.Component {
+          constructor(props) {
+            super(props);
+            lifecycle.push('getInitialState');
+            this.state = {name: 'TestComponent'};
+          }
+
+          componentWillMount() {
+            lifecycle.push('componentWillMount');
+          }
+
+          componentDidMount() {
+            lifecycle.push('componentDidMount');
+          }
+
+          render() {
+            lifecycle.push('render');
+            return <span>Component name: {this.state.name}</span>;
+          }
+
+          componentWillUpdate() {
+            lifecycle.push('componentWillUpdate');
+          }
+
+          componentDidUpdate() {
+            lifecycle.push('componentDidUpdate');
+          }
+
+          shouldComponentUpdate() {
+            lifecycle.push('shouldComponentUpdate');
+          }
+
+          componentWillReceiveProps() {
+            lifecycle.push('componentWillReceiveProps');
+          }
+
+          componentWillUnmount() {
+            lifecycle.push('componentWillUnmount');
+          }
+        }
+
+        var response = ReactDOMServer.renderToStaticMarkup(<TestComponent />);
+
+        expect(response).toBe('<span>Component name: TestComponent</span>');
+        expect(lifecycle).toEqual([
+          'getInitialState',
+          'componentWillMount',
+          'render',
+        ]);
+      }
+
+      runTest();
+
+      // This should work the same regardless of whether you can use DOM or not.
+      ExecutionEnvironment.canUseDOM = true;
+      runTest();
+    });
+
+    it('should throw with silly args', () => {
+      expect(
+        ReactDOMServer.renderToStaticMarkup.bind(ReactDOMServer, {x: 123}),
+      ).toThrowError(
+        'Objects are not valid as a React child (found: object with keys {x})',
+      );
+    });
+
+    it('allows setState in componentWillMount without using DOM', () => {
+      class Component extends React.Component {
+        componentWillMount() {
+          this.setState({text: 'hello, world'});
+        }
+
+        render() {
+          return <div>{this.state.text}</div>;
+        }
+      }
+      var markup = ReactDOMServer.renderToString(<Component />);
+      expect(markup).toContain('hello, world');
+    });
+
+    it('allows setState in componentWillMount with custom constructor', () => {
+      class Component extends React.Component {
+        constructor() {
+          super();
+          this.state = {text: 'default state'};
+        }
+
+        componentWillMount() {
+          this.setState({text: 'hello, world'});
+        }
+
+        render() {
+          return <div>{this.state.text}</div>;
+        }
+      }
+      var markup = ReactDOMServer.renderToString(<Component />);
+      expect(markup).toContain('hello, world');
+    });
+
+    it('renders with props when using custom constructor', () => {
+      class Component extends React.Component {
+        constructor() {
+          super();
+        }
+
+        render() {
+          return <div>{this.props.text}</div>;
+        }
+      }
+
+      var markup = ReactDOMServer.renderToString(
+        <Component text="hello, world" />,
+      );
+      expect(markup).toContain('hello, world');
+    });
+
+    it('renders with context when using custom constructor', () => {
+      class Component extends React.Component {
+        constructor() {
+          super();
+        }
+
+        render() {
+          return <div>{this.context.text}</div>;
+        }
+      }
+
+      Component.contextTypes = {
+        text: PropTypes.string.isRequired,
+      };
+
+      class ContextProvider extends React.Component {
+        getChildContext() {
+          return {
+            text: 'hello, world',
+          };
+        }
+
+        render() {
+          return this.props.children;
+        }
+      }
+
+      ContextProvider.childContextTypes = {
+        text: PropTypes.string,
+      };
+
+      var markup = ReactDOMServer.renderToString(
+        <ContextProvider><Component /></ContextProvider>,
+      );
+      expect(markup).toContain('hello, world');
+    });
+
+    it('renders components with different batching strategies', () => {
+      class StaticComponent extends React.Component {
+        render() {
+          const staticContent = ReactDOMServer.renderToStaticMarkup(
+            <div>
+              <img src="foo-bar.jpg" />
+            </div>,
+          );
+          return <div dangerouslySetInnerHTML={{__html: staticContent}} />;
+        }
+      }
+
+      class Component extends React.Component {
+        componentWillMount() {
+          this.setState({text: 'hello, world'});
+        }
+
+        render() {
+          return <div>{this.state.text}</div>;
+        }
+      }
+
+      expect(
+        ReactDOMServer.renderToString.bind(
+          ReactDOMServer,
+          <div>
+            <StaticComponent />
+            <Component />
+          </div>,
+        ),
+      ).not.toThrow();
+    });
+  });
+
+  it('warns with a no-op when an async setState is triggered', () => {
+    class Foo extends React.Component {
+      componentWillMount() {
+        this.setState({text: 'hello'});
+        setTimeout(() => {
+          this.setState({text: 'error'});
+        });
+      }
+      render() {
+        return <div onClick={() => {}}>{this.state.text}</div>;
+      }
+    }
+
+    spyOn(console, 'error');
+    ReactDOMServer.renderToString(<Foo />);
+    jest.runOnlyPendingTimers();
+    expectDev(console.error.calls.count()).toBe(1);
+    expectDev(console.error.calls.mostRecent().args[0]).toBe(
+      'Warning: setState(...): Can only update a mounting component.' +
+        ' This usually means you called setState() outside componentWillMount() on the server.' +
+        ' This is a no-op.\n\nPlease check the code for the Foo component.',
+    );
+    var markup = ReactDOMServer.renderToStaticMarkup(<Foo />);
+    expect(markup).toBe('<div>hello</div>');
+  });
+
+  it('warns with a no-op when an async forceUpdate is triggered', () => {
+    class Baz extends React.Component {
+      componentWillMount() {
+        this.forceUpdate();
+        setTimeout(() => {
+          this.forceUpdate();
+        });
+      }
+
+      render() {
+        return <div onClick={() => {}} />;
+      }
+    }
+
+    spyOn(console, 'error');
+    ReactDOMServer.renderToString(<Baz />);
+    jest.runOnlyPendingTimers();
+    expectDev(console.error.calls.count()).toBe(1);
+    expectDev(console.error.calls.mostRecent().args[0]).toBe(
+      'Warning: forceUpdate(...): Can only update a mounting component. ' +
+        'This usually means you called forceUpdate() outside componentWillMount() on the server. ' +
+        'This is a no-op.\n\nPlease check the code for the Baz component.',
+    );
+    var markup = ReactDOMServer.renderToStaticMarkup(<Baz />);
+    expect(markup).toBe('<div></div>');
+  });
+
+  it('should warn when children are mutated during render', () => {
+    spyOn(console, 'error');
+    function Wrapper(props) {
+      props.children[1] = <p key={1} />; // Mutation is illegal
+      return <div>{props.children}</div>;
+    }
+    expect(() => {
+      ReactDOMServer.renderToStaticMarkup(
+        <Wrapper>
+          <span key={0} />
+          <span key={1} />
+          <span key={2} />
+        </Wrapper>,
+      );
+    }).toThrowError(/Cannot assign to read only property.*/);
+  });
+
+  it('warns about lowercase html but not in svg tags', () => {
+    spyOn(console, 'error');
+    function CompositeG(props) {
+      // Make sure namespace passes through composites
+      return <g>{props.children}</g>;
+    }
+    ReactDOMServer.renderToStaticMarkup(
+      <div>
+        <inPUT />
+        <svg>
+          <CompositeG>
+            <linearGradient />
+            <foreignObject>
+              {/* back to HTML */}
+              <iFrame />
+            </foreignObject>
+          </CompositeG>
+        </svg>
+      </div>,
+    );
+    expect(console.error.calls.count()).toBe(2);
+    expect(console.error.calls.argsFor(0)[0]).toBe(
+      'Warning: <inPUT /> is using uppercase HTML. Always use lowercase ' +
+        'HTML tags in React.',
+    );
+    // linearGradient doesn't warn
+    expect(console.error.calls.argsFor(1)[0]).toBe(
+      'Warning: <iFrame /> is using uppercase HTML. Always use lowercase ' +
+        'HTML tags in React.',
+    );
+  });
+
+  it('should warn about contentEditable and children', () => {
+    spyOn(console, 'error');
+    ReactDOMServer.renderToString(<div contentEditable={true} children="" />);
+    expectDev(console.error.calls.count()).toBe(1);
+    expectDev(normalizeCodeLocInfo(console.error.calls.argsFor(0)[0])).toBe(
+      'Warning: A component is `contentEditable` and contains `children` ' +
+        'managed by React. It is now your responsibility to guarantee that ' +
+        'none of those nodes are unexpectedly modified or duplicated. This ' +
+        'is probably not intentional.\n    in div (at **)',
+    );
+  });
+});

commit 1eed302d346bfb8f5db8d88b0e7096d8999d3548
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Wed Oct 25 02:55:00 2017 +0300

    Drop Haste (#11303)
    
    * Use relative paths in packages/react
    
    * Use relative paths in packages/react-art
    
    * Use relative paths in packages/react-cs
    
    * Use relative paths in other packages
    
    * Fix as many issues as I can
    
    This uncovered an interesting problem where ./b from package/src/a would resolve to a different instantiation of package/src/b in Jest.
    
    Either this is a showstopper or we can solve it by completely fobbidding remaining /src/.
    
    * Fix all tests
    
    It seems we can't use relative requires in tests anymore. Otherwise Jest becomes confused between real file and symlink.
    https://github.com/facebook/jest/issues/3830
    
    This seems bad... Except that we already *don't* want people to create tests that import individual source files.
    All existing cases of us doing so are actually TODOs waiting to be fixed.
    
    So perhaps this requirement isn't too bad because it makes bad code looks bad.
    
    Of course, if we go with this, we'll have to lint against relative requires in tests.
    It also makes moving things more painful.
    
    * Prettier
    
    * Remove @providesModule
    
    * Fix remaining Haste imports I missed earlier
    
    * Fix up paths to reflect new flat structure
    
    * Fix Flow
    
    * Fix CJS and UMD builds
    
    * Fix FB bundles
    
    * Fix RN bundles
    
    * Prettier
    
    * Fix lint
    
    * Fix warning printing and error codes
    
    * Fix buggy return
    
    * Fix lint and Flow
    
    * Use Yarn on CI
    
    * Unbreak Jest
    
    * Fix lint
    
    * Fix aliased originals getting included in DEV
    
    Shouldn't affect correctness (they were ignored) but fixes DEV size regression.
    
    * Record sizes
    
    * Fix weird version in package.json
    
    * Tweak bundle labels
    
    * Get rid of output option by introducing react-dom/server.node
    
    * Reconciler should depend on prop-types
    
    * Update sizes last time

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index 3e82973ace..4833f51c29 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -34,7 +34,7 @@ describe('ReactDOMServer', () => {
     ExecutionEnvironment.canUseDOM = false;
     ReactDOMServer = require('react-dom/server');
 
-    var DOMProperty = require('DOMProperty');
+    var DOMProperty = require('react-dom/src/shared/DOMProperty');
     ROOT_ATTRIBUTE_NAME = DOMProperty.ROOT_ATTRIBUTE_NAME;
   });
 

commit 707ca7f4927f4a3d640dbcb696a4c8e8982ad8bf
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Thu Oct 26 15:15:24 2017 +0100

    Update Jest and remove hacks (#11372)
    
    * Update Jest
    
    * Remove hacks for Jest + Workspace integration
    
    They were fixed by https://github.com/facebook/jest/pull/4761.
    
    * Use relative requires in tests relying on private APIs
    
    I changed them to absolute to work around a Jest bug.
    The bug has been fixed so I can revert my past changes now.

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index 4833f51c29..ffae448c2d 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -34,7 +34,8 @@ describe('ReactDOMServer', () => {
     ExecutionEnvironment.canUseDOM = false;
     ReactDOMServer = require('react-dom/server');
 
-    var DOMProperty = require('react-dom/src/shared/DOMProperty');
+    // TODO: can we express this test with only public API?
+    var DOMProperty = require('../shared/DOMProperty');
     ROOT_ATTRIBUTE_NAME = DOMProperty.ROOT_ATTRIBUTE_NAME;
   });
 

commit 3f1f3dc12e72809c997d8e1078edfadd7e31bc14
Author: Anushree Subramani <anushreesubramani@users.noreply.github.com>
Date:   Tue Oct 31 18:05:28 2017 +0530

     Deduplicated many warnings (#11140) (#11216)
    
    *  Deduplicated many warnings (#11140)
    
    *  Deduplicated the following warnings:
    
    1.  Can only update a mounted or mounting component.
        This usually means you called setState, replaceState,
        or forceUpdate on an unmounted component. This is a no-op
    
    2.  %s.componentWillReceiveProps(): Assigning directly to
        this.state is deprecated (except inside a component's
        constructor). Use setState instead.'
    
    3.  An update (setState, replaceState, or forceUpdate) was scheduled
        from inside an update function. Update functions should be pure,
        with zero side-effects. Consider using componentDidUpdate or a
        callback.
    
    4.  setState(...): Cannot call setState() inside getChildContext()
    
    * Code review changes made for #11140
    
    * Minor style fix
    
    * Test deduplication for noop updates in server renderer
    
    * Test deduplication for cWRP warning
    
    * Test deduplication for cWM setState warning
    
    * Test deduplication for unnmounted setState warning
    
    * Fix existing Flow typing
    
    * Test deduplication for invalid updates
    
    * Test deduplication of update-in-updater warning

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index ffae448c2d..17494318f0 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -656,8 +656,11 @@ describe('ReactDOMServer', () => {
         ' This usually means you called setState() outside componentWillMount() on the server.' +
         ' This is a no-op.\n\nPlease check the code for the Foo component.',
     );
+
     var markup = ReactDOMServer.renderToStaticMarkup(<Foo />);
     expect(markup).toBe('<div>hello</div>');
+    jest.runOnlyPendingTimers();
+    expectDev(console.error.calls.count()).toBe(1);
   });
 
   it('warns with a no-op when an async forceUpdate is triggered', () => {

commit 21d0c115238b4f38837020cf83e0c657d8c01c9f
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Thu Nov 2 19:50:03 2017 +0000

    Convert the Source to ES Modules (#11389)
    
    * Update transforms to handle ES modules
    
    * Update Jest to handle ES modules
    
    * Convert react package to ES modules
    
    * Convert react-art package to ES Modules
    
    * Convert react-call-return package to ES Modules
    
    * Convert react-test-renderer package to ES Modules
    
    * Convert react-cs-renderer package to ES Modules
    
    * Convert react-rt-renderer package to ES Modules
    
    * Convert react-noop-renderer package to ES Modules
    
    * Convert react-dom/server to ES modules
    
    * Convert react-dom/{client,events,test-utils} to ES modules
    
    * Convert react-dom/shared to ES modules
    
    * Convert react-native-renderer to ES modules
    
    * Convert react-reconciler to ES modules
    
    * Convert events to ES modules
    
    * Convert shared to ES modules
    
    * Remove CommonJS support from transforms
    
    * Move ReactDOMFB entry point code into react-dom/src
    
    This is clearer because we can use ES imports in it.
    
    * Fix Rollup shim configuration to work with ESM
    
    * Fix incorrect comment
    
    * Exclude external imports without side effects
    
    * Fix ReactDOM FB build
    
    * Remove TODOs I donâ€™t intend to fix yet

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index 17494318f0..4b5e127c26 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -35,7 +35,7 @@ describe('ReactDOMServer', () => {
     ReactDOMServer = require('react-dom/server');
 
     // TODO: can we express this test with only public API?
-    var DOMProperty = require('../shared/DOMProperty');
+    var DOMProperty = require('../shared/DOMProperty').default;
     ROOT_ATTRIBUTE_NAME = DOMProperty.ROOT_ATTRIBUTE_NAME;
   });
 

commit 92b7b172cce9958b846844f0b46fd7bbd8c5140d
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Sun Nov 5 11:58:36 2017 +0000

    Use named exports in more places (#11457)
    
    * Convert EventPlugin{Hub,Registry} to named exports
    
    * Convert EventPluginUtils to named exports
    
    * Convert EventPropagators to named exports
    
    * Convert ReactControlledComponent to named exports
    
    * Convert ReactGenericBatching to named exports
    
    * Convert ReactDOMComponentTree to named exports
    
    * Convert ReactNativeComponentTree to named exports
    
    * Convert ReactNativeRTComponentTree to named exports
    
    * Convert FallbackCompositionState to named exports
    
    * Convert ReactEventEmitterMixin to named exports
    
    * Convert ReactBrowserEventEmitter to named exports
    
    * Convert ReactNativeEventEmitter to named exports
    
    * Convert ReactDOMEventListener to named exports
    
    * Convert DOMMarkupOperations to named exports
    
    * Convert DOMProperty to named exports
    
    * Add suppression for existing Flow violation
    
    Flow didn't see it before.
    
    * Update sizes

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index 4b5e127c26..17494318f0 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -35,7 +35,7 @@ describe('ReactDOMServer', () => {
     ReactDOMServer = require('react-dom/server');
 
     // TODO: can we express this test with only public API?
-    var DOMProperty = require('../shared/DOMProperty').default;
+    var DOMProperty = require('../shared/DOMProperty');
     ROOT_ATTRIBUTE_NAME = DOMProperty.ROOT_ATTRIBUTE_NAME;
   });
 

commit 94f44aeba72eacb04443974c2c6c91a050d61b1c
Author: Clement Hoang <clement.hoang24@gmail.com>
Date:   Tue Nov 7 18:09:33 2017 +0000

    Update prettier to 1.8.1 (#10785)
    
    * Change prettier dependency in package.json version 1.8.1
    
    * Update yarn.lock
    
    * Apply prettier changes
    
    * Fix ReactDOMServerIntegration-test.js
    
    * Fix test for ReactDOMComponent-test.js

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index 17494318f0..c83c702307 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -81,7 +81,11 @@ describe('ReactDOMServer', () => {
     it('should render composite components', () => {
       class Parent extends React.Component {
         render() {
-          return <div><Child name="child" /></div>;
+          return (
+            <div>
+              <Child name="child" />
+            </div>
+          );
         }
       }
 
@@ -198,7 +202,9 @@ describe('ReactDOMServer', () => {
 
         render() {
           return (
-            <span ref="span" onClick={this.click}>Name: {this.props.name}</span>
+            <span ref="span" onClick={this.click}>
+              Name: {this.props.name}
+            </span>
           );
         }
       }
@@ -410,7 +416,11 @@ describe('ReactDOMServer', () => {
 
       class TestComponent extends React.Component {
         render() {
-          return <span><NestedComponent /></span>;
+          return (
+            <span>
+              <NestedComponent />
+            </span>
+          );
         }
       }
 
@@ -422,7 +432,11 @@ describe('ReactDOMServer', () => {
     it('should not put checksum and React ID on text components', () => {
       class TestComponent extends React.Component {
         render() {
-          return <span>{'hello'} {'world'}</span>;
+          return (
+            <span>
+              {'hello'} {'world'}
+            </span>
+          );
         }
       }
 
@@ -595,7 +609,9 @@ describe('ReactDOMServer', () => {
       };
 
       var markup = ReactDOMServer.renderToString(
-        <ContextProvider><Component /></ContextProvider>,
+        <ContextProvider>
+          <Component />
+        </ContextProvider>,
       );
       expect(markup).toContain('hello, world');
     });

commit afc5fab26ca95438ddbc07abd1099a2a9d4c4941
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Mon Nov 13 15:22:12 2017 +0000

    Don't emit autoFocus={false} attribute on the server (#11543)

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index c83c702307..86519ae585 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -382,6 +382,21 @@ describe('ReactDOMServer', () => {
       expect(element.firstChild.focus).not.toHaveBeenCalled();
     });
 
+    it('should not focus on either server or client with autofocus={false}', () => {
+      var element = document.createElement('div');
+      element.innerHTML = ReactDOMServer.renderToString(
+        <input autoFocus={false} />,
+      );
+      expect(element.firstChild.autofocus).toBe(false);
+
+      element.firstChild.focus = jest.fn();
+      ReactDOM.hydrate(<input autoFocus={false} />, element);
+      expect(element.firstChild.focus).not.toHaveBeenCalled();
+
+      ReactDOM.render(<input autoFocus={false} />, element);
+      expect(element.firstChild.focus).not.toHaveBeenCalled();
+    });
+
     it('should throw with silly args', () => {
       expect(
         ReactDOMServer.renderToString.bind(ReactDOMServer, {x: 123}),

commit 6041f481b7851d75649630eea489628d399cc3cf
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Wed Nov 22 13:02:26 2017 +0000

    Run Jest in production mode (#11616)
    
    * Move Jest setup files to /dev/ subdirectory
    
    * Clone Jest /dev/ files into /prod/
    
    * Move shared code into scripts/jest
    
    * Move Jest config into the scripts folder
    
    * Fix the equivalence test
    
    It fails because the config is now passed to Jest explicitly.
    But the test doesn't know about the config.
    
    To fix this, we just run it via `yarn test` (which includes the config).
    We already depend on Yarn for development anyway.
    
    * Add yarn test-prod to run Jest with production environment
    
    * Actually flip the production tests to run in prod environment
    
    This produces a bunch of errors:
    
    Test Suites: 64 failed, 58 passed, 122 total
    Tests:       740 failed, 26 skipped, 1809 passed, 2575 total
    Snapshots:   16 failed, 4 passed, 20 total
    
    * Ignore expectDev() calls in production
    
    Down from 740 to 175 failed.
    
    Test Suites: 44 failed, 78 passed, 122 total
    Tests:       175 failed, 26 skipped, 2374 passed, 2575 total
    Snapshots:   16 failed, 4 passed, 20 total
    
    * Decode errors so tests can assert on their messages
    
    Down from 175 to 129.
    
    Test Suites: 33 failed, 89 passed, 122 total
    Tests:       129 failed, 1029 skipped, 1417 passed, 2575 total
    Snapshots:   16 failed, 4 passed, 20 total
    
    * Remove ReactDOMProduction-test
    
    There is no need for it now. The only test that was special is moved into ReactDOM-test.
    
    * Remove production switches from ReactErrorUtils
    
    The tests now run in production in a separate pass.
    
    * Add and use spyOnDev() for warnings
    
    This ensures that by default we expect no warnings in production bundles.
    If the warning *is* expected, use the regular spyOn() method.
    
    This currently breaks all expectDev() assertions without __DEV__ blocks so we go back to:
    
    Test Suites: 56 failed, 65 passed, 121 total
    Tests:       379 failed, 1029 skipped, 1148 passed, 2556 total
    Snapshots:   16 failed, 4 passed, 20 total
    
    * Replace expectDev() with expect() in __DEV__ blocks
    
    We started using spyOnDev() for console warnings to ensure we don't *expect* them to occur in production. As a consequence, expectDev() assertions on console.error.calls fail because console.error.calls doesn't exist. This is actually good because it would help catch accidental warnings in production.
    
    To solve this, we are getting rid of expectDev() altogether, and instead introduce explicit expectation branches. We'd need them anyway for testing intentional behavior differences.
    
    This commit replaces all expectDev() calls with expect() calls in __DEV__ blocks. It also removes a few unnecessary expect() checks that no warnings were produced (by also removing the corresponding spyOnDev() calls).
    
    Some DEV-only assertions used plain expect(). Those were also moved into __DEV__ blocks.
    
    ReactFiberErrorLogger was special because it console.error()'s in production too. So in that case I intentionally used spyOn() instead of spyOnDev(), and added extra assertions.
    
    This gets us down to:
    
    Test Suites: 21 failed, 100 passed, 121 total
    Tests:       72 failed, 26 skipped, 2458 passed, 2556 total
    Snapshots:   16 failed, 4 passed, 20 total
    
    * Enable User Timing API for production testing
    
    We could've disabled it, but seems like a good idea to test since we use it at FB.
    
    * Test for explicit Object.freeze() differences between PROD and DEV
    
    This is one of the few places where DEV and PROD behavior differs for performance reasons.
    Now we explicitly test both branches.
    
    * Run Jest via "yarn test" on CI
    
    * Remove unused variable
    
    * Assert different error messages
    
    * Fix error handling tests
    
    This logic is really complicated because of the global ReactFiberErrorLogger mock.
    I understand it now, so I added TODOs for later.
    
    It can be much simpler if we change the rest of the tests that assert uncaught errors to also assert they are logged as warnings.
    Which mirrors what happens in practice anyway.
    
    * Fix more assertions
    
    * Change tests to document the DEV/PROD difference for state invariant
    
    It is very likely unintentional but I don't want to change behavior in this PR.
    Filed a follow up as https://github.com/facebook/react/issues/11618.
    
    * Remove unnecessary split between DEV/PROD ref tests
    
    * Fix more test message assertions
    
    * Make validateDOMNesting tests DEV-only
    
    * Fix error message assertions
    
    * Document existing DEV/PROD message difference (possible bug)
    
    * Change mocking assertions to be DEV-only
    
    * Fix the error code test
    
    * Fix more error message assertions
    
    * Fix the last failing test due to known issue
    
    * Run production tests on CI
    
    * Unify configuration
    
    * Fix coverage script
    
    * Remove expectDev from eslintrc
    
    * Run everything in band
    
    We used to before, too. I just forgot to add the arguments after deleting the script.

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index 86519ae585..a321d457f9 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -183,8 +183,8 @@ describe('ReactDOMServer', () => {
     });
 
     it('should have the correct mounting behavior (old hydrate API)', () => {
-      spyOn(console, 'warn');
-      spyOn(console, 'error');
+      spyOnDev(console, 'warn');
+      spyOnDev(console, 'error');
       // This test is testing client-side behavior.
       ExecutionEnvironment.canUseDOM = true;
 
@@ -241,13 +241,15 @@ describe('ReactDOMServer', () => {
 
       var instance = ReactDOM.render(<TestComponent name="x" />, element);
       expect(mountCount).toEqual(3);
-      expectDev(console.warn.calls.count()).toBe(1);
-      expectDev(console.warn.calls.argsFor(0)[0]).toContain(
-        'render(): Calling ReactDOM.render() to hydrate server-rendered markup ' +
-          'will stop working in React v17. Replace the ReactDOM.render() call ' +
-          'with ReactDOM.hydrate() if you want React to attach to the server HTML.',
-      );
-      console.warn.calls.reset();
+      if (__DEV__) {
+        expect(console.warn.calls.count()).toBe(1);
+        expect(console.warn.calls.argsFor(0)[0]).toContain(
+          'render(): Calling ReactDOM.render() to hydrate server-rendered markup ' +
+            'will stop working in React v17. Replace the ReactDOM.render() call ' +
+            'with ReactDOM.hydrate() if you want React to attach to the server HTML.',
+        );
+        console.warn.calls.reset();
+      }
       expect(element.innerHTML).toBe(lastMarkup);
 
       // Ensure the events system works after mount into server markup
@@ -263,11 +265,13 @@ describe('ReactDOMServer', () => {
       element.innerHTML = lastMarkup;
       instance = ReactDOM.render(<TestComponent name="y" />, element);
       expect(mountCount).toEqual(4);
-      expectDev(console.error.calls.count()).toBe(1);
-      expectDev(console.error.calls.argsFor(0)[0]).toContain(
-        'Text content did not match. Server: "x" Client: "y"',
-      );
-      console.error.calls.reset();
+      if (__DEV__) {
+        expect(console.error.calls.count()).toBe(1);
+        expect(console.error.calls.argsFor(0)[0]).toContain(
+          'Text content did not match. Server: "x" Client: "y"',
+        );
+        console.error.calls.reset();
+      }
       expect(element.innerHTML.length > 0).toBe(true);
       expect(element.innerHTML).not.toEqual(lastMarkup);
 
@@ -275,12 +279,14 @@ describe('ReactDOMServer', () => {
       expect(numClicks).toEqual(1);
       ReactTestUtils.Simulate.click(ReactDOM.findDOMNode(instance.refs.span));
       expect(numClicks).toEqual(2);
-      expectDev(console.warn.calls.count()).toBe(0);
-      expectDev(console.error.calls.count()).toBe(0);
+      if (__DEV__) {
+        expect(console.warn.calls.count()).toBe(0);
+        expect(console.error.calls.count()).toBe(0);
+      }
     });
 
     it('should have the correct mounting behavior (new hydrate API)', () => {
-      spyOn(console, 'error');
+      spyOnDev(console, 'error');
       // This test is testing client-side behavior.
       ExecutionEnvironment.canUseDOM = true;
 
@@ -352,7 +358,9 @@ describe('ReactDOMServer', () => {
       element.innerHTML = lastMarkup;
       instance = ReactDOM.hydrate(<TestComponent name="y" />, element);
       expect(mountCount).toEqual(4);
-      expectDev(console.error.calls.count()).toBe(1);
+      if (__DEV__) {
+        expect(console.error.calls.count()).toBe(1);
+      }
       expect(element.innerHTML.length > 0).toBe(true);
       expect(element.innerHTML).not.toEqual(lastMarkup);
 
@@ -416,7 +424,7 @@ describe('ReactDOMServer', () => {
       expect(normalizeCodeLocInfo(caughtErr.message)).toContain(
         'The `style` prop expects a mapping from style properties to values, not ' +
           "a string. For example, style={{marginRight: spacing + 'em'}} when using JSX." +
-          '\n    in iframe (at **)',
+          (__DEV__ ? '\n    in iframe (at **)' : ''),
       );
     });
   });
@@ -678,20 +686,24 @@ describe('ReactDOMServer', () => {
       }
     }
 
-    spyOn(console, 'error');
+    spyOnDev(console, 'error');
     ReactDOMServer.renderToString(<Foo />);
     jest.runOnlyPendingTimers();
-    expectDev(console.error.calls.count()).toBe(1);
-    expectDev(console.error.calls.mostRecent().args[0]).toBe(
-      'Warning: setState(...): Can only update a mounting component.' +
-        ' This usually means you called setState() outside componentWillMount() on the server.' +
-        ' This is a no-op.\n\nPlease check the code for the Foo component.',
-    );
+    if (__DEV__) {
+      expect(console.error.calls.count()).toBe(1);
+      expect(console.error.calls.mostRecent().args[0]).toBe(
+        'Warning: setState(...): Can only update a mounting component.' +
+          ' This usually means you called setState() outside componentWillMount() on the server.' +
+          ' This is a no-op.\n\nPlease check the code for the Foo component.',
+      );
+    }
 
     var markup = ReactDOMServer.renderToStaticMarkup(<Foo />);
     expect(markup).toBe('<div>hello</div>');
     jest.runOnlyPendingTimers();
-    expectDev(console.error.calls.count()).toBe(1);
+    if (__DEV__) {
+      expect(console.error.calls.count()).toBe(1);
+    }
   });
 
   it('warns with a no-op when an async forceUpdate is triggered', () => {
@@ -708,38 +720,52 @@ describe('ReactDOMServer', () => {
       }
     }
 
-    spyOn(console, 'error');
+    spyOnDev(console, 'error');
     ReactDOMServer.renderToString(<Baz />);
     jest.runOnlyPendingTimers();
-    expectDev(console.error.calls.count()).toBe(1);
-    expectDev(console.error.calls.mostRecent().args[0]).toBe(
-      'Warning: forceUpdate(...): Can only update a mounting component. ' +
-        'This usually means you called forceUpdate() outside componentWillMount() on the server. ' +
-        'This is a no-op.\n\nPlease check the code for the Baz component.',
-    );
+    if (__DEV__) {
+      expect(console.error.calls.count()).toBe(1);
+      expect(console.error.calls.mostRecent().args[0]).toBe(
+        'Warning: forceUpdate(...): Can only update a mounting component. ' +
+          'This usually means you called forceUpdate() outside componentWillMount() on the server. ' +
+          'This is a no-op.\n\nPlease check the code for the Baz component.',
+      );
+    }
     var markup = ReactDOMServer.renderToStaticMarkup(<Baz />);
     expect(markup).toBe('<div></div>');
   });
 
-  it('should warn when children are mutated during render', () => {
-    spyOn(console, 'error');
+  it('should throw (in dev) when children are mutated during render', () => {
+    spyOnDev(console, 'error');
     function Wrapper(props) {
       props.children[1] = <p key={1} />; // Mutation is illegal
       return <div>{props.children}</div>;
     }
-    expect(() => {
-      ReactDOMServer.renderToStaticMarkup(
-        <Wrapper>
-          <span key={0} />
-          <span key={1} />
-          <span key={2} />
-        </Wrapper>,
-      );
-    }).toThrowError(/Cannot assign to read only property.*/);
+    if (__DEV__) {
+      expect(() => {
+        ReactDOMServer.renderToStaticMarkup(
+          <Wrapper>
+            <span key={0} />
+            <span key={1} />
+            <span key={2} />
+          </Wrapper>,
+        );
+      }).toThrowError(/Cannot assign to read only property.*/);
+    } else {
+      expect(
+        ReactDOMServer.renderToStaticMarkup(
+          <Wrapper>
+            <span key={0} />
+            <span key={1} />
+            <span key={2} />
+          </Wrapper>,
+        ),
+      ).toContain('<p>');
+    }
   });
 
   it('warns about lowercase html but not in svg tags', () => {
-    spyOn(console, 'error');
+    spyOnDev(console, 'error');
     function CompositeG(props) {
       // Make sure namespace passes through composites
       return <g>{props.children}</g>;
@@ -758,27 +784,31 @@ describe('ReactDOMServer', () => {
         </svg>
       </div>,
     );
-    expect(console.error.calls.count()).toBe(2);
-    expect(console.error.calls.argsFor(0)[0]).toBe(
-      'Warning: <inPUT /> is using uppercase HTML. Always use lowercase ' +
-        'HTML tags in React.',
-    );
-    // linearGradient doesn't warn
-    expect(console.error.calls.argsFor(1)[0]).toBe(
-      'Warning: <iFrame /> is using uppercase HTML. Always use lowercase ' +
-        'HTML tags in React.',
-    );
+    if (__DEV__) {
+      expect(console.error.calls.count()).toBe(2);
+      expect(console.error.calls.argsFor(0)[0]).toBe(
+        'Warning: <inPUT /> is using uppercase HTML. Always use lowercase ' +
+          'HTML tags in React.',
+      );
+      // linearGradient doesn't warn
+      expect(console.error.calls.argsFor(1)[0]).toBe(
+        'Warning: <iFrame /> is using uppercase HTML. Always use lowercase ' +
+          'HTML tags in React.',
+      );
+    }
   });
 
   it('should warn about contentEditable and children', () => {
-    spyOn(console, 'error');
+    spyOnDev(console, 'error');
     ReactDOMServer.renderToString(<div contentEditable={true} children="" />);
-    expectDev(console.error.calls.count()).toBe(1);
-    expectDev(normalizeCodeLocInfo(console.error.calls.argsFor(0)[0])).toBe(
-      'Warning: A component is `contentEditable` and contains `children` ' +
-        'managed by React. It is now your responsibility to guarantee that ' +
-        'none of those nodes are unexpectedly modified or duplicated. This ' +
-        'is probably not intentional.\n    in div (at **)',
-    );
+    if (__DEV__) {
+      expect(console.error.calls.count()).toBe(1);
+      expect(normalizeCodeLocInfo(console.error.calls.argsFor(0)[0])).toBe(
+        'Warning: A component is `contentEditable` and contains `children` ' +
+          'managed by React. It is now your responsibility to guarantee that ' +
+          'none of those nodes are unexpectedly modified or duplicated. This ' +
+          'is probably not intentional.\n    in div (at **)',
+      );
+    }
   });
 });

commit fa7a97fc46935e1611d52da2fdb7d53f6ab9577d
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Thu Nov 23 17:44:58 2017 +0000

    Run 90% of tests on compiled bundles (both development and production) (#11633)
    
    * Extract Jest config into a separate file
    
    * Refactor Jest scripts directory structure
    
    Introduces a more consistent naming scheme.
    
    * Add yarn test-bundles and yarn test-prod-bundles
    
    Only files ending with -test.public.js are opted in (so far we don't have any).
    
    * Fix error decoding for production bundles
    
    GCC seems to remove `new` from `new Error()` which broke our proxy.
    
    * Build production version of react-noop-renderer
    
    This lets us test more bundles.
    
    * Switch to blacklist (exclude .private.js tests)
    
    * Rename tests that are currently broken against bundles to *-test.internal.js
    
    Some of these are using private APIs. Some have other issues.
    
    * Add bundle tests to CI
    
    * Split private and public ReactJSXElementValidator tests
    
    * Remove internal deps from ReactServerRendering-test and make it public
    
    * Only run tests directly in __tests__
    
    This lets us share code between test files by placing them in __tests__/utils.
    
    * Remove ExecutionEnvironment dependency from DOMServerIntegrationTest
    
    It's not necessary since Stack.
    
    * Split up ReactDOMServerIntegration into test suite and utilities
    
    This enables us to further split it down. Good both for parallelization and extracting public parts.
    
    * Split Fragment tests from other DOMServerIntegration tests
    
    This enables them to opt other DOMServerIntegration tests into bundle testing.
    
    * Split ReactDOMServerIntegration into different test files
    
    It was way too slow to run all these in sequence.
    
    * Don't reset the cache twice in DOMServerIntegration tests
    
    We used to do this to simulate testing separate bundles.
    But now we actually *do* test bundles. So there is no need for this, as it makes tests slower.
    
    * Rename test-bundles* commands to test-build*
    
    Also add test-prod-build as alias for test-build-prod because I keep messing them up.
    
    * Use regenerator polyfill for react-noop
    
    This fixes other issues and finally lets us run ReactNoop tests against a prod bundle.
    
    * Run most Incremental tests against bundles
    
    Now that GCC generator issue is fixed, we can do this.
    I split ErrorLogging test separately because it does mocking. Other error handling tests don't need it.
    
    * Update sizes
    
    * Fix ReactMount test
    
    * Enable ReactDOMComponent test
    
    * Fix a warning issue uncovered by flat bundle testing
    
    With flat bundles, we couldn't produce a good warning for <div onclick={}> on SSR
    because it doesn't use the event system. However the issue was not visible in normal
    Jest runs because the event plugins have been injected by the time the test ran.
    
    To solve this, I am explicitly passing whether event system is available as an argument
    to the hook. This makes the behavior consistent between source and bundle tests. Then
    I change the tests to document the actual logic and _attempt_ to show a nice message
    (e.g. we know for sure `onclick` is a bad event but we don't know the right name for it
    on the server so we just say a generic message about camelCase naming convention).

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index a321d457f9..bb8ecc6e81 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -9,15 +9,12 @@
 
 'use strict';
 
-var ExecutionEnvironment;
 var React;
 var ReactDOM;
 var ReactDOMServer;
 var ReactTestUtils;
 var PropTypes;
 
-var ROOT_ATTRIBUTE_NAME;
-
 function normalizeCodeLocInfo(str) {
   return str && str.replace(/\(at .+?:\d+\)/g, '(at **)');
 }
@@ -29,39 +26,26 @@ describe('ReactDOMServer', () => {
     ReactDOM = require('react-dom');
     ReactTestUtils = require('react-dom/test-utils');
     PropTypes = require('prop-types');
-
-    ExecutionEnvironment = require('fbjs/lib/ExecutionEnvironment');
-    ExecutionEnvironment.canUseDOM = false;
     ReactDOMServer = require('react-dom/server');
-
-    // TODO: can we express this test with only public API?
-    var DOMProperty = require('../shared/DOMProperty');
-    ROOT_ATTRIBUTE_NAME = DOMProperty.ROOT_ATTRIBUTE_NAME;
   });
 
   describe('renderToString', () => {
     it('should generate simple markup', () => {
       var response = ReactDOMServer.renderToString(<span>hello world</span>);
       expect(response).toMatch(
-        new RegExp(
-          '<span ' + ROOT_ATTRIBUTE_NAME + '=""' + '>hello world</span>',
-        ),
+        new RegExp('<span data-reactroot=""' + '>hello world</span>'),
       );
     });
 
     it('should generate simple markup for self-closing tags', () => {
       var response = ReactDOMServer.renderToString(<img />);
-      expect(response).toMatch(
-        new RegExp('<img ' + ROOT_ATTRIBUTE_NAME + '=""' + '/>'),
-      );
+      expect(response).toMatch(new RegExp('<img data-reactroot=""' + '/>'));
     });
 
     it('should generate simple markup for attribute with `>` symbol', () => {
       var response = ReactDOMServer.renderToString(<img data-attr=">" />);
       expect(response).toMatch(
-        new RegExp(
-          '<img data-attr="&gt;" ' + ROOT_ATTRIBUTE_NAME + '=""' + '/>',
-        ),
+        new RegExp('<img data-attr="&gt;" data-reactroot=""' + '/>'),
       );
     });
 
@@ -99,7 +83,7 @@ describe('ReactDOMServer', () => {
       expect(response).toMatch(
         new RegExp(
           '<div ' +
-            ROOT_ATTRIBUTE_NAME +
+            'data-reactroot' +
             '=""' +
             '>' +
             '<span' +
@@ -161,7 +145,7 @@ describe('ReactDOMServer', () => {
         expect(response).toMatch(
           new RegExp(
             '<span ' +
-              ROOT_ATTRIBUTE_NAME +
+              'data-reactroot' +
               '=""' +
               '>' +
               'Component name: <!-- -->TestComponent' +
@@ -176,17 +160,11 @@ describe('ReactDOMServer', () => {
       }
 
       runTest();
-
-      // This should work the same regardless of whether you can use DOM or not.
-      ExecutionEnvironment.canUseDOM = true;
-      runTest();
     });
 
     it('should have the correct mounting behavior (old hydrate API)', () => {
       spyOnDev(console, 'warn');
       spyOnDev(console, 'error');
-      // This test is testing client-side behavior.
-      ExecutionEnvironment.canUseDOM = true;
 
       var mountCount = 0;
       var numClicks = 0;
@@ -234,9 +212,7 @@ describe('ReactDOMServer', () => {
       ReactDOM.unmountComponentAtNode(element);
       expect(element.innerHTML).toEqual('');
 
-      ExecutionEnvironment.canUseDOM = false;
       lastMarkup = ReactDOMServer.renderToString(<TestComponent name="x" />);
-      ExecutionEnvironment.canUseDOM = true;
       element.innerHTML = lastMarkup;
 
       var instance = ReactDOM.render(<TestComponent name="x" />, element);
@@ -287,8 +263,6 @@ describe('ReactDOMServer', () => {
 
     it('should have the correct mounting behavior (new hydrate API)', () => {
       spyOnDev(console, 'error');
-      // This test is testing client-side behavior.
-      ExecutionEnvironment.canUseDOM = true;
 
       var mountCount = 0;
       var numClicks = 0;
@@ -336,9 +310,7 @@ describe('ReactDOMServer', () => {
       ReactDOM.unmountComponentAtNode(element);
       expect(element.innerHTML).toEqual('');
 
-      ExecutionEnvironment.canUseDOM = false;
       lastMarkup = ReactDOMServer.renderToString(<TestComponent name="x" />);
-      ExecutionEnvironment.canUseDOM = true;
       element.innerHTML = lastMarkup;
 
       var instance = ReactDOM.hydrate(<TestComponent name="x" />, element);
@@ -536,10 +508,6 @@ describe('ReactDOMServer', () => {
       }
 
       runTest();
-
-      // This should work the same regardless of whether you can use DOM or not.
-      ExecutionEnvironment.canUseDOM = true;
-      runTest();
     });
 
     it('should throw with silly args', () => {

commit cafe352c1a6ab8591b6e42e1e788d48115b0a814
Author: Jeremias Menichelli <jmenichelli@gmail.com>
Date:   Thu Nov 23 19:41:28 2017 -0300

    Drop .textContent IE8 polyfill and rewrite escaping tests against public API (#11331)
    
    * Rename escapeText util. Test quoteAttributeValueForBrowser through ReactDOMServer API
    
    * Fix lint errors
    
    * Prettier reformatting
    
    * Change syntax to prevent prettier escape doble quote
    
    * Name and description gardening. Add tests for escapeTextForBrowser. Add missing tests
    
    * Improve script tag as text content test
    
    * Update escapeTextForBrowser-test.js
    
    * Update quoteAttributeValueForBrowser-test.js
    
    * Simplify tests
    
    * Move utilities to server folder

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index bb8ecc6e81..12294a9e69 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -42,13 +42,6 @@ describe('ReactDOMServer', () => {
       expect(response).toMatch(new RegExp('<img data-reactroot=""' + '/>'));
     });
 
-    it('should generate simple markup for attribute with `>` symbol', () => {
-      var response = ReactDOMServer.renderToString(<img data-attr=">" />);
-      expect(response).toMatch(
-        new RegExp('<img data-attr="&gt;" data-reactroot=""' + '/>'),
-      );
-    });
-
     it('should generate comment markup for component returns null', () => {
       class NullComponent extends React.Component {
         render() {

commit c3f1b6cd91ffa3e05465c3ed2f48225876c1bd3b
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Wed Nov 29 21:45:38 2017 +0000

    Prevent infinite loop when SSR-rendering a portal (#11709)

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index 12294a9e69..9bb4c61294 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -10,6 +10,7 @@
 'use strict';
 
 var React;
+var ReactCallReturn;
 var ReactDOM;
 var ReactDOMServer;
 var ReactTestUtils;
@@ -23,6 +24,7 @@ describe('ReactDOMServer', () => {
   beforeEach(() => {
     jest.resetModules();
     React = require('react');
+    ReactCallReturn = require('react-call-return');
     ReactDOM = require('react-dom');
     ReactTestUtils = require('react-dom/test-utils');
     PropTypes = require('prop-types');
@@ -772,4 +774,36 @@ describe('ReactDOMServer', () => {
       );
     }
   });
+
+  it('should throw rendering portals on the server', () => {
+    var div = document.createElement('div');
+    expect(() => {
+      ReactDOMServer.renderToString(
+        <div>{ReactDOM.createPortal(<div />, div)}</div>,
+      );
+    }).toThrow(
+      'Portals are not currently supported by the server renderer. ' +
+        'Render them conditionally so that they only appear on the client render.',
+    );
+  });
+
+  it('should throw rendering call/return on the server', () => {
+    var div = document.createElement('div');
+    expect(() => {
+      ReactDOMServer.renderToString(
+        <div>{ReactCallReturn.unstable_createReturn(42)}</div>,
+      );
+    }).toThrow(
+      'The experimental Call and Return types are not currently supported by the server renderer.',
+    );
+    expect(() => {
+      ReactDOMServer.renderToString(
+        <div>
+          {ReactCallReturn.unstable_createCall(null, function() {}, {})}
+        </div>,
+      );
+    }).toThrow(
+      'The experimental Call and Return types are not currently supported by the server renderer.',
+    );
+  });
 });

commit 48616e591fe23c0b89b0823c3ec99bae2d7b6853
Author: Raphael Amorim <rapha850@gmail.com>
Date:   Tue Dec 5 16:29:22 2017 -0200

    react-dom: convert packages/react-dom/src/__tests__ (#11776)

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index 9bb4c61294..a65fea1c8b 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -9,12 +9,12 @@
 
 'use strict';
 
-var React;
-var ReactCallReturn;
-var ReactDOM;
-var ReactDOMServer;
-var ReactTestUtils;
-var PropTypes;
+let React;
+let ReactCallReturn;
+let ReactDOM;
+let ReactDOMServer;
+let ReactTestUtils;
+let PropTypes;
 
 function normalizeCodeLocInfo(str) {
   return str && str.replace(/\(at .+?:\d+\)/g, '(at **)');
@@ -33,14 +33,14 @@ describe('ReactDOMServer', () => {
 
   describe('renderToString', () => {
     it('should generate simple markup', () => {
-      var response = ReactDOMServer.renderToString(<span>hello world</span>);
+      const response = ReactDOMServer.renderToString(<span>hello world</span>);
       expect(response).toMatch(
         new RegExp('<span data-reactroot=""' + '>hello world</span>'),
       );
     });
 
     it('should generate simple markup for self-closing tags', () => {
-      var response = ReactDOMServer.renderToString(<img />);
+      const response = ReactDOMServer.renderToString(<img />);
       expect(response).toMatch(new RegExp('<img data-reactroot=""' + '/>'));
     });
 
@@ -51,7 +51,7 @@ describe('ReactDOMServer', () => {
         }
       }
 
-      var response = ReactDOMServer.renderToString(<NullComponent />);
+      const response = ReactDOMServer.renderToString(<NullComponent />);
       expect(response).toBe('');
     });
 
@@ -74,7 +74,7 @@ describe('ReactDOMServer', () => {
         }
       }
 
-      var response = ReactDOMServer.renderToString(<Parent />);
+      const response = ReactDOMServer.renderToString(<Parent />);
       expect(response).toMatch(
         new RegExp(
           '<div ' +
@@ -92,7 +92,7 @@ describe('ReactDOMServer', () => {
 
     it('should only execute certain lifecycle methods', () => {
       function runTest() {
-        var lifecycle = [];
+        const lifecycle = [];
 
         class TestComponent extends React.Component {
           constructor(props) {
@@ -135,7 +135,7 @@ describe('ReactDOMServer', () => {
           }
         }
 
-        var response = ReactDOMServer.renderToString(<TestComponent />);
+        const response = ReactDOMServer.renderToString(<TestComponent />);
 
         expect(response).toMatch(
           new RegExp(
@@ -161,8 +161,8 @@ describe('ReactDOMServer', () => {
       spyOnDev(console, 'warn');
       spyOnDev(console, 'error');
 
-      var mountCount = 0;
-      var numClicks = 0;
+      let mountCount = 0;
+      let numClicks = 0;
 
       class TestComponent extends React.Component {
         componentDidMount() {
@@ -182,10 +182,10 @@ describe('ReactDOMServer', () => {
         }
       }
 
-      var element = document.createElement('div');
+      const element = document.createElement('div');
       ReactDOM.render(<TestComponent />, element);
 
-      var lastMarkup = element.innerHTML;
+      let lastMarkup = element.innerHTML;
 
       // Exercise the update path. Markup should not change,
       // but some lifecycle methods should be run again.
@@ -210,7 +210,7 @@ describe('ReactDOMServer', () => {
       lastMarkup = ReactDOMServer.renderToString(<TestComponent name="x" />);
       element.innerHTML = lastMarkup;
 
-      var instance = ReactDOM.render(<TestComponent name="x" />, element);
+      let instance = ReactDOM.render(<TestComponent name="x" />, element);
       expect(mountCount).toEqual(3);
       if (__DEV__) {
         expect(console.warn.calls.count()).toBe(1);
@@ -259,8 +259,8 @@ describe('ReactDOMServer', () => {
     it('should have the correct mounting behavior (new hydrate API)', () => {
       spyOnDev(console, 'error');
 
-      var mountCount = 0;
-      var numClicks = 0;
+      let mountCount = 0;
+      let numClicks = 0;
 
       class TestComponent extends React.Component {
         componentDidMount() {
@@ -280,10 +280,10 @@ describe('ReactDOMServer', () => {
         }
       }
 
-      var element = document.createElement('div');
+      const element = document.createElement('div');
       ReactDOM.render(<TestComponent />, element);
 
-      var lastMarkup = element.innerHTML;
+      let lastMarkup = element.innerHTML;
 
       // Exercise the update path. Markup should not change,
       // but some lifecycle methods should be run again.
@@ -308,7 +308,7 @@ describe('ReactDOMServer', () => {
       lastMarkup = ReactDOMServer.renderToString(<TestComponent name="x" />);
       element.innerHTML = lastMarkup;
 
-      var instance = ReactDOM.hydrate(<TestComponent name="x" />, element);
+      let instance = ReactDOM.hydrate(<TestComponent name="x" />, element);
       expect(mountCount).toEqual(3);
       expect(element.innerHTML).toBe(lastMarkup);
 
@@ -341,7 +341,7 @@ describe('ReactDOMServer', () => {
     // want it to call focus() when hydrating because this can mess up existing
     // focus before the JS has loaded.
     it('should emit autofocus on the server but not focus() when hydrating', () => {
-      var element = document.createElement('div');
+      const element = document.createElement('div');
       element.innerHTML = ReactDOMServer.renderToString(
         <input autoFocus={true} />,
       );
@@ -358,7 +358,7 @@ describe('ReactDOMServer', () => {
     });
 
     it('should not focus on either server or client with autofocus={false}', () => {
-      var element = document.createElement('div');
+      const element = document.createElement('div');
       element.innerHTML = ReactDOMServer.renderToString(
         <input autoFocus={false} />,
       );
@@ -414,7 +414,7 @@ describe('ReactDOMServer', () => {
         }
       }
 
-      var response = ReactDOMServer.renderToStaticMarkup(<TestComponent />);
+      const response = ReactDOMServer.renderToStaticMarkup(<TestComponent />);
 
       expect(response).toBe('<span><div>inner text</div></span>');
     });
@@ -430,7 +430,7 @@ describe('ReactDOMServer', () => {
         }
       }
 
-      var response = ReactDOMServer.renderToStaticMarkup(<TestComponent />);
+      const response = ReactDOMServer.renderToStaticMarkup(<TestComponent />);
 
       expect(response).toBe('<span>hello world</span>');
     });
@@ -442,14 +442,14 @@ describe('ReactDOMServer', () => {
         }
       }
 
-      var response = ReactDOMServer.renderToStaticMarkup(<TestComponent />);
+      const response = ReactDOMServer.renderToStaticMarkup(<TestComponent />);
 
       expect(response).toBe('');
     });
 
     it('should only execute certain lifecycle methods', () => {
       function runTest() {
-        var lifecycle = [];
+        const lifecycle = [];
 
         class TestComponent extends React.Component {
           constructor(props) {
@@ -492,7 +492,7 @@ describe('ReactDOMServer', () => {
           }
         }
 
-        var response = ReactDOMServer.renderToStaticMarkup(<TestComponent />);
+        const response = ReactDOMServer.renderToStaticMarkup(<TestComponent />);
 
         expect(response).toBe('<span>Component name: TestComponent</span>');
         expect(lifecycle).toEqual([
@@ -523,7 +523,7 @@ describe('ReactDOMServer', () => {
           return <div>{this.state.text}</div>;
         }
       }
-      var markup = ReactDOMServer.renderToString(<Component />);
+      const markup = ReactDOMServer.renderToString(<Component />);
       expect(markup).toContain('hello, world');
     });
 
@@ -542,7 +542,7 @@ describe('ReactDOMServer', () => {
           return <div>{this.state.text}</div>;
         }
       }
-      var markup = ReactDOMServer.renderToString(<Component />);
+      const markup = ReactDOMServer.renderToString(<Component />);
       expect(markup).toContain('hello, world');
     });
 
@@ -557,7 +557,7 @@ describe('ReactDOMServer', () => {
         }
       }
 
-      var markup = ReactDOMServer.renderToString(
+      const markup = ReactDOMServer.renderToString(
         <Component text="hello, world" />,
       );
       expect(markup).toContain('hello, world');
@@ -594,7 +594,7 @@ describe('ReactDOMServer', () => {
         text: PropTypes.string,
       };
 
-      var markup = ReactDOMServer.renderToString(
+      const markup = ReactDOMServer.renderToString(
         <ContextProvider>
           <Component />
         </ContextProvider>,
@@ -661,7 +661,7 @@ describe('ReactDOMServer', () => {
       );
     }
 
-    var markup = ReactDOMServer.renderToStaticMarkup(<Foo />);
+    const markup = ReactDOMServer.renderToStaticMarkup(<Foo />);
     expect(markup).toBe('<div>hello</div>');
     jest.runOnlyPendingTimers();
     if (__DEV__) {
@@ -694,7 +694,7 @@ describe('ReactDOMServer', () => {
           'This is a no-op.\n\nPlease check the code for the Baz component.',
       );
     }
-    var markup = ReactDOMServer.renderToStaticMarkup(<Baz />);
+    const markup = ReactDOMServer.renderToStaticMarkup(<Baz />);
     expect(markup).toBe('<div></div>');
   });
 
@@ -776,7 +776,7 @@ describe('ReactDOMServer', () => {
   });
 
   it('should throw rendering portals on the server', () => {
-    var div = document.createElement('div');
+    const div = document.createElement('div');
     expect(() => {
       ReactDOMServer.renderToString(
         <div>{ReactDOM.createPortal(<div />, div)}</div>,
@@ -788,7 +788,7 @@ describe('ReactDOMServer', () => {
   });
 
   it('should throw rendering call/return on the server', () => {
-    var div = document.createElement('div');
+    const div = document.createElement('div');
     expect(() => {
       ReactDOMServer.renderToString(
         <div>{ReactCallReturn.unstable_createReturn(42)}</div>,

commit 19bc2dd090c44be862bae59c64e89acb8d0827f5
Author: Toru Kobayashi <koba0004@gmail.com>
Date:   Thu Dec 7 00:23:37 2017 +0900

    Fix autoFocus for hydration content when it is mismatched (#11737)
    
    * Fix autoFocus for hydration content when it is mismatched
    
    * Add a test for mismatched content
    
    * Fix a test for production
    
    * Fix a spec description and verify console.error output
    
    * Run prettier
    
    * finalizeInitialChildren always returns `true`
    
    * Revert "finalizeInitialChildren always returns `true`"
    
    This reverts commit 58edd228046bcafcbcd04a70cb5e78520b50a07e.
    
    * Add a TODO comment
    
    * Update ReactServerRendering-test.js
    
    * Update ReactServerRendering-test.js
    
    * Rewrite the comment

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index a65fea1c8b..c2a1e6b3d7 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -372,6 +372,28 @@ describe('ReactDOMServer', () => {
       expect(element.firstChild.focus).not.toHaveBeenCalled();
     });
 
+    // Regression test for https://github.com/facebook/react/issues/11726
+    it('should not focus on either server or client with autofocus={false} even if there is a markup mismatch', () => {
+      spyOnDev(console, 'error');
+
+      var element = document.createElement('div');
+      element.innerHTML = ReactDOMServer.renderToString(
+        <button autoFocus={false}>server</button>,
+      );
+      expect(element.firstChild.autofocus).toBe(false);
+
+      element.firstChild.focus = jest.fn();
+      ReactDOM.hydrate(<button autoFocus={false}>client</button>, element);
+
+      expect(element.firstChild.focus).not.toHaveBeenCalled();
+      if (__DEV__) {
+        expect(console.error.calls.count()).toBe(1);
+        expect(console.error.calls.argsFor(0)[0]).toBe(
+          'Warning: Text content did not match. Server: "server" Client: "client"',
+        );
+      }
+    });
+
     it('should throw with silly args', () => {
       expect(
         ReactDOMServer.renderToString.bind(ReactDOMServer, {x: 123}),

commit e8e62ebb595434db40ee9a079189b1ee7e111ffe
Author: Jack Hou <ctxhou@gmail.com>
Date:   Mon Dec 11 23:52:46 2017 +0800

    use different eslint config for es6 and es5 (#11794)
    
    * use different eslint config for es6 and es5
    
    * remove confusing eslint/baseConfig.js & add more eslint setting for es5, es6
    
    * more clear way to run eslint on es5 & es6 file
    
    * seperate ESNext, ES6, ES6 path, and use different lint config
    
    * rename eslint config file & update eslint rules
    
    * Undo yarn.lock changes
    
    * Rename a file
    
    * Remove unnecessary exceptions
    
    * Refactor a little bit
    
    * Refactor and tweak the logic
    
    * Minor issues

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index c2a1e6b3d7..1cb2915b7d 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -376,7 +376,7 @@ describe('ReactDOMServer', () => {
     it('should not focus on either server or client with autofocus={false} even if there is a markup mismatch', () => {
       spyOnDev(console, 'error');
 
-      var element = document.createElement('div');
+      const element = document.createElement('div');
       element.innerHTML = ReactDOMServer.renderToString(
         <button autoFocus={false}>server</button>,
       );

commit 0deea326674077598e351803d7a204a1c744a578
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Tue Jan 2 18:42:18 2018 +0000

    Run some tests in Node environment (#11948)
    
    * Run some tests in Node environment
    
    * Separate SSR tests that require DOM
    
    This allow us to run others with Node environment.

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index 1cb2915b7d..642d950f22 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -5,15 +5,14 @@
  * LICENSE file in the root directory of this source tree.
  *
  * @emails react-core
+ * @jest-environment node
  */
 
 'use strict';
 
 let React;
 let ReactCallReturn;
-let ReactDOM;
 let ReactDOMServer;
-let ReactTestUtils;
 let PropTypes;
 
 function normalizeCodeLocInfo(str) {
@@ -25,8 +24,6 @@ describe('ReactDOMServer', () => {
     jest.resetModules();
     React = require('react');
     ReactCallReturn = require('react-call-return');
-    ReactDOM = require('react-dom');
-    ReactTestUtils = require('react-dom/test-utils');
     PropTypes = require('prop-types');
     ReactDOMServer = require('react-dom/server');
   });
@@ -157,243 +154,6 @@ describe('ReactDOMServer', () => {
       runTest();
     });
 
-    it('should have the correct mounting behavior (old hydrate API)', () => {
-      spyOnDev(console, 'warn');
-      spyOnDev(console, 'error');
-
-      let mountCount = 0;
-      let numClicks = 0;
-
-      class TestComponent extends React.Component {
-        componentDidMount() {
-          mountCount++;
-        }
-
-        click = () => {
-          numClicks++;
-        };
-
-        render() {
-          return (
-            <span ref="span" onClick={this.click}>
-              Name: {this.props.name}
-            </span>
-          );
-        }
-      }
-
-      const element = document.createElement('div');
-      ReactDOM.render(<TestComponent />, element);
-
-      let lastMarkup = element.innerHTML;
-
-      // Exercise the update path. Markup should not change,
-      // but some lifecycle methods should be run again.
-      ReactDOM.render(<TestComponent name="x" />, element);
-      expect(mountCount).toEqual(1);
-
-      // Unmount and remount. We should get another mount event and
-      // we should get different markup, as the IDs are unique each time.
-      ReactDOM.unmountComponentAtNode(element);
-      expect(element.innerHTML).toEqual('');
-      ReactDOM.render(<TestComponent name="x" />, element);
-      expect(mountCount).toEqual(2);
-      expect(element.innerHTML).not.toEqual(lastMarkup);
-
-      // Now kill the node and render it on top of server-rendered markup, as if
-      // we used server rendering. We should mount again, but the markup should
-      // be unchanged. We will append a sentinel at the end of innerHTML to be
-      // sure that innerHTML was not changed.
-      ReactDOM.unmountComponentAtNode(element);
-      expect(element.innerHTML).toEqual('');
-
-      lastMarkup = ReactDOMServer.renderToString(<TestComponent name="x" />);
-      element.innerHTML = lastMarkup;
-
-      let instance = ReactDOM.render(<TestComponent name="x" />, element);
-      expect(mountCount).toEqual(3);
-      if (__DEV__) {
-        expect(console.warn.calls.count()).toBe(1);
-        expect(console.warn.calls.argsFor(0)[0]).toContain(
-          'render(): Calling ReactDOM.render() to hydrate server-rendered markup ' +
-            'will stop working in React v17. Replace the ReactDOM.render() call ' +
-            'with ReactDOM.hydrate() if you want React to attach to the server HTML.',
-        );
-        console.warn.calls.reset();
-      }
-      expect(element.innerHTML).toBe(lastMarkup);
-
-      // Ensure the events system works after mount into server markup
-      expect(numClicks).toEqual(0);
-      ReactTestUtils.Simulate.click(ReactDOM.findDOMNode(instance.refs.span));
-      expect(numClicks).toEqual(1);
-
-      ReactDOM.unmountComponentAtNode(element);
-      expect(element.innerHTML).toEqual('');
-
-      // Now simulate a situation where the app is not idempotent. React should
-      // warn but do the right thing.
-      element.innerHTML = lastMarkup;
-      instance = ReactDOM.render(<TestComponent name="y" />, element);
-      expect(mountCount).toEqual(4);
-      if (__DEV__) {
-        expect(console.error.calls.count()).toBe(1);
-        expect(console.error.calls.argsFor(0)[0]).toContain(
-          'Text content did not match. Server: "x" Client: "y"',
-        );
-        console.error.calls.reset();
-      }
-      expect(element.innerHTML.length > 0).toBe(true);
-      expect(element.innerHTML).not.toEqual(lastMarkup);
-
-      // Ensure the events system works after markup mismatch.
-      expect(numClicks).toEqual(1);
-      ReactTestUtils.Simulate.click(ReactDOM.findDOMNode(instance.refs.span));
-      expect(numClicks).toEqual(2);
-      if (__DEV__) {
-        expect(console.warn.calls.count()).toBe(0);
-        expect(console.error.calls.count()).toBe(0);
-      }
-    });
-
-    it('should have the correct mounting behavior (new hydrate API)', () => {
-      spyOnDev(console, 'error');
-
-      let mountCount = 0;
-      let numClicks = 0;
-
-      class TestComponent extends React.Component {
-        componentDidMount() {
-          mountCount++;
-        }
-
-        click = () => {
-          numClicks++;
-        };
-
-        render() {
-          return (
-            <span ref="span" onClick={this.click}>
-              Name: {this.props.name}
-            </span>
-          );
-        }
-      }
-
-      const element = document.createElement('div');
-      ReactDOM.render(<TestComponent />, element);
-
-      let lastMarkup = element.innerHTML;
-
-      // Exercise the update path. Markup should not change,
-      // but some lifecycle methods should be run again.
-      ReactDOM.render(<TestComponent name="x" />, element);
-      expect(mountCount).toEqual(1);
-
-      // Unmount and remount. We should get another mount event and
-      // we should get different markup, as the IDs are unique each time.
-      ReactDOM.unmountComponentAtNode(element);
-      expect(element.innerHTML).toEqual('');
-      ReactDOM.render(<TestComponent name="x" />, element);
-      expect(mountCount).toEqual(2);
-      expect(element.innerHTML).not.toEqual(lastMarkup);
-
-      // Now kill the node and render it on top of server-rendered markup, as if
-      // we used server rendering. We should mount again, but the markup should
-      // be unchanged. We will append a sentinel at the end of innerHTML to be
-      // sure that innerHTML was not changed.
-      ReactDOM.unmountComponentAtNode(element);
-      expect(element.innerHTML).toEqual('');
-
-      lastMarkup = ReactDOMServer.renderToString(<TestComponent name="x" />);
-      element.innerHTML = lastMarkup;
-
-      let instance = ReactDOM.hydrate(<TestComponent name="x" />, element);
-      expect(mountCount).toEqual(3);
-      expect(element.innerHTML).toBe(lastMarkup);
-
-      // Ensure the events system works after mount into server markup
-      expect(numClicks).toEqual(0);
-      ReactTestUtils.Simulate.click(ReactDOM.findDOMNode(instance.refs.span));
-      expect(numClicks).toEqual(1);
-
-      ReactDOM.unmountComponentAtNode(element);
-      expect(element.innerHTML).toEqual('');
-
-      // Now simulate a situation where the app is not idempotent. React should
-      // warn but do the right thing.
-      element.innerHTML = lastMarkup;
-      instance = ReactDOM.hydrate(<TestComponent name="y" />, element);
-      expect(mountCount).toEqual(4);
-      if (__DEV__) {
-        expect(console.error.calls.count()).toBe(1);
-      }
-      expect(element.innerHTML.length > 0).toBe(true);
-      expect(element.innerHTML).not.toEqual(lastMarkup);
-
-      // Ensure the events system works after markup mismatch.
-      expect(numClicks).toEqual(1);
-      ReactTestUtils.Simulate.click(ReactDOM.findDOMNode(instance.refs.span));
-      expect(numClicks).toEqual(2);
-    });
-
-    // We have a polyfill for autoFocus on the client, but we intentionally don't
-    // want it to call focus() when hydrating because this can mess up existing
-    // focus before the JS has loaded.
-    it('should emit autofocus on the server but not focus() when hydrating', () => {
-      const element = document.createElement('div');
-      element.innerHTML = ReactDOMServer.renderToString(
-        <input autoFocus={true} />,
-      );
-      expect(element.firstChild.autofocus).toBe(true);
-
-      // It should not be called on mount.
-      element.firstChild.focus = jest.fn();
-      ReactDOM.hydrate(<input autoFocus={true} />, element);
-      expect(element.firstChild.focus).not.toHaveBeenCalled();
-
-      // Or during an update.
-      ReactDOM.render(<input autoFocus={true} />, element);
-      expect(element.firstChild.focus).not.toHaveBeenCalled();
-    });
-
-    it('should not focus on either server or client with autofocus={false}', () => {
-      const element = document.createElement('div');
-      element.innerHTML = ReactDOMServer.renderToString(
-        <input autoFocus={false} />,
-      );
-      expect(element.firstChild.autofocus).toBe(false);
-
-      element.firstChild.focus = jest.fn();
-      ReactDOM.hydrate(<input autoFocus={false} />, element);
-      expect(element.firstChild.focus).not.toHaveBeenCalled();
-
-      ReactDOM.render(<input autoFocus={false} />, element);
-      expect(element.firstChild.focus).not.toHaveBeenCalled();
-    });
-
-    // Regression test for https://github.com/facebook/react/issues/11726
-    it('should not focus on either server or client with autofocus={false} even if there is a markup mismatch', () => {
-      spyOnDev(console, 'error');
-
-      const element = document.createElement('div');
-      element.innerHTML = ReactDOMServer.renderToString(
-        <button autoFocus={false}>server</button>,
-      );
-      expect(element.firstChild.autofocus).toBe(false);
-
-      element.firstChild.focus = jest.fn();
-      ReactDOM.hydrate(<button autoFocus={false}>client</button>, element);
-
-      expect(element.firstChild.focus).not.toHaveBeenCalled();
-      if (__DEV__) {
-        expect(console.error.calls.count()).toBe(1);
-        expect(console.error.calls.argsFor(0)[0]).toBe(
-          'Warning: Text content did not match. Server: "server" Client: "client"',
-        );
-      }
-    });
-
     it('should throw with silly args', () => {
       expect(
         ReactDOMServer.renderToString.bind(ReactDOMServer, {x: 123}),
@@ -797,20 +557,7 @@ describe('ReactDOMServer', () => {
     }
   });
 
-  it('should throw rendering portals on the server', () => {
-    const div = document.createElement('div');
-    expect(() => {
-      ReactDOMServer.renderToString(
-        <div>{ReactDOM.createPortal(<div />, div)}</div>,
-      );
-    }).toThrow(
-      'Portals are not currently supported by the server renderer. ' +
-        'Render them conditionally so that they only appear on the client render.',
-    );
-  });
-
   it('should throw rendering call/return on the server', () => {
-    const div = document.createElement('div');
     expect(() => {
       ReactDOMServer.renderToString(
         <div>{ReactCallReturn.unstable_createReturn(42)}</div>,

commit 9f848f8ebec30b3aaa4844ecaef83b014359c5e3
Author: Brian Vaughn <brian.david.vaughn@gmail.com>
Date:   Wed Jan 3 13:55:37 2018 -0800

    Update additional tests to use .toWarnDev() matcher (#11957)
    
    * Migrated several additional tests to use new .toWarnDev() matcher
    
    * Migrated ReactDOMComponent-test to use .toWarnDev() matcher
    
    Note this test previous had some hacky logic to verify errors were reported against unique line numbers. Since the new matcher doesn't suppor this, I replaced this check with an equivalent (I think) comparison of unique DOM elements (eg div -> span)
    
    * Updated several additional tests to use the new .toWarnDev() matcher
    
    * Updated many more tests to use .toWarnDev()
    
    * Updated several additional tests to use .toWarnDev() matcher
    
    * Updated ReactElementValidator to distinguish between Array and Object in its warning. Also updated its test to use .toWarnDev() matcher.
    
    * Updated a couple of additional tests
    
    * Removed unused normalizeCodeLocInfo() methods

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index 642d950f22..cfba21e052 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -431,24 +431,17 @@ describe('ReactDOMServer', () => {
       }
     }
 
-    spyOnDev(console, 'error');
     ReactDOMServer.renderToString(<Foo />);
-    jest.runOnlyPendingTimers();
-    if (__DEV__) {
-      expect(console.error.calls.count()).toBe(1);
-      expect(console.error.calls.mostRecent().args[0]).toBe(
-        'Warning: setState(...): Can only update a mounting component.' +
-          ' This usually means you called setState() outside componentWillMount() on the server.' +
-          ' This is a no-op.\n\nPlease check the code for the Foo component.',
-      );
-    }
+    expect(() => jest.runOnlyPendingTimers()).toWarnDev(
+      'Warning: setState(...): Can only update a mounting component.' +
+        ' This usually means you called setState() outside componentWillMount() on the server.' +
+        ' This is a no-op.\n\nPlease check the code for the Foo component.',
+    );
 
     const markup = ReactDOMServer.renderToStaticMarkup(<Foo />);
     expect(markup).toBe('<div>hello</div>');
+    // No additional warnings are expected
     jest.runOnlyPendingTimers();
-    if (__DEV__) {
-      expect(console.error.calls.count()).toBe(1);
-    }
   });
 
   it('warns with a no-op when an async forceUpdate is triggered', () => {
@@ -465,23 +458,17 @@ describe('ReactDOMServer', () => {
       }
     }
 
-    spyOnDev(console, 'error');
     ReactDOMServer.renderToString(<Baz />);
-    jest.runOnlyPendingTimers();
-    if (__DEV__) {
-      expect(console.error.calls.count()).toBe(1);
-      expect(console.error.calls.mostRecent().args[0]).toBe(
-        'Warning: forceUpdate(...): Can only update a mounting component. ' +
-          'This usually means you called forceUpdate() outside componentWillMount() on the server. ' +
-          'This is a no-op.\n\nPlease check the code for the Baz component.',
-      );
-    }
+    expect(() => jest.runOnlyPendingTimers()).toWarnDev(
+      'Warning: forceUpdate(...): Can only update a mounting component. ' +
+        'This usually means you called forceUpdate() outside componentWillMount() on the server. ' +
+        'This is a no-op.\n\nPlease check the code for the Baz component.',
+    );
     const markup = ReactDOMServer.renderToStaticMarkup(<Baz />);
     expect(markup).toBe('<div></div>');
   });
 
   it('should throw (in dev) when children are mutated during render', () => {
-    spyOnDev(console, 'error');
     function Wrapper(props) {
       props.children[1] = <p key={1} />; // Mutation is illegal
       return <div>{props.children}</div>;
@@ -510,51 +497,43 @@ describe('ReactDOMServer', () => {
   });
 
   it('warns about lowercase html but not in svg tags', () => {
-    spyOnDev(console, 'error');
     function CompositeG(props) {
       // Make sure namespace passes through composites
       return <g>{props.children}</g>;
     }
-    ReactDOMServer.renderToStaticMarkup(
-      <div>
-        <inPUT />
-        <svg>
-          <CompositeG>
-            <linearGradient />
-            <foreignObject>
-              {/* back to HTML */}
-              <iFrame />
-            </foreignObject>
-          </CompositeG>
-        </svg>
-      </div>,
-    );
-    if (__DEV__) {
-      expect(console.error.calls.count()).toBe(2);
-      expect(console.error.calls.argsFor(0)[0]).toBe(
-        'Warning: <inPUT /> is using uppercase HTML. Always use lowercase ' +
-          'HTML tags in React.',
-      );
+    expect(() =>
+      ReactDOMServer.renderToStaticMarkup(
+        <div>
+          <inPUT />
+          <svg>
+            <CompositeG>
+              <linearGradient />
+              <foreignObject>
+                {/* back to HTML */}
+                <iFrame />
+              </foreignObject>
+            </CompositeG>
+          </svg>
+        </div>,
+      ),
+    ).toWarnDev([
+      'Warning: <inPUT /> is using uppercase HTML. Always use lowercase ' +
+        'HTML tags in React.',
       // linearGradient doesn't warn
-      expect(console.error.calls.argsFor(1)[0]).toBe(
-        'Warning: <iFrame /> is using uppercase HTML. Always use lowercase ' +
-          'HTML tags in React.',
-      );
-    }
+      'Warning: <iFrame /> is using uppercase HTML. Always use lowercase ' +
+        'HTML tags in React.',
+    ]);
   });
 
   it('should warn about contentEditable and children', () => {
-    spyOnDev(console, 'error');
-    ReactDOMServer.renderToString(<div contentEditable={true} children="" />);
-    if (__DEV__) {
-      expect(console.error.calls.count()).toBe(1);
-      expect(normalizeCodeLocInfo(console.error.calls.argsFor(0)[0])).toBe(
-        'Warning: A component is `contentEditable` and contains `children` ' +
-          'managed by React. It is now your responsibility to guarantee that ' +
-          'none of those nodes are unexpectedly modified or duplicated. This ' +
-          'is probably not intentional.\n    in div (at **)',
-      );
-    }
+    expect(() =>
+      ReactDOMServer.renderToString(<div contentEditable={true} children="" />),
+    ).toWarnDev(
+      'Warning: A component is `contentEditable` and contains `children` ' +
+        'managed by React. It is now your responsibility to guarantee that ' +
+        'none of those nodes are unexpectedly modified or duplicated. This ' +
+        'is probably not intentional.\n    in div (at **)',
+    );
   });
 
   it('should throw rendering call/return on the server', () => {

commit e6e393b9c5221bfb1a5ddcc7221c42e96ab3baca
Author: Neil Kistner <neil.kistner@gmail.com>
Date:   Tue Jan 9 10:24:49 2018 -0600

    Add warning in server renderer if class doesn't extend React.Component (#11993)
    
    * Add warning in server renderer if class doesn't extend React.Component
    
    In dev mode, while server rendering, a warning will be thrown if there is a class that doesn't extend React.Component.
    
    * Use `.toWarnDev` matcher and deduplicate warnings
    
    * Deduplicate client-side warning if class doesn't extend React.Component
    
    * Default componentName to Unknown if null

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index cfba21e052..cfc17f7e28 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -554,4 +554,27 @@ describe('ReactDOMServer', () => {
       'The experimental Call and Return types are not currently supported by the server renderer.',
     );
   });
+
+  it('should warn when server rendering a class with a render method that does not extend React.Component', () => {
+    class ClassWithRenderNotExtended {
+      render() {
+        return <div />;
+      }
+    }
+
+    expect(() => {
+      expect(() =>
+        ReactDOMServer.renderToString(<ClassWithRenderNotExtended />),
+      ).toWarnDev(
+        'Warning: The <ClassWithRenderNotExtended /> component appears to have a render method, ' +
+          "but doesn't extend React.Component. This is likely to cause errors. " +
+          'Change ClassWithRenderNotExtended to extend React.Component instead.',
+      );
+    }).toThrow(TypeError);
+
+    // Test deduplication
+    expect(() => {
+      ReactDOMServer.renderToString(<ClassWithRenderNotExtended />);
+    }).toThrow(TypeError);
+  });
 });

commit 97e2911508a2a7af6f50cf87ae503abe39842bef
Author: Brian Vaughn <brian.david.vaughn@gmail.com>
Date:   Fri Jan 19 09:36:46 2018 -0800

    RFC 6: Deprecate unsafe lifecycles (#12028)
    
    * Added unsafe_* lifecycles and deprecation warnings
    If the old lifecycle hooks (componentWillMount, componentWillUpdate, componentWillReceiveProps) are detected, these methods will be called and a deprecation warning will be logged. (In other words, we do not check for both the presence of the old and new lifecycles.) This commit is expected to fail tests.
    
    * Ran lifecycle hook codemod over project
    This should handle the bulk of the updates. I will manually update TypeScript and CoffeeScript tests with another commit.
    The actual command run with this commit was: jscodeshift --parser=flow -t ../react-codemod/transforms/rename-unsafe-lifecycles.js ./packages/**/src/**/*.js
    
    * Manually migrated CoffeeScript and TypeScript tests
    
    * Added inline note to createReactClassIntegration-test
    Explaining why lifecycles hooks have not been renamed in this test.
    
    * Udated NativeMethodsMixin with new lifecycle hooks
    
    * Added static getDerivedStateFromProps to ReactPartialRenderer
    Also added a new set of tests focused on server side lifecycle hooks.
    
    * Added getDerivedStateFromProps to shallow renderer
    Also added warnings for several cases involving getDerivedStateFromProps() as well as the deprecated lifecycles.
    Also added tests for the above.
    
    * Dedupe and DEV-only deprecation warning in server renderer
    
    * Renamed unsafe_* prefix to UNSAFE_* to be more noticeable
    
    * Added getDerivedStateFromProps to ReactFiberClassComponent
    Also updated class component and lifecyle tests to cover the added functionality.
    
    * Warn about UNSAFE_componentWillRecieveProps misspelling
    
    * Added tests to createReactClassIntegration for new lifecycles
    
    * Added warning for stateless functional components with gDSFP
    
    * Added createReactClass test for static gDSFP
    
    * Moved lifecycle deprecation warnings behind (disabled) feature flag
    
    Updated tests accordingly, by temporarily splitting tests that were specific to this feature-flag into their own, internal tests. This was the only way I knew of to interact with the feature flag without breaking our build/dist tests.
    
    * Tidying up
    
    * Tweaked warning message wording slightly
    Replaced 'You may may have returned undefined.' with 'You may have returned undefined.'
    
    * Replaced truthy partialState checks with != null
    
    * Call getDerivedStateFromProps via .call(null) to prevent type access
    
    * Move shallow-renderer didWarn* maps off the instance
    
    * Only call getDerivedStateFromProps if props instance has changed
    
    * Avoid creating new state object if not necessary
    
    * Inject state as a param to callGetDerivedStateFromProps
    This value will be either workInProgress.memoizedState (for updates) or instance.state (for initialization).
    
    * Explicitly warn about uninitialized state before calling getDerivedStateFromProps.
    And added some new tests for this change.
    
    Also:
    * Improved a couple of falsy null/undefined checks to more explicitly check for null or undefined.
    * Made some small tweaks to ReactFiberClassComponent WRT when and how it reads instance.state and sets to null.
    
    * Improved wording for deprecation lifecycle warnings
    
    * Fix state-regression for module-pattern components
    Also add support for new static getDerivedStateFromProps method

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index cfc17f7e28..f37fa2c15c 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -98,7 +98,7 @@ describe('ReactDOMServer', () => {
             this.state = {name: 'TestComponent'};
           }
 
-          componentWillMount() {
+          UNSAFE_componentWillMount() {
             lifecycle.push('componentWillMount');
           }
 
@@ -111,7 +111,7 @@ describe('ReactDOMServer', () => {
             return <span>Component name: {this.state.name}</span>;
           }
 
-          componentWillUpdate() {
+          UNSAFE_componentWillUpdate() {
             lifecycle.push('componentWillUpdate');
           }
 
@@ -123,7 +123,7 @@ describe('ReactDOMServer', () => {
             lifecycle.push('shouldComponentUpdate');
           }
 
-          componentWillReceiveProps() {
+          UNSAFE_componentWillReceiveProps() {
             lifecycle.push('componentWillReceiveProps');
           }
 
@@ -240,7 +240,7 @@ describe('ReactDOMServer', () => {
             this.state = {name: 'TestComponent'};
           }
 
-          componentWillMount() {
+          UNSAFE_componentWillMount() {
             lifecycle.push('componentWillMount');
           }
 
@@ -253,7 +253,7 @@ describe('ReactDOMServer', () => {
             return <span>Component name: {this.state.name}</span>;
           }
 
-          componentWillUpdate() {
+          UNSAFE_componentWillUpdate() {
             lifecycle.push('componentWillUpdate');
           }
 
@@ -265,7 +265,7 @@ describe('ReactDOMServer', () => {
             lifecycle.push('shouldComponentUpdate');
           }
 
-          componentWillReceiveProps() {
+          UNSAFE_componentWillReceiveProps() {
             lifecycle.push('componentWillReceiveProps');
           }
 
@@ -297,7 +297,7 @@ describe('ReactDOMServer', () => {
 
     it('allows setState in componentWillMount without using DOM', () => {
       class Component extends React.Component {
-        componentWillMount() {
+        UNSAFE_componentWillMount() {
           this.setState({text: 'hello, world'});
         }
 
@@ -316,7 +316,7 @@ describe('ReactDOMServer', () => {
           this.state = {text: 'default state'};
         }
 
-        componentWillMount() {
+        UNSAFE_componentWillMount() {
           this.setState({text: 'hello, world'});
         }
 
@@ -397,7 +397,7 @@ describe('ReactDOMServer', () => {
       }
 
       class Component extends React.Component {
-        componentWillMount() {
+        UNSAFE_componentWillMount() {
           this.setState({text: 'hello, world'});
         }
 
@@ -420,7 +420,7 @@ describe('ReactDOMServer', () => {
 
   it('warns with a no-op when an async setState is triggered', () => {
     class Foo extends React.Component {
-      componentWillMount() {
+      UNSAFE_componentWillMount() {
         this.setState({text: 'hello'});
         setTimeout(() => {
           this.setState({text: 'error'});
@@ -446,7 +446,7 @@ describe('ReactDOMServer', () => {
 
   it('warns with a no-op when an async forceUpdate is triggered', () => {
     class Baz extends React.Component {
-      componentWillMount() {
+      UNSAFE_componentWillMount() {
         this.forceUpdate();
         setTimeout(() => {
           this.forceUpdate();

commit 87ae211ccd8d61796cfdef138d1e12fb7a74f85d
Author: Andrew Clark <acdlite@me.com>
Date:   Wed Jan 24 19:36:22 2018 -0800

    New context API (#11818)
    
    * New context API
    
    Introduces a declarative context API that propagates updates even when
    shouldComponentUpdate returns false.
    
    * Fuzz tester for context
    
    * Use ReactElement for provider and consumer children
    
    * Unify more branches in createFiberFromElement
    
    * Compare context values using Object.is
    
    Same semantics as PureComponent/shallowEqual.
    
    * Add support for Provider and Consumer to server-side renderer
    
    * Store providers on global stack
    
    Rather than using a linked list stored on the context type. The global
    stack can be reset in case of an interruption or error, whereas with the
    linked list implementation, you'd need to keep track of every
    context type.
    
    * Put new context API behind a feature flag
    
    We'll enable this in www only for now.
    
    * Store nearest provider on context object
    
    * Handle reentrancy in server renderer
    
    Context stack should be per server renderer instance.
    
    * Bailout of consumer updates using bitmask
    
    The context type defines an optional function that compares two context
    values, returning a bitfield. A consumer may specify the bits it needs
    for rendering. If a provider's context changes, and the consumer's bits
    do not intersect with the changed bits, we can skip the consumer.
    
    This is similar to how selectors are used in Redux but fast enough to do
    while scanning the tree. The only user code involved is the function
    that computes the changed bits. But that's only called once per provider
    update, not for every consumer.
    
    * Store current value and changed bits on context object
    
    There are fewer providers than consumers, so better to do this work
    at the provider.
    
    * Use maximum of 31 bits for bitmask
    
    This is the largest integer size in V8 on 32-bit systems. Warn in
    development if too large a number is used.
    
    * ProviderComponent -> ContextProvider, ConsumerComponent -> ContextConsumer
    
    * Inline Object.is
    
    * Warn if multiple renderers concurrently render the same context provider
    
    Let's see if we can get away with not supporting this for now. If it
    turns out that it's needed, we can fall back to backtracking the
    fiber return path.
    
    * Nits that came up during review

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
deleted file mode 100644
index f37fa2c15c..0000000000
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ /dev/null
@@ -1,580 +0,0 @@
-/**
- * Copyright (c) 2013-present, Facebook, Inc.
- *
- * This source code is licensed under the MIT license found in the
- * LICENSE file in the root directory of this source tree.
- *
- * @emails react-core
- * @jest-environment node
- */
-
-'use strict';
-
-let React;
-let ReactCallReturn;
-let ReactDOMServer;
-let PropTypes;
-
-function normalizeCodeLocInfo(str) {
-  return str && str.replace(/\(at .+?:\d+\)/g, '(at **)');
-}
-
-describe('ReactDOMServer', () => {
-  beforeEach(() => {
-    jest.resetModules();
-    React = require('react');
-    ReactCallReturn = require('react-call-return');
-    PropTypes = require('prop-types');
-    ReactDOMServer = require('react-dom/server');
-  });
-
-  describe('renderToString', () => {
-    it('should generate simple markup', () => {
-      const response = ReactDOMServer.renderToString(<span>hello world</span>);
-      expect(response).toMatch(
-        new RegExp('<span data-reactroot=""' + '>hello world</span>'),
-      );
-    });
-
-    it('should generate simple markup for self-closing tags', () => {
-      const response = ReactDOMServer.renderToString(<img />);
-      expect(response).toMatch(new RegExp('<img data-reactroot=""' + '/>'));
-    });
-
-    it('should generate comment markup for component returns null', () => {
-      class NullComponent extends React.Component {
-        render() {
-          return null;
-        }
-      }
-
-      const response = ReactDOMServer.renderToString(<NullComponent />);
-      expect(response).toBe('');
-    });
-
-    // TODO: Test that listeners are not registered onto any document/container.
-
-    it('should render composite components', () => {
-      class Parent extends React.Component {
-        render() {
-          return (
-            <div>
-              <Child name="child" />
-            </div>
-          );
-        }
-      }
-
-      class Child extends React.Component {
-        render() {
-          return <span>My name is {this.props.name}</span>;
-        }
-      }
-
-      const response = ReactDOMServer.renderToString(<Parent />);
-      expect(response).toMatch(
-        new RegExp(
-          '<div ' +
-            'data-reactroot' +
-            '=""' +
-            '>' +
-            '<span' +
-            '>' +
-            'My name is <!-- -->child' +
-            '</span>' +
-            '</div>',
-        ),
-      );
-    });
-
-    it('should only execute certain lifecycle methods', () => {
-      function runTest() {
-        const lifecycle = [];
-
-        class TestComponent extends React.Component {
-          constructor(props) {
-            super(props);
-            lifecycle.push('getInitialState');
-            this.state = {name: 'TestComponent'};
-          }
-
-          UNSAFE_componentWillMount() {
-            lifecycle.push('componentWillMount');
-          }
-
-          componentDidMount() {
-            lifecycle.push('componentDidMount');
-          }
-
-          render() {
-            lifecycle.push('render');
-            return <span>Component name: {this.state.name}</span>;
-          }
-
-          UNSAFE_componentWillUpdate() {
-            lifecycle.push('componentWillUpdate');
-          }
-
-          componentDidUpdate() {
-            lifecycle.push('componentDidUpdate');
-          }
-
-          shouldComponentUpdate() {
-            lifecycle.push('shouldComponentUpdate');
-          }
-
-          UNSAFE_componentWillReceiveProps() {
-            lifecycle.push('componentWillReceiveProps');
-          }
-
-          componentWillUnmount() {
-            lifecycle.push('componentWillUnmount');
-          }
-        }
-
-        const response = ReactDOMServer.renderToString(<TestComponent />);
-
-        expect(response).toMatch(
-          new RegExp(
-            '<span ' +
-              'data-reactroot' +
-              '=""' +
-              '>' +
-              'Component name: <!-- -->TestComponent' +
-              '</span>',
-          ),
-        );
-        expect(lifecycle).toEqual([
-          'getInitialState',
-          'componentWillMount',
-          'render',
-        ]);
-      }
-
-      runTest();
-    });
-
-    it('should throw with silly args', () => {
-      expect(
-        ReactDOMServer.renderToString.bind(ReactDOMServer, {x: 123}),
-      ).toThrowError(
-        'Objects are not valid as a React child (found: object with keys {x})',
-      );
-    });
-
-    it('should throw prop mapping error for an <iframe /> with invalid props', () => {
-      let caughtErr;
-      try {
-        ReactDOMServer.renderToString(<iframe style="border:none;" />);
-      } catch (err) {
-        caughtErr = err;
-      }
-      expect(caughtErr).not.toBe(undefined);
-      expect(normalizeCodeLocInfo(caughtErr.message)).toContain(
-        'The `style` prop expects a mapping from style properties to values, not ' +
-          "a string. For example, style={{marginRight: spacing + 'em'}} when using JSX." +
-          (__DEV__ ? '\n    in iframe (at **)' : ''),
-      );
-    });
-  });
-
-  describe('renderToStaticMarkup', () => {
-    it('should not put checksum and React ID on components', () => {
-      class NestedComponent extends React.Component {
-        render() {
-          return <div>inner text</div>;
-        }
-      }
-
-      class TestComponent extends React.Component {
-        render() {
-          return (
-            <span>
-              <NestedComponent />
-            </span>
-          );
-        }
-      }
-
-      const response = ReactDOMServer.renderToStaticMarkup(<TestComponent />);
-
-      expect(response).toBe('<span><div>inner text</div></span>');
-    });
-
-    it('should not put checksum and React ID on text components', () => {
-      class TestComponent extends React.Component {
-        render() {
-          return (
-            <span>
-              {'hello'} {'world'}
-            </span>
-          );
-        }
-      }
-
-      const response = ReactDOMServer.renderToStaticMarkup(<TestComponent />);
-
-      expect(response).toBe('<span>hello world</span>');
-    });
-
-    it('should not use comments for empty nodes', () => {
-      class TestComponent extends React.Component {
-        render() {
-          return null;
-        }
-      }
-
-      const response = ReactDOMServer.renderToStaticMarkup(<TestComponent />);
-
-      expect(response).toBe('');
-    });
-
-    it('should only execute certain lifecycle methods', () => {
-      function runTest() {
-        const lifecycle = [];
-
-        class TestComponent extends React.Component {
-          constructor(props) {
-            super(props);
-            lifecycle.push('getInitialState');
-            this.state = {name: 'TestComponent'};
-          }
-
-          UNSAFE_componentWillMount() {
-            lifecycle.push('componentWillMount');
-          }
-
-          componentDidMount() {
-            lifecycle.push('componentDidMount');
-          }
-
-          render() {
-            lifecycle.push('render');
-            return <span>Component name: {this.state.name}</span>;
-          }
-
-          UNSAFE_componentWillUpdate() {
-            lifecycle.push('componentWillUpdate');
-          }
-
-          componentDidUpdate() {
-            lifecycle.push('componentDidUpdate');
-          }
-
-          shouldComponentUpdate() {
-            lifecycle.push('shouldComponentUpdate');
-          }
-
-          UNSAFE_componentWillReceiveProps() {
-            lifecycle.push('componentWillReceiveProps');
-          }
-
-          componentWillUnmount() {
-            lifecycle.push('componentWillUnmount');
-          }
-        }
-
-        const response = ReactDOMServer.renderToStaticMarkup(<TestComponent />);
-
-        expect(response).toBe('<span>Component name: TestComponent</span>');
-        expect(lifecycle).toEqual([
-          'getInitialState',
-          'componentWillMount',
-          'render',
-        ]);
-      }
-
-      runTest();
-    });
-
-    it('should throw with silly args', () => {
-      expect(
-        ReactDOMServer.renderToStaticMarkup.bind(ReactDOMServer, {x: 123}),
-      ).toThrowError(
-        'Objects are not valid as a React child (found: object with keys {x})',
-      );
-    });
-
-    it('allows setState in componentWillMount without using DOM', () => {
-      class Component extends React.Component {
-        UNSAFE_componentWillMount() {
-          this.setState({text: 'hello, world'});
-        }
-
-        render() {
-          return <div>{this.state.text}</div>;
-        }
-      }
-      const markup = ReactDOMServer.renderToString(<Component />);
-      expect(markup).toContain('hello, world');
-    });
-
-    it('allows setState in componentWillMount with custom constructor', () => {
-      class Component extends React.Component {
-        constructor() {
-          super();
-          this.state = {text: 'default state'};
-        }
-
-        UNSAFE_componentWillMount() {
-          this.setState({text: 'hello, world'});
-        }
-
-        render() {
-          return <div>{this.state.text}</div>;
-        }
-      }
-      const markup = ReactDOMServer.renderToString(<Component />);
-      expect(markup).toContain('hello, world');
-    });
-
-    it('renders with props when using custom constructor', () => {
-      class Component extends React.Component {
-        constructor() {
-          super();
-        }
-
-        render() {
-          return <div>{this.props.text}</div>;
-        }
-      }
-
-      const markup = ReactDOMServer.renderToString(
-        <Component text="hello, world" />,
-      );
-      expect(markup).toContain('hello, world');
-    });
-
-    it('renders with context when using custom constructor', () => {
-      class Component extends React.Component {
-        constructor() {
-          super();
-        }
-
-        render() {
-          return <div>{this.context.text}</div>;
-        }
-      }
-
-      Component.contextTypes = {
-        text: PropTypes.string.isRequired,
-      };
-
-      class ContextProvider extends React.Component {
-        getChildContext() {
-          return {
-            text: 'hello, world',
-          };
-        }
-
-        render() {
-          return this.props.children;
-        }
-      }
-
-      ContextProvider.childContextTypes = {
-        text: PropTypes.string,
-      };
-
-      const markup = ReactDOMServer.renderToString(
-        <ContextProvider>
-          <Component />
-        </ContextProvider>,
-      );
-      expect(markup).toContain('hello, world');
-    });
-
-    it('renders components with different batching strategies', () => {
-      class StaticComponent extends React.Component {
-        render() {
-          const staticContent = ReactDOMServer.renderToStaticMarkup(
-            <div>
-              <img src="foo-bar.jpg" />
-            </div>,
-          );
-          return <div dangerouslySetInnerHTML={{__html: staticContent}} />;
-        }
-      }
-
-      class Component extends React.Component {
-        UNSAFE_componentWillMount() {
-          this.setState({text: 'hello, world'});
-        }
-
-        render() {
-          return <div>{this.state.text}</div>;
-        }
-      }
-
-      expect(
-        ReactDOMServer.renderToString.bind(
-          ReactDOMServer,
-          <div>
-            <StaticComponent />
-            <Component />
-          </div>,
-        ),
-      ).not.toThrow();
-    });
-  });
-
-  it('warns with a no-op when an async setState is triggered', () => {
-    class Foo extends React.Component {
-      UNSAFE_componentWillMount() {
-        this.setState({text: 'hello'});
-        setTimeout(() => {
-          this.setState({text: 'error'});
-        });
-      }
-      render() {
-        return <div onClick={() => {}}>{this.state.text}</div>;
-      }
-    }
-
-    ReactDOMServer.renderToString(<Foo />);
-    expect(() => jest.runOnlyPendingTimers()).toWarnDev(
-      'Warning: setState(...): Can only update a mounting component.' +
-        ' This usually means you called setState() outside componentWillMount() on the server.' +
-        ' This is a no-op.\n\nPlease check the code for the Foo component.',
-    );
-
-    const markup = ReactDOMServer.renderToStaticMarkup(<Foo />);
-    expect(markup).toBe('<div>hello</div>');
-    // No additional warnings are expected
-    jest.runOnlyPendingTimers();
-  });
-
-  it('warns with a no-op when an async forceUpdate is triggered', () => {
-    class Baz extends React.Component {
-      UNSAFE_componentWillMount() {
-        this.forceUpdate();
-        setTimeout(() => {
-          this.forceUpdate();
-        });
-      }
-
-      render() {
-        return <div onClick={() => {}} />;
-      }
-    }
-
-    ReactDOMServer.renderToString(<Baz />);
-    expect(() => jest.runOnlyPendingTimers()).toWarnDev(
-      'Warning: forceUpdate(...): Can only update a mounting component. ' +
-        'This usually means you called forceUpdate() outside componentWillMount() on the server. ' +
-        'This is a no-op.\n\nPlease check the code for the Baz component.',
-    );
-    const markup = ReactDOMServer.renderToStaticMarkup(<Baz />);
-    expect(markup).toBe('<div></div>');
-  });
-
-  it('should throw (in dev) when children are mutated during render', () => {
-    function Wrapper(props) {
-      props.children[1] = <p key={1} />; // Mutation is illegal
-      return <div>{props.children}</div>;
-    }
-    if (__DEV__) {
-      expect(() => {
-        ReactDOMServer.renderToStaticMarkup(
-          <Wrapper>
-            <span key={0} />
-            <span key={1} />
-            <span key={2} />
-          </Wrapper>,
-        );
-      }).toThrowError(/Cannot assign to read only property.*/);
-    } else {
-      expect(
-        ReactDOMServer.renderToStaticMarkup(
-          <Wrapper>
-            <span key={0} />
-            <span key={1} />
-            <span key={2} />
-          </Wrapper>,
-        ),
-      ).toContain('<p>');
-    }
-  });
-
-  it('warns about lowercase html but not in svg tags', () => {
-    function CompositeG(props) {
-      // Make sure namespace passes through composites
-      return <g>{props.children}</g>;
-    }
-    expect(() =>
-      ReactDOMServer.renderToStaticMarkup(
-        <div>
-          <inPUT />
-          <svg>
-            <CompositeG>
-              <linearGradient />
-              <foreignObject>
-                {/* back to HTML */}
-                <iFrame />
-              </foreignObject>
-            </CompositeG>
-          </svg>
-        </div>,
-      ),
-    ).toWarnDev([
-      'Warning: <inPUT /> is using uppercase HTML. Always use lowercase ' +
-        'HTML tags in React.',
-      // linearGradient doesn't warn
-      'Warning: <iFrame /> is using uppercase HTML. Always use lowercase ' +
-        'HTML tags in React.',
-    ]);
-  });
-
-  it('should warn about contentEditable and children', () => {
-    expect(() =>
-      ReactDOMServer.renderToString(<div contentEditable={true} children="" />),
-    ).toWarnDev(
-      'Warning: A component is `contentEditable` and contains `children` ' +
-        'managed by React. It is now your responsibility to guarantee that ' +
-        'none of those nodes are unexpectedly modified or duplicated. This ' +
-        'is probably not intentional.\n    in div (at **)',
-    );
-  });
-
-  it('should throw rendering call/return on the server', () => {
-    expect(() => {
-      ReactDOMServer.renderToString(
-        <div>{ReactCallReturn.unstable_createReturn(42)}</div>,
-      );
-    }).toThrow(
-      'The experimental Call and Return types are not currently supported by the server renderer.',
-    );
-    expect(() => {
-      ReactDOMServer.renderToString(
-        <div>
-          {ReactCallReturn.unstable_createCall(null, function() {}, {})}
-        </div>,
-      );
-    }).toThrow(
-      'The experimental Call and Return types are not currently supported by the server renderer.',
-    );
-  });
-
-  it('should warn when server rendering a class with a render method that does not extend React.Component', () => {
-    class ClassWithRenderNotExtended {
-      render() {
-        return <div />;
-      }
-    }
-
-    expect(() => {
-      expect(() =>
-        ReactDOMServer.renderToString(<ClassWithRenderNotExtended />),
-      ).toWarnDev(
-        'Warning: The <ClassWithRenderNotExtended /> component appears to have a render method, ' +
-          "but doesn't extend React.Component. This is likely to cause errors. " +
-          'Change ClassWithRenderNotExtended to extend React.Component instead.',
-      );
-    }).toThrow(TypeError);
-
-    // Test deduplication
-    expect(() => {
-      ReactDOMServer.renderToString(<ClassWithRenderNotExtended />);
-    }).toThrow(TypeError);
-  });
-});

commit f5779bbc10ce85ac78fb54c9f20e71b5e32bb393
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Thu Jul 5 19:42:22 2018 +0100

    Run server rendering test on bundles (#13153)

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
new file mode 100644
index 0000000000..b7c6eca3de
--- /dev/null
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -0,0 +1,646 @@
+/**
+ * Copyright (c) 2013-present, Facebook, Inc.
+ *
+ * This source code is licensed under the MIT license found in the
+ * LICENSE file in the root directory of this source tree.
+ *
+ * @emails react-core
+ * @jest-environment node
+ */
+
+'use strict';
+
+let React;
+let ReactDOMServer;
+let PropTypes;
+
+function normalizeCodeLocInfo(str) {
+  return str && str.replace(/\(at .+?:\d+\)/g, '(at **)');
+}
+
+describe('ReactDOMServer', () => {
+  beforeEach(() => {
+    jest.resetModules();
+    React = require('react');
+    PropTypes = require('prop-types');
+    ReactDOMServer = require('react-dom/server');
+  });
+
+  describe('renderToString', () => {
+    it('should generate simple markup', () => {
+      const response = ReactDOMServer.renderToString(<span>hello world</span>);
+      expect(response).toMatch(
+        new RegExp('<span data-reactroot=""' + '>hello world</span>'),
+      );
+    });
+
+    it('should generate simple markup for self-closing tags', () => {
+      const response = ReactDOMServer.renderToString(<img />);
+      expect(response).toMatch(new RegExp('<img data-reactroot=""' + '/>'));
+    });
+
+    it('should generate comment markup for component returns null', () => {
+      class NullComponent extends React.Component {
+        render() {
+          return null;
+        }
+      }
+
+      const response = ReactDOMServer.renderToString(<NullComponent />);
+      expect(response).toBe('');
+    });
+
+    // TODO: Test that listeners are not registered onto any document/container.
+
+    it('should render composite components', () => {
+      class Parent extends React.Component {
+        render() {
+          return (
+            <div>
+              <Child name="child" />
+            </div>
+          );
+        }
+      }
+
+      class Child extends React.Component {
+        render() {
+          return <span>My name is {this.props.name}</span>;
+        }
+      }
+
+      const response = ReactDOMServer.renderToString(<Parent />);
+      expect(response).toMatch(
+        new RegExp(
+          '<div ' +
+            'data-reactroot' +
+            '=""' +
+            '>' +
+            '<span' +
+            '>' +
+            'My name is <!-- -->child' +
+            '</span>' +
+            '</div>',
+        ),
+      );
+    });
+
+    it('should only execute certain lifecycle methods', () => {
+      function runTest() {
+        const lifecycle = [];
+
+        class TestComponent extends React.Component {
+          constructor(props) {
+            super(props);
+            lifecycle.push('getInitialState');
+            this.state = {name: 'TestComponent'};
+          }
+
+          UNSAFE_componentWillMount() {
+            lifecycle.push('componentWillMount');
+          }
+
+          componentDidMount() {
+            lifecycle.push('componentDidMount');
+          }
+
+          render() {
+            lifecycle.push('render');
+            return <span>Component name: {this.state.name}</span>;
+          }
+
+          UNSAFE_componentWillUpdate() {
+            lifecycle.push('componentWillUpdate');
+          }
+
+          componentDidUpdate() {
+            lifecycle.push('componentDidUpdate');
+          }
+
+          shouldComponentUpdate() {
+            lifecycle.push('shouldComponentUpdate');
+          }
+
+          UNSAFE_componentWillReceiveProps() {
+            lifecycle.push('componentWillReceiveProps');
+          }
+
+          componentWillUnmount() {
+            lifecycle.push('componentWillUnmount');
+          }
+        }
+
+        const response = ReactDOMServer.renderToString(<TestComponent />);
+
+        expect(response).toMatch(
+          new RegExp(
+            '<span ' +
+              'data-reactroot' +
+              '=""' +
+              '>' +
+              'Component name: <!-- -->TestComponent' +
+              '</span>',
+          ),
+        );
+        expect(lifecycle).toEqual([
+          'getInitialState',
+          'componentWillMount',
+          'render',
+        ]);
+      }
+
+      runTest();
+    });
+
+    it('should throw with silly args', () => {
+      expect(
+        ReactDOMServer.renderToString.bind(ReactDOMServer, {x: 123}),
+      ).toThrowError(
+        'Objects are not valid as a React child (found: object with keys {x})',
+      );
+    });
+
+    it('should throw prop mapping error for an <iframe /> with invalid props', () => {
+      let caughtErr;
+      try {
+        ReactDOMServer.renderToString(<iframe style="border:none;" />);
+      } catch (err) {
+        caughtErr = err;
+      }
+      expect(caughtErr).not.toBe(undefined);
+      expect(normalizeCodeLocInfo(caughtErr.message)).toContain(
+        'The `style` prop expects a mapping from style properties to values, not ' +
+          "a string. For example, style={{marginRight: spacing + 'em'}} when using JSX." +
+          (__DEV__ ? '\n    in iframe (at **)' : ''),
+      );
+    });
+  });
+
+  describe('renderToStaticMarkup', () => {
+    it('should not put checksum and React ID on components', () => {
+      class NestedComponent extends React.Component {
+        render() {
+          return <div>inner text</div>;
+        }
+      }
+
+      class TestComponent extends React.Component {
+        render() {
+          return (
+            <span>
+              <NestedComponent />
+            </span>
+          );
+        }
+      }
+
+      const response = ReactDOMServer.renderToStaticMarkup(<TestComponent />);
+
+      expect(response).toBe('<span><div>inner text</div></span>');
+    });
+
+    it('should not put checksum and React ID on text components', () => {
+      class TestComponent extends React.Component {
+        render() {
+          return (
+            <span>
+              {'hello'} {'world'}
+            </span>
+          );
+        }
+      }
+
+      const response = ReactDOMServer.renderToStaticMarkup(<TestComponent />);
+
+      expect(response).toBe('<span>hello world</span>');
+    });
+
+    it('should not use comments for empty nodes', () => {
+      class TestComponent extends React.Component {
+        render() {
+          return null;
+        }
+      }
+
+      const response = ReactDOMServer.renderToStaticMarkup(<TestComponent />);
+
+      expect(response).toBe('');
+    });
+
+    it('should only execute certain lifecycle methods', () => {
+      function runTest() {
+        const lifecycle = [];
+
+        class TestComponent extends React.Component {
+          constructor(props) {
+            super(props);
+            lifecycle.push('getInitialState');
+            this.state = {name: 'TestComponent'};
+          }
+
+          UNSAFE_componentWillMount() {
+            lifecycle.push('componentWillMount');
+          }
+
+          componentDidMount() {
+            lifecycle.push('componentDidMount');
+          }
+
+          render() {
+            lifecycle.push('render');
+            return <span>Component name: {this.state.name}</span>;
+          }
+
+          UNSAFE_componentWillUpdate() {
+            lifecycle.push('componentWillUpdate');
+          }
+
+          componentDidUpdate() {
+            lifecycle.push('componentDidUpdate');
+          }
+
+          shouldComponentUpdate() {
+            lifecycle.push('shouldComponentUpdate');
+          }
+
+          UNSAFE_componentWillReceiveProps() {
+            lifecycle.push('componentWillReceiveProps');
+          }
+
+          componentWillUnmount() {
+            lifecycle.push('componentWillUnmount');
+          }
+        }
+
+        const response = ReactDOMServer.renderToStaticMarkup(<TestComponent />);
+
+        expect(response).toBe('<span>Component name: TestComponent</span>');
+        expect(lifecycle).toEqual([
+          'getInitialState',
+          'componentWillMount',
+          'render',
+        ]);
+      }
+
+      runTest();
+    });
+
+    it('should throw with silly args', () => {
+      expect(
+        ReactDOMServer.renderToStaticMarkup.bind(ReactDOMServer, {x: 123}),
+      ).toThrowError(
+        'Objects are not valid as a React child (found: object with keys {x})',
+      );
+    });
+
+    it('allows setState in componentWillMount without using DOM', () => {
+      class Component extends React.Component {
+        UNSAFE_componentWillMount() {
+          this.setState({text: 'hello, world'});
+        }
+
+        render() {
+          return <div>{this.state.text}</div>;
+        }
+      }
+      const markup = ReactDOMServer.renderToString(<Component />);
+      expect(markup).toContain('hello, world');
+    });
+
+    it('allows setState in componentWillMount with custom constructor', () => {
+      class Component extends React.Component {
+        constructor() {
+          super();
+          this.state = {text: 'default state'};
+        }
+
+        UNSAFE_componentWillMount() {
+          this.setState({text: 'hello, world'});
+        }
+
+        render() {
+          return <div>{this.state.text}</div>;
+        }
+      }
+      const markup = ReactDOMServer.renderToString(<Component />);
+      expect(markup).toContain('hello, world');
+    });
+
+    it('renders with props when using custom constructor', () => {
+      class Component extends React.Component {
+        constructor() {
+          super();
+        }
+
+        render() {
+          return <div>{this.props.text}</div>;
+        }
+      }
+
+      const markup = ReactDOMServer.renderToString(
+        <Component text="hello, world" />,
+      );
+      expect(markup).toContain('hello, world');
+    });
+
+    it('renders with context when using custom constructor', () => {
+      class Component extends React.Component {
+        constructor() {
+          super();
+        }
+
+        render() {
+          return <div>{this.context.text}</div>;
+        }
+      }
+
+      Component.contextTypes = {
+        text: PropTypes.string.isRequired,
+      };
+
+      class ContextProvider extends React.Component {
+        getChildContext() {
+          return {
+            text: 'hello, world',
+          };
+        }
+
+        render() {
+          return this.props.children;
+        }
+      }
+
+      ContextProvider.childContextTypes = {
+        text: PropTypes.string,
+      };
+
+      const markup = ReactDOMServer.renderToString(
+        <ContextProvider>
+          <Component />
+        </ContextProvider>,
+      );
+      expect(markup).toContain('hello, world');
+    });
+
+    it('renders with new context API', () => {
+      const Context = React.createContext(0);
+
+      function Consumer(props) {
+        return (
+          <Context.Consumer>{value => 'Result: ' + value}</Context.Consumer>
+        );
+      }
+
+      const Indirection = React.Fragment;
+
+      function App(props) {
+        return (
+          <Context.Provider value={props.value}>
+            <Context.Provider value={2}>
+              <Consumer />
+            </Context.Provider>
+            <Indirection>
+              <Indirection>
+                <Consumer />
+                <Context.Provider value={3}>
+                  <Consumer />
+                </Context.Provider>
+              </Indirection>
+            </Indirection>
+            <Consumer />
+          </Context.Provider>
+        );
+      }
+
+      const markup = ReactDOMServer.renderToString(<App value={1} />);
+      // Extract the numbers rendered by the consumers
+      const results = markup.match(/\d+/g).map(Number);
+      expect(results).toEqual([2, 1, 3, 1]);
+    });
+
+    it('renders context API, reentrancy', () => {
+      const Context = React.createContext(0);
+
+      function Consumer(props) {
+        return (
+          <Context.Consumer>{value => 'Result: ' + value}</Context.Consumer>
+        );
+      }
+
+      let reentrantMarkup;
+      function Reentrant() {
+        reentrantMarkup = ReactDOMServer.renderToString(
+          <App value={1} reentrant={false} />,
+        );
+        return null;
+      }
+
+      const Indirection = React.Fragment;
+
+      function App(props) {
+        return (
+          <Context.Provider value={props.value}>
+            {props.reentrant && <Reentrant />}
+            <Context.Provider value={2}>
+              <Consumer />
+            </Context.Provider>
+            <Indirection>
+              <Indirection>
+                <Consumer />
+                <Context.Provider value={3}>
+                  <Consumer />
+                </Context.Provider>
+              </Indirection>
+            </Indirection>
+            <Consumer />
+          </Context.Provider>
+        );
+      }
+
+      const markup = ReactDOMServer.renderToString(
+        <App value={1} reentrant={true} />,
+      );
+      // Extract the numbers rendered by the consumers
+      const results = markup.match(/\d+/g).map(Number);
+      const reentrantResults = reentrantMarkup.match(/\d+/g).map(Number);
+      expect(results).toEqual([2, 1, 3, 1]);
+      expect(reentrantResults).toEqual([2, 1, 3, 1]);
+    });
+
+    it('renders components with different batching strategies', () => {
+      class StaticComponent extends React.Component {
+        render() {
+          const staticContent = ReactDOMServer.renderToStaticMarkup(
+            <div>
+              <img src="foo-bar.jpg" />
+            </div>,
+          );
+          return <div dangerouslySetInnerHTML={{__html: staticContent}} />;
+        }
+      }
+
+      class Component extends React.Component {
+        UNSAFE_componentWillMount() {
+          this.setState({text: 'hello, world'});
+        }
+
+        render() {
+          return <div>{this.state.text}</div>;
+        }
+      }
+
+      expect(
+        ReactDOMServer.renderToString.bind(
+          ReactDOMServer,
+          <div>
+            <StaticComponent />
+            <Component />
+          </div>,
+        ),
+      ).not.toThrow();
+    });
+  });
+
+  it('warns with a no-op when an async setState is triggered', () => {
+    class Foo extends React.Component {
+      UNSAFE_componentWillMount() {
+        this.setState({text: 'hello'});
+        setTimeout(() => {
+          this.setState({text: 'error'});
+        });
+      }
+      render() {
+        return <div onClick={() => {}}>{this.state.text}</div>;
+      }
+    }
+
+    ReactDOMServer.renderToString(<Foo />);
+    expect(() => jest.runOnlyPendingTimers()).toWarnDev(
+      'Warning: setState(...): Can only update a mounting component.' +
+        ' This usually means you called setState() outside componentWillMount() on the server.' +
+        ' This is a no-op.\n\nPlease check the code for the Foo component.',
+    );
+
+    const markup = ReactDOMServer.renderToStaticMarkup(<Foo />);
+    expect(markup).toBe('<div>hello</div>');
+    // No additional warnings are expected
+    jest.runOnlyPendingTimers();
+  });
+
+  it('warns with a no-op when an async forceUpdate is triggered', () => {
+    class Baz extends React.Component {
+      UNSAFE_componentWillMount() {
+        this.forceUpdate();
+        setTimeout(() => {
+          this.forceUpdate();
+        });
+      }
+
+      render() {
+        return <div onClick={() => {}} />;
+      }
+    }
+
+    ReactDOMServer.renderToString(<Baz />);
+    expect(() => jest.runOnlyPendingTimers()).toWarnDev(
+      'Warning: forceUpdate(...): Can only update a mounting component. ' +
+        'This usually means you called forceUpdate() outside componentWillMount() on the server. ' +
+        'This is a no-op.\n\nPlease check the code for the Baz component.',
+    );
+    const markup = ReactDOMServer.renderToStaticMarkup(<Baz />);
+    expect(markup).toBe('<div></div>');
+  });
+
+  it('should throw (in dev) when children are mutated during render', () => {
+    function Wrapper(props) {
+      props.children[1] = <p key={1} />; // Mutation is illegal
+      return <div>{props.children}</div>;
+    }
+    if (__DEV__) {
+      expect(() => {
+        ReactDOMServer.renderToStaticMarkup(
+          <Wrapper>
+            <span key={0} />
+            <span key={1} />
+            <span key={2} />
+          </Wrapper>,
+        );
+      }).toThrowError(/Cannot assign to read only property.*/);
+    } else {
+      expect(
+        ReactDOMServer.renderToStaticMarkup(
+          <Wrapper>
+            <span key={0} />
+            <span key={1} />
+            <span key={2} />
+          </Wrapper>,
+        ),
+      ).toContain('<p>');
+    }
+  });
+
+  it('warns about lowercase html but not in svg tags', () => {
+    function CompositeG(props) {
+      // Make sure namespace passes through composites
+      return <g>{props.children}</g>;
+    }
+    expect(() =>
+      ReactDOMServer.renderToStaticMarkup(
+        <div>
+          <inPUT />
+          <svg>
+            <CompositeG>
+              <linearGradient />
+              <foreignObject>
+                {/* back to HTML */}
+                <iFrame />
+              </foreignObject>
+            </CompositeG>
+          </svg>
+        </div>,
+      ),
+    ).toWarnDev([
+      'Warning: <inPUT /> is using incorrect casing. ' +
+        'Use PascalCase for React components, ' +
+        'or lowercase for HTML elements.',
+      // linearGradient doesn't warn
+      'Warning: <iFrame /> is using incorrect casing. ' +
+        'Use PascalCase for React components, ' +
+        'or lowercase for HTML elements.',
+    ]);
+  });
+
+  it('should warn about contentEditable and children', () => {
+    expect(() =>
+      ReactDOMServer.renderToString(<div contentEditable={true} children="" />),
+    ).toWarnDev(
+      'Warning: A component is `contentEditable` and contains `children` ' +
+        'managed by React. It is now your responsibility to guarantee that ' +
+        'none of those nodes are unexpectedly modified or duplicated. This ' +
+        'is probably not intentional.\n    in div (at **)',
+    );
+  });
+
+  it('should warn when server rendering a class with a render method that does not extend React.Component', () => {
+    class ClassWithRenderNotExtended {
+      render() {
+        return <div />;
+      }
+    }
+
+    expect(() => {
+      expect(() =>
+        ReactDOMServer.renderToString(<ClassWithRenderNotExtended />),
+      ).toWarnDev(
+        'Warning: The <ClassWithRenderNotExtended /> component appears to have a render method, ' +
+          "but doesn't extend React.Component. This is likely to cause errors. " +
+          'Change ClassWithRenderNotExtended to extend React.Component instead.',
+      );
+    }).toThrow(TypeError);
+
+    // Test deduplication
+    expect(() => {
+      ReactDOMServer.renderToString(<ClassWithRenderNotExtended />);
+    }).toThrow(TypeError);
+  });
+});

commit f762b3abb1d951b366f3c8a2354aeedb7fbc32ff
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Fri Jul 6 16:43:43 2018 +0100

    Run react-dom SSR import test in jsdom-less environment (#13157)

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index b7c6eca3de..a07a842b33 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -643,4 +643,25 @@ describe('ReactDOMServer', () => {
       ReactDOMServer.renderToString(<ClassWithRenderNotExtended />);
     }).toThrow(TypeError);
   });
+
+  // We're just testing importing, not using it.
+  // It is important because even isomorphic components may import it.
+  it('can import react-dom in Node environment', () => {
+    if (
+      typeof requestAnimationFrame !== 'undefined' ||
+      global.hasOwnProperty('requestAnimationFrame') ||
+      typeof requestIdleCallback !== 'undefined' ||
+      global.hasOwnProperty('requestIdleCallback') ||
+      typeof window !== 'undefined' ||
+      global.hasOwnProperty('window')
+    ) {
+      // Don't remove this. This test is specifically checking
+      // what happens when they *don't* exist. It's useless otherwise.
+      throw new Error('Expected this test to run in a Node environment.');
+    }
+    jest.resetModules();
+    expect(() => {
+      require('react-dom');
+    }).not.toThrow();
+  });
 });

commit 377e1a049e03cbbf78a63ecadf31c3460602fe06
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Mon Jul 9 14:41:48 2018 +0100

    Add a test for SSR stack traces (#13180)

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index a07a842b33..6524b06671 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -664,4 +664,60 @@ describe('ReactDOMServer', () => {
       require('react-dom');
     }).not.toThrow();
   });
+
+  it('includes a useful stack in warnings', () => {
+    function A() {
+      return null;
+    }
+
+    function B() {
+      return (
+        <font>
+          <C>
+            <span ariaTypo="no" />
+          </C>
+        </font>
+      );
+    }
+
+    class C extends React.Component {
+      render() {
+        return <b>{this.props.children}</b>;
+      }
+    }
+
+    function Child() {
+      return [<A key="1" />, <B key="2" />, <span ariaTypo2="no" />];
+    }
+
+    function App() {
+      return (
+        <div>
+          <section />
+          <span>
+            <Child />
+          </span>
+        </div>
+      );
+    }
+
+    expect(() => ReactDOMServer.renderToString(<App />)).toWarnDev([
+      'Invalid ARIA attribute `ariaTypo`. ARIA attributes follow the pattern aria-* and must be lowercase.\n' +
+        '    in span (at **)\n' +
+        '    in b (at **)\n' +
+        '    in C (at **)\n' +
+        '    in font (at **)\n' +
+        '    in B (at **)\n' +
+        '    in Child (at **)\n' +
+        '    in span (at **)\n' +
+        '    in div (at **)\n' +
+        '    in App (at **)',
+      'Invalid ARIA attribute `ariaTypo2`. ARIA attributes follow the pattern aria-* and must be lowercase.\n' +
+        '    in span (at **)\n' +
+        '    in Child (at **)\n' +
+        '    in span (at **)\n' +
+        '    in div (at **)\n' +
+        '    in App (at **)',
+    ]);
+  });
 });

commit 6ebc8f3c07d8aadea127532fd33637cb091a9e66
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Wed Jul 11 19:43:54 2018 +0100

    Add support for re-entrant SSR stacks (#13181)
    
    * Add failing tests
    
    * Fix re-entrancy in ReactDOMServer

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index 6524b06671..a859e0c8f1 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -720,4 +720,61 @@ describe('ReactDOMServer', () => {
         '    in App (at **)',
     ]);
   });
+
+  it('reports stacks with re-entrant renderToString() calls', () => {
+    function Child2(props) {
+      return <span ariaTypo3="no">{props.children}</span>;
+    }
+
+    function App2() {
+      return (
+        <Child2>
+          {ReactDOMServer.renderToString(<blink ariaTypo2="no" />)}
+        </Child2>
+      );
+    }
+
+    function Child() {
+      return (
+        <span ariaTypo4="no">{ReactDOMServer.renderToString(<App2 />)}</span>
+      );
+    }
+
+    function App() {
+      return (
+        <div>
+          <span ariaTypo="no" />
+          <Child />
+          <font ariaTypo5="no" />
+        </div>
+      );
+    }
+
+    expect(() => ReactDOMServer.renderToString(<App />)).toWarnDev([
+      // ReactDOMServer(App > div > span)
+      'Invalid ARIA attribute `ariaTypo`. ARIA attributes follow the pattern aria-* and must be lowercase.\n' +
+        '    in span (at **)\n' +
+        '    in div (at **)\n' +
+        '    in App (at **)',
+      // ReactDOMServer(App > div > Child) >>> ReactDOMServer(App2) >>> ReactDOMServer(blink)
+      'Invalid ARIA attribute `ariaTypo2`. ARIA attributes follow the pattern aria-* and must be lowercase.\n' +
+        '    in blink (at **)',
+      // ReactDOMServer(App > div > Child) >>> ReactDOMServer(App2 > Child2 > span)
+      'Invalid ARIA attribute `ariaTypo3`. ARIA attributes follow the pattern aria-* and must be lowercase.\n' +
+        '    in span (at **)\n' +
+        '    in Child2 (at **)\n' +
+        '    in App2 (at **)',
+      // ReactDOMServer(App > div > Child > span)
+      'Invalid ARIA attribute `ariaTypo4`. ARIA attributes follow the pattern aria-* and must be lowercase.\n' +
+        '    in span (at **)\n' +
+        '    in Child (at **)\n' +
+        '    in div (at **)\n' +
+        '    in App (at **)',
+      // ReactDOMServer(App > div > font)
+      'Invalid ARIA attribute `ariaTypo5`. ARIA attributes follow the pattern aria-* and must be lowercase.\n' +
+        '    in font (at **)\n' +
+        '    in div (at **)\n' +
+        '    in App (at **)',
+    ]);
+  });
 });

commit 467d1391016dd2df8e1946aa33c6d6e1219c9dbb
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Mon Jul 16 20:20:18 2018 +0100

    Enforce presence or absence of component stack in tests (#13215)
    
    * Enforce presence or absence of stack in tests
    
    * Rename expectNoStack to withoutStack
    
    * Fix lint
    
    * Add some tests for toWarnDev()

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index a859e0c8f1..e3b05d7328 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -519,6 +519,7 @@ describe('ReactDOMServer', () => {
       'Warning: setState(...): Can only update a mounting component.' +
         ' This usually means you called setState() outside componentWillMount() on the server.' +
         ' This is a no-op.\n\nPlease check the code for the Foo component.',
+      {withoutStack: true},
     );
 
     const markup = ReactDOMServer.renderToStaticMarkup(<Foo />);
@@ -546,6 +547,7 @@ describe('ReactDOMServer', () => {
       'Warning: forceUpdate(...): Can only update a mounting component. ' +
         'This usually means you called forceUpdate() outside componentWillMount() on the server. ' +
         'This is a no-op.\n\nPlease check the code for the Baz component.',
+      {withoutStack: true},
     );
     const markup = ReactDOMServer.renderToStaticMarkup(<Baz />);
     expect(markup).toBe('<div></div>');
@@ -599,15 +601,18 @@ describe('ReactDOMServer', () => {
           </svg>
         </div>,
       ),
-    ).toWarnDev([
-      'Warning: <inPUT /> is using incorrect casing. ' +
-        'Use PascalCase for React components, ' +
-        'or lowercase for HTML elements.',
-      // linearGradient doesn't warn
-      'Warning: <iFrame /> is using incorrect casing. ' +
-        'Use PascalCase for React components, ' +
-        'or lowercase for HTML elements.',
-    ]);
+    ).toWarnDev(
+      [
+        'Warning: <inPUT /> is using incorrect casing. ' +
+          'Use PascalCase for React components, ' +
+          'or lowercase for HTML elements.',
+        // linearGradient doesn't warn
+        'Warning: <iFrame /> is using incorrect casing. ' +
+          'Use PascalCase for React components, ' +
+          'or lowercase for HTML elements.',
+      ],
+      {withoutStack: true},
+    );
   });
 
   it('should warn about contentEditable and children', () => {

commit 82c7ca4cca90976cd1230e03ea1a4372a4276e67
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Tue Jul 17 20:15:03 2018 +0100

    Add component stacks to some warnings (#13218)

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index e3b05d7328..9c6c8c29ee 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -601,18 +601,15 @@ describe('ReactDOMServer', () => {
           </svg>
         </div>,
       ),
-    ).toWarnDev(
-      [
-        'Warning: <inPUT /> is using incorrect casing. ' +
-          'Use PascalCase for React components, ' +
-          'or lowercase for HTML elements.',
-        // linearGradient doesn't warn
-        'Warning: <iFrame /> is using incorrect casing. ' +
-          'Use PascalCase for React components, ' +
-          'or lowercase for HTML elements.',
-      ],
-      {withoutStack: true},
-    );
+    ).toWarnDev([
+      'Warning: <inPUT /> is using incorrect casing. ' +
+        'Use PascalCase for React components, ' +
+        'or lowercase for HTML elements.',
+      // linearGradient doesn't warn
+      'Warning: <iFrame /> is using incorrect casing. ' +
+        'Use PascalCase for React components, ' +
+        'or lowercase for HTML elements.',
+    ]);
   });
 
   it('should warn about contentEditable and children', () => {

commit f60a7f722cfd0083ca43387798dde7cd95b2fe26
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Wed Aug 1 20:23:19 2018 +0100

    Fix SSR crash on a hasOwnProperty attribute (#13303)

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index 9c6c8c29ee..0e605f8c6e 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -174,6 +174,19 @@ describe('ReactDOMServer', () => {
           (__DEV__ ? '\n    in iframe (at **)' : ''),
       );
     });
+
+    it('should not crash on poisoned hasOwnProperty', () => {
+      let html;
+      expect(
+        () =>
+          (html = ReactDOMServer.renderToString(
+            <div hasOwnProperty="poison">
+              <span unknown="test" />
+            </div>,
+          )),
+      ).toWarnDev(['React does not recognize the `hasOwnProperty` prop']);
+      expect(html).toContain('<span unknown="test">');
+    });
   });
 
   describe('renderToStaticMarkup', () => {

commit e106b8c44f9a81058f250c7ee37b61ae0094455e
Author: Brian Vaughn <brian.david.vaughn@gmail.com>
Date:   Tue Aug 21 07:43:02 2018 -0700

    Warn about unsafe toWarnDev() nesting in tests (#12457)
    
    * Add lint run to warn about improperly nested toWarnDev matchers
    * Updated tests to avoid invalid nesting

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index 0e605f8c6e..e14586d72f 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -646,12 +646,13 @@ describe('ReactDOMServer', () => {
     expect(() => {
       expect(() =>
         ReactDOMServer.renderToString(<ClassWithRenderNotExtended />),
-      ).toWarnDev(
-        'Warning: The <ClassWithRenderNotExtended /> component appears to have a render method, ' +
-          "but doesn't extend React.Component. This is likely to cause errors. " +
-          'Change ClassWithRenderNotExtended to extend React.Component instead.',
-      );
-    }).toThrow(TypeError);
+      ).toThrow(TypeError);
+    }).toWarnDev(
+      'Warning: The <ClassWithRenderNotExtended /> component appears to have a render method, ' +
+        "but doesn't extend React.Component. This is likely to cause errors. " +
+        'Change ClassWithRenderNotExtended to extend React.Component instead.',
+      {withoutStack: true},
+    );
 
     // Test deduplication
     expect(() => {

commit b87aabdfe1b7461e7331abb3601d9e6bb27544bc
Author: HÃ©ctor Ramos <165856+hramos@users.noreply.github.com>
Date:   Fri Sep 7 15:11:23 2018 -0700

    Drop the year from Facebook copyright headers and the LICENSE file. (#13593)

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index e14586d72f..f3958af69a 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -1,5 +1,5 @@
 /**
- * Copyright (c) 2013-present, Facebook, Inc.
+ * Copyright (c) Facebook, Inc. and its affiliates.
  *
  * This source code is licensed under the MIT license found in the
  * LICENSE file in the root directory of this source tree.

commit 8ca8a594e6fc7dfcba73b8595344e7522d40171d
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Fri Oct 12 14:47:02 2018 +0100

    Error gracefully for unsupported SSR features (#13839)

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index f3958af69a..27b30f9bb0 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -566,6 +566,29 @@ describe('ReactDOMServer', () => {
     expect(markup).toBe('<div></div>');
   });
 
+  it('throws for unsupported types on the server', () => {
+    expect(() => {
+      ReactDOMServer.renderToString(<React.unstable_Suspense />);
+    }).toThrow('ReactDOMServer does not yet support Suspense.');
+
+    expect(() => {
+      const LazyFoo = React.lazy(
+        () =>
+          new Promise(resolve =>
+            resolve(function Foo() {
+              return <div />;
+            }),
+          ),
+      );
+      ReactDOMServer.renderToString(<LazyFoo />);
+    }).toThrow('ReactDOMServer does not yet support lazy-loaded components.');
+
+    expect(() => {
+      const FooPromise = {then() {}};
+      ReactDOMServer.renderToString(<FooPromise />);
+    }).toThrow('ReactDOMServer does not yet support lazy-loaded components.');
+  });
+
   it('should throw (in dev) when children are mutated during render', () => {
     function Wrapper(props) {
       props.children[1] = <p key={1} />; // Mutation is illegal

commit d9659e499eba3089b098c32cf112b7a067bdddf1
Author: Andrew Clark <github@andrewclark.io>
Date:   Thu Oct 18 19:57:12 2018 -0700

    Lazy components must use React.lazy (#13885)
    
    Removes support for using arbitrary promises as the type of a React
    element. Instead, promises must be wrapped in React.lazy. This gives us
    flexibility later if we need to change the protocol.
    
    The reason is that promises do not provide a way to call their
    constructor multiple times. For example:
    
    const promiseForA = new Promise(resolve => {
      fetchA(a => resolve(a));
    });
    
    Given a reference to `promiseForA`, there's no way to call `fetchA`
    again. Calling `then` on the promise doesn't run the constructor again;
    it only attaches another listener.
    
    In the future we will likely introduce an API like `React.eager` that
    is similar to `lazy` but eagerly calls the constructor. That gives us
    the ability to call the constructor multiple times. E.g. to increase
    the priority, or to retry if the first operation failed.

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index 27b30f9bb0..f15cb5557e 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -582,11 +582,6 @@ describe('ReactDOMServer', () => {
       );
       ReactDOMServer.renderToString(<LazyFoo />);
     }).toThrow('ReactDOMServer does not yet support lazy-loaded components.');
-
-    expect(() => {
-      const FooPromise = {then() {}};
-      ReactDOMServer.renderToString(<FooPromise />);
-    }).toThrow('ReactDOMServer does not yet support lazy-loaded components.');
   });
 
   it('should throw (in dev) when children are mutated during render', () => {

commit d9a3cc070c3b554ce6c4b43b917c1ba8951f9b5f
Author: Andrew Clark <github@andrewclark.io>
Date:   Thu Oct 18 19:58:25 2018 -0700

    React.lazy constructor must return result of a dynamic import (#13886)
    
    We may want to change the protocol later, so until then we'll be
    restrictive. Heuristic is to check for existence of `default`.

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index f15cb5557e..88b47fde82 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -571,14 +571,19 @@ describe('ReactDOMServer', () => {
       ReactDOMServer.renderToString(<React.unstable_Suspense />);
     }).toThrow('ReactDOMServer does not yet support Suspense.');
 
+    async function fakeImport(result) {
+      return {default: result};
+    }
+
     expect(() => {
-      const LazyFoo = React.lazy(
-        () =>
+      const LazyFoo = React.lazy(() =>
+        fakeImport(
           new Promise(resolve =>
             resolve(function Foo() {
               return <div />;
             }),
           ),
+        ),
       );
       ReactDOMServer.renderToString(<LazyFoo />);
     }).toThrow('ReactDOMServer does not yet support lazy-loaded components.');

commit fa65c58e15ca6b718a9771782e77d8a990a011d7
Author: Sebastian MarkbÃ¥ge <sebastian@calyptus.eu>
Date:   Thu Oct 18 20:20:03 2018 -0700

    Add readContext to SSR (#13888)
    
    Will be used by react-cache.

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index 88b47fde82..b6afd3ebae 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -13,6 +13,7 @@
 let React;
 let ReactDOMServer;
 let PropTypes;
+let ReactCurrentOwner;
 
 function normalizeCodeLocInfo(str) {
   return str && str.replace(/\(at .+?:\d+\)/g, '(at **)');
@@ -24,6 +25,9 @@ describe('ReactDOMServer', () => {
     React = require('react');
     PropTypes = require('prop-types');
     ReactDOMServer = require('react-dom/server');
+    ReactCurrentOwner =
+      React.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED
+        .ReactCurrentOwner;
   });
 
   describe('renderToString', () => {
@@ -431,6 +435,44 @@ describe('ReactDOMServer', () => {
       expect(results).toEqual([2, 1, 3, 1]);
     });
 
+    it('renders with dispatcher.readContext mechanism', () => {
+      const Context = React.createContext(0);
+
+      function readContext(context) {
+        return ReactCurrentOwner.currentDispatcher.readContext(context);
+      }
+
+      function Consumer(props) {
+        return 'Result: ' + readContext(Context);
+      }
+
+      const Indirection = React.Fragment;
+
+      function App(props) {
+        return (
+          <Context.Provider value={props.value}>
+            <Context.Provider value={2}>
+              <Consumer />
+            </Context.Provider>
+            <Indirection>
+              <Indirection>
+                <Consumer />
+                <Context.Provider value={3}>
+                  <Consumer />
+                </Context.Provider>
+              </Indirection>
+            </Indirection>
+            <Consumer />
+          </Context.Provider>
+        );
+      }
+
+      const markup = ReactDOMServer.renderToString(<App value={1} />);
+      // Extract the numbers rendered by the consumers
+      const results = markup.match(/\d+/g).map(Number);
+      expect(results).toEqual([2, 1, 3, 1]);
+    });
+
     it('renders context API, reentrancy', () => {
       const Context = React.createContext(0);
 

commit d75c69e0cf2a842adc47edab87ca5103411e6949
Author: Sebastian MarkbÃ¥ge <sebastian@calyptus.eu>
Date:   Mon Oct 22 22:40:05 2018 -0700

    Remove unstable_ prefix from Suspense (#13922)
    
    We are using it with lazy and the combination Suspense + lazy seems pretty
    stable. maxDuration is not but that's only enabled when you're in
    ConcurrentMode which is still unstable.

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index b6afd3ebae..b28892df11 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -610,7 +610,7 @@ describe('ReactDOMServer', () => {
 
   it('throws for unsupported types on the server', () => {
     expect(() => {
-      ReactDOMServer.renderToString(<React.unstable_Suspense />);
+      ReactDOMServer.renderToString(<React.Suspense />);
     }).toThrow('ReactDOMServer does not yet support Suspense.');
 
     async function fakeImport(result) {

commit ee3ef3a0792c0ad777270739fe5ff126e3d57992
Author: Pelle Wessman <pelle@kodfabrik.se>
Date:   Tue Nov 27 14:00:46 2018 +0100

    Fix regression: Errors not emitted in streams (#14314)
    
    Regression introduced in #14182 resulted in errors no longer being emitted on streams, breaking many consumers.
    
    Co-authored-by: Elliot Jalgard <elliot.j@live.se>

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index b28892df11..89a5f32116 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -556,6 +556,52 @@ describe('ReactDOMServer', () => {
     });
   });
 
+  describe('renderToNodeStream', () => {
+    it('should generate simple markup', () => {
+      const SuccessfulElement = React.createElement(() => <img />);
+      const response = ReactDOMServer.renderToNodeStream(SuccessfulElement);
+      expect(response.read().toString()).toMatch(
+        new RegExp('<img data-reactroot=""' + '/>'),
+      );
+    });
+
+    it('should handle errors correctly', () => {
+      const FailingElement = React.createElement(() => {
+        throw new Error('An Error');
+      });
+      const response = ReactDOMServer.renderToNodeStream(FailingElement);
+      return new Promise(resolve => {
+        response.once('error', () => {
+          resolve();
+        });
+        expect(response.read()).toBeNull();
+      });
+    });
+  });
+
+  describe('renderToStaticNodeStream', () => {
+    it('should generate simple markup', () => {
+      const SuccessfulElement = React.createElement(() => <img />);
+      const response = ReactDOMServer.renderToStaticNodeStream(
+        SuccessfulElement,
+      );
+      expect(response.read().toString()).toMatch(new RegExp('<img' + '/>'));
+    });
+
+    it('should handle errors correctly', () => {
+      const FailingElement = React.createElement(() => {
+        throw new Error('An Error');
+      });
+      const response = ReactDOMServer.renderToStaticNodeStream(FailingElement);
+      return new Promise(resolve => {
+        response.once('error', () => {
+          resolve();
+        });
+        expect(response.read()).toBeNull();
+      });
+    });
+  });
+
   it('warns with a no-op when an async setState is triggered', () => {
     class Foo extends React.Component {
       UNSAFE_componentWillMount() {

commit 19ef0ec116a2c5fd1a8dc86d38c2185d62abc6a1
Author: Brian Vaughn <brian.david.vaughn@gmail.com>
Date:   Tue Jan 8 14:39:52 2019 -0800

    Separate current owner and dispatcher (#14548)

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index 89a5f32116..14e14fccc5 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -13,7 +13,7 @@
 let React;
 let ReactDOMServer;
 let PropTypes;
-let ReactCurrentOwner;
+let ReactCurrentDispatcher;
 
 function normalizeCodeLocInfo(str) {
   return str && str.replace(/\(at .+?:\d+\)/g, '(at **)');
@@ -25,9 +25,9 @@ describe('ReactDOMServer', () => {
     React = require('react');
     PropTypes = require('prop-types');
     ReactDOMServer = require('react-dom/server');
-    ReactCurrentOwner =
+    ReactCurrentDispatcher =
       React.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED
-        .ReactCurrentOwner;
+        .ReactCurrentDispatcher;
   });
 
   describe('renderToString', () => {
@@ -439,7 +439,7 @@ describe('ReactDOMServer', () => {
       const Context = React.createContext(0);
 
       function readContext(context) {
-        return ReactCurrentOwner.currentDispatcher.readContext(context);
+        return ReactCurrentDispatcher.current.readContext(context);
       }
 
       function Consumer(props) {

commit df7b87d25e74fbbaf19b822096d0651aa3ad6a9f
Author: Brandon Dail <aweary@users.noreply.github.com>
Date:   Mon Mar 18 12:27:05 2019 -0700

    Warn for Context.Consumer with contextType (#14831)

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index 14e14fccc5..738148ba3b 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -904,4 +904,43 @@ describe('ReactDOMServer', () => {
         '    in App (at **)',
     ]);
   });
+
+  it('should warn if an invalid contextType is defined', () => {
+    const Context = React.createContext();
+
+    class ComponentA extends React.Component {
+      // It should warn for both Context.Consumer and Context.Provider
+      static contextType = Context.Consumer;
+      render() {
+        return <div />;
+      }
+    }
+    class ComponentB extends React.Component {
+      static contextType = Context.Provider;
+      render() {
+        return <div />;
+      }
+    }
+
+    expect(() => {
+      ReactDOMServer.renderToString(<ComponentA />);
+    }).toWarnDev(
+      'Warning: ComponentA defines an invalid contextType. ' +
+        'contextType should point to the Context object returned by React.createContext(). ' +
+        'Did you accidentally pass the Context.Consumer instead?',
+      {withoutStack: true},
+    );
+
+    // Warnings should be deduped by component type
+    ReactDOMServer.renderToString(<ComponentA />);
+
+    expect(() => {
+      ReactDOMServer.renderToString(<ComponentB />);
+    }).toWarnDev(
+      'Warning: ComponentB defines an invalid contextType. ' +
+        'contextType should point to the Context object returned by React.createContext(). ' +
+        'Did you accidentally pass the Context.Provider instead?',
+      {withoutStack: true},
+    );
+  });
 });

commit 7ad7386308abd55f12ad9f1cddac6a97860e92eb
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Tue Mar 19 13:31:26 2019 +0000

    Improve warning for invalid class contextType (#15142)
    
    * Improve warning for invalid class contextType
    
    * Don't warn for null
    
    * Grammar

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index 738148ba3b..8c68b07a5f 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -943,4 +943,86 @@ describe('ReactDOMServer', () => {
       {withoutStack: true},
     );
   });
+
+  it('should not warn when class contextType is null', () => {
+    class Foo extends React.Component {
+      static contextType = null; // Handy for conditional declaration
+      render() {
+        return this.context.hello.world;
+      }
+    }
+
+    expect(() => {
+      ReactDOMServer.renderToString(<Foo />);
+    }).toThrow("Cannot read property 'world' of undefined");
+  });
+
+  it('should warn when class contextType is undefined', () => {
+    class Foo extends React.Component {
+      // This commonly happens with circular deps
+      // https://github.com/facebook/react/issues/13969
+      static contextType = undefined;
+      render() {
+        return this.context.hello.world;
+      }
+    }
+
+    expect(() => {
+      expect(() => {
+        ReactDOMServer.renderToString(<Foo />);
+      }).toThrow("Cannot read property 'world' of undefined");
+    }).toWarnDev(
+      'Foo defines an invalid contextType. ' +
+        'contextType should point to the Context object returned by React.createContext(). ' +
+        'However, it is set to undefined. ' +
+        'This can be caused by a typo or by mixing up named and default imports. ' +
+        'This can also happen due to a circular dependency, ' +
+        'so try moving the createContext() call to a separate file.',
+      {withoutStack: true},
+    );
+  });
+
+  it('should warn when class contextType is an object', () => {
+    class Foo extends React.Component {
+      // Can happen due to a typo
+      static contextType = {
+        x: 42,
+        y: 'hello',
+      };
+      render() {
+        return this.context.hello.world;
+      }
+    }
+
+    expect(() => {
+      expect(() => {
+        ReactDOMServer.renderToString(<Foo />);
+      }).toThrow("Cannot read property 'hello' of undefined");
+    }).toWarnDev(
+      'Foo defines an invalid contextType. ' +
+        'contextType should point to the Context object returned by React.createContext(). ' +
+        'However, it is set to an object with keys {x, y}.',
+      {withoutStack: true},
+    );
+  });
+
+  it('should warn when class contextType is a primitive', () => {
+    class Foo extends React.Component {
+      static contextType = 'foo';
+      render() {
+        return this.context.hello.world;
+      }
+    }
+
+    expect(() => {
+      expect(() => {
+        ReactDOMServer.renderToString(<Foo />);
+      }).toThrow("Cannot read property 'world' of undefined");
+    }).toWarnDev(
+      'Foo defines an invalid contextType. ' +
+        'contextType should point to the Context object returned by React.createContext(). ' +
+        'However, it is set to a string.',
+      {withoutStack: true},
+    );
+  });
 });

commit 56636353d8a0bf51c0eee1bbef004c90d6788999
Author: Lee Byron <lee.byron@robinhood.com>
Date:   Tue Aug 13 18:51:20 2019 -0700

    Partial support for React.lazy() in server renderer. (#16383)
    
    Provides partial support for React.lazy() components from the existing PartialRenderer server-side renderer.
    
    Lazy components which are already resolved (or rejected), perhaps with something like `react-ssr-prepass`, can be continued into synchronously. If they have not yet been initialized, they'll be initialized before checking, opening the possibility to exploit this capability with a babel transform. If they're pending (which will typically be the case for a just initialized async ctor) then the existing invariant continues to be thrown.

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index 8c68b07a5f..4cd37d469a 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -554,6 +554,34 @@ describe('ReactDOMServer', () => {
         ),
       ).not.toThrow();
     });
+
+    it('renders synchronously resolved lazy component', () => {
+      const LazyFoo = React.lazy(() => ({
+        then(resolve) {
+          resolve({
+            default: function Foo({id}) {
+              return <div id={id}>lazy</div>;
+            },
+          });
+        },
+      }));
+
+      expect(ReactDOMServer.renderToString(<LazyFoo id="foo" />)).toEqual(
+        '<div id="foo">lazy</div>',
+      );
+    });
+
+    it('throws error from synchronously rejected lazy component', () => {
+      const LazyFoo = React.lazy(() => ({
+        then(resolve, reject) {
+          reject(new Error('Bad lazy'));
+        },
+      }));
+
+      expect(() => ReactDOMServer.renderToString(<LazyFoo />)).toThrow(
+        'Bad lazy',
+      );
+    });
   });
 
   describe('renderToNodeStream', () => {

commit 56f93a7f38f25284261ee5d287aa32dcb1caf327
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Mon Aug 19 19:53:02 2019 +0100

    Throw on unhandled SSR suspending (#16460)
    
    * Throw on unhandled SSR suspending
    
    * Add a nicer message when the flag is off
    
    * Tweak internal refinement error message

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index 4cd37d469a..bb29d665a4 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -705,6 +705,70 @@ describe('ReactDOMServer', () => {
     }).toThrow('ReactDOMServer does not yet support lazy-loaded components.');
   });
 
+  it('throws when suspending on the server', () => {
+    function AsyncFoo() {
+      throw new Promise(() => {});
+    }
+
+    expect(() => {
+      ReactDOMServer.renderToString(<AsyncFoo />);
+    }).toThrow('ReactDOMServer does not yet support Suspense.');
+  });
+
+  it('does not get confused by throwing null', () => {
+    function Bad() {
+      // eslint-disable-next-line no-throw-literal
+      throw null;
+    }
+
+    let didError;
+    let error;
+    try {
+      ReactDOMServer.renderToString(<Bad />);
+    } catch (err) {
+      didError = true;
+      error = err;
+    }
+    expect(didError).toBe(true);
+    expect(error).toBe(null);
+  });
+
+  it('does not get confused by throwing undefined', () => {
+    function Bad() {
+      // eslint-disable-next-line no-throw-literal
+      throw undefined;
+    }
+
+    let didError;
+    let error;
+    try {
+      ReactDOMServer.renderToString(<Bad />);
+    } catch (err) {
+      didError = true;
+      error = err;
+    }
+    expect(didError).toBe(true);
+    expect(error).toBe(undefined);
+  });
+
+  it('does not get confused by throwing a primitive', () => {
+    function Bad() {
+      // eslint-disable-next-line no-throw-literal
+      throw 'foo';
+    }
+
+    let didError;
+    let error;
+    try {
+      ReactDOMServer.renderToString(<Bad />);
+    } catch (err) {
+      didError = true;
+      error = err;
+    }
+    expect(didError).toBe(true);
+    expect(error).toBe('foo');
+  });
+
   it('should throw (in dev) when children are mutated during render', () => {
     function Wrapper(props) {
       props.children[1] = <p key={1} />; // Mutation is illegal

commit f61138e0681f729c43cf755f48f060e6262a09eb
Author: Gerald Monaco <gerald@gmonaco.me>
Date:   Thu Aug 29 08:08:38 2019 -0700

    Use renderToStaticMarkup for tests (#16516)

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index bb29d665a4..a1f48f3e49 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -320,7 +320,7 @@ describe('ReactDOMServer', () => {
           return <div>{this.state.text}</div>;
         }
       }
-      const markup = ReactDOMServer.renderToString(<Component />);
+      const markup = ReactDOMServer.renderToStaticMarkup(<Component />);
       expect(markup).toContain('hello, world');
     });
 
@@ -339,7 +339,7 @@ describe('ReactDOMServer', () => {
           return <div>{this.state.text}</div>;
         }
       }
-      const markup = ReactDOMServer.renderToString(<Component />);
+      const markup = ReactDOMServer.renderToStaticMarkup(<Component />);
       expect(markup).toContain('hello, world');
     });
 
@@ -354,7 +354,7 @@ describe('ReactDOMServer', () => {
         }
       }
 
-      const markup = ReactDOMServer.renderToString(
+      const markup = ReactDOMServer.renderToStaticMarkup(
         <Component text="hello, world" />,
       );
       expect(markup).toContain('hello, world');
@@ -391,7 +391,7 @@ describe('ReactDOMServer', () => {
         text: PropTypes.string,
       };
 
-      const markup = ReactDOMServer.renderToString(
+      const markup = ReactDOMServer.renderToStaticMarkup(
         <ContextProvider>
           <Component />
         </ContextProvider>,
@@ -429,7 +429,7 @@ describe('ReactDOMServer', () => {
         );
       }
 
-      const markup = ReactDOMServer.renderToString(<App value={1} />);
+      const markup = ReactDOMServer.renderToStaticMarkup(<App value={1} />);
       // Extract the numbers rendered by the consumers
       const results = markup.match(/\d+/g).map(Number);
       expect(results).toEqual([2, 1, 3, 1]);
@@ -467,7 +467,7 @@ describe('ReactDOMServer', () => {
         );
       }
 
-      const markup = ReactDOMServer.renderToString(<App value={1} />);
+      const markup = ReactDOMServer.renderToStaticMarkup(<App value={1} />);
       // Extract the numbers rendered by the consumers
       const results = markup.match(/\d+/g).map(Number);
       expect(results).toEqual([2, 1, 3, 1]);
@@ -484,7 +484,7 @@ describe('ReactDOMServer', () => {
 
       let reentrantMarkup;
       function Reentrant() {
-        reentrantMarkup = ReactDOMServer.renderToString(
+        reentrantMarkup = ReactDOMServer.renderToStaticMarkup(
           <App value={1} reentrant={false} />,
         );
         return null;
@@ -512,7 +512,7 @@ describe('ReactDOMServer', () => {
         );
       }
 
-      const markup = ReactDOMServer.renderToString(
+      const markup = ReactDOMServer.renderToStaticMarkup(
         <App value={1} reentrant={true} />,
       );
       // Extract the numbers rendered by the consumers
@@ -566,7 +566,7 @@ describe('ReactDOMServer', () => {
         },
       }));
 
-      expect(ReactDOMServer.renderToString(<LazyFoo id="foo" />)).toEqual(
+      expect(ReactDOMServer.renderToStaticMarkup(<LazyFoo id="foo" />)).toEqual(
         '<div id="foo">lazy</div>',
       );
     });
@@ -578,7 +578,7 @@ describe('ReactDOMServer', () => {
         },
       }));
 
-      expect(() => ReactDOMServer.renderToString(<LazyFoo />)).toThrow(
+      expect(() => ReactDOMServer.renderToStaticMarkup(<LazyFoo />)).toThrow(
         'Bad lazy',
       );
     });

commit 30c5daf943bd3bed38e464ac79e38f0e8a27426b
Author: Andrew Clark <git@andrewclark.io>
Date:   Tue Oct 15 15:09:19 2019 -0700

    Remove concurrent apis from stable (#17088)
    
    * Tests run in experimental mode by default
    
    For local development, you usually want experiments enabled. Unless
    the release channel is set with an environment variable, tests will
    run with __EXPERIMENTAL__ set to `true`.
    
    * Remove concurrent APIs from stable builds
    
    Those who want to try concurrent mode should use the experimental
    builds instead.
    
    I've left the `unstable_` prefixed APIs in the Facebook build so we
    can continue experimenting with them internally without blessing them
    for widespread use.
    
    * Turn on SSR flags in experimental build
    
    * Remove prefixed concurrent APIs from www build
    
    Instead we'll use the experimental builds when syncing to www.
    
    * Remove "canary" from internal React version string

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index a1f48f3e49..54edfacb84 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -682,38 +682,40 @@ describe('ReactDOMServer', () => {
     expect(markup).toBe('<div></div>');
   });
 
-  it('throws for unsupported types on the server', () => {
-    expect(() => {
-      ReactDOMServer.renderToString(<React.Suspense />);
-    }).toThrow('ReactDOMServer does not yet support Suspense.');
+  if (!__EXPERIMENTAL__) {
+    it('throws for unsupported types on the server', () => {
+      expect(() => {
+        ReactDOMServer.renderToString(<React.Suspense />);
+      }).toThrow('ReactDOMServer does not yet support Suspense.');
 
-    async function fakeImport(result) {
-      return {default: result};
-    }
+      async function fakeImport(result) {
+        return {default: result};
+      }
 
-    expect(() => {
-      const LazyFoo = React.lazy(() =>
-        fakeImport(
-          new Promise(resolve =>
-            resolve(function Foo() {
-              return <div />;
-            }),
+      expect(() => {
+        const LazyFoo = React.lazy(() =>
+          fakeImport(
+            new Promise(resolve =>
+              resolve(function Foo() {
+                return <div />;
+              }),
+            ),
           ),
-        ),
-      );
-      ReactDOMServer.renderToString(<LazyFoo />);
-    }).toThrow('ReactDOMServer does not yet support lazy-loaded components.');
-  });
+        );
+        ReactDOMServer.renderToString(<LazyFoo />);
+      }).toThrow('ReactDOMServer does not yet support lazy-loaded components.');
+    });
 
-  it('throws when suspending on the server', () => {
-    function AsyncFoo() {
-      throw new Promise(() => {});
-    }
+    it('throws when suspending on the server', () => {
+      function AsyncFoo() {
+        throw new Promise(() => {});
+      }
 
-    expect(() => {
-      ReactDOMServer.renderToString(<AsyncFoo />);
-    }).toThrow('ReactDOMServer does not yet support Suspense.');
-  });
+      expect(() => {
+        ReactDOMServer.renderToString(<AsyncFoo />);
+      }).toThrow('ReactDOMServer does not yet support Suspense.');
+    });
+  }
 
   it('does not get confused by throwing null', () => {
     function Bad() {

commit b15bf36750ca4c4a5a09f2de76c5315ded1258d0
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Thu Dec 12 23:47:55 2019 +0000

    Add component stacks to (almost) all warnings (#17586)

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index 54edfacb84..5a80060abe 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -856,7 +856,6 @@ describe('ReactDOMServer', () => {
       'Warning: The <ClassWithRenderNotExtended /> component appears to have a render method, ' +
         "but doesn't extend React.Component. This is likely to cause errors. " +
         'Change ClassWithRenderNotExtended to extend React.Component instead.',
-      {withoutStack: true},
     );
 
     // Test deduplication
@@ -1022,7 +1021,6 @@ describe('ReactDOMServer', () => {
       'Warning: ComponentA defines an invalid contextType. ' +
         'contextType should point to the Context object returned by React.createContext(). ' +
         'Did you accidentally pass the Context.Consumer instead?',
-      {withoutStack: true},
     );
 
     // Warnings should be deduped by component type
@@ -1034,7 +1032,6 @@ describe('ReactDOMServer', () => {
       'Warning: ComponentB defines an invalid contextType. ' +
         'contextType should point to the Context object returned by React.createContext(). ' +
         'Did you accidentally pass the Context.Provider instead?',
-      {withoutStack: true},
     );
   });
 
@@ -1072,7 +1069,6 @@ describe('ReactDOMServer', () => {
         'This can be caused by a typo or by mixing up named and default imports. ' +
         'This can also happen due to a circular dependency, ' +
         'so try moving the createContext() call to a separate file.',
-      {withoutStack: true},
     );
   });
 
@@ -1096,7 +1092,6 @@ describe('ReactDOMServer', () => {
       'Foo defines an invalid contextType. ' +
         'contextType should point to the Context object returned by React.createContext(). ' +
         'However, it is set to an object with keys {x, y}.',
-      {withoutStack: true},
     );
   });
 
@@ -1116,7 +1111,6 @@ describe('ReactDOMServer', () => {
       'Foo defines an invalid contextType. ' +
         'contextType should point to the Context object returned by React.createContext(). ' +
         'However, it is set to a string.',
-      {withoutStack: true},
     );
   });
 });

commit 0b5a26a4895261894f04e50d5a700e83b9c0dcf6
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Mon Dec 16 12:48:16 2019 +0000

    Rename toWarnDev -> toErrorDev, toLowPriorityWarnDev -> toWarnDev (#17605)
    
    * Rename toWarnDev -> toErrorDev in tests
    
    * Rename toWarnDev matcher implementation to toErrorDev
    
    * Rename toLowPriorityWarnDev -> toWarnDev in tests and implementation

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index 5a80060abe..e68de16057 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -188,7 +188,7 @@ describe('ReactDOMServer', () => {
               <span unknown="test" />
             </div>,
           )),
-      ).toWarnDev(['React does not recognize the `hasOwnProperty` prop']);
+      ).toErrorDev(['React does not recognize the `hasOwnProperty` prop']);
       expect(html).toContain('<span unknown="test">');
     });
   });
@@ -644,7 +644,7 @@ describe('ReactDOMServer', () => {
     }
 
     ReactDOMServer.renderToString(<Foo />);
-    expect(() => jest.runOnlyPendingTimers()).toWarnDev(
+    expect(() => jest.runOnlyPendingTimers()).toErrorDev(
       'Warning: setState(...): Can only update a mounting component.' +
         ' This usually means you called setState() outside componentWillMount() on the server.' +
         ' This is a no-op.\n\nPlease check the code for the Foo component.',
@@ -672,7 +672,7 @@ describe('ReactDOMServer', () => {
     }
 
     ReactDOMServer.renderToString(<Baz />);
-    expect(() => jest.runOnlyPendingTimers()).toWarnDev(
+    expect(() => jest.runOnlyPendingTimers()).toErrorDev(
       'Warning: forceUpdate(...): Can only update a mounting component. ' +
         'This usually means you called forceUpdate() outside componentWillMount() on the server. ' +
         'This is a no-op.\n\nPlease check the code for the Baz component.',
@@ -819,7 +819,7 @@ describe('ReactDOMServer', () => {
           </svg>
         </div>,
       ),
-    ).toWarnDev([
+    ).toErrorDev([
       'Warning: <inPUT /> is using incorrect casing. ' +
         'Use PascalCase for React components, ' +
         'or lowercase for HTML elements.',
@@ -833,7 +833,7 @@ describe('ReactDOMServer', () => {
   it('should warn about contentEditable and children', () => {
     expect(() =>
       ReactDOMServer.renderToString(<div contentEditable={true} children="" />),
-    ).toWarnDev(
+    ).toErrorDev(
       'Warning: A component is `contentEditable` and contains `children` ' +
         'managed by React. It is now your responsibility to guarantee that ' +
         'none of those nodes are unexpectedly modified or duplicated. This ' +
@@ -852,7 +852,7 @@ describe('ReactDOMServer', () => {
       expect(() =>
         ReactDOMServer.renderToString(<ClassWithRenderNotExtended />),
       ).toThrow(TypeError);
-    }).toWarnDev(
+    }).toErrorDev(
       'Warning: The <ClassWithRenderNotExtended /> component appears to have a render method, ' +
         "but doesn't extend React.Component. This is likely to cause errors. " +
         'Change ClassWithRenderNotExtended to extend React.Component instead.',
@@ -921,7 +921,7 @@ describe('ReactDOMServer', () => {
       );
     }
 
-    expect(() => ReactDOMServer.renderToString(<App />)).toWarnDev([
+    expect(() => ReactDOMServer.renderToString(<App />)).toErrorDev([
       'Invalid ARIA attribute `ariaTypo`. ARIA attributes follow the pattern aria-* and must be lowercase.\n' +
         '    in span (at **)\n' +
         '    in b (at **)\n' +
@@ -970,7 +970,7 @@ describe('ReactDOMServer', () => {
       );
     }
 
-    expect(() => ReactDOMServer.renderToString(<App />)).toWarnDev([
+    expect(() => ReactDOMServer.renderToString(<App />)).toErrorDev([
       // ReactDOMServer(App > div > span)
       'Invalid ARIA attribute `ariaTypo`. ARIA attributes follow the pattern aria-* and must be lowercase.\n' +
         '    in span (at **)\n' +
@@ -1017,7 +1017,7 @@ describe('ReactDOMServer', () => {
 
     expect(() => {
       ReactDOMServer.renderToString(<ComponentA />);
-    }).toWarnDev(
+    }).toErrorDev(
       'Warning: ComponentA defines an invalid contextType. ' +
         'contextType should point to the Context object returned by React.createContext(). ' +
         'Did you accidentally pass the Context.Consumer instead?',
@@ -1028,7 +1028,7 @@ describe('ReactDOMServer', () => {
 
     expect(() => {
       ReactDOMServer.renderToString(<ComponentB />);
-    }).toWarnDev(
+    }).toErrorDev(
       'Warning: ComponentB defines an invalid contextType. ' +
         'contextType should point to the Context object returned by React.createContext(). ' +
         'Did you accidentally pass the Context.Provider instead?',
@@ -1062,7 +1062,7 @@ describe('ReactDOMServer', () => {
       expect(() => {
         ReactDOMServer.renderToString(<Foo />);
       }).toThrow("Cannot read property 'world' of undefined");
-    }).toWarnDev(
+    }).toErrorDev(
       'Foo defines an invalid contextType. ' +
         'contextType should point to the Context object returned by React.createContext(). ' +
         'However, it is set to undefined. ' +
@@ -1088,7 +1088,7 @@ describe('ReactDOMServer', () => {
       expect(() => {
         ReactDOMServer.renderToString(<Foo />);
       }).toThrow("Cannot read property 'hello' of undefined");
-    }).toWarnDev(
+    }).toErrorDev(
       'Foo defines an invalid contextType. ' +
         'contextType should point to the Context object returned by React.createContext(). ' +
         'However, it is set to an object with keys {x, y}.',
@@ -1107,7 +1107,7 @@ describe('ReactDOMServer', () => {
       expect(() => {
         ReactDOMServer.renderToString(<Foo />);
       }).toThrow("Cannot read property 'world' of undefined");
-    }).toWarnDev(
+    }).toErrorDev(
       'Foo defines an invalid contextType. ' +
         'contextType should point to the Context object returned by React.createContext(). ' +
         'However, it is set to a string.',

commit b979db4e7215957f03c4221622f0b115a868439a
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Thu Jan 9 13:54:11 2020 +0000

    Bump Prettier (#17811)
    
    * Bump Prettier
    
    * Reformat
    
    * Use non-deprecated option

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index e68de16057..bcefcdb652 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -644,7 +644,9 @@ describe('ReactDOMServer', () => {
     }
 
     ReactDOMServer.renderToString(<Foo />);
-    expect(() => jest.runOnlyPendingTimers()).toErrorDev(
+    expect(() =>
+      jest.runOnlyPendingTimers(),
+    ).toErrorDev(
       'Warning: setState(...): Can only update a mounting component.' +
         ' This usually means you called setState() outside componentWillMount() on the server.' +
         ' This is a no-op.\n\nPlease check the code for the Foo component.',
@@ -672,7 +674,9 @@ describe('ReactDOMServer', () => {
     }
 
     ReactDOMServer.renderToString(<Baz />);
-    expect(() => jest.runOnlyPendingTimers()).toErrorDev(
+    expect(() =>
+      jest.runOnlyPendingTimers(),
+    ).toErrorDev(
       'Warning: forceUpdate(...): Can only update a mounting component. ' +
         'This usually means you called forceUpdate() outside componentWillMount() on the server. ' +
         'This is a no-op.\n\nPlease check the code for the Baz component.',

commit 115cd12d9bbb2bff303e52feb1394e3a2cef20ca
Author: Andrew Clark <git@andrewclark.io>
Date:   Fri Mar 6 09:29:05 2020 -0800

    Add test run that uses www feature flags (#18234)
    
    In CI, we run our test suite against multiple build configurations. For
    example, we run our tests in both dev and prod, and in both the
    experimental and stable release channels. This is to prevent accidental
    deviations in behavior between the different builds. If there's an
    intentional deviation in behavior, the test author must account
    for them.
    
    However, we currently don't run tests against the www builds. That's
    a problem, because it's common for features to land in www before they
    land anywhere else, including the experimental release channel.
    Typically we do this so we can gradually roll out the feature behind
    a flag before deciding to enable it.
    
    The way we test those features today is by mutating the
    `shared/ReactFeatureFlags` module. There are a few downsides to this
    approach, though. The flag is only overridden for the specific tests or
    test suites where you apply the override. But usually what you want is
    to run *all* tests with the flag enabled, to protect against unexpected
    regressions.
    
    Also, mutating the feature flags module only works when running the
    tests against source, not against the final build artifacts, because the
    ReactFeatureFlags module is inlined by the build script.
    
    Instead, we should run the test suite against the www configuration,
    just like we do for prod, experimental, and so on. I've added a new
    command, `yarn test-www`. It automatically runs in CI.
    
    Some of the www feature flags are dynamic; that is, they depend on
    a runtime condition (i.e. a GK). These flags are imported from an
    external module that lives in www. Those flags will be enabled for some
    clients and disabled for others, so we should run the tests against
    *both* modes.
    
    So I've added a new global `__VARIANT__`, and a new test command `yarn
    test-www-variant`. `__VARIANT__` is set to false by default; when
    running `test-www-variant`, it's set to true.
    
    If we were going for *really* comprehensive coverage, we would run the
    tests against every possible configuration of feature flags: 2 ^
    numberOfFlags total combinations. That's not practical, though, so
    instead we only run against two combinations: once with `__VARIANT__`
    set to `true`, and once with it set to `false`. We generally assume that
    flags can be toggled independently, so in practice this should
    be enough.
    
    You can also refer to `__VARIANT__` in tests to detect which mode you're
    running in. Or, you can import `shared/ReactFeatureFlags` and read the
    specific flag you can about. However, we should stop mutating that
    module going forward. Treat it as read-only.
    
    In this commit, I have only setup the www tests to run against source.
    I'll leave running against build for a follow up.
    
    Many of our tests currently assume they run only in the default
    configuration, and break when certain flags are toggled. Rather than fix
    these all up front, I've hard-coded the relevant flags to the default
    values. We can incrementally migrate those tests later.

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index bcefcdb652..b920a025ea 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -14,6 +14,8 @@ let React;
 let ReactDOMServer;
 let PropTypes;
 let ReactCurrentDispatcher;
+let enableSuspenseServerRenderer = require('shared/ReactFeatureFlags')
+  .enableSuspenseServerRenderer;
 
 function normalizeCodeLocInfo(str) {
   return str && str.replace(/\(at .+?:\d+\)/g, '(at **)');
@@ -686,7 +688,7 @@ describe('ReactDOMServer', () => {
     expect(markup).toBe('<div></div>');
   });
 
-  if (!__EXPERIMENTAL__) {
+  if (!enableSuspenseServerRenderer) {
     it('throws for unsupported types on the server', () => {
       expect(() => {
         ReactDOMServer.renderToString(<React.Suspense />);

commit fd61f7ea53989a59bc427603798bb111c852816a
Author: Sebastian MarkbÃ¥ge <sebastian@calyptus.eu>
Date:   Sun Mar 22 21:53:05 2020 -0700

    Refactor Lazy Components to use teh Suspense (and wrap Blocks in Lazy) (#18362)
    
    * Refactor Lazy Components
    
    * Switch Blocks to using a Lazy component wrapper
    
    Then resolve to a true Block inside.
    
    * Test component names of lazy Blocks

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index b920a025ea..56ee796e56 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -709,7 +709,7 @@ describe('ReactDOMServer', () => {
           ),
         );
         ReactDOMServer.renderToString(<LazyFoo />);
-      }).toThrow('ReactDOMServer does not yet support lazy-loaded components.');
+      }).toThrow('ReactDOMServer does not yet support Suspense.');
     });
 
     it('throws when suspending on the server', () => {

commit 3e94bce765d355d74f6a60feb4addb6d196e3482
Author: Sebastian MarkbÃ¥ge <sebastian@calyptus.eu>
Date:   Wed Apr 1 12:35:52 2020 -0700

    Enable prefer-const lint rules (#18451)
    
    * Enable prefer-const rule
    
    Stylistically I don't like this but Closure Compiler takes advantage of
    this information.
    
    * Auto-fix lints
    
    * Manually fix the remaining callsites

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index 56ee796e56..26fb497a6b 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -14,7 +14,7 @@ let React;
 let ReactDOMServer;
 let PropTypes;
 let ReactCurrentDispatcher;
-let enableSuspenseServerRenderer = require('shared/ReactFeatureFlags')
+const enableSuspenseServerRenderer = require('shared/ReactFeatureFlags')
   .enableSuspenseServerRenderer;
 
 function normalizeCodeLocInfo(str) {

commit 98d410f5005988644d01c9ec79b7181c3dd6c847
Author: Sebastian MarkbÃ¥ge <sebastian@calyptus.eu>
Date:   Fri Apr 10 13:32:12 2020 -0700

    Build Component Stacks from Native Stack Frames (#18561)
    
    * Implement component stack extraction hack
    
    * Normalize errors in tests
    
    This drops the requirement to include owner to pass the test.
    
    * Special case tests
    
    * Add destructuring to force toObject which throws before the side-effects
    
    This ensures that we don't double call yieldValue or advanceTime in tests.
    
    Ideally we could use empty destructuring but ES lint doesn't like it.
    
    * Cache the result in DEV
    
    In DEV it's somewhat likely that we'll see many logs that add component
    stacks. This could be slow so we cache the results of previous components.
    
    * Fixture
    
    * Add Reflect to lint
    
    * Log if out of range.
    
    * Fix special case when the function call throws in V8
    
    In V8 we need to ignore the first line. Normally we would never get there
    because the stacks would differ before that, but the stacks are the same if
    we end up throwing at the same place as the control.

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index 26fb497a6b..fb5858e881 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -18,7 +18,12 @@ const enableSuspenseServerRenderer = require('shared/ReactFeatureFlags')
   .enableSuspenseServerRenderer;
 
 function normalizeCodeLocInfo(str) {
-  return str && str.replace(/\(at .+?:\d+\)/g, '(at **)');
+  return (
+    str &&
+    str.replace(/\n +(?:at|in) ([\S]+)[^\n]*/g, function(m, name) {
+      return '\n    in ' + name + ' (at **)';
+    })
+  );
 }
 
 describe('ReactDOMServer', () => {

commit 940f48b999a3131e77b2545bd7ae252ef27ae6d1
Author: Sebastian MarkbÃ¥ge <sebastian@calyptus.eu>
Date:   Tue Apr 21 09:22:46 2020 -0700

    Avoid passing custom stacks to console.error (#18685)
    
    * Detect double stacks in the new format in tests
    
    * Remove unnecessary uses of getStackByFiberInDevAndProd
    
    These all execute in the right execution context already.
    
    * Set the debug fiber around the cases that don't have an execution context
    
    * Remove stack detection in our console log overrides
    
    We never pass custom stacks as part of the args anymore.
    
    * Bonus: Don't append getStackAddendum to invariants
    
    We print component stacks for every error anyway so this is just duplicate
    information.

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index fb5858e881..e84ae1d2ed 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -17,15 +17,6 @@ let ReactCurrentDispatcher;
 const enableSuspenseServerRenderer = require('shared/ReactFeatureFlags')
   .enableSuspenseServerRenderer;
 
-function normalizeCodeLocInfo(str) {
-  return (
-    str &&
-    str.replace(/\n +(?:at|in) ([\S]+)[^\n]*/g, function(m, name) {
-      return '\n    in ' + name + ' (at **)';
-    })
-  );
-}
-
 describe('ReactDOMServer', () => {
   beforeEach(() => {
     jest.resetModules();
@@ -172,17 +163,11 @@ describe('ReactDOMServer', () => {
     });
 
     it('should throw prop mapping error for an <iframe /> with invalid props', () => {
-      let caughtErr;
-      try {
+      expect(() => {
         ReactDOMServer.renderToString(<iframe style="border:none;" />);
-      } catch (err) {
-        caughtErr = err;
-      }
-      expect(caughtErr).not.toBe(undefined);
-      expect(normalizeCodeLocInfo(caughtErr.message)).toContain(
+      }).toThrowError(
         'The `style` prop expects a mapping from style properties to values, not ' +
-          "a string. For example, style={{marginRight: spacing + 'em'}} when using JSX." +
-          (__DEV__ ? '\n    in iframe (at **)' : ''),
+          "a string. For example, style={{marginRight: spacing + 'em'}} when using JSX.",
       );
     });
 

commit 5890e0e692d1c39eddde0110bd0d123409f31dd3
Author: Sebastian MarkbÃ¥ge <sebastian@calyptus.eu>
Date:   Thu May 13 13:18:21 2021 -0400

    Remove data-reactroot from server rendering and hydration heuristic (#20996)
    
    This was used to implicitly hydrate if you call ReactDOM.render.
    
    We've had a warning to explicitly use ReactDOM.hydrate(...) instead of
    ReactDOM.render(...). We can now remove this from the generated markup.
    (And avoid adding it to Fizz.)
    
    This is a little strange to do now since we're trying hard to make the
    root API work the same.
    
    But if we kept it, we'd need to keep it in the generated output which adds
    unnecessary bytes. It also risks people relying on it, in the Fizz world
    where as this is an opportunity to create that clean state.
    
    We could possibly only keep it in the old server rendering APIs but then
    that creates an implicit dependency between which server API and which
    client API that you use. Currently you can really mix and match either way.

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index e84ae1d2ed..b39d7c8ff5 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -31,14 +31,12 @@ describe('ReactDOMServer', () => {
   describe('renderToString', () => {
     it('should generate simple markup', () => {
       const response = ReactDOMServer.renderToString(<span>hello world</span>);
-      expect(response).toMatch(
-        new RegExp('<span data-reactroot=""' + '>hello world</span>'),
-      );
+      expect(response).toMatch(new RegExp('<span' + '>hello world</span>'));
     });
 
     it('should generate simple markup for self-closing tags', () => {
       const response = ReactDOMServer.renderToString(<img />);
-      expect(response).toMatch(new RegExp('<img data-reactroot=""' + '/>'));
+      expect(response).toMatch(new RegExp('<img' + '/>'));
     });
 
     it('should generate comment markup for component returns null', () => {
@@ -74,10 +72,7 @@ describe('ReactDOMServer', () => {
       const response = ReactDOMServer.renderToString(<Parent />);
       expect(response).toMatch(
         new RegExp(
-          '<div ' +
-            'data-reactroot' +
-            '=""' +
-            '>' +
+          '<div>' +
             '<span' +
             '>' +
             'My name is <!-- -->child' +
@@ -136,12 +131,7 @@ describe('ReactDOMServer', () => {
 
         expect(response).toMatch(
           new RegExp(
-            '<span ' +
-              'data-reactroot' +
-              '=""' +
-              '>' +
-              'Component name: <!-- -->TestComponent' +
-              '</span>',
+            '<span>' + 'Component name: <!-- -->TestComponent' + '</span>',
           ),
         );
         expect(lifecycle).toEqual([
@@ -580,9 +570,7 @@ describe('ReactDOMServer', () => {
     it('should generate simple markup', () => {
       const SuccessfulElement = React.createElement(() => <img />);
       const response = ReactDOMServer.renderToNodeStream(SuccessfulElement);
-      expect(response.read().toString()).toMatch(
-        new RegExp('<img data-reactroot=""' + '/>'),
-      );
+      expect(response.read().toString()).toMatch(new RegExp('<img' + '/>'));
     });
 
     it('should handle errors correctly', () => {

commit 24dd07bd269590ee5024b7f0f1906887d256ea86
Author: Joey Arhar <josepharhar@gmail.com>
Date:   Wed Dec 8 07:11:42 2021 -0800

    Add custom element property support behind a flag (#22184)
    
    * custom element props
    
    * custom element events
    
    * use function type for on*
    
    * tests, htmlFor
    
    * className
    
    * fix ReactDOMComponent-test
    
    * started on adding feature flag
    
    * added feature flag to all feature flag files
    
    * everything passes
    
    * tried to fix getPropertyInfo
    
    * used @gate and __experimental__
    
    * remove flag gating for test which already passes
    
    * fix onClick test
    
    * add __EXPERIMENTAL__ to www flags, rename eventProxy
    
    * Add innerText and textContent to reservedProps
    
    * Emit warning when assigning to read only properties in client
    
    * Revert "Emit warning when assigning to read only properties in client"
    
    This reverts commit 1a093e584ce50e2e634aa743e04f9cb8fc2b3f7d.
    
    * Emit warning when assigning to read only properties during hydration
    
    * yarn prettier-all
    
    * Gate hydration warning test on flag
    
    * Fix gating in hydration warning test
    
    * Fix assignment to boolean properties
    
    * Replace _listeners with random suffix matching
    
    * Improve gating for hydration warning test
    
    * Add outerText and outerHTML to server warning properties
    
    * remove nameLower logic
    
    * fix capture event listener test
    
    * Add coverage for changing custom event listeners
    
    * yarn prettier-all
    
    * yarn lint --fix
    
    * replace getCustomElementEventHandlersFromNode with getFiberCurrentPropsFromNode
    
    * Remove previous value when adding event listener
    
    * flow, lint, prettier
    
    * Add dispatchEvent to make sure nothing crashes
    
    * Add state change to reserved attribute tests
    
    * Add missing feature flag test gate
    
    * Reimplement SSR changes in ReactDOMServerFormatConfig
    
    * Test hydration for objects and functions
    
    * add missing test gate
    
    * remove extraneous comment
    
    * Add attribute->property test

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index b39d7c8ff5..6489151b05 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -1097,4 +1097,43 @@ describe('ReactDOMServer', () => {
         'However, it is set to a string.',
     );
   });
+
+  describe('custom element server rendering', () => {
+    it('String properties should be server rendered for custom elements', () => {
+      const output = ReactDOMServer.renderToString(
+        <my-custom-element foo="bar" />,
+      );
+      expect(output).toBe(`<my-custom-element foo="bar"></my-custom-element>`);
+    });
+
+    it('Number properties should be server rendered for custom elements', () => {
+      const output = ReactDOMServer.renderToString(
+        <my-custom-element foo={5} />,
+      );
+      expect(output).toBe(`<my-custom-element foo="5"></my-custom-element>`);
+    });
+
+    // @gate enableCustomElementPropertySupport
+    it('Object properties should not be server rendered for custom elements', () => {
+      const output = ReactDOMServer.renderToString(
+        <my-custom-element foo={{foo: 'bar'}} />,
+      );
+      expect(output).toBe(`<my-custom-element></my-custom-element>`);
+    });
+
+    // @gate enableCustomElementPropertySupport
+    it('Array properties should not be server rendered for custom elements', () => {
+      const output = ReactDOMServer.renderToString(
+        <my-custom-element foo={['foo', 'bar']} />,
+      );
+      expect(output).toBe(`<my-custom-element></my-custom-element>`);
+    });
+
+    it('Function properties should not be server rendered for custom elements', () => {
+      const output = ReactDOMServer.renderToString(
+        <my-custom-element foo={() => console.log('bar')} />,
+      );
+      expect(output).toBe(`<my-custom-element></my-custom-element>`);
+    });
+  });
 });

commit 8d0d0e9a8aadc4bdddff3a40871dbc54c63264f3
Author: Sebastian MarkbÃ¥ge <sebastian@calyptus.eu>
Date:   Thu Feb 24 20:09:03 2022 -0500

    Deprecate renderToNodeStream (and fix textarea bug) (#23359)
    
    * Deprecate renderToNodeStream
    
    * Use renderToPipeableStream in tests instead of renderToNodeStream
    
    This is the equivalent API. This means that we have way less test coverage
    of this API but I feel like that's fine since it has a deprecation warning
    in it and we have coverage on renderToString that is mostly the same.
    
    * Fix textarea bug
    
    The test changes revealed a bug with textarea. It happens because we
    currently always insert trailing comment nodes. We should optimize that
    away. However, we also don't really support complex children so we
    should toString it anyway which is what partial renderer used to do.
    
    * Update tests that assert number of nodes
    
    These tests are unnecessarily specific about number of nodes.
    
    I special case these, which these tests already do, because they're good
    tests to test that the optimization actually works later when we do
    fix it.

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index 6489151b05..0c057c5fad 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -569,7 +569,13 @@ describe('ReactDOMServer', () => {
   describe('renderToNodeStream', () => {
     it('should generate simple markup', () => {
       const SuccessfulElement = React.createElement(() => <img />);
-      const response = ReactDOMServer.renderToNodeStream(SuccessfulElement);
+      let response;
+      expect(() => {
+        response = ReactDOMServer.renderToNodeStream(SuccessfulElement);
+      }).toErrorDev(
+        'renderToNodeStream is deprecated. Use renderToPipeableStream instead.',
+        {withoutStack: true},
+      );
       expect(response.read().toString()).toMatch(new RegExp('<img' + '/>'));
     });
 
@@ -577,7 +583,13 @@ describe('ReactDOMServer', () => {
       const FailingElement = React.createElement(() => {
         throw new Error('An Error');
       });
-      const response = ReactDOMServer.renderToNodeStream(FailingElement);
+      let response;
+      expect(() => {
+        response = ReactDOMServer.renderToNodeStream(FailingElement);
+      }).toErrorDev(
+        'renderToNodeStream is deprecated. Use renderToPipeableStream instead.',
+        {withoutStack: true},
+      );
       return new Promise(resolve => {
         response.once('error', () => {
           resolve();

commit 392808a1f7fa2909492a742116ba8b549e862d70
Author: Andrew Clark <git@andrewclark.io>
Date:   Wed Apr 20 10:21:36 2022 -0400

    Land enableClientRenderFallbackOnTextMismatch flag (#24405)
    
    This flag is already enabled on all relevant surfaces. We can remove it.

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index 0c057c5fad..23be43a773 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -14,8 +14,6 @@ let React;
 let ReactDOMServer;
 let PropTypes;
 let ReactCurrentDispatcher;
-const enableSuspenseServerRenderer = require('shared/ReactFeatureFlags')
-  .enableSuspenseServerRenderer;
 
 describe('ReactDOMServer', () => {
   beforeEach(() => {
@@ -678,41 +676,6 @@ describe('ReactDOMServer', () => {
     expect(markup).toBe('<div></div>');
   });
 
-  if (!enableSuspenseServerRenderer) {
-    it('throws for unsupported types on the server', () => {
-      expect(() => {
-        ReactDOMServer.renderToString(<React.Suspense />);
-      }).toThrow('ReactDOMServer does not yet support Suspense.');
-
-      async function fakeImport(result) {
-        return {default: result};
-      }
-
-      expect(() => {
-        const LazyFoo = React.lazy(() =>
-          fakeImport(
-            new Promise(resolve =>
-              resolve(function Foo() {
-                return <div />;
-              }),
-            ),
-          ),
-        );
-        ReactDOMServer.renderToString(<LazyFoo />);
-      }).toThrow('ReactDOMServer does not yet support Suspense.');
-    });
-
-    it('throws when suspending on the server', () => {
-      function AsyncFoo() {
-        throw new Promise(() => {});
-      }
-
-      expect(() => {
-        ReactDOMServer.renderToString(<AsyncFoo />);
-      }).toThrow('ReactDOMServer does not yet support Suspense.');
-    });
-  }
-
   it('does not get confused by throwing null', () => {
     function Bad() {
       // eslint-disable-next-line no-throw-literal

commit b345523528f6b346c3a6de2145d5df6b2e23ca75
Author: Josh Story <story@hey.com>
Date:   Tue Jun 7 22:36:09 2022 -0700

    [Fizz] Support abort reasons (#24680)
    
    * [Fizz] Support abort reasons
    
    Fizz supports aborting the render but does not currently accept a reason. The various render functions that use Fizz have some automatic and some user-controlled abort semantics that can be useful to communicate with the running program and users about why an Abort happened.
    
    This change implements abort reasons for renderToReadableStream and renderToPipeable stream as well as legacy renderers such as renderToString and related implementations.
    
    For AbortController implementations the reason passed to the abort method is forwarded to Fizz and sent to the onError handler. If no reason is provided the AbortController should construct an AbortError DOMException and as a fallback Fizz will generate a similar error in the absence of a reason
    
    For pipeable  streams, an abort function is returned alongside pipe which already accepted a reason. That reason is now forwarded to Fizz and the implementation described above.
    
    For legacy renderers there is no exposed abort functionality but it is used internally and the reasons provided give useful context to, for instance to the fact that Suspense is not supported in renderToString-like renderers

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index 23be43a773..fed6988077 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -14,6 +14,7 @@ let React;
 let ReactDOMServer;
 let PropTypes;
 let ReactCurrentDispatcher;
+let useingPartialRenderer;
 
 describe('ReactDOMServer', () => {
   beforeEach(() => {
@@ -24,6 +25,8 @@ describe('ReactDOMServer', () => {
     ReactCurrentDispatcher =
       React.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED
         .ReactCurrentDispatcher;
+
+    useingPartialRenderer = global.__WWW__ && !__EXPERIMENTAL__;
   });
 
   describe('renderToString', () => {
@@ -562,6 +565,23 @@ describe('ReactDOMServer', () => {
         'Bad lazy',
       );
     });
+
+    it('aborts synchronously any suspended tasks and renders their fallbacks', () => {
+      const promise = new Promise(res => {});
+      function Suspender() {
+        throw promise;
+      }
+      const response = ReactDOMServer.renderToStaticMarkup(
+        <React.Suspense fallback={'fallback'}>
+          <Suspender />
+        </React.Suspense>,
+      );
+      if (useingPartialRenderer) {
+        expect(response).toEqual('<!--$!-->fallback<!--/$-->');
+      } else {
+        expect(response).toEqual('fallback');
+      }
+    });
   });
 
   describe('renderToNodeStream', () => {
@@ -618,6 +638,41 @@ describe('ReactDOMServer', () => {
         expect(response.read()).toBeNull();
       });
     });
+
+    it('should refer users to new apis when using suspense', async () => {
+      let resolve = null;
+      const promise = new Promise(res => {
+        resolve = () => {
+          resolved = true;
+          res();
+        };
+      });
+      let resolved = false;
+      function Suspender() {
+        if (resolved) {
+          return 'resolved';
+        }
+        throw promise;
+      }
+
+      let response;
+      expect(() => {
+        response = ReactDOMServer.renderToNodeStream(
+          <div>
+            <React.Suspense fallback={'fallback'}>
+              <Suspender />
+            </React.Suspense>
+          </div>,
+        );
+      }).toErrorDev(
+        'renderToNodeStream is deprecated. Use renderToPipeableStream instead.',
+        {withoutStack: true},
+      );
+      await resolve();
+      expect(response.read().toString()).toEqual(
+        '<div><!--$-->resolved<!-- --><!--/$--></div>',
+      );
+    });
   });
 
   it('warns with a no-op when an async setState is triggered', () => {

commit 95e22ff528c875b090de51a0fb0d83181c4d1111
Author: Andrew Clark <git@andrewclark.io>
Date:   Thu Jul 7 16:57:42 2022 -0400

    Delete Partial Renderer SSR implementation (#24868)
    
    This removes the old server rendering implementation (the "Partial Renderer").
    It was replaced in React 18 with a new streaming implementation (Fizz).
    
    We hadn't removed it from the codebase yet because Facebook hadn't finished
    rolling out Fizz in production; it's been behind a feature flag while we run
    performance tests and migrate our internal infrastructure.
    
    The diff to land Fizz will land imminently, and once it does, we can merge
    this commit.

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index fed6988077..c22846fa63 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -14,7 +14,6 @@ let React;
 let ReactDOMServer;
 let PropTypes;
 let ReactCurrentDispatcher;
-let useingPartialRenderer;
 
 describe('ReactDOMServer', () => {
   beforeEach(() => {
@@ -25,8 +24,6 @@ describe('ReactDOMServer', () => {
     ReactCurrentDispatcher =
       React.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED
         .ReactCurrentDispatcher;
-
-    useingPartialRenderer = global.__WWW__ && !__EXPERIMENTAL__;
   });
 
   describe('renderToString', () => {
@@ -576,11 +573,7 @@ describe('ReactDOMServer', () => {
           <Suspender />
         </React.Suspense>,
       );
-      if (useingPartialRenderer) {
-        expect(response).toEqual('<!--$!-->fallback<!--/$-->');
-      } else {
-        expect(response).toEqual('fallback');
-      }
+      expect(response).toEqual('fallback');
     });
   });
 

commit 9cdf8a99edcfd94d7420835ea663edca04237527
Author: Andrew Clark <git@andrewclark.io>
Date:   Tue Oct 18 11:19:24 2022 -0400

    [Codemod] Update copyright header to Meta (#25315)
    
    * Facebook -> Meta in copyright
    
    rg --files | xargs sed -i 's#Copyright (c) Facebook, Inc. and its affiliates.#Copyright (c) Meta Platforms, Inc. and affiliates.#g'
    
    * Manual tweaks

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index c22846fa63..4151a38024 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -1,5 +1,5 @@
 /**
- * Copyright (c) Facebook, Inc. and its affiliates.
+ * Copyright (c) Meta Platforms, Inc. and affiliates.
  *
  * This source code is licensed under the MIT license found in the
  * LICENSE file in the root directory of this source tree.

commit 6b3083266686f62b29462d32de75c6e71f7ba3e3
Author: Jan Kassens <jkassens@meta.com>
Date:   Tue Jan 31 08:25:05 2023 -0500

    Upgrade prettier (#26081)
    
    The old version of prettier we were using didn't support the Flow syntax
    to access properties in a type using `SomeType['prop']`. This updates
    `prettier` and `rollup-plugin-prettier` to the latest versions.
    
    I added the prettier config `arrowParens: "avoid"` to reduce the diff
    size as the default has changed in Prettier 2.0. The largest amount of
    changes comes from function expressions now having a space. This doesn't
    have an option to preserve the old behavior, so we have to update this.

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index 4151a38024..40c8248ee1 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -613,9 +613,8 @@ describe('ReactDOMServer', () => {
   describe('renderToStaticNodeStream', () => {
     it('should generate simple markup', () => {
       const SuccessfulElement = React.createElement(() => <img />);
-      const response = ReactDOMServer.renderToStaticNodeStream(
-        SuccessfulElement,
-      );
+      const response =
+        ReactDOMServer.renderToStaticNodeStream(SuccessfulElement);
       expect(response.read().toString()).toMatch(new RegExp('<img' + '/>'));
     });
 
@@ -682,9 +681,7 @@ describe('ReactDOMServer', () => {
     }
 
     ReactDOMServer.renderToString(<Foo />);
-    expect(() =>
-      jest.runOnlyPendingTimers(),
-    ).toErrorDev(
+    expect(() => jest.runOnlyPendingTimers()).toErrorDev(
       'Warning: setState(...): Can only update a mounting component.' +
         ' This usually means you called setState() outside componentWillMount() on the server.' +
         ' This is a no-op.\n\nPlease check the code for the Foo component.',
@@ -712,9 +709,7 @@ describe('ReactDOMServer', () => {
     }
 
     ReactDOMServer.renderToString(<Baz />);
-    expect(() =>
-      jest.runOnlyPendingTimers(),
-    ).toErrorDev(
+    expect(() => jest.runOnlyPendingTimers()).toErrorDev(
       'Warning: forceUpdate(...): Can only update a mounting component. ' +
         'This usually means you called forceUpdate() outside componentWillMount() on the server. ' +
         'This is a no-op.\n\nPlease check the code for the Baz component.',

commit 63346148603675f5d03509969007b7937cfddff2
Author: Andrew Clark <git@andrewclark.io>
Date:   Sat Mar 11 15:32:02 2023 -0500

    Add disableLegacyContext test gates where needed (#26371)
    
    The www builds include disableLegacyContext as a dynamic flag, so we
    should be running the tests in that mode, too. Previously we were
    overriding the flag during the test run. This strategy usually doesn't
    work because the flags get compiled out in the final build, but we
    happen to not test www in build mode, only source.
    
    To get of this hacky override, I added a test gate to every test that
    uses legacy context. When we eventually remove legacy context from the
    codebase, this should make it slightly easier to find which tests are
    affected. And removes one more hack from our hack-ridden test config.
    
    Given that sometimes www has features enabled that aren't on in other
    builds, we might want to consider testing its build artifacts in CI,
    rather than just source. That would have forced this cleanup to happen
    sooner. Currently we only test the public builds in CI.

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index 40c8248ee1..02f02187cb 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -340,6 +340,7 @@ describe('ReactDOMServer', () => {
       expect(markup).toContain('hello, world');
     });
 
+    // @gate !disableLegacyContext
     it('renders with context when using custom constructor', () => {
       class Component extends React.Component {
         constructor() {

commit 30e2938e04c8cf51688509a457a494d36bcc4269
Author: Rick Hanlon <rickhanlonii@gmail.com>
Date:   Tue Feb 6 12:43:27 2024 -0500

    [Tests] Reset modules by default (#28254)
    
    ## Overview
    
    Sets `resetModules: true` in the base Jest config, and deletes all the
    `jest.resetModule()` calls we don't need.

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index 02f02187cb..c2c89c8093 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -17,7 +17,6 @@ let ReactCurrentDispatcher;
 
 describe('ReactDOMServer', () => {
   beforeEach(() => {
-    jest.resetModules();
     React = require('react');
     PropTypes = require('prop-types');
     ReactDOMServer = require('react-dom/server');

commit 14fd9630ee04387f4361da289393234e2b7d93b6
Author: dan <dan.abramov@me.com>
Date:   Tue Feb 13 15:04:49 2024 +0000

    Switch <Context> to mean <Context.Provider> (#28226)
    
    Previously, `<Context>` was equivalent to `<Context.Consumer>`. However,
    since the introduction of Hooks, the `<Context.Consumer>` API is rarely
    used. The goal here is to make the common case cleaner:
    
    ```js
    const ThemeContext = createContext('light')
    
    function App() {
      return (
        <ThemeContext value="dark">
          ...
        </ThemeContext>
      )
    }
    
    function Button() {
      const theme = use(ThemeContext)
      // ...
    }
    ```
    
    This is technically a breaking change, but we've been warning about
    rendering `<Context>` directly for several years by now, so it's
    unlikely much code in the wild depends on the old behavior. [Proof that
    it warns today (check
    console).](https://codesandbox.io/p/sandbox/peaceful-nobel-pdxtfl)
    
    ---
    
    **The relevant commit is 5696782b428a5ace96e66c1857e13249b6c07958.** It
    switches `createContext` implementation so that `Context.Provider ===
    Context`.
    
    The main assumption that changed is that a Provider's fiber type is now
    the context itself (rather than an intermediate object). Whereas a
    Consumer's fiber type is now always an intermediate object (rather than
    it being sometimes the context itself and sometimes an intermediate
    object).
    
    My methodology was to start with the relevant symbols, work tags, and
    types, and work my way backwards to all usages.
    
    This might break tooling that depends on inspecting React's internal
    fields. I've added DevTools support in the second commit. This didn't
    need explicit versioningâ€”the structure tells us enough.

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index c2c89c8093..b95c20f9e3 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -1000,22 +1000,15 @@ describe('ReactDOMServer', () => {
     ]);
   });
 
+  // @gate enableRenderableContext || !__DEV__
   it('should warn if an invalid contextType is defined', () => {
     const Context = React.createContext();
-
     class ComponentA extends React.Component {
-      // It should warn for both Context.Consumer and Context.Provider
       static contextType = Context.Consumer;
       render() {
         return <div />;
       }
     }
-    class ComponentB extends React.Component {
-      static contextType = Context.Provider;
-      render() {
-        return <div />;
-      }
-    }
 
     expect(() => {
       ReactDOMServer.renderToString(<ComponentA />);
@@ -1028,13 +1021,14 @@ describe('ReactDOMServer', () => {
     // Warnings should be deduped by component type
     ReactDOMServer.renderToString(<ComponentA />);
 
-    expect(() => {
-      ReactDOMServer.renderToString(<ComponentB />);
-    }).toErrorDev(
-      'Warning: ComponentB defines an invalid contextType. ' +
-        'contextType should point to the Context object returned by React.createContext(). ' +
-        'Did you accidentally pass the Context.Provider instead?',
-    );
+    class ComponentB extends React.Component {
+      static contextType = Context.Provider;
+      render() {
+        return <div />;
+      }
+    }
+    // Does not warn because Context === Context.Provider.
+    ReactDOMServer.renderToString(<ComponentB />);
   });
 
   it('should not warn when class contextType is null', () => {

commit 015ff2ed66c1d164111752263682d1d757c97f3e
Author: Andrew Clark <git@andrewclark.io>
Date:   Tue Feb 13 11:39:45 2024 -0500

    Revert "[Tests] Reset modules by default" (#28318)
    
    This was causing a slowdown in one of the tests
    ESLintRuleExhaustiveDeps-test.js. Reverting until we figure out why.

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index b95c20f9e3..3b398a47fe 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -17,6 +17,7 @@ let ReactCurrentDispatcher;
 
 describe('ReactDOMServer', () => {
   beforeEach(() => {
+    jest.resetModules();
     React = require('react');
     PropTypes = require('prop-types');
     ReactDOMServer = require('react-dom/server');

commit d579e7748218920331252b0528850943d5e2dd31
Author: Sebastian MarkbÃ¥ge <sebastian@calyptus.eu>
Date:   Fri Feb 23 15:16:54 2024 -0500

    Remove method name prefix from warnings and errors (#28432)
    
    This pattern is a petpeeve of mine. I don't consider this best practice
    and so most don't have these prefixes. Very inconsistent.
    
    At best this is useless and noisey that you have to parse because the
    information is also in the stack trace.
    
    At worse these are misleading because they're highlighting something
    internal (like validateDOMNesting) which even suggests an internal bug.
    Even the ones public to React aren't necessarily what you called because
    you might be calling a wrapper around it.
    
    That would be properly reflected in a stack trace - which can also
    properly ignore list so that the first stack you see is your callsite,
    
    Which might be like `render()` in react-testing-library rather than
    `createRoot()` for example.

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index 3b398a47fe..07654a9f13 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -683,7 +683,7 @@ describe('ReactDOMServer', () => {
 
     ReactDOMServer.renderToString(<Foo />);
     expect(() => jest.runOnlyPendingTimers()).toErrorDev(
-      'Warning: setState(...): Can only update a mounting component.' +
+      'Warning: Can only update a mounting component.' +
         ' This usually means you called setState() outside componentWillMount() on the server.' +
         ' This is a no-op.\n\nPlease check the code for the Foo component.',
       {withoutStack: true},
@@ -711,7 +711,7 @@ describe('ReactDOMServer', () => {
 
     ReactDOMServer.renderToString(<Baz />);
     expect(() => jest.runOnlyPendingTimers()).toErrorDev(
-      'Warning: forceUpdate(...): Can only update a mounting component. ' +
+      'Warning: Can only update a mounting component. ' +
         'This usually means you called forceUpdate() outside componentWillMount() on the server. ' +
         'This is a no-op.\n\nPlease check the code for the Baz component.',
       {withoutStack: true},

commit c47fee55d9886b2d9746a4b71c48bbd8b8ac9d3a
Author: Josh Story <story@hey.com>
Date:   Thu Mar 21 11:03:09 2024 -0700

    [Fizz][Legacy] use static markup mode for renderToStaticNodeStream (#28606)
    
    Since it was first implemented renderToStaticNodeStream never correctly
    set the renderer state to mark the output as static markup which means
    it was functionally the same as renderToNodeStream. This change fixes
    this oversight. While we are removing renderToNodeStream in a future
    version we never did deprecate the static version of this API because it
    has no immediate analog in the modern APIs.

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index 07654a9f13..ec962ef8ba 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -609,6 +609,41 @@ describe('ReactDOMServer', () => {
         expect(response.read()).toBeNull();
       });
     });
+
+    it('should refer users to new apis when using suspense', async () => {
+      let resolve = null;
+      const promise = new Promise(res => {
+        resolve = () => {
+          resolved = true;
+          res();
+        };
+      });
+      let resolved = false;
+      function Suspender() {
+        if (resolved) {
+          return 'resolved';
+        }
+        throw promise;
+      }
+
+      let response;
+      expect(() => {
+        response = ReactDOMServer.renderToNodeStream(
+          <div>
+            <React.Suspense fallback={'fallback'}>
+              <Suspender />
+            </React.Suspense>
+          </div>,
+        );
+      }).toErrorDev(
+        'renderToNodeStream is deprecated. Use renderToPipeableStream instead.',
+        {withoutStack: true},
+      );
+      await resolve();
+      expect(response.read().toString()).toEqual(
+        '<div><!--$-->resolved<!-- --><!--/$--></div>',
+      );
+    });
   });
 
   describe('renderToStaticNodeStream', () => {
@@ -632,7 +667,7 @@ describe('ReactDOMServer', () => {
       });
     });
 
-    it('should refer users to new apis when using suspense', async () => {
+    it('should omit text and suspense placeholders', async () => {
       let resolve = null;
       const promise = new Promise(res => {
         resolve = () => {
@@ -648,23 +683,15 @@ describe('ReactDOMServer', () => {
         throw promise;
       }
 
-      let response;
-      expect(() => {
-        response = ReactDOMServer.renderToNodeStream(
-          <div>
-            <React.Suspense fallback={'fallback'}>
-              <Suspender />
-            </React.Suspense>
-          </div>,
-        );
-      }).toErrorDev(
-        'renderToNodeStream is deprecated. Use renderToPipeableStream instead.',
-        {withoutStack: true},
+      const response = ReactDOMServer.renderToStaticNodeStream(
+        <div>
+          <React.Suspense fallback={'fallback'}>
+            <Suspender />
+          </React.Suspense>
+        </div>,
       );
       await resolve();
-      expect(response.read().toString()).toEqual(
-        '<div><!--$-->resolved<!-- --><!--/$--></div>',
-      );
+      expect(response.read().toString()).toEqual('<div>resolved</div>');
     });
   });
 

commit 8436bcca6287077a5409b3c9180f8af0361b16a5
Author: Josh Story <story@hey.com>
Date:   Wed Mar 27 12:02:36 2024 -0700

    [Fizz][Legacy] Remove renderToNodeStream (#28607)
    
    Stacked on #28606
    
    renderToNodeStream has been deprecated since React 18 with a warning
    indicating users should upgrade to renderToPipeableStream. This change
    removes renderToNodeStream

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index ec962ef8ba..bd70b81d2a 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -578,74 +578,6 @@ describe('ReactDOMServer', () => {
     });
   });
 
-  describe('renderToNodeStream', () => {
-    it('should generate simple markup', () => {
-      const SuccessfulElement = React.createElement(() => <img />);
-      let response;
-      expect(() => {
-        response = ReactDOMServer.renderToNodeStream(SuccessfulElement);
-      }).toErrorDev(
-        'renderToNodeStream is deprecated. Use renderToPipeableStream instead.',
-        {withoutStack: true},
-      );
-      expect(response.read().toString()).toMatch(new RegExp('<img' + '/>'));
-    });
-
-    it('should handle errors correctly', () => {
-      const FailingElement = React.createElement(() => {
-        throw new Error('An Error');
-      });
-      let response;
-      expect(() => {
-        response = ReactDOMServer.renderToNodeStream(FailingElement);
-      }).toErrorDev(
-        'renderToNodeStream is deprecated. Use renderToPipeableStream instead.',
-        {withoutStack: true},
-      );
-      return new Promise(resolve => {
-        response.once('error', () => {
-          resolve();
-        });
-        expect(response.read()).toBeNull();
-      });
-    });
-
-    it('should refer users to new apis when using suspense', async () => {
-      let resolve = null;
-      const promise = new Promise(res => {
-        resolve = () => {
-          resolved = true;
-          res();
-        };
-      });
-      let resolved = false;
-      function Suspender() {
-        if (resolved) {
-          return 'resolved';
-        }
-        throw promise;
-      }
-
-      let response;
-      expect(() => {
-        response = ReactDOMServer.renderToNodeStream(
-          <div>
-            <React.Suspense fallback={'fallback'}>
-              <Suspender />
-            </React.Suspense>
-          </div>,
-        );
-      }).toErrorDev(
-        'renderToNodeStream is deprecated. Use renderToPipeableStream instead.',
-        {withoutStack: true},
-      );
-      await resolve();
-      expect(response.read().toString()).toEqual(
-        '<div><!--$-->resolved<!-- --><!--/$--></div>',
-      );
-    });
-  });
-
   describe('renderToStaticNodeStream', () => {
     it('should generate simple markup', () => {
       const SuccessfulElement = React.createElement(() => <img />);

commit eb510a33048fabd95d272b1c0b65f941e2909240
Author: Andrey Lunyov <alunyov@meta.com>
Date:   Fri Mar 29 13:06:07 2024 -0400

    Land enableCustomElementPropertySupport for React 19 (#27450)
    
    We've rolled out this flag internally on WWW. This PR removed flag
    `enableCustomElementPropertySupport`
    
    Test plan:
     -- `yarn test`
    
    Co-authored-by: Ricky Hanlon <rickhanlonii@gmail.com>

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index bd70b81d2a..efacdb8be9 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -1085,7 +1085,6 @@ describe('ReactDOMServer', () => {
       expect(output).toBe(`<my-custom-element foo="5"></my-custom-element>`);
     });
 
-    // @gate enableCustomElementPropertySupport
     it('Object properties should not be server rendered for custom elements', () => {
       const output = ReactDOMServer.renderToString(
         <my-custom-element foo={{foo: 'bar'}} />,
@@ -1093,7 +1092,6 @@ describe('ReactDOMServer', () => {
       expect(output).toBe(`<my-custom-element></my-custom-element>`);
     });
 
-    // @gate enableCustomElementPropertySupport
     it('Array properties should not be server rendered for custom elements', () => {
       const output = ReactDOMServer.renderToString(
         <my-custom-element foo={['foo', 'bar']} />,

commit d50323eb845c5fde0d720cae888bf35dedd05506
Author: Sebastian MarkbÃ¥ge <sebastian@calyptus.eu>
Date:   Mon Apr 8 19:23:23 2024 -0400

    Flatten ReactSharedInternals (#28783)
    
    This is similar to #28771 but for isomorphic. We need a make over for
    these dispatchers anyway so this is the first step. Also helps flush out
    some internals usage that will break anyway.
    
    It flattens the inner mutable objects onto the ReactSharedInternals.

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index efacdb8be9..3dd1ca5ac3 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -13,7 +13,7 @@
 let React;
 let ReactDOMServer;
 let PropTypes;
-let ReactCurrentDispatcher;
+let ReactSharedInternals;
 
 describe('ReactDOMServer', () => {
   beforeEach(() => {
@@ -21,9 +21,8 @@ describe('ReactDOMServer', () => {
     React = require('react');
     PropTypes = require('prop-types');
     ReactDOMServer = require('react-dom/server');
-    ReactCurrentDispatcher =
-      React.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED
-        .ReactCurrentDispatcher;
+    ReactSharedInternals =
+      React.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;
   });
 
   describe('renderToString', () => {
@@ -420,7 +419,7 @@ describe('ReactDOMServer', () => {
       const Context = React.createContext(0);
 
       function readContext(context) {
-        return ReactCurrentDispatcher.current.readContext(context);
+        return ReactSharedInternals.H.readContext(context);
       }
 
       function Consumer(props) {

commit f6131653570bbbf62d642ba9343b9cd0ab1ae97c
Author: Sebastian MarkbÃ¥ge <sebastian@calyptus.eu>
Date:   Tue Apr 9 12:20:22 2024 -0400

    Rename SECRET INTERNALS to `__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE` (#28789)
    
    Follow up to #28783 and #28786.
    
    Since we've changed the implementations of these we can rename them to
    something a bit more descriptive while we're at it, since anyone
    depending on them will need to upgrade their code anyway.
    
    "react" with no condition:
    `__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE`
    "react" with "react-server" condition:
    `__SERVER_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE`
    "react-dom":
    `__DOM_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE`

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index 3dd1ca5ac3..d2590e21f7 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -22,7 +22,7 @@ describe('ReactDOMServer', () => {
     PropTypes = require('prop-types');
     ReactDOMServer = require('react-dom/server');
     ReactSharedInternals =
-      React.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;
+      React.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE;
   });
 
   describe('renderToString', () => {

commit d329ff9d9e87f3f909f98cf63701ef3795cf2584
Author: Josh Story <story@hey.com>
Date:   Thu Apr 18 18:33:53 2024 -0700

    Deprecate `renderToStaticNodeStream` (#28872)
    
    This commit adds warnings indicating that `renderToStaticNodeStream`
    will be removed in an upcoming React release. This API has been legacy,
    is not widely used (renderToStaticMarkup is more common) and has
    semantically eqiuvalent implementations with renderToReadableStream and
    renderToPipeableStream.

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index d2590e21f7..ab200d1051 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -580,16 +580,28 @@ describe('ReactDOMServer', () => {
   describe('renderToStaticNodeStream', () => {
     it('should generate simple markup', () => {
       const SuccessfulElement = React.createElement(() => <img />);
-      const response =
-        ReactDOMServer.renderToStaticNodeStream(SuccessfulElement);
-      expect(response.read().toString()).toMatch(new RegExp('<img' + '/>'));
+      expect(() => {
+        const response =
+          ReactDOMServer.renderToStaticNodeStream(SuccessfulElement);
+        expect(response.read().toString()).toMatch(new RegExp('<img' + '/>'));
+      }).toErrorDev(
+        'ReactDOMServer.renderToStaticNodeStream() is deprecated and will be removed in an upcomingrelease of React',
+        {withoutStack: true},
+      );
     });
 
     it('should handle errors correctly', () => {
       const FailingElement = React.createElement(() => {
         throw new Error('An Error');
       });
-      const response = ReactDOMServer.renderToStaticNodeStream(FailingElement);
+
+      let response;
+      expect(() => {
+        response = ReactDOMServer.renderToStaticNodeStream(FailingElement);
+      }).toErrorDev(
+        'ReactDOMServer.renderToStaticNodeStream() is deprecated and will be removed in an upcomingrelease of React',
+        {withoutStack: true},
+      );
       return new Promise(resolve => {
         response.once('error', () => {
           resolve();
@@ -614,12 +626,18 @@ describe('ReactDOMServer', () => {
         throw promise;
       }
 
-      const response = ReactDOMServer.renderToStaticNodeStream(
-        <div>
-          <React.Suspense fallback={'fallback'}>
-            <Suspender />
-          </React.Suspense>
-        </div>,
+      let response;
+      expect(() => {
+        response = ReactDOMServer.renderToStaticNodeStream(
+          <div>
+            <React.Suspense fallback={'fallback'}>
+              <Suspender />
+            </React.Suspense>
+          </div>,
+        );
+      }).toErrorDev(
+        'ReactDOMServer.renderToStaticNodeStream() is deprecated and will be removed in an upcomingrelease of React',
+        {withoutStack: true},
       );
       await resolve();
       expect(response.read().toString()).toEqual('<div>resolved</div>');

commit 33a32441e991e126e5e874f831bd3afc237a3ecf
Author: Josh Story <story@hey.com>
Date:   Thu Apr 18 21:06:04 2024 -0700

    Remove `renderToStaticNodeStream` (#28873)
    
    Stacked on #28872
    
    renderToStaticNodeStream was not originally deprecated when
    renderToNodeStream was deprecated because it did not yet have a clear
    analog in the modern streaming implementation for SSR. In React 19 we
    have already removed renderToNodeStream. This change removes
    renderToStaticNodeStream as well because you can replicate it's
    semantics using renderToPipeableStream with onAllReady or
    renderToReadableStream with await stream.allready.

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index ab200d1051..b964656c5c 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -577,73 +577,6 @@ describe('ReactDOMServer', () => {
     });
   });
 
-  describe('renderToStaticNodeStream', () => {
-    it('should generate simple markup', () => {
-      const SuccessfulElement = React.createElement(() => <img />);
-      expect(() => {
-        const response =
-          ReactDOMServer.renderToStaticNodeStream(SuccessfulElement);
-        expect(response.read().toString()).toMatch(new RegExp('<img' + '/>'));
-      }).toErrorDev(
-        'ReactDOMServer.renderToStaticNodeStream() is deprecated and will be removed in an upcomingrelease of React',
-        {withoutStack: true},
-      );
-    });
-
-    it('should handle errors correctly', () => {
-      const FailingElement = React.createElement(() => {
-        throw new Error('An Error');
-      });
-
-      let response;
-      expect(() => {
-        response = ReactDOMServer.renderToStaticNodeStream(FailingElement);
-      }).toErrorDev(
-        'ReactDOMServer.renderToStaticNodeStream() is deprecated and will be removed in an upcomingrelease of React',
-        {withoutStack: true},
-      );
-      return new Promise(resolve => {
-        response.once('error', () => {
-          resolve();
-        });
-        expect(response.read()).toBeNull();
-      });
-    });
-
-    it('should omit text and suspense placeholders', async () => {
-      let resolve = null;
-      const promise = new Promise(res => {
-        resolve = () => {
-          resolved = true;
-          res();
-        };
-      });
-      let resolved = false;
-      function Suspender() {
-        if (resolved) {
-          return 'resolved';
-        }
-        throw promise;
-      }
-
-      let response;
-      expect(() => {
-        response = ReactDOMServer.renderToStaticNodeStream(
-          <div>
-            <React.Suspense fallback={'fallback'}>
-              <Suspender />
-            </React.Suspense>
-          </div>,
-        );
-      }).toErrorDev(
-        'ReactDOMServer.renderToStaticNodeStream() is deprecated and will be removed in an upcomingrelease of React',
-        {withoutStack: true},
-      );
-      await resolve();
-      expect(response.read().toString()).toEqual('<div>resolved</div>');
-    });
-  });
-
   it('warns with a no-op when an async setState is triggered', () => {
     class Foo extends React.Component {
       UNSAFE_componentWillMount() {

commit 84239da896fd7395a667ab1e7ef1ef338a32de8f
Author: Sebastian MarkbÃ¥ge <sebastian@calyptus.eu>
Date:   Thu May 23 12:48:57 2024 -0400

    Move createElement/JSX Warnings into the Renderer (#29088)
    
    This is necessary to simplify the component stack handling to make way
    for owner stacks. It also solves some hacks that we used to have but
    don't quite make sense. It also solves the problem where things like key
    warnings get silenced in RSC because they get deduped. It also surfaces
    areas where we were missing key warnings to begin with.
    
    Almost every type of warning is issued from the renderer. React Elements
    are really not anything special themselves. They're just lazily invoked
    functions and its really the renderer that determines there semantics.
    
    We have three types of warnings that previously fired in
    JSX/createElement:
    
    - Fragment props validation.
    - Type validation.
    - Key warning.
    
    It's nice to be able to do some validation in the JSX/createElement
    because it has a more specific stack frame at the callsite. However,
    that's the case for every type of component and validation. That's the
    whole point of enableOwnerStacks. It's also not sufficient to do it in
    JSX/createElement so we also have validation in the renderers too. So
    this validation is really just an eager validation but also happens
    again later.
    
    The problem with these is that we don't really know what types are valid
    until we get to the renderer. Additionally, by placing it in the
    isomorphic code it becomes harder to do deduping of warnings in a way
    that makes sense for that renderer. It also means we can't reuse logic
    for managing stacks etc.
    
    Fragment props validation really should just be part of the renderer
    like any other component type. This also matters once we add Fragment
    refs and other fragment features. So I moved this into Fiber. However,
    since some Fragments don't have Fibers, I do the validation in
    ChildFiber instead of beginWork where it would normally happen.
    
    For `type` validation we already do validation when rendering. By
    leaving it to the renderer we don't have to hard code an extra list.
    This list also varies by context. E.g. class components aren't allowed
    in RSC but client references are but we don't have an isomorphic way to
    identify client references because they're defined by the host config so
    the current logic is flawed anyway. I kept the early validation for now
    without the `enableOwnerStacks` since it does provide a nicer stack
    frame but with that flag on it'll be handled with nice stacks anyway. I
    normalized some of the errors to ensure tests pass.
    
    For `key` validation it's the same principle. The mechanism for the
    heuristic is still the same - if it passes statically through a parent
    JSX/createElement call then it's considered validated. We already did
    print the error later from the renderer so this also disables the early
    log in the `enableOwnerStacks` flag.
    
    I also added logging to Fizz so that key warnings can print in SSR logs.
    
    Flight is a bit more complex. For elements that end up on the client we
    just pass the `validated` flag along to the client and let the client
    renderer print the error once rendered. For server components we log the
    error from Flight with the server component as the owner on the stack
    which will allow us to print the right stack for context. The factoring
    of this is a little tricky because we only want to warn if it's in an
    array parent but we want to log the error later to get the right debug
    info.
    
    Fiber/Fizz has a similar factoring problem that causes us to create a
    fake Fiber for the owner which means the logs won't be associated with
    the right place in DevTools.

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index b964656c5c..d58cc83947 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -819,7 +819,7 @@ describe('ReactDOMServer', () => {
     }
 
     function Child() {
-      return [<A key="1" />, <B key="2" />, <span ariaTypo2="no" />];
+      return [<A key="1" />, <B key="2" />, <span ariaTypo2="no" key="3" />];
     }
 
     function App() {

commit 277420803947724b43c47bbc47d3a353553868f1
Author: Sebastian MarkbÃ¥ge <sebastian@calyptus.eu>
Date:   Mon Jun 10 18:41:56 2024 -0400

    Remove Warning: prefix and toString on console Arguments (#29839)
    
    Basically make `console.error` and `console.warn` behave like normal -
    when a component stack isn't appended. I need this because I need to be
    able to print rich logs with the component stack option and to be able
    to disable instrumentation completely in `console.createTask`
    environments that don't need it.
    
    Currently we can't print logs with richer objects because they're
    toString:ed first. In practice, pretty much all arguments we log are
    already toString:ed so it's not necessary anyway. Some might be like a
    number. So it would only be a problem if some environment can't handle
    proper consoles but then it's up to that environment to toString it
    before logging.
    
    The `Warning: ` prefix is historic and is both noisy and confusing. It's
    mostly unnecessary since the UI surrounding `console.error` and
    `console.warn` tend to have visual treatment around it anyway. However,
    it's actively misleading when `console.error` gets prefixed with a
    Warning that we consider an error level. There's an argument to be made
    that some of our `console.error` don't make the bar for an error but
    then the argument is to downgrade each of those to `console.warn` - not
    to brand all our actual error logging with `Warning: `.
    
    Apparently something needs to change in React Native before landing this
    because it depends on the prefix somehow which probably doesn't make
    sense already.

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index d58cc83947..a414886006 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -592,7 +592,7 @@ describe('ReactDOMServer', () => {
 
     ReactDOMServer.renderToString(<Foo />);
     expect(() => jest.runOnlyPendingTimers()).toErrorDev(
-      'Warning: Can only update a mounting component.' +
+      'Can only update a mounting component.' +
         ' This usually means you called setState() outside componentWillMount() on the server.' +
         ' This is a no-op.\n\nPlease check the code for the Foo component.',
       {withoutStack: true},
@@ -620,7 +620,7 @@ describe('ReactDOMServer', () => {
 
     ReactDOMServer.renderToString(<Baz />);
     expect(() => jest.runOnlyPendingTimers()).toErrorDev(
-      'Warning: Can only update a mounting component. ' +
+      'Can only update a mounting component. ' +
         'This usually means you called forceUpdate() outside componentWillMount() on the server. ' +
         'This is a no-op.\n\nPlease check the code for the Baz component.',
       {withoutStack: true},
@@ -732,11 +732,11 @@ describe('ReactDOMServer', () => {
         </div>,
       ),
     ).toErrorDev([
-      'Warning: <inPUT /> is using incorrect casing. ' +
+      '<inPUT /> is using incorrect casing. ' +
         'Use PascalCase for React components, ' +
         'or lowercase for HTML elements.',
       // linearGradient doesn't warn
-      'Warning: <iFrame /> is using incorrect casing. ' +
+      '<iFrame /> is using incorrect casing. ' +
         'Use PascalCase for React components, ' +
         'or lowercase for HTML elements.',
     ]);
@@ -746,7 +746,7 @@ describe('ReactDOMServer', () => {
     expect(() =>
       ReactDOMServer.renderToString(<div contentEditable={true} children="" />),
     ).toErrorDev(
-      'Warning: A component is `contentEditable` and contains `children` ' +
+      'A component is `contentEditable` and contains `children` ' +
         'managed by React. It is now your responsibility to guarantee that ' +
         'none of those nodes are unexpectedly modified or duplicated. This ' +
         'is probably not intentional.\n    in div (at **)',
@@ -765,7 +765,7 @@ describe('ReactDOMServer', () => {
         ReactDOMServer.renderToString(<ClassWithRenderNotExtended />),
       ).toThrow(TypeError);
     }).toErrorDev(
-      'Warning: The <ClassWithRenderNotExtended /> component appears to have a render method, ' +
+      'The <ClassWithRenderNotExtended /> component appears to have a render method, ' +
         "but doesn't extend React.Component. This is likely to cause errors. " +
         'Change ClassWithRenderNotExtended to extend React.Component instead.',
     );
@@ -923,7 +923,7 @@ describe('ReactDOMServer', () => {
     expect(() => {
       ReactDOMServer.renderToString(<ComponentA />);
     }).toErrorDev(
-      'Warning: ComponentA defines an invalid contextType. ' +
+      'ComponentA defines an invalid contextType. ' +
         'contextType should point to the Context object returned by React.createContext(). ' +
         'Did you accidentally pass the Context.Consumer instead?',
     );

commit 315109b02b0c9460b7466ca88f3f4d6ed1215a21
Author: Sebastian MarkbÃ¥ge <sebastian@calyptus.eu>
Date:   Mon Jul 1 10:27:52 2024 -0400

    [Fizz] Enable owner stacks for SSR (#30152)
    
    Stacked on #30142.
    
    This tracks owners and their stacks in DEV in Fizz. We use the
    ComponentStackNode as the data structure to track this information -
    effectively like ReactComponentInfo (Server) or Fiber (Client). They're
    the instance.
    
    I then port them same logic from ReactFiberComponentStack,
    ReactFiberOwnerStack and ReactFiberCallUserSpace to Fizz equivalents.
    
    This gets us both owner stacks from `captureOwnerStack()`, as well as
    appended to console.errors logged by Fizz, while rendering and in
    onError.

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index a414886006..065f7cadd7 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -835,21 +835,30 @@ describe('ReactDOMServer', () => {
 
     expect(() => ReactDOMServer.renderToString(<App />)).toErrorDev([
       'Invalid ARIA attribute `ariaTypo`. ARIA attributes follow the pattern aria-* and must be lowercase.\n' +
-        '    in span (at **)\n' +
-        '    in b (at **)\n' +
-        '    in C (at **)\n' +
-        '    in font (at **)\n' +
-        '    in B (at **)\n' +
-        '    in Child (at **)\n' +
-        '    in span (at **)\n' +
-        '    in div (at **)\n' +
-        '    in App (at **)',
+        (gate(flags => flags.enableOwnerStacks)
+          ? '    in span (at **)\n' +
+            '    in B (at **)\n' +
+            '    in Child (at **)\n' +
+            '    in App (at **)'
+          : '    in span (at **)\n' +
+            '    in b (at **)\n' +
+            '    in C (at **)\n' +
+            '    in font (at **)\n' +
+            '    in B (at **)\n' +
+            '    in Child (at **)\n' +
+            '    in span (at **)\n' +
+            '    in div (at **)\n' +
+            '    in App (at **)'),
       'Invalid ARIA attribute `ariaTypo2`. ARIA attributes follow the pattern aria-* and must be lowercase.\n' +
-        '    in span (at **)\n' +
-        '    in Child (at **)\n' +
-        '    in span (at **)\n' +
-        '    in div (at **)\n' +
-        '    in App (at **)',
+        (gate(flags => flags.enableOwnerStacks)
+          ? '    in span (at **)\n' +
+            '    in Child (at **)\n' +
+            '    in App (at **)'
+          : '    in span (at **)\n' +
+            '    in Child (at **)\n' +
+            '    in span (at **)\n' +
+            '    in div (at **)\n' +
+            '    in App (at **)'),
     ]);
   });
 
@@ -885,9 +894,11 @@ describe('ReactDOMServer', () => {
     expect(() => ReactDOMServer.renderToString(<App />)).toErrorDev([
       // ReactDOMServer(App > div > span)
       'Invalid ARIA attribute `ariaTypo`. ARIA attributes follow the pattern aria-* and must be lowercase.\n' +
-        '    in span (at **)\n' +
-        '    in div (at **)\n' +
-        '    in App (at **)',
+        (gate(flags => flags.enableOwnerStacks)
+          ? '    in span (at **)\n' + '    in App (at **)'
+          : '    in span (at **)\n' +
+            '    in div (at **)\n' +
+            '    in App (at **)'),
       // ReactDOMServer(App > div > Child) >>> ReactDOMServer(App2) >>> ReactDOMServer(blink)
       'Invalid ARIA attribute `ariaTypo2`. ARIA attributes follow the pattern aria-* and must be lowercase.\n' +
         '    in blink (at **)',
@@ -898,15 +909,21 @@ describe('ReactDOMServer', () => {
         '    in App2 (at **)',
       // ReactDOMServer(App > div > Child > span)
       'Invalid ARIA attribute `ariaTypo4`. ARIA attributes follow the pattern aria-* and must be lowercase.\n' +
-        '    in span (at **)\n' +
-        '    in Child (at **)\n' +
-        '    in div (at **)\n' +
-        '    in App (at **)',
+        (gate(flags => flags.enableOwnerStacks)
+          ? '    in span (at **)\n' +
+            '    in Child (at **)\n' +
+            '    in App (at **)'
+          : '    in span (at **)\n' +
+            '    in Child (at **)\n' +
+            '    in div (at **)\n' +
+            '    in App (at **)'),
       // ReactDOMServer(App > div > font)
       'Invalid ARIA attribute `ariaTypo5`. ARIA attributes follow the pattern aria-* and must be lowercase.\n' +
-        '    in font (at **)\n' +
-        '    in div (at **)\n' +
-        '    in App (at **)',
+        (gate(flags => flags.enableOwnerStacks)
+          ? '    in font (at **)\n' + '    in App (at **)'
+          : '    in font (at **)\n' +
+            '    in div (at **)\n' +
+            '    in App (at **)'),
     ]);
   });
 

commit 378b305958eb7259cacfce8ad0e66eec07e07074
Author: Jan Kassens <jkassens@meta.com>
Date:   Wed Jul 10 11:53:00 2024 -0400

    Warn about legacy context when legacy context is not disabled (#30297)
    
    For environments that still have legacy contexts available, this adds a
    warning to make the remaining call sites easier to locate and encourage
    upgrades.

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index 065f7cadd7..71e6ce7224 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -371,11 +371,17 @@ describe('ReactDOMServer', () => {
         text: PropTypes.string,
       };
 
-      const markup = ReactDOMServer.renderToStaticMarkup(
-        <ContextProvider>
-          <Component />
-        </ContextProvider>,
-      );
+      let markup;
+      expect(() => {
+        markup = ReactDOMServer.renderToStaticMarkup(
+          <ContextProvider>
+            <Component />
+          </ContextProvider>,
+        );
+      }).toErrorDev([
+        'ContextProvider uses the legacy childContextTypes API which will soon be removed. Use React.createContext() instead.',
+        'Component uses the legacy contextTypes API which will soon be removed. Use React.createContext() with static contextType instead.',
+      ]);
       expect(markup).toContain('hello, world');
     });
 

commit 03e4ec2d0fe7cd854d28634ba035dc8996ff244d
Author: Rick Hanlon <rickhanlonii@gmail.com>
Date:   Sun Jan 5 17:10:29 2025 -0500

    [assert helpers] react-dom (pt3) (#31983)
    
    moar assert helpers
    
    this finishes all of react-dom except the server integration tests which
    are tricky to convert

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index 71e6ce7224..cbcf06892a 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -14,6 +14,7 @@ let React;
 let ReactDOMServer;
 let PropTypes;
 let ReactSharedInternals;
+let assertConsoleErrorDev;
 
 describe('ReactDOMServer', () => {
   beforeEach(() => {
@@ -21,6 +22,8 @@ describe('ReactDOMServer', () => {
     React = require('react');
     PropTypes = require('prop-types');
     ReactDOMServer = require('react-dom/server');
+    assertConsoleErrorDev =
+      require('internal-test-utils').assertConsoleErrorDev;
     ReactSharedInternals =
       React.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE;
   });
@@ -159,15 +162,18 @@ describe('ReactDOMServer', () => {
     });
 
     it('should not crash on poisoned hasOwnProperty', () => {
-      let html;
-      expect(
-        () =>
-          (html = ReactDOMServer.renderToString(
-            <div hasOwnProperty="poison">
-              <span unknown="test" />
-            </div>,
-          )),
-      ).toErrorDev(['React does not recognize the `hasOwnProperty` prop']);
+      const html = ReactDOMServer.renderToString(
+        <div hasOwnProperty="poison">
+          <span unknown="test" />
+        </div>,
+      );
+      assertConsoleErrorDev([
+        'React does not recognize the `hasOwnProperty` prop on a DOM element. ' +
+          'If you intentionally want it to appear in the DOM as a custom attribute, ' +
+          'spell it as lowercase `hasownproperty` instead. ' +
+          'If you accidentally passed it from a parent component, remove it from the DOM element.\n' +
+          '    in div (at **)',
+      ]);
       expect(html).toContain('<span unknown="test">');
     });
   });
@@ -371,16 +377,18 @@ describe('ReactDOMServer', () => {
         text: PropTypes.string,
       };
 
-      let markup;
-      expect(() => {
-        markup = ReactDOMServer.renderToStaticMarkup(
-          <ContextProvider>
-            <Component />
-          </ContextProvider>,
-        );
-      }).toErrorDev([
-        'ContextProvider uses the legacy childContextTypes API which will soon be removed. Use React.createContext() instead.',
-        'Component uses the legacy contextTypes API which will soon be removed. Use React.createContext() with static contextType instead.',
+      const markup = ReactDOMServer.renderToStaticMarkup(
+        <ContextProvider>
+          <Component />
+        </ContextProvider>,
+      );
+      assertConsoleErrorDev([
+        'ContextProvider uses the legacy childContextTypes API which will soon be removed. ' +
+          'Use React.createContext() instead. (https://react.dev/link/legacy-context)\n' +
+          '    in ContextProvider (at **)',
+        'Component uses the legacy contextTypes API which will soon be removed. ' +
+          'Use React.createContext() with static contextType instead. (https://react.dev/link/legacy-context)\n' +
+          '    in Component (at **)',
       ]);
       expect(markup).toContain('hello, world');
     });
@@ -597,10 +605,15 @@ describe('ReactDOMServer', () => {
     }
 
     ReactDOMServer.renderToString(<Foo />);
-    expect(() => jest.runOnlyPendingTimers()).toErrorDev(
-      'Can only update a mounting component.' +
-        ' This usually means you called setState() outside componentWillMount() on the server.' +
-        ' This is a no-op.\n\nPlease check the code for the Foo component.',
+    jest.runOnlyPendingTimers();
+    assertConsoleErrorDev(
+      [
+        'Can only update a mounting component. ' +
+          'This usually means you called setState() outside componentWillMount() on the server. ' +
+          'This is a no-op.\n' +
+          '\n' +
+          'Please check the code for the Foo component.',
+      ],
       {withoutStack: true},
     );
 
@@ -625,10 +638,15 @@ describe('ReactDOMServer', () => {
     }
 
     ReactDOMServer.renderToString(<Baz />);
-    expect(() => jest.runOnlyPendingTimers()).toErrorDev(
-      'Can only update a mounting component. ' +
-        'This usually means you called forceUpdate() outside componentWillMount() on the server. ' +
-        'This is a no-op.\n\nPlease check the code for the Baz component.',
+    jest.runOnlyPendingTimers();
+    assertConsoleErrorDev(
+      [
+        'Can only update a mounting component. ' +
+          'This usually means you called forceUpdate() outside componentWillMount() on the server. ' +
+          'This is a no-op.\n' +
+          '\n' +
+          'Please check the code for the Baz component.',
+      ],
       {withoutStack: true},
     );
     const markup = ReactDOMServer.renderToStaticMarkup(<Baz />);
@@ -722,41 +740,50 @@ describe('ReactDOMServer', () => {
       // Make sure namespace passes through composites
       return <g>{props.children}</g>;
     }
-    expect(() =>
-      ReactDOMServer.renderToStaticMarkup(
-        <div>
-          <inPUT />
-          <svg>
-            <CompositeG>
-              <linearGradient />
-              <foreignObject>
-                {/* back to HTML */}
-                <iFrame />
-              </foreignObject>
-            </CompositeG>
-          </svg>
-        </div>,
-      ),
-    ).toErrorDev([
+    ReactDOMServer.renderToStaticMarkup(
+      <div>
+        <inPUT />
+        <svg>
+          <CompositeG>
+            <linearGradient />
+            <foreignObject>
+              {/* back to HTML */}
+              <iFrame />
+            </foreignObject>
+          </CompositeG>
+        </svg>
+      </div>,
+    );
+    assertConsoleErrorDev([
       '<inPUT /> is using incorrect casing. ' +
         'Use PascalCase for React components, ' +
-        'or lowercase for HTML elements.',
+        'or lowercase for HTML elements.\n' +
+        '    in inPUT (at **)' +
+        (gate('enableOwnerStacks') ? '' : '\n    in div (at **)'),
       // linearGradient doesn't warn
       '<iFrame /> is using incorrect casing. ' +
         'Use PascalCase for React components, ' +
-        'or lowercase for HTML elements.',
+        'or lowercase for HTML elements.\n' +
+        '    in iFrame (at **)' +
+        (gate('enableOwnerStacks')
+          ? ''
+          : '\n    in foreignObject (at **)' +
+            '\n    in g (at **)' +
+            '\n    in CompositeG (at **)' +
+            '\n    in svg (at **)' +
+            '\n    in div (at **)'),
     ]);
   });
 
   it('should warn about contentEditable and children', () => {
-    expect(() =>
-      ReactDOMServer.renderToString(<div contentEditable={true} children="" />),
-    ).toErrorDev(
+    ReactDOMServer.renderToString(<div contentEditable={true} children="" />);
+    assertConsoleErrorDev([
       'A component is `contentEditable` and contains `children` ' +
         'managed by React. It is now your responsibility to guarantee that ' +
         'none of those nodes are unexpectedly modified or duplicated. This ' +
-        'is probably not intentional.\n    in div (at **)',
-    );
+        'is probably not intentional.\n' +
+        '    in div (at **)',
+    ]);
   });
 
   it('should warn when server rendering a class with a render method that does not extend React.Component', () => {
@@ -766,15 +793,15 @@ describe('ReactDOMServer', () => {
       }
     }
 
-    expect(() => {
-      expect(() =>
-        ReactDOMServer.renderToString(<ClassWithRenderNotExtended />),
-      ).toThrow(TypeError);
-    }).toErrorDev(
+    expect(() =>
+      ReactDOMServer.renderToString(<ClassWithRenderNotExtended />),
+    ).toThrow(TypeError);
+    assertConsoleErrorDev([
       'The <ClassWithRenderNotExtended /> component appears to have a render method, ' +
         "but doesn't extend React.Component. This is likely to cause errors. " +
-        'Change ClassWithRenderNotExtended to extend React.Component instead.',
-    );
+        'Change ClassWithRenderNotExtended to extend React.Component instead.\n' +
+        '    in ClassWithRenderNotExtended (at **)',
+    ]);
 
     // Test deduplication
     expect(() => {
@@ -839,7 +866,8 @@ describe('ReactDOMServer', () => {
       );
     }
 
-    expect(() => ReactDOMServer.renderToString(<App />)).toErrorDev([
+    ReactDOMServer.renderToString(<App />);
+    assertConsoleErrorDev([
       'Invalid ARIA attribute `ariaTypo`. ARIA attributes follow the pattern aria-* and must be lowercase.\n' +
         (gate(flags => flags.enableOwnerStacks)
           ? '    in span (at **)\n' +
@@ -897,7 +925,8 @@ describe('ReactDOMServer', () => {
       );
     }
 
-    expect(() => ReactDOMServer.renderToString(<App />)).toErrorDev([
+    ReactDOMServer.renderToString(<App />);
+    assertConsoleErrorDev([
       // ReactDOMServer(App > div > span)
       'Invalid ARIA attribute `ariaTypo`. ARIA attributes follow the pattern aria-* and must be lowercase.\n' +
         (gate(flags => flags.enableOwnerStacks)
@@ -907,12 +936,23 @@ describe('ReactDOMServer', () => {
             '    in App (at **)'),
       // ReactDOMServer(App > div > Child) >>> ReactDOMServer(App2) >>> ReactDOMServer(blink)
       'Invalid ARIA attribute `ariaTypo2`. ARIA attributes follow the pattern aria-* and must be lowercase.\n' +
-        '    in blink (at **)',
+        (gate(flags => flags.enableOwnerStacks)
+          ? '    in blink (at **)\n' +
+            '    in App2 (at **)\n' +
+            '    in Child (at **)\n' +
+            '    in App (at **)'
+          : '    in blink (at **)'),
       // ReactDOMServer(App > div > Child) >>> ReactDOMServer(App2 > Child2 > span)
       'Invalid ARIA attribute `ariaTypo3`. ARIA attributes follow the pattern aria-* and must be lowercase.\n' +
-        '    in span (at **)\n' +
-        '    in Child2 (at **)\n' +
-        '    in App2 (at **)',
+        (gate(flags => flags.enableOwnerStacks)
+          ? '    in span (at **)\n' +
+            '    in Child2 (at **)\n' +
+            '    in App2 (at **)\n' +
+            '    in Child (at **)\n' +
+            '    in App (at **)'
+          : '    in span (at **)\n' +
+            '    in Child2 (at **)\n' +
+            '    in App2 (at **)'),
       // ReactDOMServer(App > div > Child > span)
       'Invalid ARIA attribute `ariaTypo4`. ARIA attributes follow the pattern aria-* and must be lowercase.\n' +
         (gate(flags => flags.enableOwnerStacks)
@@ -943,13 +983,13 @@ describe('ReactDOMServer', () => {
       }
     }
 
-    expect(() => {
-      ReactDOMServer.renderToString(<ComponentA />);
-    }).toErrorDev(
+    ReactDOMServer.renderToString(<ComponentA />);
+    assertConsoleErrorDev([
       'ComponentA defines an invalid contextType. ' +
         'contextType should point to the Context object returned by React.createContext(). ' +
-        'Did you accidentally pass the Context.Consumer instead?',
-    );
+        'Did you accidentally pass the Context.Consumer instead?\n' +
+        '    in ComponentA (at **)',
+    ]);
 
     // Warnings should be deduped by component type
     ReactDOMServer.renderToString(<ComponentA />);
@@ -988,17 +1028,17 @@ describe('ReactDOMServer', () => {
     }
 
     expect(() => {
-      expect(() => {
-        ReactDOMServer.renderToString(<Foo />);
-      }).toThrow("Cannot read property 'world' of undefined");
-    }).toErrorDev(
+      ReactDOMServer.renderToString(<Foo />);
+    }).toThrow("Cannot read property 'world' of undefined");
+    assertConsoleErrorDev([
       'Foo defines an invalid contextType. ' +
         'contextType should point to the Context object returned by React.createContext(). ' +
         'However, it is set to undefined. ' +
         'This can be caused by a typo or by mixing up named and default imports. ' +
         'This can also happen due to a circular dependency, ' +
-        'so try moving the createContext() call to a separate file.',
-    );
+        'so try moving the createContext() call to a separate file.\n' +
+        '    in Foo (at **)',
+    ]);
   });
 
   it('should warn when class contextType is an object', () => {
@@ -1014,14 +1054,14 @@ describe('ReactDOMServer', () => {
     }
 
     expect(() => {
-      expect(() => {
-        ReactDOMServer.renderToString(<Foo />);
-      }).toThrow("Cannot read property 'hello' of undefined");
-    }).toErrorDev(
+      ReactDOMServer.renderToString(<Foo />);
+    }).toThrow("Cannot read property 'hello' of undefined");
+    assertConsoleErrorDev([
       'Foo defines an invalid contextType. ' +
         'contextType should point to the Context object returned by React.createContext(). ' +
-        'However, it is set to an object with keys {x, y}.',
-    );
+        'However, it is set to an object with keys {x, y}.\n' +
+        '    in Foo (at **)',
+    ]);
   });
 
   it('should warn when class contextType is a primitive', () => {
@@ -1033,14 +1073,14 @@ describe('ReactDOMServer', () => {
     }
 
     expect(() => {
-      expect(() => {
-        ReactDOMServer.renderToString(<Foo />);
-      }).toThrow("Cannot read property 'world' of undefined");
-    }).toErrorDev(
+      ReactDOMServer.renderToString(<Foo />);
+    }).toThrow("Cannot read property 'world' of undefined");
+    assertConsoleErrorDev([
       'Foo defines an invalid contextType. ' +
         'contextType should point to the Context object returned by React.createContext(). ' +
-        'However, it is set to a string.',
-    );
+        'However, it is set to a string.\n' +
+        '    in Foo (at **)',
+    ]);
   });
 
   describe('custom element server rendering', () => {

commit e0fe3479671555e01531dbc3d2fd85d5bd4c5a56
Author: Rick Hanlon <rickhanlonii@gmail.com>
Date:   Tue Mar 4 12:34:34 2025 -0500

    [flags] remove enableOwnerStacks (#32426)
    
    Bassed off: https://github.com/facebook/react/pull/32425
    
    Wait to land internally.
    
    [Commit to
    review.](https://github.com/facebook/react/pull/32426/commits/66aa6a4dbb78106b4f3d3eb367f5c27eb8f30c66)
    
    This has landed everywhere

diff --git a/packages/react-dom/src/__tests__/ReactServerRendering-test.js b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
index cbcf06892a..2bf917d3c3 100644
--- a/packages/react-dom/src/__tests__/ReactServerRendering-test.js
+++ b/packages/react-dom/src/__tests__/ReactServerRendering-test.js
@@ -758,20 +758,12 @@ describe('ReactDOMServer', () => {
       '<inPUT /> is using incorrect casing. ' +
         'Use PascalCase for React components, ' +
         'or lowercase for HTML elements.\n' +
-        '    in inPUT (at **)' +
-        (gate('enableOwnerStacks') ? '' : '\n    in div (at **)'),
+        '    in inPUT (at **)',
       // linearGradient doesn't warn
       '<iFrame /> is using incorrect casing. ' +
         'Use PascalCase for React components, ' +
         'or lowercase for HTML elements.\n' +
-        '    in iFrame (at **)' +
-        (gate('enableOwnerStacks')
-          ? ''
-          : '\n    in foreignObject (at **)' +
-            '\n    in g (at **)' +
-            '\n    in CompositeG (at **)' +
-            '\n    in svg (at **)' +
-            '\n    in div (at **)'),
+        '    in iFrame (at **)',
     ]);
   });
 
@@ -869,30 +861,14 @@ describe('ReactDOMServer', () => {
     ReactDOMServer.renderToString(<App />);
     assertConsoleErrorDev([
       'Invalid ARIA attribute `ariaTypo`. ARIA attributes follow the pattern aria-* and must be lowercase.\n' +
-        (gate(flags => flags.enableOwnerStacks)
-          ? '    in span (at **)\n' +
-            '    in B (at **)\n' +
-            '    in Child (at **)\n' +
-            '    in App (at **)'
-          : '    in span (at **)\n' +
-            '    in b (at **)\n' +
-            '    in C (at **)\n' +
-            '    in font (at **)\n' +
-            '    in B (at **)\n' +
-            '    in Child (at **)\n' +
-            '    in span (at **)\n' +
-            '    in div (at **)\n' +
-            '    in App (at **)'),
+        '    in span (at **)\n' +
+        '    in B (at **)\n' +
+        '    in Child (at **)\n' +
+        '    in App (at **)',
       'Invalid ARIA attribute `ariaTypo2`. ARIA attributes follow the pattern aria-* and must be lowercase.\n' +
-        (gate(flags => flags.enableOwnerStacks)
-          ? '    in span (at **)\n' +
-            '    in Child (at **)\n' +
-            '    in App (at **)'
-          : '    in span (at **)\n' +
-            '    in Child (at **)\n' +
-            '    in span (at **)\n' +
-            '    in div (at **)\n' +
-            '    in App (at **)'),
+        '    in span (at **)\n' +
+        '    in Child (at **)\n' +
+        '    in App (at **)',
     ]);
   });
 
@@ -929,47 +905,30 @@ describe('ReactDOMServer', () => {
     assertConsoleErrorDev([
       // ReactDOMServer(App > div > span)
       'Invalid ARIA attribute `ariaTypo`. ARIA attributes follow the pattern aria-* and must be lowercase.\n' +
-        (gate(flags => flags.enableOwnerStacks)
-          ? '    in span (at **)\n' + '    in App (at **)'
-          : '    in span (at **)\n' +
-            '    in div (at **)\n' +
-            '    in App (at **)'),
+        '    in span (at **)\n' +
+        '    in App (at **)',
       // ReactDOMServer(App > div > Child) >>> ReactDOMServer(App2) >>> ReactDOMServer(blink)
       'Invalid ARIA attribute `ariaTypo2`. ARIA attributes follow the pattern aria-* and must be lowercase.\n' +
-        (gate(flags => flags.enableOwnerStacks)
-          ? '    in blink (at **)\n' +
-            '    in App2 (at **)\n' +
-            '    in Child (at **)\n' +
-            '    in App (at **)'
-          : '    in blink (at **)'),
+        '    in blink (at **)\n' +
+        '    in App2 (at **)\n' +
+        '    in Child (at **)\n' +
+        '    in App (at **)',
       // ReactDOMServer(App > div > Child) >>> ReactDOMServer(App2 > Child2 > span)
       'Invalid ARIA attribute `ariaTypo3`. ARIA attributes follow the pattern aria-* and must be lowercase.\n' +
-        (gate(flags => flags.enableOwnerStacks)
-          ? '    in span (at **)\n' +
-            '    in Child2 (at **)\n' +
-            '    in App2 (at **)\n' +
-            '    in Child (at **)\n' +
-            '    in App (at **)'
-          : '    in span (at **)\n' +
-            '    in Child2 (at **)\n' +
-            '    in App2 (at **)'),
+        '    in span (at **)\n' +
+        '    in Child2 (at **)\n' +
+        '    in App2 (at **)\n' +
+        '    in Child (at **)\n' +
+        '    in App (at **)',
       // ReactDOMServer(App > div > Child > span)
       'Invalid ARIA attribute `ariaTypo4`. ARIA attributes follow the pattern aria-* and must be lowercase.\n' +
-        (gate(flags => flags.enableOwnerStacks)
-          ? '    in span (at **)\n' +
-            '    in Child (at **)\n' +
-            '    in App (at **)'
-          : '    in span (at **)\n' +
-            '    in Child (at **)\n' +
-            '    in div (at **)\n' +
-            '    in App (at **)'),
+        '    in span (at **)\n' +
+        '    in Child (at **)\n' +
+        '    in App (at **)',
       // ReactDOMServer(App > div > font)
       'Invalid ARIA attribute `ariaTypo5`. ARIA attributes follow the pattern aria-* and must be lowercase.\n' +
-        (gate(flags => flags.enableOwnerStacks)
-          ? '    in font (at **)\n' + '    in App (at **)'
-          : '    in font (at **)\n' +
-            '    in div (at **)\n' +
-            '    in App (at **)'),
+        '    in font (at **)\n' +
+        '    in App (at **)',
     ]);
   });
 

