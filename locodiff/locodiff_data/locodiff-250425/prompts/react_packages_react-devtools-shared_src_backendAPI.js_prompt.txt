# Instructions

You are being benchmarked. You will see the output of a git log command, and from that must infer the current state of a file. Think carefully, as you must output the exact state of the file to earn full marks.

**Important:** Your goal is to reproduce the file's content *exactly* as it exists at the final commit, even if the code appears broken, buggy, or contains obvious errors. Do **not** try to "fix" the code. Attempting to correct issues will result in a poor score, as this benchmark evaluates your ability to reproduce the precise state of the file based on its history.

# Required Response Format

Wrap the content of the file in triple backticks (```). Any text outside the final closing backticks will be ignored. End your response after outputting the closing backticks.

# Example Response

```python
#!/usr/bin/env python
print('Hello, world!')
```

# File History

> git log -p --cc --topo-order --reverse -- packages/react-devtools-shared/src/backendAPI.js

commit af16f755dc7e0d6e2b4bf79b86c434f4ce0497fe
Author: Brian Vaughn <bvaughn@fb.com>
Date:   Tue Jan 19 06:51:32 2021 -0800

    Update DevTools to use getCacheForType API (#20548)
    
    DevTools was built with a fork of an early idea for how Suspense cache might work. This idea is incompatible with newer APIs like `useTransition` which unfortunately prevented me from making certain UX improvements. This PR swaps out the primary usage of this cache (there are a few) in favor of the newer `unstable_getCacheForType` and `unstable_useCacheRefresh` APIs. We can go back and update the others in follow up PRs.
    
    ### Messaging changes
    
    I've refactored the way the frontend loads component props/state/etc to hopefully make it better match the Suspense+cache model. Doing this gave up some of the small optimizations I'd added but hopefully the actual performance impact of that is minor and the overall ergonomic improvements of working with the cache API make this worth it.
    
    The backend no longer remembers inspected paths. Instead, the frontend sends them every time and the backend sends a response with those paths. I've also added a new "force" parameter that the frontend can use to tell the backend to send a response even if the component hasn't rendered since the last time it asked. (This is used to get data for newly inspected paths.)
    
    _Initial inspection..._
    ```
    front |                                                      | back
          | -- "inspect" (id:1, paths:[], force:true) ---------> |
          | <------------------------ "inspected" (full-data) -- |
    ```
    _1 second passes with no updates..._
    ```
          | -- "inspect" (id:1, paths:[], force:false) --------> |
          | <------------------------ "inspected" (no-change) -- |
    ```
    _User clicks to expand a path, aka hydrate..._
    ```
          | -- "inspect" (id:1, paths:['foo'], force:true) ----> |
          | <------------------------ "inspected" (full-data) -- |
    ```
    _1 second passes during which there is an update..._
    ```
          | -- "inspect" (id:1, paths:['foo'], force:false) ---> |
          | <----------------- "inspectedElement" (full-data) -- |
    ```
    
    ### Clear errors/warnings transition
    Previously this meant there would be a delay after clicking the "clear" button. The UX after this change is much improved.
    
    ### Hydrating paths transition
    I also added a transition to hydration (expanding "dehyrated" paths).
    
    ### Better error boundaries
    I also added a lower-level error boundary in case the new suspense operation ever failed. It provides a better "retry" mechanism (select a new element) so DevTools doesn't become entirely useful. Here I'm intentionally causing an error every time I select an element.
    
    ### Improved snapshot tests
    I also migrated several of the existing snapshot tests to use inline snapshots and added a new serializer for dehydrated props. Inline snapshots are easier to verify and maintain and the new serializer means dehydrated props will be formatted in a way that makes sense rather than being empty (in external snapshots) or super verbose (default inline snapshot format).

diff --git a/packages/react-devtools-shared/src/backendAPI.js b/packages/react-devtools-shared/src/backendAPI.js
new file mode 100644
index 0000000000..372fd247d3
--- /dev/null
+++ b/packages/react-devtools-shared/src/backendAPI.js
@@ -0,0 +1,283 @@
+/**
+ * Copyright (c) Facebook, Inc. and its affiliates.
+ *
+ * This source code is licensed under the MIT license found in the
+ * LICENSE file in the root directory of this source tree.
+ *
+ * @flow
+ */
+
+import {hydrate, fillInPath} from 'react-devtools-shared/src/hydration';
+import {separateDisplayNameAndHOCs} from 'react-devtools-shared/src/utils';
+import Store from 'react-devtools-shared/src/devtools/store';
+
+import type {
+  InspectedElement as InspectedElementBackend,
+  InspectedElementPayload,
+} from 'react-devtools-shared/src/backend/types';
+import type {
+  BackendEvents,
+  FrontendBridge,
+} from 'react-devtools-shared/src/bridge';
+import type {
+  DehydratedData,
+  InspectedElement as InspectedElementFrontend,
+} from 'react-devtools-shared/src/devtools/views/Components/types';
+
+export function clearErrorsAndWarnings({
+  bridge,
+  store,
+}: {|
+  bridge: FrontendBridge,
+  store: Store,
+|}): void {
+  store.rootIDToRendererID.forEach(rendererID => {
+    bridge.send('clearErrorsAndWarnings', {rendererID});
+  });
+}
+
+export function clearErrorsForElement({
+  bridge,
+  id,
+  rendererID,
+}: {|
+  bridge: FrontendBridge,
+  id: number,
+  rendererID: number,
+|}): void {
+  bridge.send('clearErrorsForFiberID', {
+    rendererID,
+    id,
+  });
+}
+
+export function clearWarningsForElement({
+  bridge,
+  id,
+  rendererID,
+}: {|
+  bridge: FrontendBridge,
+  id: number,
+  rendererID: number,
+|}): void {
+  bridge.send('clearWarningsForFiberID', {
+    rendererID,
+    id,
+  });
+}
+
+export function copyInspectedElementPath({
+  bridge,
+  id,
+  path,
+  rendererID,
+}: {|
+  bridge: FrontendBridge,
+  id: number,
+  path: Array<string | number>,
+  rendererID: number,
+|}): void {
+  bridge.send('copyElementPath', {
+    id,
+    path,
+    rendererID,
+  });
+}
+
+export function inspectElement({
+  bridge,
+  forceUpdate,
+  id,
+  inspectedPaths,
+  rendererID,
+}: {|
+  bridge: FrontendBridge,
+  forceUpdate: boolean,
+  id: number,
+  inspectedPaths: Object,
+  rendererID: number,
+|}): Promise<InspectedElementPayload> {
+  const requestID = requestCounter++;
+  const promise = getPromiseForRequestID<InspectedElementPayload>(
+    requestID,
+    'inspectedElement',
+    bridge,
+  );
+
+  bridge.send('inspectElement', {
+    forceUpdate,
+    id,
+    inspectedPaths,
+    rendererID,
+    requestID,
+  });
+
+  return promise;
+}
+
+let storeAsGlobalCount = 0;
+
+export function storeAsGlobal({
+  bridge,
+  id,
+  path,
+  rendererID,
+}: {|
+  bridge: FrontendBridge,
+  id: number,
+  path: Array<string | number>,
+  rendererID: number,
+|}): void {
+  bridge.send('storeAsGlobal', {
+    count: storeAsGlobalCount++,
+    id,
+    path,
+    rendererID,
+  });
+}
+
+const TIMEOUT_DELAY = 5000;
+
+let requestCounter = 0;
+
+function getPromiseForRequestID<T>(
+  requestID: number,
+  eventType: $Keys<BackendEvents>,
+  bridge: FrontendBridge,
+): Promise<T> {
+  return new Promise((resolve, reject) => {
+    const cleanup = () => {
+      bridge.removeListener(eventType, onInspectedElement);
+
+      clearTimeout(timeoutID);
+    };
+
+    const onInspectedElement = (data: any) => {
+      if (data.responseID === requestID) {
+        cleanup();
+        resolve((data: T));
+      }
+    };
+
+    const onTimeout = () => {
+      cleanup();
+      reject();
+    };
+
+    bridge.addListener(eventType, onInspectedElement);
+
+    const timeoutID = setTimeout(onTimeout, TIMEOUT_DELAY);
+  });
+}
+
+export function cloneInspectedElementWithPath(
+  inspectedElement: InspectedElementFrontend,
+  path: Array<string | number>,
+  value: Object,
+): InspectedElementFrontend {
+  const hydratedValue = hydrateHelper(value, path);
+  const clonedInspectedElement = {...inspectedElement};
+
+  fillInPath(clonedInspectedElement, value, path, hydratedValue);
+
+  return clonedInspectedElement;
+}
+
+export function convertInspectedElementBackendToFrontend(
+  inspectedElementBackend: InspectedElementBackend,
+): InspectedElementFrontend {
+  const {
+    canEditFunctionProps,
+    canEditFunctionPropsDeletePaths,
+    canEditFunctionPropsRenamePaths,
+    canEditHooks,
+    canEditHooksAndDeletePaths,
+    canEditHooksAndRenamePaths,
+    canToggleSuspense,
+    canViewSource,
+    hasLegacyContext,
+    id,
+    source,
+    type,
+    owners,
+    context,
+    hooks,
+    props,
+    rendererPackageName,
+    rendererVersion,
+    rootType,
+    state,
+    key,
+    errors,
+    warnings,
+  } = inspectedElementBackend;
+
+  const inspectedElement: InspectedElementFrontend = {
+    canEditFunctionProps,
+    canEditFunctionPropsDeletePaths,
+    canEditFunctionPropsRenamePaths,
+    canEditHooks,
+    canEditHooksAndDeletePaths,
+    canEditHooksAndRenamePaths,
+    canToggleSuspense,
+    canViewSource,
+    hasLegacyContext,
+    id,
+    key,
+    rendererPackageName,
+    rendererVersion,
+    rootType,
+    source,
+    type,
+    owners:
+      owners === null
+        ? null
+        : owners.map(owner => {
+            const [displayName, hocDisplayNames] = separateDisplayNameAndHOCs(
+              owner.displayName,
+              owner.type,
+            );
+            return {
+              ...owner,
+              displayName,
+              hocDisplayNames,
+            };
+          }),
+    context: hydrateHelper(context),
+    hooks: hydrateHelper(hooks),
+    props: hydrateHelper(props),
+    state: hydrateHelper(state),
+    errors,
+    warnings,
+  };
+
+  return inspectedElement;
+}
+
+function hydrateHelper(
+  dehydratedData: DehydratedData | null,
+  path?: Array<string | number>,
+): Object | null {
+  if (dehydratedData !== null) {
+    const {cleaned, data, unserializable} = dehydratedData;
+
+    if (path) {
+      const {length} = path;
+      if (length > 0) {
+        // Hydration helper requires full paths, but inspection dehydrates with relative paths.
+        // In that event it's important that we adjust the "cleaned" paths to match.
+        return hydrate(
+          data,
+          cleaned.map(cleanedPath => cleanedPath.slice(length)),
+          unserializable.map(unserializablePath =>
+            unserializablePath.slice(length),
+          ),
+        );
+      }
+    }
+
+    return hydrate(data, cleaned, unserializable);
+  } else {
+    return null;
+  }
+}

commit cfd8c1bd43fc4fcf708a584924f27a6c79803eae
Author: Brian Vaughn <bvaughn@fb.com>
Date:   Mon Feb 22 14:04:20 2021 -0500

    DevTools: Restore inspect-element bridge optimizations (#20789)
    
    * Restore inspect-element bridge optimizations
    
    When the new Suspense cache was integrated (so that startTransition could be used) I removed a couple of optimizations between the backend and frontend that reduced bridge traffic when e.g. dehydrated paths were inspected for elements that had not rendered since previously inspected. This commit re-adds those optimizations as well as an additional test with a bug fix that I noticed while reading the backend code.
    
    There are two remaining TODO items as of this commit:
    - Make inspected element edits and deletes also use transition API
    - Don't over-eagerly refresh the cache in our ping-for-updates handler
    
    I will addres both in subsequent commits.
    
    * Poll for update only refreshes cache when there's an update
    
    * Added inline comment

diff --git a/packages/react-devtools-shared/src/backendAPI.js b/packages/react-devtools-shared/src/backendAPI.js
index 372fd247d3..a4b870ea8f 100644
--- a/packages/react-devtools-shared/src/backendAPI.js
+++ b/packages/react-devtools-shared/src/backendAPI.js
@@ -86,15 +86,13 @@ export function copyInspectedElementPath({
 
 export function inspectElement({
   bridge,
-  forceUpdate,
   id,
-  inspectedPaths,
+  path,
   rendererID,
 }: {|
   bridge: FrontendBridge,
-  forceUpdate: boolean,
   id: number,
-  inspectedPaths: Object,
+  path: Array<string | number> | null,
   rendererID: number,
 |}): Promise<InspectedElementPayload> {
   const requestID = requestCounter++;
@@ -105,9 +103,8 @@ export function inspectElement({
   );
 
   bridge.send('inspectElement', {
-    forceUpdate,
     id,
-    inspectedPaths,
+    path,
     rendererID,
     requestID,
   });
@@ -254,7 +251,7 @@ export function convertInspectedElementBackendToFrontend(
   return inspectedElement;
 }
 
-function hydrateHelper(
+export function hydrateHelper(
   dehydratedData: DehydratedData | null,
   path?: Array<string | number>,
 ): Object | null {

commit 8b4201535c6068147d61d0ed3f02d21d6dcd6927
Author: Bao Pham <gbaopham@gmail.com>
Date:   Thu Jun 3 23:21:44 2021 +0800

    Devtools: add feature to trigger an error boundary (#21583)
    
    Co-authored-by: Brian Vaughn <bvaughn@fb.com>

diff --git a/packages/react-devtools-shared/src/backendAPI.js b/packages/react-devtools-shared/src/backendAPI.js
index a4b870ea8f..4a79147ec2 100644
--- a/packages/react-devtools-shared/src/backendAPI.js
+++ b/packages/react-devtools-shared/src/backendAPI.js
@@ -190,6 +190,9 @@ export function convertInspectedElementBackendToFrontend(
     canEditHooks,
     canEditHooksAndDeletePaths,
     canEditHooksAndRenamePaths,
+    canToggleError,
+    isErrored,
+    targetErrorBoundaryID,
     canToggleSuspense,
     canViewSource,
     hasLegacyContext,
@@ -216,6 +219,9 @@ export function convertInspectedElementBackendToFrontend(
     canEditHooks,
     canEditHooksAndDeletePaths,
     canEditHooksAndRenamePaths,
+    canToggleError,
+    isErrored,
+    targetErrorBoundaryID,
     canToggleSuspense,
     canViewSource,
     hasLegacyContext,

commit a8cabb5648a14ef55cb96d679a526e3f731e9611
Author: Juan <jstejada@fb.com>
Date:   Wed Sep 15 17:19:10 2021 -0400

    [DevTools] Fix runtime error when inspecting an element times out (#22329)

diff --git a/packages/react-devtools-shared/src/backendAPI.js b/packages/react-devtools-shared/src/backendAPI.js
index 4a79147ec2..5e0ac663fe 100644
--- a/packages/react-devtools-shared/src/backendAPI.js
+++ b/packages/react-devtools-shared/src/backendAPI.js
@@ -158,7 +158,9 @@ function getPromiseForRequestID<T>(
 
     const onTimeout = () => {
       cleanup();
-      reject();
+      reject(
+        new Error(`Timed out waiting for event '${eventType}' from bridge`),
+      );
     };
 
     bridge.addListener(eventType, onInspectedElement);

commit 47177247f8c792fbb9a33328c913e246ff139a2d
Author: Brian Vaughn <bvaughn@fb.com>
Date:   Thu Sep 30 12:48:53 2021 -0400

    DevTools: Fixed potential cache miss when insepcting elements (#22472)

diff --git a/packages/react-devtools-shared/src/backendAPI.js b/packages/react-devtools-shared/src/backendAPI.js
index 5e0ac663fe..2aa5b30cd2 100644
--- a/packages/react-devtools-shared/src/backendAPI.js
+++ b/packages/react-devtools-shared/src/backendAPI.js
@@ -86,11 +86,13 @@ export function copyInspectedElementPath({
 
 export function inspectElement({
   bridge,
+  forceFullData,
   id,
   path,
   rendererID,
 }: {|
   bridge: FrontendBridge,
+  forceFullData: boolean,
   id: number,
   path: Array<string | number> | null,
   rendererID: number,
@@ -103,6 +105,7 @@ export function inspectElement({
   );
 
   bridge.send('inspectElement', {
+    forceFullData,
     id,
     path,
     rendererID,

commit 5f3b376c56c6c523e7018f5128a768cbd67a8a6f
Author: Brian Vaughn <bvaughn@fb.com>
Date:   Fri Oct 1 15:03:36 2021 -0400

    Show different error boundary UI for timeouts than normal errors (#22483)

diff --git a/packages/react-devtools-shared/src/backendAPI.js b/packages/react-devtools-shared/src/backendAPI.js
index 2aa5b30cd2..23b975e38d 100644
--- a/packages/react-devtools-shared/src/backendAPI.js
+++ b/packages/react-devtools-shared/src/backendAPI.js
@@ -10,6 +10,7 @@
 import {hydrate, fillInPath} from 'react-devtools-shared/src/hydration';
 import {separateDisplayNameAndHOCs} from 'react-devtools-shared/src/utils';
 import Store from 'react-devtools-shared/src/devtools/store';
+import TimeoutError from 'react-devtools-shared/src/TimeoutError';
 
 import type {
   InspectedElement as InspectedElementBackend,
@@ -102,6 +103,7 @@ export function inspectElement({
     requestID,
     'inspectedElement',
     bridge,
+    `Timed out while inspecting element ${id}.`,
   );
 
   bridge.send('inspectElement', {
@@ -144,6 +146,7 @@ function getPromiseForRequestID<T>(
   requestID: number,
   eventType: $Keys<BackendEvents>,
   bridge: FrontendBridge,
+  timeoutMessage: string,
 ): Promise<T> {
   return new Promise((resolve, reject) => {
     const cleanup = () => {
@@ -161,9 +164,7 @@ function getPromiseForRequestID<T>(
 
     const onTimeout = () => {
       cleanup();
-      reject(
-        new Error(`Timed out waiting for event '${eventType}' from bridge`),
-      );
+      reject(new TimeoutError(timeoutMessage));
     };
 
     bridge.addListener(eventType, onInspectedElement);

commit ad607469c58d337d23d05e3be73087d370f7d715
Author: Brian Vaughn <bvaughn@fb.com>
Date:   Tue Dec 7 20:04:12 2021 -0500

    StyleX plug-in for resolving atomic styles to values for props.xstyle (#22808)
    
    Adds the concept of "plugins" to the inspected element payload. Also adds the first plugin, one that resolves StyleX atomic style names to their values and displays them as a unified style object (rather than a nested array of objects and booleans).
    
    Source file names are displayed first, in dim color, followed by an ordered set of resolved style values.
    
    For builds with the new feature flag disabled, there is no observable change.
    
    A next step to build on top of this could be to make the style values editable, but change the logic such that editing one directly added an inline style to the item (rather than modifying the stylex class– which may be shared between multiple other components).

diff --git a/packages/react-devtools-shared/src/backendAPI.js b/packages/react-devtools-shared/src/backendAPI.js
index 23b975e38d..3849899b7d 100644
--- a/packages/react-devtools-shared/src/backendAPI.js
+++ b/packages/react-devtools-shared/src/backendAPI.js
@@ -208,6 +208,7 @@ export function convertInspectedElementBackendToFrontend(
     owners,
     context,
     hooks,
+    plugins,
     props,
     rendererPackageName,
     rendererVersion,
@@ -233,6 +234,7 @@ export function convertInspectedElementBackendToFrontend(
     hasLegacyContext,
     id,
     key,
+    plugins,
     rendererPackageName,
     rendererVersion,
     rootType,

commit e531a4a62d0b88301ac06d4efd3f5a30faa03c94
Author: Mengdi "Monday" Chen <mengdi@fb.com>
Date:   Thu May 5 20:17:23 2022 -0400

    [React DevTools] Improve DevTools UI when Inspecting a user Component that Throws an Error  (#24248)
    
    * [ReactDevTools] custom view for errors occur in user's code
    
    * [ReactDevTools] show message for unsupported feature
    
    * fix bad import
    
    * fix typo
    
    * fix issues from rebasing
    
    * prettier
    
    * sync error names
    
    * sync error name with upstream
    
    * fix lint & better comment
    
    * fix error message for test
    
    * better error message per review
    
    * add missing file
    
    * remove dead enum & provide component name in error message
    
    * better error message
    
    * better user facing error message

diff --git a/packages/react-devtools-shared/src/backendAPI.js b/packages/react-devtools-shared/src/backendAPI.js
index 3849899b7d..adf0c5e8b0 100644
--- a/packages/react-devtools-shared/src/backendAPI.js
+++ b/packages/react-devtools-shared/src/backendAPI.js
@@ -10,7 +10,7 @@
 import {hydrate, fillInPath} from 'react-devtools-shared/src/hydration';
 import {separateDisplayNameAndHOCs} from 'react-devtools-shared/src/utils';
 import Store from 'react-devtools-shared/src/devtools/store';
-import TimeoutError from 'react-devtools-shared/src/TimeoutError';
+import TimeoutError from 'react-devtools-shared/src/errors/TimeoutError';
 
 import type {
   InspectedElement as InspectedElementBackend,

commit 8003ab9cf5c711eb00f741bbd89def56b066b999
Author: Jan Kassens <jan@kassens.net>
Date:   Fri Sep 9 16:03:48 2022 -0400

    Flow: remove explicit object syntax (#25223)

diff --git a/packages/react-devtools-shared/src/backendAPI.js b/packages/react-devtools-shared/src/backendAPI.js
index adf0c5e8b0..efa56cfcad 100644
--- a/packages/react-devtools-shared/src/backendAPI.js
+++ b/packages/react-devtools-shared/src/backendAPI.js
@@ -28,10 +28,10 @@ import type {
 export function clearErrorsAndWarnings({
   bridge,
   store,
-}: {|
+}: {
   bridge: FrontendBridge,
   store: Store,
-|}): void {
+}): void {
   store.rootIDToRendererID.forEach(rendererID => {
     bridge.send('clearErrorsAndWarnings', {rendererID});
   });
@@ -41,11 +41,11 @@ export function clearErrorsForElement({
   bridge,
   id,
   rendererID,
-}: {|
+}: {
   bridge: FrontendBridge,
   id: number,
   rendererID: number,
-|}): void {
+}): void {
   bridge.send('clearErrorsForFiberID', {
     rendererID,
     id,
@@ -56,11 +56,11 @@ export function clearWarningsForElement({
   bridge,
   id,
   rendererID,
-}: {|
+}: {
   bridge: FrontendBridge,
   id: number,
   rendererID: number,
-|}): void {
+}): void {
   bridge.send('clearWarningsForFiberID', {
     rendererID,
     id,
@@ -72,12 +72,12 @@ export function copyInspectedElementPath({
   id,
   path,
   rendererID,
-}: {|
+}: {
   bridge: FrontendBridge,
   id: number,
   path: Array<string | number>,
   rendererID: number,
-|}): void {
+}): void {
   bridge.send('copyElementPath', {
     id,
     path,
@@ -91,13 +91,13 @@ export function inspectElement({
   id,
   path,
   rendererID,
-}: {|
+}: {
   bridge: FrontendBridge,
   forceFullData: boolean,
   id: number,
   path: Array<string | number> | null,
   rendererID: number,
-|}): Promise<InspectedElementPayload> {
+}): Promise<InspectedElementPayload> {
   const requestID = requestCounter++;
   const promise = getPromiseForRequestID<InspectedElementPayload>(
     requestID,
@@ -124,12 +124,12 @@ export function storeAsGlobal({
   id,
   path,
   rendererID,
-}: {|
+}: {
   bridge: FrontendBridge,
   id: number,
   path: Array<string | number>,
   rendererID: number,
-|}): void {
+}): void {
   bridge.send('storeAsGlobal', {
     count: storeAsGlobalCount++,
     id,

commit 9cdf8a99edcfd94d7420835ea663edca04237527
Author: Andrew Clark <git@andrewclark.io>
Date:   Tue Oct 18 11:19:24 2022 -0400

    [Codemod] Update copyright header to Meta (#25315)
    
    * Facebook -> Meta in copyright
    
    rg --files | xargs sed -i 's#Copyright (c) Facebook, Inc. and its affiliates.#Copyright (c) Meta Platforms, Inc. and affiliates.#g'
    
    * Manual tweaks

diff --git a/packages/react-devtools-shared/src/backendAPI.js b/packages/react-devtools-shared/src/backendAPI.js
index efa56cfcad..8d5cb409fe 100644
--- a/packages/react-devtools-shared/src/backendAPI.js
+++ b/packages/react-devtools-shared/src/backendAPI.js
@@ -1,5 +1,5 @@
 /**
- * Copyright (c) Facebook, Inc. and its affiliates.
+ * Copyright (c) Meta Platforms, Inc. and affiliates.
  *
  * This source code is licensed under the MIT license found in the
  * LICENSE file in the root directory of this source tree.

commit 2eed1328478e8c923fcb4e6abf5efbd9e1233402
Author: Ruslan Lesiutin <rdlesyutin@gmail.com>
Date:   Tue Sep 12 15:05:39 2023 +0100

    refactor[devtools/extension]: more stable element updates polling to avoid timed out errors (#27357)
    
    Some context:
    - When user selects an element in tree inspector, we display current
    state of the component. In order to display really current state, we
    start polling the backend to get available updates for the element.
    
    Previously:
    - Straight-forward sending an event to get element updates each second.
    Potential race condition is not handled in any form.
    - If user navigates from the page, timeout wouldn't be cleared and we
    would potentially throw "Timed out ..." error.
    - Bridge disconnection is not handled in any form, if it was shut down,
    we could spam with "Timed out ..." errors.
    
    With these changes:
    - Requests are now chained, so there can be a single request at a time.
    - Handling both navigation and shut down events.
    
    This should reduce the number of "Timed out ..." errors that we see in
    our logs for the extension. Other surfaces will also benefit from it,
    but not to the full extent, as long as they utilize
    "resumeElementPolling" and "pauseElementPolling" events.
    
    Tested this on Chrome, running React DevTools on multiple tabs,
    explicitly checked the case when service worker is in idle state and we
    return back to the tab.

diff --git a/packages/react-devtools-shared/src/backendAPI.js b/packages/react-devtools-shared/src/backendAPI.js
index 8d5cb409fe..fcbfb423a7 100644
--- a/packages/react-devtools-shared/src/backendAPI.js
+++ b/packages/react-devtools-shared/src/backendAPI.js
@@ -11,6 +11,7 @@ import {hydrate, fillInPath} from 'react-devtools-shared/src/hydration';
 import {separateDisplayNameAndHOCs} from 'react-devtools-shared/src/utils';
 import Store from 'react-devtools-shared/src/devtools/store';
 import TimeoutError from 'react-devtools-shared/src/errors/TimeoutError';
+import ElementPollingCancellationError from 'react-devtools-shared/src/errors/ElementPollingCancellationError';
 
 import type {
   InspectedElement as InspectedElementBackend,
@@ -138,7 +139,7 @@ export function storeAsGlobal({
   });
 }
 
-const TIMEOUT_DELAY = 5000;
+const TIMEOUT_DELAY = 10_000;
 
 let requestCounter = 0;
 
@@ -151,10 +152,17 @@ function getPromiseForRequestID<T>(
   return new Promise((resolve, reject) => {
     const cleanup = () => {
       bridge.removeListener(eventType, onInspectedElement);
+      bridge.removeListener('shutdown', onDisconnect);
+      bridge.removeListener('pauseElementPolling', onDisconnect);
 
       clearTimeout(timeoutID);
     };
 
+    const onDisconnect = () => {
+      cleanup();
+      reject(new ElementPollingCancellationError());
+    };
+
     const onInspectedElement = (data: any) => {
       if (data.responseID === requestID) {
         cleanup();
@@ -168,6 +176,8 @@ function getPromiseForRequestID<T>(
     };
 
     bridge.addListener(eventType, onInspectedElement);
+    bridge.addListener('shutdown', onDisconnect);
+    bridge.addListener('pauseElementPolling', onDisconnect);
 
     const timeoutID = setTimeout(onTimeout, TIMEOUT_DELAY);
   });

commit 77ec61885fb19607cdd116a6790095afa40b5a94
Author: Ruslan Lesiutin <rdlesyutin@gmail.com>
Date:   Tue Oct 10 18:10:17 2023 +0100

    fix[devtools/inspectElement]: dont pause initial inspectElement call when user switches tabs (#27488)
    
    There are not so many changes, most of them are changing imports,
    because I've moved types for UI in a single file.
    
    In https://github.com/facebook/react/pull/27357 I've added support for
    pausing polling events: when user inspects an element, we start polling
    React DevTools backend for updates in props / state. If user switches
    tabs, extension's service worker can be killed by browser and this
    polling will start spamming errors.
    
    What I've missed is that we also have a separate call for this API, but
    which is executed only once when user selects an element. We don't
    handle promise rejection here and this can lead to some errors when user
    selects an element and switches tabs right after it.
    
    The only change here is that this API now has
    `shouldListenToPauseEvents` param, which is `true` for polling, so we
    will pause polling once user switches tabs. It is `false` by default, so
    we won't pause initial call by accident.
    
    
    https://github.com/hoxyq/react/blob/af8beeebf63b5824497fcd0bb35b7c0ac8fe60a0/packages/react-devtools-shared/src/backendAPI.js#L96

diff --git a/packages/react-devtools-shared/src/backendAPI.js b/packages/react-devtools-shared/src/backendAPI.js
index fcbfb423a7..27700c27c7 100644
--- a/packages/react-devtools-shared/src/backendAPI.js
+++ b/packages/react-devtools-shared/src/backendAPI.js
@@ -24,7 +24,8 @@ import type {
 import type {
   DehydratedData,
   InspectedElement as InspectedElementFrontend,
-} from 'react-devtools-shared/src/devtools/views/Components/types';
+} from 'react-devtools-shared/src/frontend/types';
+import type {InspectedElementPath} from 'react-devtools-shared/src/frontend/types';
 
 export function clearErrorsAndWarnings({
   bridge,
@@ -86,25 +87,21 @@ export function copyInspectedElementPath({
   });
 }
 
-export function inspectElement({
-  bridge,
-  forceFullData,
-  id,
-  path,
-  rendererID,
-}: {
+export function inspectElement(
   bridge: FrontendBridge,
   forceFullData: boolean,
   id: number,
-  path: Array<string | number> | null,
+  path: InspectedElementPath | null,
   rendererID: number,
-}): Promise<InspectedElementPayload> {
+  shouldListenToPauseEvents: boolean = false,
+): Promise<InspectedElementPayload> {
   const requestID = requestCounter++;
   const promise = getPromiseForRequestID<InspectedElementPayload>(
     requestID,
     'inspectedElement',
     bridge,
     `Timed out while inspecting element ${id}.`,
+    shouldListenToPauseEvents,
   );
 
   bridge.send('inspectElement', {
@@ -148,16 +145,29 @@ function getPromiseForRequestID<T>(
   eventType: $Keys<BackendEvents>,
   bridge: FrontendBridge,
   timeoutMessage: string,
+  shouldListenToPauseEvents: boolean = false,
 ): Promise<T> {
   return new Promise((resolve, reject) => {
     const cleanup = () => {
       bridge.removeListener(eventType, onInspectedElement);
-      bridge.removeListener('shutdown', onDisconnect);
-      bridge.removeListener('pauseElementPolling', onDisconnect);
+      bridge.removeListener('shutdown', onShutdown);
+
+      if (shouldListenToPauseEvents) {
+        bridge.removeListener('pauseElementPolling', onDisconnect);
+      }
 
       clearTimeout(timeoutID);
     };
 
+    const onShutdown = () => {
+      cleanup();
+      reject(
+        new Error(
+          'Failed to inspect element. Try again or restart React DevTools.',
+        ),
+      );
+    };
+
     const onDisconnect = () => {
       cleanup();
       reject(new ElementPollingCancellationError());
@@ -176,8 +186,11 @@ function getPromiseForRequestID<T>(
     };
 
     bridge.addListener(eventType, onInspectedElement);
-    bridge.addListener('shutdown', onDisconnect);
-    bridge.addListener('pauseElementPolling', onDisconnect);
+    bridge.addListener('shutdown', onShutdown);
+
+    if (shouldListenToPauseEvents) {
+      bridge.addListener('pauseElementPolling', onDisconnect);
+    }
 
     const timeoutID = setTimeout(onTimeout, TIMEOUT_DELAY);
   });
@@ -277,7 +290,7 @@ export function convertInspectedElementBackendToFrontend(
 
 export function hydrateHelper(
   dehydratedData: DehydratedData | null,
-  path?: Array<string | number>,
+  path: ?InspectedElementPath,
 ): Object | null {
   if (dehydratedData !== null) {
     const {cleaned, data, unserializable} = dehydratedData;

commit 6c7b41da3de12be2d95c60181b3fe896f824f13a
Author: Ruslan Lesiutin <rdlesyutin@gmail.com>
Date:   Thu Nov 23 18:37:21 2023 +0000

    feat[devtools]: display Forget badge for the relevant components (#27709)
    
    Adds `Forget` badge to all relevant components.
    
    Changes:
    - If component is compiled with Forget and using a built-in
    `useMemoCache` hook, it will have a `Forget` badge next to its display
    name in:
      - components tree
      - inspected element view
      - owners list
    - Such badges are indexable, so Forget components can be searched using
    search bar.
    
    Fixes:
    - Displaying the badges for owners list inside the inspected component
    view
    
    Implementation:
    - React DevTools backend is responsible for identifying if component is
    compiled with Forget, based on `fiber.updateQueue.memoCache`. It will
    wrap component's display name with `Forget(...)` prefix before passing
    operations to the frontend. On the frontend side, we will parse the
    display name and strip Forget prefix, marking the corresponding element
    by setting `compiledWithForget` field. Almost the same logic is
    currently used for HOC display names.

diff --git a/packages/react-devtools-shared/src/backendAPI.js b/packages/react-devtools-shared/src/backendAPI.js
index 27700c27c7..397019bb37 100644
--- a/packages/react-devtools-shared/src/backendAPI.js
+++ b/packages/react-devtools-shared/src/backendAPI.js
@@ -8,7 +8,7 @@
  */
 
 import {hydrate, fillInPath} from 'react-devtools-shared/src/hydration';
-import {separateDisplayNameAndHOCs} from 'react-devtools-shared/src/utils';
+import {backendToFrontendSerializedElementMapper} from 'react-devtools-shared/src/utils';
 import Store from 'react-devtools-shared/src/devtools/store';
 import TimeoutError from 'react-devtools-shared/src/errors/TimeoutError';
 import ElementPollingCancellationError from 'react-devtools-shared/src/errors/ElementPollingCancellationError';
@@ -266,17 +266,7 @@ export function convertInspectedElementBackendToFrontend(
     owners:
       owners === null
         ? null
-        : owners.map(owner => {
-            const [displayName, hocDisplayNames] = separateDisplayNameAndHOCs(
-              owner.displayName,
-              owner.type,
-            );
-            return {
-              ...owner,
-              displayName,
-              hocDisplayNames,
-            };
-          }),
+        : owners.map(backendToFrontendSerializedElementMapper),
     context: hydrateHelper(context),
     hooks: hydrateHelper(hooks),
     props: hydrateHelper(props),

commit 37d901e2b81e12d40df7012c6f8681b8272d2555
Author: Sebastian Markbåge <sebastian@calyptus.eu>
Date:   Wed Feb 7 13:38:00 2024 -0800

    Remove __self and __source location from elements (#28265)
    
    Along with all the places using it like the `_debugSource` on Fiber.
    This still lets them be passed into `createElement` (and JSX dev
    runtime) since those can still be used in existing already compiled code
    and we don't want that to start spreading to DOM attributes.
    
    We used to have a DEV mode that compiles the source location of JSX into
    the compiled output. This was nice because we could get the actual call
    site of the JSX (instead of just somewhere in the component). It had a
    bunch of issues though:
    
    - It only works with JSX.
    - The way this source location is compiled is different in all the
    pipelines along the way. It relies on this transform being first and the
    source location we want to extract but it doesn't get preserved along
    source maps and don't have a way to be connected to the source hosted by
    the source maps. Ideally it should just use the mechanism other source
    maps use.
    - Since it's expensive it only works in DEV so if it's used for
    component stacks it would vary between dev and prod.
    - It only captures the callsite of the JSX and not the stack between the
    component and that callsite. In the happy case it's in the component but
    not always.
    
    Instead, we have another zero-cost trick to extract the call site of
    each component lazily only if it's needed. This ensures that component
    stacks are the same in DEV and PROD. At the cost of worse line number
    information.
    
    The better way to get the JSX call site would be to get it from `new
    Error()` or `console.createTask()` inside the JSX runtime which can
    capture the whole stack in a consistent way with other source mappings.
    We might explore that in the future.
    
    This removes source location info from React DevTools and React Native
    Inspector. The "jump to source code" feature or inspection can be made
    lazy instead by invoking the lazy component stack frame generation. That
    way it can be made to work in prod too. The filtering based on file path
    is a bit trickier.
    
    When redesigned this UI should ideally also account for more than one
    stack frame.
    
    With this change the DEV only Babel transforms are effectively
    deprecated since they're not necessary for anything.

diff --git a/packages/react-devtools-shared/src/backendAPI.js b/packages/react-devtools-shared/src/backendAPI.js
index 397019bb37..21ae444a1e 100644
--- a/packages/react-devtools-shared/src/backendAPI.js
+++ b/packages/react-devtools-shared/src/backendAPI.js
@@ -226,7 +226,6 @@ export function convertInspectedElementBackendToFrontend(
     canViewSource,
     hasLegacyContext,
     id,
-    source,
     type,
     owners,
     context,
@@ -261,7 +260,7 @@ export function convertInspectedElementBackendToFrontend(
     rendererPackageName,
     rendererVersion,
     rootType,
-    source,
+    source: null, // TODO: Load source location lazily.
     type,
     owners:
       owners === null

commit 61bd00498d2a6e23885bac42f3aeb0e02cadb8eb
Author: Ruslan Lesiutin <rdlesyutin@gmail.com>
Date:   Tue Mar 5 12:10:36 2024 +0000

    refactor[devtools]: lazily define source for fiber based on component stacks (#28351)
    
    `_debugSource` was removed in
    https://github.com/facebook/react/pull/28265.
    
    This PR migrates DevTools to define `source` for Fiber based on
    component stacks. This will be done lazily for inspected elements, once
    user clicks on the element in the tree.
    
    `DevToolsComponentStackFrame.js` was just copy-pasted from the
    implementation in `ReactComponentStackFrame`.
    
    Symbolication part is done in
    https://github.com/facebook/react/pull/28471 and stacked on this commit.

diff --git a/packages/react-devtools-shared/src/backendAPI.js b/packages/react-devtools-shared/src/backendAPI.js
index 21ae444a1e..6fcc35b574 100644
--- a/packages/react-devtools-shared/src/backendAPI.js
+++ b/packages/react-devtools-shared/src/backendAPI.js
@@ -228,6 +228,7 @@ export function convertInspectedElementBackendToFrontend(
     id,
     type,
     owners,
+    source,
     context,
     hooks,
     plugins,
@@ -260,7 +261,7 @@ export function convertInspectedElementBackendToFrontend(
     rendererPackageName,
     rendererVersion,
     rootType,
-    source: null, // TODO: Load source location lazily.
+    source,
     type,
     owners:
       owners === null

commit e5287287aacd3c51d24e223651b7f38ece584c49
Author: Ruslan Lesiutin <rdlesyutin@gmail.com>
Date:   Tue Mar 5 12:32:11 2024 +0000

    feat[devtools]: symbolicate source for inspected element (#28471)
    
    Stacked on https://github.com/facebook/react/pull/28351, please review
    only the last commit.
    
    Top-level description of the approach:
    1. Once user selects an element from the tree, frontend asks backend to
    return the inspected element, this is where we simulate an error
    happening in `render` function of the component and then we parse the
    error stack. As an improvement, we should probably migrate from custom
    implementation of error stack parser to `error-stack-parser` from npm.
    2. When frontend receives the inspected element and this object is being
    propagated, we create a Promise for symbolicated source, which is then
    passed down to all components, which are using `source`.
    3. These components use `use` hook for this promise and are wrapped in
    Suspense.
    
    Caching:
    1. For browser extension, we cache Promises based on requested resource
    + key + column, also added use of
    `chrome.devtools.inspectedWindow.getResource` API.
    2. For standalone case (RN), we cache based on requested resource url,
    we cache the content of it.

diff --git a/packages/react-devtools-shared/src/backendAPI.js b/packages/react-devtools-shared/src/backendAPI.js
index 6fcc35b574..718b1cb55b 100644
--- a/packages/react-devtools-shared/src/backendAPI.js
+++ b/packages/react-devtools-shared/src/backendAPI.js
@@ -261,7 +261,9 @@ export function convertInspectedElementBackendToFrontend(
     rendererPackageName,
     rendererVersion,
     rootType,
-    source,
+    // Previous backend implementations (<= 5.0.1) have a different interface for Source, with fileName.
+    // This gates the source features for only compatible backends: >= 5.0.2
+    source: source && source.sourceURL ? source : null,
     type,
     owners:
       owners === null

commit ec98d36c3a47e9f02c45cc14ff6046fff8c27458
Author: Sebastian Markbåge <sebastian@calyptus.eu>
Date:   Mon Jul 29 14:29:52 2024 -0400

    [DevTools] Rename Fiber to Element in the Bridge Protocol and RendererInterface (#30490)
    
    I need to start clarifying where things are really actually Fibers and
    where they're not since I'm adding Server Components as a separate type
    of component instance which is not backed by a Fiber.
    
    Nothing in the front end should really know anything about what kind of
    renderer implementation we're inspecting and indeed it's already not
    always a "Fiber" in the legacy renderer.
    
    We typically refer to this as a "Component Instance" but the front end
    currently refers to it as an Element as it historically grew from the
    browser DevTools Elements tab.
    
    I also moved the renderer.js implementation into the `backend/fiber`
    folder. These are at the same level as `backend/legacy`. This clarifies
    that anything outside of this folder ideally shouldn't refer to a
    "Fiber".
    
    console.js and profilingHooks.js unfortunately use Fibers a lot which
    needs further refactoring. The profiler frontend also uses the term
    alot.

diff --git a/packages/react-devtools-shared/src/backendAPI.js b/packages/react-devtools-shared/src/backendAPI.js
index 718b1cb55b..d0d5c79516 100644
--- a/packages/react-devtools-shared/src/backendAPI.js
+++ b/packages/react-devtools-shared/src/backendAPI.js
@@ -48,7 +48,7 @@ export function clearErrorsForElement({
   id: number,
   rendererID: number,
 }): void {
-  bridge.send('clearErrorsForFiberID', {
+  bridge.send('clearErrorsForElementID', {
     rendererID,
     id,
   });
@@ -63,7 +63,7 @@ export function clearWarningsForElement({
   id: number,
   rendererID: number,
 }): void {
-  bridge.send('clearWarningsForFiberID', {
+  bridge.send('clearWarningsForElementID', {
     rendererID,
     id,
   });

commit a06cd9e1d141f598a68377495f4c0fe9ee44e569
Author: Sebastian Markbåge <sebastian@calyptus.eu>
Date:   Thu Sep 5 15:48:17 2024 -0400

    [DevTools] Refactor Forcing Fallback / Error of Suspense / Error Boundaries (#30870)
    
    First, this basically reverts
    https://github.com/facebook/react/pull/30517/commits/1f3892ef8cc181218587ddc6accd994890c92ef5
    to use a Map/Set to track what is forced to suspend/error again instead
    of flags on the Instance. The difference is that now the key in the
    Fiber itself instead of the ID. Critically this avoids the
    fiberToFiberInstance map to look up whether or not a Fiber should be
    forced to suspend when asked by the renderer.
    
    This also allows us to force suspend/error on filtered instances. It's a
    bit unclear what should happen when you try to Suspend or Error a child
    but its parent boundary is filtered. It was also inconsistent between
    Suspense and Error due to how they were implemented.
    
    I think conceptually you're trying to simulate what would happen if that
    Component errored or suspended so it would be misleading if we triggered
    a different boundary than would happen in real life. So I think we
    should trigger the nearest unfiltered Fiber, not the nearest Instance.
    The consequence of this however is that if this instance was filtered,
    there's no way to undo it without refreshing or removing the filter.
    This is an edge case though since it's unusual you'd filter these in the
    first place.
    
    It used to be that Suspense walked the store in the frontend and Error
    walked the Fibers in the backend. They also did this somewhat eagerly.
    This simplifies and unifies the model by passing the id of what you
    clicked in the frontend and then we walk the Fiber tree from there in
    the backend to lazily find the boundary. However I also eagerly walk the
    tree at first to find whether we have any Suspense or Error boundary
    parents at all so we can hide the buttons if not.
    
    This also implements it to work with VirtualInstances using #30865. I
    find the nearest Fiber Instance downwards filtered or otherwise. Then
    from its parent we find the nearest Error or Suspense boundary. That's
    because VirtualInstance will always have their inner Fiber as an
    Instance but they might not have their parent since it might be
    filtered. Which would potentially cause us to skip over a filtered
    parent Suspense boundary.

diff --git a/packages/react-devtools-shared/src/backendAPI.js b/packages/react-devtools-shared/src/backendAPI.js
index d0d5c79516..7a8bb80144 100644
--- a/packages/react-devtools-shared/src/backendAPI.js
+++ b/packages/react-devtools-shared/src/backendAPI.js
@@ -221,7 +221,6 @@ export function convertInspectedElementBackendToFrontend(
     canEditHooksAndRenamePaths,
     canToggleError,
     isErrored,
-    targetErrorBoundaryID,
     canToggleSuspense,
     canViewSource,
     hasLegacyContext,
@@ -251,7 +250,6 @@ export function convertInspectedElementBackendToFrontend(
     canEditHooksAndRenamePaths,
     canToggleError,
     isErrored,
-    targetErrorBoundaryID,
     canToggleSuspense,
     canViewSource,
     hasLegacyContext,

commit f0c767e2a26ec28d808c22f8af2e09f2e20cdcc2
Author: Ruslan Lesiutin <rdlesyutin@gmail.com>
Date:   Wed Apr 2 22:44:38 2025 +0100

    feat[devtools]: display native tag for host components for Native (#32762)
    
    Native only. Displays the native tag for Native Host components inside a
    badge, when user inspects the component.
    
    Only displaying will be supported for now, because in order to get
    native tags indexable, they should be part of the bridge operations,
    which is technically a breaking change that requires significantly more
    time investment.
    
    The text will only be shown when user hovers over the badge.
    ![Screenshot 2025-03-26 at 19 46
    40](https://github.com/user-attachments/assets/787530cf-c5e5-4b85-8e2a-15b006a3d783)

diff --git a/packages/react-devtools-shared/src/backendAPI.js b/packages/react-devtools-shared/src/backendAPI.js
index 7a8bb80144..b3668b9d98 100644
--- a/packages/react-devtools-shared/src/backendAPI.js
+++ b/packages/react-devtools-shared/src/backendAPI.js
@@ -239,6 +239,7 @@ export function convertInspectedElementBackendToFrontend(
     key,
     errors,
     warnings,
+    nativeTag,
   } = inspectedElementBackend;
 
   const inspectedElement: InspectedElementFrontend = {
@@ -273,6 +274,7 @@ export function convertInspectedElementBackendToFrontend(
     state: hydrateHelper(state),
     errors,
     warnings,
+    nativeTag,
   };
 
   return inspectedElement;

