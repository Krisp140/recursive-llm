# Instructions

You are being benchmarked. You will see the output of a git log command, and from that must infer the current state of a file. Think carefully, as you must output the exact state of the file to earn full marks.

**Important:** Your goal is to reproduce the file's content *exactly* as it exists at the final commit, even if the code appears broken, buggy, or contains obvious errors. Do **not** try to "fix" the code. Attempting to correct issues will result in a poor score, as this benchmark evaluates your ability to reproduce the precise state of the file based on its history.

# Required Response Format

Wrap the content of the file in triple backticks (```). Any text outside the final closing backticks will be ignored. End your response after outputting the closing backticks.

# Example Response

```python
#!/usr/bin/env python
print('Hello, world!')
```

# File History

> git log -p --cc --topo-order --reverse -- packages/react-devtools-shared/src/devtools/store.js

commit ec7ef50e8b7a61639d5b622e9e675602120e2e96
Author: Brian Vaughn <bvaughn@fb.com>
Date:   Tue Aug 13 11:37:25 2019 -0700

    Reorganized things again into packages

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
new file mode 100644
index 0000000000..e032463957
--- /dev/null
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -0,0 +1,1005 @@
+// @flow
+
+import EventEmitter from 'events';
+import { inspect } from 'util';
+import {
+  TREE_OPERATION_ADD,
+  TREE_OPERATION_REMOVE,
+  TREE_OPERATION_REORDER_CHILDREN,
+  TREE_OPERATION_UPDATE_TREE_BASE_DURATION,
+} from '../constants';
+import { ElementTypeRoot } from '../types';
+import {
+  getSavedComponentFilters,
+  saveComponentFilters,
+  separateDisplayNameAndHOCs,
+  shallowDiffers,
+  utfDecodeString,
+} from '../utils';
+import { localStorageGetItem, localStorageSetItem } from '../storage';
+import { __DEBUG__ } from '../constants';
+import { printStore } from 'src/__tests__/storeSerializer';
+import ProfilerStore from './ProfilerStore';
+
+import type { Element } from './views/Components/types';
+import type { ComponentFilter, ElementType } from '../types';
+import type { FrontendBridge } from 'src/bridge';
+
+const debug = (methodName, ...args) => {
+  if (__DEBUG__) {
+    console.log(
+      `%cStore %c${methodName}`,
+      'color: green; font-weight: bold;',
+      'font-weight: bold;',
+      ...args
+    );
+  }
+};
+
+const LOCAL_STORAGE_COLLAPSE_ROOTS_BY_DEFAULT_KEY =
+  'React::DevTools::collapseNodesByDefault';
+const LOCAL_STORAGE_RECORD_CHANGE_DESCRIPTIONS_KEY =
+  'React::DevTools::recordChangeDescriptions';
+
+type Config = {|
+  isProfiling?: boolean,
+  supportsNativeInspection?: boolean,
+  supportsReloadAndProfile?: boolean,
+  supportsProfiling?: boolean,
+|};
+
+export type Capabilities = {|
+  hasOwnerMetadata: boolean,
+  supportsProfiling: boolean,
+|};
+
+/**
+ * The store is the single source of truth for updates from the backend.
+ * ContextProviders can subscribe to the Store for specific things they want to provide.
+ */
+export default class Store extends EventEmitter<{|
+  collapseNodesByDefault: [],
+  componentFilters: [],
+  mutated: [[Array<number>, Map<number, number>]],
+  recordChangeDescriptions: [],
+  roots: [],
+  supportsNativeStyleEditor: [],
+  supportsProfiling: [],
+  supportsReloadAndProfile: [],
+|}> {
+  _bridge: FrontendBridge;
+
+  // Should new nodes be collapsed by default when added to the tree?
+  _collapseNodesByDefault: boolean = true;
+
+  _componentFilters: Array<ComponentFilter>;
+
+  // At least one of the injected renderers contains (DEV only) owner metadata.
+  _hasOwnerMetadata: boolean = false;
+
+  // Map of ID to (mutable) Element.
+  // Elements are mutated to avoid excessive cloning during tree updates.
+  // The InspectedElementContext also relies on this mutability for its WeakMap usage.
+  _idToElement: Map<number, Element> = new Map();
+
+  // Should the React Native style editor panel be shown?
+  _isNativeStyleEditorSupported: boolean = false;
+
+  // Can the backend use the Storage API (e.g. localStorage)?
+  // If not, features like reload-and-profile will not work correctly and must be disabled.
+  _isBackendStorageAPISupported: boolean = false;
+
+  _nativeStyleEditorValidAttributes: $ReadOnlyArray<string> | null = null;
+
+  // Map of element (id) to the set of elements (ids) it owns.
+  // This map enables getOwnersListForElement() to avoid traversing the entire tree.
+  _ownersMap: Map<number, Set<number>> = new Map();
+
+  _profilerStore: ProfilerStore;
+
+  _recordChangeDescriptions: boolean = false;
+
+  // Incremented each time the store is mutated.
+  // This enables a passive effect to detect a mutation between render and commit phase.
+  _revision: number = 0;
+
+  // This Array must be treated as immutable!
+  // Passive effects will check it for changes between render and mount.
+  _roots: $ReadOnlyArray<number> = [];
+
+  _rootIDToCapabilities: Map<number, Capabilities> = new Map();
+
+  // Renderer ID is needed to support inspection fiber props, state, and hooks.
+  _rootIDToRendererID: Map<number, number> = new Map();
+
+  // These options may be initially set by a confiugraiton option when constructing the Store.
+  // In the case of "supportsProfiling", the option may be updated based on the injected renderers.
+  _supportsNativeInspection: boolean = true;
+  _supportsProfiling: boolean = false;
+  _supportsReloadAndProfile: boolean = false;
+
+  // Total number of visible elements (within all roots).
+  // Used for windowing purposes.
+  _weightAcrossRoots: number = 0;
+
+  constructor(bridge: FrontendBridge, config?: Config) {
+    super();
+
+    if (__DEBUG__) {
+      debug('constructor', 'subscribing to Bridge');
+    }
+
+    this._collapseNodesByDefault =
+      localStorageGetItem(LOCAL_STORAGE_COLLAPSE_ROOTS_BY_DEFAULT_KEY) ===
+      'true';
+
+    this._recordChangeDescriptions =
+      localStorageGetItem(LOCAL_STORAGE_RECORD_CHANGE_DESCRIPTIONS_KEY) ===
+      'true';
+
+    this._componentFilters = getSavedComponentFilters();
+
+    let isProfiling = false;
+    if (config != null) {
+      isProfiling = config.isProfiling === true;
+
+      const {
+        supportsNativeInspection,
+        supportsProfiling,
+        supportsReloadAndProfile,
+      } = config;
+      this._supportsNativeInspection = supportsNativeInspection !== false;
+      if (supportsProfiling) {
+        this._supportsProfiling = true;
+      }
+      if (supportsReloadAndProfile) {
+        this._supportsReloadAndProfile = true;
+      }
+    }
+
+    this._bridge = bridge;
+    bridge.addListener('operations', this.onBridgeOperations);
+    bridge.addListener(
+      'overrideComponentFilters',
+      this.onBridgeOverrideComponentFilters
+    );
+    bridge.addListener('shutdown', this.onBridgeShutdown);
+    bridge.addListener(
+      'isBackendStorageAPISupported',
+      this.onBridgeStorageSupported
+    );
+    bridge.addListener(
+      'isNativeStyleEditorSupported',
+      this.onBridgeNativeStyleEditorSupported
+    );
+
+    this._profilerStore = new ProfilerStore(bridge, this, isProfiling);
+  }
+
+  // This is only used in tests to avoid memory leaks.
+  assertExpectedRootMapSizes() {
+    if (this.roots.length === 0) {
+      // The only safe time to assert these maps are empty is when the store is empty.
+      this.assertMapSizeMatchesRootCount(this._idToElement, '_idToElement');
+      this.assertMapSizeMatchesRootCount(this._ownersMap, '_ownersMap');
+    }
+
+    // These maps should always be the same size as the number of roots
+    this.assertMapSizeMatchesRootCount(
+      this._rootIDToCapabilities,
+      '_rootIDToCapabilities'
+    );
+    this.assertMapSizeMatchesRootCount(
+      this._rootIDToRendererID,
+      '_rootIDToRendererID'
+    );
+  }
+
+  // This is only used in tests to avoid memory leaks.
+  assertMapSizeMatchesRootCount(map: Map<any, any>, mapName: string) {
+    const expectedSize = this.roots.length;
+    if (map.size !== expectedSize) {
+      throw new Error(
+        `Expected ${mapName} to contain ${expectedSize} items, but it contains ${
+          map.size
+        } items\n\n${inspect(map, {
+          depth: 20,
+        })}`
+      );
+    }
+  }
+
+  get collapseNodesByDefault(): boolean {
+    return this._collapseNodesByDefault;
+  }
+  set collapseNodesByDefault(value: boolean): void {
+    this._collapseNodesByDefault = value;
+
+    localStorageSetItem(
+      LOCAL_STORAGE_COLLAPSE_ROOTS_BY_DEFAULT_KEY,
+      value ? 'true' : 'false'
+    );
+
+    this.emit('collapseNodesByDefault');
+  }
+
+  get componentFilters(): Array<ComponentFilter> {
+    return this._componentFilters;
+  }
+  set componentFilters(value: Array<ComponentFilter>): void {
+    if (this._profilerStore.isProfiling) {
+      // Re-mounting a tree while profiling is in progress might break a lot of assumptions.
+      // If necessary, we could support this- but it doesn't seem like a necessary use case.
+      throw Error('Cannot modify filter preferences while profiling');
+    }
+
+    // Filter updates are expensive to apply (since they impact the entire tree).
+    // Let's determine if they've changed and avoid doing this work if they haven't.
+    const prevEnabledComponentFilters = this._componentFilters.filter(
+      filter => filter.isEnabled
+    );
+    const nextEnabledComponentFilters = value.filter(
+      filter => filter.isEnabled
+    );
+    let haveEnabledFiltersChanged =
+      prevEnabledComponentFilters.length !== nextEnabledComponentFilters.length;
+    if (!haveEnabledFiltersChanged) {
+      for (let i = 0; i < nextEnabledComponentFilters.length; i++) {
+        const prevFilter = prevEnabledComponentFilters[i];
+        const nextFilter = nextEnabledComponentFilters[i];
+        if (shallowDiffers(prevFilter, nextFilter)) {
+          haveEnabledFiltersChanged = true;
+          break;
+        }
+      }
+    }
+
+    this._componentFilters = value;
+
+    // Update persisted filter preferences stored in localStorage.
+    saveComponentFilters(value);
+
+    // Notify the renderer that filter prefernces have changed.
+    // This is an expensive opreation; it unmounts and remounts the entire tree,
+    // so only do it if the set of enabled component filters has changed.
+    if (haveEnabledFiltersChanged) {
+      this._bridge.send('updateComponentFilters', value);
+    }
+
+    this.emit('componentFilters');
+  }
+
+  get hasOwnerMetadata(): boolean {
+    return this._hasOwnerMetadata;
+  }
+
+  get nativeStyleEditorValidAttributes(): $ReadOnlyArray<string> | null {
+    return this._nativeStyleEditorValidAttributes;
+  }
+
+  get numElements(): number {
+    return this._weightAcrossRoots;
+  }
+
+  get profilerStore(): ProfilerStore {
+    return this._profilerStore;
+  }
+
+  get recordChangeDescriptions(): boolean {
+    return this._recordChangeDescriptions;
+  }
+  set recordChangeDescriptions(value: boolean): void {
+    this._recordChangeDescriptions = value;
+
+    localStorageSetItem(
+      LOCAL_STORAGE_RECORD_CHANGE_DESCRIPTIONS_KEY,
+      value ? 'true' : 'false'
+    );
+
+    this.emit('recordChangeDescriptions');
+  }
+
+  get revision(): number {
+    return this._revision;
+  }
+
+  get rootIDToRendererID(): Map<number, number> {
+    return this._rootIDToRendererID;
+  }
+
+  get roots(): $ReadOnlyArray<number> {
+    return this._roots;
+  }
+
+  get supportsNativeInspection(): boolean {
+    return this._supportsNativeInspection;
+  }
+
+  get supportsNativeStyleEditor(): boolean {
+    return this._isNativeStyleEditorSupported;
+  }
+
+  get supportsProfiling(): boolean {
+    return this._supportsProfiling;
+  }
+
+  get supportsReloadAndProfile(): boolean {
+    // Does the DevTools shell support reloading and eagerly injecting the renderer interface?
+    // And if so, can the backend use the localStorage API?
+    // Both of these are required for the reload-and-profile feature to work.
+    return this._supportsReloadAndProfile && this._isBackendStorageAPISupported;
+  }
+
+  containsElement(id: number): boolean {
+    return this._idToElement.get(id) != null;
+  }
+
+  getElementAtIndex(index: number): Element | null {
+    if (index < 0 || index >= this.numElements) {
+      console.warn(
+        `Invalid index ${index} specified; store contains ${
+          this.numElements
+        } items.`
+      );
+
+      return null;
+    }
+
+    // Find wich root this element is in...
+    let rootID;
+    let root;
+    let rootWeight = 0;
+    for (let i = 0; i < this._roots.length; i++) {
+      rootID = this._roots[i];
+      root = ((this._idToElement.get(rootID): any): Element);
+      if (root.children.length === 0) {
+        continue;
+      } else if (rootWeight + root.weight > index) {
+        break;
+      } else {
+        rootWeight += root.weight;
+      }
+    }
+
+    // Find the element in the tree using the weight of each node...
+    // Skip over the root itself, because roots aren't visible in the Elements tree.
+    let currentElement = ((root: any): Element);
+    let currentWeight = rootWeight - 1;
+    while (index !== currentWeight) {
+      const numChildren = currentElement.children.length;
+      for (let i = 0; i < numChildren; i++) {
+        const childID = currentElement.children[i];
+        const child = ((this._idToElement.get(childID): any): Element);
+        const childWeight = child.isCollapsed ? 1 : child.weight;
+
+        if (index <= currentWeight + childWeight) {
+          currentWeight++;
+          currentElement = child;
+          break;
+        } else {
+          currentWeight += childWeight;
+        }
+      }
+    }
+
+    return ((currentElement: any): Element) || null;
+  }
+
+  getElementIDAtIndex(index: number): number | null {
+    const element: Element | null = this.getElementAtIndex(index);
+    return element === null ? null : element.id;
+  }
+
+  getElementByID(id: number): Element | null {
+    const element = this._idToElement.get(id);
+    if (element == null) {
+      console.warn(`No element found with id "${id}"`);
+      return null;
+    }
+
+    return element;
+  }
+
+  getIndexOfElementID(id: number): number | null {
+    const element = this.getElementByID(id);
+
+    if (element === null || element.parentID === 0) {
+      return null;
+    }
+
+    // Walk up the tree to the root.
+    // Increment the index by one for each node we encounter,
+    // and by the weight of all nodes to the left of the current one.
+    // This should be a relatively fast way of determining the index of a node within the tree.
+    let previousID = id;
+    let currentID = element.parentID;
+    let index = 0;
+    while (true) {
+      const current = ((this._idToElement.get(currentID): any): Element);
+
+      const { children } = current;
+      for (let i = 0; i < children.length; i++) {
+        const childID = children[i];
+        if (childID === previousID) {
+          break;
+        }
+        const child = ((this._idToElement.get(childID): any): Element);
+        index += child.isCollapsed ? 1 : child.weight;
+      }
+
+      if (current.parentID === 0) {
+        // We found the root; stop crawling.
+        break;
+      }
+
+      index++;
+
+      previousID = current.id;
+      currentID = current.parentID;
+    }
+
+    // At this point, the current ID is a root (from the previous loop).
+    // We also need to offset the index by previous root weights.
+    for (let i = 0; i < this._roots.length; i++) {
+      const rootID = this._roots[i];
+      if (rootID === currentID) {
+        break;
+      }
+      const root = ((this._idToElement.get(rootID): any): Element);
+      index += root.weight;
+    }
+
+    return index;
+  }
+
+  getOwnersListForElement(ownerID: number): Array<Element> {
+    const list = [];
+    let element = this._idToElement.get(ownerID);
+    if (element != null) {
+      list.push({
+        ...element,
+        depth: 0,
+      });
+
+      const unsortedIDs = this._ownersMap.get(ownerID);
+      if (unsortedIDs !== undefined) {
+        const depthMap: Map<number, number> = new Map([[ownerID, 0]]);
+
+        // Items in a set are ordered based on insertion.
+        // This does not correlate with their order in the tree.
+        // So first we need to order them.
+        // I wish we could avoid this sorting operation; we could sort at insertion time,
+        // but then we'd have to pay sorting costs even if the owners list was never used.
+        // Seems better to defer the cost, since the set of ids is probably pretty small.
+        const sortedIDs = Array.from(unsortedIDs).sort(
+          (idA, idB) =>
+            ((this.getIndexOfElementID(idA): any): number) -
+            ((this.getIndexOfElementID(idB): any): number)
+        );
+
+        // Next we need to determine the appropriate depth for each element in the list.
+        // The depth in the list may not correspond to the depth in the tree,
+        // because the list has been filtered to remove intermediate components.
+        // Perhaps the easiest way to do this is to walk up the tree until we reach either:
+        // (1) another node that's already in the tree, or (2) the root (owner)
+        // at which point, our depth is just the depth of that node plus one.
+        sortedIDs.forEach(id => {
+          const element = this._idToElement.get(id);
+          if (element != null) {
+            let parentID = element.parentID;
+
+            let depth = 0;
+            while (parentID > 0) {
+              if (parentID === ownerID || unsortedIDs.has(parentID)) {
+                depth = depthMap.get(parentID) + 1;
+                depthMap.set(id, depth);
+                break;
+              }
+              const parent = this._idToElement.get(parentID);
+              if (parent == null) {
+                break;
+              }
+              parentID = parent.parentID;
+            }
+
+            if (depth === 0) {
+              throw Error('Invalid owners list');
+            }
+
+            list.push({ ...element, depth });
+          }
+        });
+      }
+    }
+
+    return list;
+  }
+
+  getRendererIDForElement(id: number): number | null {
+    let current = this._idToElement.get(id);
+    while (current != null) {
+      if (current.parentID === 0) {
+        const rendererID = this._rootIDToRendererID.get(current.id);
+        return rendererID == null ? null : rendererID;
+      } else {
+        current = this._idToElement.get(current.parentID);
+      }
+    }
+    return null;
+  }
+
+  getRootIDForElement(id: number): number | null {
+    let current = this._idToElement.get(id);
+    while (current != null) {
+      if (current.parentID === 0) {
+        return current.id;
+      } else {
+        current = this._idToElement.get(current.parentID);
+      }
+    }
+    return null;
+  }
+
+  isInsideCollapsedSubTree(id: number): boolean {
+    let current = this._idToElement.get(id);
+    while (current != null) {
+      if (current.parentID === 0) {
+        return false;
+      } else {
+        current = this._idToElement.get(current.parentID);
+        if (current != null && current.isCollapsed) {
+          return true;
+        }
+      }
+    }
+    return false;
+  }
+
+  // TODO Maybe split this into two methods: expand() and collapse()
+  toggleIsCollapsed(id: number, isCollapsed: boolean): void {
+    let didMutate = false;
+
+    const element = this.getElementByID(id);
+    if (element !== null) {
+      if (isCollapsed) {
+        if (element.type === ElementTypeRoot) {
+          throw Error('Root nodes cannot be collapsed');
+        }
+
+        if (!element.isCollapsed) {
+          didMutate = true;
+          element.isCollapsed = true;
+
+          const weightDelta = 1 - element.weight;
+
+          let parentElement = ((this._idToElement.get(
+            element.parentID
+          ): any): Element);
+          while (parentElement != null) {
+            // We don't need to break on a collapsed parent in the same way as the expand case below.
+            // That's because collapsing a node doesn't "bubble" and affect its parents.
+            parentElement.weight += weightDelta;
+            parentElement = this._idToElement.get(parentElement.parentID);
+          }
+        }
+      } else {
+        let currentElement = element;
+        while (currentElement != null) {
+          const oldWeight = currentElement.isCollapsed
+            ? 1
+            : currentElement.weight;
+
+          if (currentElement.isCollapsed) {
+            didMutate = true;
+            currentElement.isCollapsed = false;
+
+            const newWeight = currentElement.isCollapsed
+              ? 1
+              : currentElement.weight;
+            const weightDelta = newWeight - oldWeight;
+
+            let parentElement = ((this._idToElement.get(
+              currentElement.parentID
+            ): any): Element);
+            while (parentElement != null) {
+              parentElement.weight += weightDelta;
+              if (parentElement.isCollapsed) {
+                // It's important to break on a collapsed parent when expanding nodes.
+                // That's because expanding a node "bubbles" up and expands all parents as well.
+                // Breaking in this case prevents us from over-incrementing the expanded weights.
+                break;
+              }
+              parentElement = this._idToElement.get(parentElement.parentID);
+            }
+          }
+
+          currentElement =
+            currentElement.parentID !== 0
+              ? this.getElementByID(currentElement.parentID)
+              : null;
+        }
+      }
+
+      // Only re-calculate weights and emit an "update" event if the store was mutated.
+      if (didMutate) {
+        let weightAcrossRoots = 0;
+        this._roots.forEach(rootID => {
+          const { weight } = ((this.getElementByID(rootID): any): Element);
+          weightAcrossRoots += weight;
+        });
+        this._weightAcrossRoots = weightAcrossRoots;
+
+        // The Tree context's search reducer expects an explicit list of ids for nodes that were added or removed.
+        // In this  case, we can pass it empty arrays since nodes in a collapsed tree are still there (just hidden).
+        // Updating the selected search index later may require auto-expanding a collapsed subtree though.
+        this.emit('mutated', [[], new Map()]);
+      }
+    }
+  }
+
+  _adjustParentTreeWeight = (
+    parentElement: Element | null,
+    weightDelta: number
+  ) => {
+    let isInsideCollapsedSubTree = false;
+
+    while (parentElement != null) {
+      parentElement.weight += weightDelta;
+
+      // Additions and deletions within a collapsed subtree should not bubble beyond the collapsed parent.
+      // Their weight will bubble up when the parent is expanded.
+      if (parentElement.isCollapsed) {
+        isInsideCollapsedSubTree = true;
+        break;
+      }
+
+      parentElement = ((this._idToElement.get(
+        parentElement.parentID
+      ): any): Element);
+    }
+
+    // Additions and deletions within a collapsed subtree should not affect the overall number of elements.
+    if (!isInsideCollapsedSubTree) {
+      this._weightAcrossRoots += weightDelta;
+    }
+  };
+
+  onBridgeNativeStyleEditorSupported = ({
+    isSupported,
+    validAttributes,
+  }: {|
+    isSupported: boolean,
+    validAttributes: ?$ReadOnlyArray<string>,
+  |}) => {
+    this._isNativeStyleEditorSupported = isSupported;
+    this._nativeStyleEditorValidAttributes = validAttributes || null;
+
+    this.emit('supportsNativeStyleEditor');
+  };
+
+  onBridgeOperations = (operations: Array<number>) => {
+    if (__DEBUG__) {
+      console.groupCollapsed('onBridgeOperations');
+      debug('onBridgeOperations', operations.join(','));
+    }
+
+    let haveRootsChanged = false;
+
+    // The first two values are always rendererID and rootID
+    const rendererID = operations[0];
+
+    const addedElementIDs: Array<number> = [];
+    // This is a mapping of removed ID -> parent ID:
+    const removedElementIDs: Map<number, number> = new Map();
+    // We'll use the parent ID to adjust selection if it gets deleted.
+
+    let i = 2;
+
+    // Reassemble the string table.
+    const stringTable = [
+      null, // ID = 0 corresponds to the null string.
+    ];
+    const stringTableSize = operations[i++];
+    const stringTableEnd = i + stringTableSize;
+    while (i < stringTableEnd) {
+      const nextLength = operations[i++];
+      const nextString = utfDecodeString(
+        (operations.slice(i, i + nextLength): any)
+      );
+      stringTable.push(nextString);
+      i += nextLength;
+    }
+
+    while (i < operations.length) {
+      const operation = operations[i];
+      switch (operation) {
+        case TREE_OPERATION_ADD: {
+          const id = ((operations[i + 1]: any): number);
+          const type = ((operations[i + 2]: any): ElementType);
+
+          i = i + 3;
+
+          if (this._idToElement.has(id)) {
+            throw Error(
+              `Cannot add node ${id} because a node with that id is already in the Store.`
+            );
+          }
+
+          let ownerID: number = 0;
+          let parentID: number = ((null: any): number);
+          if (type === ElementTypeRoot) {
+            if (__DEBUG__) {
+              debug('Add', `new root node ${id}`);
+            }
+
+            const supportsProfiling = operations[i] > 0;
+            i++;
+
+            const hasOwnerMetadata = operations[i] > 0;
+            i++;
+
+            this._roots = this._roots.concat(id);
+            this._rootIDToRendererID.set(id, rendererID);
+            this._rootIDToCapabilities.set(id, {
+              hasOwnerMetadata,
+              supportsProfiling,
+            });
+
+            this._idToElement.set(id, {
+              children: [],
+              depth: -1,
+              displayName: null,
+              hocDisplayNames: null,
+              id,
+              isCollapsed: false, // Never collapse roots; it would hide the entire tree.
+              key: null,
+              ownerID: 0,
+              parentID: 0,
+              type,
+              weight: 0,
+            });
+
+            haveRootsChanged = true;
+          } else {
+            parentID = ((operations[i]: any): number);
+            i++;
+
+            ownerID = ((operations[i]: any): number);
+            i++;
+
+            const displayNameStringID = operations[i];
+            const displayName = stringTable[displayNameStringID];
+            i++;
+
+            const keyStringID = operations[i];
+            const key = stringTable[keyStringID];
+            i++;
+
+            if (__DEBUG__) {
+              debug(
+                'Add',
+                `node ${id} (${displayName || 'null'}) as child of ${parentID}`
+              );
+            }
+
+            if (!this._idToElement.has(parentID)) {
+              throw Error(
+                `Cannot add child ${id} to parent ${parentID} because parent node was not found in the Store.`
+              );
+            }
+
+            const parentElement = ((this._idToElement.get(
+              parentID
+            ): any): Element);
+            parentElement.children.push(id);
+
+            const [
+              displayNameWithoutHOCs,
+              hocDisplayNames,
+            ] = separateDisplayNameAndHOCs(displayName, type);
+
+            const element: Element = {
+              children: [],
+              depth: parentElement.depth + 1,
+              displayName: displayNameWithoutHOCs,
+              hocDisplayNames,
+              id,
+              isCollapsed: this._collapseNodesByDefault,
+              key,
+              ownerID,
+              parentID: parentElement.id,
+              type,
+              weight: 1,
+            };
+
+            this._idToElement.set(id, element);
+            addedElementIDs.push(id);
+            this._adjustParentTreeWeight(parentElement, 1);
+
+            if (ownerID > 0) {
+              let set = this._ownersMap.get(ownerID);
+              if (set === undefined) {
+                set = new Set();
+                this._ownersMap.set(ownerID, set);
+              }
+              set.add(id);
+            }
+          }
+          break;
+        }
+        case TREE_OPERATION_REMOVE: {
+          const removeLength = ((operations[i + 1]: any): number);
+          i = i + 2;
+
+          for (let removeIndex = 0; removeIndex < removeLength; removeIndex++) {
+            const id = ((operations[i]: any): number);
+
+            if (!this._idToElement.has(id)) {
+              throw Error(
+                `Cannot remove node ${id} because no matching node was found in the Store.`
+              );
+            }
+
+            i = i + 1;
+
+            const element = ((this._idToElement.get(id): any): Element);
+            const { children, ownerID, parentID, weight } = element;
+            if (children.length > 0) {
+              throw new Error(`Node ${id} was removed before its children.`);
+            }
+
+            this._idToElement.delete(id);
+
+            let parentElement = null;
+            if (parentID === 0) {
+              if (__DEBUG__) {
+                debug('Remove', `node ${id} root`);
+              }
+
+              this._roots = this._roots.filter(rootID => rootID !== id);
+              this._rootIDToRendererID.delete(id);
+              this._rootIDToCapabilities.delete(id);
+
+              haveRootsChanged = true;
+            } else {
+              if (__DEBUG__) {
+                debug('Remove', `node ${id} from parent ${parentID}`);
+              }
+              parentElement = ((this._idToElement.get(parentID): any): Element);
+              if (parentElement === undefined) {
+                throw Error(
+                  `Cannot remove node ${id} from parent ${parentID} because no matching node was found in the Store.`
+                );
+              }
+              const index = parentElement.children.indexOf(id);
+              parentElement.children.splice(index, 1);
+            }
+
+            this._adjustParentTreeWeight(parentElement, -weight);
+            removedElementIDs.set(id, parentID);
+
+            this._ownersMap.delete(id);
+            if (ownerID > 0) {
+              const set = this._ownersMap.get(ownerID);
+              if (set !== undefined) {
+                set.delete(id);
+              }
+            }
+          }
+          break;
+        }
+        case TREE_OPERATION_REORDER_CHILDREN: {
+          const id = ((operations[i + 1]: any): number);
+          const numChildren = ((operations[i + 2]: any): number);
+          i = i + 3;
+
+          if (!this._idToElement.has(id)) {
+            throw Error(
+              `Cannot reorder children for node ${id} because no matching node was found in the Store.`
+            );
+          }
+
+          const element = ((this._idToElement.get(id): any): Element);
+          const children = element.children;
+          if (children.length !== numChildren) {
+            throw Error(
+              `Children cannot be added or removed during a reorder operation.`
+            );
+          }
+
+          for (let j = 0; j < numChildren; j++) {
+            const childID = operations[i + j];
+            children[j] = childID;
+            if (__DEV__) {
+              // This check is more expensive so it's gated by __DEV__.
+              const childElement = this._idToElement.get(childID);
+              if (childElement == null || childElement.parentID !== id) {
+                console.error(
+                  `Children cannot be added or removed during a reorder operation.`
+                );
+              }
+            }
+          }
+          i = i + numChildren;
+
+          if (__DEBUG__) {
+            debug('Re-order', `Node ${id} children ${children.join(',')}`);
+          }
+          break;
+        }
+        case TREE_OPERATION_UPDATE_TREE_BASE_DURATION:
+          // Base duration updates are only sent while profiling is in progress.
+          // We can ignore them at this point.
+          // The profiler UI uses them lazily in order to generate the tree.
+          i = i + 3;
+          break;
+        default:
+          throw Error(`Unsupported Bridge operation ${operation}`);
+      }
+    }
+
+    this._revision++;
+
+    if (haveRootsChanged) {
+      const prevSupportsProfiling = this._supportsProfiling;
+
+      this._hasOwnerMetadata = false;
+      this._supportsProfiling = false;
+      this._rootIDToCapabilities.forEach(
+        ({ hasOwnerMetadata, supportsProfiling }) => {
+          if (hasOwnerMetadata) {
+            this._hasOwnerMetadata = true;
+          }
+          if (supportsProfiling) {
+            this._supportsProfiling = true;
+          }
+        }
+      );
+
+      this.emit('roots');
+
+      if (this._supportsProfiling !== prevSupportsProfiling) {
+        this.emit('supportsProfiling');
+      }
+    }
+
+    if (__DEBUG__) {
+      console.log(printStore(this, true));
+      console.groupEnd();
+    }
+
+    this.emit('mutated', [addedElementIDs, removedElementIDs]);
+  };
+
+  // Certain backends save filters on a per-domain basis.
+  // In order to prevent filter preferences and applied filters from being out of sync,
+  // this message enables the backend to override the frontend's current ("saved") filters.
+  // This action should also override the saved filters too,
+  // else reloading the frontend without reloading the backend would leave things out of sync.
+  onBridgeOverrideComponentFilters = (
+    componentFilters: Array<ComponentFilter>
+  ) => {
+    this._componentFilters = componentFilters;
+
+    saveComponentFilters(componentFilters);
+  };
+
+  onBridgeShutdown = () => {
+    if (__DEBUG__) {
+      debug('onBridgeShutdown', 'unsubscribing from Bridge');
+    }
+
+    this._bridge.removeListener('operations', this.onBridgeOperations);
+    this._bridge.removeListener('shutdown', this.onBridgeShutdown);
+    this._bridge.removeListener(
+      'isBackendStorageAPISupported',
+      this.onBridgeStorageSupported
+    );
+  };
+
+  onBridgeStorageSupported = (isBackendStorageAPISupported: boolean) => {
+    this._isBackendStorageAPISupported = isBackendStorageAPISupported;
+
+    this.emit('supportsReloadAndProfile');
+  };
+}

commit 08743b1a8e012c1a36ba99391c6332e462b808b2
Author: Brian Vaughn <bvaughn@fb.com>
Date:   Tue Aug 13 15:59:43 2019 -0700

    Reorganized folders into packages/*

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index e032463957..9492a4dc7c 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -18,12 +18,12 @@ import {
 } from '../utils';
 import { localStorageGetItem, localStorageSetItem } from '../storage';
 import { __DEBUG__ } from '../constants';
-import { printStore } from 'src/__tests__/storeSerializer';
+import { printStore } from '../__tests__/storeSerializer';
 import ProfilerStore from './ProfilerStore';
 
 import type { Element } from './views/Components/types';
 import type { ComponentFilter, ElementType } from '../types';
-import type { FrontendBridge } from 'src/bridge';
+import type { FrontendBridge } from 'react-devtools-shared/src/bridge';
 
 const debug = (methodName, ...args) => {
   if (__DEBUG__) {

commit edc46d7be7ce8fff2b5c21a00eb6741efbb9ef42
Author: Brian Vaughn <bvaughn@fb.com>
Date:   Tue Aug 13 17:53:28 2019 -0700

    Misc Flow and import fixes
    
    1. Fixed all reported Flow errors
    2. Added a few missing package declarations
    3. Deleted ReactDebugHooks fork in favor of react-debug-tools

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index 9492a4dc7c..6dc4fd2334 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -1,6 +1,6 @@
 // @flow
 
-import EventEmitter from 'events';
+import EventEmitter from 'node-events';
 import { inspect } from 'util';
 import {
   TREE_OPERATION_ADD,
@@ -18,7 +18,7 @@ import {
 } from '../utils';
 import { localStorageGetItem, localStorageSetItem } from '../storage';
 import { __DEBUG__ } from '../constants';
-import { printStore } from '../__tests__/storeSerializer';
+import { printStore } from './utils';
 import ProfilerStore from './ProfilerStore';
 
 import type { Element } from './views/Components/types';

commit 183f96f2ac35c36772781cb37bc3ce842e2dc78b
Author: Brian Vaughn <bvaughn@fb.com>
Date:   Tue Aug 13 17:58:03 2019 -0700

    Prettier

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index 6dc4fd2334..5a8e844107 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -1,14 +1,14 @@
 // @flow
 
 import EventEmitter from 'node-events';
-import { inspect } from 'util';
+import {inspect} from 'util';
 import {
   TREE_OPERATION_ADD,
   TREE_OPERATION_REMOVE,
   TREE_OPERATION_REORDER_CHILDREN,
   TREE_OPERATION_UPDATE_TREE_BASE_DURATION,
 } from '../constants';
-import { ElementTypeRoot } from '../types';
+import {ElementTypeRoot} from '../types';
 import {
   getSavedComponentFilters,
   saveComponentFilters,
@@ -16,14 +16,14 @@ import {
   shallowDiffers,
   utfDecodeString,
 } from '../utils';
-import { localStorageGetItem, localStorageSetItem } from '../storage';
-import { __DEBUG__ } from '../constants';
-import { printStore } from './utils';
+import {localStorageGetItem, localStorageSetItem} from '../storage';
+import {__DEBUG__} from '../constants';
+import {printStore} from './utils';
 import ProfilerStore from './ProfilerStore';
 
-import type { Element } from './views/Components/types';
-import type { ComponentFilter, ElementType } from '../types';
-import type { FrontendBridge } from 'react-devtools-shared/src/bridge';
+import type {Element} from './views/Components/types';
+import type {ComponentFilter, ElementType} from '../types';
+import type {FrontendBridge} from 'react-devtools-shared/src/bridge';
 
 const debug = (methodName, ...args) => {
   if (__DEBUG__) {
@@ -31,7 +31,7 @@ const debug = (methodName, ...args) => {
       `%cStore %c${methodName}`,
       'color: green; font-weight: bold;',
       'font-weight: bold;',
-      ...args
+      ...args,
     );
   }
 };
@@ -161,16 +161,16 @@ export default class Store extends EventEmitter<{|
     bridge.addListener('operations', this.onBridgeOperations);
     bridge.addListener(
       'overrideComponentFilters',
-      this.onBridgeOverrideComponentFilters
+      this.onBridgeOverrideComponentFilters,
     );
     bridge.addListener('shutdown', this.onBridgeShutdown);
     bridge.addListener(
       'isBackendStorageAPISupported',
-      this.onBridgeStorageSupported
+      this.onBridgeStorageSupported,
     );
     bridge.addListener(
       'isNativeStyleEditorSupported',
-      this.onBridgeNativeStyleEditorSupported
+      this.onBridgeNativeStyleEditorSupported,
     );
 
     this._profilerStore = new ProfilerStore(bridge, this, isProfiling);
@@ -187,11 +187,11 @@ export default class Store extends EventEmitter<{|
     // These maps should always be the same size as the number of roots
     this.assertMapSizeMatchesRootCount(
       this._rootIDToCapabilities,
-      '_rootIDToCapabilities'
+      '_rootIDToCapabilities',
     );
     this.assertMapSizeMatchesRootCount(
       this._rootIDToRendererID,
-      '_rootIDToRendererID'
+      '_rootIDToRendererID',
     );
   }
 
@@ -204,7 +204,7 @@ export default class Store extends EventEmitter<{|
           map.size
         } items\n\n${inspect(map, {
           depth: 20,
-        })}`
+        })}`,
       );
     }
   }
@@ -217,7 +217,7 @@ export default class Store extends EventEmitter<{|
 
     localStorageSetItem(
       LOCAL_STORAGE_COLLAPSE_ROOTS_BY_DEFAULT_KEY,
-      value ? 'true' : 'false'
+      value ? 'true' : 'false',
     );
 
     this.emit('collapseNodesByDefault');
@@ -236,10 +236,10 @@ export default class Store extends EventEmitter<{|
     // Filter updates are expensive to apply (since they impact the entire tree).
     // Let's determine if they've changed and avoid doing this work if they haven't.
     const prevEnabledComponentFilters = this._componentFilters.filter(
-      filter => filter.isEnabled
+      filter => filter.isEnabled,
     );
     const nextEnabledComponentFilters = value.filter(
-      filter => filter.isEnabled
+      filter => filter.isEnabled,
     );
     let haveEnabledFiltersChanged =
       prevEnabledComponentFilters.length !== nextEnabledComponentFilters.length;
@@ -293,7 +293,7 @@ export default class Store extends EventEmitter<{|
 
     localStorageSetItem(
       LOCAL_STORAGE_RECORD_CHANGE_DESCRIPTIONS_KEY,
-      value ? 'true' : 'false'
+      value ? 'true' : 'false',
     );
 
     this.emit('recordChangeDescriptions');
@@ -339,7 +339,7 @@ export default class Store extends EventEmitter<{|
       console.warn(
         `Invalid index ${index} specified; store contains ${
           this.numElements
-        } items.`
+        } items.`,
       );
 
       return null;
@@ -417,7 +417,7 @@ export default class Store extends EventEmitter<{|
     while (true) {
       const current = ((this._idToElement.get(currentID): any): Element);
 
-      const { children } = current;
+      const {children} = current;
       for (let i = 0; i < children.length; i++) {
         const childID = children[i];
         if (childID === previousID) {
@@ -474,7 +474,7 @@ export default class Store extends EventEmitter<{|
         const sortedIDs = Array.from(unsortedIDs).sort(
           (idA, idB) =>
             ((this.getIndexOfElementID(idA): any): number) -
-            ((this.getIndexOfElementID(idB): any): number)
+            ((this.getIndexOfElementID(idB): any): number),
         );
 
         // Next we need to determine the appropriate depth for each element in the list.
@@ -506,7 +506,7 @@ export default class Store extends EventEmitter<{|
               throw Error('Invalid owners list');
             }
 
-            list.push({ ...element, depth });
+            list.push({...element, depth});
           }
         });
       }
@@ -573,7 +573,7 @@ export default class Store extends EventEmitter<{|
           const weightDelta = 1 - element.weight;
 
           let parentElement = ((this._idToElement.get(
-            element.parentID
+            element.parentID,
           ): any): Element);
           while (parentElement != null) {
             // We don't need to break on a collapsed parent in the same way as the expand case below.
@@ -599,7 +599,7 @@ export default class Store extends EventEmitter<{|
             const weightDelta = newWeight - oldWeight;
 
             let parentElement = ((this._idToElement.get(
-              currentElement.parentID
+              currentElement.parentID,
             ): any): Element);
             while (parentElement != null) {
               parentElement.weight += weightDelta;
@@ -624,7 +624,7 @@ export default class Store extends EventEmitter<{|
       if (didMutate) {
         let weightAcrossRoots = 0;
         this._roots.forEach(rootID => {
-          const { weight } = ((this.getElementByID(rootID): any): Element);
+          const {weight} = ((this.getElementByID(rootID): any): Element);
           weightAcrossRoots += weight;
         });
         this._weightAcrossRoots = weightAcrossRoots;
@@ -639,7 +639,7 @@ export default class Store extends EventEmitter<{|
 
   _adjustParentTreeWeight = (
     parentElement: Element | null,
-    weightDelta: number
+    weightDelta: number,
   ) => {
     let isInsideCollapsedSubTree = false;
 
@@ -654,7 +654,7 @@ export default class Store extends EventEmitter<{|
       }
 
       parentElement = ((this._idToElement.get(
-        parentElement.parentID
+        parentElement.parentID,
       ): any): Element);
     }
 
@@ -704,7 +704,7 @@ export default class Store extends EventEmitter<{|
     while (i < stringTableEnd) {
       const nextLength = operations[i++];
       const nextString = utfDecodeString(
-        (operations.slice(i, i + nextLength): any)
+        (operations.slice(i, i + nextLength): any),
       );
       stringTable.push(nextString);
       i += nextLength;
@@ -721,7 +721,7 @@ export default class Store extends EventEmitter<{|
 
           if (this._idToElement.has(id)) {
             throw Error(
-              `Cannot add node ${id} because a node with that id is already in the Store.`
+              `Cannot add node ${id} because a node with that id is already in the Store.`,
             );
           }
 
@@ -778,18 +778,18 @@ export default class Store extends EventEmitter<{|
             if (__DEBUG__) {
               debug(
                 'Add',
-                `node ${id} (${displayName || 'null'}) as child of ${parentID}`
+                `node ${id} (${displayName || 'null'}) as child of ${parentID}`,
               );
             }
 
             if (!this._idToElement.has(parentID)) {
               throw Error(
-                `Cannot add child ${id} to parent ${parentID} because parent node was not found in the Store.`
+                `Cannot add child ${id} to parent ${parentID} because parent node was not found in the Store.`,
               );
             }
 
             const parentElement = ((this._idToElement.get(
-              parentID
+              parentID,
             ): any): Element);
             parentElement.children.push(id);
 
@@ -836,14 +836,14 @@ export default class Store extends EventEmitter<{|
 
             if (!this._idToElement.has(id)) {
               throw Error(
-                `Cannot remove node ${id} because no matching node was found in the Store.`
+                `Cannot remove node ${id} because no matching node was found in the Store.`,
               );
             }
 
             i = i + 1;
 
             const element = ((this._idToElement.get(id): any): Element);
-            const { children, ownerID, parentID, weight } = element;
+            const {children, ownerID, parentID, weight} = element;
             if (children.length > 0) {
               throw new Error(`Node ${id} was removed before its children.`);
             }
@@ -868,7 +868,7 @@ export default class Store extends EventEmitter<{|
               parentElement = ((this._idToElement.get(parentID): any): Element);
               if (parentElement === undefined) {
                 throw Error(
-                  `Cannot remove node ${id} from parent ${parentID} because no matching node was found in the Store.`
+                  `Cannot remove node ${id} from parent ${parentID} because no matching node was found in the Store.`,
                 );
               }
               const index = parentElement.children.indexOf(id);
@@ -895,7 +895,7 @@ export default class Store extends EventEmitter<{|
 
           if (!this._idToElement.has(id)) {
             throw Error(
-              `Cannot reorder children for node ${id} because no matching node was found in the Store.`
+              `Cannot reorder children for node ${id} because no matching node was found in the Store.`,
             );
           }
 
@@ -903,7 +903,7 @@ export default class Store extends EventEmitter<{|
           const children = element.children;
           if (children.length !== numChildren) {
             throw Error(
-              `Children cannot be added or removed during a reorder operation.`
+              `Children cannot be added or removed during a reorder operation.`,
             );
           }
 
@@ -915,7 +915,7 @@ export default class Store extends EventEmitter<{|
               const childElement = this._idToElement.get(childID);
               if (childElement == null || childElement.parentID !== id) {
                 console.error(
-                  `Children cannot be added or removed during a reorder operation.`
+                  `Children cannot be added or removed during a reorder operation.`,
                 );
               }
             }
@@ -946,14 +946,14 @@ export default class Store extends EventEmitter<{|
       this._hasOwnerMetadata = false;
       this._supportsProfiling = false;
       this._rootIDToCapabilities.forEach(
-        ({ hasOwnerMetadata, supportsProfiling }) => {
+        ({hasOwnerMetadata, supportsProfiling}) => {
           if (hasOwnerMetadata) {
             this._hasOwnerMetadata = true;
           }
           if (supportsProfiling) {
             this._supportsProfiling = true;
           }
-        }
+        },
       );
 
       this.emit('roots');
@@ -977,7 +977,7 @@ export default class Store extends EventEmitter<{|
   // This action should also override the saved filters too,
   // else reloading the frontend without reloading the backend would leave things out of sync.
   onBridgeOverrideComponentFilters = (
-    componentFilters: Array<ComponentFilter>
+    componentFilters: Array<ComponentFilter>,
   ) => {
     this._componentFilters = componentFilters;
 
@@ -993,7 +993,7 @@ export default class Store extends EventEmitter<{|
     this._bridge.removeListener('shutdown', this.onBridgeShutdown);
     this._bridge.removeListener(
       'isBackendStorageAPISupported',
-      this.onBridgeStorageSupported
+      this.onBridgeStorageSupported,
     );
   };
 

commit ac2e861fbe05901b874e3ab49807abab820ef648
Author: Brian Vaughn <bvaughn@fb.com>
Date:   Tue Aug 13 21:59:07 2019 -0700

    Fixed a bunch of Lint issues

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index 5a8e844107..cc657bdec4 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -484,9 +484,9 @@ export default class Store extends EventEmitter<{|
         // (1) another node that's already in the tree, or (2) the root (owner)
         // at which point, our depth is just the depth of that node plus one.
         sortedIDs.forEach(id => {
-          const element = this._idToElement.get(id);
-          if (element != null) {
-            let parentID = element.parentID;
+          const innerElement = this._idToElement.get(id);
+          if (innerElement != null) {
+            let parentID = innerElement.parentID;
 
             let depth = 0;
             while (parentID > 0) {
@@ -506,7 +506,7 @@ export default class Store extends EventEmitter<{|
               throw Error('Invalid owners list');
             }
 
-            list.push({...element, depth});
+            list.push({...innerElement, depth});
           }
         });
       }
@@ -717,7 +717,7 @@ export default class Store extends EventEmitter<{|
           const id = ((operations[i + 1]: any): number);
           const type = ((operations[i + 2]: any): ElementType);
 
-          i = i + 3;
+          i += 3;
 
           if (this._idToElement.has(id)) {
             throw Error(
@@ -829,7 +829,7 @@ export default class Store extends EventEmitter<{|
         }
         case TREE_OPERATION_REMOVE: {
           const removeLength = ((operations[i + 1]: any): number);
-          i = i + 2;
+          i += 2;
 
           for (let removeIndex = 0; removeIndex < removeLength; removeIndex++) {
             const id = ((operations[i]: any): number);
@@ -840,7 +840,7 @@ export default class Store extends EventEmitter<{|
               );
             }
 
-            i = i + 1;
+            i += 1;
 
             const element = ((this._idToElement.get(id): any): Element);
             const {children, ownerID, parentID, weight} = element;
@@ -891,7 +891,7 @@ export default class Store extends EventEmitter<{|
         case TREE_OPERATION_REORDER_CHILDREN: {
           const id = ((operations[i + 1]: any): number);
           const numChildren = ((operations[i + 2]: any): number);
-          i = i + 3;
+          i += 3;
 
           if (!this._idToElement.has(id)) {
             throw Error(
@@ -920,7 +920,7 @@ export default class Store extends EventEmitter<{|
               }
             }
           }
-          i = i + numChildren;
+          i += numChildren;
 
           if (__DEBUG__) {
             debug('Re-order', `Node ${id} children ${children.join(',')}`);
@@ -931,7 +931,7 @@ export default class Store extends EventEmitter<{|
           // Base duration updates are only sent while profiling is in progress.
           // We can ignore them at this point.
           // The profiler UI uses them lazily in order to generate the tree.
-          i = i + 3;
+          i += 3;
           break;
         default:
           throw Error(`Unsupported Bridge operation ${operation}`);

commit 4078167255d00d478bf5156bed74b90b406c1482
Author: Brian Vaughn <bvaughn@fb.com>
Date:   Wed Aug 14 11:43:59 2019 -0700

    Removed (no longer necessary) node->node-events mapping

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index cc657bdec4..31756d573f 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -1,6 +1,6 @@
 // @flow
 
-import EventEmitter from 'node-events';
+import EventEmitter from 'events';
 import {inspect} from 'util';
 import {
   TREE_OPERATION_ADD,

commit 8e1434e80e203ebd2cd066772d68f121808c83aa
Author: Brian Vaughn <bvaughn@fb.com>
Date:   Tue Aug 27 10:54:01 2019 -0700

    Added FB copyright header

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index 31756d573f..68264ddeb4 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -1,4 +1,11 @@
-// @flow
+/**
+ * Copyright (c) Facebook, Inc. and its affiliates.
+ *
+ * This source code is licensed under the MIT license found in the
+ * LICENSE file in the root directory of this source tree.
+ *
+ * @flow
+ */
 
 import EventEmitter from 'events';
 import {inspect} from 'util';

commit b6606ecba80b591ea66db1e2ee1fed72befb4c32
Author: Brian Vaughn <bvaughn@fb.com>
Date:   Thu Sep 26 08:41:46 2019 -0700

    DevTools shows unsupported renderer version dialog (#16897)
    
    * DevTools shows unsupported renderer version dialog
    
    * Optimistic CHANGELOG udpate

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index 68264ddeb4..efbcf02196 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -73,6 +73,7 @@ export default class Store extends EventEmitter<{|
   supportsNativeStyleEditor: [],
   supportsProfiling: [],
   supportsReloadAndProfile: [],
+  unsupportedRendererVersionDetected: [],
 |}> {
   _bridge: FrontendBridge;
 
@@ -125,6 +126,8 @@ export default class Store extends EventEmitter<{|
   _supportsProfiling: boolean = false;
   _supportsReloadAndProfile: boolean = false;
 
+  _unsupportedRendererVersionDetected: boolean = false;
+
   // Total number of visible elements (within all roots).
   // Used for windowing purposes.
   _weightAcrossRoots: number = 0;
@@ -179,6 +182,10 @@ export default class Store extends EventEmitter<{|
       'isNativeStyleEditorSupported',
       this.onBridgeNativeStyleEditorSupported,
     );
+    bridge.addListener(
+      'unsupportedRendererVersion',
+      this.onBridgeUnsupportedRendererVersion,
+    );
 
     this._profilerStore = new ProfilerStore(bridge, this, isProfiling);
   }
@@ -337,6 +344,10 @@ export default class Store extends EventEmitter<{|
     return this._supportsReloadAndProfile && this._isBackendStorageAPISupported;
   }
 
+  get unsupportedRendererVersionDetected(): boolean {
+    return this._unsupportedRendererVersionDetected;
+  }
+
   containsElement(id: number): boolean {
     return this._idToElement.get(id) != null;
   }
@@ -1009,4 +1020,10 @@ export default class Store extends EventEmitter<{|
 
     this.emit('supportsReloadAndProfile');
   };
+
+  onBridgeUnsupportedRendererVersion = () => {
+    this._unsupportedRendererVersionDetected = true;
+
+    this.emit('unsupportedRendererVersionDetected');
+  };
 }

commit 0545f366d4d6b5959f4bb172e810c745f74b9513
Author: Brian Vaughn <bvaughn@fb.com>
Date:   Thu Oct 3 11:07:18 2019 -0700

    Added trace updates feature (DOM only) (#16989)
    
    * Added trace updates feature (DOM only)
    * Updated DevTools CHANGELOG

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index efbcf02196..5cb23a4d2e 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -53,6 +53,7 @@ type Config = {|
   supportsNativeInspection?: boolean,
   supportsReloadAndProfile?: boolean,
   supportsProfiling?: boolean,
+  supportsTraceUpdates?: boolean,
 |};
 
 export type Capabilities = {|
@@ -125,6 +126,7 @@ export default class Store extends EventEmitter<{|
   _supportsNativeInspection: boolean = true;
   _supportsProfiling: boolean = false;
   _supportsReloadAndProfile: boolean = false;
+  _supportsTraceUpdates: boolean = false;
 
   _unsupportedRendererVersionDetected: boolean = false;
 
@@ -157,6 +159,7 @@ export default class Store extends EventEmitter<{|
         supportsNativeInspection,
         supportsProfiling,
         supportsReloadAndProfile,
+        supportsTraceUpdates,
       } = config;
       this._supportsNativeInspection = supportsNativeInspection !== false;
       if (supportsProfiling) {
@@ -165,6 +168,9 @@ export default class Store extends EventEmitter<{|
       if (supportsReloadAndProfile) {
         this._supportsReloadAndProfile = true;
       }
+      if (supportsTraceUpdates) {
+        this._supportsTraceUpdates = true;
+      }
     }
 
     this._bridge = bridge;
@@ -336,7 +342,6 @@ export default class Store extends EventEmitter<{|
   get supportsProfiling(): boolean {
     return this._supportsProfiling;
   }
-
   get supportsReloadAndProfile(): boolean {
     // Does the DevTools shell support reloading and eagerly injecting the renderer interface?
     // And if so, can the backend use the localStorage API?
@@ -344,6 +349,10 @@ export default class Store extends EventEmitter<{|
     return this._supportsReloadAndProfile && this._isBackendStorageAPISupported;
   }
 
+  get supportsTraceUpdates(): boolean {
+    return this._supportsTraceUpdates;
+  }
+
   get unsupportedRendererVersionDetected(): boolean {
     return this._unsupportedRendererVersionDetected;
   }

commit b979db4e7215957f03c4221622f0b115a868439a
Author: Dan Abramov <dan.abramov@gmail.com>
Date:   Thu Jan 9 13:54:11 2020 +0000

    Bump Prettier (#17811)
    
    * Bump Prettier
    
    * Reformat
    
    * Use non-deprecated option

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index 5cb23a4d2e..ad46873c35 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -364,9 +364,7 @@ export default class Store extends EventEmitter<{|
   getElementAtIndex(index: number): Element | null {
     if (index < 0 || index >= this.numElements) {
       console.warn(
-        `Invalid index ${index} specified; store contains ${
-          this.numElements
-        } items.`,
+        `Invalid index ${index} specified; store contains ${this.numElements} items.`,
       );
 
       return null;

commit bd5781962a930cb7d046148b9d8ee9ccd3e9247f
Author: Brian Vaughn <bvaughn@fb.com>
Date:   Wed Mar 25 10:26:40 2020 -0700

    Inlined DevTools event emitter impl (#18378)
    
    DevTools previously used the NPM events package for dispatching events. This package has an unfortunate flaw though- if a listener throws during event dispatch, no subsequent listeners are called. I've replaced that event dispatcher with my own implementation that ensures all listeners are called before it re-throws an error.
    
    This commit replaces that event emitter with a custom implementation that calls all listeners before re-throwing an error.

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index ad46873c35..1e246cab0b 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -7,7 +7,7 @@
  * @flow
  */
 
-import EventEmitter from 'events';
+import EventEmitter from '../events';
 import {inspect} from 'util';
 import {
   TREE_OPERATION_ADD,

commit 3e94bce765d355d74f6a60feb4addb6d196e3482
Author: Sebastian Markbge <sebastian@calyptus.eu>
Date:   Wed Apr 1 12:35:52 2020 -0700

    Enable prefer-const lint rules (#18451)
    
    * Enable prefer-const rule
    
    Stylistically I don't like this but Closure Compiler takes advantage of
    this information.
    
    * Auto-fix lints
    
    * Manually fix the remaining callsites

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index 1e246cab0b..3d98d0ff15 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -479,7 +479,7 @@ export default class Store extends EventEmitter<{|
 
   getOwnersListForElement(ownerID: number): Array<Element> {
     const list = [];
-    let element = this._idToElement.get(ownerID);
+    const element = this._idToElement.get(ownerID);
     if (element != null) {
       list.push({
         ...element,

commit 30b47103d4354d9187dc0f1fb804855a5208ca9f
Author: Rick Hanlon <rickhanlonii@gmail.com>
Date:   Mon Jun 15 19:59:44 2020 -0400

    Fix spelling errors and typos (#19138)

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index 3d98d0ff15..cd829bb3bf 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -370,7 +370,7 @@ export default class Store extends EventEmitter<{|
       return null;
     }
 
-    // Find wich root this element is in...
+    // Find which root this element is in...
     let rootID;
     let root;
     let rootWeight = 0;

commit 09a2c363a5175291ecdcbf7f39b0d165bc7da8ec
Author: Sebastian Silbermann <silbermann.sebastian@gmail.com>
Date:   Tue Dec 22 17:09:29 2020 +0100

    Expose DEV-mode warnings in devtools UI (#20463)
    
    Co-authored-by: Brian Vaughn <bvaughn@fb.com>

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index cd829bb3bf..6b1b83e524 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -12,7 +12,9 @@ import {inspect} from 'util';
 import {
   TREE_OPERATION_ADD,
   TREE_OPERATION_REMOVE,
+  TREE_OPERATION_REMOVE_ROOT,
   TREE_OPERATION_REORDER_CHILDREN,
+  TREE_OPERATION_UPDATE_ERRORS_OR_WARNINGS,
   TREE_OPERATION_UPDATE_TREE_BASE_DURATION,
 } from '../constants';
 import {ElementTypeRoot} from '../types';
@@ -78,11 +80,22 @@ export default class Store extends EventEmitter<{|
 |}> {
   _bridge: FrontendBridge;
 
+  // Computed whenever _errorsAndWarnings Map changes.
+  _cachedErrorCount: number = 0;
+  _cachedWarningCount: number = 0;
+  _cachedErrorAndWarningTuples: Array<{|id: number, index: number|}> = [];
+
   // Should new nodes be collapsed by default when added to the tree?
   _collapseNodesByDefault: boolean = true;
 
   _componentFilters: Array<ComponentFilter>;
 
+  // Map of ID to number of recorded error and warning message IDs.
+  _errorsAndWarnings: Map<
+    number,
+    {|errorCount: number, warningCount: number|},
+  > = new Map();
+
   // At least one of the injected renderers contains (DEV only) owner metadata.
   _hasOwnerMetadata: boolean = false;
 
@@ -289,6 +302,10 @@ export default class Store extends EventEmitter<{|
     this.emit('componentFilters');
   }
 
+  get errorCount(): number {
+    return this._cachedErrorCount;
+  }
+
   get hasOwnerMetadata(): boolean {
     return this._hasOwnerMetadata;
   }
@@ -357,6 +374,46 @@ export default class Store extends EventEmitter<{|
     return this._unsupportedRendererVersionDetected;
   }
 
+  get warningCount(): number {
+    return this._cachedWarningCount;
+  }
+
+  clearErrorsAndWarnings(): void {
+    this._rootIDToRendererID.forEach(rendererID => {
+      this._bridge.send('clearErrorsAndWarnings', {
+        rendererID,
+      });
+    });
+  }
+
+  clearErrorsForElement(id: number): void {
+    const rendererID = this.getRendererIDForElement(id);
+    if (rendererID === null) {
+      console.warn(
+        `Unable to find rendererID for element ${id} when clearing errors.`,
+      );
+    } else {
+      this._bridge.send('clearErrorsForFiberID', {
+        rendererID,
+        id,
+      });
+    }
+  }
+
+  clearWarningsForElement(id: number): void {
+    const rendererID = this.getRendererIDForElement(id);
+    if (rendererID === null) {
+      console.warn(
+        `Unable to find rendererID for element ${id} when clearing warnings.`,
+      );
+    } else {
+      this._bridge.send('clearWarningsForFiberID', {
+        rendererID,
+        id,
+      });
+    }
+  }
+
   containsElement(id: number): boolean {
     return this._idToElement.get(id) != null;
   }
@@ -425,6 +482,17 @@ export default class Store extends EventEmitter<{|
     return element;
   }
 
+  // Returns a tuple of [id, index]
+  getElementsWithErrorsAndWarnings(): Array<{|id: number, index: number|}> {
+    return this._cachedErrorAndWarningTuples;
+  }
+
+  getErrorAndWarningCountForElementID(
+    id: number,
+  ): {|errorCount: number, warningCount: number|} {
+    return this._errorsAndWarnings.get(id) || {errorCount: 0, warningCount: 0};
+  }
+
   getIndexOfElementID(id: number): number | null {
     const element = this.getElementByID(id);
 
@@ -709,6 +777,7 @@ export default class Store extends EventEmitter<{|
     }
 
     let haveRootsChanged = false;
+    let haveErrorsOrWarningsChanged = false;
 
     // The first two values are always rendererID and rootID
     const rendererID = operations[0];
@@ -910,7 +979,41 @@ export default class Store extends EventEmitter<{|
                 set.delete(id);
               }
             }
+
+            if (this._errorsAndWarnings.has(id)) {
+              this._errorsAndWarnings.delete(id);
+              haveErrorsOrWarningsChanged = true;
+            }
+          }
+          break;
+        }
+        case TREE_OPERATION_REMOVE_ROOT: {
+          i += 1;
+
+          const id = operations[1];
+
+          if (__DEBUG__) {
+            debug(`Remove root ${id}`);
           }
+
+          const recursivelyDeleteElements = elementID => {
+            const element = this._idToElement.get(elementID);
+            this._idToElement.delete(elementID);
+            if (element) {
+              // Mostly for Flow's sake
+              for (let index = 0; index < element.children.length; index++) {
+                recursivelyDeleteElements(element.children[index]);
+              }
+            }
+          };
+
+          const root = ((this._idToElement.get(id): any): Element);
+          recursivelyDeleteElements(id);
+
+          this._rootIDToCapabilities.delete(id);
+          this._rootIDToRendererID.delete(id);
+          this._roots = this._roots.filter(rootID => rootID !== id);
+          this._weightAcrossRoots -= root.weight;
           break;
         }
         case TREE_OPERATION_REORDER_CHILDREN: {
@@ -958,6 +1061,20 @@ export default class Store extends EventEmitter<{|
           // The profiler UI uses them lazily in order to generate the tree.
           i += 3;
           break;
+        case TREE_OPERATION_UPDATE_ERRORS_OR_WARNINGS:
+          const id = operations[i + 1];
+          const errorCount = operations[i + 2];
+          const warningCount = operations[i + 3];
+
+          i += 4;
+
+          if (errorCount > 0 || warningCount > 0) {
+            this._errorsAndWarnings.set(id, {errorCount, warningCount});
+          } else if (this._errorsAndWarnings.has(id)) {
+            this._errorsAndWarnings.delete(id);
+          }
+          haveErrorsOrWarningsChanged = true;
+          break;
         default:
           throw Error(`Unsupported Bridge operation ${operation}`);
       }
@@ -965,6 +1082,41 @@ export default class Store extends EventEmitter<{|
 
     this._revision++;
 
+    if (haveErrorsOrWarningsChanged) {
+      let errorCount = 0;
+      let warningCount = 0;
+
+      this._errorsAndWarnings.forEach(entry => {
+        errorCount += entry.errorCount;
+        warningCount += entry.warningCount;
+      });
+
+      this._cachedErrorCount = errorCount;
+      this._cachedWarningCount = warningCount;
+
+      const errorAndWarningTuples: Array<{|id: number, index: number|}> = [];
+
+      this._errorsAndWarnings.forEach((_, id) => {
+        const index = this.getIndexOfElementID(id);
+        if (index !== null) {
+          let low = 0;
+          let high = errorAndWarningTuples.length;
+          while (low < high) {
+            const mid = (low + high) >> 1;
+            if (errorAndWarningTuples[mid].index > index) {
+              high = mid;
+            } else {
+              low = mid + 1;
+            }
+          }
+
+          errorAndWarningTuples.splice(low, 0, {id, index});
+        }
+      });
+
+      this._cachedErrorAndWarningTuples = errorAndWarningTuples;
+    }
+
     if (haveRootsChanged) {
       const prevSupportsProfiling = this._supportsProfiling;
 

commit af16f755dc7e0d6e2b4bf79b86c434f4ce0497fe
Author: Brian Vaughn <bvaughn@fb.com>
Date:   Tue Jan 19 06:51:32 2021 -0800

    Update DevTools to use getCacheForType API (#20548)
    
    DevTools was built with a fork of an early idea for how Suspense cache might work. This idea is incompatible with newer APIs like `useTransition` which unfortunately prevented me from making certain UX improvements. This PR swaps out the primary usage of this cache (there are a few) in favor of the newer `unstable_getCacheForType` and `unstable_useCacheRefresh` APIs. We can go back and update the others in follow up PRs.
    
    ### Messaging changes
    
    I've refactored the way the frontend loads component props/state/etc to hopefully make it better match the Suspense+cache model. Doing this gave up some of the small optimizations I'd added but hopefully the actual performance impact of that is minor and the overall ergonomic improvements of working with the cache API make this worth it.
    
    The backend no longer remembers inspected paths. Instead, the frontend sends them every time and the backend sends a response with those paths. I've also added a new "force" parameter that the frontend can use to tell the backend to send a response even if the component hasn't rendered since the last time it asked. (This is used to get data for newly inspected paths.)
    
    _Initial inspection..._
    ```
    front |                                                      | back
          | -- "inspect" (id:1, paths:[], force:true) ---------> |
          | <------------------------ "inspected" (full-data) -- |
    ```
    _1 second passes with no updates..._
    ```
          | -- "inspect" (id:1, paths:[], force:false) --------> |
          | <------------------------ "inspected" (no-change) -- |
    ```
    _User clicks to expand a path, aka hydrate..._
    ```
          | -- "inspect" (id:1, paths:['foo'], force:true) ----> |
          | <------------------------ "inspected" (full-data) -- |
    ```
    _1 second passes during which there is an update..._
    ```
          | -- "inspect" (id:1, paths:['foo'], force:false) ---> |
          | <----------------- "inspectedElement" (full-data) -- |
    ```
    
    ### Clear errors/warnings transition
    Previously this meant there would be a delay after clicking the "clear" button. The UX after this change is much improved.
    
    ### Hydrating paths transition
    I also added a transition to hydration (expanding "dehyrated" paths).
    
    ### Better error boundaries
    I also added a lower-level error boundary in case the new suspense operation ever failed. It provides a better "retry" mechanism (select a new element) so DevTools doesn't become entirely useful. Here I'm intentionally causing an error every time I select an element.
    
    ### Improved snapshot tests
    I also migrated several of the existing snapshot tests to use inline snapshots and added a new serializer for dehydrated props. Inline snapshots are easier to verify and maintain and the new serializer means dehydrated props will be formatted in a way that makes sense rather than being empty (in external snapshots) or super verbose (default inline snapshot format).

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index 6b1b83e524..e5a6ac15fb 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -101,7 +101,7 @@ export default class Store extends EventEmitter<{|
 
   // Map of ID to (mutable) Element.
   // Elements are mutated to avoid excessive cloning during tree updates.
-  // The InspectedElementContext also relies on this mutability for its WeakMap usage.
+  // The InspectedElement Suspense cache also relies on this mutability for its WeakMap usage.
   _idToElement: Map<number, Element> = new Map();
 
   // Should the React Native style editor panel be shown?
@@ -378,42 +378,6 @@ export default class Store extends EventEmitter<{|
     return this._cachedWarningCount;
   }
 
-  clearErrorsAndWarnings(): void {
-    this._rootIDToRendererID.forEach(rendererID => {
-      this._bridge.send('clearErrorsAndWarnings', {
-        rendererID,
-      });
-    });
-  }
-
-  clearErrorsForElement(id: number): void {
-    const rendererID = this.getRendererIDForElement(id);
-    if (rendererID === null) {
-      console.warn(
-        `Unable to find rendererID for element ${id} when clearing errors.`,
-      );
-    } else {
-      this._bridge.send('clearErrorsForFiberID', {
-        rendererID,
-        id,
-      });
-    }
-  }
-
-  clearWarningsForElement(id: number): void {
-    const rendererID = this.getRendererIDForElement(id);
-    if (rendererID === null) {
-      console.warn(
-        `Unable to find rendererID for element ${id} when clearing warnings.`,
-      );
-    } else {
-      this._bridge.send('clearWarningsForFiberID', {
-        rendererID,
-        id,
-      });
-    }
-  }
-
   containsElement(id: number): boolean {
     return this._idToElement.get(id) != null;
   }

commit bd245c1bab1a1f965cb51f5d01406a2770244930
Author: Chris Dobson <chrisdobby.dev@gmail.com>
Date:   Thu Mar 11 15:31:57 2021 +0000

    Ensure sync-xhr is allowed before reload and profile (#20879)
    
    Co-authored-by: Brian Vaughn <brian.david.vaughn@gmail.com>

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index e5a6ac15fb..c0083f90a1 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -111,6 +111,12 @@ export default class Store extends EventEmitter<{|
   // If not, features like reload-and-profile will not work correctly and must be disabled.
   _isBackendStorageAPISupported: boolean = false;
 
+  // Can DevTools use sync XHR requests?
+  // If not, features like reload-and-profile will not work correctly and must be disabled.
+  // This current limitation applies only to web extension builds
+  // and will need to be reconsidered in the future if we add support for reload to React Native.
+  _isSynchronousXHRSupported: boolean = false;
+
   _nativeStyleEditorValidAttributes: $ReadOnlyArray<string> | null = null;
 
   // Map of element (id) to the set of elements (ids) it owns.
@@ -195,12 +201,16 @@ export default class Store extends EventEmitter<{|
     bridge.addListener('shutdown', this.onBridgeShutdown);
     bridge.addListener(
       'isBackendStorageAPISupported',
-      this.onBridgeStorageSupported,
+      this.onBackendStorageAPISupported,
     );
     bridge.addListener(
       'isNativeStyleEditorSupported',
       this.onBridgeNativeStyleEditorSupported,
     );
+    bridge.addListener(
+      'isSynchronousXHRSupported',
+      this.onBridgeSynchronousXHRSupported,
+    );
     bridge.addListener(
       'unsupportedRendererVersion',
       this.onBridgeUnsupportedRendererVersion,
@@ -359,11 +369,16 @@ export default class Store extends EventEmitter<{|
   get supportsProfiling(): boolean {
     return this._supportsProfiling;
   }
+
   get supportsReloadAndProfile(): boolean {
     // Does the DevTools shell support reloading and eagerly injecting the renderer interface?
-    // And if so, can the backend use the localStorage API?
-    // Both of these are required for the reload-and-profile feature to work.
-    return this._supportsReloadAndProfile && this._isBackendStorageAPISupported;
+    // And if so, can the backend use the localStorage API and sync XHR?
+    // All of these are currently required for the reload-and-profile feature to work.
+    return (
+      this._supportsReloadAndProfile &&
+      this._isBackendStorageAPISupported &&
+      this._isSynchronousXHRSupported
+    );
   }
 
   get supportsTraceUpdates(): boolean {
@@ -1130,20 +1145,43 @@ export default class Store extends EventEmitter<{|
       debug('onBridgeShutdown', 'unsubscribing from Bridge');
     }
 
-    this._bridge.removeListener('operations', this.onBridgeOperations);
-    this._bridge.removeListener('shutdown', this.onBridgeShutdown);
-    this._bridge.removeListener(
+    const bridge = this._bridge;
+    bridge.removeListener('operations', this.onBridgeOperations);
+    bridge.removeListener(
+      'overrideComponentFilters',
+      this.onBridgeOverrideComponentFilters,
+    );
+    bridge.removeListener('shutdown', this.onBridgeShutdown);
+    bridge.removeListener(
       'isBackendStorageAPISupported',
-      this.onBridgeStorageSupported,
+      this.onBackendStorageAPISupported,
+    );
+    bridge.removeListener(
+      'isNativeStyleEditorSupported',
+      this.onBridgeNativeStyleEditorSupported,
+    );
+    bridge.removeListener(
+      'isSynchronousXHRSupported',
+      this.onBridgeSynchronousXHRSupported,
+    );
+    bridge.removeListener(
+      'unsupportedRendererVersion',
+      this.onBridgeUnsupportedRendererVersion,
     );
   };
 
-  onBridgeStorageSupported = (isBackendStorageAPISupported: boolean) => {
+  onBackendStorageAPISupported = (isBackendStorageAPISupported: boolean) => {
     this._isBackendStorageAPISupported = isBackendStorageAPISupported;
 
     this.emit('supportsReloadAndProfile');
   };
 
+  onBridgeSynchronousXHRSupported = (isSynchronousXHRSupported: boolean) => {
+    this._isSynchronousXHRSupported = isSynchronousXHRSupported;
+
+    this.emit('supportsReloadAndProfile');
+  };
+
   onBridgeUnsupportedRendererVersion = () => {
     this._unsupportedRendererVersionDetected = true;
 

commit 4def1ceee2acc241f2434b2cfab6b8bc4c741cb3
Author: Brian Vaughn <bvaughn@fb.com>
Date:   Mon Apr 19 13:05:28 2021 -0400

    Update DevTools Error strings to support GitHub fuzzy search (#21314)

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index c0083f90a1..5fa4bff344 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -794,7 +794,7 @@ export default class Store extends EventEmitter<{|
 
           if (this._idToElement.has(id)) {
             throw Error(
-              `Cannot add node ${id} because a node with that id is already in the Store.`,
+              `Cannot add node "${id}" because a node with that id is already in the Store.`,
             );
           }
 
@@ -857,7 +857,7 @@ export default class Store extends EventEmitter<{|
 
             if (!this._idToElement.has(parentID)) {
               throw Error(
-                `Cannot add child ${id} to parent ${parentID} because parent node was not found in the Store.`,
+                `Cannot add child "${id}" to parent "${parentID}" because parent node was not found in the Store.`,
               );
             }
 
@@ -909,7 +909,7 @@ export default class Store extends EventEmitter<{|
 
             if (!this._idToElement.has(id)) {
               throw Error(
-                `Cannot remove node ${id} because no matching node was found in the Store.`,
+                `Cannot remove node "${id}" because no matching node was found in the Store.`,
               );
             }
 
@@ -918,7 +918,7 @@ export default class Store extends EventEmitter<{|
             const element = ((this._idToElement.get(id): any): Element);
             const {children, ownerID, parentID, weight} = element;
             if (children.length > 0) {
-              throw new Error(`Node ${id} was removed before its children.`);
+              throw new Error(`Node "${id}" was removed before its children.`);
             }
 
             this._idToElement.delete(id);
@@ -941,7 +941,7 @@ export default class Store extends EventEmitter<{|
               parentElement = ((this._idToElement.get(parentID): any): Element);
               if (parentElement === undefined) {
                 throw Error(
-                  `Cannot remove node ${id} from parent ${parentID} because no matching node was found in the Store.`,
+                  `Cannot remove node "${id}" from parent "${parentID}" because no matching node was found in the Store.`,
                 );
               }
               const index = parentElement.children.indexOf(id);
@@ -1002,7 +1002,7 @@ export default class Store extends EventEmitter<{|
 
           if (!this._idToElement.has(id)) {
             throw Error(
-              `Cannot reorder children for node ${id} because no matching node was found in the Store.`,
+              `Cannot reorder children for node "${id}" because no matching node was found in the Store.`,
             );
           }
 
@@ -1055,7 +1055,7 @@ export default class Store extends EventEmitter<{|
           haveErrorsOrWarningsChanged = true;
           break;
         default:
-          throw Error(`Unsupported Bridge operation ${operation}`);
+          throw Error(`Unsupported Bridge operation "${operation}"`);
       }
     }
 

commit 8e2bb3e89c8c3c8b64b3aa94e0bb524775ef4522
Author: Brian Vaughn <bvaughn@fb.com>
Date:   Tue Apr 27 17:26:07 2021 -0400

    DevTools: Add Bridge protocol version backend/frontend (#21331)
    
    Add an explicit Bridge protocol version to the frontend and backend components as well as a check during initialization to ensure that both are compatible. If not, the frontend will display either upgrade or downgrade instructions.
    
    Note that only the `react-devtools-core` (React Native) and `react-devtools-inline` (Code Sandbox) packages implement this check. Browser extensions inject their own backend and so the check is unnecessary. (Arguably the `react-devtools-inline` check is also unlikely to be necessary _but_ has been added as an extra guard for use cases such as Replay.io.)

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index 5fa4bff344..ff3cf487b9 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -29,10 +29,17 @@ import {localStorageGetItem, localStorageSetItem} from '../storage';
 import {__DEBUG__} from '../constants';
 import {printStore} from './utils';
 import ProfilerStore from './ProfilerStore';
+import {
+  BRIDGE_PROTOCOL,
+  currentBridgeProtocol,
+} from 'react-devtools-shared/src/bridge';
 
 import type {Element} from './views/Components/types';
 import type {ComponentFilter, ElementType} from '../types';
-import type {FrontendBridge} from 'react-devtools-shared/src/bridge';
+import type {
+  FrontendBridge,
+  BridgeProtocol,
+} from 'react-devtools-shared/src/bridge';
 
 const debug = (methodName, ...args) => {
   if (__DEBUG__) {
@@ -51,6 +58,7 @@ const LOCAL_STORAGE_RECORD_CHANGE_DESCRIPTIONS_KEY =
   'React::DevTools::recordChangeDescriptions';
 
 type Config = {|
+  checkBridgeProtocolCompatibility?: boolean,
   isProfiling?: boolean,
   supportsNativeInspection?: boolean,
   supportsReloadAndProfile?: boolean,
@@ -76,6 +84,7 @@ export default class Store extends EventEmitter<{|
   supportsNativeStyleEditor: [],
   supportsProfiling: [],
   supportsReloadAndProfile: [],
+  unsupportedBridgeProtocolDetected: [],
   unsupportedRendererVersionDetected: [],
 |}> {
   _bridge: FrontendBridge;
@@ -119,6 +128,10 @@ export default class Store extends EventEmitter<{|
 
   _nativeStyleEditorValidAttributes: $ReadOnlyArray<string> | null = null;
 
+  // Older backends don't support an explicit bridge protocol,
+  // so we should timeout eventually and show a downgrade message.
+  _onBridgeProtocolTimeoutID: TimeoutID | null = null;
+
   // Map of element (id) to the set of elements (ids) it owns.
   // This map enables getOwnersListForElement() to avoid traversing the entire tree.
   _ownersMap: Map<number, Set<number>> = new Map();
@@ -147,6 +160,7 @@ export default class Store extends EventEmitter<{|
   _supportsReloadAndProfile: boolean = false;
   _supportsTraceUpdates: boolean = false;
 
+  _unsupportedBridgeProtocol: BridgeProtocol | null = null;
   _unsupportedRendererVersionDetected: boolean = false;
 
   // Total number of visible elements (within all roots).
@@ -217,6 +231,20 @@ export default class Store extends EventEmitter<{|
     );
 
     this._profilerStore = new ProfilerStore(bridge, this, isProfiling);
+
+    // Verify that the frontend version is compatible with the connected backend.
+    // See github.com/facebook/react/issues/21326
+    if (config != null && config.checkBridgeProtocolCompatibility) {
+      // Older backends don't support an explicit bridge protocol,
+      // so we should timeout eventually and show a downgrade message.
+      this._onBridgeProtocolTimeoutID = setTimeout(
+        this.onBridgeProtocolTimeout,
+        10000,
+      );
+
+      bridge.addListener('bridgeProtocol', this.onBridgeProtocol);
+      bridge.send('getBridgeProtocol');
+    }
   }
 
   // This is only used in tests to avoid memory leaks.
@@ -385,6 +413,10 @@ export default class Store extends EventEmitter<{|
     return this._supportsTraceUpdates;
   }
 
+  get unsupportedBridgeProtocol(): BridgeProtocol | null {
+    return this._unsupportedBridgeProtocol;
+  }
+
   get unsupportedRendererVersionDetected(): boolean {
     return this._unsupportedRendererVersionDetected;
   }
@@ -1168,6 +1200,12 @@ export default class Store extends EventEmitter<{|
       'unsupportedRendererVersion',
       this.onBridgeUnsupportedRendererVersion,
     );
+    bridge.removeListener('bridgeProtocol', this.onBridgeProtocol);
+
+    if (this._onBridgeProtocolTimeoutID !== null) {
+      clearTimeout(this._onBridgeProtocolTimeoutID);
+      this._onBridgeProtocolTimeoutID = null;
+    }
   };
 
   onBackendStorageAPISupported = (isBackendStorageAPISupported: boolean) => {
@@ -1187,4 +1225,30 @@ export default class Store extends EventEmitter<{|
 
     this.emit('unsupportedRendererVersionDetected');
   };
+
+  onBridgeProtocol = (bridgeProtocol: BridgeProtocol) => {
+    if (this._onBridgeProtocolTimeoutID !== null) {
+      clearTimeout(this._onBridgeProtocolTimeoutID);
+      this._onBridgeProtocolTimeoutID = null;
+    }
+
+    if (bridgeProtocol.version !== currentBridgeProtocol.version) {
+      this._unsupportedBridgeProtocol = bridgeProtocol;
+    } else {
+      // If we should happen to get a response after timing out...
+      this._unsupportedBridgeProtocol = null;
+    }
+
+    this.emit('unsupportedBridgeProtocolDetected');
+  };
+
+  onBridgeProtocolTimeout = () => {
+    this._onBridgeProtocolTimeoutID = null;
+
+    // If we timed out, that indicates the backend predates the bridge protocol,
+    // so we can set a fake version (0) to trigger the downgrade message.
+    this._unsupportedBridgeProtocol = BRIDGE_PROTOCOL[0];
+
+    this.emit('unsupportedBridgeProtocolDetected');
+  };
 }

commit d19257b8fabd883d1db91811d81e10651d059e71
Author: Brian Vaughn <bvaughn@fb.com>
Date:   Tue May 4 10:46:26 2021 -0400

    DevTools Store emits errors before throwing (#21426)
    
    The Store should never throw an Error without also emitting an event. Otherwise Store errors will be invisible to users, but the downstream errors they cause will be reported as bugs. (For example, github.com/facebook/react/issues/21402)
    
    Emitting an error event allows the ErrorBoundary to show the original error.
    
    Throwing is still valuable for local development and for unit testing the Store itself.

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index ff3cf487b9..0d2ca5faa8 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -78,6 +78,7 @@ export type Capabilities = {|
 export default class Store extends EventEmitter<{|
   collapseNodesByDefault: [],
   componentFilters: [],
+  error: [Error],
   mutated: [[Array<number>, Map<number, number>]],
   recordChangeDescriptions: [],
   roots: [],
@@ -270,12 +271,14 @@ export default class Store extends EventEmitter<{|
   assertMapSizeMatchesRootCount(map: Map<any, any>, mapName: string) {
     const expectedSize = this.roots.length;
     if (map.size !== expectedSize) {
-      throw new Error(
-        `Expected ${mapName} to contain ${expectedSize} items, but it contains ${
-          map.size
-        } items\n\n${inspect(map, {
-          depth: 20,
-        })}`,
+      this._throwAndEmitError(
+        Error(
+          `Expected ${mapName} to contain ${expectedSize} items, but it contains ${
+            map.size
+          } items\n\n${inspect(map, {
+            depth: 20,
+          })}`,
+        ),
       );
     }
   }
@@ -301,7 +304,9 @@ export default class Store extends EventEmitter<{|
     if (this._profilerStore.isProfiling) {
       // Re-mounting a tree while profiling is in progress might break a lot of assumptions.
       // If necessary, we could support this- but it doesn't seem like a necessary use case.
-      throw Error('Cannot modify filter preferences while profiling');
+      this._throwAndEmitError(
+        Error('Cannot modify filter preferences while profiling'),
+      );
     }
 
     // Filter updates are expensive to apply (since they impact the entire tree).
@@ -607,7 +612,7 @@ export default class Store extends EventEmitter<{|
             }
 
             if (depth === 0) {
-              throw Error('Invalid owners list');
+              this._throwAndEmitError(Error('Invalid owners list'));
             }
 
             list.push({...innerElement, depth});
@@ -667,7 +672,7 @@ export default class Store extends EventEmitter<{|
     if (element !== null) {
       if (isCollapsed) {
         if (element.type === ElementTypeRoot) {
-          throw Error('Root nodes cannot be collapsed');
+          this._throwAndEmitError(Error('Root nodes cannot be collapsed'));
         }
 
         if (!element.isCollapsed) {
@@ -825,8 +830,10 @@ export default class Store extends EventEmitter<{|
           i += 3;
 
           if (this._idToElement.has(id)) {
-            throw Error(
-              `Cannot add node "${id}" because a node with that id is already in the Store.`,
+            this._throwAndEmitError(
+              Error(
+                `Cannot add node "${id}" because a node with that id is already in the Store.`,
+              ),
             );
           }
 
@@ -888,8 +895,10 @@ export default class Store extends EventEmitter<{|
             }
 
             if (!this._idToElement.has(parentID)) {
-              throw Error(
-                `Cannot add child "${id}" to parent "${parentID}" because parent node was not found in the Store.`,
+              this._throwAndEmitError(
+                Error(
+                  `Cannot add child "${id}" to parent "${parentID}" because parent node was not found in the Store.`,
+                ),
               );
             }
 
@@ -940,8 +949,10 @@ export default class Store extends EventEmitter<{|
             const id = ((operations[i]: any): number);
 
             if (!this._idToElement.has(id)) {
-              throw Error(
-                `Cannot remove node "${id}" because no matching node was found in the Store.`,
+              this._throwAndEmitError(
+                Error(
+                  `Cannot remove node "${id}" because no matching node was found in the Store.`,
+                ),
               );
             }
 
@@ -950,7 +961,9 @@ export default class Store extends EventEmitter<{|
             const element = ((this._idToElement.get(id): any): Element);
             const {children, ownerID, parentID, weight} = element;
             if (children.length > 0) {
-              throw new Error(`Node "${id}" was removed before its children.`);
+              this._throwAndEmitError(
+                Error(`Node "${id}" was removed before its children.`),
+              );
             }
 
             this._idToElement.delete(id);
@@ -972,8 +985,10 @@ export default class Store extends EventEmitter<{|
               }
               parentElement = ((this._idToElement.get(parentID): any): Element);
               if (parentElement === undefined) {
-                throw Error(
-                  `Cannot remove node "${id}" from parent "${parentID}" because no matching node was found in the Store.`,
+                this._throwAndEmitError(
+                  Error(
+                    `Cannot remove node "${id}" from parent "${parentID}" because no matching node was found in the Store.`,
+                  ),
                 );
               }
               const index = parentElement.children.indexOf(id);
@@ -1033,16 +1048,20 @@ export default class Store extends EventEmitter<{|
           i += 3;
 
           if (!this._idToElement.has(id)) {
-            throw Error(
-              `Cannot reorder children for node "${id}" because no matching node was found in the Store.`,
+            this._throwAndEmitError(
+              Error(
+                `Cannot reorder children for node "${id}" because no matching node was found in the Store.`,
+              ),
             );
           }
 
           const element = ((this._idToElement.get(id): any): Element);
           const children = element.children;
           if (children.length !== numChildren) {
-            throw Error(
-              `Children cannot be added or removed during a reorder operation.`,
+            this._throwAndEmitError(
+              Error(
+                `Children cannot be added or removed during a reorder operation.`,
+              ),
             );
           }
 
@@ -1087,7 +1106,9 @@ export default class Store extends EventEmitter<{|
           haveErrorsOrWarningsChanged = true;
           break;
         default:
-          throw Error(`Unsupported Bridge operation "${operation}"`);
+          this._throwAndEmitError(
+            Error(`Unsupported Bridge operation "${operation}"`),
+          );
       }
     }
 
@@ -1251,4 +1272,17 @@ export default class Store extends EventEmitter<{|
 
     this.emit('unsupportedBridgeProtocolDetected');
   };
+
+  // The Store should never throw an Error without also emitting an event.
+  // Otherwise Store errors will be invisible to users,
+  // but the downstream errors they cause will be reported as bugs.
+  // For example, https://github.com/facebook/react/issues/21402
+  // Emitting an error event allows the ErrorBoundary to show the original error.
+  _throwAndEmitError(error: Error) {
+    this.emit('error', error);
+
+    // Throwing is still valuable for local development
+    // and for unit testing the Store itself.
+    throw error;
+  }
 }

commit d5de45820ae6beda46c34f8737f1861c85642a65
Author: houssemchebeb <59608551+houssemchebeb@users.noreply.github.com>
Date:   Thu Jul 15 01:42:54 2021 +0100

    Fix typo (#21671)

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index 0d2ca5faa8..59e10a5ef7 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -335,8 +335,8 @@ export default class Store extends EventEmitter<{|
     // Update persisted filter preferences stored in localStorage.
     saveComponentFilters(value);
 
-    // Notify the renderer that filter prefernces have changed.
-    // This is an expensive opreation; it unmounts and remounts the entire tree,
+    // Notify the renderer that filter preferences have changed.
+    // This is an expensive operation; it unmounts and remounts the entire tree,
     // so only do it if the set of enabled component filters has changed.
     if (haveEnabledFiltersChanged) {
       this._bridge.send('updateComponentFilters', value);

commit f4161c3ec7d2ab2993695a458f771bb331e256d5
Author: Brian Vaughn <bvaughn@fb.com>
Date:   Thu Jul 22 13:58:57 2021 -0400

    [DRAFT] Import scheduling profiler into DevTools Profiler (#21897)

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index 59e10a5ef7..16bc56ae64 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -62,6 +62,7 @@ type Config = {|
   isProfiling?: boolean,
   supportsNativeInspection?: boolean,
   supportsReloadAndProfile?: boolean,
+  supportsSchedulingProfiler?: boolean,
   supportsProfiling?: boolean,
   supportsTraceUpdates?: boolean,
 |};
@@ -159,6 +160,7 @@ export default class Store extends EventEmitter<{|
   _supportsNativeInspection: boolean = true;
   _supportsProfiling: boolean = false;
   _supportsReloadAndProfile: boolean = false;
+  _supportsSchedulingProfiler: boolean = false;
   _supportsTraceUpdates: boolean = false;
 
   _unsupportedBridgeProtocol: BridgeProtocol | null = null;
@@ -193,6 +195,7 @@ export default class Store extends EventEmitter<{|
         supportsNativeInspection,
         supportsProfiling,
         supportsReloadAndProfile,
+        supportsSchedulingProfiler,
         supportsTraceUpdates,
       } = config;
       this._supportsNativeInspection = supportsNativeInspection !== false;
@@ -202,6 +205,9 @@ export default class Store extends EventEmitter<{|
       if (supportsReloadAndProfile) {
         this._supportsReloadAndProfile = true;
       }
+      if (supportsSchedulingProfiler) {
+        this._supportsSchedulingProfiler = true;
+      }
       if (supportsTraceUpdates) {
         this._supportsTraceUpdates = true;
       }
@@ -414,6 +420,10 @@ export default class Store extends EventEmitter<{|
     );
   }
 
+  get supportsSchedulingProfiler(): boolean {
+    return this._supportsSchedulingProfiler;
+  }
+
   get supportsTraceUpdates(): boolean {
     return this._supportsTraceUpdates;
   }

commit b6ff9ad1630b4f1d7cb98e9b9ec46bca315bb302
Author: Sebastian Silbermann <silbermann.sebastian@gmail.com>
Date:   Fri Aug 20 17:55:42 2021 +0200

    DevTools: update error indices when elements are added/removed (#22144)

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index 16bc56ae64..7cd5c41e8b 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -1187,6 +1187,18 @@ export default class Store extends EventEmitter<{|
       console.groupEnd();
     }
 
+    const indicesOfCachedErrorsOrWarningsAreStale =
+      !haveErrorsOrWarningsChanged &&
+      (addedElementIDs.length > 0 || removedElementIDs.size > 0);
+    if (indicesOfCachedErrorsOrWarningsAreStale) {
+      this._cachedErrorAndWarningTuples.forEach(entry => {
+        const index = this.getIndexOfElementID(entry.id);
+        if (index !== null) {
+          entry.index = index;
+        }
+      });
+    }
+
     this.emit('mutated', [addedElementIDs, removedElementIDs]);
   };
 

commit 75a3e9fa4074b4b18ee95398ceabc361a6c9f82e
Author: Brian Vaughn <bvaughn@fb.com>
Date:   Fri Aug 20 12:53:28 2021 -0400

    DevTools: Reset cached indices in Store after elements reordered (#22147)

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index 7cd5c41e8b..217abe7f72 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -57,6 +57,8 @@ const LOCAL_STORAGE_COLLAPSE_ROOTS_BY_DEFAULT_KEY =
 const LOCAL_STORAGE_RECORD_CHANGE_DESCRIPTIONS_KEY =
   'React::DevTools::recordChangeDescriptions';
 
+type ErrorAndWarningTuples = Array<{|id: number, index: number|}>;
+
 type Config = {|
   checkBridgeProtocolCompatibility?: boolean,
   isProfiling?: boolean,
@@ -94,7 +96,7 @@ export default class Store extends EventEmitter<{|
   // Computed whenever _errorsAndWarnings Map changes.
   _cachedErrorCount: number = 0;
   _cachedWarningCount: number = 0;
-  _cachedErrorAndWarningTuples: Array<{|id: number, index: number|}> = [];
+  _cachedErrorAndWarningTuples: ErrorAndWarningTuples | null = null;
 
   // Should new nodes be collapsed by default when added to the tree?
   _collapseNodesByDefault: boolean = true;
@@ -510,7 +512,34 @@ export default class Store extends EventEmitter<{|
 
   // Returns a tuple of [id, index]
   getElementsWithErrorsAndWarnings(): Array<{|id: number, index: number|}> {
-    return this._cachedErrorAndWarningTuples;
+    if (this._cachedErrorAndWarningTuples !== null) {
+      return this._cachedErrorAndWarningTuples;
+    } else {
+      const errorAndWarningTuples: ErrorAndWarningTuples = [];
+
+      this._errorsAndWarnings.forEach((_, id) => {
+        const index = this.getIndexOfElementID(id);
+        if (index !== null) {
+          let low = 0;
+          let high = errorAndWarningTuples.length;
+          while (low < high) {
+            const mid = (low + high) >> 1;
+            if (errorAndWarningTuples[mid].index > index) {
+              high = mid;
+            } else {
+              low = mid + 1;
+            }
+          }
+
+          errorAndWarningTuples.splice(low, 0, {id, index});
+        }
+      });
+
+      // Cache for later (at least until the tree changes again).
+      this._cachedErrorAndWarningTuples = errorAndWarningTuples;
+
+      return errorAndWarningTuples;
+    }
   }
 
   getErrorAndWarningCountForElementID(
@@ -1124,6 +1153,9 @@ export default class Store extends EventEmitter<{|
 
     this._revision++;
 
+    // Any time the tree changes (e.g. elements added, removed, or reordered) cached inidices may be invalid.
+    this._cachedErrorAndWarningTuples = null;
+
     if (haveErrorsOrWarningsChanged) {
       let errorCount = 0;
       let warningCount = 0;
@@ -1135,28 +1167,6 @@ export default class Store extends EventEmitter<{|
 
       this._cachedErrorCount = errorCount;
       this._cachedWarningCount = warningCount;
-
-      const errorAndWarningTuples: Array<{|id: number, index: number|}> = [];
-
-      this._errorsAndWarnings.forEach((_, id) => {
-        const index = this.getIndexOfElementID(id);
-        if (index !== null) {
-          let low = 0;
-          let high = errorAndWarningTuples.length;
-          while (low < high) {
-            const mid = (low + high) >> 1;
-            if (errorAndWarningTuples[mid].index > index) {
-              high = mid;
-            } else {
-              low = mid + 1;
-            }
-          }
-
-          errorAndWarningTuples.splice(low, 0, {id, index});
-        }
-      });
-
-      this._cachedErrorAndWarningTuples = errorAndWarningTuples;
     }
 
     if (haveRootsChanged) {
@@ -1187,18 +1197,6 @@ export default class Store extends EventEmitter<{|
       console.groupEnd();
     }
 
-    const indicesOfCachedErrorsOrWarningsAreStale =
-      !haveErrorsOrWarningsChanged &&
-      (addedElementIDs.length > 0 || removedElementIDs.size > 0);
-    if (indicesOfCachedErrorsOrWarningsAreStale) {
-      this._cachedErrorAndWarningTuples.forEach(entry => {
-        const index = this.getIndexOfElementID(entry.id);
-        if (index !== null) {
-          entry.index = index;
-        }
-      });
-    }
-
     this.emit('mutated', [addedElementIDs, removedElementIDs]);
   };
 

commit 13455d26d1904519c53686d6f295d4eb50b6c2fc
Author: Brian Vaughn <bvaughn@fb.com>
Date:   Thu Nov 4 11:40:45 2021 -0400

    Cleaned up remaining "scheduling profiler" references in DevTools (#22696)

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index 217abe7f72..c8b252072d 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -63,9 +63,9 @@ type Config = {|
   checkBridgeProtocolCompatibility?: boolean,
   isProfiling?: boolean,
   supportsNativeInspection?: boolean,
-  supportsReloadAndProfile?: boolean,
-  supportsSchedulingProfiler?: boolean,
   supportsProfiling?: boolean,
+  supportsReloadAndProfile?: boolean,
+  supportsTimeline?: boolean,
   supportsTraceUpdates?: boolean,
 |};
 
@@ -162,7 +162,7 @@ export default class Store extends EventEmitter<{|
   _supportsNativeInspection: boolean = true;
   _supportsProfiling: boolean = false;
   _supportsReloadAndProfile: boolean = false;
-  _supportsSchedulingProfiler: boolean = false;
+  _supportsTimeline: boolean = false;
   _supportsTraceUpdates: boolean = false;
 
   _unsupportedBridgeProtocol: BridgeProtocol | null = null;
@@ -197,7 +197,7 @@ export default class Store extends EventEmitter<{|
         supportsNativeInspection,
         supportsProfiling,
         supportsReloadAndProfile,
-        supportsSchedulingProfiler,
+        supportsTimeline,
         supportsTraceUpdates,
       } = config;
       this._supportsNativeInspection = supportsNativeInspection !== false;
@@ -207,8 +207,8 @@ export default class Store extends EventEmitter<{|
       if (supportsReloadAndProfile) {
         this._supportsReloadAndProfile = true;
       }
-      if (supportsSchedulingProfiler) {
-        this._supportsSchedulingProfiler = true;
+      if (supportsTimeline) {
+        this._supportsTimeline = true;
       }
       if (supportsTraceUpdates) {
         this._supportsTraceUpdates = true;
@@ -422,8 +422,8 @@ export default class Store extends EventEmitter<{|
     );
   }
 
-  get supportsSchedulingProfiler(): boolean {
-    return this._supportsSchedulingProfiler;
+  get supportsTimeline(): boolean {
+    return this._supportsTimeline;
   }
 
   get supportsTraceUpdates(): boolean {

commit 3b3daf5573efe801fa3dc659020625b4023d3a9f
Author: Brian Vaughn <bvaughn@fb.com>
Date:   Fri Dec 10 11:05:18 2021 -0500

    Advocate for StrictMode usage within Components tree (#22886)
    
    Adds the concept of subtree modes to DevTools to bridge protocol as follows:
    1. Add-root messages get two new attributes: one specifying whether the root is running in strict mode and another specifying whether the root (really the root's renderer) supports the concept of strict mode.
    2. A new backend message type (TREE_OPERATION_SET_SUBTREE_MODE). This type specifies a subtree root (id) and a mode (bitmask). For now, the only mode this message deals with is strict mode.
    
    The DevTools frontend has been updated as well to highlight non-StrictMode compliant components.
    
    The changes to the bridge protocol require incrementing the bridge protocol version number, which will also require updating the version of react-devtools-core backend that is shipped with React Native.

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index c8b252072d..b68ea3d26f 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -14,6 +14,7 @@ import {
   TREE_OPERATION_REMOVE,
   TREE_OPERATION_REMOVE_ROOT,
   TREE_OPERATION_REORDER_CHILDREN,
+  TREE_OPERATION_SET_SUBTREE_MODE,
   TREE_OPERATION_UPDATE_ERRORS_OR_WARNINGS,
   TREE_OPERATION_UPDATE_TREE_BASE_DURATION,
 } from '../constants';
@@ -33,6 +34,7 @@ import {
   BRIDGE_PROTOCOL,
   currentBridgeProtocol,
 } from 'react-devtools-shared/src/bridge';
+import {StrictMode} from 'react-devtools-shared/src/types';
 
 import type {Element} from './views/Components/types';
 import type {ComponentFilter, ElementType} from '../types';
@@ -72,6 +74,7 @@ type Config = {|
 export type Capabilities = {|
   hasOwnerMetadata: boolean,
   supportsProfiling: boolean,
+  supportsStrictMode: boolean,
 |};
 
 /**
@@ -812,6 +815,20 @@ export default class Store extends EventEmitter<{|
     }
   };
 
+  _recursivelyUpdateSubtree(
+    id: number,
+    callback: (element: Element) => void,
+  ): void {
+    const element = this._idToElement.get(id);
+    if (element) {
+      callback(element);
+
+      element.children.forEach(child =>
+        this._recursivelyUpdateSubtree(child, callback),
+      );
+    }
+  }
+
   onBridgeNativeStyleEditorSupported = ({
     isSupported,
     validAttributes,
@@ -883,9 +900,15 @@ export default class Store extends EventEmitter<{|
               debug('Add', `new root node ${id}`);
             }
 
+            const isStrictModeCompliant = operations[i] > 0;
+            i++;
+
             const supportsProfiling = operations[i] > 0;
             i++;
 
+            const supportsStrictMode = operations[i] > 0;
+            i++;
+
             const hasOwnerMetadata = operations[i] > 0;
             i++;
 
@@ -894,8 +917,14 @@ export default class Store extends EventEmitter<{|
             this._rootIDToCapabilities.set(id, {
               hasOwnerMetadata,
               supportsProfiling,
+              supportsStrictMode,
             });
 
+            // Not all roots support StrictMode;
+            // don't flag a root as non-compliant unless it also supports StrictMode.
+            const isStrictModeNonCompliant =
+              !isStrictModeCompliant && supportsStrictMode;
+
             this._idToElement.set(id, {
               children: [],
               depth: -1,
@@ -903,6 +932,7 @@ export default class Store extends EventEmitter<{|
               hocDisplayNames: null,
               id,
               isCollapsed: false, // Never collapse roots; it would hide the entire tree.
+              isStrictModeNonCompliant,
               key: null,
               ownerID: 0,
               parentID: 0,
@@ -958,9 +988,10 @@ export default class Store extends EventEmitter<{|
               hocDisplayNames,
               id,
               isCollapsed: this._collapseNodesByDefault,
+              isStrictModeNonCompliant: parentElement.isStrictModeNonCompliant,
               key,
               ownerID,
-              parentID: parentElement.id,
+              parentID,
               type,
               weight: 1,
             };
@@ -1050,6 +1081,7 @@ export default class Store extends EventEmitter<{|
               haveErrorsOrWarningsChanged = true;
             }
           }
+
           break;
         }
         case TREE_OPERATION_REMOVE_ROOT: {
@@ -1124,6 +1156,28 @@ export default class Store extends EventEmitter<{|
           }
           break;
         }
+        case TREE_OPERATION_SET_SUBTREE_MODE: {
+          const id = operations[i + 1];
+          const mode = operations[i + 2];
+
+          i += 3;
+
+          // If elements have already been mounted in this subtree, update them.
+          // (In practice, this likely only applies to the root element.)
+          if (mode === StrictMode) {
+            this._recursivelyUpdateSubtree(id, element => {
+              element.isStrictModeNonCompliant = false;
+            });
+          }
+
+          if (__DEBUG__) {
+            debug(
+              'Subtree mode',
+              `Subtree with root ${id} set to mode ${mode}`,
+            );
+          }
+          break;
+        }
         case TREE_OPERATION_UPDATE_TREE_BASE_DURATION:
           // Base duration updates are only sent while profiling is in progress.
           // We can ignore them at this point.

commit fa816be7f0b28df051d80acfc85156197a9365de
Author: Brian Vaughn <bvaughn@fb.com>
Date:   Fri Jan 28 13:09:28 2022 -0500

    DevTools: Timeline profiler refactor
    
    Refactor DevTools to record Timeline data (in memory) while profiling. Updated the Profiler UI to import/export Timeline data along with legacy profiler data.
    
    Relates to issue #22529

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index b68ea3d26f..a2fda1825f 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -10,6 +10,8 @@
 import EventEmitter from '../events';
 import {inspect} from 'util';
 import {
+  PROFILING_FLAG_BASIC_SUPPORT,
+  PROFILING_FLAG_TIMELINE_SUPPORT,
   TREE_OPERATION_ADD,
   TREE_OPERATION_REMOVE,
   TREE_OPERATION_REMOVE_ROOT,
@@ -72,9 +74,10 @@ type Config = {|
 |};
 
 export type Capabilities = {|
+  supportsBasicProfiling: boolean,
   hasOwnerMetadata: boolean,
-  supportsProfiling: boolean,
   supportsStrictMode: boolean,
+  supportsTimeline: boolean,
 |};
 
 /**
@@ -88,8 +91,9 @@ export default class Store extends EventEmitter<{|
   mutated: [[Array<number>, Map<number, number>]],
   recordChangeDescriptions: [],
   roots: [],
+  rootSupportsBasicProfiling: [],
+  rootSupportsTimelineProfiling: [],
   supportsNativeStyleEditor: [],
-  supportsProfiling: [],
   supportsReloadAndProfile: [],
   unsupportedBridgeProtocolDetected: [],
   unsupportedRendererVersionDetected: [],
@@ -161,13 +165,16 @@ export default class Store extends EventEmitter<{|
   _rootIDToRendererID: Map<number, number> = new Map();
 
   // These options may be initially set by a confiugraiton option when constructing the Store.
-  // In the case of "supportsProfiling", the option may be updated based on the injected renderers.
   _supportsNativeInspection: boolean = true;
   _supportsProfiling: boolean = false;
   _supportsReloadAndProfile: boolean = false;
   _supportsTimeline: boolean = false;
   _supportsTraceUpdates: boolean = false;
 
+  // These options default to false but may be updated as roots are added and removed.
+  _rootSupportsBasicProfiling: boolean = false;
+  _rootSupportsTimelineProfiling: boolean = false;
+
   _unsupportedBridgeProtocol: BridgeProtocol | null = null;
   _unsupportedRendererVersionDetected: boolean = false;
 
@@ -402,6 +409,16 @@ export default class Store extends EventEmitter<{|
     return this._roots;
   }
 
+  // At least one of the currently mounted roots support the Legacy profiler.
+  get rootSupportsBasicProfiling(): boolean {
+    return this._rootSupportsBasicProfiling;
+  }
+
+  // At least one of the currently mounted roots support the Timeline profiler.
+  get rootSupportsTimelineProfiling(): boolean {
+    return this._rootSupportsTimelineProfiling;
+  }
+
   get supportsNativeInspection(): boolean {
     return this._supportsNativeInspection;
   }
@@ -410,6 +427,8 @@ export default class Store extends EventEmitter<{|
     return this._isNativeStyleEditorSupported;
   }
 
+  // This build of DevTools supports the legacy profiler.
+  // This is a static flag, controled by the Store config.
   get supportsProfiling(): boolean {
     return this._supportsProfiling;
   }
@@ -425,6 +444,8 @@ export default class Store extends EventEmitter<{|
     );
   }
 
+  // This build of DevTools supports the Timeline profiler.
+  // This is a static flag, controled by the Store config.
   get supportsTimeline(): boolean {
     return this._supportsTimeline;
   }
@@ -903,7 +924,10 @@ export default class Store extends EventEmitter<{|
             const isStrictModeCompliant = operations[i] > 0;
             i++;
 
-            const supportsProfiling = operations[i] > 0;
+            const supportsBasicProfiling =
+              (operations[i] & PROFILING_FLAG_BASIC_SUPPORT) !== 0;
+            const supportsTimeline =
+              (operations[i] & PROFILING_FLAG_TIMELINE_SUPPORT) !== 0;
             i++;
 
             const supportsStrictMode = operations[i] > 0;
@@ -915,9 +939,10 @@ export default class Store extends EventEmitter<{|
             this._roots = this._roots.concat(id);
             this._rootIDToRendererID.set(id, rendererID);
             this._rootIDToCapabilities.set(id, {
+              supportsBasicProfiling,
               hasOwnerMetadata,
-              supportsProfiling,
               supportsStrictMode,
+              supportsTimeline,
             });
 
             // Not all roots support StrictMode;
@@ -1224,25 +1249,38 @@ export default class Store extends EventEmitter<{|
     }
 
     if (haveRootsChanged) {
-      const prevSupportsProfiling = this._supportsProfiling;
+      const prevRootSupportsProfiling = this._rootSupportsBasicProfiling;
+      const prevRootSupportsTimelineProfiling = this
+        ._rootSupportsTimelineProfiling;
 
       this._hasOwnerMetadata = false;
-      this._supportsProfiling = false;
+      this._rootSupportsBasicProfiling = false;
+      this._rootSupportsTimelineProfiling = false;
       this._rootIDToCapabilities.forEach(
-        ({hasOwnerMetadata, supportsProfiling}) => {
+        ({supportsBasicProfiling, hasOwnerMetadata, supportsTimeline}) => {
+          if (supportsBasicProfiling) {
+            this._rootSupportsBasicProfiling = true;
+          }
           if (hasOwnerMetadata) {
             this._hasOwnerMetadata = true;
           }
-          if (supportsProfiling) {
-            this._supportsProfiling = true;
+          if (supportsTimeline) {
+            this._rootSupportsTimelineProfiling = true;
           }
         },
       );
 
       this.emit('roots');
 
-      if (this._supportsProfiling !== prevSupportsProfiling) {
-        this.emit('supportsProfiling');
+      if (this._rootSupportsBasicProfiling !== prevRootSupportsProfiling) {
+        this.emit('rootSupportsBasicProfiling');
+      }
+
+      if (
+        this._rootSupportsTimelineProfiling !==
+        prevRootSupportsTimelineProfiling
+      ) {
+        this.emit('rootSupportsTimelineProfiling');
       }
     }
 

commit 0e0b1a45fa09c0a8b162cde655016af97eda5c88
Author: Brian Vaughn <bvaughn@fb.com>
Date:   Wed Mar 2 09:26:48 2022 -0800

    Show DevTools backend and frontend versions in UI (#23399)
    
    This information can help with bug investigation for renderers (like React Native) that embed the DevTools backend into their source (separately from the DevTools frontend, which gets run by the user).
    
    If the DevTools backend is too old to report a version, or if the version reported is the same as the frontend (as will be the case with the browser extension) then only a single version string will be shown, as before. If a different version is reported, then both will be shown separately.

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index a2fda1825f..ddf647cc21 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -85,6 +85,7 @@ export type Capabilities = {|
  * ContextProviders can subscribe to the Store for specific things they want to provide.
  */
 export default class Store extends EventEmitter<{|
+  backendVersion: [],
   collapseNodesByDefault: [],
   componentFilters: [],
   error: [Error],
@@ -98,6 +99,10 @@ export default class Store extends EventEmitter<{|
   unsupportedBridgeProtocolDetected: [],
   unsupportedRendererVersionDetected: [],
 |}> {
+  // If the backend version is new enough to report its (NPM) version, this is it.
+  // This version may be displayed by the frontend for debugging purposes.
+  _backendVersion: string | null = null;
+
   _bridge: FrontendBridge;
 
   // Computed whenever _errorsAndWarnings Map changes.
@@ -264,6 +269,9 @@ export default class Store extends EventEmitter<{|
       bridge.addListener('bridgeProtocol', this.onBridgeProtocol);
       bridge.send('getBridgeProtocol');
     }
+
+    bridge.addListener('backendVersion', this.onBridgeBackendVersion);
+    bridge.send('getBackendVersion');
   }
 
   // This is only used in tests to avoid memory leaks.
@@ -301,6 +309,10 @@ export default class Store extends EventEmitter<{|
     }
   }
 
+  get backendVersion(): string | null {
+    return this._backendVersion;
+  }
+
   get collapseNodesByDefault(): boolean {
     return this._collapseNodesByDefault;
   }
@@ -1333,6 +1345,7 @@ export default class Store extends EventEmitter<{|
       'unsupportedRendererVersion',
       this.onBridgeUnsupportedRendererVersion,
     );
+    bridge.removeListener('backendVersion', this.onBridgeBackendVersion);
     bridge.removeListener('bridgeProtocol', this.onBridgeProtocol);
 
     if (this._onBridgeProtocolTimeoutID !== null) {
@@ -1359,6 +1372,11 @@ export default class Store extends EventEmitter<{|
     this.emit('unsupportedRendererVersionDetected');
   };
 
+  onBridgeBackendVersion = (backendVersion: string) => {
+    this._backendVersion = backendVersion;
+    this.emit('backendVersion');
+  };
+
   onBridgeProtocol = (bridgeProtocol: BridgeProtocol) => {
     if (this._onBridgeProtocolTimeoutID !== null) {
       clearTimeout(this._onBridgeProtocolTimeoutID);

commit 63b86e19955a3f68c3e6e4928f4e5b24fd8a8342
Author: Brian Vaughn <bvaughn@fb.com>
Date:   Tue Mar 15 10:48:26 2022 -0700

    Disable unsupported Bridge protocol version dialog and add workaround for old protocol operations format (#24093)
    
    Rationale: The only case where the unsupported dialog really matters is React Naive. That's the case where the frontend and backend versions are most likely to mismatch. In React Native, the backend is likely to send the bridge protocol version before sending operations since the agent does this proactively during initialization.
    
    I've tested the React Native starter app after forcefully downgrading the backend version to 4.19.1 (see #23307 (comment)) and verified that this change "fixes" things. Not only does DevTools no longer throw an error that causes the UI to be hidden it works (meaning that the Components tree can be inspected and interacted with).

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index ddf647cc21..f172cd6aa3 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -180,7 +180,8 @@ export default class Store extends EventEmitter<{|
   _rootSupportsBasicProfiling: boolean = false;
   _rootSupportsTimelineProfiling: boolean = false;
 
-  _unsupportedBridgeProtocol: BridgeProtocol | null = null;
+  _bridgeProtocol: BridgeProtocol | null = null;
+  _unsupportedBridgeProtocolDetected: boolean = false;
   _unsupportedRendererVersionDetected: boolean = false;
 
   // Total number of visible elements (within all roots).
@@ -375,6 +376,10 @@ export default class Store extends EventEmitter<{|
     this.emit('componentFilters');
   }
 
+  get bridgeProtocol(): BridgeProtocol | null {
+    return this._bridgeProtocol;
+  }
+
   get errorCount(): number {
     return this._cachedErrorCount;
   }
@@ -466,8 +471,8 @@ export default class Store extends EventEmitter<{|
     return this._supportsTraceUpdates;
   }
 
-  get unsupportedBridgeProtocol(): BridgeProtocol | null {
-    return this._unsupportedBridgeProtocol;
+  get unsupportedBridgeProtocolDetected(): boolean {
+    return this._unsupportedBridgeProtocolDetected;
   }
 
   get unsupportedRendererVersionDetected(): boolean {
@@ -942,11 +947,21 @@ export default class Store extends EventEmitter<{|
               (operations[i] & PROFILING_FLAG_TIMELINE_SUPPORT) !== 0;
             i++;
 
-            const supportsStrictMode = operations[i] > 0;
-            i++;
+            let supportsStrictMode = false;
+            let hasOwnerMetadata = false;
 
-            const hasOwnerMetadata = operations[i] > 0;
-            i++;
+            // If we don't know the bridge protocol, guess that we're dealing with the latest.
+            // If we do know it, we can take it into consideration when parsing operations.
+            if (
+              this._bridgeProtocol === null ||
+              this._bridgeProtocol.version >= 2
+            ) {
+              supportsStrictMode = operations[i] > 0;
+              i++;
+
+              hasOwnerMetadata = operations[i] > 0;
+              i++;
+            }
 
             this._roots = this._roots.concat(id);
             this._rootIDToRendererID.set(id, rendererID);
@@ -1383,14 +1398,13 @@ export default class Store extends EventEmitter<{|
       this._onBridgeProtocolTimeoutID = null;
     }
 
+    this._bridgeProtocol = bridgeProtocol;
+
     if (bridgeProtocol.version !== currentBridgeProtocol.version) {
-      this._unsupportedBridgeProtocol = bridgeProtocol;
-    } else {
-      // If we should happen to get a response after timing out...
-      this._unsupportedBridgeProtocol = null;
+      // Technically newer versions of the frontend can, at least for now,
+      // gracefully handle older versions of the backend protocol.
+      // So for now we don't need to display the unsupported dialog.
     }
-
-    this.emit('unsupportedBridgeProtocolDetected');
   };
 
   onBridgeProtocolTimeout = () => {
@@ -1398,7 +1412,7 @@ export default class Store extends EventEmitter<{|
 
     // If we timed out, that indicates the backend predates the bridge protocol,
     // so we can set a fake version (0) to trigger the downgrade message.
-    this._unsupportedBridgeProtocol = BRIDGE_PROTOCOL[0];
+    this._bridgeProtocol = BRIDGE_PROTOCOL[0];
 
     this.emit('unsupportedBridgeProtocolDetected');
   };

commit e62a8d754548a490c2a3bcff3b420e5eedaf11c0
Author: Brian Vaughn <bvaughn@fb.com>
Date:   Wed Mar 23 14:04:54 2022 -0700

    Store throws a specific Error type (UnsupportedBridgeOperationError) (#24147)
    
    When this Error type is detected, DevTools shows a custom error overlay with upgrade/downgrade instructions.

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index f172cd6aa3..2c5703505c 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -44,6 +44,7 @@ import type {
   FrontendBridge,
   BridgeProtocol,
 } from 'react-devtools-shared/src/bridge';
+import UnsupportedBridgeOperationError from 'react-devtools-shared/src/UnsupportedBridgeOperationError';
 
 const debug = (methodName, ...args) => {
   if (__DEBUG__) {
@@ -1252,7 +1253,9 @@ export default class Store extends EventEmitter<{|
           break;
         default:
           this._throwAndEmitError(
-            Error(`Unsupported Bridge operation "${operation}"`),
+            new UnsupportedBridgeOperationError(
+              `Unsupported Bridge operation "${operation}"`,
+            ),
           );
       }
     }

commit 540ba5b4039cf3489a3a7d5da90211c1dc00eb39
Author: Robert Balicki <robertbalicki@fb.com>
Date:   Fri Sep 9 11:09:30 2022 -0400

    [react devtools][easy] Change variable names, etc. (#25211)
    
    * Change variable names, put stuff in constants, etc. in preparation for next diff

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index 2c5703505c..56f1131205 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -23,7 +23,7 @@ import {
 import {ElementTypeRoot} from '../types';
 import {
   getSavedComponentFilters,
-  saveComponentFilters,
+  setSavedComponentFilters,
   separateDisplayNameAndHOCs,
   shallowDiffers,
   utfDecodeString,
@@ -365,7 +365,7 @@ export default class Store extends EventEmitter<{|
     this._componentFilters = value;
 
     // Update persisted filter preferences stored in localStorage.
-    saveComponentFilters(value);
+    setSavedComponentFilters(value);
 
     // Notify the renderer that filter preferences have changed.
     // This is an expensive operation; it unmounts and remounts the entire tree,
@@ -1332,7 +1332,7 @@ export default class Store extends EventEmitter<{|
   ) => {
     this._componentFilters = componentFilters;
 
-    saveComponentFilters(componentFilters);
+    setSavedComponentFilters(componentFilters);
   };
 
   onBridgeShutdown = () => {

commit 8003ab9cf5c711eb00f741bbd89def56b066b999
Author: Jan Kassens <jan@kassens.net>
Date:   Fri Sep 9 16:03:48 2022 -0400

    Flow: remove explicit object syntax (#25223)

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index 56f1131205..4c9131c896 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -62,9 +62,9 @@ const LOCAL_STORAGE_COLLAPSE_ROOTS_BY_DEFAULT_KEY =
 const LOCAL_STORAGE_RECORD_CHANGE_DESCRIPTIONS_KEY =
   'React::DevTools::recordChangeDescriptions';
 
-type ErrorAndWarningTuples = Array<{|id: number, index: number|}>;
+type ErrorAndWarningTuples = Array<{id: number, index: number}>;
 
-type Config = {|
+type Config = {
   checkBridgeProtocolCompatibility?: boolean,
   isProfiling?: boolean,
   supportsNativeInspection?: boolean,
@@ -72,20 +72,20 @@ type Config = {|
   supportsReloadAndProfile?: boolean,
   supportsTimeline?: boolean,
   supportsTraceUpdates?: boolean,
-|};
+};
 
-export type Capabilities = {|
+export type Capabilities = {
   supportsBasicProfiling: boolean,
   hasOwnerMetadata: boolean,
   supportsStrictMode: boolean,
   supportsTimeline: boolean,
-|};
+};
 
 /**
  * The store is the single source of truth for updates from the backend.
  * ContextProviders can subscribe to the Store for specific things they want to provide.
  */
-export default class Store extends EventEmitter<{|
+export default class Store extends EventEmitter<{
   backendVersion: [],
   collapseNodesByDefault: [],
   componentFilters: [],
@@ -99,7 +99,7 @@ export default class Store extends EventEmitter<{|
   supportsReloadAndProfile: [],
   unsupportedBridgeProtocolDetected: [],
   unsupportedRendererVersionDetected: [],
-|}> {
+}> {
   // If the backend version is new enough to report its (NPM) version, this is it.
   // This version may be displayed by the frontend for debugging purposes.
   _backendVersion: string | null = null;
@@ -119,7 +119,7 @@ export default class Store extends EventEmitter<{|
   // Map of ID to number of recorded error and warning message IDs.
   _errorsAndWarnings: Map<
     number,
-    {|errorCount: number, warningCount: number|},
+    {errorCount: number, warningCount: number},
   > = new Map();
 
   // At least one of the injected renderers contains (DEV only) owner metadata.
@@ -553,7 +553,7 @@ export default class Store extends EventEmitter<{|
   }
 
   // Returns a tuple of [id, index]
-  getElementsWithErrorsAndWarnings(): Array<{|id: number, index: number|}> {
+  getElementsWithErrorsAndWarnings(): Array<{id: number, index: number}> {
     if (this._cachedErrorAndWarningTuples !== null) {
       return this._cachedErrorAndWarningTuples;
     } else {
@@ -586,7 +586,7 @@ export default class Store extends EventEmitter<{|
 
   getErrorAndWarningCountForElementID(
     id: number,
-  ): {|errorCount: number, warningCount: number|} {
+  ): {errorCount: number, warningCount: number} {
     return this._errorsAndWarnings.get(id) || {errorCount: 0, warningCount: 0};
   }
 
@@ -871,10 +871,10 @@ export default class Store extends EventEmitter<{|
   onBridgeNativeStyleEditorSupported = ({
     isSupported,
     validAttributes,
-  }: {|
+  }: {
     isSupported: boolean,
     validAttributes: ?$ReadOnlyArray<string>,
-  |}) => {
+  }) => {
     this._isNativeStyleEditorSupported = isSupported;
     this._nativeStyleEditorValidAttributes = validAttributes || null;
 

commit 6aa38e74c7960465db4cf4377e26abb3a205f5d9
Author: Jan Kassens <jan@kassens.net>
Date:   Mon Sep 12 16:22:50 2022 -0400

    Flow: enable unsafe-addition error (#25242)

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index 4c9131c896..b51597f43a 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -681,6 +681,7 @@ export default class Store extends EventEmitter<{
             let depth = 0;
             while (parentID > 0) {
               if (parentID === ownerID || unsortedIDs.has(parentID)) {
+                // $FlowFixMe[unsafe-addition] addition with possible null/undefined value
                 depth = depthMap.get(parentID) + 1;
                 depthMap.set(id, depth);
                 break;

commit fc16293f3f8fd4483f0c8f358d1f2187fbb07463
Author: Jan Kassens <jan@kassens.net>
Date:   Thu Sep 15 16:45:29 2022 -0400

    Flow: well_formed_exports for devtools (#25266)

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index b51597f43a..11d4a9a5f1 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -828,10 +828,10 @@ export default class Store extends EventEmitter<{
     }
   }
 
-  _adjustParentTreeWeight = (
+  _adjustParentTreeWeight: (
     parentElement: Element | null,
     weightDelta: number,
-  ) => {
+  ) => void = (parentElement, weightDelta) => {
     let isInsideCollapsedSubTree = false;
 
     while (parentElement != null) {
@@ -869,20 +869,17 @@ export default class Store extends EventEmitter<{
     }
   }
 
-  onBridgeNativeStyleEditorSupported = ({
-    isSupported,
-    validAttributes,
-  }: {
+  onBridgeNativeStyleEditorSupported: ({
     isSupported: boolean,
     validAttributes: ?$ReadOnlyArray<string>,
-  }) => {
+  }) => void = ({isSupported, validAttributes}) => {
     this._isNativeStyleEditorSupported = isSupported;
     this._nativeStyleEditorValidAttributes = validAttributes || null;
 
     this.emit('supportsNativeStyleEditor');
   };
 
-  onBridgeOperations = (operations: Array<number>) => {
+  onBridgeOperations: (operations: Array<number>) => void = operations => {
     if (__DEBUG__) {
       console.groupCollapsed('onBridgeOperations');
       debug('onBridgeOperations', operations.join(','));
@@ -1328,15 +1325,15 @@ export default class Store extends EventEmitter<{
   // this message enables the backend to override the frontend's current ("saved") filters.
   // This action should also override the saved filters too,
   // else reloading the frontend without reloading the backend would leave things out of sync.
-  onBridgeOverrideComponentFilters = (
+  onBridgeOverrideComponentFilters: (
     componentFilters: Array<ComponentFilter>,
-  ) => {
+  ) => void = componentFilters => {
     this._componentFilters = componentFilters;
 
     setSavedComponentFilters(componentFilters);
   };
 
-  onBridgeShutdown = () => {
+  onBridgeShutdown: () => void = () => {
     if (__DEBUG__) {
       debug('onBridgeShutdown', 'unsubscribing from Bridge');
     }
@@ -1373,30 +1370,36 @@ export default class Store extends EventEmitter<{
     }
   };
 
-  onBackendStorageAPISupported = (isBackendStorageAPISupported: boolean) => {
+  onBackendStorageAPISupported: (
+    isBackendStorageAPISupported: boolean,
+  ) => void = isBackendStorageAPISupported => {
     this._isBackendStorageAPISupported = isBackendStorageAPISupported;
 
     this.emit('supportsReloadAndProfile');
   };
 
-  onBridgeSynchronousXHRSupported = (isSynchronousXHRSupported: boolean) => {
+  onBridgeSynchronousXHRSupported: (
+    isSynchronousXHRSupported: boolean,
+  ) => void = isSynchronousXHRSupported => {
     this._isSynchronousXHRSupported = isSynchronousXHRSupported;
 
     this.emit('supportsReloadAndProfile');
   };
 
-  onBridgeUnsupportedRendererVersion = () => {
+  onBridgeUnsupportedRendererVersion: () => void = () => {
     this._unsupportedRendererVersionDetected = true;
 
     this.emit('unsupportedRendererVersionDetected');
   };
 
-  onBridgeBackendVersion = (backendVersion: string) => {
+  onBridgeBackendVersion: (backendVersion: string) => void = backendVersion => {
     this._backendVersion = backendVersion;
     this.emit('backendVersion');
   };
 
-  onBridgeProtocol = (bridgeProtocol: BridgeProtocol) => {
+  onBridgeProtocol: (
+    bridgeProtocol: BridgeProtocol,
+  ) => void = bridgeProtocol => {
     if (this._onBridgeProtocolTimeoutID !== null) {
       clearTimeout(this._onBridgeProtocolTimeoutID);
       this._onBridgeProtocolTimeoutID = null;
@@ -1411,7 +1414,7 @@ export default class Store extends EventEmitter<{
     }
   };
 
-  onBridgeProtocolTimeout = () => {
+  onBridgeProtocolTimeout: () => void = () => {
     this._onBridgeProtocolTimeoutID = null;
 
     // If we timed out, that indicates the backend predates the bridge protocol,

commit 3b6826ed9e76207d9ab7a513a069fd67b69599a8
Author: Jan Kassens <jkassens@meta.com>
Date:   Tue Oct 4 15:39:26 2022 -0400

    Flow: inference_mode=constrain_writes
    
    This mode is going to be the new default in Flow going forward.
    There was an unfortuante large number of suppressions in this update.
    
    More on the changes can be found in this [Flow blog post](https://medium.com/flow-type/new-flow-language-rule-constrained-writes-4c70e375d190).
    
    Added some of the required annotations using the provided codemod:
    
    ```sh
    node_modules/.bin/flow codemod annotate-declarations --write .
    ```
    
    ghstack-source-id: 0b168e1b23f1305083e71d0b931b732e94705c73
    Pull Request resolved: https://github.com/facebook/react/pull/25422

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index 11d4a9a5f1..fb0c6d868f 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -763,7 +763,7 @@ export default class Store extends EventEmitter<{
 
           const weightDelta = 1 - element.weight;
 
-          let parentElement = ((this._idToElement.get(
+          let parentElement: void | Element = ((this._idToElement.get(
             element.parentID,
           ): any): Element);
           while (parentElement != null) {
@@ -789,7 +789,7 @@ export default class Store extends EventEmitter<{
               : currentElement.weight;
             const weightDelta = newWeight - oldWeight;
 
-            let parentElement = ((this._idToElement.get(
+            let parentElement: void | Element = ((this._idToElement.get(
               currentElement.parentID,
             ): any): Element);
             while (parentElement != null) {
@@ -806,8 +806,10 @@ export default class Store extends EventEmitter<{
 
           currentElement =
             currentElement.parentID !== 0
-              ? this.getElementByID(currentElement.parentID)
-              : null;
+              ? // $FlowFixMe[incompatible-type] found when upgrading Flow
+                this.getElementByID(currentElement.parentID)
+              : // $FlowFixMe[incompatible-type] found when upgrading Flow
+                null;
         }
       }
 

commit 9cdf8a99edcfd94d7420835ea663edca04237527
Author: Andrew Clark <git@andrewclark.io>
Date:   Tue Oct 18 11:19:24 2022 -0400

    [Codemod] Update copyright header to Meta (#25315)
    
    * Facebook -> Meta in copyright
    
    rg --files | xargs sed -i 's#Copyright (c) Facebook, Inc. and its affiliates.#Copyright (c) Meta Platforms, Inc. and affiliates.#g'
    
    * Manual tweaks

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index fb0c6d868f..71d53c886e 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -1,5 +1,5 @@
 /**
- * Copyright (c) Facebook, Inc. and its affiliates.
+ * Copyright (c) Meta Platforms, Inc. and affiliates.
  *
  * This source code is licensed under the MIT license found in the
  * LICENSE file in the root directory of this source tree.

commit 0b4f443020af386f2b48c47c074cb504ed672dc8
Author: Jan Kassens <jkassens@meta.com>
Date:   Mon Jan 9 15:46:48 2023 -0500

    [flow] enable enforce_local_inference_annotations (#25921)
    
    This setting is an incremental path to the next Flow version enforcing
    type annotations on most functions (except some inline callbacks).
    
    Used
    ```
    node_modules/.bin/flow codemod annotate-functions-and-classes --write .
    ```
    to add a majority of the types with some hand cleanup when for large
    inferred objects that should just be `Fiber` or weird constructs
    including `any`.
    
    Suppressed the remaining issues.
    
    Builds on #25918

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index 71d53c886e..fd9264eed5 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -46,7 +46,7 @@ import type {
 } from 'react-devtools-shared/src/bridge';
 import UnsupportedBridgeOperationError from 'react-devtools-shared/src/UnsupportedBridgeOperationError';
 
-const debug = (methodName, ...args) => {
+const debug = (methodName: string, ...args: Array<string>) => {
   if (__DEBUG__) {
     console.log(
       `%cStore %c${methodName}`,
@@ -1146,7 +1146,7 @@ export default class Store extends EventEmitter<{
             debug(`Remove root ${id}`);
           }
 
-          const recursivelyDeleteElements = elementID => {
+          const recursivelyDeleteElements = (elementID: number) => {
             const element = this._idToElement.get(elementID);
             this._idToElement.delete(elementID);
             if (element) {
@@ -1431,7 +1431,7 @@ export default class Store extends EventEmitter<{
   // but the downstream errors they cause will be reported as bugs.
   // For example, https://github.com/facebook/react/issues/21402
   // Emitting an error event allows the ErrorBoundary to show the original error.
-  _throwAndEmitError(error: Error) {
+  _throwAndEmitError(error: Error): empty {
     this.emit('error', error);
 
     // Throwing is still valuable for local development

commit 6b3083266686f62b29462d32de75c6e71f7ba3e3
Author: Jan Kassens <jkassens@meta.com>
Date:   Tue Jan 31 08:25:05 2023 -0500

    Upgrade prettier (#26081)
    
    The old version of prettier we were using didn't support the Flow syntax
    to access properties in a type using `SomeType['prop']`. This updates
    `prettier` and `rollup-plugin-prettier` to the latest versions.
    
    I added the prettier config `arrowParens: "avoid"` to reduce the diff
    size as the default has changed in Prettier 2.0. The largest amount of
    changes comes from function expressions now having a space. This doesn't
    have an option to preserve the old behavior, so we have to update this.

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index fd9264eed5..93251b839f 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -117,10 +117,8 @@ export default class Store extends EventEmitter<{
   _componentFilters: Array<ComponentFilter>;
 
   // Map of ID to number of recorded error and warning message IDs.
-  _errorsAndWarnings: Map<
-    number,
-    {errorCount: number, warningCount: number},
-  > = new Map();
+  _errorsAndWarnings: Map<number, {errorCount: number, warningCount: number}> =
+    new Map();
 
   // At least one of the injected renderers contains (DEV only) owner metadata.
   _hasOwnerMetadata: boolean = false;
@@ -584,9 +582,10 @@ export default class Store extends EventEmitter<{
     }
   }
 
-  getErrorAndWarningCountForElementID(
-    id: number,
-  ): {errorCount: number, warningCount: number} {
+  getErrorAndWarningCountForElementID(id: number): {
+    errorCount: number,
+    warningCount: number,
+  } {
     return this._errorsAndWarnings.get(id) || {errorCount: 0, warningCount: 0};
   }
 
@@ -1029,10 +1028,8 @@ export default class Store extends EventEmitter<{
             ): any): Element);
             parentElement.children.push(id);
 
-            const [
-              displayNameWithoutHOCs,
-              hocDisplayNames,
-            ] = separateDisplayNameAndHOCs(displayName, type);
+            const [displayNameWithoutHOCs, hocDisplayNames] =
+              separateDisplayNameAndHOCs(displayName, type);
 
             const element: Element = {
               children: [],
@@ -1280,8 +1277,8 @@ export default class Store extends EventEmitter<{
 
     if (haveRootsChanged) {
       const prevRootSupportsProfiling = this._rootSupportsBasicProfiling;
-      const prevRootSupportsTimelineProfiling = this
-        ._rootSupportsTimelineProfiling;
+      const prevRootSupportsTimelineProfiling =
+        this._rootSupportsTimelineProfiling;
 
       this._hasOwnerMetadata = false;
       this._rootSupportsBasicProfiling = false;
@@ -1399,22 +1396,21 @@ export default class Store extends EventEmitter<{
     this.emit('backendVersion');
   };
 
-  onBridgeProtocol: (
-    bridgeProtocol: BridgeProtocol,
-  ) => void = bridgeProtocol => {
-    if (this._onBridgeProtocolTimeoutID !== null) {
-      clearTimeout(this._onBridgeProtocolTimeoutID);
-      this._onBridgeProtocolTimeoutID = null;
-    }
+  onBridgeProtocol: (bridgeProtocol: BridgeProtocol) => void =
+    bridgeProtocol => {
+      if (this._onBridgeProtocolTimeoutID !== null) {
+        clearTimeout(this._onBridgeProtocolTimeoutID);
+        this._onBridgeProtocolTimeoutID = null;
+      }
 
-    this._bridgeProtocol = bridgeProtocol;
+      this._bridgeProtocol = bridgeProtocol;
 
-    if (bridgeProtocol.version !== currentBridgeProtocol.version) {
-      // Technically newer versions of the frontend can, at least for now,
-      // gracefully handle older versions of the backend protocol.
-      // So for now we don't need to display the unsupported dialog.
-    }
-  };
+      if (bridgeProtocol.version !== currentBridgeProtocol.version) {
+        // Technically newer versions of the frontend can, at least for now,
+        // gracefully handle older versions of the backend protocol.
+        // So for now we don't need to display the unsupported dialog.
+      }
+    };
 
   onBridgeProtocolTimeout: () => void = () => {
     this._onBridgeProtocolTimeoutID = null;

commit 6ddcbd4f96cb103de3978617a53c200baf5b546c
Author: Jan Kassens <jkassens@meta.com>
Date:   Thu Feb 9 17:07:39 2023 -0500

    [flow] enable LTI inference mode (#26104)
    
    This is the next generation inference mode for Flow.

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index 93251b839f..ba7ae80953 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -642,7 +642,7 @@ export default class Store extends EventEmitter<{
   }
 
   getOwnersListForElement(ownerID: number): Array<Element> {
-    const list = [];
+    const list: Array<Element> = [];
     const element = this._idToElement.get(ownerID);
     if (element != null) {
       list.push({
@@ -900,7 +900,7 @@ export default class Store extends EventEmitter<{
     let i = 2;
 
     // Reassemble the string table.
-    const stringTable = [
+    const stringTable: Array<string | null> = [
       null, // ID = 0 corresponds to the null string.
     ];
     const stringTableSize = operations[i++];

commit 21021fb0f06f5b8ccdad0774d53ff5f865faeb6d
Author: Ruslan Lesiutin <rdlesyutin@gmail.com>
Date:   Wed Apr 12 16:12:03 2023 +0100

    refactor[devtools]: copy to clipboard only on frontend side (#26604)
    
    Fixes https://github.com/facebook/react/issues/26500
    
    ## Summary
    - No more using `clipboard-js` from the backend side, now emitting
    custom `saveToClipboard` event, also adding corresponding listener in
    `store.js`
    - Not migrating to `navigator.clipboard` api yet, there were some issues
    with using it on Chrome, will add more details to
    https://github.com/facebook/react/pull/26539
    
    ## How did you test this change?
    - Tested on Chrome, Firefox, Edge
    - Tested on standalone electron app: seems like context menu is not
    expected to work there (cannot right-click on value, the menu is not
    appearing), other logic (pressing on copy icon) was not changed

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index ba7ae80953..eb5ac7af4f 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -7,6 +7,7 @@
  * @flow
  */
 
+import {copy} from 'clipboard-js';
 import EventEmitter from '../events';
 import {inspect} from 'util';
 import {
@@ -272,6 +273,8 @@ export default class Store extends EventEmitter<{
 
     bridge.addListener('backendVersion', this.onBridgeBackendVersion);
     bridge.send('getBackendVersion');
+
+    bridge.addListener('saveToClipboard', this.onSaveToClipboard);
   }
 
   // This is only used in tests to avoid memory leaks.
@@ -1362,6 +1365,7 @@ export default class Store extends EventEmitter<{
     );
     bridge.removeListener('backendVersion', this.onBridgeBackendVersion);
     bridge.removeListener('bridgeProtocol', this.onBridgeProtocol);
+    bridge.removeListener('saveToClipboard', this.onSaveToClipboard);
 
     if (this._onBridgeProtocolTimeoutID !== null) {
       clearTimeout(this._onBridgeProtocolTimeoutID);
@@ -1422,6 +1426,10 @@ export default class Store extends EventEmitter<{
     this.emit('unsupportedBridgeProtocolDetected');
   };
 
+  onSaveToClipboard: (text: string) => void = text => {
+    copy(text);
+  };
+
   // The Store should never throw an Error without also emitting an event.
   // Otherwise Store errors will be invisible to users,
   // but the downstream errors they cause will be reported as bugs.

commit 377c5175f78e47a3f01d323ad6528a696c88b76e
Author: Ruslan Lesiutin <rdlesyutin@gmail.com>
Date:   Thu May 4 17:34:57 2023 +0100

    DevTools: fix backend activation (#26779)
    
    ## Summary
    We have a case:
    1. Open components tab
    2. Close Chrome / Firefox devtools window completely
    3. Reopen browser devtools panel
    4. Open components tab
    
    Currently, in version 4.27.6, we cannot load the components tree.
    
    This PR contains two changes:
    - non-functional refactoring in
    `react-devtools-shared/src/devtools/store.js`: removed some redundant
    type castings.
    - fixed backend manager logic (introduced in
    https://github.com/facebook/react/pull/26615) to activate already
    registered backends. Looks like frontend of devtools also depends on
    `renderer-attached` event, without it component tree won't load.
    
    ## How did you test this change?
    This fixes the case mentioned prior. Currently in 4.27.6 version it is
    not working, we need to refresh the page to make it work.
    
    I've tested this in several environments: chrome, firefox, standalone
    with RN application.

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index eb5ac7af4f..2c1316cba1 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -169,7 +169,7 @@ export default class Store extends EventEmitter<{
   // Renderer ID is needed to support inspection fiber props, state, and hooks.
   _rootIDToRendererID: Map<number, number> = new Map();
 
-  // These options may be initially set by a confiugraiton option when constructing the Store.
+  // These options may be initially set by a configuration option when constructing the Store.
   _supportsNativeInspection: boolean = true;
   _supportsProfiling: boolean = false;
   _supportsReloadAndProfile: boolean = false;
@@ -486,7 +486,7 @@ export default class Store extends EventEmitter<{
   }
 
   containsElement(id: number): boolean {
-    return this._idToElement.get(id) != null;
+    return this._idToElement.has(id);
   }
 
   getElementAtIndex(index: number): Element | null {
@@ -539,13 +539,13 @@ export default class Store extends EventEmitter<{
   }
 
   getElementIDAtIndex(index: number): number | null {
-    const element: Element | null = this.getElementAtIndex(index);
+    const element = this.getElementAtIndex(index);
     return element === null ? null : element.id;
   }
 
   getElementByID(id: number): Element | null {
     const element = this._idToElement.get(id);
-    if (element == null) {
+    if (element === undefined) {
       console.warn(`No element found with id "${id}"`);
       return null;
     }
@@ -607,7 +607,10 @@ export default class Store extends EventEmitter<{
     let currentID = element.parentID;
     let index = 0;
     while (true) {
-      const current = ((this._idToElement.get(currentID): any): Element);
+      const current = this._idToElement.get(currentID);
+      if (current === undefined) {
+        return null;
+      }
 
       const {children} = current;
       for (let i = 0; i < children.length; i++) {
@@ -615,7 +618,12 @@ export default class Store extends EventEmitter<{
         if (childID === previousID) {
           break;
         }
-        const child = ((this._idToElement.get(childID): any): Element);
+
+        const child = this._idToElement.get(childID);
+        if (child === undefined) {
+          return null;
+        }
+
         index += child.isCollapsed ? 1 : child.weight;
       }
 
@@ -637,7 +645,12 @@ export default class Store extends EventEmitter<{
       if (rootID === currentID) {
         break;
       }
-      const root = ((this._idToElement.get(rootID): any): Element);
+
+      const root = this._idToElement.get(rootID);
+      if (root === undefined) {
+        return null;
+      }
+
       index += root.weight;
     }
 
@@ -647,7 +660,7 @@ export default class Store extends EventEmitter<{
   getOwnersListForElement(ownerID: number): Array<Element> {
     const list: Array<Element> = [];
     const element = this._idToElement.get(ownerID);
-    if (element != null) {
+    if (element !== undefined) {
       list.push({
         ...element,
         depth: 0,
@@ -665,8 +678,8 @@ export default class Store extends EventEmitter<{
         // Seems better to defer the cost, since the set of ids is probably pretty small.
         const sortedIDs = Array.from(unsortedIDs).sort(
           (idA, idB) =>
-            ((this.getIndexOfElementID(idA): any): number) -
-            ((this.getIndexOfElementID(idB): any): number),
+            (this.getIndexOfElementID(idA) || 0) -
+            (this.getIndexOfElementID(idB) || 0),
         );
 
         // Next we need to determine the appropriate depth for each element in the list.
@@ -677,7 +690,7 @@ export default class Store extends EventEmitter<{
         // at which point, our depth is just the depth of that node plus one.
         sortedIDs.forEach(id => {
           const innerElement = this._idToElement.get(id);
-          if (innerElement != null) {
+          if (innerElement !== undefined) {
             let parentID = innerElement.parentID;
 
             let depth = 0;
@@ -689,7 +702,7 @@ export default class Store extends EventEmitter<{
                 break;
               }
               const parent = this._idToElement.get(parentID);
-              if (parent == null) {
+              if (parent === undefined) {
                 break;
               }
               parentID = parent.parentID;
@@ -710,7 +723,7 @@ export default class Store extends EventEmitter<{
 
   getRendererIDForElement(id: number): number | null {
     let current = this._idToElement.get(id);
-    while (current != null) {
+    while (current !== undefined) {
       if (current.parentID === 0) {
         const rendererID = this._rootIDToRendererID.get(current.id);
         return rendererID == null ? null : rendererID;
@@ -723,7 +736,7 @@ export default class Store extends EventEmitter<{
 
   getRootIDForElement(id: number): number | null {
     let current = this._idToElement.get(id);
-    while (current != null) {
+    while (current !== undefined) {
       if (current.parentID === 0) {
         return current.id;
       } else {
@@ -765,10 +778,8 @@ export default class Store extends EventEmitter<{
 
           const weightDelta = 1 - element.weight;
 
-          let parentElement: void | Element = ((this._idToElement.get(
-            element.parentID,
-          ): any): Element);
-          while (parentElement != null) {
+          let parentElement = this._idToElement.get(element.parentID);
+          while (parentElement !== undefined) {
             // We don't need to break on a collapsed parent in the same way as the expand case below.
             // That's because collapsing a node doesn't "bubble" and affect its parents.
             parentElement.weight += weightDelta;
@@ -776,7 +787,7 @@ export default class Store extends EventEmitter<{
           }
         }
       } else {
-        let currentElement = element;
+        let currentElement: ?Element = element;
         while (currentElement != null) {
           const oldWeight = currentElement.isCollapsed
             ? 1
@@ -791,10 +802,8 @@ export default class Store extends EventEmitter<{
               : currentElement.weight;
             const weightDelta = newWeight - oldWeight;
 
-            let parentElement: void | Element = ((this._idToElement.get(
-              currentElement.parentID,
-            ): any): Element);
-            while (parentElement != null) {
+            let parentElement = this._idToElement.get(currentElement.parentID);
+            while (parentElement !== undefined) {
               parentElement.weight += weightDelta;
               if (parentElement.isCollapsed) {
                 // It's important to break on a collapsed parent when expanding nodes.
@@ -808,10 +817,8 @@ export default class Store extends EventEmitter<{
 
           currentElement =
             currentElement.parentID !== 0
-              ? // $FlowFixMe[incompatible-type] found when upgrading Flow
-                this.getElementByID(currentElement.parentID)
-              : // $FlowFixMe[incompatible-type] found when upgrading Flow
-                null;
+              ? this.getElementByID(currentElement.parentID)
+              : null;
         }
       }
 
@@ -833,7 +840,7 @@ export default class Store extends EventEmitter<{
   }
 
   _adjustParentTreeWeight: (
-    parentElement: Element | null,
+    parentElement: ?Element,
     weightDelta: number,
   ) => void = (parentElement, weightDelta) => {
     let isInsideCollapsedSubTree = false;
@@ -848,9 +855,7 @@ export default class Store extends EventEmitter<{
         break;
       }
 
-      parentElement = ((this._idToElement.get(
-        parentElement.parentID,
-      ): any): Element);
+      parentElement = this._idToElement.get(parentElement.parentID);
     }
 
     // Additions and deletions within a collapsed subtree should not affect the overall number of elements.
@@ -906,13 +911,16 @@ export default class Store extends EventEmitter<{
     const stringTable: Array<string | null> = [
       null, // ID = 0 corresponds to the null string.
     ];
-    const stringTableSize = operations[i++];
+    const stringTableSize = operations[i];
+    i++;
+
     const stringTableEnd = i + stringTableSize;
+
     while (i < stringTableEnd) {
-      const nextLength = operations[i++];
-      const nextString = utfDecodeString(
-        (operations.slice(i, i + nextLength): any),
-      );
+      const nextLength = operations[i];
+      i++;
+
+      const nextString = utfDecodeString(operations.slice(i, i + nextLength));
       stringTable.push(nextString);
       i += nextLength;
     }
@@ -921,7 +929,7 @@ export default class Store extends EventEmitter<{
       const operation = operations[i];
       switch (operation) {
         case TREE_OPERATION_ADD: {
-          const id = ((operations[i + 1]: any): number);
+          const id = operations[i + 1];
           const type = ((operations[i + 2]: any): ElementType);
 
           i += 3;
@@ -934,8 +942,6 @@ export default class Store extends EventEmitter<{
             );
           }
 
-          let ownerID: number = 0;
-          let parentID: number = ((null: any): number);
           if (type === ElementTypeRoot) {
             if (__DEBUG__) {
               debug('Add', `new root node ${id}`);
@@ -997,10 +1003,10 @@ export default class Store extends EventEmitter<{
 
             haveRootsChanged = true;
           } else {
-            parentID = ((operations[i]: any): number);
+            const parentID = operations[i];
             i++;
 
-            ownerID = ((operations[i]: any): number);
+            const ownerID = operations[i];
             i++;
 
             const displayNameStringID = operations[i];
@@ -1018,17 +1024,17 @@ export default class Store extends EventEmitter<{
               );
             }
 
-            if (!this._idToElement.has(parentID)) {
+            const parentElement = this._idToElement.get(parentID);
+            if (parentElement === undefined) {
               this._throwAndEmitError(
                 Error(
                   `Cannot add child "${id}" to parent "${parentID}" because parent node was not found in the Store.`,
                 ),
               );
+
+              continue;
             }
 
-            const parentElement = ((this._idToElement.get(
-              parentID,
-            ): any): Element);
             parentElement.children.push(id);
 
             const [displayNameWithoutHOCs, hocDisplayNames] =
@@ -1065,23 +1071,25 @@ export default class Store extends EventEmitter<{
           break;
         }
         case TREE_OPERATION_REMOVE: {
-          const removeLength = ((operations[i + 1]: any): number);
+          const removeLength = operations[i + 1];
           i += 2;
 
           for (let removeIndex = 0; removeIndex < removeLength; removeIndex++) {
-            const id = ((operations[i]: any): number);
+            const id = operations[i];
+            const element = this._idToElement.get(id);
 
-            if (!this._idToElement.has(id)) {
+            if (element === undefined) {
               this._throwAndEmitError(
                 Error(
                   `Cannot remove node "${id}" because no matching node was found in the Store.`,
                 ),
               );
+
+              continue;
             }
 
             i += 1;
 
-            const element = ((this._idToElement.get(id): any): Element);
             const {children, ownerID, parentID, weight} = element;
             if (children.length > 0) {
               this._throwAndEmitError(
@@ -1091,7 +1099,7 @@ export default class Store extends EventEmitter<{
 
             this._idToElement.delete(id);
 
-            let parentElement = null;
+            let parentElement: ?Element = null;
             if (parentID === 0) {
               if (__DEBUG__) {
                 debug('Remove', `node ${id} root`);
@@ -1106,14 +1114,18 @@ export default class Store extends EventEmitter<{
               if (__DEBUG__) {
                 debug('Remove', `node ${id} from parent ${parentID}`);
               }
-              parentElement = ((this._idToElement.get(parentID): any): Element);
+
+              parentElement = this._idToElement.get(parentID);
               if (parentElement === undefined) {
                 this._throwAndEmitError(
                   Error(
                     `Cannot remove node "${id}" from parent "${parentID}" because no matching node was found in the Store.`,
                   ),
                 );
+
+                continue;
               }
+
               const index = parentElement.children.indexOf(id);
               parentElement.children.splice(index, 1);
             }
@@ -1167,19 +1179,21 @@ export default class Store extends EventEmitter<{
           break;
         }
         case TREE_OPERATION_REORDER_CHILDREN: {
-          const id = ((operations[i + 1]: any): number);
-          const numChildren = ((operations[i + 2]: any): number);
+          const id = operations[i + 1];
+          const numChildren = operations[i + 2];
           i += 3;
 
-          if (!this._idToElement.has(id)) {
+          const element = this._idToElement.get(id);
+          if (element === undefined) {
             this._throwAndEmitError(
               Error(
                 `Cannot reorder children for node "${id}" because no matching node was found in the Store.`,
               ),
             );
+
+            continue;
           }
 
-          const element = ((this._idToElement.get(id): any): Element);
           const children = element.children;
           if (children.length !== numChildren) {
             this._throwAndEmitError(

commit 77ec61885fb19607cdd116a6790095afa40b5a94
Author: Ruslan Lesiutin <rdlesyutin@gmail.com>
Date:   Tue Oct 10 18:10:17 2023 +0100

    fix[devtools/inspectElement]: dont pause initial inspectElement call when user switches tabs (#27488)
    
    There are not so many changes, most of them are changing imports,
    because I've moved types for UI in a single file.
    
    In https://github.com/facebook/react/pull/27357 I've added support for
    pausing polling events: when user inspects an element, we start polling
    React DevTools backend for updates in props / state. If user switches
    tabs, extension's service worker can be killed by browser and this
    polling will start spamming errors.
    
    What I've missed is that we also have a separate call for this API, but
    which is executed only once when user selects an element. We don't
    handle promise rejection here and this can lead to some errors when user
    selects an element and switches tabs right after it.
    
    The only change here is that this API now has
    `shouldListenToPauseEvents` param, which is `true` for polling, so we
    will pause polling once user switches tabs. It is `false` by default, so
    we won't pause initial call by accident.
    
    
    https://github.com/hoxyq/react/blob/af8beeebf63b5824497fcd0bb35b7c0ac8fe60a0/packages/react-devtools-shared/src/backendAPI.js#L96

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index 2c1316cba1..a04a31cf63 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -21,7 +21,7 @@ import {
   TREE_OPERATION_UPDATE_ERRORS_OR_WARNINGS,
   TREE_OPERATION_UPDATE_TREE_BASE_DURATION,
 } from '../constants';
-import {ElementTypeRoot} from '../types';
+import {ElementTypeRoot} from '../frontend/types';
 import {
   getSavedComponentFilters,
   setSavedComponentFilters,
@@ -37,10 +37,13 @@ import {
   BRIDGE_PROTOCOL,
   currentBridgeProtocol,
 } from 'react-devtools-shared/src/bridge';
-import {StrictMode} from 'react-devtools-shared/src/types';
+import {StrictMode} from 'react-devtools-shared/src/frontend/types';
 
-import type {Element} from './views/Components/types';
-import type {ComponentFilter, ElementType} from '../types';
+import type {
+  Element,
+  ComponentFilter,
+  ElementType,
+} from 'react-devtools-shared/src/frontend/types';
 import type {
   FrontendBridge,
   BridgeProtocol,

commit c897260cffb6a237d5ad707a6043f68ddf9ab014
Author: Ruslan Lesiutin <rdlesyutin@gmail.com>
Date:   Tue Nov 7 16:39:34 2023 +0000

    refactor[react-devtools-shared]: minor parsing improvements and modifications (#27661)
    
    Had these stashed for some time, it includes:
    - Some refactoring to remove unnecessary `FlowFixMe`s and type castings
    via `any`.
    - Optimized version of parsing component names. We encode string names
    to utf8 and then pass it serialized from backend to frontend in a single
    array of numbers. Previously we would call `slice` to get the
    corresponding encoded string as a subarray and then parse each
    character. New implementation skips `slice` step and just receives
    `left` and `right` ranges for the string to parse.
    - Early `break` instead of `continue` when Store receives unexpected
    operation, like removing an element from the Store, which is not
    registered yet.

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index a04a31cf63..5ae3d3cdc4 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -27,7 +27,7 @@ import {
   setSavedComponentFilters,
   separateDisplayNameAndHOCs,
   shallowDiffers,
-  utfDecodeString,
+  utfDecodeStringWithRanges,
 } from '../utils';
 import {localStorageGetItem, localStorageSetItem} from '../storage';
 import {__DEBUG__} from '../constants';
@@ -450,7 +450,7 @@ export default class Store extends EventEmitter<{
   }
 
   // This build of DevTools supports the legacy profiler.
-  // This is a static flag, controled by the Store config.
+  // This is a static flag, controlled by the Store config.
   get supportsProfiling(): boolean {
     return this._supportsProfiling;
   }
@@ -467,7 +467,7 @@ export default class Store extends EventEmitter<{
   }
 
   // This build of DevTools supports the Timeline profiler.
-  // This is a static flag, controled by the Store config.
+  // This is a static flag, controlled by the Store config.
   get supportsTimeline(): boolean {
     return this._supportsTimeline;
   }
@@ -502,30 +502,58 @@ export default class Store extends EventEmitter<{
     }
 
     // Find which root this element is in...
-    let rootID;
     let root;
     let rootWeight = 0;
     for (let i = 0; i < this._roots.length; i++) {
-      rootID = this._roots[i];
-      root = ((this._idToElement.get(rootID): any): Element);
+      const rootID = this._roots[i];
+      root = this._idToElement.get(rootID);
+
+      if (root === undefined) {
+        this._throwAndEmitError(
+          Error(
+            `Couldn't find root with id "${rootID}": no matching node was found in the Store.`,
+          ),
+        );
+
+        return null;
+      }
+
       if (root.children.length === 0) {
         continue;
-      } else if (rootWeight + root.weight > index) {
+      }
+
+      if (rootWeight + root.weight > index) {
         break;
       } else {
         rootWeight += root.weight;
       }
     }
 
+    if (root === undefined) {
+      return null;
+    }
+
     // Find the element in the tree using the weight of each node...
     // Skip over the root itself, because roots aren't visible in the Elements tree.
-    let currentElement = ((root: any): Element);
+    let currentElement: Element = root;
     let currentWeight = rootWeight - 1;
+
     while (index !== currentWeight) {
       const numChildren = currentElement.children.length;
       for (let i = 0; i < numChildren; i++) {
         const childID = currentElement.children[i];
-        const child = ((this._idToElement.get(childID): any): Element);
+        const child = this._idToElement.get(childID);
+
+        if (child === undefined) {
+          this._throwAndEmitError(
+            Error(
+              `Couldn't child element with id "${childID}": no matching node was found in the Store.`,
+            ),
+          );
+
+          return null;
+        }
+
         const childWeight = child.isCollapsed ? 1 : child.weight;
 
         if (index <= currentWeight + childWeight) {
@@ -538,7 +566,7 @@ export default class Store extends EventEmitter<{
       }
     }
 
-    return ((currentElement: any): Element) || null;
+    return currentElement || null;
   }
 
   getElementIDAtIndex(index: number): number | null {
@@ -560,32 +588,31 @@ export default class Store extends EventEmitter<{
   getElementsWithErrorsAndWarnings(): Array<{id: number, index: number}> {
     if (this._cachedErrorAndWarningTuples !== null) {
       return this._cachedErrorAndWarningTuples;
-    } else {
-      const errorAndWarningTuples: ErrorAndWarningTuples = [];
-
-      this._errorsAndWarnings.forEach((_, id) => {
-        const index = this.getIndexOfElementID(id);
-        if (index !== null) {
-          let low = 0;
-          let high = errorAndWarningTuples.length;
-          while (low < high) {
-            const mid = (low + high) >> 1;
-            if (errorAndWarningTuples[mid].index > index) {
-              high = mid;
-            } else {
-              low = mid + 1;
-            }
-          }
+    }
 
-          errorAndWarningTuples.splice(low, 0, {id, index});
+    const errorAndWarningTuples: ErrorAndWarningTuples = [];
+
+    this._errorsAndWarnings.forEach((_, id) => {
+      const index = this.getIndexOfElementID(id);
+      if (index !== null) {
+        let low = 0;
+        let high = errorAndWarningTuples.length;
+        while (low < high) {
+          const mid = (low + high) >> 1;
+          if (errorAndWarningTuples[mid].index > index) {
+            high = mid;
+          } else {
+            low = mid + 1;
+          }
         }
-      });
 
-      // Cache for later (at least until the tree changes again).
-      this._cachedErrorAndWarningTuples = errorAndWarningTuples;
+        errorAndWarningTuples.splice(low, 0, {id, index});
+      }
+    });
 
-      return errorAndWarningTuples;
-    }
+    // Cache for later (at least until the tree changes again).
+    this._cachedErrorAndWarningTuples = errorAndWarningTuples;
+    return errorAndWarningTuples;
   }
 
   getErrorAndWarningCountForElementID(id: number): {
@@ -923,7 +950,11 @@ export default class Store extends EventEmitter<{
       const nextLength = operations[i];
       i++;
 
-      const nextString = utfDecodeString(operations.slice(i, i + nextLength));
+      const nextString = utfDecodeStringWithRanges(
+        operations,
+        i,
+        i + nextLength - 1,
+      );
       stringTable.push(nextString);
       i += nextLength;
     }
@@ -1035,7 +1066,7 @@ export default class Store extends EventEmitter<{
                 ),
               );
 
-              continue;
+              break;
             }
 
             parentElement.children.push(id);
@@ -1088,7 +1119,7 @@ export default class Store extends EventEmitter<{
                 ),
               );
 
-              continue;
+              break;
             }
 
             i += 1;
@@ -1126,7 +1157,7 @@ export default class Store extends EventEmitter<{
                   ),
                 );
 
-                continue;
+                break;
               }
 
               const index = parentElement.children.indexOf(id);
@@ -1172,7 +1203,17 @@ export default class Store extends EventEmitter<{
             }
           };
 
-          const root = ((this._idToElement.get(id): any): Element);
+          const root = this._idToElement.get(id);
+          if (root === undefined) {
+            this._throwAndEmitError(
+              Error(
+                `Cannot remove root "${id}": no matching node was found in the Store.`,
+              ),
+            );
+
+            break;
+          }
+
           recursivelyDeleteElements(id);
 
           this._rootIDToCapabilities.delete(id);
@@ -1194,7 +1235,7 @@ export default class Store extends EventEmitter<{
               ),
             );
 
-            continue;
+            break;
           }
 
           const children = element.children;
@@ -1279,7 +1320,7 @@ export default class Store extends EventEmitter<{
 
     this._revision++;
 
-    // Any time the tree changes (e.g. elements added, removed, or reordered) cached inidices may be invalid.
+    // Any time the tree changes (e.g. elements added, removed, or reordered) cached indices may be invalid.
     this._cachedErrorAndWarningTuples = null;
 
     if (haveErrorsOrWarningsChanged) {

commit 6c7b41da3de12be2d95c60181b3fe896f824f13a
Author: Ruslan Lesiutin <rdlesyutin@gmail.com>
Date:   Thu Nov 23 18:37:21 2023 +0000

    feat[devtools]: display Forget badge for the relevant components (#27709)
    
    Adds `Forget` badge to all relevant components.
    
    Changes:
    - If component is compiled with Forget and using a built-in
    `useMemoCache` hook, it will have a `Forget` badge next to its display
    name in:
      - components tree
      - inspected element view
      - owners list
    - Such badges are indexable, so Forget components can be searched using
    search bar.
    
    Fixes:
    - Displaying the badges for owners list inside the inspected component
    view
    
    Implementation:
    - React DevTools backend is responsible for identifying if component is
    compiled with Forget, based on `fiber.updateQueue.memoCache`. It will
    wrap component's display name with `Forget(...)` prefix before passing
    operations to the frontend. On the frontend side, we will parse the
    display name and strip Forget prefix, marking the corresponding element
    by setting `compiledWithForget` field. Almost the same logic is
    currently used for HOC display names.

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index 5ae3d3cdc4..1d0632072d 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -25,9 +25,9 @@ import {ElementTypeRoot} from '../frontend/types';
 import {
   getSavedComponentFilters,
   setSavedComponentFilters,
-  separateDisplayNameAndHOCs,
   shallowDiffers,
   utfDecodeStringWithRanges,
+  parseElementDisplayNameFromBackend,
 } from '../utils';
 import {localStorageGetItem, localStorageSetItem} from '../storage';
 import {__DEBUG__} from '../constants';
@@ -1033,6 +1033,7 @@ export default class Store extends EventEmitter<{
               parentID: 0,
               type,
               weight: 0,
+              compiledWithForget: false,
             });
 
             haveRootsChanged = true;
@@ -1071,8 +1072,11 @@ export default class Store extends EventEmitter<{
 
             parentElement.children.push(id);
 
-            const [displayNameWithoutHOCs, hocDisplayNames] =
-              separateDisplayNameAndHOCs(displayName, type);
+            const {
+              formattedDisplayName: displayNameWithoutHOCs,
+              hocDisplayNames,
+              compiledWithForget,
+            } = parseElementDisplayNameFromBackend(displayName, type);
 
             const element: Element = {
               children: [],
@@ -1087,6 +1091,7 @@ export default class Store extends EventEmitter<{
               parentID,
               type,
               weight: 1,
+              compiledWithForget,
             };
 
             this._idToElement.set(id, element);

commit 6f23540c7d39d7da2091284322008dadd055c031
Author: Ruslan Lesiutin <rdlesyutin@gmail.com>
Date:   Tue May 28 11:07:31 2024 +0100

    cleanup[react-devtools]: remove unused supportsProfiling flag from store config (#29193)
    
    Looks like this is unused

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index 1d0632072d..3eb589b903 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -68,11 +68,10 @@ const LOCAL_STORAGE_RECORD_CHANGE_DESCRIPTIONS_KEY =
 
 type ErrorAndWarningTuples = Array<{id: number, index: number}>;
 
-type Config = {
+export type Config = {
   checkBridgeProtocolCompatibility?: boolean,
   isProfiling?: boolean,
   supportsNativeInspection?: boolean,
-  supportsProfiling?: boolean,
   supportsReloadAndProfile?: boolean,
   supportsTimeline?: boolean,
   supportsTraceUpdates?: boolean,
@@ -174,7 +173,6 @@ export default class Store extends EventEmitter<{
 
   // These options may be initially set by a configuration option when constructing the Store.
   _supportsNativeInspection: boolean = true;
-  _supportsProfiling: boolean = false;
   _supportsReloadAndProfile: boolean = false;
   _supportsTimeline: boolean = false;
   _supportsTraceUpdates: boolean = false;
@@ -214,15 +212,11 @@ export default class Store extends EventEmitter<{
 
       const {
         supportsNativeInspection,
-        supportsProfiling,
         supportsReloadAndProfile,
         supportsTimeline,
         supportsTraceUpdates,
       } = config;
       this._supportsNativeInspection = supportsNativeInspection !== false;
-      if (supportsProfiling) {
-        this._supportsProfiling = true;
-      }
       if (supportsReloadAndProfile) {
         this._supportsReloadAndProfile = true;
       }
@@ -449,12 +443,6 @@ export default class Store extends EventEmitter<{
     return this._isNativeStyleEditorSupported;
   }
 
-  // This build of DevTools supports the legacy profiler.
-  // This is a static flag, controlled by the Store config.
-  get supportsProfiling(): boolean {
-    return this._supportsProfiling;
-  }
-
   get supportsReloadAndProfile(): boolean {
     // Does the DevTools shell support reloading and eagerly injecting the renderer interface?
     // And if so, can the backend use the localStorage API and sync XHR?

commit fd6e130b00d4d1fe211c75e981160131669c4412
Author: Vitali Zaidman <vzaidman@gmail.com>
Date:   Thu Jun 6 17:48:44 2024 +0100

    Default native inspections config false (#29784)
    
    ## Summary
    
    To make the config `supportsNativeInspection` explicit, set it to
    default to `false` and only allow it in the extension.
    
    ## How did you test this change?
    When disabled on **React DevTools extension**
    <img width="419" alt="Screenshot 2024-06-06 at 17 34 02"
    src="https://github.com/facebook/react/assets/5188459/0052b645-2214-475c-8b41-4f9207ca3343">
    
    When enabled on **React DevTools extension** (the chosen config)
    <img width="425" alt="Screenshot 2024-06-06 at 17 34 53"
    src="https://github.com/facebook/react/assets/5188459/df34ec8e-2039-4984-86c8-74feaf89bbdd">
    
    When enabled on **React DevTools in Fusebox**
    <img width="1170" alt="Screenshot 2024-06-06 at 17 29 24"
    src="https://github.com/facebook/react/assets/5188459/ae52274b-583d-463c-8482-2323d502f4c0">
    
    When disabled on **React DevTools in Fusebox** (the chosen config)
    <img width="1453" alt="Screenshot 2024-06-06 at 17 30 31"
    src="https://github.com/facebook/react/assets/5188459/cba5b51b-c973-412d-8ad0-382a4f9bf115">
    
    When enabled on **React DevTools Inline**
    <img width="915" alt="Screenshot 2024-06-06 at 17 24 20"
    src="https://github.com/facebook/react/assets/5188459/f0d61d99-2b75-4a87-a19e-db431be697e3">
    
    When disabled on **React DevTools Inline** (the chosen config)
    <img width="844" alt="Screenshot 2024-06-06 at 17 19 39"
    src="https://github.com/facebook/react/assets/5188459/d3bcc8a7-535d-4656-844d-f9f89bb2b248">
    
    When enabled on **React DevTools standalone**
    <img width="1227" alt="Screenshot 2024-06-06 at 17 23 16"
    src="https://github.com/facebook/react/assets/5188459/174fbae6-1412-4539-bbe6-e1d0e8baa7d5">
    
    When disabled on **React DevTools standalone** (the chosen config)
    <img width="844" alt="Screenshot 2024-06-06 at 17 19 39"
    src="https://github.com/facebook/react/assets/5188459/00c46907-e3a6-4766-a1b4-dd088cac2157">

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index 3eb589b903..408151dcdb 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -172,7 +172,7 @@ export default class Store extends EventEmitter<{
   _rootIDToRendererID: Map<number, number> = new Map();
 
   // These options may be initially set by a configuration option when constructing the Store.
-  _supportsNativeInspection: boolean = true;
+  _supportsNativeInspection: boolean = false;
   _supportsReloadAndProfile: boolean = false;
   _supportsTimeline: boolean = false;
   _supportsTraceUpdates: boolean = false;
@@ -216,7 +216,9 @@ export default class Store extends EventEmitter<{
         supportsTimeline,
         supportsTraceUpdates,
       } = config;
-      this._supportsNativeInspection = supportsNativeInspection !== false;
+      if (supportsNativeInspection) {
+        this._supportsNativeInspection = true;
+      }
       if (supportsReloadAndProfile) {
         this._supportsReloadAndProfile = true;
       }

commit d9a5b6393a9329b60592e34c9e1fe091e6af5090
Author: Vitali Zaidman <vzaidman@gmail.com>
Date:   Thu Jun 13 15:37:51 2024 +0100

    fix[react-devtools] divided inspecting elements between inspecting do (#29885)
    
    # **before**
    * nav to dom element from devtools
    * nav to devtools element from page
    are enabled on extension and disabled on the rest of the flavors.
    
    ## extension:
    * nav to dom element from devtools **enabled** and working
    * nav to devtools element from page **enabled** and working
    ![Screenshot 2024-06-13 at 11 15
    11](https://github.com/facebook/react/assets/5188459/fef78b70-d22c-4405-8871-8b0449b51937)
    
    ## inline:
    * nav to dom element from devtools **disabled**
    * nav to devtools element from page **disabled**
    
    ![before-inline](https://github.com/facebook/react/assets/5188459/24020dc2-baec-4d0a-84d4-45c96d653843)
    
    ## standalone:
    * nav to dom element from devtools **disabled**
    * nav to devtools element from page **disabled**
    
    ![before-standalone](https://github.com/facebook/react/assets/5188459/19b4cb34-9d1f-412e-baea-59ea85f99d04)
    
    ## fusebox:
    * nav to dom element from devtools **disabled**
    * nav to devtools element from page **disabled**
    
    ![before-fusebox](https://github.com/facebook/react/assets/5188459/1a18fda4-04b8-40f4-ae8b-e059889fca93)
    
    # **after**
    same:
    * nav to dom element from devtools
    * nav to devtools element from page
    are enabled on extension and disabled on inline.
    
    change:
    standalone and fusebox can nav to devtools element from page
    
    ## extension:
    * nav to dom element from devtools **enabled** and working
    * nav to devtools element from page **enabled** and working
    ![Screenshot 2024-06-13 at 10 50
    25](https://github.com/facebook/react/assets/5188459/f4679c72-b211-43d6-b3ea-6380e0d1edf0)
    
    ## inline:
    * nav to dom element from devtools **disabled**
    * nav to devtools element from page **disabled**
    
    ![after-inline](https://github.com/facebook/react/assets/5188459/fdfdd87b-9bc3-47f3-b1e0-730239f6485d)
    
    ## standalone:
    * nav to dom element from devtools **disabled**
    * nav to devtools element from page **enabled** and working
    
    ![after-standalone](https://github.com/facebook/react/assets/5188459/b25e3c63-a697-4b0c-8ad2-0e12ec5c3e9c)
    
    ## fusebox:
    * nav to dom element from devtools **disabled**
    * nav to devtools element from page **enabled** and working
    
    ![after-fusebox](https://github.com/facebook/react/assets/5188459/f14147d8-9831-4909-a164-52f892c875e5)

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index 408151dcdb..ef6f720346 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -71,7 +71,8 @@ type ErrorAndWarningTuples = Array<{id: number, index: number}>;
 export type Config = {
   checkBridgeProtocolCompatibility?: boolean,
   isProfiling?: boolean,
-  supportsNativeInspection?: boolean,
+  supportsInspectMatchingDOMElement?: boolean,
+  supportsClickToInspect?: boolean,
   supportsReloadAndProfile?: boolean,
   supportsTimeline?: boolean,
   supportsTraceUpdates?: boolean,
@@ -172,7 +173,8 @@ export default class Store extends EventEmitter<{
   _rootIDToRendererID: Map<number, number> = new Map();
 
   // These options may be initially set by a configuration option when constructing the Store.
-  _supportsNativeInspection: boolean = false;
+  _supportsInspectMatchingDOMElement: boolean = false;
+  _supportsClickToInspect: boolean = false;
   _supportsReloadAndProfile: boolean = false;
   _supportsTimeline: boolean = false;
   _supportsTraceUpdates: boolean = false;
@@ -211,13 +213,17 @@ export default class Store extends EventEmitter<{
       isProfiling = config.isProfiling === true;
 
       const {
-        supportsNativeInspection,
+        supportsInspectMatchingDOMElement,
+        supportsClickToInspect,
         supportsReloadAndProfile,
         supportsTimeline,
         supportsTraceUpdates,
       } = config;
-      if (supportsNativeInspection) {
-        this._supportsNativeInspection = true;
+      if (supportsInspectMatchingDOMElement) {
+        this._supportsInspectMatchingDOMElement = true;
+      }
+      if (supportsClickToInspect) {
+        this._supportsClickToInspect = true;
       }
       if (supportsReloadAndProfile) {
         this._supportsReloadAndProfile = true;
@@ -437,8 +443,12 @@ export default class Store extends EventEmitter<{
     return this._rootSupportsTimelineProfiling;
   }
 
-  get supportsNativeInspection(): boolean {
-    return this._supportsNativeInspection;
+  get supportsInspectMatchingDOMElement(): boolean {
+    return this._supportsInspectMatchingDOMElement;
+  }
+
+  get supportsClickToInspect(): boolean {
+    return this._supportsClickToInspect;
   }
 
   get supportsNativeStyleEditor(): boolean {

commit 344bc8128bc8f135e3fe6bb3449580d216ec7639
Author: Ruslan Lesiutin <rdlesyutin@gmail.com>
Date:   Wed Sep 11 15:10:13 2024 +0100

    refactor[Agent/Store]: Store to send messages only after Agent is initialized (#30945)
    
    Both for browser extension, and for React Native (as part of
    `react-devtools-core`) `Store` is initialized before the Backend (and
    `Agent` as a part of it):
    
    https://github.com/facebook/react/blob/bac33d1f82d9094b45d6f662dd7fa895abab8bce/packages/react-devtools-extensions/src/main/index.js#L111-L113
    
    Any messages that we send from `Store`'s constructor are ignored,
    because there is nothing on the other end yet. With these changes,
    `Agent` will send `backendInitialized` message to `Store`, after which
    `getBackendVersion` and other events will be sent.
    
    Note that `isBackendStorageAPISupported` and `isSynchronousXHRSupported`
    are still sent from `Agent`'s constructor, because we don't explicitly
    ask for it from `Store`, but these are used.
    
    This the pre-requisite for fetching settings and unsupported renderers
    reliably from the Frontend.

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index ef6f720346..e4d4b9dcce 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -191,6 +191,8 @@ export default class Store extends EventEmitter<{
   // Used for windowing purposes.
   _weightAcrossRoots: number = 0;
 
+  _shouldCheckBridgeProtocolCompatibility: boolean = false;
+
   constructor(bridge: FrontendBridge, config?: Config) {
     super();
 
@@ -218,6 +220,7 @@ export default class Store extends EventEmitter<{
         supportsReloadAndProfile,
         supportsTimeline,
         supportsTraceUpdates,
+        checkBridgeProtocolCompatibility,
       } = config;
       if (supportsInspectMatchingDOMElement) {
         this._supportsInspectMatchingDOMElement = true;
@@ -234,6 +237,9 @@ export default class Store extends EventEmitter<{
       if (supportsTraceUpdates) {
         this._supportsTraceUpdates = true;
       }
+      if (checkBridgeProtocolCompatibility) {
+        this._shouldCheckBridgeProtocolCompatibility = true;
+      }
     }
 
     this._bridge = bridge;
@@ -262,24 +268,9 @@ export default class Store extends EventEmitter<{
 
     this._profilerStore = new ProfilerStore(bridge, this, isProfiling);
 
-    // Verify that the frontend version is compatible with the connected backend.
-    // See github.com/facebook/react/issues/21326
-    if (config != null && config.checkBridgeProtocolCompatibility) {
-      // Older backends don't support an explicit bridge protocol,
-      // so we should timeout eventually and show a downgrade message.
-      this._onBridgeProtocolTimeoutID = setTimeout(
-        this.onBridgeProtocolTimeout,
-        10000,
-      );
-
-      bridge.addListener('bridgeProtocol', this.onBridgeProtocol);
-      bridge.send('getBridgeProtocol');
-    }
-
     bridge.addListener('backendVersion', this.onBridgeBackendVersion);
-    bridge.send('getBackendVersion');
-
     bridge.addListener('saveToClipboard', this.onSaveToClipboard);
+    bridge.addListener('backendInitialized', this.onBackendInitialized);
   }
 
   // This is only used in tests to avoid memory leaks.
@@ -1493,6 +1484,24 @@ export default class Store extends EventEmitter<{
     copy(text);
   };
 
+  onBackendInitialized: () => void = () => {
+    // Verify that the frontend version is compatible with the connected backend.
+    // See github.com/facebook/react/issues/21326
+    if (this._shouldCheckBridgeProtocolCompatibility) {
+      // Older backends don't support an explicit bridge protocol,
+      // so we should timeout eventually and show a downgrade message.
+      this._onBridgeProtocolTimeoutID = setTimeout(
+        this.onBridgeProtocolTimeout,
+        10000,
+      );
+
+      this._bridge.addListener('bridgeProtocol', this.onBridgeProtocol);
+      this._bridge.send('getBridgeProtocol');
+    }
+
+    this._bridge.send('getBackendVersion');
+  };
+
   // The Store should never throw an Error without also emitting an event.
   // Otherwise Store errors will be invisible to users,
   // but the downstream errors they cause will be reported as bugs.

commit bb6b86ed596399ddd8bf642404a9e68ae430a6ea
Author: Ruslan Lesiutin <rdlesyutin@gmail.com>
Date:   Thu Sep 12 13:59:29 2024 +0100

    refactor[react-devtools]: initialize renderer interface early (#30946)
    
    The current state is that `rendererInterface`, which contains all the
    backend logic, like generating component stack or attaching errors to
    fibers, or traversing the Fiber tree, ..., is only mounted after the
    Frontend is created.
    
    For browser extension, this means that we don't patch console or track
    errors and warnings before Chrome DevTools is opened.
    
    With these changes, `rendererInterface` is created right after
    `renderer` is injected from React via global hook object (e. g.
    `__REACT_DEVTOOLS_GLOBAL_HOOK__.inject(...)`.
    
    Because of the current implementation, in case of multiple Reacts on the
    page, all of them will patch the console independently. This will be
    fixed in one of the next PRs, where I am moving console patching to the
    global Hook.
    
    This change of course makes `hook.js` script bigger, but I think it is a
    reasonable trade-off for better DevX. We later can add more heuristics
    to optimize the performance (if necessary) of `rendererInterface` for
    cases when Frontend was connected late and Backend is attempting to
    flush out too many recorded operations.
    
    This essentially reverts https://github.com/facebook/react/pull/26563.

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index e4d4b9dcce..d351306a44 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -1500,6 +1500,7 @@ export default class Store extends EventEmitter<{
     }
 
     this._bridge.send('getBackendVersion');
+    this._bridge.send('getIfHasUnsupportedRendererVersion');
   };
 
   // The Store should never throw an Error without also emitting an event.

commit e33acfd67f0003272a9aec7a0725d19a429f2460
Author: Ruslan Lesiutin <rdlesyutin@gmail.com>
Date:   Wed Sep 18 18:19:01 2024 +0100

    refactor[react-devtools]: propagate settings from global hook object to frontend (#30610)
    
    Stacked on https://github.com/facebook/react/pull/30597 and whats under
    it. See [this
    commit](https://github.com/facebook/react/pull/30610/commits/59b4efa72377bf62f5ec8c0e32e56902cf73fbd7).
    
    With this change, the initial values for console patching settings are
    propagated from hook (which is the source of truth now, because of
    https://github.com/facebook/react/pull/30596) to the UI. Instead of
    reading from `localStorage` the frontend is now requesting it from the
    hook. This happens when settings modal is rendered, and wrapped in a
    transition. Also, this is happening even if settings modal is not opened
    yet, so we have enough time to fetch this data without displaying loader
    or similar UI.

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index d351306a44..1798e0952b 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -49,6 +49,7 @@ import type {
   BridgeProtocol,
 } from 'react-devtools-shared/src/bridge';
 import UnsupportedBridgeOperationError from 'react-devtools-shared/src/UnsupportedBridgeOperationError';
+import type {DevToolsHookSettings} from '../backend/types';
 
 const debug = (methodName: string, ...args: Array<string>) => {
   if (__DEBUG__) {
@@ -94,6 +95,7 @@ export default class Store extends EventEmitter<{
   collapseNodesByDefault: [],
   componentFilters: [],
   error: [Error],
+  hookSettings: [$ReadOnly<DevToolsHookSettings>],
   mutated: [[Array<number>, Map<number, number>]],
   recordChangeDescriptions: [],
   roots: [],
@@ -192,6 +194,7 @@ export default class Store extends EventEmitter<{
   _weightAcrossRoots: number = 0;
 
   _shouldCheckBridgeProtocolCompatibility: boolean = false;
+  _hookSettings: $ReadOnly<DevToolsHookSettings> | null = null;
 
   constructor(bridge: FrontendBridge, config?: Config) {
     super();
@@ -270,6 +273,7 @@ export default class Store extends EventEmitter<{
 
     bridge.addListener('backendVersion', this.onBridgeBackendVersion);
     bridge.addListener('saveToClipboard', this.onSaveToClipboard);
+    bridge.addListener('hookSettings', this.onHookSettings);
     bridge.addListener('backendInitialized', this.onBackendInitialized);
   }
 
@@ -1501,8 +1505,29 @@ export default class Store extends EventEmitter<{
 
     this._bridge.send('getBackendVersion');
     this._bridge.send('getIfHasUnsupportedRendererVersion');
+    this._bridge.send('getHookSettings'); // Warm up cached hook settings
   };
 
+  getHookSettings: () => void = () => {
+    if (this._hookSettings != null) {
+      this.emit('hookSettings', this._hookSettings);
+    } else {
+      this._bridge.send('getHookSettings');
+    }
+  };
+
+  updateHookSettings: (settings: $ReadOnly<DevToolsHookSettings>) => void =
+    settings => {
+      this._hookSettings = settings;
+      this._bridge.send('updateHookSettings', settings);
+    };
+
+  onHookSettings: (settings: $ReadOnly<DevToolsHookSettings>) => void =
+    settings => {
+      this._hookSettings = settings;
+      this.emit('hookSettings', settings);
+    };
+
   // The Store should never throw an Error without also emitting an event.
   // Otherwise Store errors will be invisible to users,
   // but the downstream errors they cause will be reported as bugs.

commit f37c7bc6539b4da38f7080b5486eb00bdb2c3237
Author: Ruslan Lesiutin <rdlesyutin@gmail.com>
Date:   Wed Sep 18 18:26:39 2024 +0100

    feat[react-devtools/extension]: use chrome.storage to persist settings across sessions (#30636)
    
    Stacked on https://github.com/facebook/react/pull/30610 and whats under
    it. See [last
    commit](https://github.com/facebook/react/pull/30636/commits/248ddba18608e1bb5ef14c823085a7ff9d7a54a3).
    
    Now, we are using
    [`chrome.storage`](https://developer.chrome.com/docs/extensions/reference/api/storage)
    to persist settings for the browser extension across different sessions.
    Once settings are updated from the UI, the `Store` will emit
    `settingsUpdated` event, and we are going to persist them via
    `chrome.storage.local.set` in `main/index.js`.
    
    When hook is being injected, we are going to pass a `Promise`, which is
    going to be resolved after the settings are read from the storage via
    `chrome.storage.local.get` in `hookSettingsInjector.js`.

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index 1798e0952b..b54907338b 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -96,6 +96,7 @@ export default class Store extends EventEmitter<{
   componentFilters: [],
   error: [Error],
   hookSettings: [$ReadOnly<DevToolsHookSettings>],
+  settingsUpdated: [$ReadOnly<DevToolsHookSettings>],
   mutated: [[Array<number>, Map<number, number>]],
   recordChangeDescriptions: [],
   roots: [],
@@ -1519,7 +1520,9 @@ export default class Store extends EventEmitter<{
   updateHookSettings: (settings: $ReadOnly<DevToolsHookSettings>) => void =
     settings => {
       this._hookSettings = settings;
+
       this._bridge.send('updateHookSettings', settings);
+      this.emit('settingsUpdated', settings);
     };
 
   onHookSettings: (settings: $ReadOnly<DevToolsHookSettings>) => void =

commit a15bbe14751287cb7ac124ff88f694d0883f3ac6
Author: Ruslan Lesiutin <rdlesyutin@gmail.com>
Date:   Tue Sep 24 19:51:21 2024 +0100

    refactor: data source for errors and warnings tracking is now in Store (#31010)
    
    Stacked on https://github.com/facebook/react/pull/31009.
    
    1. Instead of keeping `showInlineWarningsAndErrors` in `Settings`
    context (which was removed in
    https://github.com/facebook/react/pull/30610), `Store` will now have a
    boolean flag, which controls if the UI should be displaying information
    about errors and warnings.
    2. The errors and warnings counters in the Tree view are now counting
    only unique errors. This makes more sense, because it is part of the
    Elements Tree view, so ideally it should be showing number of components
    with errors and number of components of warnings. Consider this example:
    2.1. Warning for element `A` was emitted once and warning for element
    `B` was emitted twice.
    2.2. With previous implementation, we would show `3 `, because in
    total there were 3 warnings in total. If user tries to iterate through
    these, it will only take 2 steps to do the full cycle, because there are
    only 2 elements with warnings (with one having same warning, which was
    emitted twice).
    2.3 With current implementation, we would show `2 `. Inspecting the
    element with doubled warning will still show the warning counter (2)
    before the warning message.
    
    With these changes, the feature correctly works.
    https://fburl.com/a7fw92m4

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index b54907338b..b1544126d8 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -114,8 +114,8 @@ export default class Store extends EventEmitter<{
   _bridge: FrontendBridge;
 
   // Computed whenever _errorsAndWarnings Map changes.
-  _cachedErrorCount: number = 0;
-  _cachedWarningCount: number = 0;
+  _cachedComponentWithErrorCount: number = 0;
+  _cachedComponentWithWarningCount: number = 0;
   _cachedErrorAndWarningTuples: ErrorAndWarningTuples | null = null;
 
   // Should new nodes be collapsed by default when added to the tree?
@@ -196,6 +196,7 @@ export default class Store extends EventEmitter<{
 
   _shouldCheckBridgeProtocolCompatibility: boolean = false;
   _hookSettings: $ReadOnly<DevToolsHookSettings> | null = null;
+  _shouldShowWarningsAndErrors: boolean = false;
 
   constructor(bridge: FrontendBridge, config?: Config) {
     super();
@@ -383,8 +384,24 @@ export default class Store extends EventEmitter<{
     return this._bridgeProtocol;
   }
 
-  get errorCount(): number {
-    return this._cachedErrorCount;
+  get componentWithErrorCount(): number {
+    if (!this._shouldShowWarningsAndErrors) {
+      return 0;
+    }
+
+    return this._cachedComponentWithErrorCount;
+  }
+
+  get componentWithWarningCount(): number {
+    if (!this._shouldShowWarningsAndErrors) {
+      return 0;
+    }
+
+    return this._cachedComponentWithWarningCount;
+  }
+
+  get displayingErrorsAndWarningsEnabled(): boolean {
+    return this._shouldShowWarningsAndErrors;
   }
 
   get hasOwnerMetadata(): boolean {
@@ -480,10 +497,6 @@ export default class Store extends EventEmitter<{
     return this._unsupportedRendererVersionDetected;
   }
 
-  get warningCount(): number {
-    return this._cachedWarningCount;
-  }
-
   containsElement(id: number): boolean {
     return this._idToElement.has(id);
   }
@@ -581,7 +594,11 @@ export default class Store extends EventEmitter<{
   }
 
   // Returns a tuple of [id, index]
-  getElementsWithErrorsAndWarnings(): Array<{id: number, index: number}> {
+  getElementsWithErrorsAndWarnings(): ErrorAndWarningTuples {
+    if (!this._shouldShowWarningsAndErrors) {
+      return [];
+    }
+
     if (this._cachedErrorAndWarningTuples !== null) {
       return this._cachedErrorAndWarningTuples;
     }
@@ -615,6 +632,10 @@ export default class Store extends EventEmitter<{
     errorCount: number,
     warningCount: number,
   } {
+    if (!this._shouldShowWarningsAndErrors) {
+      return {errorCount: 0, warningCount: 0};
+    }
+
     return this._errorsAndWarnings.get(id) || {errorCount: 0, warningCount: 0};
   }
 
@@ -1325,16 +1346,21 @@ export default class Store extends EventEmitter<{
     this._cachedErrorAndWarningTuples = null;
 
     if (haveErrorsOrWarningsChanged) {
-      let errorCount = 0;
-      let warningCount = 0;
+      let componentWithErrorCount = 0;
+      let componentWithWarningCount = 0;
 
       this._errorsAndWarnings.forEach(entry => {
-        errorCount += entry.errorCount;
-        warningCount += entry.warningCount;
+        if (entry.errorCount > 0) {
+          componentWithErrorCount++;
+        }
+
+        if (entry.warningCount > 0) {
+          componentWithWarningCount++;
+        }
       });
 
-      this._cachedErrorCount = errorCount;
-      this._cachedWarningCount = warningCount;
+      this._cachedComponentWithErrorCount = componentWithErrorCount;
+      this._cachedComponentWithWarningCount = componentWithWarningCount;
     }
 
     if (haveRootsChanged) {
@@ -1528,9 +1554,21 @@ export default class Store extends EventEmitter<{
   onHookSettings: (settings: $ReadOnly<DevToolsHookSettings>) => void =
     settings => {
       this._hookSettings = settings;
+
+      this.setShouldShowWarningsAndErrors(settings.showInlineWarningsAndErrors);
       this.emit('hookSettings', settings);
     };
 
+  setShouldShowWarningsAndErrors(status: boolean): void {
+    const previousStatus = this._shouldShowWarningsAndErrors;
+    this._shouldShowWarningsAndErrors = status;
+
+    if (previousStatus !== status) {
+      // Propagate to subscribers, although tree state has not changed
+      this.emit('mutated', [[], new Map()]);
+    }
+  }
+
   // The Store should never throw an Error without also emitting an event.
   // Otherwise Store errors will be invisible to users,
   // but the downstream errors they cause will be reported as bugs.

commit f8024b0686c87634b233262e8a05e4a37a292e87
Author: Edmond Chui <1967998+EdmondChuiHW@users.noreply.github.com>
Date:   Thu Sep 26 12:39:28 2024 +0100

    refactor: allow custom impl of backend realod-to-profile support check (#31048)
    
    <!--
      Thanks for submitting a pull request!
    We appreciate you spending the time to work on these changes. Please
    provide enough information so that others can review your pull request.
    The three fields below are mandatory.
    
    Before submitting a pull request, please make sure the following is
    done:
    
    1. Fork [the repository](https://github.com/facebook/react) and create
    your branch from `main`.
      2. Run `yarn` in the repository root.
    3. If you've fixed a bug or added code that should be tested, add tests!
    4. Ensure the test suite passes (`yarn test`). Tip: `yarn test --watch
    TestName` is helpful in development.
    5. Run `yarn test --prod` to test in the production environment. It
    supports the same options as `yarn test`.
    6. If you need a debugger, run `yarn test --debug --watch TestName`,
    open `chrome://inspect`, and press "Inspect".
    7. Format your code with
    [prettier](https://github.com/prettier/prettier) (`yarn prettier`).
    8. Make sure your code lints (`yarn lint`). Tip: `yarn linc` to only
    check changed files.
      9. Run the [Flow](https://flowtype.org/) type checks (`yarn flow`).
      10. If you haven't already, complete the CLA.
    
    Learn more about contributing:
    https://reactjs.org/docs/how-to-contribute.html
    -->
    
    ## Summary
    
    In preparation to support reload-to-profile in Fusebox (#31021), we need
    a way to check capability of different backends, e.g. web vs React
    Native.
    
    ## How did you test this change?
    
    <!--
    Demonstrate the code is solid. Example: The exact commands you ran and
    their output, screenshots / videos if the pull request changes the user
    interface.
    How exactly did you verify that your PR solves the issue you wanted to
    solve?
      If you leave this empty, your PR will very likely be closed.
    -->
    
    * Default, e.g. existing web impl = no-op
    * Custom impl: is called

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index b1544126d8..8af997d928 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -138,16 +138,6 @@ export default class Store extends EventEmitter<{
   // Should the React Native style editor panel be shown?
   _isNativeStyleEditorSupported: boolean = false;
 
-  // Can the backend use the Storage API (e.g. localStorage)?
-  // If not, features like reload-and-profile will not work correctly and must be disabled.
-  _isBackendStorageAPISupported: boolean = false;
-
-  // Can DevTools use sync XHR requests?
-  // If not, features like reload-and-profile will not work correctly and must be disabled.
-  // This current limitation applies only to web extension builds
-  // and will need to be reconsidered in the future if we add support for reload to React Native.
-  _isSynchronousXHRSupported: boolean = false;
-
   _nativeStyleEditorValidAttributes: $ReadOnlyArray<string> | null = null;
 
   // Older backends don't support an explicit bridge protocol,
@@ -178,10 +168,12 @@ export default class Store extends EventEmitter<{
   // These options may be initially set by a configuration option when constructing the Store.
   _supportsInspectMatchingDOMElement: boolean = false;
   _supportsClickToInspect: boolean = false;
-  _supportsReloadAndProfile: boolean = false;
   _supportsTimeline: boolean = false;
   _supportsTraceUpdates: boolean = false;
 
+  _isReloadAndProfileFrontendSupported: boolean = false;
+  _isReloadAndProfileBackendSupported: boolean = false;
+
   // These options default to false but may be updated as roots are added and removed.
   _rootSupportsBasicProfiling: boolean = false;
   _rootSupportsTimelineProfiling: boolean = false;
@@ -234,7 +226,7 @@ export default class Store extends EventEmitter<{
         this._supportsClickToInspect = true;
       }
       if (supportsReloadAndProfile) {
-        this._supportsReloadAndProfile = true;
+        this._isReloadAndProfileFrontendSupported = true;
       }
       if (supportsTimeline) {
         this._supportsTimeline = true;
@@ -255,17 +247,13 @@ export default class Store extends EventEmitter<{
     );
     bridge.addListener('shutdown', this.onBridgeShutdown);
     bridge.addListener(
-      'isBackendStorageAPISupported',
-      this.onBackendStorageAPISupported,
+      'isReloadAndProfileSupportedByBackend',
+      this.onBackendReloadAndProfileSupported,
     );
     bridge.addListener(
       'isNativeStyleEditorSupported',
       this.onBridgeNativeStyleEditorSupported,
     );
-    bridge.addListener(
-      'isSynchronousXHRSupported',
-      this.onBridgeSynchronousXHRSupported,
-    );
     bridge.addListener(
       'unsupportedRendererVersion',
       this.onBridgeUnsupportedRendererVersion,
@@ -469,13 +457,9 @@ export default class Store extends EventEmitter<{
   }
 
   get supportsReloadAndProfile(): boolean {
-    // Does the DevTools shell support reloading and eagerly injecting the renderer interface?
-    // And if so, can the backend use the localStorage API and sync XHR?
-    // All of these are currently required for the reload-and-profile feature to work.
     return (
-      this._supportsReloadAndProfile &&
-      this._isBackendStorageAPISupported &&
-      this._isSynchronousXHRSupported
+      this._isReloadAndProfileFrontendSupported &&
+      this._isReloadAndProfileBackendSupported
     );
   }
 
@@ -1433,17 +1417,13 @@ export default class Store extends EventEmitter<{
     );
     bridge.removeListener('shutdown', this.onBridgeShutdown);
     bridge.removeListener(
-      'isBackendStorageAPISupported',
-      this.onBackendStorageAPISupported,
+      'isReloadAndProfileSupportedByBackend',
+      this.onBackendReloadAndProfileSupported,
     );
     bridge.removeListener(
       'isNativeStyleEditorSupported',
       this.onBridgeNativeStyleEditorSupported,
     );
-    bridge.removeListener(
-      'isSynchronousXHRSupported',
-      this.onBridgeSynchronousXHRSupported,
-    );
     bridge.removeListener(
       'unsupportedRendererVersion',
       this.onBridgeUnsupportedRendererVersion,
@@ -1458,18 +1438,10 @@ export default class Store extends EventEmitter<{
     }
   };
 
-  onBackendStorageAPISupported: (
-    isBackendStorageAPISupported: boolean,
-  ) => void = isBackendStorageAPISupported => {
-    this._isBackendStorageAPISupported = isBackendStorageAPISupported;
-
-    this.emit('supportsReloadAndProfile');
-  };
-
-  onBridgeSynchronousXHRSupported: (
-    isSynchronousXHRSupported: boolean,
-  ) => void = isSynchronousXHRSupported => {
-    this._isSynchronousXHRSupported = isSynchronousXHRSupported;
+  onBackendReloadAndProfileSupported: (
+    isReloadAndProfileSupported: boolean,
+  ) => void = isReloadAndProfileSupported => {
+    this._isReloadAndProfileBackendSupported = isReloadAndProfileSupported;
 
     this.emit('supportsReloadAndProfile');
   };

commit dbf80c8d7a823041d83baff8b0dca8892ce27411
Author: Ruslan Lesiutin <rdlesyutin@gmail.com>
Date:   Wed Oct 9 13:23:23 2024 +0100

    fix[react-devtools]: update profiling status before receiving response from backend (#31117)
    
    We can't wait for a response from Backend, because it might take some
    time to actually finish profiling.
    
    We should keep a flag on the frontend side, so user can quickly see the
    feedback in the UI.

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index 8af997d928..9f4343beab 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -324,7 +324,7 @@ export default class Store extends EventEmitter<{
     return this._componentFilters;
   }
   set componentFilters(value: Array<ComponentFilter>): void {
-    if (this._profilerStore.isProfiling) {
+    if (this._profilerStore.isProfilingBasedOnUserInput) {
       // Re-mounting a tree while profiling is in progress might break a lot of assumptions.
       // If necessary, we could support this- but it doesn't seem like a necessary use case.
       this._throwAndEmitError(

commit 54cfa95d3a83328868f9fba00d8213e6de6c7d2f
Author: Ruslan Lesiutin <rdlesyutin@gmail.com>
Date:   Thu Jan 9 18:01:07 2025 +0000

    DevTools: fix initial host instance selection (#31892)
    
    Related: https://github.com/facebook/react/pull/31342
    
    This fixes RDT behaviour when some DOM element was pre-selected in
    built-in browser's Elements panel, and then Components panel of React
    DevTools was opened for the first time. With this change, React DevTools
    will correctly display the initial state of the Components Tree with the
    corresponding React Element (if possible) pre-selected.
    
    Previously, we would only subscribe listener when `TreeContext` is
    mounted, but this only happens when user opens one of React DevTools
    panels for the first time. With this change, we keep state inside
    `Store`, which is created when Browser DevTools are opened. Later,
    `TreeContext` will use it for initial state value.
    
    Planned next changes:
    1. Merge `inspectedElementID` and `selectedElementID`, I have no idea
    why we need both.
    2. Fix issue with `AutoSizer` rendering a blank container.

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index 9f4343beab..0a3fbe82bb 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -96,6 +96,7 @@ export default class Store extends EventEmitter<{
   componentFilters: [],
   error: [Error],
   hookSettings: [$ReadOnly<DevToolsHookSettings>],
+  hostInstanceSelected: [Element['id']],
   settingsUpdated: [$ReadOnly<DevToolsHookSettings>],
   mutated: [[Array<number>, Map<number, number>]],
   recordChangeDescriptions: [],
@@ -190,6 +191,9 @@ export default class Store extends EventEmitter<{
   _hookSettings: $ReadOnly<DevToolsHookSettings> | null = null;
   _shouldShowWarningsAndErrors: boolean = false;
 
+  // Only used in browser extension for synchronization with built-in Elements panel.
+  _lastSelectedHostInstanceElementId: Element['id'] | null = null;
+
   constructor(bridge: FrontendBridge, config?: Config) {
     super();
 
@@ -265,6 +269,7 @@ export default class Store extends EventEmitter<{
     bridge.addListener('saveToClipboard', this.onSaveToClipboard);
     bridge.addListener('hookSettings', this.onHookSettings);
     bridge.addListener('backendInitialized', this.onBackendInitialized);
+    bridge.addListener('selectElement', this.onHostInstanceSelected);
   }
 
   // This is only used in tests to avoid memory leaks.
@@ -481,6 +486,10 @@ export default class Store extends EventEmitter<{
     return this._unsupportedRendererVersionDetected;
   }
 
+  get lastSelectedHostInstanceElementId(): Element['id'] | null {
+    return this._lastSelectedHostInstanceElementId;
+  }
+
   containsElement(id: number): boolean {
     return this._idToElement.has(id);
   }
@@ -1431,6 +1440,7 @@ export default class Store extends EventEmitter<{
     bridge.removeListener('backendVersion', this.onBridgeBackendVersion);
     bridge.removeListener('bridgeProtocol', this.onBridgeProtocol);
     bridge.removeListener('saveToClipboard', this.onSaveToClipboard);
+    bridge.removeListener('selectElement', this.onHostInstanceSelected);
 
     if (this._onBridgeProtocolTimeoutID !== null) {
       clearTimeout(this._onBridgeProtocolTimeoutID);
@@ -1507,6 +1517,16 @@ export default class Store extends EventEmitter<{
     this._bridge.send('getHookSettings'); // Warm up cached hook settings
   };
 
+  onHostInstanceSelected: (elementId: number) => void = elementId => {
+    if (this._lastSelectedHostInstanceElementId === elementId) {
+      return;
+    }
+
+    this._lastSelectedHostInstanceElementId = elementId;
+    // By the time we emit this, there is no guarantee that TreeContext is rendered.
+    this.emit('hostInstanceSelected', elementId);
+  };
+
   getHookSettings: () => void = () => {
     if (this._hookSettings != null) {
       this.emit('hookSettings', this._hookSettings);

commit 221f3002caa2314cba0a62950da6fb92b453d1d0
Author: Ruslan Lesiutin <rdlesyutin@gmail.com>
Date:   Thu Jan 30 20:08:17 2025 +0000

    chore[DevTools]: make clipboardWrite optional for chromium (#32262)
    
    Addresses https://github.com/facebook/react/issues/32244.
    
    ### Chromium
    We will use
    [chrome.permissions](https://developer.chrome.com/docs/extensions/reference/api/permissions)
    for checking / requesting `clipboardWrite` permission before copying
    something to the clipboard.
    
    ### Firefox
    We will keep `clipboardWrite` as a required permission, because there is
    no reliable and working API for requesting optional permissions for
    extensions that are extending browser DevTools:
    - `chrome.permissions` is unavailable for devtools pages -
    https://bugzilla.mozilla.org/show_bug.cgi?id=1796933
    - You can't call `chrome.permissions.request` from background, because
    this instruction has to be executed inside user-event callback,
    basically only initiated by user.
    
    I don't really want to come up with solutions like opening a new tab
    with a button that user has to click.

diff --git a/packages/react-devtools-shared/src/devtools/store.js b/packages/react-devtools-shared/src/devtools/store.js
index 0a3fbe82bb..3895217053 100644
--- a/packages/react-devtools-shared/src/devtools/store.js
+++ b/packages/react-devtools-shared/src/devtools/store.js
@@ -38,6 +38,7 @@ import {
   currentBridgeProtocol,
 } from 'react-devtools-shared/src/bridge';
 import {StrictMode} from 'react-devtools-shared/src/frontend/types';
+import {withPermissionsCheck} from 'react-devtools-shared/src/frontend/utils/withPermissionsCheck';
 
 import type {
   Element,
@@ -1494,7 +1495,7 @@ export default class Store extends EventEmitter<{
   };
 
   onSaveToClipboard: (text: string) => void = text => {
-    copy(text);
+    withPermissionsCheck({permissions: ['clipboardWrite']}, () => copy(text))();
   };
 
   onBackendInitialized: () => void = () => {

