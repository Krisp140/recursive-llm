# Instructions

You are being benchmarked. You will see the output of a git log command, and from that must infer the current state of a file. Think carefully, as you must output the exact state of the file to earn full marks.

**Important:** Your goal is to reproduce the file's content *exactly* as it exists at the final commit, even if the code appears broken, buggy, or contains obvious errors. Do **not** try to "fix" the code. Attempting to correct issues will result in a poor score, as this benchmark evaluates your ability to reproduce the precise state of the file based on its history.

# Required Response Format

Wrap the content of the file in triple backticks (```). Any text outside the final closing backticks will be ignored. End your response after outputting the closing backticks.

# Example Response

```python
#!/usr/bin/env python
print('Hello, world!')
```

# File History

> git log -p --cc --topo-order --reverse -- aider/sendchat.py

commit 289887d94fae425d654f5d47e5a244d32c2a8161
Author: Paul Gauthier <aider@paulg.org>
Date:   Fri Jul 21 11:21:41 2023 -0300

    refactor send_with_retries

diff --git a/aider/sendchat.py b/aider/sendchat.py
new file mode 100644
index 00000000..9a441423
--- /dev/null
+++ b/aider/sendchat.py
@@ -0,0 +1,44 @@
+import hashlib
+import json
+
+import backoff
+import openai
+import requests
+from openai.error import APIError, RateLimitError, ServiceUnavailableError, Timeout
+
+
+@backoff.on_exception(
+    backoff.expo,
+    (
+        Timeout,
+        APIError,
+        ServiceUnavailableError,
+        RateLimitError,
+        requests.exceptions.ConnectionError,
+    ),
+    max_tries=10,
+    on_backoff=lambda details: print(
+        f"{details.get('exception','Exception')}\nRetry in {details['wait']:.1f} seconds."
+    ),
+)
+def send_with_retries(model, messages, functions, stream):
+    kwargs = dict(
+        model=model,
+        messages=messages,
+        temperature=0,
+        stream=stream,
+    )
+    if functions is not None:
+        kwargs["functions"] = functions
+
+    # we are abusing the openai object to stash these values
+    if hasattr(openai, "api_deployment_id"):
+        kwargs["deployment_id"] = openai.api_deployment_id
+    if hasattr(openai, "api_engine"):
+        kwargs["engine"] = openai.api_engine
+
+    # Generate SHA1 hash of kwargs and append it to chat_completion_call_hashes
+    hash_object = hashlib.sha1(json.dumps(kwargs, sort_keys=True).encode())
+
+    res = openai.ChatCompletion.create(**kwargs)
+    return hash_object, res

commit 661a521693628385616ed6413113453fe288e5d4
Author: Paul Gauthier <aider@paulg.org>
Date:   Fri Jul 21 16:20:27 2023 -0300

    aider.repo.simple_send_with_retries

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 9a441423..44144786 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -42,3 +42,16 @@ def send_with_retries(model, messages, functions, stream):
 
     res = openai.ChatCompletion.create(**kwargs)
     return hash_object, res
+
+
+def simple_send_with_retries(model, messages):
+    try:
+        _hash, response = send_with_retries(
+            model=model,
+            messages=messages,
+            functions=None,
+            stream=False,
+        )
+        return response.choices[0].message.content
+    except (AttributeError, openai.error.InvalidRequestError):
+        return

commit 3e4b4d1b0da8a84e1340ba65fa38c07a7ad753c0
Author: Paul Gauthier <aider@paulg.org>
Date:   Wed Jul 26 07:40:36 2023 -0300

    retry on APIConnectionError

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 44144786..56b46bd4 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -4,7 +4,13 @@ import json
 import backoff
 import openai
 import requests
-from openai.error import APIError, RateLimitError, ServiceUnavailableError, Timeout
+from openai.error import (
+    APIConnectionError,
+    APIError,
+    RateLimitError,
+    ServiceUnavailableError,
+    Timeout,
+)
 
 
 @backoff.on_exception(
@@ -14,6 +20,7 @@ from openai.error import APIError, RateLimitError, ServiceUnavailableError, Time
         APIError,
         ServiceUnavailableError,
         RateLimitError,
+        APIConnectionError,
         requests.exceptions.ConnectionError,
     ),
     max_tries=10,

commit 0aa2ff2cf9c0ed5a466204f26171a26ec02e30c8
Author: Paul Gauthier <aider@paulg.org>
Date:   Wed Aug 9 11:30:13 2023 -0300

    roughed in cache; elide full dirnames from test results to make them deterministic

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 56b46bd4..57d9f168 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -4,6 +4,7 @@ import json
 import backoff
 import openai
 import requests
+from diskcache import Cache
 from openai.error import (
     APIConnectionError,
     APIError,
@@ -12,6 +13,9 @@ from openai.error import (
     Timeout,
 )
 
+CACHE_PATH = ".aider.send.cache.v1"
+CACHE = Cache(CACHE_PATH)
+
 
 @backoff.on_exception(
     backoff.expo,
@@ -44,10 +48,22 @@ def send_with_retries(model, messages, functions, stream):
     if hasattr(openai, "api_engine"):
         kwargs["engine"] = openai.api_engine
 
+    key = json.dumps(kwargs, sort_keys=True).encode()
+
     # Generate SHA1 hash of kwargs and append it to chat_completion_call_hashes
-    hash_object = hashlib.sha1(json.dumps(kwargs, sort_keys=True).encode())
+    hash_object = hashlib.sha1(key)
+
+    if not stream and key in CACHE:
+        print("hit", key)
+        return hash_object, CACHE[key]
+
+    print("miss", key)
 
     res = openai.ChatCompletion.create(**kwargs)
+
+    if not stream:
+        CACHE[key] = res
+
     return hash_object, res
 
 

commit 9e64e7bb9d0a52ad68be5ff7f39cbad3aa9ef604
Author: Paul Gauthier <aider@paulg.org>
Date:   Wed Aug 9 11:57:00 2023 -0300

    precise edit blocks prompting language

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 57d9f168..b4bd6b48 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -13,7 +13,7 @@ from openai.error import (
     Timeout,
 )
 
-CACHE_PATH = ".aider.send.cache.v1"
+CACHE_PATH = "~/.aider.send.cache.v1"
 CACHE = Cache(CACHE_PATH)
 
 
@@ -54,11 +54,8 @@ def send_with_retries(model, messages, functions, stream):
     hash_object = hashlib.sha1(key)
 
     if not stream and key in CACHE:
-        print("hit", key)
         return hash_object, CACHE[key]
 
-    print("miss", key)
-
     res = openai.ChatCompletion.create(**kwargs)
 
     if not stream:

commit 7924900bc4814860be5a172f446344551a1deb2c
Author: Paul Gauthier <aider@paulg.org>
Date:   Thu Aug 10 12:27:46 2023 -0300

    updated tests, disabled send cache

diff --git a/aider/sendchat.py b/aider/sendchat.py
index b4bd6b48..5025d42d 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -4,7 +4,8 @@ import json
 import backoff
 import openai
 import requests
-from diskcache import Cache
+
+# from diskcache import Cache
 from openai.error import (
     APIConnectionError,
     APIError,
@@ -14,7 +15,8 @@ from openai.error import (
 )
 
 CACHE_PATH = "~/.aider.send.cache.v1"
-CACHE = Cache(CACHE_PATH)
+CACHE = None
+# CACHE = Cache(CACHE_PATH)
 
 
 @backoff.on_exception(
@@ -53,12 +55,12 @@ def send_with_retries(model, messages, functions, stream):
     # Generate SHA1 hash of kwargs and append it to chat_completion_call_hashes
     hash_object = hashlib.sha1(key)
 
-    if not stream and key in CACHE:
+    if not stream and CACHE is not None and key in CACHE:
         return hash_object, CACHE[key]
 
     res = openai.ChatCompletion.create(**kwargs)
 
-    if not stream:
+    if not stream and CACHE is not None:
         CACHE[key] = res
 
     return hash_object, res

commit 041f3a4a381670449011e3cfbf4d18900452855b
Author: JV <aider@codewithjv.com>
Date:   Tue Aug 15 03:35:55 2023 +1200

    initial code for working with openrouter

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 5025d42d..04bcab94 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -50,6 +50,12 @@ def send_with_retries(model, messages, functions, stream):
     if hasattr(openai, "api_engine"):
         kwargs["engine"] = openai.api_engine
 
+    if "openrouter.ai" in openai.api_base:
+        kwargs["headers"] = {
+            "HTTP-Referer": "http://aider.chat",
+            "X-Title": "Aider"
+        }
+
     key = json.dumps(kwargs, sort_keys=True).encode()
 
     # Generate SHA1 hash of kwargs and append it to chat_completion_call_hashes

commit abbc93678b2d14dd6a7e34bd2861ed9ac743e4ad
Author: Joshua Vial <joshua@enspiral.com>
Date:   Wed Aug 23 21:26:27 2023 +1200

    finishing openrouter integration

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 04bcab94..2269e512 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -34,9 +34,9 @@ CACHE = None
         f"{details.get('exception','Exception')}\nRetry in {details['wait']:.1f} seconds."
     ),
 )
-def send_with_retries(model, messages, functions, stream):
+def send_with_retries(model_name, messages, functions, stream):
     kwargs = dict(
-        model=model,
+        model=model_name,
         messages=messages,
         temperature=0,
         stream=stream,
@@ -72,10 +72,10 @@ def send_with_retries(model, messages, functions, stream):
     return hash_object, res
 
 
-def simple_send_with_retries(model, messages):
+def simple_send_with_retries(model_name, messages):
     try:
         _hash, response = send_with_retries(
-            model=model,
+            model_name=model_name,
             messages=messages,
             functions=None,
             stream=False,

commit 13343924181a1934eea7e8f62e28ddccb36c5eba
Author: Paul Gauthier <aider@paulg.org>
Date:   Fri Sep 1 15:53:19 2023 -0700

    lint

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 2269e512..7c2994dc 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -51,10 +51,7 @@ def send_with_retries(model_name, messages, functions, stream):
         kwargs["engine"] = openai.api_engine
 
     if "openrouter.ai" in openai.api_base:
-        kwargs["headers"] = {
-            "HTTP-Referer": "http://aider.chat",
-            "X-Title": "Aider"
-        }
+        kwargs["headers"] = {"HTTP-Referer": "http://aider.chat", "X-Title": "Aider"}
 
     key = json.dumps(kwargs, sort_keys=True).encode()
 

commit d8f33a81242d05b130790d0e7cc2d83f74ea5542
Author: Joshua Vial <joshua@enspiral.com>
Date:   Wed Nov 29 21:20:29 2023 +1300

    Auto switch to gpt-4-vision-preview if image files added to context

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 7c2994dc..fb190f85 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -53,6 +53,13 @@ def send_with_retries(model_name, messages, functions, stream):
     if "openrouter.ai" in openai.api_base:
         kwargs["headers"] = {"HTTP-Referer": "http://aider.chat", "X-Title": "Aider"}
 
+    # Check conditions to switch to gpt-4-vision-preview
+    if "openrouter.ai" not in openai.api_base and model_name.startswith("gpt-4"):
+        if any(isinstance(msg.get("content"), list) and any("image_url" in item for item in msg.get("content") if isinstance(item, dict)) for msg in messages):
+            kwargs['model'] = "gpt-4-vision-preview"
+            # looks like gpt-4-vision is limited to max tokens of 4096
+            kwargs["max_tokens"] = 4096
+
     key = json.dumps(kwargs, sort_keys=True).encode()
 
     # Generate SHA1 hash of kwargs and append it to chat_completion_call_hashes

commit 6ebc142377a9fd7f04cdf82903098b60667b7a7a
Author: Paul Gauthier <aider@paulg.org>
Date:   Tue Dec 5 07:37:05 2023 -0800

    roughed in openai 1.x

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 7c2994dc..a1b5b767 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -6,11 +6,11 @@ import openai
 import requests
 
 # from diskcache import Cache
-from openai.error import (
+from openai import (
     APIConnectionError,
     APIError,
+    InternalServerError,
     RateLimitError,
-    ServiceUnavailableError,
     Timeout,
 )
 
@@ -24,7 +24,7 @@ CACHE = None
     (
         Timeout,
         APIError,
-        ServiceUnavailableError,
+        InternalServerError,
         RateLimitError,
         APIConnectionError,
         requests.exceptions.ConnectionError,
@@ -34,7 +34,7 @@ CACHE = None
         f"{details.get('exception','Exception')}\nRetry in {details['wait']:.1f} seconds."
     ),
 )
-def send_with_retries(model_name, messages, functions, stream):
+def send_with_retries(client, model_name, messages, functions, stream):
     kwargs = dict(
         model=model_name,
         messages=messages,
@@ -44,15 +44,6 @@ def send_with_retries(model_name, messages, functions, stream):
     if functions is not None:
         kwargs["functions"] = functions
 
-    # we are abusing the openai object to stash these values
-    if hasattr(openai, "api_deployment_id"):
-        kwargs["deployment_id"] = openai.api_deployment_id
-    if hasattr(openai, "api_engine"):
-        kwargs["engine"] = openai.api_engine
-
-    if "openrouter.ai" in openai.api_base:
-        kwargs["headers"] = {"HTTP-Referer": "http://aider.chat", "X-Title": "Aider"}
-
     key = json.dumps(kwargs, sort_keys=True).encode()
 
     # Generate SHA1 hash of kwargs and append it to chat_completion_call_hashes
@@ -61,7 +52,7 @@ def send_with_retries(model_name, messages, functions, stream):
     if not stream and CACHE is not None and key in CACHE:
         return hash_object, CACHE[key]
 
-    res = openai.ChatCompletion.create(**kwargs)
+    res = client.chat.completions.create(**kwargs)
 
     if not stream and CACHE is not None:
         CACHE[key] = res
@@ -69,14 +60,15 @@ def send_with_retries(model_name, messages, functions, stream):
     return hash_object, res
 
 
-def simple_send_with_retries(model_name, messages):
+def simple_send_with_retries(client, model_name, messages):
     try:
         _hash, response = send_with_retries(
+            client=client,
             model_name=model_name,
             messages=messages,
             functions=None,
             stream=False,
         )
         return response.choices[0].message.content
-    except (AttributeError, openai.error.InvalidRequestError):
+    except (AttributeError, openai.BadRequestError):
         return

commit 23e6c4ee5575905e11ba86d97c89116231a90087
Author: Paul Gauthier <aider@paulg.org>
Date:   Tue Dec 5 10:51:50 2023 -0800

    fixed test_coder

diff --git a/aider/sendchat.py b/aider/sendchat.py
index a1b5b767..9419de7b 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -6,13 +6,9 @@ import openai
 import requests
 
 # from diskcache import Cache
-from openai import (
-    APIConnectionError,
-    APIError,
-    InternalServerError,
-    RateLimitError,
-    Timeout,
-)
+from openai import APIConnectionError, InternalServerError, RateLimitError
+
+from aider.dump import dump  # noqa: F401
 
 CACHE_PATH = "~/.aider.send.cache.v1"
 CACHE = None
@@ -22,8 +18,6 @@ CACHE = None
 @backoff.on_exception(
     backoff.expo,
     (
-        Timeout,
-        APIError,
         InternalServerError,
         RateLimitError,
         APIConnectionError,

commit 2ed0c8fb66645337dd31145b3d4311994a95ba3d
Author: Paul Gauthier <aider@paulg.org>
Date:   Tue Dec 5 10:58:44 2023 -0800

    fixed test_repo

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 9419de7b..65b0a46c 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -29,6 +29,9 @@ CACHE = None
     ),
 )
 def send_with_retries(client, model_name, messages, functions, stream):
+    if not client:
+        raise ValueError("No openai client provided")
+
     kwargs = dict(
         model=model_name,
         messages=messages,

commit 5b21d5704a6274ee710f43aa83d146bd416f9cdf
Author: Paul Gauthier <aider@paulg.org>
Date:   Tue Dec 5 11:08:14 2023 -0800

    fixed test_sendchat

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 65b0a46c..c770ef08 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -2,8 +2,8 @@ import hashlib
 import json
 
 import backoff
+import httpx
 import openai
-import requests
 
 # from diskcache import Cache
 from openai import APIConnectionError, InternalServerError, RateLimitError
@@ -21,7 +21,7 @@ CACHE = None
         InternalServerError,
         RateLimitError,
         APIConnectionError,
-        requests.exceptions.ConnectionError,
+        httpx.ConnectError,
     ),
     max_tries=10,
     on_backoff=lambda details: print(

commit b107db98fa796eef49df4254344d84543f2300e3
Author: Paul Gauthier <aider@paulg.org>
Date:   Tue Dec 5 11:31:17 2023 -0800

    implement deployment id

diff --git a/aider/sendchat.py b/aider/sendchat.py
index c770ef08..baba6e68 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -28,10 +28,15 @@ CACHE = None
         f"{details.get('exception','Exception')}\nRetry in {details['wait']:.1f} seconds."
     ),
 )
-def send_with_retries(client, model_name, messages, functions, stream):
+def send_with_retries(client, model, messages, functions, stream):
     if not client:
         raise ValueError("No openai client provided")
 
+    if model.deployment_id:
+        model_name = model.deployment_id
+    else:
+        model_name = model.name
+
     kwargs = dict(
         model=model_name,
         messages=messages,
@@ -57,11 +62,11 @@ def send_with_retries(client, model_name, messages, functions, stream):
     return hash_object, res
 
 
-def simple_send_with_retries(client, model_name, messages):
+def simple_send_with_retries(client, model, messages):
     try:
         _hash, response = send_with_retries(
             client=client,
-            model_name=model_name,
+            model=model,
             messages=messages,
             functions=None,
             stream=False,

commit 57ab2cc9da833120b82b076f730db7c44619109e
Author: Paul Gauthier <aider@paulg.org>
Date:   Wed Dec 6 09:20:53 2023 -0800

    Revert "implement deployment id"
    
    This reverts commit b107db98fa796eef49df4254344d84543f2300e3.

diff --git a/aider/sendchat.py b/aider/sendchat.py
index baba6e68..c770ef08 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -28,15 +28,10 @@ CACHE = None
         f"{details.get('exception','Exception')}\nRetry in {details['wait']:.1f} seconds."
     ),
 )
-def send_with_retries(client, model, messages, functions, stream):
+def send_with_retries(client, model_name, messages, functions, stream):
     if not client:
         raise ValueError("No openai client provided")
 
-    if model.deployment_id:
-        model_name = model.deployment_id
-    else:
-        model_name = model.name
-
     kwargs = dict(
         model=model_name,
         messages=messages,
@@ -62,11 +57,11 @@ def send_with_retries(client, model, messages, functions, stream):
     return hash_object, res
 
 
-def simple_send_with_retries(client, model, messages):
+def simple_send_with_retries(client, model_name, messages):
     try:
         _hash, response = send_with_retries(
             client=client,
-            model=model,
+            model_name=model_name,
             messages=messages,
             functions=None,
             stream=False,

commit fe9423d7b880f4730a5825bd660831e01bf05b13
Merge: 91bbb0a0 560759f0
Author: Joshua Vial <joshua@enspiral.com>
Date:   Mon Dec 11 20:43:18 2023 +1300

    merge in openai upgrade

diff --cc aider/sendchat.py
index fb190f85,c770ef08..bca95385
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@@ -44,22 -41,6 +41,13 @@@ def send_with_retries(client, model_nam
      if functions is not None:
          kwargs["functions"] = functions
  
-     # we are abusing the openai object to stash these values
-     if hasattr(openai, "api_deployment_id"):
-         kwargs["deployment_id"] = openai.api_deployment_id
-     if hasattr(openai, "api_engine"):
-         kwargs["engine"] = openai.api_engine
- 
-     if "openrouter.ai" in openai.api_base:
-         kwargs["headers"] = {"HTTP-Referer": "http://aider.chat", "X-Title": "Aider"}
- 
 +    # Check conditions to switch to gpt-4-vision-preview
-     if "openrouter.ai" not in openai.api_base and model_name.startswith("gpt-4"):
++    if client and client.base_url.host != "openrouter.ai" and model_name.startswith("gpt-4"):
 +        if any(isinstance(msg.get("content"), list) and any("image_url" in item for item in msg.get("content") if isinstance(item, dict)) for msg in messages):
 +            kwargs['model'] = "gpt-4-vision-preview"
 +            # looks like gpt-4-vision is limited to max tokens of 4096
 +            kwargs["max_tokens"] = 4096
 +
      key = json.dumps(kwargs, sort_keys=True).encode()
  
      # Generate SHA1 hash of kwargs and append it to chat_completion_call_hashes

commit 3d8599617d079e913376b592949697c6f17923b0
Author: Joshua Vial <joshua@enspiral.com>
Date:   Mon Dec 11 20:56:20 2023 +1300

    Switch to gpt-4-vision-preview if baseurl.host includes api.openai.com/ and gpt-4, otherwise strip out any image_url messages.

diff --git a/aider/sendchat.py b/aider/sendchat.py
index bca95385..a2a50fac 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -42,6 +42,7 @@ def send_with_retries(client, model_name, messages, functions, stream):
         kwargs["functions"] = functions
 
     # Check conditions to switch to gpt-4-vision-preview
+    # TODO if baseurl.host does include api.openai.com/ and gpt-4 then switch the models, if it doesn't then strip out any image_url messages
     if client and client.base_url.host != "openrouter.ai" and model_name.startswith("gpt-4"):
         if any(isinstance(msg.get("content"), list) and any("image_url" in item for item in msg.get("content") if isinstance(item, dict)) for msg in messages):
             kwargs['model'] = "gpt-4-vision-preview"

commit d0255ce2aed98d7a72102627a6779c3034e32e73
Author: Joshua Vial <joshua@enspiral.com>
Date:   Mon Dec 11 20:56:23 2023 +1300

    better logic for image handling

diff --git a/aider/sendchat.py b/aider/sendchat.py
index a2a50fac..b1496488 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -41,13 +41,19 @@ def send_with_retries(client, model_name, messages, functions, stream):
     if functions is not None:
         kwargs["functions"] = functions
 
-    # Check conditions to switch to gpt-4-vision-preview
-    # TODO if baseurl.host does include api.openai.com/ and gpt-4 then switch the models, if it doesn't then strip out any image_url messages
-    if client and client.base_url.host != "openrouter.ai" and model_name.startswith("gpt-4"):
-        if any(isinstance(msg.get("content"), list) and any("image_url" in item for item in msg.get("content") if isinstance(item, dict)) for msg in messages):
-            kwargs['model'] = "gpt-4-vision-preview"
-            # looks like gpt-4-vision is limited to max tokens of 4096
-            kwargs["max_tokens"] = 4096
+    # Check conditions to switch to gpt-4-vision-preview or strip out image_url messages
+    if client and model_name.startswith("gpt-4"):
+        if client.base_url.host != "api.openai.com":
+            if any(isinstance(msg.get("content"), list) and any("image_url" in item for item in msg.get("content") if isinstance(item, dict)) for msg in messages):
+                kwargs['model'] = "gpt-4-vision-preview"
+                # gpt-4-vision is limited to max tokens of 4096
+                kwargs["max_tokens"] = 4096
+        else:
+            # Strip out any image_url messages if not using gpt-4-vision-preview
+            messages = [
+                {k: v for k, v in msg.items() if k != "content" or not any(isinstance(item, dict) and "image_url" in item for item in v)}
+                for msg in messages if isinstance(msg.get("content"), list)
+            ] + [msg for msg in messages if not isinstance(msg.get("content"), list)]
 
     key = json.dumps(kwargs, sort_keys=True).encode()
 

commit 90fb538015a73aededffd1760815682ae3d1b637
Author: Joshua Vial <joshua@enspiral.com>
Date:   Mon Dec 11 21:03:30 2023 +1300

    fix logic for image switching

diff --git a/aider/sendchat.py b/aider/sendchat.py
index b1496488..d5e62d97 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -42,18 +42,19 @@ def send_with_retries(client, model_name, messages, functions, stream):
         kwargs["functions"] = functions
 
     # Check conditions to switch to gpt-4-vision-preview or strip out image_url messages
-    if client and model_name.startswith("gpt-4"):
-        if client.base_url.host != "api.openai.com":
-            if any(isinstance(msg.get("content"), list) and any("image_url" in item for item in msg.get("content") if isinstance(item, dict)) for msg in messages):
-                kwargs['model'] = "gpt-4-vision-preview"
-                # gpt-4-vision is limited to max tokens of 4096
-                kwargs["max_tokens"] = 4096
-        else:
-            # Strip out any image_url messages if not using gpt-4-vision-preview
-            messages = [
-                {k: v for k, v in msg.items() if k != "content" or not any(isinstance(item, dict) and "image_url" in item for item in v)}
-                for msg in messages if isinstance(msg.get("content"), list)
-            ] + [msg for msg in messages if not isinstance(msg.get("content"), list)]
+    if client and model_name.startswith("gpt-4") and "api.openai.com" in client.base_url.host:
+        print('switch model')
+        if any(isinstance(msg.get("content"), list) and any("image_url" in item for item in msg.get("content") if isinstance(item, dict)) for msg in messages):
+            kwargs['model'] = "gpt-4-vision-preview"
+            # gpt-4-vision is limited to max tokens of 4096
+            kwargs["max_tokens"] = 4096
+    else:
+        # Strip out any image_url messages if not using gpt-4-vision-preview
+        print('strip img')
+        messages = [
+            {k: v for k, v in msg.items() if k != "content" or not any(isinstance(item, dict) and "image_url" in item for item in v)}
+            for msg in messages if isinstance(msg.get("content"), list)
+        ] + [msg for msg in messages if not isinstance(msg.get("content"), list)]
 
     key = json.dumps(kwargs, sort_keys=True).encode()
 

commit c919f9f0c6816fd87deb05c1d1cd927e7cf22b58
Author: Joshua Vial <joshua@enspiral.com>
Date:   Mon Dec 11 21:13:07 2023 +1300

    handle switching to gpt4-vision-preview

diff --git a/aider/sendchat.py b/aider/sendchat.py
index d5e62d97..d8ac9262 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -43,18 +43,10 @@ def send_with_retries(client, model_name, messages, functions, stream):
 
     # Check conditions to switch to gpt-4-vision-preview or strip out image_url messages
     if client and model_name.startswith("gpt-4") and "api.openai.com" in client.base_url.host:
-        print('switch model')
         if any(isinstance(msg.get("content"), list) and any("image_url" in item for item in msg.get("content") if isinstance(item, dict)) for msg in messages):
             kwargs['model'] = "gpt-4-vision-preview"
             # gpt-4-vision is limited to max tokens of 4096
             kwargs["max_tokens"] = 4096
-    else:
-        # Strip out any image_url messages if not using gpt-4-vision-preview
-        print('strip img')
-        messages = [
-            {k: v for k, v in msg.items() if k != "content" or not any(isinstance(item, dict) and "image_url" in item for item in v)}
-            for msg in messages if isinstance(msg.get("content"), list)
-        ] + [msg for msg in messages if not isinstance(msg.get("content"), list)]
 
     key = json.dumps(kwargs, sort_keys=True).encode()
 

commit f9ba8e7b41ac697d2fefcee5c9a140f715cba957
Author: Joshua Vial <joshua@enspiral.com>
Date:   Mon Dec 11 21:53:53 2023 +1300

    Remove unnecessary comment and method call in Commands class.

diff --git a/aider/sendchat.py b/aider/sendchat.py
index d8ac9262..18956b83 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -41,8 +41,10 @@ def send_with_retries(client, model_name, messages, functions, stream):
     if functions is not None:
         kwargs["functions"] = functions
 
+    from aider.utils import is_gpt4_with_openai_base_url
+
     # Check conditions to switch to gpt-4-vision-preview or strip out image_url messages
-    if client and model_name.startswith("gpt-4") and "api.openai.com" in client.base_url.host:
+    if client and is_gpt4_with_openai_base_url(model_name, client):
         if any(isinstance(msg.get("content"), list) and any("image_url" in item for item in msg.get("content") if isinstance(item, dict)) for msg in messages):
             kwargs['model'] = "gpt-4-vision-preview"
             # gpt-4-vision is limited to max tokens of 4096

commit 9ceaf97f08b6e71466ad703c7b31e95486133734
Author: Joshua Vial <joshua@enspiral.com>
Date:   Mon Dec 11 22:21:24 2023 +1300

    making image code more robust

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 18956b83..64aa9c7b 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -8,6 +8,7 @@ import openai
 # from diskcache import Cache
 from openai import APIConnectionError, InternalServerError, RateLimitError
 
+from aider.utils import is_gpt4_with_openai_base_url
 from aider.dump import dump  # noqa: F401
 
 CACHE_PATH = "~/.aider.send.cache.v1"
@@ -41,7 +42,6 @@ def send_with_retries(client, model_name, messages, functions, stream):
     if functions is not None:
         kwargs["functions"] = functions
 
-    from aider.utils import is_gpt4_with_openai_base_url
 
     # Check conditions to switch to gpt-4-vision-preview or strip out image_url messages
     if client and is_gpt4_with_openai_base_url(model_name, client):

commit b0245d39303d350ed79e9dbb86339b550344108c
Author: Paul Gauthier <aider@paulg.org>
Date:   Wed Apr 17 14:15:24 2024 -0700

    rouged in litellm

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 64aa9c7b..ec25d2c0 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -3,13 +3,14 @@ import json
 
 import backoff
 import httpx
+import litellm
 import openai
 
 # from diskcache import Cache
 from openai import APIConnectionError, InternalServerError, RateLimitError
 
-from aider.utils import is_gpt4_with_openai_base_url
 from aider.dump import dump  # noqa: F401
+from aider.utils import is_gpt4_with_openai_base_url
 
 CACHE_PATH = "~/.aider.send.cache.v1"
 CACHE = None
@@ -30,9 +31,6 @@ CACHE = None
     ),
 )
 def send_with_retries(client, model_name, messages, functions, stream):
-    if not client:
-        raise ValueError("No openai client provided")
-
     kwargs = dict(
         model=model_name,
         messages=messages,
@@ -42,11 +40,14 @@ def send_with_retries(client, model_name, messages, functions, stream):
     if functions is not None:
         kwargs["functions"] = functions
 
-
     # Check conditions to switch to gpt-4-vision-preview or strip out image_url messages
     if client and is_gpt4_with_openai_base_url(model_name, client):
-        if any(isinstance(msg.get("content"), list) and any("image_url" in item for item in msg.get("content") if isinstance(item, dict)) for msg in messages):
-            kwargs['model'] = "gpt-4-vision-preview"
+        if any(
+            isinstance(msg.get("content"), list)
+            and any("image_url" in item for item in msg.get("content") if isinstance(item, dict))
+            for msg in messages
+        ):
+            kwargs["model"] = "gpt-4-vision-preview"
             # gpt-4-vision is limited to max tokens of 4096
             kwargs["max_tokens"] = 4096
 
@@ -58,7 +59,7 @@ def send_with_retries(client, model_name, messages, functions, stream):
     if not stream and CACHE is not None and key in CACHE:
         return hash_object, CACHE[key]
 
-    res = client.chat.completions.create(**kwargs)
+    res = litellm.completion(**kwargs)
 
     if not stream and CACHE is not None:
         CACHE[key] = res

commit c770fc4380ba5bf92fc4f22795528f1a86ab9349
Author: Paul Gauthier <aider@paulg.org>
Date:   Wed Apr 17 15:47:07 2024 -0700

    cleaned up client refs

diff --git a/aider/sendchat.py b/aider/sendchat.py
index ec25d2c0..dd07e536 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -30,7 +30,7 @@ CACHE = None
         f"{details.get('exception','Exception')}\nRetry in {details['wait']:.1f} seconds."
     ),
 )
-def send_with_retries(client, model_name, messages, functions, stream):
+def send_with_retries(model_name, messages, functions, stream):
     kwargs = dict(
         model=model_name,
         messages=messages,
@@ -41,7 +41,7 @@ def send_with_retries(client, model_name, messages, functions, stream):
         kwargs["functions"] = functions
 
     # Check conditions to switch to gpt-4-vision-preview or strip out image_url messages
-    if client and is_gpt4_with_openai_base_url(model_name, client):
+    if is_gpt4_with_openai_base_url(model_name):
         if any(
             isinstance(msg.get("content"), list)
             and any("image_url" in item for item in msg.get("content") if isinstance(item, dict))
@@ -67,10 +67,9 @@ def send_with_retries(client, model_name, messages, functions, stream):
     return hash_object, res
 
 
-def simple_send_with_retries(client, model_name, messages):
+def simple_send_with_retries(model_name, messages):
     try:
         _hash, response = send_with_retries(
-            client=client,
             model_name=model_name,
             messages=messages,
             functions=None,

commit 0da1b59901bb5bccce92672eb54f55d1f754b312
Author: Paul Gauthier <aider@paulg.org>
Date:   Thu Apr 18 14:39:32 2024 -0700

    Fixed up images in chat

diff --git a/aider/sendchat.py b/aider/sendchat.py
index dd07e536..a36f967b 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -10,7 +10,6 @@ import openai
 from openai import APIConnectionError, InternalServerError, RateLimitError
 
 from aider.dump import dump  # noqa: F401
-from aider.utils import is_gpt4_with_openai_base_url
 
 CACHE_PATH = "~/.aider.send.cache.v1"
 CACHE = None
@@ -40,17 +39,6 @@ def send_with_retries(model_name, messages, functions, stream):
     if functions is not None:
         kwargs["functions"] = functions
 
-    # Check conditions to switch to gpt-4-vision-preview or strip out image_url messages
-    if is_gpt4_with_openai_base_url(model_name):
-        if any(
-            isinstance(msg.get("content"), list)
-            and any("image_url" in item for item in msg.get("content") if isinstance(item, dict))
-            for msg in messages
-        ):
-            kwargs["model"] = "gpt-4-vision-preview"
-            # gpt-4-vision is limited to max tokens of 4096
-            kwargs["max_tokens"] = 4096
-
     key = json.dumps(kwargs, sort_keys=True).encode()
 
     # Generate SHA1 hash of kwargs and append it to chat_completion_call_hashes

commit 9afa6e8435d70e357f72fb72af5d76f1f9fc46cf
Author: Paul Gauthier <aider@paulg.org>
Date:   Tue Apr 23 09:45:10 2024 -0700

    Added gemini 1.5 pro

diff --git a/aider/sendchat.py b/aider/sendchat.py
index a36f967b..e911932a 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -23,6 +23,7 @@ CACHE = None
         RateLimitError,
         APIConnectionError,
         httpx.ConnectError,
+        litellm.exceptions.BadRequestError,
     ),
     max_tries=10,
     on_backoff=lambda details: print(

commit 01cf038bb574bae0fd8bea883c9296beeed35295
Author: Paul Gauthier <aider@paulg.org>
Date:   Tue Apr 23 10:37:43 2024 -0700

    Quiet litellm

diff --git a/aider/sendchat.py b/aider/sendchat.py
index e911932a..2cbbfd2d 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -15,6 +15,8 @@ CACHE_PATH = "~/.aider.send.cache.v1"
 CACHE = None
 # CACHE = Cache(CACHE_PATH)
 
+litellm.suppress_debug_info = True
+
 
 @backoff.on_exception(
     backoff.expo,

commit 7b14d77e9efdabbf59a4c0fdeb5af2e55c69ba26
Author: Paul Gauthier <aider@paulg.org>
Date:   Tue Apr 30 14:40:15 2024 -0700

    Don't retry on gemini RECITATION error

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 2cbbfd2d..8693cf5d 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -18,6 +18,12 @@ CACHE = None
 litellm.suppress_debug_info = True
 
 
+def giveup_on_recitiation(ex):
+    if not isinstance(ex, litellm.exceptions.BadRequestError):
+        return
+    return "RECITATION" in str(ex)
+
+
 @backoff.on_exception(
     backoff.expo,
     (
@@ -27,6 +33,7 @@ litellm.suppress_debug_info = True
         httpx.ConnectError,
         litellm.exceptions.BadRequestError,
     ),
+    giveup=giveup_on_recitiation,
     max_tries=10,
     on_backoff=lambda details: print(
         f"{details.get('exception','Exception')}\nRetry in {details['wait']:.1f} seconds."
@@ -50,6 +57,8 @@ def send_with_retries(model_name, messages, functions, stream):
     if not stream and CACHE is not None and key in CACHE:
         return hash_object, CACHE[key]
 
+    # del kwargs['stream']
+
     res = litellm.completion(**kwargs)
 
     if not stream and CACHE is not None:

commit 3469e04eb882221fe60f16bf7cab0f0b0862a494
Author: Paul Gauthier <aider@paulg.org>
Date:   Tue Apr 30 15:34:01 2024 -0700

    Do exp backoff for litellm.exceptions.ServiceUnavailableError #580

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 8693cf5d..fd6ade8a 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -32,6 +32,7 @@ def giveup_on_recitiation(ex):
         APIConnectionError,
         httpx.ConnectError,
         litellm.exceptions.BadRequestError,
+        litellm.exceptions.ServiceUnavailableError,
     ),
     giveup=giveup_on_recitiation,
     max_tries=10,

commit a3a4d87a0ce4aa72c9e1cc33ac9ab353fbc1b83d
Author: Paul Gauthier <aider@paulg.org>
Date:   Tue Apr 30 15:40:13 2024 -0700

    treat litellm.exceptions.BadRequestError as a 400 error and do not retry

diff --git a/aider/sendchat.py b/aider/sendchat.py
index fd6ade8a..6c613d07 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -18,12 +18,6 @@ CACHE = None
 litellm.suppress_debug_info = True
 
 
-def giveup_on_recitiation(ex):
-    if not isinstance(ex, litellm.exceptions.BadRequestError):
-        return
-    return "RECITATION" in str(ex)
-
-
 @backoff.on_exception(
     backoff.expo,
     (
@@ -31,10 +25,8 @@ def giveup_on_recitiation(ex):
         RateLimitError,
         APIConnectionError,
         httpx.ConnectError,
-        litellm.exceptions.BadRequestError,
         litellm.exceptions.ServiceUnavailableError,
     ),
-    giveup=giveup_on_recitiation,
     max_tries=10,
     on_backoff=lambda details: print(
         f"{details.get('exception','Exception')}\nRetry in {details['wait']:.1f} seconds."

commit 1d7320e8a00ece68b8731609dd9b99a2542a8b7c
Author: Paul Gauthier <aider@paulg.org>
Date:   Fri May 3 08:48:19 2024 -0700

    Added httpx.RemoteProtocolError to backoff #586

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 6c613d07..a341993a 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -25,6 +25,7 @@ litellm.suppress_debug_info = True
         RateLimitError,
         APIConnectionError,
         httpx.ConnectError,
+        httpx.RemoteProtocolError,
         litellm.exceptions.ServiceUnavailableError,
     ),
     max_tries=10,

commit 7c9c4fe78885f6f9878abc9ba897cd9d9ac213e6
Author: Paul Gauthier <aider@paulg.org>
Date:   Sat May 4 17:43:26 2024 -0700

    should_giveup?

diff --git a/aider/sendchat.py b/aider/sendchat.py
index a341993a..3bb74a1a 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -18,6 +18,13 @@ CACHE = None
 litellm.suppress_debug_info = True
 
 
+def should_giveup(e):
+    if not hasattr(e, "status_code"):
+        return False
+
+    return not litellm._should_retry(e.status_code)
+
+
 @backoff.on_exception(
     backoff.expo,
     (
@@ -28,7 +35,8 @@ litellm.suppress_debug_info = True
         httpx.RemoteProtocolError,
         litellm.exceptions.ServiceUnavailableError,
     ),
-    max_tries=10,
+    giveup=should_giveup,
+    max_tries=3,
     on_backoff=lambda details: print(
         f"{details.get('exception','Exception')}\nRetry in {details['wait']:.1f} seconds."
     ),

commit 3e4fca26750e049a400302b7937db5fac26b3ca7
Author: Paul Gauthier <aider@paulg.org>
Date:   Sat May 4 17:48:01 2024 -0700

    max_time not max_tries

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 3bb74a1a..bd2ab9df 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -36,7 +36,7 @@ def should_giveup(e):
         litellm.exceptions.ServiceUnavailableError,
     ),
     giveup=should_giveup,
-    max_tries=3,
+    max_time=60,
     on_backoff=lambda details: print(
         f"{details.get('exception','Exception')}\nRetry in {details['wait']:.1f} seconds."
     ),

commit 9ff6770a0473e8e7e0ccc87e74eb197710e282d7
Author: Paul Gauthier <aider@paulg.org>
Date:   Wed May 8 08:05:15 2024 -0700

    refactored litellm to avoid duplicating workarounds

diff --git a/aider/sendchat.py b/aider/sendchat.py
index bd2ab9df..0dc27e63 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -3,20 +3,18 @@ import json
 
 import backoff
 import httpx
-import litellm
 import openai
 
 # from diskcache import Cache
 from openai import APIConnectionError, InternalServerError, RateLimitError
 
 from aider.dump import dump  # noqa: F401
+from aider.litellm import litellm
 
 CACHE_PATH = "~/.aider.send.cache.v1"
 CACHE = None
 # CACHE = Cache(CACHE_PATH)
 
-litellm.suppress_debug_info = True
-
 
 def should_giveup(e):
     if not hasattr(e, "status_code"):

commit 728a6297894ca9c2d6c936a9b682a6501e4424fc
Author: Paul Gauthier <aider@paulg.org>
Date:   Thu May 9 14:16:09 2024 -0700

    Catch and appropriately retry *all* litellm exceptions #598

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 0dc27e63..3708ce79 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -5,12 +5,12 @@ import backoff
 import httpx
 import openai
 
-# from diskcache import Cache
-from openai import APIConnectionError, InternalServerError, RateLimitError
-
 from aider.dump import dump  # noqa: F401
 from aider.litellm import litellm
 
+# from diskcache import Cache
+
+
 CACHE_PATH = "~/.aider.send.cache.v1"
 CACHE = None
 # CACHE = Cache(CACHE_PATH)
@@ -26,12 +26,13 @@ def should_giveup(e):
 @backoff.on_exception(
     backoff.expo,
     (
-        InternalServerError,
-        RateLimitError,
-        APIConnectionError,
         httpx.ConnectError,
         httpx.RemoteProtocolError,
+        litellm.exceptions.APIConnectionError,
+        litellm.exceptions.APIError,
+        litellm.exceptions.RateLimitError,
         litellm.exceptions.ServiceUnavailableError,
+        litellm.exceptions.Timeout,
     ),
     giveup=should_giveup,
     max_time=60,

commit 1098b428e6e118be2e4ebb49a3dd2b14ae79e50e
Author: Paul Gauthier <aider@paulg.org>
Date:   Sat May 11 07:47:53 2024 -0700

    prompt tweaks, retry on httpx.ReadTimeout

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 3708ce79..126bb50d 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -28,6 +28,7 @@ def should_giveup(e):
     (
         httpx.ConnectError,
         httpx.RemoteProtocolError,
+        httpx.ReadTimeout,
         litellm.exceptions.APIConnectionError,
         litellm.exceptions.APIError,
         litellm.exceptions.RateLimitError,

commit 4841f318c1d99cb7948b1a8e0ba9d447f1fe34d2
Author: Paul Gauthier <aider@paulg.org>
Date:   Sat May 11 15:01:56 2024 -0700

    always retry httpx errors

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 126bb50d..00833a27 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -20,6 +20,13 @@ def should_giveup(e):
     if not hasattr(e, "status_code"):
         return False
 
+    if type(e) in (
+        httpx.ConnectError,
+        httpx.RemoteProtocolError,
+        httpx.ReadTimeout,
+    ):
+        return False
+
     return not litellm._should_retry(e.status_code)
 
 

commit 819fccc7a4810c82472f46f500a4223e283ca702
Author: Paul Gauthier <aider@paulg.org>
Date:   Thu May 16 08:52:30 2024 -0700

    added temp param, prompt strong that files message is truth

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 00833a27..19e91d25 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -48,11 +48,11 @@ def should_giveup(e):
         f"{details.get('exception','Exception')}\nRetry in {details['wait']:.1f} seconds."
     ),
 )
-def send_with_retries(model_name, messages, functions, stream):
+def send_with_retries(model_name, messages, functions, stream, temperature=0):
     kwargs = dict(
         model=model_name,
         messages=messages,
-        temperature=0,
+        temperature=temperature,
         stream=stream,
     )
     if functions is not None:

commit 044617b1b7f15297c88658efa3ca6e822f02df7a
Author: Paul Gauthier <aider@paulg.org>
Date:   Thu Jun 27 14:40:46 2024 -0700

    continue roughly working using anthropic's prefill

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 19e91d25..8f661f59 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -3,7 +3,6 @@ import json
 
 import backoff
 import httpx
-import openai
 
 from aider.dump import dump  # noqa: F401
 from aider.litellm import litellm
@@ -85,5 +84,5 @@ def simple_send_with_retries(model_name, messages):
             stream=False,
         )
         return response.choices[0].message.content
-    except (AttributeError, openai.BadRequestError):
+    except (AttributeError, litellm.exceptions.BadRequestError):
         return

commit 2cd680cba7ccfa31b0dbede5ebe0a104f76e29e7
Author: Paul Gauthier <aider@paulg.org>
Date:   Mon Jul 1 14:12:00 2024 -0300

    Automatically retry on Anthropic overloaded_error

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 8f661f59..78e16ae6 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -40,6 +40,7 @@ def should_giveup(e):
         litellm.exceptions.RateLimitError,
         litellm.exceptions.ServiceUnavailableError,
         litellm.exceptions.Timeout,
+        litellm.llms.anthropic.AnthropicError,
     ),
     giveup=should_giveup,
     max_time=60,

commit ee203deef0ff7bbef229e3766457865f7c507b10
Author: Paul Gauthier <aider@paulg.org>
Date:   Wed Jul 3 12:45:53 2024 -0300

    Lazily import litellm to shave >1sec off the initial load time of aider

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 78e16ae6..43153d2e 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -15,40 +15,49 @@ CACHE = None
 # CACHE = Cache(CACHE_PATH)
 
 
-def should_giveup(e):
-    if not hasattr(e, "status_code"):
-        return False
-
-    if type(e) in (
-        httpx.ConnectError,
-        httpx.RemoteProtocolError,
-        httpx.ReadTimeout,
-    ):
-        return False
-
-    return not litellm._should_retry(e.status_code)
-
-
-@backoff.on_exception(
-    backoff.expo,
-    (
-        httpx.ConnectError,
-        httpx.RemoteProtocolError,
-        httpx.ReadTimeout,
-        litellm.exceptions.APIConnectionError,
-        litellm.exceptions.APIError,
-        litellm.exceptions.RateLimitError,
-        litellm.exceptions.ServiceUnavailableError,
-        litellm.exceptions.Timeout,
-        litellm.llms.anthropic.AnthropicError,
-    ),
-    giveup=should_giveup,
-    max_time=60,
-    on_backoff=lambda details: print(
-        f"{details.get('exception','Exception')}\nRetry in {details['wait']:.1f} seconds."
-    ),
-)
+def lazy_litellm_retry_decorator(func):
+    def wrapper(*args, **kwargs):
+        def should_giveup(e):
+            if not hasattr(e, "status_code"):
+                return False
+
+            if type(e) in (
+                httpx.ConnectError,
+                httpx.RemoteProtocolError,
+                httpx.ReadTimeout,
+            ):
+                return False
+
+            return not litellm._should_retry(e.status_code)
+
+        decorated_func = backoff.on_exception(
+            backoff.expo,
+            (
+                httpx.ConnectError,
+                httpx.RemoteProtocolError,
+                httpx.ReadTimeout,
+                litellm.exceptions.APIConnectionError,
+                litellm.exceptions.APIError,
+                litellm.exceptions.RateLimitError,
+                litellm.exceptions.ServiceUnavailableError,
+                litellm.exceptions.Timeout,
+                litellm.llms.anthropic.AnthropicError,
+            ),
+            giveup=should_giveup,
+            max_time=60,
+            on_backoff=lambda details: print(
+                f"{details.get('exception','Exception')}\nRetry in {details['wait']:.1f} seconds."
+            ),
+        )(func)
+        return decorated_func(*args, **kwargs)
+
+    return wrapper
+
+
+@lazy_litellm_retry_decorator
 def send_with_retries(model_name, messages, functions, stream, temperature=0):
+    from aider.litellm import litellm
+
     kwargs = dict(
         model=model_name,
         messages=messages,

commit 2dc6735ab42c129d12edf9eff63abfac89a8dbba
Author: Paul Gauthier <aider@paulg.org>
Date:   Wed Jul 3 13:25:10 2024 -0300

    defer import of httpx

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 43153d2e..bb0030c3 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -2,7 +2,6 @@ import hashlib
 import json
 
 import backoff
-import httpx
 
 from aider.dump import dump  # noqa: F401
 from aider.litellm import litellm
@@ -17,6 +16,8 @@ CACHE = None
 
 def lazy_litellm_retry_decorator(func):
     def wrapper(*args, **kwargs):
+        import httpx
+
         def should_giveup(e):
             if not hasattr(e, "status_code"):
                 return False

commit 9d02628cf87c8d52e0ab5616fa7d6cefc725da35
Author: Paul Gauthier <aider@paulg.org>
Date:   Wed Jul 3 21:32:50 2024 -0300

    streamlit borks sys.path, causes import("litellm") to load our litellm.py; fix

diff --git a/aider/sendchat.py b/aider/sendchat.py
index bb0030c3..1123fe78 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -4,7 +4,7 @@ import json
 import backoff
 
 from aider.dump import dump  # noqa: F401
-from aider.litellm import litellm
+from aider.llm import litellm
 
 # from diskcache import Cache
 
@@ -57,7 +57,7 @@ def lazy_litellm_retry_decorator(func):
 
 @lazy_litellm_retry_decorator
 def send_with_retries(model_name, messages, functions, stream, temperature=0):
-    from aider.litellm import litellm
+    from aider.llm import litellm
 
     kwargs = dict(
         model=model_name,

commit cba53bfc225ea04a5acc52887f64441659200675
Author: Paul Gauthier (aider) <aider@paulg.org>
Date:   Tue Jul 30 12:23:33 2024 -0300

    Add retry support for litellm.InternalServerError

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 1123fe78..b5f05e57 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -42,6 +42,7 @@ def lazy_litellm_retry_decorator(func):
                 litellm.exceptions.RateLimitError,
                 litellm.exceptions.ServiceUnavailableError,
                 litellm.exceptions.Timeout,
+                litellm.exceptions.InternalServerError,
                 litellm.llms.anthropic.AnthropicError,
             ),
             giveup=should_giveup,

commit bcd802b6e97ac90ca882452f6714b867b7c1e64a
Author: Paul Gauthier (aider) <aider@paulg.org>
Date:   Tue Jul 30 12:23:41 2024 -0300

    Add retry support for `litellm.InternalServerError` in the `send_with_retries` function in `aider/sendchat.py`.

diff --git a/aider/sendchat.py b/aider/sendchat.py
index b5f05e57..7dfcbf14 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -48,7 +48,7 @@ def lazy_litellm_retry_decorator(func):
             giveup=should_giveup,
             max_time=60,
             on_backoff=lambda details: print(
-                f"{details.get('exception','Exception')}\nRetry in {details['wait']:.1f} seconds."
+                f"{details.get('exception', 'Exception')}\nRetry in {details['wait']:.1f} seconds."
             ),
         )(func)
         return decorated_func(*args, **kwargs)

commit 38b411a6cbb0193587482be7c347d7b3339644a4
Author: Paul Gauthier (aider) <aider@paulg.org>
Date:   Thu Aug 1 17:27:31 2024 -0300

    feat: Add extra_headers parameter to send_with_retries function

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 7dfcbf14..19a4e3a1 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -57,7 +57,7 @@ def lazy_litellm_retry_decorator(func):
 
 
 @lazy_litellm_retry_decorator
-def send_with_retries(model_name, messages, functions, stream, temperature=0):
+def send_with_retries(model_name, messages, functions, stream, temperature=0, extra_headers=None):
     from aider.llm import litellm
 
     kwargs = dict(
@@ -68,6 +68,8 @@ def send_with_retries(model_name, messages, functions, stream, temperature=0):
     )
     if functions is not None:
         kwargs["functions"] = functions
+    if extra_headers is not None:
+        kwargs["extra_headers"] = extra_headers
 
     key = json.dumps(kwargs, sort_keys=True).encode()
 

commit 5e818c2899fb8de5455665fdc6ccbf8bae14e8c5
Author: Paul Gauthier <aider@paulg.org>
Date:   Thu Aug 1 17:52:14 2024 -0300

    support 8k output with 3.5 sonnet

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 19a4e3a1..42559e0b 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -57,7 +57,9 @@ def lazy_litellm_retry_decorator(func):
 
 
 @lazy_litellm_retry_decorator
-def send_with_retries(model_name, messages, functions, stream, temperature=0, extra_headers=None):
+def send_with_retries(
+    model_name, messages, functions, stream, temperature=0, extra_headers=None, max_tokens=None
+):
     from aider.llm import litellm
 
     kwargs = dict(
@@ -70,6 +72,8 @@ def send_with_retries(model_name, messages, functions, stream, temperature=0, ex
         kwargs["functions"] = functions
     if extra_headers is not None:
         kwargs["extra_headers"] = extra_headers
+    if max_tokens is not None:
+        kwargs["max_tokens"] = max_tokens
 
     key = json.dumps(kwargs, sort_keys=True).encode()
 

commit 4a42a07237cf1db7e69d002b25ab185bd1644998
Author: Paul Gauthier <aider@paulg.org>
Date:   Thu Aug 1 18:28:41 2024 -0300

    fix: Handle empty status codes in litellm retry decorator

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 42559e0b..e3d40c23 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -29,6 +29,14 @@ def lazy_litellm_retry_decorator(func):
             ):
                 return False
 
+            # These seem to return .status_code = ""
+            # litellm._should_retry() expects an int and throws a TypeError
+            #
+            # litellm.llms.anthropic.AnthropicError
+            # litellm.exceptions.APIError
+            if not e.status_code:
+                return False
+
             return not litellm._should_retry(e.status_code)
 
         decorated_func = backoff.on_exception(

commit d619edf6e96e339c01836e88d3e10c2807fb01d4
Author: Paul Gauthier <aider@paulg.org>
Date:   Fri Aug 2 10:35:10 2024 -0300

    rename simple_send_with_retries -> send_with_retries

diff --git a/aider/sendchat.py b/aider/sendchat.py
index e3d40c23..630f45b2 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -66,7 +66,13 @@ def lazy_litellm_retry_decorator(func):
 
 @lazy_litellm_retry_decorator
 def send_with_retries(
-    model_name, messages, functions, stream, temperature=0, extra_headers=None, max_tokens=None
+    model_name,
+    messages,
+    functions=None,
+    stream=False,
+    temperature=0,
+    extra_headers=None,
+    max_tokens=None,
 ):
     from aider.llm import litellm
 
@@ -99,16 +105,3 @@ def send_with_retries(
         CACHE[key] = res
 
     return hash_object, res
-
-
-def simple_send_with_retries(model_name, messages):
-    try:
-        _hash, response = send_with_retries(
-            model_name=model_name,
-            messages=messages,
-            functions=None,
-            stream=False,
-        )
-        return response.choices[0].message.content
-    except (AttributeError, litellm.exceptions.BadRequestError):
-        return

commit da3e507ec46dd51a828e3fd7475affdb283a0654
Author: Paul Gauthier <aider@paulg.org>
Date:   Fri Aug 2 10:49:44 2024 -0300

    Revert "rename simple_send_with_retries -> send_with_retries"
    
    This reverts commit d619edf6e96e339c01836e88d3e10c2807fb01d4.

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 630f45b2..e3d40c23 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -66,13 +66,7 @@ def lazy_litellm_retry_decorator(func):
 
 @lazy_litellm_retry_decorator
 def send_with_retries(
-    model_name,
-    messages,
-    functions=None,
-    stream=False,
-    temperature=0,
-    extra_headers=None,
-    max_tokens=None,
+    model_name, messages, functions, stream, temperature=0, extra_headers=None, max_tokens=None
 ):
     from aider.llm import litellm
 
@@ -105,3 +99,16 @@ def send_with_retries(
         CACHE[key] = res
 
     return hash_object, res
+
+
+def simple_send_with_retries(model_name, messages):
+    try:
+        _hash, response = send_with_retries(
+            model_name=model_name,
+            messages=messages,
+            functions=None,
+            stream=False,
+        )
+        return response.choices[0].message.content
+    except (AttributeError, litellm.exceptions.BadRequestError):
+        return

commit 1e232d4db685d34c9a79381a2fb6262c21046d87
Author: Paul Gauthier <aider@paulg.org>
Date:   Tue Aug 6 14:32:52 2024 -0300

    Stop using litellm._should_retry

diff --git a/aider/sendchat.py b/aider/sendchat.py
index e3d40c23..d840fb47 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -18,27 +18,6 @@ def lazy_litellm_retry_decorator(func):
     def wrapper(*args, **kwargs):
         import httpx
 
-        def should_giveup(e):
-            if not hasattr(e, "status_code"):
-                return False
-
-            if type(e) in (
-                httpx.ConnectError,
-                httpx.RemoteProtocolError,
-                httpx.ReadTimeout,
-            ):
-                return False
-
-            # These seem to return .status_code = ""
-            # litellm._should_retry() expects an int and throws a TypeError
-            #
-            # litellm.llms.anthropic.AnthropicError
-            # litellm.exceptions.APIError
-            if not e.status_code:
-                return False
-
-            return not litellm._should_retry(e.status_code)
-
         decorated_func = backoff.on_exception(
             backoff.expo,
             (
@@ -53,7 +32,6 @@ def lazy_litellm_retry_decorator(func):
                 litellm.exceptions.InternalServerError,
                 litellm.llms.anthropic.AnthropicError,
             ),
-            giveup=should_giveup,
             max_time=60,
             on_backoff=lambda details: print(
                 f"{details.get('exception', 'Exception')}\nRetry in {details['wait']:.1f} seconds."

commit 47295a154566123174137ce4c95e0a60138ebcf6
Author: Paul Gauthier <aider@paulg.org>
Date:   Wed Aug 7 07:37:16 2024 -0300

    wip

diff --git a/aider/sendchat.py b/aider/sendchat.py
index d840fb47..58b85f1d 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -55,7 +55,7 @@ def send_with_retries(
         stream=stream,
     )
     if functions is not None:
-        kwargs["functions"] = functions
+        kwargs["tools"] = [dict(type="functions", function=functions[0])]
     if extra_headers is not None:
         kwargs["extra_headers"] = extra_headers
     if max_tokens is not None:

commit 1ecc780f740ff24dedecaafc5fdd937f8b8e89e8
Author: Paul Gauthier <aider@paulg.org>
Date:   Wed Aug 7 11:29:31 2024 -0300

    Revert "Stop using litellm._should_retry"
    
    This reverts commit 1e232d4db685d34c9a79381a2fb6262c21046d87.

diff --git a/aider/sendchat.py b/aider/sendchat.py
index d840fb47..e3d40c23 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -18,6 +18,27 @@ def lazy_litellm_retry_decorator(func):
     def wrapper(*args, **kwargs):
         import httpx
 
+        def should_giveup(e):
+            if not hasattr(e, "status_code"):
+                return False
+
+            if type(e) in (
+                httpx.ConnectError,
+                httpx.RemoteProtocolError,
+                httpx.ReadTimeout,
+            ):
+                return False
+
+            # These seem to return .status_code = ""
+            # litellm._should_retry() expects an int and throws a TypeError
+            #
+            # litellm.llms.anthropic.AnthropicError
+            # litellm.exceptions.APIError
+            if not e.status_code:
+                return False
+
+            return not litellm._should_retry(e.status_code)
+
         decorated_func = backoff.on_exception(
             backoff.expo,
             (
@@ -32,6 +53,7 @@ def lazy_litellm_retry_decorator(func):
                 litellm.exceptions.InternalServerError,
                 litellm.llms.anthropic.AnthropicError,
             ),
+            giveup=should_giveup,
             max_time=60,
             on_backoff=lambda details: print(
                 f"{details.get('exception', 'Exception')}\nRetry in {details['wait']:.1f} seconds."

commit 3d66aea572234059d128c971df63d3aab41125ca
Author: Paul Gauthier <aider@paulg.org>
Date:   Wed Aug 7 11:30:43 2024 -0300

    retry sends in most cases

diff --git a/aider/sendchat.py b/aider/sendchat.py
index e3d40c23..c1ccbbe0 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -26,6 +26,13 @@ def lazy_litellm_retry_decorator(func):
                 httpx.ConnectError,
                 httpx.RemoteProtocolError,
                 httpx.ReadTimeout,
+                litellm.exceptions.APIConnectionError,
+                litellm.exceptions.APIError,
+                litellm.exceptions.RateLimitError,
+                litellm.exceptions.ServiceUnavailableError,
+                litellm.exceptions.Timeout,
+                litellm.exceptions.InternalServerError,
+                litellm.llms.anthropic.AnthropicError,
             ):
                 return False
 

commit 3f6ae4b2d9d9036b054b222d858ae67cb40edb25
Author: Paul Gauthier <aider@paulg.org>
Date:   Thu Aug 8 14:54:59 2024 -0300

    Handle retries at a higher level; exceptions come out of the streaming completion object

diff --git a/aider/sendchat.py b/aider/sendchat.py
index c1ccbbe0..e767e29c 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -14,53 +14,28 @@ CACHE = None
 # CACHE = Cache(CACHE_PATH)
 
 
+def retry_exceptions():
+    import httpx
+
+    return (
+        httpx.ConnectError,
+        httpx.RemoteProtocolError,
+        httpx.ReadTimeout,
+        litellm.exceptions.APIConnectionError,
+        litellm.exceptions.APIError,
+        litellm.exceptions.RateLimitError,
+        litellm.exceptions.ServiceUnavailableError,
+        litellm.exceptions.Timeout,
+        litellm.exceptions.InternalServerError,
+        litellm.llms.anthropic.AnthropicError,
+    )
+
+
 def lazy_litellm_retry_decorator(func):
     def wrapper(*args, **kwargs):
-        import httpx
-
-        def should_giveup(e):
-            if not hasattr(e, "status_code"):
-                return False
-
-            if type(e) in (
-                httpx.ConnectError,
-                httpx.RemoteProtocolError,
-                httpx.ReadTimeout,
-                litellm.exceptions.APIConnectionError,
-                litellm.exceptions.APIError,
-                litellm.exceptions.RateLimitError,
-                litellm.exceptions.ServiceUnavailableError,
-                litellm.exceptions.Timeout,
-                litellm.exceptions.InternalServerError,
-                litellm.llms.anthropic.AnthropicError,
-            ):
-                return False
-
-            # These seem to return .status_code = ""
-            # litellm._should_retry() expects an int and throws a TypeError
-            #
-            # litellm.llms.anthropic.AnthropicError
-            # litellm.exceptions.APIError
-            if not e.status_code:
-                return False
-
-            return not litellm._should_retry(e.status_code)
-
         decorated_func = backoff.on_exception(
             backoff.expo,
-            (
-                httpx.ConnectError,
-                httpx.RemoteProtocolError,
-                httpx.ReadTimeout,
-                litellm.exceptions.APIConnectionError,
-                litellm.exceptions.APIError,
-                litellm.exceptions.RateLimitError,
-                litellm.exceptions.ServiceUnavailableError,
-                litellm.exceptions.Timeout,
-                litellm.exceptions.InternalServerError,
-                litellm.llms.anthropic.AnthropicError,
-            ),
-            giveup=should_giveup,
+            retry_exceptions(),
             max_time=60,
             on_backoff=lambda details: print(
                 f"{details.get('exception', 'Exception')}\nRetry in {details['wait']:.1f} seconds."
@@ -71,8 +46,7 @@ def lazy_litellm_retry_decorator(func):
     return wrapper
 
 
-@lazy_litellm_retry_decorator
-def send_with_retries(
+def send_completion(
     model_name, messages, functions, stream, temperature=0, extra_headers=None, max_tokens=None
 ):
     from aider.llm import litellm
@@ -108,9 +82,10 @@ def send_with_retries(
     return hash_object, res
 
 
+@lazy_litellm_retry_decorator
 def simple_send_with_retries(model_name, messages):
     try:
-        _hash, response = send_with_retries(
+        _hash, response = send_completion(
             model_name=model_name,
             messages=messages,
             functions=None,

commit 7822c1c879a4401b22d4c44e5ea458b3609c6e07
Author: Paul Gauthier (aider) <aider@paulg.org>
Date:   Mon Aug 12 15:04:05 2024 -0700

    feat: Add support for DeepSeek API base URL

diff --git a/aider/sendchat.py b/aider/sendchat.py
index e767e29c..7e12e36c 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -1,5 +1,6 @@
 import hashlib
 import json
+import os
 
 import backoff
 
@@ -57,6 +58,9 @@ def send_completion(
         temperature=temperature,
         stream=stream,
     )
+    
+    if model_name.startswith("deepseek/") and "DEEPSEEK_API_BASE" in os.environ:
+        kwargs["base_url"] = os.environ["DEEPSEEK_API_BASE"]
     if functions is not None:
         kwargs["functions"] = functions
     if extra_headers is not None:

commit 2669b0c758fce89f4c90939523bb6d71e93eddca
Author: Paul Gauthier (aider) <aider@paulg.org>
Date:   Mon Aug 12 15:04:08 2024 -0700

    style: Apply linter edits to sendchat.py

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 7e12e36c..5c0977c1 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -58,7 +58,7 @@ def send_completion(
         temperature=temperature,
         stream=stream,
     )
-    
+
     if model_name.startswith("deepseek/") and "DEEPSEEK_API_BASE" in os.environ:
         kwargs["base_url"] = os.environ["DEEPSEEK_API_BASE"]
     if functions is not None:

commit 485418d917cbf8a379f638be05c68c19935bc076
Author: Paul Gauthier (aider) <aider@paulg.org>
Date:   Mon Aug 12 15:06:55 2024 -0700

    feat: Add --deepseek-beta bool arg to use DeepSeek Coder via the beta API endpoint

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 5c0977c1..06505910 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -59,8 +59,11 @@ def send_completion(
         stream=stream,
     )
 
-    if model_name.startswith("deepseek/") and "DEEPSEEK_API_BASE" in os.environ:
-        kwargs["base_url"] = os.environ["DEEPSEEK_API_BASE"]
+    if model_name.startswith("deepseek/"):
+        if "DEEPSEEK_API_BASE" in os.environ:
+            kwargs["base_url"] = os.environ["DEEPSEEK_API_BASE"]
+        elif getattr(kwargs.get('extra_headers', {}), 'deepseek_beta', False):
+            kwargs["base_url"] = "https://api.deepseek.com/v1"
     if functions is not None:
         kwargs["functions"] = functions
     if extra_headers is not None:

commit 2a1fb7d1508d380d6ba1bcc5fc6b61bd92b56499
Author: Paul Gauthier <aider@paulg.org>
Date:   Mon Aug 12 15:35:32 2024 -0700

    Clean up DEEPSEEK_API_BASE

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 06505910..29ba668c 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -1,6 +1,5 @@
 import hashlib
 import json
-import os
 
 import backoff
 
@@ -59,11 +58,6 @@ def send_completion(
         stream=stream,
     )
 
-    if model_name.startswith("deepseek/"):
-        if "DEEPSEEK_API_BASE" in os.environ:
-            kwargs["base_url"] = os.environ["DEEPSEEK_API_BASE"]
-        elif getattr(kwargs.get('extra_headers', {}), 'deepseek_beta', False):
-            kwargs["base_url"] = "https://api.deepseek.com/v1"
     if functions is not None:
         kwargs["functions"] = functions
     if extra_headers is not None:

commit e1b83ba6b5aedcd83d9604d5f24bcdadccdfc2aa
Merge: 47295a15 8115cbbd
Author: Paul Gauthier <aider@paulg.org>
Date:   Tue Aug 13 17:03:30 2024 -0700

    Merge branch 'main' into json-coders

diff --cc aider/sendchat.py
index 58b85f1d,29ba668c..16e296eb
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@@ -54,8 -57,9 +57,9 @@@ def send_completion
          temperature=temperature,
          stream=stream,
      )
+ 
      if functions is not None:
 -        kwargs["functions"] = functions
 +        kwargs["tools"] = [dict(type="functions", function=functions[0])]
      if extra_headers is not None:
          kwargs["extra_headers"] = extra_headers
      if max_tokens is not None:

commit 675263623ddd23144f7253e7adfdd1ac5549293a
Author: Paul Gauthier <aider@paulg.org>
Date:   Wed Aug 14 11:14:37 2024 -0700

    use strict for new gpt4o

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 16e296eb..e45444ef 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -59,7 +59,7 @@ def send_completion(
     )
 
     if functions is not None:
-        kwargs["tools"] = [dict(type="functions", function=functions[0])]
+        kwargs["tools"] = [dict(type="function", function=functions[0])]
     if extra_headers is not None:
         kwargs["extra_headers"] = extra_headers
     if max_tokens is not None:

commit 3996c4a7d5fd1e7ffbfd5af02d07a60dbbcb2fb7
Author: Paul Gauthier <aider@paulg.org>
Date:   Wed Aug 14 11:21:36 2024 -0700

    force tool use

diff --git a/aider/sendchat.py b/aider/sendchat.py
index e45444ef..1914a618 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -59,7 +59,9 @@ def send_completion(
     )
 
     if functions is not None:
-        kwargs["tools"] = [dict(type="function", function=functions[0])]
+        function = functions[0]
+        kwargs["tools"] = [dict(type="function", function=function)]
+        kwargs["tool_choice"] = {"type": "function", "function": {"name": function["name"]}}
     if extra_headers is not None:
         kwargs["extra_headers"] = extra_headers
     if max_tokens is not None:

commit e81ddcc1a6624bd68a3d419b3a18f39957bc1869
Author: Paul Gauthier (aider) <aider@paulg.org>
Date:   Fri Aug 23 14:17:44 2024 -0700

    feat: Add extra_headers parameter to simple_send_with_retries

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 1914a618..e6ab1dc5 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -86,13 +86,14 @@ def send_completion(
 
 
 @lazy_litellm_retry_decorator
-def simple_send_with_retries(model_name, messages):
+def simple_send_with_retries(model_name, messages, extra_headers=None):
     try:
         _hash, response = send_completion(
             model_name=model_name,
             messages=messages,
             functions=None,
             stream=False,
+            extra_headers=extra_headers,
         )
         return response.choices[0].message.content
     except (AttributeError, litellm.exceptions.BadRequestError):

commit 5ded503d2b5eab34b8b22d869fb743f8233120db
Author: Paul Gauthier (aider) <aider@paulg.org>
Date:   Fri Aug 23 14:20:15 2024 -0700

    fix: Only include extra_headers in send_completion if not None

diff --git a/aider/sendchat.py b/aider/sendchat.py
index e6ab1dc5..38c76fb4 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -88,13 +88,16 @@ def send_completion(
 @lazy_litellm_retry_decorator
 def simple_send_with_retries(model_name, messages, extra_headers=None):
     try:
-        _hash, response = send_completion(
-            model_name=model_name,
-            messages=messages,
-            functions=None,
-            stream=False,
-            extra_headers=extra_headers,
-        )
+        kwargs = {
+            "model_name": model_name,
+            "messages": messages,
+            "functions": None,
+            "stream": False,
+        }
+        if extra_headers is not None:
+            kwargs["extra_headers"] = extra_headers
+        
+        _hash, response = send_completion(**kwargs)
         return response.choices[0].message.content
     except (AttributeError, litellm.exceptions.BadRequestError):
         return

commit 2906dcb642bf02fb35026c154ff12e1fcebae591
Author: Paul Gauthier (aider) <aider@paulg.org>
Date:   Fri Aug 23 14:20:18 2024 -0700

    style: Fix formatting in sendchat.py

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 38c76fb4..29bfca98 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -96,7 +96,7 @@ def simple_send_with_retries(model_name, messages, extra_headers=None):
         }
         if extra_headers is not None:
             kwargs["extra_headers"] = extra_headers
-        
+
         _hash, response = send_completion(**kwargs)
         return response.choices[0].message.content
     except (AttributeError, litellm.exceptions.BadRequestError):

commit 97a70830e94c1a82ee803bbea196130aadb1f0f0
Author: Paul Gauthier <aider@paulg.org>
Date:   Mon Aug 26 15:49:48 2024 -0700

    cleanup

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 29bfca98..7301a602 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -47,7 +47,13 @@ def lazy_litellm_retry_decorator(func):
 
 
 def send_completion(
-    model_name, messages, functions, stream, temperature=0, extra_headers=None, max_tokens=None
+    model_name,
+    messages,
+    functions,
+    stream,
+    temperature=0,
+    extra_headers=None,
+    max_tokens=None,
 ):
     from aider.llm import litellm
 

commit 291b456a45b848479098a79b90c901c68d2b986d
Author: Paul Gauthier <aider@paulg.org>
Date:   Thu Sep 12 13:05:25 2024 -0700

    hack for o1-mini: no system prompt, no temperature

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 7301a602..af3d126e 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -60,7 +60,7 @@ def send_completion(
     kwargs = dict(
         model=model_name,
         messages=messages,
-        temperature=temperature,
+        # temperature=temperature,
         stream=stream,
     )
 

commit 1755d2e0f45067e9df7f3e9a10b1920184c61c88
Author: Paul Gauthier <aider@paulg.org>
Date:   Thu Sep 12 14:24:21 2024 -0700

    fix: Use temperature setting from model configuration

diff --git a/aider/sendchat.py b/aider/sendchat.py
index af3d126e..55c64b2f 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -60,9 +60,10 @@ def send_completion(
     kwargs = dict(
         model=model_name,
         messages=messages,
-        # temperature=temperature,
         stream=stream,
     )
+    if temperature is not None:
+        kwargs["temperature"] = temperature
 
     if functions is not None:
         function = functions[0]

commit 2ca093fb8406f0d1383ff655a9afce2d53cb7cf2
Author: Paul Gauthier <aider@paulg.org>
Date:   Sat Sep 21 11:04:48 2024 -0700

    Bumping all dependencies

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 55c64b2f..1ac34f9a 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -27,7 +27,7 @@ def retry_exceptions():
         litellm.exceptions.ServiceUnavailableError,
         litellm.exceptions.Timeout,
         litellm.exceptions.InternalServerError,
-        litellm.llms.anthropic.AnthropicError,
+        litellm.llms.anthropic.chat.AnthropicError,
     )
 
 

commit d0bce02c008425175379809fb22239ee10469fdf
Author: hypn4 <khs951211@gmail.com>
Date:   Thu Sep 19 16:59:05 2024 +0900

    feat: add `extra_body`field and use in model settings.
    
    resolved: #1583
    
    The `extra_body` field is a parameter used by the `openai` provider.
    
    Since `litellm` also uses this field to additionally transmit `request body`, I added a function so that `aider` can also utilize the `extra_body` field.
    
    The `openrouter` provider also supports various functions through the additional field of `request body`, so we added the function.
    
    The following is how to use it in model settings.
    ```yaml
    # .aider.model.settings.yml
    - name: "openrouter/<YOUR_MODEL>"
      edit_format: "whole"
      use_repo_map: true
      extra_body:
        provider:
          order:
          - Azure
          allow_fallbacks: false
    ```

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 1ac34f9a..d651e590 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -53,6 +53,7 @@ def send_completion(
     stream,
     temperature=0,
     extra_headers=None,
+    extra_body=None,
     max_tokens=None,
 ):
     from aider.llm import litellm
@@ -71,6 +72,8 @@ def send_completion(
         kwargs["tool_choice"] = {"type": "function", "function": {"name": function["name"]}}
     if extra_headers is not None:
         kwargs["extra_headers"] = extra_headers
+    if extra_body is not None:
+        kwargs["extra_body"] = extra_body
     if max_tokens is not None:
         kwargs["max_tokens"] = max_tokens
 
@@ -103,6 +106,8 @@ def simple_send_with_retries(model_name, messages, extra_headers=None):
         }
         if extra_headers is not None:
             kwargs["extra_headers"] = extra_headers
+        if extra_body is not None:
+            kwargs["extra_body"] = extra_body
 
         _hash, response = send_completion(**kwargs)
         return response.choices[0].message.content

commit 6dc846d41ba6dbc42ce0e56fb86544f807b9ebc3
Author: hypn4 <khs951211@gmail.com>
Date:   Sat Sep 21 05:23:38 2024 +0900

    fix: added missing parameters.
    
    added missing parameters in `simple_send_with_retries` function.

diff --git a/aider/sendchat.py b/aider/sendchat.py
index d651e590..6678b5ed 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -96,7 +96,7 @@ def send_completion(
 
 
 @lazy_litellm_retry_decorator
-def simple_send_with_retries(model_name, messages, extra_headers=None):
+def simple_send_with_retries(model_name, messages, extra_headers=None, extra_body=None):
     try:
         kwargs = {
             "model_name": model_name,

commit 74f615bbb4447cd3dcfeded5848bb515104fe82a
Author: Paul Gauthier (aider) <aider@paulg.org>
Date:   Fri Sep 27 13:02:44 2024 -0700

    feat: Consolidate extra parameters in sendchat.py

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 6678b5ed..fd581898 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -52,9 +52,7 @@ def send_completion(
     functions,
     stream,
     temperature=0,
-    extra_headers=None,
-    extra_body=None,
-    max_tokens=None,
+    extra_params=None,
 ):
     from aider.llm import litellm
 
@@ -70,12 +68,9 @@ def send_completion(
         function = functions[0]
         kwargs["tools"] = [dict(type="function", function=function)]
         kwargs["tool_choice"] = {"type": "function", "function": {"name": function["name"]}}
-    if extra_headers is not None:
-        kwargs["extra_headers"] = extra_headers
-    if extra_body is not None:
-        kwargs["extra_body"] = extra_body
-    if max_tokens is not None:
-        kwargs["max_tokens"] = max_tokens
+    
+    if extra_params is not None:
+        kwargs.update(extra_params)
 
     key = json.dumps(kwargs, sort_keys=True).encode()
 
@@ -85,8 +80,6 @@ def send_completion(
     if not stream and CACHE is not None and key in CACHE:
         return hash_object, CACHE[key]
 
-    # del kwargs['stream']
-
     res = litellm.completion(**kwargs)
 
     if not stream and CACHE is not None:
@@ -96,7 +89,7 @@ def send_completion(
 
 
 @lazy_litellm_retry_decorator
-def simple_send_with_retries(model_name, messages, extra_headers=None, extra_body=None):
+def simple_send_with_retries(model_name, messages, extra_params=None):
     try:
         kwargs = {
             "model_name": model_name,
@@ -104,10 +97,8 @@ def simple_send_with_retries(model_name, messages, extra_headers=None, extra_bod
             "functions": None,
             "stream": False,
         }
-        if extra_headers is not None:
-            kwargs["extra_headers"] = extra_headers
-        if extra_body is not None:
-            kwargs["extra_body"] = extra_body
+        if extra_params is not None:
+            kwargs["extra_params"] = extra_params
 
         _hash, response = send_completion(**kwargs)
         return response.choices[0].message.content

commit c24e947b18c40f43a25cb281dde1f51f989119c0
Author: Paul Gauthier (aider) <aider@paulg.org>
Date:   Fri Sep 27 13:02:47 2024 -0700

    style: Run linter

diff --git a/aider/sendchat.py b/aider/sendchat.py
index fd581898..14efce94 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -68,7 +68,7 @@ def send_completion(
         function = functions[0]
         kwargs["tools"] = [dict(type="function", function=function)]
         kwargs["tool_choice"] = {"type": "function", "function": {"name": function["name"]}}
-    
+
     if extra_params is not None:
         kwargs.update(extra_params)
 

commit 810aeccf94df91158e751380b39a6e07917a096f
Author: Paul Gauthier <aider@paulg.org>
Date:   Fri Sep 27 13:09:43 2024 -0700

    fix: Replace extra_headers and extra_body with extra_params in Coder, ChatSummary, and GitRepo

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 14efce94..0fb9406c 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -96,9 +96,8 @@ def simple_send_with_retries(model_name, messages, extra_params=None):
             "messages": messages,
             "functions": None,
             "stream": False,
+            "extra_params": extra_params,
         }
-        if extra_params is not None:
-            kwargs["extra_params"] = extra_params
 
         _hash, response = send_completion(**kwargs)
         return response.choices[0].message.content

commit 6bb9b2567f9fc35b72358ff2c763a97b57e02d26
Author: Paul Gauthier <aider@paulg.org>
Date:   Tue Oct 15 12:25:05 2024 -0700

    refactor: Centralize retry timeout and use consistent value

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 0fb9406c..262fab20 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -13,6 +13,8 @@ CACHE_PATH = "~/.aider.send.cache.v1"
 CACHE = None
 # CACHE = Cache(CACHE_PATH)
 
+RETRY_TIMEOUT = 60
+
 
 def retry_exceptions():
     import httpx
@@ -36,7 +38,7 @@ def lazy_litellm_retry_decorator(func):
         decorated_func = backoff.on_exception(
             backoff.expo,
             retry_exceptions(),
-            max_time=60,
+            max_time=RETRY_TIMEOUT,
             on_backoff=lambda details: print(
                 f"{details.get('exception', 'Exception')}\nRetry in {details['wait']:.1f} seconds."
             ),

commit 29293cc8acaf7929f4d39efe6220e9985f8d63f6
Author: Paul Gauthier <aider@paulg.org>
Date:   Fri Oct 25 07:07:36 2024 -0700

    fix: update import path for AnthropicError in retry_exceptions

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 262fab20..2b9615c1 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -29,7 +29,7 @@ def retry_exceptions():
         litellm.exceptions.ServiceUnavailableError,
         litellm.exceptions.Timeout,
         litellm.exceptions.InternalServerError,
-        litellm.llms.anthropic.chat.AnthropicError,
+        litellm.llms.anthropic.common_utils.AnthropicError,
     )
 
 

commit be74259df6b0cd0150351787a4b9e3fdc22c8ffd
Author: Paul Gauthier <aider@paulg.org>
Date:   Fri Oct 25 07:31:05 2024 -0700

    fix: add missing AnthropicError exception to retry list

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 2b9615c1..daa0f22a 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -29,7 +29,10 @@ def retry_exceptions():
         litellm.exceptions.ServiceUnavailableError,
         litellm.exceptions.Timeout,
         litellm.exceptions.InternalServerError,
+        # These are apparently different?
+        # https://github.com/search?q=repo%3ABerriAI%2Flitellm%20AnthropicError&type=code
         litellm.llms.anthropic.common_utils.AnthropicError,
+        litellm.llms.anthropic.completion.AnthropicError,
     )
 
 

commit e2dff0a74b498ec73daeb80124ad08a1f12e1451
Author: Paul Gauthier <aider@paulg.org>
Date:   Fri Oct 25 15:47:30 2024 -0700

    #2120

diff --git a/aider/sendchat.py b/aider/sendchat.py
index daa0f22a..8420c929 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -20,19 +20,24 @@ def retry_exceptions():
     import httpx
 
     return (
+        # httpx
         httpx.ConnectError,
         httpx.RemoteProtocolError,
         httpx.ReadTimeout,
+        # litellm
+        litellm.exceptions.BadRequestError,
+        litellm.exceptions.AuthenticationError,
+        litellm.exceptions.PermissionDeniedError,
+        litellm.exceptions.NotFoundError,
+        litellm.exceptions.UnprocessableEntityError,
+        litellm.exceptions.RateLimitError,
+        litellm.exceptions.InternalServerError,
+        litellm.exceptions.ContextWindowExceededError,
+        litellm.exceptions.ContentPolicyViolationError,
         litellm.exceptions.APIConnectionError,
         litellm.exceptions.APIError,
-        litellm.exceptions.RateLimitError,
         litellm.exceptions.ServiceUnavailableError,
         litellm.exceptions.Timeout,
-        litellm.exceptions.InternalServerError,
-        # These are apparently different?
-        # https://github.com/search?q=repo%3ABerriAI%2Flitellm%20AnthropicError&type=code
-        litellm.llms.anthropic.common_utils.AnthropicError,
-        litellm.llms.anthropic.completion.AnthropicError,
     )
 
 

commit bf63e7045b1f0f0af80df59d09efedf849cff72d
Author: Paul Gauthier <aider@paulg.org>
Date:   Mon Oct 28 14:27:19 2024 -0700

    refactor: simplify litellm exception imports

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 8420c929..02494af9 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -15,7 +15,7 @@ CACHE = None
 
 RETRY_TIMEOUT = 60
 
-
+#ai
 def retry_exceptions():
     import httpx
 
@@ -25,19 +25,18 @@ def retry_exceptions():
         httpx.RemoteProtocolError,
         httpx.ReadTimeout,
         # litellm
-        litellm.exceptions.BadRequestError,
-        litellm.exceptions.AuthenticationError,
-        litellm.exceptions.PermissionDeniedError,
-        litellm.exceptions.NotFoundError,
-        litellm.exceptions.UnprocessableEntityError,
-        litellm.exceptions.RateLimitError,
-        litellm.exceptions.InternalServerError,
-        litellm.exceptions.ContextWindowExceededError,
-        litellm.exceptions.ContentPolicyViolationError,
-        litellm.exceptions.APIConnectionError,
-        litellm.exceptions.APIError,
-        litellm.exceptions.ServiceUnavailableError,
-        litellm.exceptions.Timeout,
+        litellm.AuthenticationError,
+        litellm.PermissionDeniedError,
+        litellm.NotFoundError,
+        litellm.UnprocessableEntityError,
+        litellm.RateLimitError,
+        litellm.InternalServerError,
+        litellm.ContextWindowExceededError,
+        litellm.ContentPolicyViolationError,
+        litellm.APIConnectionError,
+        litellm.APIError,
+        litellm.ServiceUnavailableError,
+        litellm.Timeout,
     )
 
 
@@ -111,5 +110,5 @@ def simple_send_with_retries(model_name, messages, extra_params=None):
 
         _hash, response = send_completion(**kwargs)
         return response.choices[0].message.content
-    except (AttributeError, litellm.exceptions.BadRequestError):
+    except (AttributeError, litellm.BadRequestError):
         return

commit 3d66b5379195043460ab90cce6c4a35a46554044
Author: Paul Gauthier (aider) <aider@paulg.org>
Date:   Mon Oct 28 14:27:20 2024 -0700

    test: add basic test for retry_exceptions function

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 02494af9..d0baf55e 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -15,7 +15,6 @@ CACHE = None
 
 RETRY_TIMEOUT = 60
 
-#ai
 def retry_exceptions():
     import httpx
 

commit cd133f95ee1ba033970fa7df2f1b9006f2b1d824
Author: Paul Gauthier (aider) <aider@paulg.org>
Date:   Mon Oct 28 14:27:26 2024 -0700

    style: fix linting issues with whitespace and line breaks

diff --git a/aider/sendchat.py b/aider/sendchat.py
index d0baf55e..1a27c1a2 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -15,6 +15,7 @@ CACHE = None
 
 RETRY_TIMEOUT = 60
 
+
 def retry_exceptions():
     import httpx
 

commit 8e2a4b47d643c7f74c0076c38f75cffac1d0e55e
Author: Paul Gauthier <aider@paulg.org>
Date:   Mon Oct 28 14:29:42 2024 -0700

    fix: update litellm exception imports and error handling

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 1a27c1a2..f860f232 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -25,18 +25,18 @@ def retry_exceptions():
         httpx.RemoteProtocolError,
         httpx.ReadTimeout,
         # litellm
-        litellm.AuthenticationError,
-        litellm.PermissionDeniedError,
-        litellm.NotFoundError,
-        litellm.UnprocessableEntityError,
-        litellm.RateLimitError,
-        litellm.InternalServerError,
-        litellm.ContextWindowExceededError,
-        litellm.ContentPolicyViolationError,
-        litellm.APIConnectionError,
-        litellm.APIError,
-        litellm.ServiceUnavailableError,
-        litellm.Timeout,
+        litellm.exceptions.AuthenticationError,
+        litellm.exceptions.PermissionDeniedError,
+        litellm.exceptions.NotFoundError,
+        litellm.exceptions.UnprocessableEntityError,
+        litellm.exceptions.RateLimitError,
+        litellm.exceptions.InternalServerError,
+        litellm.exceptions.ContextWindowExceededError,
+        litellm.exceptions.ContentPolicyViolationError,
+        litellm.exceptions.APIConnectionError,
+        litellm.exceptions.APIError,
+        litellm.exceptions.ServiceUnavailableError,
+        litellm.exceptions.Timeout,
     )
 
 
@@ -110,5 +110,5 @@ def simple_send_with_retries(model_name, messages, extra_params=None):
 
         _hash, response = send_completion(**kwargs)
         return response.choices[0].message.content
-    except (AttributeError, litellm.BadRequestError):
+    except AttributeError:
         return

commit 54d55c857bc0b194702d47cd5e8d40e12ab92e39
Author: Paul Gauthier <aider@paulg.org>
Date:   Mon Oct 28 14:40:42 2024 -0700

    refactor: update retry exceptions to use openai instead of litellm

diff --git a/aider/sendchat.py b/aider/sendchat.py
index f860f232..3ad22e74 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -18,25 +18,32 @@ RETRY_TIMEOUT = 60
 
 def retry_exceptions():
     import httpx
+    import openai
 
     return (
         # httpx
         httpx.ConnectError,
         httpx.RemoteProtocolError,
         httpx.ReadTimeout,
-        # litellm
-        litellm.exceptions.AuthenticationError,
-        litellm.exceptions.PermissionDeniedError,
-        litellm.exceptions.NotFoundError,
-        litellm.exceptions.UnprocessableEntityError,
-        litellm.exceptions.RateLimitError,
-        litellm.exceptions.InternalServerError,
-        litellm.exceptions.ContextWindowExceededError,
-        litellm.exceptions.ContentPolicyViolationError,
-        litellm.exceptions.APIConnectionError,
-        litellm.exceptions.APIError,
-        litellm.exceptions.ServiceUnavailableError,
-        litellm.exceptions.Timeout,
+        #
+        # litellm exceptions inherit from openai exceptions
+        # https://docs.litellm.ai/docs/exception_mapping
+        #
+        # openai.BadRequestError,
+        # litellm.ContextWindowExceededError,
+        # litellm.ContentPolicyViolationError,
+        #
+        # openai.AuthenticationError,
+        # openai.PermissionDeniedError,
+        # openai.NotFoundError,
+        #
+        openai.APITimeoutError,
+        openai.UnprocessableEntityError,
+        openai.RateLimitError,
+        openai.APIConnectionError,
+        openai.APIError,
+        openai.APIStatusError,
+        openai.InternalServerError,
     )
 
 
@@ -63,8 +70,6 @@ def send_completion(
     temperature=0,
     extra_params=None,
 ):
-    from aider.llm import litellm
-
     kwargs = dict(
         model=model_name,
         messages=messages,

commit f9c45432e6a81657642b4a61d41d5785aa367410
Author: Paul Gauthier <aider@paulg.org>
Date:   Mon Oct 28 15:05:06 2024 -0700

    refactor: Move retry logic from base_coder to sendchat module

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 3ad22e74..2c796e54 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -102,7 +102,7 @@ def send_completion(
     return hash_object, res
 
 
-@lazy_litellm_retry_decorator
+# ai: in this function!
 def simple_send_with_retries(model_name, messages, extra_params=None):
     try:
         kwargs = {

commit bc515cf74a5d9bb1f205d0dbfd9d9ab56017999a
Author: Paul Gauthier (aider) <aider@paulg.org>
Date:   Mon Oct 28 15:05:07 2024 -0700

    refactor: add retry loop to simple_send_with_retries function

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 2c796e54..86a06540 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -1,5 +1,6 @@
 import hashlib
 import json
+import time
 
 import backoff
 
@@ -102,18 +103,27 @@ def send_completion(
     return hash_object, res
 
 
-# ai: in this function!
 def simple_send_with_retries(model_name, messages, extra_params=None):
-    try:
-        kwargs = {
-            "model_name": model_name,
-            "messages": messages,
-            "functions": None,
-            "stream": False,
-            "extra_params": extra_params,
-        }
-
-        _hash, response = send_completion(**kwargs)
-        return response.choices[0].message.content
-    except AttributeError:
-        return
+    retry_delay = 0.125
+    while True:
+        try:
+            kwargs = {
+                "model_name": model_name,
+                "messages": messages,
+                "functions": None,
+                "stream": False,
+                "extra_params": extra_params,
+            }
+
+            _hash, response = send_completion(**kwargs)
+            return response.choices[0].message.content
+        except retry_exceptions() as err:
+            print(str(err))
+            retry_delay *= 2
+            if retry_delay > RETRY_TIMEOUT:
+                break
+            print(f"Retrying in {retry_delay:.1f} seconds...")
+            time.sleep(retry_delay)
+            continue
+        except AttributeError:
+            return

commit 3baad86afd6f25d5d00b278f67f8e57dc57bf3a6
Author: Paul Gauthier (aider) <aider@paulg.org>
Date:   Mon Oct 28 15:09:22 2024 -0700

    refactor: consolidate error and retry messages into single print statement

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 86a06540..0068d644 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -118,11 +118,10 @@ def simple_send_with_retries(model_name, messages, extra_params=None):
             _hash, response = send_completion(**kwargs)
             return response.choices[0].message.content
         except retry_exceptions() as err:
-            print(str(err))
             retry_delay *= 2
             if retry_delay > RETRY_TIMEOUT:
                 break
-            print(f"Retrying in {retry_delay:.1f} seconds...")
+            print(f"{str(err)}\nRetrying in {retry_delay:.1f} seconds...")
             time.sleep(retry_delay)
             continue
         except AttributeError:

commit 907c1dbe2b528427ddca481280c66e80308a3fdf
Author: Paul Gauthier <aider@paulg.org>
Date:   Mon Oct 28 15:10:27 2024 -0700

    refactor: split error and retry messages in simple_send_with_retries

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 0068d644..86a06540 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -118,10 +118,11 @@ def simple_send_with_retries(model_name, messages, extra_params=None):
             _hash, response = send_completion(**kwargs)
             return response.choices[0].message.content
         except retry_exceptions() as err:
+            print(str(err))
             retry_delay *= 2
             if retry_delay > RETRY_TIMEOUT:
                 break
-            print(f"{str(err)}\nRetrying in {retry_delay:.1f} seconds...")
+            print(f"Retrying in {retry_delay:.1f} seconds...")
             time.sleep(retry_delay)
             continue
         except AttributeError:

commit 17330e53c3d61e52196a031693c30888f5a03573
Author: Paul Gauthier <aider@paulg.org>
Date:   Thu Oct 31 14:13:36 2024 -0700

    refactor: Improve error handling and URL processing in chat functionality

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 86a06540..e82e0d8f 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -42,8 +42,8 @@ def retry_exceptions():
         openai.UnprocessableEntityError,
         openai.RateLimitError,
         openai.APIConnectionError,
-        openai.APIError,
-        openai.APIStatusError,
+        # openai.APIError,
+        # openai.APIStatusError,
         openai.InternalServerError,
     )
 

commit 816fd5e65cc8657c219291cc5aadc6c80cca0a5a
Author: Paul Gauthier <aider@paulg.org>
Date:   Thu Nov 7 13:02:04 2024 -0800

    refactor: Simplify error handling and remove unused retry exceptions code

diff --git a/aider/sendchat.py b/aider/sendchat.py
index e82e0d8f..8c63ff83 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -5,6 +5,7 @@ import time
 import backoff
 
 from aider.dump import dump  # noqa: F401
+from aider.exceptions import LiteLLMExceptions
 from aider.llm import litellm
 
 # from diskcache import Cache
@@ -17,52 +18,6 @@ CACHE = None
 RETRY_TIMEOUT = 60
 
 
-def retry_exceptions():
-    import httpx
-    import openai
-
-    return (
-        # httpx
-        httpx.ConnectError,
-        httpx.RemoteProtocolError,
-        httpx.ReadTimeout,
-        #
-        # litellm exceptions inherit from openai exceptions
-        # https://docs.litellm.ai/docs/exception_mapping
-        #
-        # openai.BadRequestError,
-        # litellm.ContextWindowExceededError,
-        # litellm.ContentPolicyViolationError,
-        #
-        # openai.AuthenticationError,
-        # openai.PermissionDeniedError,
-        # openai.NotFoundError,
-        #
-        openai.APITimeoutError,
-        openai.UnprocessableEntityError,
-        openai.RateLimitError,
-        openai.APIConnectionError,
-        # openai.APIError,
-        # openai.APIStatusError,
-        openai.InternalServerError,
-    )
-
-
-def lazy_litellm_retry_decorator(func):
-    def wrapper(*args, **kwargs):
-        decorated_func = backoff.on_exception(
-            backoff.expo,
-            retry_exceptions(),
-            max_time=RETRY_TIMEOUT,
-            on_backoff=lambda details: print(
-                f"{details.get('exception', 'Exception')}\nRetry in {details['wait']:.1f} seconds."
-            ),
-        )(func)
-        return decorated_func(*args, **kwargs)
-
-    return wrapper
-
-
 def send_completion(
     model_name,
     messages,
@@ -104,6 +59,8 @@ def send_completion(
 
 
 def simple_send_with_retries(model_name, messages, extra_params=None):
+    litellm_ex = LiteLLMExceptions()
+
     retry_delay = 0.125
     while True:
         try:
@@ -117,11 +74,22 @@ def simple_send_with_retries(model_name, messages, extra_params=None):
 
             _hash, response = send_completion(**kwargs)
             return response.choices[0].message.content
-        except retry_exceptions() as err:
+        except litellm_ex.exceptions_tuple() as err:
+            ex_info = litellm_ex.get_ex_info(err)
+
             print(str(err))
-            retry_delay *= 2
-            if retry_delay > RETRY_TIMEOUT:
+            if ex_info.description:
+                print(ex_info.description)
+
+            should_retry = ex_info.retry
+            if should_retry:
+                retry_delay *= 2
+                if retry_delay > RETRY_TIMEOUT:
+                    should_retry = False
+
+            if not should_retry:
                 break
+
             print(f"Retrying in {retry_delay:.1f} seconds...")
             time.sleep(retry_delay)
             continue

commit 4d96728709c0516c69d322aeed637c2923210dc3
Author: Paul Gauthier (aider) <aider@paulg.org>
Date:   Thu Nov 7 13:02:07 2024 -0800

    fix: Remove unused import of 'backoff' in sendchat.py

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 8c63ff83..4e3c8d66 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -2,7 +2,6 @@ import hashlib
 import json
 import time
 
-import backoff
 
 from aider.dump import dump  # noqa: F401
 from aider.exceptions import LiteLLMExceptions

commit 9e7219c4d64ccd03484530fdab7c4134cb8b970a
Author: Paul Gauthier (aider) <aider@paulg.org>
Date:   Thu Nov 7 13:02:10 2024 -0800

    style: Run linter to clean up code formatting in sendchat.py

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 4e3c8d66..e4b8bd7b 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -2,7 +2,6 @@ import hashlib
 import json
 import time
 
-
 from aider.dump import dump  # noqa: F401
 from aider.exceptions import LiteLLMExceptions
 from aider.llm import litellm

commit 14d02bc843a67f74f055f1166c1e312d0aa217bd
Author: Paul Gauthier (aider) <aider@paulg.org>
Date:   Fri Nov 8 10:02:48 2024 -0800

    fix: Handle None response and update InvalidRequestError test

diff --git a/aider/sendchat.py b/aider/sendchat.py
index e4b8bd7b..745d10eb 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -71,6 +71,8 @@ def simple_send_with_retries(model_name, messages, extra_params=None):
             }
 
             _hash, response = send_completion(**kwargs)
+            if not response or not hasattr(response, 'choices') or not response.choices:
+                return None
             return response.choices[0].message.content
         except litellm_ex.exceptions_tuple() as err:
             ex_info = litellm_ex.get_ex_info(err)

commit d0e85d9c2c053a1679cf78f046ef021bcf04dc7a
Author: Paul Gauthier (aider) <aider@paulg.org>
Date:   Fri Nov 8 10:02:54 2024 -0800

    style: Apply linter formatting to sendchat.py and test_sendchat.py

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 745d10eb..7414243c 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -71,7 +71,7 @@ def simple_send_with_retries(model_name, messages, extra_params=None):
             }
 
             _hash, response = send_completion(**kwargs)
-            if not response or not hasattr(response, 'choices') or not response.choices:
+            if not response or not hasattr(response, "choices") or not response.choices:
                 return None
             return response.choices[0].message.content
         except litellm_ex.exceptions_tuple() as err:

commit 7a8399571acfc590c0112d8ee389bc8cb0b99358
Author: Paul Gauthier (aider) <aider@paulg.org>
Date:   Fri Nov 8 10:03:49 2024 -0800

    fix: Handle non-retryable errors by returning None in simple_send_with_retries

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 7414243c..3d1224bc 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -88,10 +88,10 @@ def simple_send_with_retries(model_name, messages, extra_params=None):
                     should_retry = False
 
             if not should_retry:
-                break
+                return None
 
             print(f"Retrying in {retry_delay:.1f} seconds...")
             time.sleep(retry_delay)
             continue
         except AttributeError:
-            return
+            return None

commit ccf460c1f7889b1a337757aece3f8707c7bab510
Author: Paul Gauthier (aider) <aider@paulg.org>
Date:   Sat Dec 7 13:37:14 2024 -0800

    refactor: update simple_send_with_retries to use model object and handle temperature

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 3d1224bc..a61ac554 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -56,18 +56,19 @@ def send_completion(
     return hash_object, res
 
 
-def simple_send_with_retries(model_name, messages, extra_params=None):
+def simple_send_with_retries(model, messages):
     litellm_ex = LiteLLMExceptions()
 
     retry_delay = 0.125
     while True:
         try:
             kwargs = {
-                "model_name": model_name,
+                "model_name": model.name,
                 "messages": messages,
                 "functions": None,
                 "stream": False,
-                "extra_params": extra_params,
+                "temperature": None if not model.use_temperature else 0,
+                "extra_params": model.extra_params,
             }
 
             _hash, response = send_completion(**kwargs)

commit cdc9ec2854a3961986292f709c50f62e99838acd
Author: Paul Gauthier <paul@aider.chat>
Date:   Mon Jan 20 08:34:38 2025 -0800

    refactor: Add comment for `sanity_check_messages` function in `sendchat.py`

diff --git a/aider/sendchat.py b/aider/sendchat.py
index a61ac554..8cd635d8 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -15,6 +15,7 @@ CACHE = None
 
 RETRY_TIMEOUT = 60
 
+# sanity_check_messages(messages) -> check if messages alternate role=user and role=assistant (it's ok if role=system messages are interspersed) ai!
 
 def send_completion(
     model_name,

commit bb61be630a5f66126ed70c54b2481070ee38cf0a
Author: Paul Gauthier (aider) <paul@aider.chat>
Date:   Mon Jan 20 08:34:40 2025 -0800

    feat: add message role validation function

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 8cd635d8..07d31b42 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -15,7 +15,19 @@ CACHE = None
 
 RETRY_TIMEOUT = 60
 
-# sanity_check_messages(messages) -> check if messages alternate role=user and role=assistant (it's ok if role=system messages are interspersed) ai!
+def sanity_check_messages(messages):
+    """Check if messages alternate between user and assistant roles.
+    System messages can be interspersed anywhere.
+    Returns True if valid, False otherwise."""
+    last_role = None
+    for msg in messages:
+        role = msg.get("role")
+        if role == "system":
+            continue
+        if last_role and role == last_role:
+            return False
+        last_role = role
+    return True
 
 def send_completion(
     model_name,

commit fc431df2b414598cfd16d44d86a40d1d4ba636f8
Author: Paul Gauthier (aider) <paul@aider.chat>
Date:   Mon Jan 20 08:34:44 2025 -0800

    style: Add blank lines for better readability in sendchat.py

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 07d31b42..59f67c53 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -15,6 +15,7 @@ CACHE = None
 
 RETRY_TIMEOUT = 60
 
+
 def sanity_check_messages(messages):
     """Check if messages alternate between user and assistant roles.
     System messages can be interspersed anywhere.
@@ -29,6 +30,7 @@ def sanity_check_messages(messages):
         last_role = role
     return True
 
+
 def send_completion(
     model_name,
     messages,

commit 7e5e1800005c14d96cdc9ba5df0d89aab77fa8bb
Author: Paul Gauthier (aider) <paul@aider.chat>
Date:   Mon Jan 20 08:35:21 2025 -0800

    feat: verify last non-system message is from user in sanity_check_messages

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 59f67c53..379ec62d 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -19,16 +19,24 @@ RETRY_TIMEOUT = 60
 def sanity_check_messages(messages):
     """Check if messages alternate between user and assistant roles.
     System messages can be interspersed anywhere.
+    Also verifies the last non-system message is from the user.
     Returns True if valid, False otherwise."""
     last_role = None
+    last_non_system_role = None
+    
     for msg in messages:
         role = msg.get("role")
         if role == "system":
             continue
+            
         if last_role and role == last_role:
             return False
+            
         last_role = role
-    return True
+        last_non_system_role = role
+        
+    # Ensure last non-system message is from user
+    return last_non_system_role == "user"
 
 
 def send_completion(

commit 73bc0f62580f6fb152b1ef695c0840ccb1320aac
Author: Paul Gauthier (aider) <paul@aider.chat>
Date:   Mon Jan 20 08:35:24 2025 -0800

    style: Remove trailing whitespace in sendchat.py

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 379ec62d..4e88f302 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -23,18 +23,18 @@ def sanity_check_messages(messages):
     Returns True if valid, False otherwise."""
     last_role = None
     last_non_system_role = None
-    
+
     for msg in messages:
         role = msg.get("role")
         if role == "system":
             continue
-            
+
         if last_role and role == last_role:
             return False
-            
+
         last_role = role
         last_non_system_role = role
-        
+
     # Ensure last non-system message is from user
     return last_non_system_role == "user"
 

commit dff544cd5dea68807e5d2a66cfa3954c14102abc
Author: Paul Gauthier <paul@aider.chat>
Date:   Mon Jan 20 09:38:45 2025 -0800

    refactor: Split summarize method and add model metadata handling

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 4e88f302..ccf1c9f5 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -5,6 +5,7 @@ import time
 from aider.dump import dump  # noqa: F401
 from aider.exceptions import LiteLLMExceptions
 from aider.llm import litellm
+from aider.utils import format_messages
 
 # from diskcache import Cache
 
@@ -30,7 +31,9 @@ def sanity_check_messages(messages):
             continue
 
         if last_role and role == last_role:
-            return False
+            print(format_messages(messages))
+            # import sys ; sys.exit()
+            raise ValueError("Messages don't properly alternate user/assistant")
 
         last_role = role
         last_non_system_role = role
@@ -47,6 +50,8 @@ def send_completion(
     temperature=0,
     extra_params=None,
 ):
+    # sanity_check_messages(messages)
+
     kwargs = dict(
         model=model_name,
         messages=messages,

commit 06d5b14b86b643823905264660bdb994fd873360
Author: Paul Gauthier <paul@aider.chat>
Date:   Mon Jan 20 09:43:01 2025 -0800

    sanity_check_messages

diff --git a/aider/sendchat.py b/aider/sendchat.py
index ccf1c9f5..41082340 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -50,7 +50,7 @@ def send_completion(
     temperature=0,
     extra_params=None,
 ):
-    # sanity_check_messages(messages)
+    sanity_check_messages(messages)
 
     kwargs = dict(
         model=model_name,

commit 56506974757bc03c00bc29d1874df00bbf733286
Author: Paul Gauthier <paul@aider.chat>
Date:   Mon Jan 20 11:10:43 2025 -0800

    no turn errors, with upd_cur_msgs fix and summarizer disabled

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 41082340..0158c52a 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -31,9 +31,8 @@ def sanity_check_messages(messages):
             continue
 
         if last_role and role == last_role:
-            print(format_messages(messages))
-            # import sys ; sys.exit()
-            raise ValueError("Messages don't properly alternate user/assistant")
+            turns = format_messages(messages)
+            raise ValueError("Messages don't properly alternate user/assistant:\n\n" + turns)
 
         last_role = role
         last_non_system_role = role

commit 163e6f56df4c7c67fe22968b463064c6fba0411c
Author: Paul Gauthier <paul@aider.chat>
Date:   Mon Jan 20 11:26:19 2025 -0800

    re-enable summaries

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 0158c52a..bd45cc13 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -49,7 +49,11 @@ def send_completion(
     temperature=0,
     extra_params=None,
 ):
+    #
+    #
     sanity_check_messages(messages)
+    #
+    #
 
     kwargs = dict(
         model=model_name,

commit 61ab5d16527a57d5a0c6b288ca543342d2835d48
Author: Paul Gauthier <paul@aider.chat>
Date:   Mon Jan 20 11:35:54 2025 -0800

    disable sanity check

diff --git a/aider/sendchat.py b/aider/sendchat.py
index bd45cc13..e0400825 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -51,7 +51,7 @@ def send_completion(
 ):
     #
     #
-    sanity_check_messages(messages)
+    # sanity_check_messages(messages)
     #
     #
 

commit 42ef4352f4b0bd2d05629e0c12bd6409ea8f7b74
Author: Paul Gauthier <paul@aider.chat>
Date:   Wed Jan 22 09:02:45 2025 -0800

    refactor: Handle KeyboardInterrupt with user-assistant message pair and add env check for sanity_check_messages

diff --git a/aider/sendchat.py b/aider/sendchat.py
index e0400825..2cf7086a 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -1,5 +1,6 @@
 import hashlib
 import json
+import os
 import time
 
 from aider.dump import dump  # noqa: F401
@@ -51,7 +52,8 @@ def send_completion(
 ):
     #
     #
-    # sanity_check_messages(messages)
+    if os.environ.get("AIDER_SANITY_CHECK_TURNS"):
+        sanity_check_messages(messages)
     #
     #
 

commit 421bc9376563ef1a6c05949083a555290161b8c7
Author: Mir Adnan ALI <maali@socialdynamics.ca>
Date:   Fri Jan 24 03:58:08 2025 -0500

    Ensure alternating roles for deepseek-reasoner

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 2cf7086a..5e75ff58 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -42,6 +42,38 @@ def sanity_check_messages(messages):
     return last_non_system_role == "user"
 
 
+def ensure_alternating_roles(messages):
+    """
+    Ensure messages alternate between 'assistant' and 'user' roles.
+    Inserts empty messages of the opposite role when consecutive messages of the same role are found.
+
+    Args:
+        messages: List of message dictionaries with 'role' and 'content' keys.
+
+    Returns:
+        List of messages with alternating roles.
+    """
+    if not messages:
+        return messages
+
+    fixed_messages = []
+    prev_role = None
+
+    for msg in messages:
+        current_role = msg['role']
+
+        # If the current role is the same as the previous, insert an empty message of the opposite role
+        if current_role == prev_role:
+            if current_role == 'user':
+                fixed_messages.append({'role': 'assistant', 'content': ''})
+            else:
+                fixed_messages.append({'role': 'user', 'content': ''})
+
+        fixed_messages.append(msg)
+        prev_role = current_role
+
+    return fixed_messages
+
 def send_completion(
     model_name,
     messages,
@@ -57,6 +89,9 @@ def send_completion(
     #
     #
 
+    if model_name == 'deepseek/deepseek-reasoner':
+        messages = ensure_alternating_roles(messages)
+
     kwargs = dict(
         model=model_name,
         messages=messages,

commit 92f6d31f3322c0ea827bffce019c1cf9cf34afe3
Author: Mir Adnan ALI <maali@socialdynamics.ca>
Date:   Fri Jan 24 05:25:21 2025 -0500

    Updated patch to avoid KeyError on malformed dict

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 5e75ff58..837b3b85 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -60,7 +60,7 @@ def ensure_alternating_roles(messages):
     prev_role = None
 
     for msg in messages:
-        current_role = msg['role']
+        current_role = msg.get('role')  # Get 'role', None if missing
 
         # If the current role is the same as the previous, insert an empty message of the opposite role
         if current_role == prev_role:

commit d8c14c04e30d204bbfbcef6c97af74a226a9beea
Author: Paul Gauthier <paul@aider.chat>
Date:   Fri Jan 24 09:14:37 2025 -0800

    refactor: standardize string quotes and improve model name handling

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 837b3b85..108da90b 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -60,20 +60,21 @@ def ensure_alternating_roles(messages):
     prev_role = None
 
     for msg in messages:
-        current_role = msg.get('role')  # Get 'role', None if missing
+        current_role = msg.get("role")  # Get 'role', None if missing
 
         # If the current role is the same as the previous, insert an empty message of the opposite role
         if current_role == prev_role:
-            if current_role == 'user':
-                fixed_messages.append({'role': 'assistant', 'content': ''})
+            if current_role == "user":
+                fixed_messages.append({"role": "assistant", "content": ""})
             else:
-                fixed_messages.append({'role': 'user', 'content': ''})
+                fixed_messages.append({"role": "user", "content": ""})
 
         fixed_messages.append(msg)
         prev_role = current_role
 
     return fixed_messages
 
+
 def send_completion(
     model_name,
     messages,
@@ -89,7 +90,7 @@ def send_completion(
     #
     #
 
-    if model_name == 'deepseek/deepseek-reasoner':
+    if "deepseek-reasoner" in model_name:
         messages = ensure_alternating_roles(messages)
 
     kwargs = dict(
@@ -127,6 +128,9 @@ def send_completion(
 def simple_send_with_retries(model, messages):
     litellm_ex = LiteLLMExceptions()
 
+    if "deepseek-reasoner" in model.name:
+        messages = ensure_alternating_roles(messages)
+
     retry_delay = 0.125
     while True:
         try:

commit 387b7602cf640a30e0e84024118edb3789ccb216
Author: Paul Gauthier (aider) <paul@aider.chat>
Date:   Fri Jan 24 09:14:51 2025 -0800

    style: Break long lines to comply with flake8 E501

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 108da90b..1622de24 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -43,9 +43,10 @@ def sanity_check_messages(messages):
 
 
 def ensure_alternating_roles(messages):
-    """
-    Ensure messages alternate between 'assistant' and 'user' roles.
-    Inserts empty messages of the opposite role when consecutive messages of the same role are found.
+    """Ensure messages alternate between 'assistant' and 'user' roles.
+    
+    Inserts empty messages of the opposite role when consecutive messages
+    of the same role are found.
 
     Args:
         messages: List of message dictionaries with 'role' and 'content' keys.
@@ -62,7 +63,8 @@ def ensure_alternating_roles(messages):
     for msg in messages:
         current_role = msg.get("role")  # Get 'role', None if missing
 
-        # If the current role is the same as the previous, insert an empty message of the opposite role
+        # If current role same as previous, insert empty message
+        # of the opposite role
         if current_role == prev_role:
             if current_role == "user":
                 fixed_messages.append({"role": "assistant", "content": ""})

commit 231bceeabbfb40b26be95f70d431d74b87b18c3f
Author: Paul Gauthier (aider) <paul@aider.chat>
Date:   Fri Jan 24 09:14:55 2025 -0800

    style: Fix whitespace in docstring

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 1622de24..bc400826 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -44,7 +44,7 @@ def sanity_check_messages(messages):
 
 def ensure_alternating_roles(messages):
     """Ensure messages alternate between 'assistant' and 'user' roles.
-    
+
     Inserts empty messages of the opposite role when consecutive messages
     of the same role are found.
 

commit 6e5b2c73689e61f198f4c057342165283a49516f
Author: Paul Gauthier <paul@aider.chat>
Date:   Tue Jan 28 10:49:40 2025 -0800

    cleanup

diff --git a/aider/sendchat.py b/aider/sendchat.py
index bc400826..6d4ef61d 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -112,6 +112,7 @@ def send_completion(
         kwargs.update(extra_params)
 
     key = json.dumps(kwargs, sort_keys=True).encode()
+    # dump(kwargs)
 
     # Generate SHA1 hash of kwargs and append it to chat_completion_call_hashes
     hash_object = hashlib.sha1(key)

commit 60aff26d94697b31a794d72c7040ea1284e68402
Author: Paul Gauthier (aider) <paul@aider.chat>
Date:   Tue Feb 4 11:32:58 2025 -0800

    refactor: Move send_completion and simple_send_with_retries to Model class

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 6d4ef61d..f5518cc7 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -77,97 +77,5 @@ def ensure_alternating_roles(messages):
     return fixed_messages
 
 
-def send_completion(
-    model_name,
-    messages,
-    functions,
-    stream,
-    temperature=0,
-    extra_params=None,
-):
-    #
-    #
-    if os.environ.get("AIDER_SANITY_CHECK_TURNS"):
-        sanity_check_messages(messages)
-    #
-    #
-
-    if "deepseek-reasoner" in model_name:
-        messages = ensure_alternating_roles(messages)
-
-    kwargs = dict(
-        model=model_name,
-        messages=messages,
-        stream=stream,
-    )
-    if temperature is not None:
-        kwargs["temperature"] = temperature
-
-    if functions is not None:
-        function = functions[0]
-        kwargs["tools"] = [dict(type="function", function=function)]
-        kwargs["tool_choice"] = {"type": "function", "function": {"name": function["name"]}}
-
-    if extra_params is not None:
-        kwargs.update(extra_params)
-
-    key = json.dumps(kwargs, sort_keys=True).encode()
-    # dump(kwargs)
-
-    # Generate SHA1 hash of kwargs and append it to chat_completion_call_hashes
-    hash_object = hashlib.sha1(key)
-
-    if not stream and CACHE is not None and key in CACHE:
-        return hash_object, CACHE[key]
-
-    res = litellm.completion(**kwargs)
-
-    if not stream and CACHE is not None:
-        CACHE[key] = res
-
-    return hash_object, res
-
-
-def simple_send_with_retries(model, messages):
-    litellm_ex = LiteLLMExceptions()
-
-    if "deepseek-reasoner" in model.name:
-        messages = ensure_alternating_roles(messages)
-
-    retry_delay = 0.125
-    while True:
-        try:
-            kwargs = {
-                "model_name": model.name,
-                "messages": messages,
-                "functions": None,
-                "stream": False,
-                "temperature": None if not model.use_temperature else 0,
-                "extra_params": model.extra_params,
-            }
-
-            _hash, response = send_completion(**kwargs)
-            if not response or not hasattr(response, "choices") or not response.choices:
-                return None
-            return response.choices[0].message.content
-        except litellm_ex.exceptions_tuple() as err:
-            ex_info = litellm_ex.get_ex_info(err)
-
-            print(str(err))
-            if ex_info.description:
-                print(ex_info.description)
-
-            should_retry = ex_info.retry
-            if should_retry:
-                retry_delay *= 2
-                if retry_delay > RETRY_TIMEOUT:
-                    should_retry = False
-
-            if not should_retry:
-                return None
-
-            print(f"Retrying in {retry_delay:.1f} seconds...")
-            time.sleep(retry_delay)
-            continue
-        except AttributeError:
-            return None
+
+

commit 24b1360eb8cf4fba556a5998469d18e554337247
Author: Paul Gauthier (aider) <paul@aider.chat>
Date:   Tue Feb 4 11:33:05 2025 -0800

    style: Run linter and fix whitespace issues in models.py and sendchat.py

diff --git a/aider/sendchat.py b/aider/sendchat.py
index f5518cc7..23e8612a 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -75,7 +75,3 @@ def ensure_alternating_roles(messages):
         prev_role = current_role
 
     return fixed_messages
-
-
-
-

commit 34227ce738e9c6dab069a779028a98f583e67dc6
Author: Paul Gauthier (aider) <paul@aider.chat>
Date:   Tue Feb 4 11:33:43 2025 -0800

    fix: Remove unused imports from sendchat.py and add hashlib import in models.py

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 23e8612a..c10c25d2 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -1,11 +1,5 @@
-import hashlib
-import json
-import os
-import time
 
 from aider.dump import dump  # noqa: F401
-from aider.exceptions import LiteLLMExceptions
-from aider.llm import litellm
 from aider.utils import format_messages
 
 # from diskcache import Cache

commit db694b20dffce31f21594aeebc82751b3048d78f
Author: Paul Gauthier (aider) <paul@aider.chat>
Date:   Tue Feb 4 11:33:49 2025 -0800

    style: Run linter and fix import order in models.py and sendchat.py

diff --git a/aider/sendchat.py b/aider/sendchat.py
index c10c25d2..f518a6d7 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -1,4 +1,3 @@
-
 from aider.dump import dump  # noqa: F401
 from aider.utils import format_messages
 

commit c3beaedaa68a79e59528081dc0faf3edeba8b837
Author: Paul Gauthier (aider) <paul@aider.chat>
Date:   Tue Feb 4 11:34:38 2025 -0800

    chore: remove CACHE logic from sendchat and models files

diff --git a/aider/sendchat.py b/aider/sendchat.py
index f518a6d7..1710a4e9 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -1,12 +1,6 @@
 from aider.dump import dump  # noqa: F401
 from aider.utils import format_messages
 
-# from diskcache import Cache
-
-
-CACHE_PATH = "~/.aider.send.cache.v1"
-CACHE = None
-# CACHE = Cache(CACHE_PATH)
 
 RETRY_TIMEOUT = 60
 

commit 72b82a8d19648f9240bfb3012de1917cea650e59
Author: Paul Gauthier (aider) <paul@aider.chat>
Date:   Tue Feb 4 11:34:45 2025 -0800

    style: Run linter and fix whitespace issues in models.py and sendchat.py

diff --git a/aider/sendchat.py b/aider/sendchat.py
index 1710a4e9..f11f4186 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -1,7 +1,6 @@
 from aider.dump import dump  # noqa: F401
 from aider.utils import format_messages
 
-
 RETRY_TIMEOUT = 60
 
 

commit 74da63e3cabcce0adb77b1f05a2745051f34f07b
Author: Paul Gauthier (aider) <paul@aider.chat>
Date:   Tue Feb 4 11:45:40 2025 -0800

    refactor: Move RETRY_TIMEOUT constant to models.py

diff --git a/aider/sendchat.py b/aider/sendchat.py
index f11f4186..3f06cbfb 100644
--- a/aider/sendchat.py
+++ b/aider/sendchat.py
@@ -1,8 +1,6 @@
 from aider.dump import dump  # noqa: F401
 from aider.utils import format_messages
 
-RETRY_TIMEOUT = 60
-
 
 def sanity_check_messages(messages):
     """Check if messages alternate between user and assistant roles.

