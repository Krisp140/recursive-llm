# Instructions

You are being benchmarked. You will see the output of a git log command, and from that must infer the current state of a file. Think carefully, as you must output the exact state of the file to earn full marks.

**Important:** Your goal is to reproduce the file's content *exactly* as it exists at the final commit, even if the code appears broken, buggy, or contains obvious errors. Do **not** try to "fix" the code. Attempting to correct issues will result in a poor score, as this benchmark evaluates your ability to reproduce the precise state of the file based on its history.

# Required Response Format

Wrap the content of the file in triple backticks (```). Any text outside the final closing backticks will be ignored. End your response after outputting the closing backticks.

# Example Response

```python
#!/usr/bin/env python
print('Hello, world!')
```

# File History

> git log -p --cc --topo-order --reverse -- packages/editor/src/lib/components/Shape.tsx

commit 29ed921c6745923dcc8daa72ba6f815a5c4b279a
Author: alex <alex@dytry.ch>
Date:   Tue Apr 25 12:01:25 2023 +0100

    transfer-out: transfer out

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
new file mode 100644
index 000000000..bd191bd2b
--- /dev/null
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -0,0 +1,161 @@
+import { Matrix2d } from '@tldraw/primitives'
+import { TLShape, TLShapeId } from '@tldraw/tlschema'
+import * as React from 'react'
+import {
+	track,
+	// @ts-expect-error 'private' export
+	useStateTracking,
+} from 'signia-react'
+import { useApp } from '../..'
+import { TLShapeUtil } from '../app/shapeutils/TLShapeUtil'
+import { useEditorComponents } from '../hooks/useEditorComponents'
+import { useQuickReactor } from '../hooks/useQuickReactor'
+import { useShapeEvents } from '../hooks/useShapeEvents'
+import { OptionalErrorBoundary } from './ErrorBoundary'
+
+/*
+This component renders shapes on the canvas. There are two stages: positioning
+and styling the shape's container using CSS, and then rendering the shape's 
+JSX using its shape util's render method. Rendering the "inside" of a shape is
+more expensive than positioning it or changing its color, so we use React.memo
+to wrap the inner shape and only re-render it when the shape's props change. 
+
+The shape also receives props for its index and opacity. The index is used to
+determine the z-index of the shape, and the opacity is used to set the shape's
+opacity based on its own opacity and that of its parent's.
+*/
+export const Shape = track(function Shape({
+	id,
+	index,
+	opacity,
+	isCulled,
+}: {
+	id: TLShapeId
+	index: number
+	opacity: number
+	isCulled: boolean
+}) {
+	const app = useApp()
+
+	const { ShapeErrorFallback } = useEditorComponents()
+
+	const events = useShapeEvents(id)
+
+	const rContainer = React.useRef<HTMLDivElement>(null)
+
+	useQuickReactor(
+		'set shape container transform position',
+		() => {
+			const elm = rContainer.current
+			if (!elm) return
+
+			const shape = app.getShapeById(id)
+			const pageTransform = app.getPageTransformById(id)
+
+			if (!shape || !pageTransform) return null
+
+			const transform = Matrix2d.toCssString(pageTransform)
+			elm.style.setProperty('transform', transform)
+		},
+		[app]
+	)
+
+	useQuickReactor(
+		'set shape container clip path / color',
+		() => {
+			const elm = rContainer.current
+			const shape = app.getShapeById(id)
+			if (!elm) return
+			if (!shape) return null
+
+			const clipPath = app.getClipPathById(id)
+			elm.style.setProperty('clip-path', clipPath ?? 'none')
+			if ('color' in shape.props) {
+				elm.style.setProperty('color', app.getCssColor(shape.props.color))
+			}
+		},
+		[app]
+	)
+
+	useQuickReactor(
+		'set shape height and width',
+		() => {
+			const elm = rContainer.current
+			const shape = app.getShapeById(id)
+			if (!elm) return
+			if (!shape) return null
+
+			const util = app.getShapeUtil(shape)
+			const bounds = util.bounds(shape)
+			elm.style.setProperty('width', Math.ceil(bounds.width) + 'px')
+			elm.style.setProperty('height', Math.ceil(bounds.height) + 'px')
+		},
+		[app]
+	)
+
+	// Set the opacity of the container when the opacity changes
+	React.useLayoutEffect(() => {
+		const elm = rContainer.current
+		if (!elm) return
+		elm.style.setProperty('opacity', opacity + '')
+		elm.style.setProperty('z-index', index + '')
+	}, [opacity, index])
+
+	const shape = app.getShapeById(id)
+
+	if (!shape) return null
+
+	const util = app.getShapeUtil(shape)
+
+	return (
+		<div
+			key={id}
+			ref={rContainer}
+			className="rs-shape"
+			data-shape-type={shape.type}
+			draggable={false}
+			onPointerDown={events.onPointerDown}
+			onPointerMove={events.onPointerMove}
+			onPointerUp={events.onPointerUp}
+			onPointerEnter={events.onPointerEnter}
+			onPointerLeave={events.onPointerLeave}
+		>
+			{isCulled && util.canUnmount(shape) ? (
+				<CulledShape shape={shape} util={util} />
+			) : (
+				<OptionalErrorBoundary
+					fallback={ShapeErrorFallback ? (error) => <ShapeErrorFallback error={error} /> : null}
+					onError={(error) =>
+						app.annotateError(error, { origin: 'react.shape', willCrashApp: false })
+					}
+				>
+					<InnerShape shape={shape} util={util} />
+				</OptionalErrorBoundary>
+			)}
+		</div>
+	)
+})
+
+const InnerShape = React.memo(
+	function InnerShape<T extends TLShape>({ shape, util }: { shape: T; util: TLShapeUtil<T> }) {
+		return useStateTracking('InnerShape:' + util.type, () => util.render(shape))
+	},
+	(prev, next) => prev.shape.props === next.shape.props
+)
+
+const CulledShape = React.memo(
+	function CulledShap<T extends TLShape>({ shape, util }: { shape: T; util: TLShapeUtil<T> }) {
+		const bounds = util.bounds(shape)
+		return (
+			<div
+				className="rs-shape__culled"
+				style={{
+					transform: `translate(${bounds.minX}px, ${bounds.minY}px)`,
+					width: bounds.width,
+					height: bounds.height,
+				}}
+			/>
+		)
+	},
+	() => true
+)

commit dc16ae1b1267b89b85f501ad2e979f618089a89b
Author: Lu[ke] Wilson <l2wilson94@gmail.com>
Date:   Fri May 5 07:14:42 2023 -0700

    remove svg layer, html all the things, rs to tl (#1227)
    
    This PR has been hijacked! üóëÔ∏èü¶ùü¶ùü¶ù
    
    The <Canvas> component was previously split into an <SVGLayer> and an
    <HTMLLayer>, mainly due to the complexity around translating SVGs.
    However, this was done before we learned that SVGs can have overflow:
    visible, so it turns out that we don't really need the SVGLayer at all.
    This PR now refactors away SVG Layer.
    
    It also updates the class name prefix in editor from `rs-` to `tl-` and
    does a few other small changes.
    
    ---------
    
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index bd191bd2b..40927ce36 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -111,7 +111,7 @@ export const Shape = track(function Shape({
 		<div
 			key={id}
 			ref={rContainer}
-			className="rs-shape"
+			className="tl-shape"
 			data-shape-type={shape.type}
 			draggable={false}
 			onPointerDown={events.onPointerDown}
@@ -148,7 +148,7 @@ const CulledShape = React.memo(
 		const bounds = util.bounds(shape)
 		return (
 			<div
-				className="rs-shape__culled"
+				className="tl-shape__culled"
 				style={{
 					transform: `translate(${bounds.minX}px, ${bounds.minY}px)`,
 					width: bounds.width,

commit a11a741de48278bf8f10fc1f55838ad2b6448361
Author: alex <alex@dytry.ch>
Date:   Thu Jun 1 16:22:47 2023 +0100

    [2/3] renderer changes to support "sandwich mode" highlighting (#1418)
    
    This diff modifies our canvas/rendering code to support shapes rendering
    into a "background layer". The background layer isn't a layer in the
    sense of our own html/svg/indicator layers, but is instead part of the
    HTML canvas layer and is created by allocating z-indexes to shapes below
    all others.
    
    For most shapes, the background starts at the canvas. If a shape is in a
    frame, then the frame is treated as the background.
    
    ![Kapture 2023-05-19 at 11 38
    12](https://github.com/tldraw/tldraw/assets/1489520/3ab6e0c0-f71e-4bfd-a996-c5411be28a71)
    
    Exports now use the `renderingShapes` algorithm which fixed a small bug
    with exports where opacity wouldn't get correctly propagated down
    through child shapes.
    
    ### The plan
    1. initial highlighter shape/tool #1401
    2. sandwich rendering for highlighter shapes #1418  **>you are here<**
    3. shape styling - new colours and sizes, lightweight perfect freehand
    changes
    
    ### Change Type
    
    - [x] `minor` ‚Äî New Feature
    
    
    ### Test Plan
    
    not yet!
    
    - [x] Unit Tests
    
    ### Release Notes
    
    [not yet!]

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index 40927ce36..c383b59d8 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -27,11 +27,13 @@ opacity based on its own opacity and that of its parent's.
 export const Shape = track(function Shape({
 	id,
 	index,
+	backgroundIndex,
 	opacity,
 	isCulled,
 }: {
 	id: TLShapeId
 	index: number
+	backgroundIndex: number
 	opacity: number
 	isCulled: boolean
 }) {
@@ -41,65 +43,63 @@ export const Shape = track(function Shape({
 
 	const events = useShapeEvents(id)
 
-	const rContainer = React.useRef<HTMLDivElement>(null)
+	const containerRef = React.useRef<HTMLDivElement>(null)
+	const backgroundContainerRef = React.useRef<HTMLDivElement>(null)
+
+	const setProperty = React.useCallback((property: string, value: string) => {
+		containerRef.current?.style.setProperty(property, value)
+		backgroundContainerRef.current?.style.setProperty(property, value)
+	}, [])
 
 	useQuickReactor(
 		'set shape container transform position',
 		() => {
-			const elm = rContainer.current
-			if (!elm) return
-
 			const shape = app.getShapeById(id)
 			const pageTransform = app.getPageTransformById(id)
 
 			if (!shape || !pageTransform) return null
 
 			const transform = Matrix2d.toCssString(pageTransform)
-			elm.style.setProperty('transform', transform)
+			setProperty('transform', transform)
 		},
-		[app]
+		[app, setProperty]
 	)
 
 	useQuickReactor(
 		'set shape container clip path / color',
 		() => {
-			const elm = rContainer.current
 			const shape = app.getShapeById(id)
-			if (!elm) return
 			if (!shape) return null
 
 			const clipPath = app.getClipPathById(id)
-			elm.style.setProperty('clip-path', clipPath ?? 'none')
+			setProperty('clip-path', clipPath ?? 'none')
 			if ('color' in shape.props) {
-				elm.style.setProperty('color', app.getCssColor(shape.props.color))
+				setProperty('color', app.getCssColor(shape.props.color))
 			}
 		},
-		[app]
+		[app, setProperty]
 	)
 
 	useQuickReactor(
 		'set shape height and width',
 		() => {
-			const elm = rContainer.current
 			const shape = app.getShapeById(id)
-			if (!elm) return
 			if (!shape) return null
 
 			const util = app.getShapeUtil(shape)
 			const bounds = util.bounds(shape)
-			elm.style.setProperty('width', Math.ceil(bounds.width) + 'px')
-			elm.style.setProperty('height', Math.ceil(bounds.height) + 'px')
+			setProperty('width', Math.ceil(bounds.width) + 'px')
+			setProperty('height', Math.ceil(bounds.height) + 'px')
 		},
 		[app]
 	)
 
 	// Set the opacity of the container when the opacity changes
 	React.useLayoutEffect(() => {
-		const elm = rContainer.current
-		if (!elm) return
-		elm.style.setProperty('opacity', opacity + '')
-		elm.style.setProperty('z-index', index + '')
-	}, [opacity, index])
+		setProperty('opacity', opacity + '')
+		containerRef.current?.style.setProperty('z-index', index + '')
+		backgroundContainerRef.current?.style.setProperty('z-index', backgroundIndex + '')
+	}, [opacity, index, backgroundIndex, setProperty])
 
 	const shape = app.getShapeById(id)
 
@@ -108,31 +108,53 @@ export const Shape = track(function Shape({
 	const util = app.getShapeUtil(shape)
 
 	return (
-		<div
-			key={id}
-			ref={rContainer}
-			className="tl-shape"
-			data-shape-type={shape.type}
-			draggable={false}
-			onPointerDown={events.onPointerDown}
-			onPointerMove={events.onPointerMove}
-			onPointerUp={events.onPointerUp}
-			onPointerEnter={events.onPointerEnter}
-			onPointerLeave={events.onPointerLeave}
-		>
-			{isCulled && util.canUnmount(shape) ? (
-				<CulledShape shape={shape} util={util} />
-			) : (
-				<OptionalErrorBoundary
-					fallback={ShapeErrorFallback ? (error) => <ShapeErrorFallback error={error} /> : null}
-					onError={(error) =>
-						app.annotateError(error, { origin: 'react.shape', willCrashApp: false })
-					}
+		<>
+			{util.renderBackground && (
+				<div
+					ref={backgroundContainerRef}
+					className="tl-shape tl-shape-background"
+					data-shape-type={shape.type}
+					draggable={false}
 				>
-					<InnerShape shape={shape} util={util} />
-				</OptionalErrorBoundary>
+					{isCulled ? (
+						<CulledShape shape={shape} util={util} />
+					) : (
+						<OptionalErrorBoundary
+							fallback={ShapeErrorFallback ? (error) => <ShapeErrorFallback error={error} /> : null}
+							onError={(error) =>
+								app.annotateError(error, { origin: 'react.shape', willCrashApp: false })
+							}
+						>
+							<InnerShapeBackground shape={shape} util={util} />
+						</OptionalErrorBoundary>
+					)}
+				</div>
 			)}
-		</div>
+			<div
+				ref={containerRef}
+				className="tl-shape"
+				data-shape-type={shape.type}
+				draggable={false}
+				onPointerDown={events.onPointerDown}
+				onPointerMove={events.onPointerMove}
+				onPointerUp={events.onPointerUp}
+				onPointerEnter={events.onPointerEnter}
+				onPointerLeave={events.onPointerLeave}
+			>
+				{isCulled && util.canUnmount(shape) ? (
+					<CulledShape shape={shape} util={util} />
+				) : (
+					<OptionalErrorBoundary
+						fallback={ShapeErrorFallback ? (error) => <ShapeErrorFallback error={error} /> : null}
+						onError={(error) =>
+							app.annotateError(error, { origin: 'react.shape', willCrashApp: false })
+						}
+					>
+						<InnerShape shape={shape} util={util} />
+					</OptionalErrorBoundary>
+				)}
+			</div>
+		</>
 	)
 })
 
@@ -143,6 +165,19 @@ const InnerShape = React.memo(
 	(prev, next) => prev.shape.props === next.shape.props
 )
 
+const InnerShapeBackground = React.memo(
+	function InnerShapeBackground<T extends TLShape>({
+		shape,
+		util,
+	}: {
+		shape: T
+		util: TLShapeUtil<T>
+	}) {
+		return useStateTracking('InnerShape:' + util.type, () => util.renderBackground?.(shape))
+	},
+	(prev, next) => prev.shape.props === next.shape.props
+)
+
 const CulledShape = React.memo(
 	function CulledShap<T extends TLShape>({ shape, util }: { shape: T; util: TLShapeUtil<T> }) {
 		const bounds = util.bounds(shape)

commit d6085e4ea6e62f1816c7188537f2b6b27dd8317c
Author: alex <alex@dytry.ch>
Date:   Thu Jun 1 16:34:59 2023 +0100

    [3/3] Highlighter styling (#1490)
    
    This PR finalises the highlighter shape with new colors, sizing, and
    perfect freehand options.
    
    The colors are based on our existing colour palette, but take advantage
    of wide-gamut displays to make the highlighter highlightier. I used my
    [oklch color palette tool to pick the
    palette](https://alex.dytry.ch/toys/palette/?palette=%7B%22families%22:%5B%22black%22,%22grey%22,%22white%22,%22green%22,%22light-green%22,%22blue%22,%22light-blue%22,%22violet%22,%22light-violet%22,%22red%22,%22light-red%22,%22orange%22,%22yellow%22%5D,%22shades%22:%5B%22light-mode%22,%22dark-mode%22,%22hl-light%22,%22hl-dark%22%5D,%22colors%22:%5B%5B%5B0.2308,0,null%5D,%5B0.9097,0,null%5D,%5B0.2308,0,null%5D,%5B0.2308,0,null%5D%5D,%5B%5B0.7692,0.0145,248.02%5D,%5B0.6778,0.0118,256.72%5D,%5B0.7692,0.0145,248.02%5D,%5B0.7692,0.0145,248.02%5D%5D,%5B%5B1,0,null%5D,%5B0.2308,0,null%5D,%5B1,0,null%5D,%5B1,0,null%5D%5D,%5B%5B0.5851,0.1227,164.1%5D,%5B0.5319,0.0811,162.23%5D,%5B0.8729,0.2083,173.3%5D,%5B0.5851,0.152,173.3%5D%5D,%5B%5B0.7146,0.1835,146.44%5D,%5B0.6384,0.1262,143.36%5D,%5B0.8603,0.2438,140.11%5D,%5B0.6082,0.2286,140.11%5D%5D,%5B%5B0.5566,0.2082,268.35%5D,%5B0.4961,0.1644,270.65%5D,%5B0.7158,0.173,243.85%5D,%5B0.5573,0.178,243.85%5D%5D,%5B%5B0.718,0.1422,246.06%5D,%5B0.6366,0.1055,250.98%5D,%5B0.8615,0.1896,200.03%5D,%5B0.707,0.161,200.03%5D%5D,%5B%5B0.5783,0.2186,319.15%5D,%5B0.5043,0.1647,315.37%5D,%5B0.728,0.2001,307.45%5D,%5B0.5433,0.2927,307.45%5D%5D,%5B%5B0.7904,0.1516,319.77%5D,%5B0.6841,0.1139,315.99%5D,%5B0.812,0.21,327.8%5D,%5B0.5668,0.281,327.8%5D%5D,%5B%5B0.5928,0.2106,26.53%5D,%5B0.5112,0.1455,26.18%5D,%5B0.7326,0.21,20.59%5D,%5B0.554,0.2461,20.59%5D%5D,%5B%5B0.7563,0.146,21.1%5D,%5B0.6561,0.0982,20.86%5D,%5B0.7749,0.178,6.8%5D,%5B0.5565,0.2454,6.8%5D%5D,%5B%5B0.6851,0.1954,44.57%5D,%5B0.5958,0.1366,46.6%5D,%5B0.8207,0.175,68.62%5D,%5B0.6567,0.164,68.61%5D%5D,%5B%5B0.8503,0.1149,68.95%5D,%5B0.7404,0.0813,72.25%5D,%5B0.8939,0.2137,100.36%5D,%5B0.7776,0.186,100.36%5D%5D%5D%7D&selected=3).
    I'm not sure happy about these colors as they are right now - in
    particular, i think dark mode looks a bit rubbish and there are a few
    colors where the highlight and original version are much too similar
    (light-violet & light-red). Black uses yellow (like note shape) and grey
    uses light-blue. Exports are forced into srgb color space rather than P3
    for maximum compatibility.
    
    
    ![image](https://github.com/tldraw/tldraw/assets/1489520/e3de762b-6ef7-4d17-87db-3e2b71dd8de1)
    
    
    ![image](https://github.com/tldraw/tldraw/assets/1489520/3bd90aa9-bdbc-4a2b-9e56-e3a83a2a877b)
    
    
    
    The size of a highlighter stroke is now based on the text size which
    works nicely for making the highlighter play well with text:
    
    
    ![image](https://github.com/tldraw/tldraw/assets/1489520/dd3184fc-decd-4db5-90ce-e9cc75edd3d6)
    
    
    Perfect freehands settings are very similar to the draw tool, but with
    the thinning turned way down. There is still some, but it's pretty
    minimal.
    
    ### The plan
    1. initial highlighter shape/tool #1401
    2. sandwich rendering for highlighter shapes #1418
    3. shape styling - new colours and sizes, lightweight perfect freehand
    changes #1490 **>you are here<**
    
    ### Change Type
    - [x] `minor` ‚Äî New Feature
    
    ### Test Plan
    
    1. You can find the highlighter tool in the extended toolbar
    2. You can activate the highlighter tool by pressing shift-D
    3. Highlighter draws nice and vibrantly when over the page background or
    frame background
    4. Highlighter is less vibrant but still visible when drawn over images
    / other fills
    5. Highlighter size should nicely match the corresponding unscaled text
    size
    6. Exports with highlighter look as expected
    
    ### Release Notes
    
    Highlighter pen is here! üéâüéâüéâ
    
    ---------
    
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index c383b59d8..bc300fe2a 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -116,9 +116,7 @@ export const Shape = track(function Shape({
 					data-shape-type={shape.type}
 					draggable={false}
 				>
-					{isCulled ? (
-						<CulledShape shape={shape} util={util} />
-					) : (
+					{!isCulled && (
 						<OptionalErrorBoundary
 							fallback={ShapeErrorFallback ? (error) => <ShapeErrorFallback error={error} /> : null}
 							onError={(error) =>

commit 735f1c41b79a3fcce14446b6384ec796f0298a31
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Fri Jun 2 16:21:45 2023 +0100

    rename app to editor (#1503)
    
    This PR renames `App`, `app` and all appy names to `Editor`, `editor`,
    and editorry names.
    
    ### Change Type
    
    - [x] `major` ‚Äî Breaking Change
    
    ### Release Notes
    
    - Rename `App` to `Editor` and many other things that reference `app` to
    `editor`.

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index bc300fe2a..236707f8f 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -6,7 +6,7 @@ import {
 	// @ts-expect-error 'private' export
 	useStateTracking,
 } from 'signia-react'
-import { useApp } from '../..'
+import { useEditor } from '../..'
 import { TLShapeUtil } from '../app/shapeutils/TLShapeUtil'
 import { useEditorComponents } from '../hooks/useEditorComponents'
 import { useQuickReactor } from '../hooks/useQuickReactor'
@@ -37,7 +37,7 @@ export const Shape = track(function Shape({
 	opacity: number
 	isCulled: boolean
 }) {
-	const app = useApp()
+	const editor = useEditor()
 
 	const { ShapeErrorFallback } = useEditorComponents()
 
@@ -54,44 +54,44 @@ export const Shape = track(function Shape({
 	useQuickReactor(
 		'set shape container transform position',
 		() => {
-			const shape = app.getShapeById(id)
-			const pageTransform = app.getPageTransformById(id)
+			const shape = editor.getShapeById(id)
+			const pageTransform = editor.getPageTransformById(id)
 
 			if (!shape || !pageTransform) return null
 
 			const transform = Matrix2d.toCssString(pageTransform)
 			setProperty('transform', transform)
 		},
-		[app, setProperty]
+		[editor, setProperty]
 	)
 
 	useQuickReactor(
 		'set shape container clip path / color',
 		() => {
-			const shape = app.getShapeById(id)
+			const shape = editor.getShapeById(id)
 			if (!shape) return null
 
-			const clipPath = app.getClipPathById(id)
+			const clipPath = editor.getClipPathById(id)
 			setProperty('clip-path', clipPath ?? 'none')
 			if ('color' in shape.props) {
-				setProperty('color', app.getCssColor(shape.props.color))
+				setProperty('color', editor.getCssColor(shape.props.color))
 			}
 		},
-		[app, setProperty]
+		[editor, setProperty]
 	)
 
 	useQuickReactor(
 		'set shape height and width',
 		() => {
-			const shape = app.getShapeById(id)
+			const shape = editor.getShapeById(id)
 			if (!shape) return null
 
-			const util = app.getShapeUtil(shape)
+			const util = editor.getShapeUtil(shape)
 			const bounds = util.bounds(shape)
 			setProperty('width', Math.ceil(bounds.width) + 'px')
 			setProperty('height', Math.ceil(bounds.height) + 'px')
 		},
-		[app]
+		[editor]
 	)
 
 	// Set the opacity of the container when the opacity changes
@@ -101,11 +101,11 @@ export const Shape = track(function Shape({
 		backgroundContainerRef.current?.style.setProperty('z-index', backgroundIndex + '')
 	}, [opacity, index, backgroundIndex, setProperty])
 
-	const shape = app.getShapeById(id)
+	const shape = editor.getShapeById(id)
 
 	if (!shape) return null
 
-	const util = app.getShapeUtil(shape)
+	const util = editor.getShapeUtil(shape)
 
 	return (
 		<>
@@ -120,7 +120,7 @@ export const Shape = track(function Shape({
 						<OptionalErrorBoundary
 							fallback={ShapeErrorFallback ? (error) => <ShapeErrorFallback error={error} /> : null}
 							onError={(error) =>
-								app.annotateError(error, { origin: 'react.shape', willCrashApp: false })
+								editor.annotateError(error, { origin: 'react.shape', willCrashApp: false })
 							}
 						>
 							<InnerShapeBackground shape={shape} util={util} />
@@ -145,7 +145,7 @@ export const Shape = track(function Shape({
 					<OptionalErrorBoundary
 						fallback={ShapeErrorFallback ? (error) => <ShapeErrorFallback error={error} /> : null}
 						onError={(error) =>
-							app.annotateError(error, { origin: 'react.shape', willCrashApp: false })
+							editor.annotateError(error, { origin: 'react.shape', willCrashApp: false })
 						}
 					>
 						<InnerShape shape={shape} util={util} />

commit 0f893096046acfbbc6870a90796b5574b9ddf91b
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Sun Jun 4 11:38:53 2023 +0100

    Renaming types, shape utils, tools (#1513)
    
    This PR renames all exported types to include the `TL` prefix. It also
    removes the `TL` prefix from things that are not types, including:
    - shape utils (e.g. `TLArrowUtil` becomes `ArrowShapeUtil`)
    - tools (e.g. `TLArrowTool` becomes `ArrowShapeTool`, `TLSelectTool`
    becomes `SelectTool`)
    
    ### Change Type
    
    - [x] `major` ‚Äî Breaking Change
    
    ### Release Notes
    
    - Renaming of types, shape utils, tools

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index 236707f8f..70142d056 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -7,7 +7,7 @@ import {
 	useStateTracking,
 } from 'signia-react'
 import { useEditor } from '../..'
-import { TLShapeUtil } from '../app/shapeutils/TLShapeUtil'
+import { ShapeUtil } from '../app/shapeutils/ShapeUtil'
 import { useEditorComponents } from '../hooks/useEditorComponents'
 import { useQuickReactor } from '../hooks/useQuickReactor'
 import { useShapeEvents } from '../hooks/useShapeEvents'
@@ -157,7 +157,7 @@ export const Shape = track(function Shape({
 })
 
 const InnerShape = React.memo(
-	function InnerShape<T extends TLShape>({ shape, util }: { shape: T; util: TLShapeUtil<T> }) {
+	function InnerShape<T extends TLShape>({ shape, util }: { shape: T; util: ShapeUtil<T> }) {
 		return useStateTracking('InnerShape:' + util.type, () => util.render(shape))
 	},
 	(prev, next) => prev.shape.props === next.shape.props
@@ -169,7 +169,7 @@ const InnerShapeBackground = React.memo(
 		util,
 	}: {
 		shape: T
-		util: TLShapeUtil<T>
+		util: ShapeUtil<T>
 	}) {
 		return useStateTracking('InnerShape:' + util.type, () => util.renderBackground?.(shape))
 	},
@@ -177,7 +177,7 @@ const InnerShapeBackground = React.memo(
 )
 
 const CulledShape = React.memo(
-	function CulledShap<T extends TLShape>({ shape, util }: { shape: T; util: TLShapeUtil<T> }) {
+	function CulledShap<T extends TLShape>({ shape, util }: { shape: T; util: ShapeUtil<T> }) {
 		const bounds = util.bounds(shape)
 		return (
 			<div

commit 355ed1de72de231232ce61612270f5fc7915690b
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Tue Jun 6 17:01:54 2023 +0100

    rename app folder to editor (#1528)
    
    Turns out there was one last terrible renaming PR to make. This PR
    renames the `@tldraw.editor`'s `app` folder to `editor`. It should not
    effect exports but it will be a gnarly diff.
    
    ### Change Type
    
    - [x] `internal` ‚Äî Any other changes that don't affect the published
    package (will not publish a new version)

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index 70142d056..971df9606 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -7,7 +7,7 @@ import {
 	useStateTracking,
 } from 'signia-react'
 import { useEditor } from '../..'
-import { ShapeUtil } from '../app/shapeutils/ShapeUtil'
+import { ShapeUtil } from '../editor/shapeutils/ShapeUtil'
 import { useEditorComponents } from '../hooks/useEditorComponents'
 import { useQuickReactor } from '../hooks/useQuickReactor'
 import { useShapeEvents } from '../hooks/useShapeEvents'

commit 7b03ef9d0c6244c00de7bf92d3c022e2873977fa
Author: alex <alex@dytry.ch>
Date:   Mon Jun 12 16:39:50 2023 +0100

    shapes folder, move tools into shape defs (#1574)
    
    This diff adds a new property to `defineShape`: `tool`.
    
    The tool prop allows shapes to bring a tool along with them as part of
    their definition. E.g. the draw shape isn't much use without the draw
    tool, so adding the draw shape to your app gives you the draw tool tool.
    
    As part of this, i renamed the `shapeutils` folder to just `shapes`, and
    moved a bunch of shape-specific tools from the tools folder into the
    shapes folder. This more closely reflects how things will be once we
    move our default shapes out of core for tldraw-zero.
    
    ### Change Type
    
    - [x] `patch` ‚Äî Bug fix
    
    ### Test Plan
    
    Tested locally
    
    ### Release Notes
    
    n/a

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index 971df9606..1aae8528f 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -7,7 +7,7 @@ import {
 	useStateTracking,
 } from 'signia-react'
 import { useEditor } from '../..'
-import { ShapeUtil } from '../editor/shapeutils/ShapeUtil'
+import { ShapeUtil } from '../editor/shapes/ShapeUtil'
 import { useEditorComponents } from '../hooks/useEditorComponents'
 import { useQuickReactor } from '../hooks/useQuickReactor'
 import { useShapeEvents } from '../hooks/useShapeEvents'

commit b88a2370b314855237774548d627ed4d3301a1ad
Author: alex <alex@dytry.ch>
Date:   Fri Jun 16 11:33:47 2023 +0100

    Styles API (#1580)
    
    Removes `propsForNextShape` and replaces it with the new styles API.
    
    Changes in here:
    - New custom style example
    - `setProp` is now `setStyle` and takes a `StyleProp` instead of a
    string
    - `Editor.props` and `Editor.opacity` are now `Editor.sharedStyles` and
    `Editor.sharedOpacity`
    - They return an object that flags mixed vs shared types instead of
    using null to signal mixed types
    - `Editor.styles` returns a `SharedStyleMap` - keyed on `StyleProp`
    instead of `string`
    - `StateNode.shapeType` is now the shape util rather than just a string.
    This lets us pull the styles from the shape type directly.
    - `color` is no longer a core part of the editor set on the shape
    parent. Individual child shapes have to use color directly.
    - `propsForNextShape` is now `stylesForNextShape`
    - `InstanceRecordType` is created at runtime in the same way
    `ShapeRecordType` is. This is so it can pull style validators out of
    shape defs for `stylesForNextShape`
    - Shape type are now defined by their props rather than having separate
    validators & type defs
    
    ### Change Type
    
    - [x] `major` ‚Äî Breaking change
    
    ### Test Plan
    
    1. Big time regression testing around styles!
    2. Check UI works as intended for all shape/style/tool combos
    
    - [x] Unit Tests
    - [ ] End to end tests
    
    ### Release Notes
    
    -
    
    ---------
    
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index 1aae8528f..28c13bc80 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -66,16 +66,13 @@ export const Shape = track(function Shape({
 	)
 
 	useQuickReactor(
-		'set shape container clip path / color',
+		'set shape container clip path',
 		() => {
 			const shape = editor.getShapeById(id)
 			if (!shape) return null
 
 			const clipPath = editor.getClipPathById(id)
 			setProperty('clip-path', clipPath ?? 'none')
-			if ('color' in shape.props) {
-				setProperty('color', editor.getCssColor(shape.props.color))
-			}
 		},
 		[editor, setProperty]
 	)

commit 3129bae6e27715921f2d700549c938c8764c1fc8
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Sun Jun 18 10:46:53 2023 +0100

    Rename `ShapeUtil.render` -> `ShapeUtil.component` (#1609)
    
    This PR renames `ShapeUtil.render` to `ShapeUtil.component`.
    
    ### Change Type
    
    - [x] `major` ‚Äî Breaking change
    
    ### Release Notes
    
    - [editor] rename `ShapeUtil.render` to `ShapeUtil.component`

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index 28c13bc80..e370644d5 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -155,7 +155,7 @@ export const Shape = track(function Shape({
 
 const InnerShape = React.memo(
 	function InnerShape<T extends TLShape>({ shape, util }: { shape: T; util: ShapeUtil<T> }) {
-		return useStateTracking('InnerShape:' + util.type, () => util.render(shape))
+		return useStateTracking('InnerShape:' + util.type, () => util.component(shape))
 	},
 	(prev, next) => prev.shape.props === next.shape.props
 )

commit 57bb341593d5f66261de4f0341736681aa6a71b6
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon Jun 19 15:01:18 2023 +0100

    `ShapeUtil` refactor, `Editor` cleanup (#1611)
    
    This PR improves the ergonomics of `ShapeUtil` classes.
    
    ### Cached methods
    
    First, I've remove the cached methods (such as `bounds`) from the
    `ShapeUtil` class and lifted this to the `Editor` class.
    
    Previously, calling `ShapeUtil.getBounds` would return the un-cached
    bounds of a shape, while calling `ShapeUtil.bounds` would return the
    cached bounds of a shape. We also had `Editor.getBounds`, which would
    call `ShapeUtil.bounds`. It was confusing. The cached methods like
    `outline` were also marked with "please don't override", which suggested
    the architecture was just wrong.
    
    The only weirdness from this is that utils sometimes reach out to the
    editor for cached versions of data rather than calling their own cached
    methods. It's still an easier story to tell than what we had before.
    
    ### More defaults
    
    We now have three and only three `abstract` methods for a `ShapeUtil`:
    - `getDefaultProps` (renamed from `defaultProps`)
    - `getBounds`,
    - `component`
    -  `indicator`
    
    Previously, we also had `getCenter` as an abstract method, though this
    was usually just the middle of the bounds anyway.
    
    ### Editing bounds
    
    This PR removes the concept of editingBounds. The viewport will no
    longer animate to editing shapes.
    
    ### Active area manager
    
    This PR also removes the active area manager, which was not being used
    in the way we expected it to be.
    
    ### Dpr manager
    
    This PR removes the dpr manager and uses a hook instead to update it
    from React. This is one less runtime browser dependency in the app, one
    less thing to document.
    
    ### Moving things around
    
    This PR also continues to try to organize related methods and properties
    in the editor.
    
    ### Change Type
    
    - [x] `major` ‚Äî Breaking change
    
    ### Release Notes
    
    - [editor] renames `defaultProps` to `getDefaultProps`
    - [editor] removes `outline`, `outlineSegments`, `handles`, `bounds`
    - [editor] renames `renderBackground` to `backgroundComponent`

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index e370644d5..f47d4f92b 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -83,8 +83,7 @@ export const Shape = track(function Shape({
 			const shape = editor.getShapeById(id)
 			if (!shape) return null
 
-			const util = editor.getShapeUtil(shape)
-			const bounds = util.bounds(shape)
+			const bounds = editor.getBounds(shape)
 			setProperty('width', Math.ceil(bounds.width) + 'px')
 			setProperty('height', Math.ceil(bounds.height) + 'px')
 		},
@@ -106,7 +105,7 @@ export const Shape = track(function Shape({
 
 	return (
 		<>
-			{util.renderBackground && (
+			{util.backgroundComponent && (
 				<div
 					ref={backgroundContainerRef}
 					className="tl-shape tl-shape-background"
@@ -137,7 +136,7 @@ export const Shape = track(function Shape({
 				onPointerLeave={events.onPointerLeave}
 			>
 				{isCulled && util.canUnmount(shape) ? (
-					<CulledShape shape={shape} util={util} />
+					<CulledShape shape={shape} />
 				) : (
 					<OptionalErrorBoundary
 						fallback={ShapeErrorFallback ? (error) => <ShapeErrorFallback error={error} /> : null}
@@ -168,14 +167,16 @@ const InnerShapeBackground = React.memo(
 		shape: T
 		util: ShapeUtil<T>
 	}) {
-		return useStateTracking('InnerShape:' + util.type, () => util.renderBackground?.(shape))
+		return useStateTracking('InnerShape:' + util.type, () => util.backgroundComponent?.(shape))
 	},
 	(prev, next) => prev.shape.props === next.shape.props
 )
 
 const CulledShape = React.memo(
-	function CulledShap<T extends TLShape>({ shape, util }: { shape: T; util: ShapeUtil<T> }) {
-		const bounds = util.bounds(shape)
+	function CulledShape<T extends TLShape>({ shape }: { shape: T }) {
+		const editor = useEditor()
+		const bounds = editor.getBounds(shape)
+
 		return (
 			<div
 				className="tl-shape__culled"

commit 5cb08711c19c086a013b3a52b06b7cdcfd443fe5
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Tue Jun 20 14:31:26 2023 +0100

    Incorporate signia as @tldraw/state (#1620)
    
    It tried to get out but we're dragging it back in.
    
    This PR brings [signia](https://github.com/tldraw/signia) back into
    tldraw as @tldraw/state.
    
    ### Change Type
    
    - [x] major
    
    ---------
    
    Co-authored-by: David Sheldrick <d.j.sheldrick@gmail.com>

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index f47d4f92b..7550771da 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -1,15 +1,10 @@
 import { Matrix2d } from '@tldraw/primitives'
+import { track, useQuickReactor, useStateTracking } from '@tldraw/state'
 import { TLShape, TLShapeId } from '@tldraw/tlschema'
 import * as React from 'react'
-import {
-	track,
-	// @ts-expect-error 'private' export
-	useStateTracking,
-} from 'signia-react'
 import { useEditor } from '../..'
 import { ShapeUtil } from '../editor/shapes/ShapeUtil'
 import { useEditorComponents } from '../hooks/useEditorComponents'
-import { useQuickReactor } from '../hooks/useQuickReactor'
 import { useShapeEvents } from '../hooks/useShapeEvents'
 import { OptionalErrorBoundary } from './ErrorBoundary'
 

commit 83184aaf439079a67b1a1b5199d7af1d8c79e91f
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Tue Jun 20 15:06:28 2023 +0100

    [fix] react component runaways, error boundaries (#1625)
    
    This PR fixes a few components that were updating too often. It changes
    the format of our error boundaries in order to avoid re-rendering them
    as changed props.
    
    ### Change Type
    
    - [x] `major` ‚Äî Breaking change

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index 7550771da..4fe691e82 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -94,6 +94,13 @@ export const Shape = track(function Shape({
 
 	const shape = editor.getShapeById(id)
 
+	const annotateError = React.useCallback(
+		(error: any) => {
+			editor.annotateError(error, { origin: 'react.shape', willCrashApp: false })
+		},
+		[editor]
+	)
+
 	if (!shape) return null
 
 	const util = editor.getShapeUtil(shape)
@@ -108,12 +115,7 @@ export const Shape = track(function Shape({
 					draggable={false}
 				>
 					{!isCulled && (
-						<OptionalErrorBoundary
-							fallback={ShapeErrorFallback ? (error) => <ShapeErrorFallback error={error} /> : null}
-							onError={(error) =>
-								editor.annotateError(error, { origin: 'react.shape', willCrashApp: false })
-							}
-						>
+						<OptionalErrorBoundary fallback={ShapeErrorFallback} onError={annotateError}>
 							<InnerShapeBackground shape={shape} util={util} />
 						</OptionalErrorBoundary>
 					)}
@@ -133,12 +135,7 @@ export const Shape = track(function Shape({
 				{isCulled && util.canUnmount(shape) ? (
 					<CulledShape shape={shape} />
 				) : (
-					<OptionalErrorBoundary
-						fallback={ShapeErrorFallback ? (error) => <ShapeErrorFallback error={error} /> : null}
-						onError={(error) =>
-							editor.annotateError(error, { origin: 'react.shape', willCrashApp: false })
-						}
-					>
+					<OptionalErrorBoundary fallback={ShapeErrorFallback} onError={annotateError}>
 						<InnerShape shape={shape} util={util} />
 					</OptionalErrorBoundary>
 				)}

commit fd29006538ab2e01b7d6c1275ac6d164e676398f
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Wed Jun 28 15:24:05 2023 +0100

    [feature] add `meta` property to records (#1627)
    
    This PR adds a `meta` property to shapes and other records.
    
    It adds it to:
    - asset
    - camera
    - document
    - instance
    - instancePageState
    - instancePresence
    - page
    - pointer
    - rootShape
    
    ## Setting meta
    
    This data can generally be added wherever you would normally update the
    corresponding record.
    
    An exception exists for shapes, which can be updated using a partial of
    the `meta` in the same way that we update shapes with a partial of
    `props`.
    
    ```ts
    this.updateShapes([{
        id: myShape.id,
        type: "geo",
        meta: {
          nemesis: "steve",
          special: true
        }
    ])
    ```
    
    ## `Editor.getInitialMetaForShape`
    
    The `Editor.getInitialMetaForShape` method is kind of a hack to set the
    initial meta property for newly created shapes. You can set it
    externally. Escape hatch!
    
    ### Change Type
    
    - [x] `minor` ‚Äî New feature
    
    ### Test Plan
    
    todo
    
    - [ ] Unit Tests (todo)
    
    ### Release Notes
    
    - todo

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index 4fe691e82..832dab66a 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -148,7 +148,7 @@ const InnerShape = React.memo(
 	function InnerShape<T extends TLShape>({ shape, util }: { shape: T; util: ShapeUtil<T> }) {
 		return useStateTracking('InnerShape:' + util.type, () => util.component(shape))
 	},
-	(prev, next) => prev.shape.props === next.shape.props
+	(prev, next) => prev.shape.props === next.shape.props || prev.shape.meta === next.shape.meta
 )
 
 const InnerShapeBackground = React.memo(
@@ -161,7 +161,7 @@ const InnerShapeBackground = React.memo(
 	}) {
 		return useStateTracking('InnerShape:' + util.type, () => util.backgroundComponent?.(shape))
 	},
-	(prev, next) => prev.shape.props === next.shape.props
+	(prev, next) => prev.shape.props === next.shape.props || prev.shape.meta === next.shape.meta
 )
 
 const CulledShape = React.memo(

commit 81ee3381bfd174120b96732f7ba6471d5865466c
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Thu Jun 29 11:13:50 2023 +0100

    [fix] Shape rendering (#1670)
    
    This PR fixes shape rendering logic. Remember! memo's 2nd argument
    returns "when should we NOT render" not "when should we render"
    
    ### Change Type
    
    - [x] `patch`
    
    ### Test Plan
    
    1. Use the draw tool

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index 832dab66a..8597fed5a 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -148,7 +148,7 @@ const InnerShape = React.memo(
 	function InnerShape<T extends TLShape>({ shape, util }: { shape: T; util: ShapeUtil<T> }) {
 		return useStateTracking('InnerShape:' + util.type, () => util.component(shape))
 	},
-	(prev, next) => prev.shape.props === next.shape.props || prev.shape.meta === next.shape.meta
+	(prev, next) => prev.shape.props === next.shape.props && prev.shape.meta === next.shape.meta
 )
 
 const InnerShapeBackground = React.memo(
@@ -161,7 +161,7 @@ const InnerShapeBackground = React.memo(
 	}) {
 		return useStateTracking('InnerShape:' + util.type, () => util.backgroundComponent?.(shape))
 	},
-	(prev, next) => prev.shape.props === next.shape.props || prev.shape.meta === next.shape.meta
+	(prev, next) => prev.shape.props === next.shape.props && prev.shape.meta === next.shape.meta
 )
 
 const CulledShape = React.memo(

commit b7d9c8684cb6cf7bd710af5420135ea3516cc3bf
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon Jul 17 22:22:34 2023 +0100

    tldraw zero - package shuffle (#1710)
    
    This PR moves code between our packages so that:
    - @tldraw/editor is a ‚Äúcore‚Äù library with the engine and canvas but no
    shapes, tools, or other things
    - @tldraw/tldraw contains everything particular to the experience we‚Äôve
    built for tldraw
    
    At first look, this might seem like a step away from customization and
    configuration, however I believe it greatly increases the configuration
    potential of the @tldraw/editor while also providing a more accurate
    reflection of what configuration options actually exist for
    @tldraw/tldraw.
    
    ## Library changes
    
    @tldraw/editor re-exports its dependencies and @tldraw/tldraw re-exports
    @tldraw/editor.
    
    - users of @tldraw/editor WITHOUT @tldraw/tldraw should almost always
    only import things from @tldraw/editor.
    - users of @tldraw/tldraw should almost always only import things from
    @tldraw/tldraw.
    
    - @tldraw/polyfills is merged into @tldraw/editor
    - @tldraw/indices is merged into @tldraw/editor
    - @tldraw/primitives is merged mostly into @tldraw/editor, partially
    into @tldraw/tldraw
    - @tldraw/file-format is merged into @tldraw/tldraw
    - @tldraw/ui is merged into @tldraw/tldraw
    
    Many (many) utils and other code is moved from the editor to tldraw. For
    example, embeds now are entirely an feature of @tldraw/tldraw. The only
    big chunk of code left in core is related to arrow handling.
    
    ## API Changes
    
    The editor can now be used without tldraw's assets. We load them in
    @tldraw/tldraw instead, so feel free to use whatever fonts or images or
    whatever that you like with the editor.
    
    All tools and shapes (except for the `Group` shape) are moved to
    @tldraw/tldraw. This includes the `select` tool.
    
    You should use the editor with at least one tool, however, so you now
    also need to send in an `initialState` prop to the Editor /
    <TldrawEditor> component indicating which state the editor should begin
    in.
    
    The `components` prop now also accepts `SelectionForeground`.
    
    The complex selection component that we use for tldraw is moved to
    @tldraw/tldraw. The default component is quite basic but can easily be
    replaced via the `components` prop. We pass down our tldraw-flavored
    SelectionFg via `components`.
    
    Likewise with the `Scribble` component: the `DefaultScribble` no longer
    uses our freehand tech and is a simple path instead. We pass down the
    tldraw-flavored scribble via `components`.
    
    The `ExternalContentManager` (`Editor.externalContentManager`) is
    removed and replaced with a mapping of types to handlers.
    
    - Register new content handlers with
    `Editor.registerExternalContentHandler`.
    - Register new asset creation handlers (for files and URLs) with
    `Editor.registerExternalAssetHandler`
    
    ### Change Type
    
    - [x] `major` ‚Äî Breaking change
    
    ### Test Plan
    
    - [x] Unit Tests
    - [x] End to end tests
    
    ### Release Notes
    
    - [@tldraw/editor] lots, wip
    - [@tldraw/ui] gone, merged to tldraw/tldraw
    - [@tldraw/polyfills] gone, merged to tldraw/editor
    - [@tldraw/primitives] gone, merged to tldraw/editor / tldraw/tldraw
    - [@tldraw/indices] gone, merged to tldraw/editor
    - [@tldraw/file-format] gone, merged to tldraw/tldraw
    
    ---------
    
    Co-authored-by: alex <alex@dytry.ch>

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index 8597fed5a..910749cf1 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -1,11 +1,11 @@
-import { Matrix2d } from '@tldraw/primitives'
 import { track, useQuickReactor, useStateTracking } from '@tldraw/state'
 import { TLShape, TLShapeId } from '@tldraw/tlschema'
 import * as React from 'react'
-import { useEditor } from '../..'
 import { ShapeUtil } from '../editor/shapes/ShapeUtil'
+import { useEditor } from '../hooks/useEditor'
 import { useEditorComponents } from '../hooks/useEditorComponents'
 import { useShapeEvents } from '../hooks/useShapeEvents'
+import { Matrix2d } from '../primitives/Matrix2d'
 import { OptionalErrorBoundary } from './ErrorBoundary'
 
 /*
@@ -135,7 +135,7 @@ export const Shape = track(function Shape({
 				{isCulled && util.canUnmount(shape) ? (
 					<CulledShape shape={shape} />
 				) : (
-					<OptionalErrorBoundary fallback={ShapeErrorFallback} onError={annotateError}>
+					<OptionalErrorBoundary fallback={ShapeErrorFallback as any} onError={annotateError}>
 						<InnerShape shape={shape} util={util} />
 					</OptionalErrorBoundary>
 				)}
@@ -146,7 +146,7 @@ export const Shape = track(function Shape({
 
 const InnerShape = React.memo(
 	function InnerShape<T extends TLShape>({ shape, util }: { shape: T; util: ShapeUtil<T> }) {
-		return useStateTracking('InnerShape:' + util.type, () => util.component(shape))
+		return useStateTracking('InnerShape:' + shape.type, () => util.component(shape))
 	},
 	(prev, next) => prev.shape.props === next.shape.props && prev.shape.meta === next.shape.meta
 )
@@ -159,7 +159,7 @@ const InnerShapeBackground = React.memo(
 		shape: T
 		util: ShapeUtil<T>
 	}) {
-		return useStateTracking('InnerShape:' + util.type, () => util.backgroundComponent?.(shape))
+		return useStateTracking('InnerShape:' + shape.type, () => util.backgroundComponent?.(shape))
 	},
 	(prev, next) => prev.shape.props === next.shape.props && prev.shape.meta === next.shape.meta
 )

commit d750da8f40efda4b011a91962ef8f30c63d1e5da
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Tue Jul 25 17:10:15 2023 +0100

    `ShapeUtil.getGeometry`, selection rewrite (#1751)
    
    This PR is a significant rewrite of our selection / hit testing logic.
    
    It
    - replaces our current geometric helpers (`getBounds`, `getOutline`,
    `hitTestPoint`, and `hitTestLineSegment`) with a new geometry API
    - moves our hit testing entirely to JS using geometry
    - improves selection logic, especially around editing shapes, groups and
    frames
    - fixes many minor selection bugs (e.g. shapes behind frames)
    - removes hit-testing DOM elements from ShapeFill etc.
    - adds many new tests around selection
    - adds new tests around selection
    - makes several superficial changes to surface editor APIs
    
    This PR is hard to evaluate. The `selection-omnibus` test suite is
    intended to describe all of the selection behavior, however all existing
    tests are also either here preserved and passing or (in a few cases
    around editing shapes) are modified to reflect the new behavior.
    
    ## Geometry
    
    All `ShapeUtils` implement `getGeometry`, which returns a single
    geometry primitive (`Geometry2d`). For example:
    
    ```ts
    class BoxyShapeUtil {
      getGeometry(shape: BoxyShape) {
        return new Rectangle2d({
            width: shape.props.width,
            height: shape.props.height,
            isFilled: true,
            margin: shape.props.strokeWidth
          })
        }
    }
    ```
    
    This geometric primitive is used for all bounds calculation, hit
    testing, intersection with arrows, etc.
    
    There are several geometric primitives that extend `Geometry2d`:
    - `Arc2d`
    - `Circle2d`
    - `CubicBezier2d`
    - `CubicSpline2d`
    - `Edge2d`
    - `Ellipse2d`
    - `Group2d`
    - `Polygon2d`
    - `Rectangle2d`
    - `Stadium2d`
    
    For shapes that have more complicated geometric representations, such as
    an arrow with a label, the `Group2d` can accept other primitives as its
    children.
    
    ## Hit testing
    
    Previously, we did all hit testing via events set on shapes and other
    elements. In this PR, I've replaced those hit tests with our own
    calculation for hit tests in JavaScript. This removed the need for many
    DOM elements, such as hit test area borders and fills which only existed
    to trigger pointer events.
    
    ## Selection
    
    We now support selecting "hollow" shapes by clicking inside of them.
    This involves a lot of new logic but it should work intuitively. See
    `Editor.getShapeAtPoint` for the (thoroughly commented) implementation.
    
    ![Kapture 2023-07-23 at 23 27
    27](https://github.com/tldraw/tldraw/assets/23072548/a743275c-acdb-42d9-a3fe-b3e20dce86b6)
    
    every sunset is actually the sun hiding in fear and respect of tldraw's
    quality of interactions
    
    This PR also fixes several bugs with scribble selection, in particular
    around the shift key modifier.
    
    ![Kapture 2023-07-24 at 23 34
    07](https://github.com/tldraw/tldraw/assets/23072548/871d67d0-8d06-42ae-a2b2-021effba37c5)
    
    ...as well as issues with labels and editing.
    
    There are **over 100 new tests** for selection covering groups, frames,
    brushing, scribbling, hovering, and editing. I'll add a few more before
    I feel comfortable merging this PR.
    
    ## Arrow binding
    
    Using the same "hollow shape" logic as selection, arrow binding is
    significantly improved.
    
    ![Kapture 2023-07-22 at 07 46
    25](https://github.com/tldraw/tldraw/assets/23072548/5aa724b3-b57d-4fb7-92d0-80e34246753c)
    
    a thousand wise men could not improve on this
    
    ## Moving focus between editing shapes
    
    Previously, this was handled in the `editing_shapes` state. This is
    moved to `useEditableText`, and should generally be considered an
    advanced implementation detail on a shape-by-shape basis. This addresses
    a bug that I'd never noticed before, but which can be reproduced by
    selecting an shape‚Äîbut not focusing its input‚Äîwhile editing a different
    shape. Previously, the new shape became the editing shape but its input
    did not focus.
    
    ![Kapture 2023-07-23 at 23 19
    09](https://github.com/tldraw/tldraw/assets/23072548/a5e157fb-24a8-42bd-a692-04ce769b1a9c)
    
    In this PR, you can select a shape by clicking on its edge or body, or
    select its input to transfer editing / focus.
    
    ![Kapture 2023-07-23 at 23 22
    21](https://github.com/tldraw/tldraw/assets/23072548/7384e7ea-9777-4e1a-8f63-15de2166a53a)
    
    tldraw, glorious tldraw
    
    ### Change Type
    
    - [x] `major` ‚Äî Breaking change
    
    ### Test Plan
    
    1. Erase shapes
    2. Select shapes
    3. Calculate their bounding boxes
    
    - [ ] Unit Tests // todo
    - [ ] End to end tests // todo
    
    ### Release Notes
    
    - [editor] Remove `ShapeUtil.getBounds`, `ShapeUtil.getOutline`,
    `ShapeUtil.hitTestPoint`, `ShapeUtil.hitTestLineSegment`
    - [editor] Add `ShapeUtil.getGeometry`
    - [editor] Add `Editor.getShapeGeometry`

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index 910749cf1..c29121b79 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -4,7 +4,6 @@ import * as React from 'react'
 import { ShapeUtil } from '../editor/shapes/ShapeUtil'
 import { useEditor } from '../hooks/useEditor'
 import { useEditorComponents } from '../hooks/useEditorComponents'
-import { useShapeEvents } from '../hooks/useShapeEvents'
 import { Matrix2d } from '../primitives/Matrix2d'
 import { OptionalErrorBoundary } from './ErrorBoundary'
 
@@ -21,12 +20,16 @@ opacity based on its own opacity and that of its parent's.
 */
 export const Shape = track(function Shape({
 	id,
+	shape,
+	util,
 	index,
 	backgroundIndex,
 	opacity,
 	isCulled,
 }: {
 	id: TLShapeId
+	shape: TLShape
+	util: ShapeUtil
 	index: number
 	backgroundIndex: number
 	opacity: number
@@ -36,8 +39,6 @@ export const Shape = track(function Shape({
 
 	const { ShapeErrorFallback } = useEditorComponents()
 
-	const events = useShapeEvents(id)
-
 	const containerRef = React.useRef<HTMLDivElement>(null)
 	const backgroundContainerRef = React.useRef<HTMLDivElement>(null)
 
@@ -49,11 +50,10 @@ export const Shape = track(function Shape({
 	useQuickReactor(
 		'set shape container transform position',
 		() => {
-			const shape = editor.getShapeById(id)
-			const pageTransform = editor.getPageTransformById(id)
-
-			if (!shape || !pageTransform) return null
+			const shape = editor.getShape(id)
+			if (!shape) return // probably the shape was just deleted
 
+			const pageTransform = editor.getPageTransform(id)
 			const transform = Matrix2d.toCssString(pageTransform)
 			setProperty('transform', transform)
 		},
@@ -63,10 +63,10 @@ export const Shape = track(function Shape({
 	useQuickReactor(
 		'set shape container clip path',
 		() => {
-			const shape = editor.getShapeById(id)
+			const shape = editor.getShape(id)
 			if (!shape) return null
 
-			const clipPath = editor.getClipPathById(id)
+			const clipPath = editor.getClipPath(id)
 			setProperty('clip-path', clipPath ?? 'none')
 		},
 		[editor, setProperty]
@@ -75,12 +75,12 @@ export const Shape = track(function Shape({
 	useQuickReactor(
 		'set shape height and width',
 		() => {
-			const shape = editor.getShapeById(id)
+			const shape = editor.getShape(id)
 			if (!shape) return null
 
-			const bounds = editor.getBounds(shape)
-			setProperty('width', Math.ceil(bounds.width) + 'px')
-			setProperty('height', Math.ceil(bounds.height) + 'px')
+			const bounds = editor.getGeometry(shape).bounds
+			setProperty('width', Math.max(1, Math.ceil(bounds.width)) + 'px')
+			setProperty('height', Math.max(1, Math.ceil(bounds.height)) + 'px')
 		},
 		[editor]
 	)
@@ -92,7 +92,7 @@ export const Shape = track(function Shape({
 		backgroundContainerRef.current?.style.setProperty('z-index', backgroundIndex + '')
 	}, [opacity, index, backgroundIndex, setProperty])
 
-	const shape = editor.getShapeById(id)
+	// const shape = editor.getShape(id)
 
 	const annotateError = React.useCallback(
 		(error: any) => {
@@ -103,8 +103,6 @@ export const Shape = track(function Shape({
 
 	if (!shape) return null
 
-	const util = editor.getShapeUtil(shape)
-
 	return (
 		<>
 			{util.backgroundComponent && (
@@ -121,17 +119,7 @@ export const Shape = track(function Shape({
 					)}
 				</div>
 			)}
-			<div
-				ref={containerRef}
-				className="tl-shape"
-				data-shape-type={shape.type}
-				draggable={false}
-				onPointerDown={events.onPointerDown}
-				onPointerMove={events.onPointerMove}
-				onPointerUp={events.onPointerUp}
-				onPointerEnter={events.onPointerEnter}
-				onPointerLeave={events.onPointerLeave}
-			>
+			<div ref={containerRef} className="tl-shape" data-shape-type={shape.type} draggable={false}>
 				{isCulled && util.canUnmount(shape) ? (
 					<CulledShape shape={shape} />
 				) : (
@@ -167,15 +155,15 @@ const InnerShapeBackground = React.memo(
 const CulledShape = React.memo(
 	function CulledShape<T extends TLShape>({ shape }: { shape: T }) {
 		const editor = useEditor()
-		const bounds = editor.getBounds(shape)
+		const bounds = editor.getGeometry(shape).bounds
 
 		return (
 			<div
 				className="tl-shape__culled"
 				style={{
 					transform: `translate(${bounds.minX}px, ${bounds.minY}px)`,
-					width: bounds.width,
-					height: bounds.height,
+					width: Math.max(1, bounds.width),
+					height: Math.max(1, bounds.height),
 				}}
 			/>
 		)

commit bf277435951a1e7fa5689414670ff1866e721b50
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Wed Aug 2 19:12:25 2023 +0100

    Rename shapes apis (#1787)
    
    This PR updates APIs related to shapes in the Editor.
    
    - removes the requirement for an `id` when creating shapes
    - `shapesOnCurrentPage` -> `currentPageShapes`
    - `findAncestor` -> `findShapeAncestor`
    - `findCommonAncestor` -> `findCommonShapeAncestor`
    - Adds `getCurrentPageShapeIds`
    - `getAncestors` -> `getShapeAncestors`
    - `getClipPath` -> `getShapeClipPath`
    - `getGeometry` -> `getShapeGeometry`
    - `getHandles` -> `getShapeHandles`
    - `getTransform` -> `getShapeLocalTransform`
    - `getPageTransform` -> `getShapePageTransform`
    - `getOutlineSegments` -> `getShapeOutlineSegments`
    - `getPageBounds` -> `getShapePageBounds`
    - `getPageTransform` -> `getShapePageTransform`
    - `getParentTransform` -> `getShapeParentTransform`
    - `selectionBounds` -> `selectionRotatedPageBounds`
    
    ### Change Type
    
    - [x] `major` ‚Äî Breaking change
    
    ### Test Plan
    
    - [x] Unit Tests

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index c29121b79..820632ed7 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -53,7 +53,7 @@ export const Shape = track(function Shape({
 			const shape = editor.getShape(id)
 			if (!shape) return // probably the shape was just deleted
 
-			const pageTransform = editor.getPageTransform(id)
+			const pageTransform = editor.getShapePageTransform(id)
 			const transform = Matrix2d.toCssString(pageTransform)
 			setProperty('transform', transform)
 		},
@@ -66,7 +66,7 @@ export const Shape = track(function Shape({
 			const shape = editor.getShape(id)
 			if (!shape) return null
 
-			const clipPath = editor.getClipPath(id)
+			const clipPath = editor.getShapeClipPath(id)
 			setProperty('clip-path', clipPath ?? 'none')
 		},
 		[editor, setProperty]
@@ -78,7 +78,7 @@ export const Shape = track(function Shape({
 			const shape = editor.getShape(id)
 			if (!shape) return null
 
-			const bounds = editor.getGeometry(shape).bounds
+			const bounds = editor.getShapeGeometry(shape).bounds
 			setProperty('width', Math.max(1, Math.ceil(bounds.width)) + 'px')
 			setProperty('height', Math.max(1, Math.ceil(bounds.height)) + 'px')
 		},
@@ -155,7 +155,7 @@ const InnerShapeBackground = React.memo(
 const CulledShape = React.memo(
 	function CulledShape<T extends TLShape>({ shape }: { shape: T }) {
 		const editor = useEditor()
-		const bounds = editor.getGeometry(shape).bounds
+		const bounds = editor.getShapeGeometry(shape).bounds
 
 		return (
 			<div

commit e4829f67023df6097d06eef484305ca0c0faee44
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Thu Aug 3 08:37:15 2023 +0100

    Custom rendering margin / don't cull selected shapes (#1788)
    
    This PR:
    - supports client configuration of the rendering bounds via
    `Editor.renderingBoundsMargin`
    - no longer culls selected shapes
    - restores rendering shape tests accidentally removed in #1786
    
    ### Change Type
    
    - [x] `patch` ‚Äî Bug fix
    
    ### Test Plan
    
    1. Select shapes, scroll quickly to see if they get culled
    
    - [x] Unit Tests
    
    ### Release Notes
    
    - [editor] add `Editor.renderingBoundsMargin`

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index 820632ed7..5bb2490ef 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -92,8 +92,6 @@ export const Shape = track(function Shape({
 		backgroundContainerRef.current?.style.setProperty('z-index', backgroundIndex + '')
 	}, [opacity, index, backgroundIndex, setProperty])
 
-	// const shape = editor.getShape(id)
-
 	const annotateError = React.useCallback(
 		(error: any) => {
 			editor.annotateError(error, { origin: 'react.shape', willCrashApp: false })
@@ -120,7 +118,7 @@ export const Shape = track(function Shape({
 				</div>
 			)}
 			<div ref={containerRef} className="tl-shape" data-shape-type={shape.type} draggable={false}>
-				{isCulled && util.canUnmount(shape) ? (
+				{isCulled ? (
 					<CulledShape shape={shape} />
 				) : (
 					<OptionalErrorBoundary fallback={ShapeErrorFallback as any} onError={annotateError}>

commit f21eaeb4d803da95d12aeaa29e810a0d588b8709
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Fri Sep 8 15:45:30 2023 +0100

    [fix] zero width / height bounds (#1840)
    
    This PR fixes zero width or height on Geometry2d bounds. It adds the
    `zeroFix` helper to the `Box2d` class.
    
    ### Change Type
    
    - [x] `patch` ‚Äî Bug fix
    
    ### Test Plan
    
    1. Create a straight line
    2. Create a straight arrow that binds to the straight line
    
    - [x] Unit Tests
    
    ### Release Notes
    
    - Fix bug with straight lines / arrows

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index 5bb2490ef..0efc80b77 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -79,8 +79,8 @@ export const Shape = track(function Shape({
 			if (!shape) return null
 
 			const bounds = editor.getShapeGeometry(shape).bounds
-			setProperty('width', Math.max(1, Math.ceil(bounds.width)) + 'px')
-			setProperty('height', Math.max(1, Math.ceil(bounds.height)) + 'px')
+			setProperty('width', Math.max(1, bounds.width) + 'px')
+			setProperty('height', Math.max(1, bounds.height) + 'px')
 		},
 		[editor]
 	)

commit 1b8c15316a38545beb44e89ad8a1950b0b1b7f97
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Mon Sep 18 17:17:49 2023 +0100

    Fix line wobble (#1915)
    
    Closes #1911
    
    ### Change Type
    
    - [x] `patch` ‚Äî Bug fix
    - [ ] `minor` ‚Äî New feature
    - [ ] `major` ‚Äî Breaking change
    - [ ] `dependencies` ‚Äî Changes to package dependencies[^1]
    - [ ] `documentation` ‚Äî Changes to the documentation only[^2]
    - [ ] `tests` ‚Äî Changes to any test code only[^2]
    - [ ] `internal` ‚Äî Any other changes that don't affect the published
    package[^2]
    - [ ] I don't know
    
    [^1]: publishes a `patch` release, for devDependencies use `internal`
    [^2]: will not publish a new version
    
    ### Test Plan
    
    1. Add a step-by-step description of how to test your PR here.
    2.
    
    - [ ] Unit Tests
    - [ ] End to end tests
    
    ### Release Notes
    
    - Fixes an issue where lines would wobble as you dragged the handles
    around

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index 0efc80b77..1afff7830 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -79,8 +79,14 @@ export const Shape = track(function Shape({
 			if (!shape) return null
 
 			const bounds = editor.getShapeGeometry(shape).bounds
-			setProperty('width', Math.max(1, bounds.width) + 'px')
-			setProperty('height', Math.max(1, bounds.height) + 'px')
+			setProperty(
+				'width',
+				`calc(${Math.max(1, Math.ceil(bounds.width)) + 'px'} * var(--tl-dpr-multiple))`
+			)
+			setProperty(
+				'height',
+				`calc(${Math.max(1, Math.ceil(bounds.height)) + 'px'} * var(--tl-dpr-multiple))`
+			)
 		},
 		[editor]
 	)

commit 0e621e3de1d2b75cb919f4b915ba9af4b84bec0b
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Tue Sep 19 14:14:51 2023 +0100

    Use smarter rounding for shape container div width/height (#1930)
    
    This is a follow up to #1915 which caused the shape container div
    dimensions to be wildly inaccurate. We thought it wouldn't matter but we
    had a note on discord from someone who was relying on the div container
    being accurate.
    
    This rounds the shape dimensions to the nearest integer that is
    compatible with the user's device pixel ratio, using the method
    pioneered in #1858 (thanks @BrianHung)
    
    ### Change Type
    
    - [x] `patch` ‚Äî Bug fix
    - [ ] `minor` ‚Äî New feature
    - [ ] `major` ‚Äî Breaking change
    - [ ] `dependencies` ‚Äî Changes to package dependencies[^1]
    - [ ] `documentation` ‚Äî Changes to the documentation only[^2]
    - [ ] `tests` ‚Äî Changes to any test code only[^2]
    - [ ] `internal` ‚Äî Any other changes that don't affect the published
    package[^2]
    - [ ] I don't know
    
    [^1]: publishes a `patch` release, for devDependencies use `internal`
    [^2]: will not publish a new version
    
    
    ### Release Notes
    
    - Improves the precision of the shape dimensions rounding logic

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index 1afff7830..ef7f8b8c9 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -2,6 +2,7 @@ import { track, useQuickReactor, useStateTracking } from '@tldraw/state'
 import { TLShape, TLShapeId } from '@tldraw/tlschema'
 import * as React from 'react'
 import { ShapeUtil } from '../editor/shapes/ShapeUtil'
+import { nearestMultiple } from '../hooks/useDPRMultiple'
 import { useEditor } from '../hooks/useEditor'
 import { useEditorComponents } from '../hooks/useEditorComponents'
 import { Matrix2d } from '../primitives/Matrix2d'
@@ -79,14 +80,18 @@ export const Shape = track(function Shape({
 			if (!shape) return null
 
 			const bounds = editor.getShapeGeometry(shape).bounds
-			setProperty(
-				'width',
-				`calc(${Math.max(1, Math.ceil(bounds.width)) + 'px'} * var(--tl-dpr-multiple))`
-			)
-			setProperty(
-				'height',
-				`calc(${Math.max(1, Math.ceil(bounds.height)) + 'px'} * var(--tl-dpr-multiple))`
-			)
+			const dpr = editor.instanceState.devicePixelRatio
+			// dprMultiple is the smallest number we can multiply dpr by to get an integer
+			// it's usually 1, 2, or 4 (for e.g. dpr of 2, 2.5 and 2.25 respectively)
+			const dprMultiple = nearestMultiple(dpr)
+			// We round the shape width and height up to the nearest multiple of dprMultiple to avoid the browser
+			// making miscalculations when applying the transform.
+			const widthRemainder = bounds.w % dprMultiple
+			const width = widthRemainder === 0 ? bounds.w : bounds.w + (dprMultiple - widthRemainder)
+			const heightRemainder = bounds.h % dprMultiple
+			const height = heightRemainder === 0 ? bounds.h : bounds.h + (dprMultiple - heightRemainder)
+			setProperty('width', Math.max(width, dprMultiple) + 'px')
+			setProperty('height', Math.max(height, dprMultiple) + 'px')
 		},
 		[editor]
 	)

commit 9e4dbd19013ccbae28a112929cf5e50474e5028f
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Tue Sep 26 09:05:05 2023 -0500

    [fix] geo shape text label placement (#1927)
    
    This PR fixes the text label placement for geo shapes. (It also fixes
    the way an ellipse renders when set to dash or dotted).
    
    There's still the slightest offset of the text label's outline when you
    begin editing. Maybe we should keep the indicator instead?
    
    ### Change Type
    
    - [x] `patch` ‚Äî Bug fix
    
    ### Test Plan
    
    Create a hexagon shape
    hit enter to type
    indicator is offset, text label is no longer offset
    
    ---------
    
    Co-authored-by: David Sheldrick <d.j.sheldrick@gmail.com>

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index ef7f8b8c9..e9f948739 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -6,6 +6,7 @@ import { nearestMultiple } from '../hooks/useDPRMultiple'
 import { useEditor } from '../hooks/useEditor'
 import { useEditorComponents } from '../hooks/useEditorComponents'
 import { Matrix2d } from '../primitives/Matrix2d'
+import { toDomPrecision } from '../primitives/utils'
 import { OptionalErrorBoundary } from './ErrorBoundary'
 
 /*
@@ -170,9 +171,11 @@ const CulledShape = React.memo(
 			<div
 				className="tl-shape__culled"
 				style={{
-					transform: `translate(${bounds.minX}px, ${bounds.minY}px)`,
-					width: Math.max(1, bounds.width),
-					height: Math.max(1, bounds.height),
+					transform: `translate(${toDomPrecision(bounds.minX)}px, ${toDomPrecision(
+						bounds.minY
+					)}px)`,
+					width: Math.max(1, toDomPrecision(bounds.width)),
+					height: Math.max(1, toDomPrecision(bounds.height)),
 				}}
 			/>
 		)

commit 647977ceecd08f662c3b6c72014d0014fea8b75c
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Wed Oct 4 16:46:59 2023 +0100

    frame label fix (#2016)
    
    Frame labels lost their editing outline at some point. ü§∑üèº any idea how
    this happened?
    
    ## Before
    ![Kapture 2023-10-04 at 13 47
    28](https://github.com/tldraw/tldraw/assets/1242537/5da612e3-6456-493d-a4d7-4a5b953284bb)
    
    ## After
    ![Kapture 2023-10-04 at 13 49
    55](https://github.com/tldraw/tldraw/assets/1242537/1608af3b-aac8-4f1c-8a9b-09aab19b07fb)
    
    
    ### Change Type
    
    - [x] `patch` ‚Äî Bug fix
    - [ ] `minor` ‚Äî New feature
    - [ ] `major` ‚Äî Breaking change
    - [ ] `dependencies` ‚Äî Changes to package dependencies[^1]
    - [ ] `documentation` ‚Äî Changes to the documentation only[^2]
    - [ ] `tests` ‚Äî Changes to any test code only[^2]
    - [ ] `internal` ‚Äî Any other changes that don't affect the published
    package[^2]
    - [ ] I don't know
    
    [^1]: publishes a `patch` release, for devDependencies use `internal`
    [^2]: will not publish a new version
    
    ### Test Plan
    
    1. Add a step-by-step description of how to test your PR here.
    2.
    
    - [ ] Unit Tests
    - [ ] End to end tests
    
    ### Release Notes
    
    - Add a brief release note for your PR here.

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index e9f948739..7c2b7f483 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -81,7 +81,7 @@ export const Shape = track(function Shape({
 			if (!shape) return null
 
 			const bounds = editor.getShapeGeometry(shape).bounds
-			const dpr = editor.instanceState.devicePixelRatio
+			const dpr = Math.floor(editor.instanceState.devicePixelRatio * 100) / 100
 			// dprMultiple is the smallest number we can multiply dpr by to get an integer
 			// it's usually 1, 2, or 4 (for e.g. dpr of 2, 2.5 and 2.25 respectively)
 			const dprMultiple = nearestMultiple(dpr)

commit 5db3c1553e14edd14aa5f7c0fc85fc5efc352335
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon Nov 13 11:51:22 2023 +0000

    Replace Atom.value with Atom.get() (#2189)
    
    This PR replaces the `.value` getter for the atom with `.get()`
    
    ### Change Type
    
    - [x] `major` ‚Äî Breaking change
    
    ---------
    
    Co-authored-by: David Sheldrick <d.j.sheldrick@gmail.com>

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index 7c2b7f483..5283101c5 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -81,7 +81,7 @@ export const Shape = track(function Shape({
 			if (!shape) return null
 
 			const bounds = editor.getShapeGeometry(shape).bounds
-			const dpr = Math.floor(editor.instanceState.devicePixelRatio * 100) / 100
+			const dpr = Math.floor(editor.getInstanceState().devicePixelRatio * 100) / 100
 			// dprMultiple is the smallest number we can multiply dpr by to get an integer
 			// it's usually 1, 2, or 4 (for e.g. dpr of 2, 2.5 and 2.25 respectively)
 			const dprMultiple = nearestMultiple(dpr)

commit 0cf6a1e4642e080278c7b908e63294da918d22dd
Author: Mitja Bezen≈°ek <mitja.bezensek@gmail.com>
Date:   Wed Dec 6 17:19:57 2023 +0100

    Fix an issue with a stale editor reference in shape utils (#2295)
    
    Fixes an issue where the editor reference in shape utils was not up to
    date with the editor returned from `useEditor`. Actually, the whole util
    was the incorrect one and was holding a reference to the previous
    instantiation of the editor.
    
    This only occurred in dev mode, but could also happen in other cases
    where editor is created multiple times. To see the kinds of issues this
    causes in dev mode you can do the following:
    1. Create an image, crop it.
    2. Refresh the page.
    3. Select the image, then double click it to enter crop mode.
    4. You will not see the cropped area of the image. You need to change
    the crop slightly and then it suddenly appears. This is because this
    changes props, which reruns the memoized function.
    
    Fixes https://github.com/tldraw/tldraw/issues/2284
    
    ### Change Type
    
    - [x] `patch` ‚Äî Bug fix
    - [ ] `minor` ‚Äî New feature
    - [ ] `major` ‚Äî Breaking change
    - [ ] `dependencies` ‚Äî Changes to package dependencies[^1]
    - [ ] `documentation` ‚Äî Changes to the documentation only[^2]
    - [ ] `tests` ‚Äî Changes to any test code only[^2]
    - [ ] `internal` ‚Äî Any other changes that don't affect the published
    package[^2]
    - [ ] I don't know
    
    [^1]: publishes a `patch` release, for devDependencies use `internal`
    [^2]: will not publish a new version
    
    ### Release Notes
    
    - Fix an issue where the shape utils could have a stale reference to the
    editor.

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index 5283101c5..f74a24819 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -146,7 +146,10 @@ const InnerShape = React.memo(
 	function InnerShape<T extends TLShape>({ shape, util }: { shape: T; util: ShapeUtil<T> }) {
 		return useStateTracking('InnerShape:' + shape.type, () => util.component(shape))
 	},
-	(prev, next) => prev.shape.props === next.shape.props && prev.shape.meta === next.shape.meta
+	(prev, next) =>
+		prev.shape.props === next.shape.props &&
+		prev.shape.meta === next.shape.meta &&
+		prev.util === next.util
 )
 
 const InnerShapeBackground = React.memo(

commit 6b1005ef71a63613a09606310f666487547d5f23
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Wed Jan 3 12:13:15 2024 +0000

    [tech debt] Primitives renaming party / cleanup (#2396)
    
    This PR:
    - renames Vec2d to Vec
    - renames Vec2dModel to VecModel
    - renames Box2d to Box
    - renames Box2dModel to BoxModel
    - renames Matrix2d to Mat
    - renames Matrix2dModel to MatModel
    - removes unused primitive helpers
    - removes unused exports
    - removes a few redundant tests in dgreensp
    
    ### Change Type
    
    - [x] `major` ‚Äî Breaking change
    
    ### Release Notes
    
    - renames Vec2d to Vec
    - renames Vec2dModel to VecModel
    - renames Box2d to Box
    - renames Box2dModel to BoxModel
    - renames Matrix2d to Mat
    - renames Matrix2dModel to MatModel
    - removes unused primitive helpers

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index f74a24819..3e1f772f4 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -5,7 +5,7 @@ import { ShapeUtil } from '../editor/shapes/ShapeUtil'
 import { nearestMultiple } from '../hooks/useDPRMultiple'
 import { useEditor } from '../hooks/useEditor'
 import { useEditorComponents } from '../hooks/useEditorComponents'
-import { Matrix2d } from '../primitives/Matrix2d'
+import { Mat } from '../primitives/Mat'
 import { toDomPrecision } from '../primitives/utils'
 import { OptionalErrorBoundary } from './ErrorBoundary'
 
@@ -56,7 +56,7 @@ export const Shape = track(function Shape({
 			if (!shape) return // probably the shape was just deleted
 
 			const pageTransform = editor.getShapePageTransform(id)
-			const transform = Matrix2d.toCssString(pageTransform)
+			const transform = Mat.toCssString(pageTransform)
 			setProperty('transform', transform)
 		},
 		[editor, setProperty]

commit 8eba6704df998e21adff0b3a296e29b992492d6e
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Wed Jan 17 10:44:40 2024 +0000

    Prevent overlay content disappearing at some browser zoom levels (#2483)
    
    This essentially reverts the change from #1858 ‚Äì it seems to be no
    longer necessary after we applied the transforms to each overlay item
    individually rather than applying a single transform to the outer
    container.
    
    This fixes an issue where at certain zoom levels, overlay elements would
    disappear when their parent div/svg (that we use for positioning) went
    offscreen while their overflowing contents (the stuff you could see) did
    not.
    
    todos before merging
    - [ ] test on android and ios
    - [ ] test on windows
    
    
    ### Change Type
    
    - [x] `patch` ‚Äî Bug fix
    
    [^1]: publishes a `patch` release, for devDependencies use `internal`
    [^2]: will not publish a new version
    
    ### Release Notes
    
    - removes the internal `useDprMultiple` hook

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index 3e1f772f4..675519583 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -2,11 +2,11 @@ import { track, useQuickReactor, useStateTracking } from '@tldraw/state'
 import { TLShape, TLShapeId } from '@tldraw/tlschema'
 import * as React from 'react'
 import { ShapeUtil } from '../editor/shapes/ShapeUtil'
-import { nearestMultiple } from '../hooks/useDPRMultiple'
 import { useEditor } from '../hooks/useEditor'
 import { useEditorComponents } from '../hooks/useEditorComponents'
 import { Mat } from '../primitives/Mat'
 import { toDomPrecision } from '../primitives/utils'
+import { nearestMultiple } from '../utils/nearestMultiple'
 import { OptionalErrorBoundary } from './ErrorBoundary'
 
 /*

commit 8e23a253fc7282a07cd37bc6f26c291f4318f219
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Fri Mar 15 16:18:23 2024 +0000

    [perf] Reinstate render throttling (#3160)
    
    Follow up to #3129
    
    ### Change Type
    
    <!-- ‚ùó Please select a 'Scope' label ‚ùóÔ∏è -->
    
    - [x] `sdk` ‚Äî Changes the tldraw SDK
    
    - [x] `improvement` ‚Äî Improving existing features
    
    
    
    ### Test Plan
    
    1. Add a step-by-step description of how to test your PR here.
    2.
    
    - [ ] Unit Tests
    - [ ] End to end tests
    
    ### Release Notes
    
    - Add a brief release note for your PR here.

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index 675519583..6afa14aee 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -1,4 +1,4 @@
-import { track, useQuickReactor, useStateTracking } from '@tldraw/state'
+import { track, useLayoutReaction, useStateTracking } from '@tldraw/state'
 import { TLShape, TLShapeId } from '@tldraw/tlschema'
 import * as React from 'react'
 import { ShapeUtil } from '../editor/shapes/ShapeUtil'
@@ -49,53 +49,31 @@ export const Shape = track(function Shape({
 		backgroundContainerRef.current?.style.setProperty(property, value)
 	}, [])
 
-	useQuickReactor(
-		'set shape container transform position',
-		() => {
-			const shape = editor.getShape(id)
-			if (!shape) return // probably the shape was just deleted
+	useLayoutReaction('set shape stuff', () => {
+		const shape = editor.getShape(id)
+		if (!shape) return // probably the shape was just deleted
 
-			const pageTransform = editor.getShapePageTransform(id)
-			const transform = Mat.toCssString(pageTransform)
-			setProperty('transform', transform)
-		},
-		[editor, setProperty]
-	)
-
-	useQuickReactor(
-		'set shape container clip path',
-		() => {
-			const shape = editor.getShape(id)
-			if (!shape) return null
+		const pageTransform = editor.getShapePageTransform(id)
+		const transform = Mat.toCssString(pageTransform)
+		setProperty('transform', transform)
 
-			const clipPath = editor.getShapeClipPath(id)
-			setProperty('clip-path', clipPath ?? 'none')
-		},
-		[editor, setProperty]
-	)
+		const clipPath = editor.getShapeClipPath(id)
+		setProperty('clip-path', clipPath ?? 'none')
 
-	useQuickReactor(
-		'set shape height and width',
-		() => {
-			const shape = editor.getShape(id)
-			if (!shape) return null
-
-			const bounds = editor.getShapeGeometry(shape).bounds
-			const dpr = Math.floor(editor.getInstanceState().devicePixelRatio * 100) / 100
-			// dprMultiple is the smallest number we can multiply dpr by to get an integer
-			// it's usually 1, 2, or 4 (for e.g. dpr of 2, 2.5 and 2.25 respectively)
-			const dprMultiple = nearestMultiple(dpr)
-			// We round the shape width and height up to the nearest multiple of dprMultiple to avoid the browser
-			// making miscalculations when applying the transform.
-			const widthRemainder = bounds.w % dprMultiple
-			const width = widthRemainder === 0 ? bounds.w : bounds.w + (dprMultiple - widthRemainder)
-			const heightRemainder = bounds.h % dprMultiple
-			const height = heightRemainder === 0 ? bounds.h : bounds.h + (dprMultiple - heightRemainder)
-			setProperty('width', Math.max(width, dprMultiple) + 'px')
-			setProperty('height', Math.max(height, dprMultiple) + 'px')
-		},
-		[editor]
-	)
+		const bounds = editor.getShapeGeometry(shape).bounds
+		const dpr = Math.floor(editor.getInstanceState().devicePixelRatio * 100) / 100
+		// dprMultiple is the smallest number we can multiply dpr by to get an integer
+		// it's usually 1, 2, or 4 (for e.g. dpr of 2, 2.5 and 2.25 respectively)
+		const dprMultiple = nearestMultiple(dpr)
+		// We round the shape width and height up to the nearest multiple of dprMultiple to avoid the browser
+		// making miscalculations when applying the transform.
+		const widthRemainder = bounds.w % dprMultiple
+		const width = widthRemainder === 0 ? bounds.w : bounds.w + (dprMultiple - widthRemainder)
+		const heightRemainder = bounds.h % dprMultiple
+		const height = heightRemainder === 0 ? bounds.h : bounds.h + (dprMultiple - heightRemainder)
+		setProperty('width', Math.max(width, dprMultiple) + 'px')
+		setProperty('height', Math.max(height, dprMultiple) + 'px')
+	})
 
 	// Set the opacity of the container when the opacity changes
 	React.useLayoutEffect(() => {

commit 4801b35768108b0569b054e762b5b12c9f488d83
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Sun Mar 17 21:37:37 2024 +0000

    [tinyish] Simplify / skip some work in Shape (#3176)
    
    This PR is a minor cleanup of the Shape component.
    
    Here we:
    - use some dumb memoized info to avoid unnecessary style changes
    - move the dpr check up out of the shapes themselves, avoiding renders
    on instance state changes
    
    Culled shapes:
    - move the props setting on the culled shape component to a layout
    reactor
    - no longer set the height / width on the culled shape component
    - no longer update the culled shape component when the shape changes
    
    Random:
    - move the arrow shape defs to the arrow shape util (using that neat API
    we didn't used to have)
    
    ### Change Type
    
    <!-- ‚ùó Please select a 'Scope' label ‚ùóÔ∏è -->
    
    - [x] `sdk` ‚Äî Changes the tldraw SDK
    - [ ] `dotcom` ‚Äî Changes the tldraw.com web app
    - [ ] `docs` ‚Äî Changes to the documentation, examples, or templates.
    - [ ] `vs code` ‚Äî Changes to the vscode plugin
    - [ ] `internal` ‚Äî Does not affect user-facing stuff
    
    <!-- ‚ùó Please select a 'Type' label ‚ùóÔ∏è -->
    
    - [ ] `bugfix` ‚Äî Bug fix
    - [ ] `feature` ‚Äî New feature
    - [x] `improvement` ‚Äî Improving existing features
    - [ ] `chore` ‚Äî Updating dependencies, other boring stuff
    - [ ] `galaxy brain` ‚Äî Architectural changes
    - [ ] `tests` ‚Äî Changes to any test code
    - [ ] `tools` ‚Äî Changes to infrastructure, CI, internal scripts,
    debugging tools, etc.
    - [ ] `dunno` ‚Äî I don't know
    
    
    ### Test Plan
    
    1. Use shapes
    2. Use culled shapes
    
    ### Release Notes
    
    - SDK: minor improvements to the Shape component

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index 6afa14aee..0823f49a4 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -1,26 +1,27 @@
-import { track, useLayoutReaction, useStateTracking } from '@tldraw/state'
+import { useLayoutReaction, useStateTracking } from '@tldraw/state'
+import { IdOf } from '@tldraw/store'
 import { TLShape, TLShapeId } from '@tldraw/tlschema'
-import * as React from 'react'
+import { memo, useCallback, useLayoutEffect, useRef } from 'react'
 import { ShapeUtil } from '../editor/shapes/ShapeUtil'
 import { useEditor } from '../hooks/useEditor'
 import { useEditorComponents } from '../hooks/useEditorComponents'
 import { Mat } from '../primitives/Mat'
 import { toDomPrecision } from '../primitives/utils'
-import { nearestMultiple } from '../utils/nearestMultiple'
+import { setStyleProperty } from '../utils/dom'
 import { OptionalErrorBoundary } from './ErrorBoundary'
 
 /*
 This component renders shapes on the canvas. There are two stages: positioning
 and styling the shape's container using CSS, and then rendering the shape's 
 JSX using its shape util's render method. Rendering the "inside" of a shape is
-more expensive than positioning it or changing its color, so we use React.memo
+more expensive than positioning it or changing its color, so we use memo
 to wrap the inner shape and only re-render it when the shape's props change. 
 
 The shape also receives props for its index and opacity. The index is used to
 determine the z-index of the shape, and the opacity is used to set the shape's
 opacity based on its own opacity and that of its parent's.
 */
-export const Shape = track(function Shape({
+export const Shape = memo(function Shape({
 	id,
 	shape,
 	util,
@@ -28,6 +29,7 @@ export const Shape = track(function Shape({
 	backgroundIndex,
 	opacity,
 	isCulled,
+	dprMultiple,
 }: {
 	id: TLShapeId
 	shape: TLShape
@@ -36,56 +38,79 @@ export const Shape = track(function Shape({
 	backgroundIndex: number
 	opacity: number
 	isCulled: boolean
+	dprMultiple: number
 }) {
 	const editor = useEditor()
 
 	const { ShapeErrorFallback } = useEditorComponents()
 
-	const containerRef = React.useRef<HTMLDivElement>(null)
-	const backgroundContainerRef = React.useRef<HTMLDivElement>(null)
+	const containerRef = useRef<HTMLDivElement>(null)
+	const bgContainerRef = useRef<HTMLDivElement>(null)
 
-	const setProperty = React.useCallback((property: string, value: string) => {
-		containerRef.current?.style.setProperty(property, value)
-		backgroundContainerRef.current?.style.setProperty(property, value)
-	}, [])
+	const memoizedStuffRef = useRef({
+		transform: '',
+		clipPath: 'none',
+		width: 0,
+		height: 0,
+	})
 
 	useLayoutReaction('set shape stuff', () => {
 		const shape = editor.getShape(id)
 		if (!shape) return // probably the shape was just deleted
 
-		const pageTransform = editor.getShapePageTransform(id)
-		const transform = Mat.toCssString(pageTransform)
-		setProperty('transform', transform)
-
-		const clipPath = editor.getShapeClipPath(id)
-		setProperty('clip-path', clipPath ?? 'none')
-
+		const prev = memoizedStuffRef.current
+
+		// Clip path
+		const clipPath = editor.getShapeClipPath(id) ?? 'none'
+		if (clipPath !== prev.clipPath) {
+			setStyleProperty(containerRef.current, 'clip-path', clipPath)
+			setStyleProperty(bgContainerRef.current, 'clip-path', clipPath)
+			prev.clipPath = clipPath
+		}
+
+		// Page transform
+		const transform = Mat.toCssString(editor.getShapePageTransform(id))
+		if (transform !== prev.transform) {
+			setStyleProperty(containerRef.current, 'transform', transform)
+			setStyleProperty(bgContainerRef.current, 'transform', transform)
+			prev.transform = transform
+		}
+
+		// Width / Height
+		// We round the shape width and height up to the nearest multiple of dprMultiple
+		// to avoid the browser making miscalculations when applying the transform.
 		const bounds = editor.getShapeGeometry(shape).bounds
-		const dpr = Math.floor(editor.getInstanceState().devicePixelRatio * 100) / 100
-		// dprMultiple is the smallest number we can multiply dpr by to get an integer
-		// it's usually 1, 2, or 4 (for e.g. dpr of 2, 2.5 and 2.25 respectively)
-		const dprMultiple = nearestMultiple(dpr)
-		// We round the shape width and height up to the nearest multiple of dprMultiple to avoid the browser
-		// making miscalculations when applying the transform.
 		const widthRemainder = bounds.w % dprMultiple
-		const width = widthRemainder === 0 ? bounds.w : bounds.w + (dprMultiple - widthRemainder)
 		const heightRemainder = bounds.h % dprMultiple
+		const width = widthRemainder === 0 ? bounds.w : bounds.w + (dprMultiple - widthRemainder)
 		const height = heightRemainder === 0 ? bounds.h : bounds.h + (dprMultiple - heightRemainder)
-		setProperty('width', Math.max(width, dprMultiple) + 'px')
-		setProperty('height', Math.max(height, dprMultiple) + 'px')
+
+		if (width !== prev.width || height !== prev.height) {
+			setStyleProperty(containerRef.current, 'width', Math.max(width, dprMultiple) + 'px')
+			setStyleProperty(containerRef.current, 'height', Math.max(height, dprMultiple) + 'px')
+			setStyleProperty(bgContainerRef.current, 'width', Math.max(width, dprMultiple) + 'px')
+			setStyleProperty(bgContainerRef.current, 'height', Math.max(height, dprMultiple) + 'px')
+			prev.width = width
+			prev.height = height
+		}
 	})
 
-	// Set the opacity of the container when the opacity changes
-	React.useLayoutEffect(() => {
-		setProperty('opacity', opacity + '')
-		containerRef.current?.style.setProperty('z-index', index + '')
-		backgroundContainerRef.current?.style.setProperty('z-index', backgroundIndex + '')
-	}, [opacity, index, backgroundIndex, setProperty])
-
-	const annotateError = React.useCallback(
-		(error: any) => {
-			editor.annotateError(error, { origin: 'react.shape', willCrashApp: false })
-		},
+	// This stuff changes pretty infrequently, so we can change them together
+	useLayoutEffect(() => {
+		const container = containerRef.current
+		const bgContainer = bgContainerRef.current
+
+		// Opacity
+		setStyleProperty(container, 'opacity', opacity)
+		setStyleProperty(bgContainer, 'opacity', opacity)
+
+		// Z-Index
+		setStyleProperty(container, 'z-index', index)
+		setStyleProperty(bgContainer, 'z-index', backgroundIndex)
+	}, [opacity, index, backgroundIndex])
+
+	const annotateError = useCallback(
+		(error: any) => editor.annotateError(error, { origin: 'shape', willCrashApp: false }),
 		[editor]
 	)
 
@@ -95,12 +120,12 @@ export const Shape = track(function Shape({
 		<>
 			{util.backgroundComponent && (
 				<div
-					ref={backgroundContainerRef}
+					ref={bgContainerRef}
 					className="tl-shape tl-shape-background"
 					data-shape-type={shape.type}
 					draggable={false}
 				>
-					{!isCulled && (
+					{isCulled ? null : (
 						<OptionalErrorBoundary fallback={ShapeErrorFallback} onError={annotateError}>
 							<InnerShapeBackground shape={shape} util={util} />
 						</OptionalErrorBoundary>
@@ -109,7 +134,7 @@ export const Shape = track(function Shape({
 			)}
 			<div ref={containerRef} className="tl-shape" data-shape-type={shape.type} draggable={false}>
 				{isCulled ? (
-					<CulledShape shape={shape} />
+					<CulledShape shapeId={shape.id} />
 				) : (
 					<OptionalErrorBoundary fallback={ShapeErrorFallback as any} onError={annotateError}>
 						<InnerShape shape={shape} util={util} />
@@ -120,17 +145,14 @@ export const Shape = track(function Shape({
 	)
 })
 
-const InnerShape = React.memo(
+const InnerShape = memo(
 	function InnerShape<T extends TLShape>({ shape, util }: { shape: T; util: ShapeUtil<T> }) {
 		return useStateTracking('InnerShape:' + shape.type, () => util.component(shape))
 	},
-	(prev, next) =>
-		prev.shape.props === next.shape.props &&
-		prev.shape.meta === next.shape.meta &&
-		prev.util === next.util
+	(prev, next) => prev.shape.props === next.shape.props && prev.shape.meta === next.shape.meta
 )
 
-const InnerShapeBackground = React.memo(
+const InnerShapeBackground = memo(
 	function InnerShapeBackground<T extends TLShape>({
 		shape,
 		util,
@@ -143,23 +165,18 @@ const InnerShapeBackground = React.memo(
 	(prev, next) => prev.shape.props === next.shape.props && prev.shape.meta === next.shape.meta
 )
 
-const CulledShape = React.memo(
-	function CulledShape<T extends TLShape>({ shape }: { shape: T }) {
-		const editor = useEditor()
-		const bounds = editor.getShapeGeometry(shape).bounds
+const CulledShape = function CulledShape<T extends TLShape>({ shapeId }: { shapeId: IdOf<T> }) {
+	const editor = useEditor()
+	const culledRef = useRef<HTMLDivElement>(null)
 
-		return (
-			<div
-				className="tl-shape__culled"
-				style={{
-					transform: `translate(${toDomPrecision(bounds.minX)}px, ${toDomPrecision(
-						bounds.minY
-					)}px)`,
-					width: Math.max(1, toDomPrecision(bounds.width)),
-					height: Math.max(1, toDomPrecision(bounds.height)),
-				}}
-			/>
+	useLayoutReaction('set shape stuff', () => {
+		const bounds = editor.getShapeGeometry(shapeId).bounds
+		setStyleProperty(
+			culledRef.current,
+			'transform',
+			`translate(${toDomPrecision(bounds.minX)}px, ${toDomPrecision(bounds.minY)}px)`
 		)
-	},
-	() => true
-)
+	})
+
+	return <div ref={culledRef} className="tl-shape__culled" />
+}

commit cd02d03d063b50d93d840aa8194aeced43a6a9c5
Author: Mitja Bezen≈°ek <mitja.bezensek@gmail.com>
Date:   Thu Mar 21 11:05:44 2024 +0100

    Revert perf changes (#3217)
    
    Step 1 of the master plan üòÇ
    
    ![CleanShot 2024-03-19 at 16 05
    08](https://github.com/tldraw/tldraw/assets/2523721/7d2afed9-7b69-4fdb-8b9f-54a48c61258f)
    
    This:
    - Reverts #3186
    - Reverts #3160 (there were some conflicting changes so it's not a
    straight revert)
    - Reverts most of #2977
    
    
    ### Change Type
    
    <!-- ‚ùó Please select a 'Scope' label ‚ùóÔ∏è -->
    
    - [ ] `sdk` ‚Äî Changes the tldraw SDK
    - [ ] `dotcom` ‚Äî Changes the tldraw.com web app
    - [ ] `docs` ‚Äî Changes to the documentation, examples, or templates.
    - [ ] `vs code` ‚Äî Changes to the vscode plugin
    - [x] `internal` ‚Äî Does not affect user-facing stuff
    
    <!-- ‚ùó Please select a 'Type' label ‚ùóÔ∏è -->
    
    - [ ] `bugfix` ‚Äî Bug fix
    - [ ] `feature` ‚Äî New feature
    - [ ] `improvement` ‚Äî Improving existing features
    - [x] `chore` ‚Äî Updating dependencies, other boring stuff
    - [ ] `galaxy brain` ‚Äî Architectural changes
    - [ ] `tests` ‚Äî Changes to any test code
    - [ ] `tools` ‚Äî Changes to infrastructure, CI, internal scripts,
    debugging tools, etc.
    - [ ] `dunno` ‚Äî I don't know

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index 0823f49a4..3762290b3 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -1,7 +1,7 @@
-import { useLayoutReaction, useStateTracking } from '@tldraw/state'
+import { useQuickReactor, useStateTracking } from '@tldraw/state'
 import { IdOf } from '@tldraw/store'
 import { TLShape, TLShapeId } from '@tldraw/tlschema'
-import { memo, useCallback, useLayoutEffect, useRef } from 'react'
+import { memo, useCallback, useRef } from 'react'
 import { ShapeUtil } from '../editor/shapes/ShapeUtil'
 import { useEditor } from '../hooks/useEditor'
 import { useEditorComponents } from '../hooks/useEditorComponents'
@@ -54,60 +54,68 @@ export const Shape = memo(function Shape({
 		height: 0,
 	})
 
-	useLayoutReaction('set shape stuff', () => {
-		const shape = editor.getShape(id)
-		if (!shape) return // probably the shape was just deleted
-
-		const prev = memoizedStuffRef.current
-
-		// Clip path
-		const clipPath = editor.getShapeClipPath(id) ?? 'none'
-		if (clipPath !== prev.clipPath) {
-			setStyleProperty(containerRef.current, 'clip-path', clipPath)
-			setStyleProperty(bgContainerRef.current, 'clip-path', clipPath)
-			prev.clipPath = clipPath
-		}
-
-		// Page transform
-		const transform = Mat.toCssString(editor.getShapePageTransform(id))
-		if (transform !== prev.transform) {
-			setStyleProperty(containerRef.current, 'transform', transform)
-			setStyleProperty(bgContainerRef.current, 'transform', transform)
-			prev.transform = transform
-		}
-
-		// Width / Height
-		// We round the shape width and height up to the nearest multiple of dprMultiple
-		// to avoid the browser making miscalculations when applying the transform.
-		const bounds = editor.getShapeGeometry(shape).bounds
-		const widthRemainder = bounds.w % dprMultiple
-		const heightRemainder = bounds.h % dprMultiple
-		const width = widthRemainder === 0 ? bounds.w : bounds.w + (dprMultiple - widthRemainder)
-		const height = heightRemainder === 0 ? bounds.h : bounds.h + (dprMultiple - heightRemainder)
-
-		if (width !== prev.width || height !== prev.height) {
-			setStyleProperty(containerRef.current, 'width', Math.max(width, dprMultiple) + 'px')
-			setStyleProperty(containerRef.current, 'height', Math.max(height, dprMultiple) + 'px')
-			setStyleProperty(bgContainerRef.current, 'width', Math.max(width, dprMultiple) + 'px')
-			setStyleProperty(bgContainerRef.current, 'height', Math.max(height, dprMultiple) + 'px')
-			prev.width = width
-			prev.height = height
-		}
-	})
+	useQuickReactor(
+		'set shape stuff',
+		() => {
+			const shape = editor.getShape(id)
+			if (!shape) return // probably the shape was just deleted
+
+			const prev = memoizedStuffRef.current
+
+			// Clip path
+			const clipPath = editor.getShapeClipPath(id) ?? 'none'
+			if (clipPath !== prev.clipPath) {
+				setStyleProperty(containerRef.current, 'clip-path', clipPath)
+				setStyleProperty(bgContainerRef.current, 'clip-path', clipPath)
+				prev.clipPath = clipPath
+			}
+
+			// Page transform
+			const transform = Mat.toCssString(editor.getShapePageTransform(id))
+			if (transform !== prev.transform) {
+				setStyleProperty(containerRef.current, 'transform', transform)
+				setStyleProperty(bgContainerRef.current, 'transform', transform)
+				prev.transform = transform
+			}
+
+			// Width / Height
+			// We round the shape width and height up to the nearest multiple of dprMultiple
+			// to avoid the browser making miscalculations when applying the transform.
+			const bounds = editor.getShapeGeometry(shape).bounds
+			const widthRemainder = bounds.w % dprMultiple
+			const heightRemainder = bounds.h % dprMultiple
+			const width = widthRemainder === 0 ? bounds.w : bounds.w + (dprMultiple - widthRemainder)
+			const height = heightRemainder === 0 ? bounds.h : bounds.h + (dprMultiple - heightRemainder)
+
+			if (width !== prev.width || height !== prev.height) {
+				setStyleProperty(containerRef.current, 'width', Math.max(width, dprMultiple) + 'px')
+				setStyleProperty(containerRef.current, 'height', Math.max(height, dprMultiple) + 'px')
+				setStyleProperty(bgContainerRef.current, 'width', Math.max(width, dprMultiple) + 'px')
+				setStyleProperty(bgContainerRef.current, 'height', Math.max(height, dprMultiple) + 'px')
+				prev.width = width
+				prev.height = height
+			}
+		},
+		[editor]
+	)
 
 	// This stuff changes pretty infrequently, so we can change them together
-	useLayoutEffect(() => {
-		const container = containerRef.current
-		const bgContainer = bgContainerRef.current
-
-		// Opacity
-		setStyleProperty(container, 'opacity', opacity)
-		setStyleProperty(bgContainer, 'opacity', opacity)
-
-		// Z-Index
-		setStyleProperty(container, 'z-index', index)
-		setStyleProperty(bgContainer, 'z-index', backgroundIndex)
-	}, [opacity, index, backgroundIndex])
+	useQuickReactor(
+		'set opacity and z-index',
+		() => {
+			const container = containerRef.current
+			const bgContainer = bgContainerRef.current
+
+			// Opacity
+			setStyleProperty(container, 'opacity', opacity)
+			setStyleProperty(bgContainer, 'opacity', opacity)
+
+			// Z-Index
+			setStyleProperty(container, 'z-index', index)
+			setStyleProperty(bgContainer, 'z-index', backgroundIndex)
+		},
+		[opacity, index, backgroundIndex]
+	)
 
 	const annotateError = useCallback(
 		(error: any) => editor.annotateError(error, { origin: 'shape', willCrashApp: false }),
@@ -169,14 +177,18 @@ const CulledShape = function CulledShape<T extends TLShape>({ shapeId }: { shape
 	const editor = useEditor()
 	const culledRef = useRef<HTMLDivElement>(null)
 
-	useLayoutReaction('set shape stuff', () => {
-		const bounds = editor.getShapeGeometry(shapeId).bounds
-		setStyleProperty(
-			culledRef.current,
-			'transform',
-			`translate(${toDomPrecision(bounds.minX)}px, ${toDomPrecision(bounds.minY)}px)`
-		)
-	})
+	useQuickReactor(
+		'set shape stuff',
+		() => {
+			const bounds = editor.getShapeGeometry(shapeId).bounds
+			setStyleProperty(
+				culledRef.current,
+				'transform',
+				`translate(${toDomPrecision(bounds.minX)}px, ${toDomPrecision(bounds.minY)}px)`
+			)
+		},
+		[editor]
+	)
 
 	return <div ref={culledRef} className="tl-shape__culled" />
 }

commit f1e0af763184584a3297e7137d745af8567f1895
Author: Mitja Bezen≈°ek <mitja.bezensek@gmail.com>
Date:   Fri Apr 5 15:23:02 2024 +0200

    Display none for culled shapes (#3291)
    
    Comparing different culling optimizations:
    
    
    https://github.com/tldraw/tldraw/assets/2523721/0b3b8b42-ed70-45b7-bf83-41023c36a563
    
    I think we should go with the `display: none` + showing the skeleteon.
    The way it works is:
    - We now add a sibling to the shape wrapper div which serves as the
    skeleton for the culled shapes.
    - Only one of the two divs (shape wrapper and skeleton div) is
    displayed. The other one is using `display: none` to improve
    performance.
    
    ### Change Type
    
    <!-- ‚ùó Please select a 'Scope' label ‚ùóÔ∏è -->
    
    - [ ] `sdk` ‚Äî Changes the tldraw SDK
    - [ ] `dotcom` ‚Äî Changes the tldraw.com web app
    - [ ] `docs` ‚Äî Changes to the documentation, examples, or templates.
    - [ ] `vs code` ‚Äî Changes to the vscode plugin
    - [x] `internal` ‚Äî Does not affect user-facing stuff
    
    <!-- ‚ùó Please select a 'Type' label ‚ùóÔ∏è -->
    
    - [ ] `bugfix` ‚Äî Bug fix
    - [ ] `feature` ‚Äî New feature
    - [x] `improvement` ‚Äî Improving existing features
    - [ ] `chore` ‚Äî Updating dependencies, other boring stuff
    - [ ] `galaxy brain` ‚Äî Architectural changes
    - [ ] `tests` ‚Äî Changes to any test code
    - [ ] `tools` ‚Äî Changes to infrastructure, CI, internal scripts,
    debugging tools, etc.
    - [ ] `dunno` ‚Äî I don't know
    
    
    - Improve performance of culled shapes by using `display: none`.
    
    ---------
    
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index 3762290b3..8c7dedd0b 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -1,12 +1,10 @@
 import { useQuickReactor, useStateTracking } from '@tldraw/state'
-import { IdOf } from '@tldraw/store'
 import { TLShape, TLShapeId } from '@tldraw/tlschema'
-import { memo, useCallback, useRef } from 'react'
+import { memo, useCallback, useLayoutEffect, useRef } from 'react'
 import { ShapeUtil } from '../editor/shapes/ShapeUtil'
 import { useEditor } from '../hooks/useEditor'
 import { useEditorComponents } from '../hooks/useEditorComponents'
 import { Mat } from '../primitives/Mat'
-import { toDomPrecision } from '../primitives/utils'
 import { setStyleProperty } from '../utils/dom'
 import { OptionalErrorBoundary } from './ErrorBoundary'
 
@@ -45,6 +43,7 @@ export const Shape = memo(function Shape({
 	const { ShapeErrorFallback } = useEditorComponents()
 
 	const containerRef = useRef<HTMLDivElement>(null)
+	const culledContainerRef = useRef<HTMLDivElement>(null)
 	const bgContainerRef = useRef<HTMLDivElement>(null)
 
 	const memoizedStuffRef = useRef({
@@ -52,6 +51,8 @@ export const Shape = memo(function Shape({
 		clipPath: 'none',
 		width: 0,
 		height: 0,
+		x: 0,
+		y: 0,
 	})
 
 	useQuickReactor(
@@ -66,22 +67,31 @@ export const Shape = memo(function Shape({
 			const clipPath = editor.getShapeClipPath(id) ?? 'none'
 			if (clipPath !== prev.clipPath) {
 				setStyleProperty(containerRef.current, 'clip-path', clipPath)
+				setStyleProperty(culledContainerRef.current, 'clip-path', clipPath)
 				setStyleProperty(bgContainerRef.current, 'clip-path', clipPath)
 				prev.clipPath = clipPath
 			}
 
 			// Page transform
-			const transform = Mat.toCssString(editor.getShapePageTransform(id))
+			const pageTransform = editor.getShapePageTransform(id)
+			const transform = Mat.toCssString(pageTransform)
+			const bounds = editor.getShapeGeometry(shape).bounds
+
+			// Update if the tranform has changed
 			if (transform !== prev.transform) {
 				setStyleProperty(containerRef.current, 'transform', transform)
 				setStyleProperty(bgContainerRef.current, 'transform', transform)
+				setStyleProperty(
+					culledContainerRef.current,
+					'transform',
+					`${Mat.toCssString(pageTransform)} translate(${bounds.x}px, ${bounds.y}px)`
+				)
 				prev.transform = transform
 			}
 
 			// Width / Height
 			// We round the shape width and height up to the nearest multiple of dprMultiple
 			// to avoid the browser making miscalculations when applying the transform.
-			const bounds = editor.getShapeGeometry(shape).bounds
 			const widthRemainder = bounds.w % dprMultiple
 			const heightRemainder = bounds.h % dprMultiple
 			const width = widthRemainder === 0 ? bounds.w : bounds.w + (dprMultiple - widthRemainder)
@@ -90,6 +100,8 @@ export const Shape = memo(function Shape({
 			if (width !== prev.width || height !== prev.height) {
 				setStyleProperty(containerRef.current, 'width', Math.max(width, dprMultiple) + 'px')
 				setStyleProperty(containerRef.current, 'height', Math.max(height, dprMultiple) + 'px')
+				setStyleProperty(culledContainerRef.current, 'width', Math.max(width, dprMultiple) + 'px')
+				setStyleProperty(culledContainerRef.current, 'height', Math.max(height, dprMultiple) + 'px')
 				setStyleProperty(bgContainerRef.current, 'width', Math.max(width, dprMultiple) + 'px')
 				setStyleProperty(bgContainerRef.current, 'height', Math.max(height, dprMultiple) + 'px')
 				prev.width = width
@@ -117,6 +129,15 @@ export const Shape = memo(function Shape({
 		[opacity, index, backgroundIndex]
 	)
 
+	useLayoutEffect(() => {
+		const container = containerRef.current
+		const bgContainer = bgContainerRef.current
+		const culledContainer = culledContainerRef.current
+		setStyleProperty(container, 'display', isCulled ? 'none' : 'block')
+		setStyleProperty(bgContainer, 'display', isCulled ? 'none' : 'block')
+		setStyleProperty(culledContainer, 'display', isCulled ? 'block' : 'none')
+	}, [isCulled])
+
 	const annotateError = useCallback(
 		(error: any) => editor.annotateError(error, { origin: 'shape', willCrashApp: false }),
 		[editor]
@@ -126,6 +147,7 @@ export const Shape = memo(function Shape({
 
 	return (
 		<>
+			<div ref={culledContainerRef} className="tl-shape__culled" draggable={false} />
 			{util.backgroundComponent && (
 				<div
 					ref={bgContainerRef}
@@ -133,21 +155,15 @@ export const Shape = memo(function Shape({
 					data-shape-type={shape.type}
 					draggable={false}
 				>
-					{isCulled ? null : (
-						<OptionalErrorBoundary fallback={ShapeErrorFallback} onError={annotateError}>
-							<InnerShapeBackground shape={shape} util={util} />
-						</OptionalErrorBoundary>
-					)}
+					<OptionalErrorBoundary fallback={ShapeErrorFallback} onError={annotateError}>
+						<InnerShapeBackground shape={shape} util={util} />
+					</OptionalErrorBoundary>
 				</div>
 			)}
 			<div ref={containerRef} className="tl-shape" data-shape-type={shape.type} draggable={false}>
-				{isCulled ? (
-					<CulledShape shapeId={shape.id} />
-				) : (
-					<OptionalErrorBoundary fallback={ShapeErrorFallback as any} onError={annotateError}>
-						<InnerShape shape={shape} util={util} />
-					</OptionalErrorBoundary>
-				)}
+				<OptionalErrorBoundary fallback={ShapeErrorFallback as any} onError={annotateError}>
+					<InnerShape shape={shape} util={util} />
+				</OptionalErrorBoundary>
 			</div>
 		</>
 	)
@@ -172,23 +188,3 @@ const InnerShapeBackground = memo(
 	},
 	(prev, next) => prev.shape.props === next.shape.props && prev.shape.meta === next.shape.meta
 )
-
-const CulledShape = function CulledShape<T extends TLShape>({ shapeId }: { shapeId: IdOf<T> }) {
-	const editor = useEditor()
-	const culledRef = useRef<HTMLDivElement>(null)
-
-	useQuickReactor(
-		'set shape stuff',
-		() => {
-			const bounds = editor.getShapeGeometry(shapeId).bounds
-			setStyleProperty(
-				culledRef.current,
-				'transform',
-				`translate(${toDomPrecision(bounds.minX)}px, ${toDomPrecision(bounds.minY)}px)`
-			)
-		},
-		[editor]
-	)
-
-	return <div ref={culledRef} className="tl-shape__culled" />
-}

commit 97b5e4093abd0f0e4ff09932bc15e4b5b94239a6
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Fri Apr 5 19:03:22 2024 +0100

    [culling] minimal culled diff with webgl (#3377)
    
    This PR extracts the #3344 changes to a smaller diff against main. It
    does not include the changes to how / where culled shapes are
    calculated, though I understand this could be much more efficiently
    done!
    
    ### Change Type
    
    - [x] `sdk` ‚Äî Changes the tldraw SDK
    - [x] `improvement` ‚Äî Improving existing features
    
    ---------
    
    Co-authored-by: Mitja Bezen≈°ek <mitja.bezensek@gmail.com>

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index 8c7dedd0b..19a33b64a 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -43,7 +43,6 @@ export const Shape = memo(function Shape({
 	const { ShapeErrorFallback } = useEditorComponents()
 
 	const containerRef = useRef<HTMLDivElement>(null)
-	const culledContainerRef = useRef<HTMLDivElement>(null)
 	const bgContainerRef = useRef<HTMLDivElement>(null)
 
 	const memoizedStuffRef = useRef({
@@ -67,7 +66,6 @@ export const Shape = memo(function Shape({
 			const clipPath = editor.getShapeClipPath(id) ?? 'none'
 			if (clipPath !== prev.clipPath) {
 				setStyleProperty(containerRef.current, 'clip-path', clipPath)
-				setStyleProperty(culledContainerRef.current, 'clip-path', clipPath)
 				setStyleProperty(bgContainerRef.current, 'clip-path', clipPath)
 				prev.clipPath = clipPath
 			}
@@ -81,11 +79,6 @@ export const Shape = memo(function Shape({
 			if (transform !== prev.transform) {
 				setStyleProperty(containerRef.current, 'transform', transform)
 				setStyleProperty(bgContainerRef.current, 'transform', transform)
-				setStyleProperty(
-					culledContainerRef.current,
-					'transform',
-					`${Mat.toCssString(pageTransform)} translate(${bounds.x}px, ${bounds.y}px)`
-				)
 				prev.transform = transform
 			}
 
@@ -100,8 +93,6 @@ export const Shape = memo(function Shape({
 			if (width !== prev.width || height !== prev.height) {
 				setStyleProperty(containerRef.current, 'width', Math.max(width, dprMultiple) + 'px')
 				setStyleProperty(containerRef.current, 'height', Math.max(height, dprMultiple) + 'px')
-				setStyleProperty(culledContainerRef.current, 'width', Math.max(width, dprMultiple) + 'px')
-				setStyleProperty(culledContainerRef.current, 'height', Math.max(height, dprMultiple) + 'px')
 				setStyleProperty(bgContainerRef.current, 'width', Math.max(width, dprMultiple) + 'px')
 				setStyleProperty(bgContainerRef.current, 'height', Math.max(height, dprMultiple) + 'px')
 				prev.width = width
@@ -132,10 +123,8 @@ export const Shape = memo(function Shape({
 	useLayoutEffect(() => {
 		const container = containerRef.current
 		const bgContainer = bgContainerRef.current
-		const culledContainer = culledContainerRef.current
 		setStyleProperty(container, 'display', isCulled ? 'none' : 'block')
 		setStyleProperty(bgContainer, 'display', isCulled ? 'none' : 'block')
-		setStyleProperty(culledContainer, 'display', isCulled ? 'block' : 'none')
 	}, [isCulled])
 
 	const annotateError = useCallback(
@@ -147,7 +136,6 @@ export const Shape = memo(function Shape({
 
 	return (
 		<>
-			<div ref={culledContainerRef} className="tl-shape__culled" draggable={false} />
 			{util.backgroundComponent && (
 				<div
 					ref={bgContainerRef}

commit 947f7b1d765917ce546de24a1338ab8c9d31e8d5
Author: Mitja Bezen≈°ek <mitja.bezensek@gmail.com>
Date:   Mon Apr 8 13:36:12 2024 +0200

    [culling] Improve setting of display none. (#3376)
    
    Small improvement for culling shapes. We now use reactor to do it. .
    
    Before:
    
    ![image](https://github.com/tldraw/tldraw/assets/2523721/7f791cdd-c0e2-4b92-84d1-8b071540de10)
    
    After:
    
    ![image](https://github.com/tldraw/tldraw/assets/2523721/ca2e2a9e-f9f6-48a8-936f-05a402c1e7a2)
    
    
    ### Change Type
    
    <!-- ‚ùó Please select a 'Scope' label ‚ùóÔ∏è -->
    
    - [ ] `sdk` ‚Äî Changes the tldraw SDK
    - [ ] `dotcom` ‚Äî Changes the tldraw.com web app
    - [ ] `docs` ‚Äî Changes to the documentation, examples, or templates.
    - [ ] `vs code` ‚Äî Changes to the vscode plugin
    - [x] `internal` ‚Äî Does not affect user-facing stuff
    
    <!-- ‚ùó Please select a 'Type' label ‚ùóÔ∏è -->
    
    - [ ] `bugfix` ‚Äî Bug fix
    - [ ] `feature` ‚Äî New feature
    - [x] `improvement` ‚Äî Improving existing features
    - [ ] `chore` ‚Äî Updating dependencies, other boring stuff
    - [ ] `galaxy brain` ‚Äî Architectural changes
    - [ ] `tests` ‚Äî Changes to any test code
    - [ ] `tools` ‚Äî Changes to infrastructure, CI, internal scripts,
    debugging tools, etc.
    - [ ] `dunno` ‚Äî I don't know

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index 19a33b64a..8e21a66ed 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -1,6 +1,6 @@
 import { useQuickReactor, useStateTracking } from '@tldraw/state'
 import { TLShape, TLShapeId } from '@tldraw/tlschema'
-import { memo, useCallback, useLayoutEffect, useRef } from 'react'
+import { memo, useCallback, useRef } from 'react'
 import { ShapeUtil } from '../editor/shapes/ShapeUtil'
 import { useEditor } from '../hooks/useEditor'
 import { useEditorComponents } from '../hooks/useEditorComponents'
@@ -26,7 +26,6 @@ export const Shape = memo(function Shape({
 	index,
 	backgroundIndex,
 	opacity,
-	isCulled,
 	dprMultiple,
 }: {
 	id: TLShapeId
@@ -35,7 +34,6 @@ export const Shape = memo(function Shape({
 	index: number
 	backgroundIndex: number
 	opacity: number
-	isCulled: boolean
 	dprMultiple: number
 }) {
 	const editor = useEditor()
@@ -120,13 +118,18 @@ export const Shape = memo(function Shape({
 		[opacity, index, backgroundIndex]
 	)
 
-	useLayoutEffect(() => {
-		const container = containerRef.current
-		const bgContainer = bgContainerRef.current
-		setStyleProperty(container, 'display', isCulled ? 'none' : 'block')
-		setStyleProperty(bgContainer, 'display', isCulled ? 'none' : 'block')
-	}, [isCulled])
+	useQuickReactor(
+		'set display',
+		() => {
+			const shape = editor.getShape(id)
+			if (!shape) return // probably the shape was just deleted
 
+			const isCulled = editor.isShapeCulled(shape)
+			setStyleProperty(containerRef.current, 'display', isCulled ? 'none' : 'block')
+			setStyleProperty(bgContainerRef.current, 'display', isCulled ? 'none' : 'block')
+		},
+		[editor]
+	)
 	const annotateError = useCallback(
 		(error: any) => editor.annotateError(error, { origin: 'shape', willCrashApp: false }),
 		[editor]

commit 987b1ac0b93f6088e7affdd1b597afff50a0fd51
Author: Mitja Bezen≈°ek <mitja.bezensek@gmail.com>
Date:   Wed Apr 10 12:29:11 2024 +0200

    Perf: Incremental culled shapes calculation. (#3411)
    
    Reworks our culling logic:
    - No longer show the gray rectangles for culled shapes.
    - Don't use `renderingBoundExpanded`, instead we now use
    `viewportPageBounds`. I've removed `renderingBoundsExpanded`, but we
    might want to deprecate it?
    - There's now a incremental computation of non visible shapes, which are
    shapes outside of `viewportPageBounds` and shapes that outside of their
    parents' clipping bounds.
    - There's also a new `getCulledShapes` function in `Editor`, which uses
    the non visible shapes computation as a part of the culled shape
    computation.
    - Also moved some of the `getRenderingShapes` tests to newly created
    `getCullingShapes` tests.
    
    Feels much better on my old, 2017 ipad (first tab is this PR, second is
    current prod, third is staging).
    
    
    https://github.com/tldraw/tldraw/assets/2523721/327a7313-9273-4350-89a0-617a30fc01a2
    
    ### Change Type
    
    <!-- ‚ùó Please select a 'Scope' label ‚ùóÔ∏è -->
    
    - [x] `sdk` ‚Äî Changes the tldraw SDK
    - [ ] `dotcom` ‚Äî Changes the tldraw.com web app
    - [ ] `docs` ‚Äî Changes to the documentation, examples, or templates.
    - [ ] `vs code` ‚Äî Changes to the vscode plugin
    - [ ] `internal` ‚Äî Does not affect user-facing stuff
    
    <!-- ‚ùó Please select a 'Type' label ‚ùóÔ∏è -->
    
    - [ ] `bugfix` ‚Äî Bug fix
    - [ ] `feature` ‚Äî New feature
    - [x] `improvement` ‚Äî Improving existing features
    - [ ] `chore` ‚Äî Updating dependencies, other boring stuff
    - [ ] `galaxy brain` ‚Äî Architectural changes
    - [ ] `tests` ‚Äî Changes to any test code
    - [ ] `tools` ‚Äî Changes to infrastructure, CI, internal scripts,
    debugging tools, etc.
    - [ ] `dunno` ‚Äî I don't know
    
    
    ### Test Plan
    
    1. Regular culling shapes tests. Pan / zoom around. Use minimap. Change
    pages.
    
    - [x] Unit Tests
    - [ ] End to end tests
    
    ---------
    
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index 8e21a66ed..909d51885 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -50,6 +50,7 @@ export const Shape = memo(function Shape({
 		height: 0,
 		x: 0,
 		y: 0,
+		isCulled: false,
 	})
 
 	useQuickReactor(
@@ -124,9 +125,13 @@ export const Shape = memo(function Shape({
 			const shape = editor.getShape(id)
 			if (!shape) return // probably the shape was just deleted
 
-			const isCulled = editor.isShapeCulled(shape)
-			setStyleProperty(containerRef.current, 'display', isCulled ? 'none' : 'block')
-			setStyleProperty(bgContainerRef.current, 'display', isCulled ? 'none' : 'block')
+			const culledShapes = editor.getCulledShapes()
+			const isCulled = culledShapes.has(id)
+			if (isCulled !== memoizedStuffRef.current.isCulled) {
+				setStyleProperty(containerRef.current, 'display', isCulled ? 'none' : 'block')
+				setStyleProperty(bgContainerRef.current, 'display', isCulled ? 'none' : 'block')
+				memoizedStuffRef.current.isCulled = isCulled
+			}
 		},
 		[editor]
 	)

commit 4da28a0ddd850fba64dc79b8bc4736a922e81ea0
Author: Mime ƒåuvalo <mimecuvalo@gmail.com>
Date:   Mon Apr 29 14:51:12 2024 +0100

    textfields: for unfilled geo shapes fix edit->edit (#3577)
    
    We need to treat unfilled geo shapes as hollow to click 'through' them.
    
    Before:
    
    
    https://github.com/tldraw/tldraw/assets/469604/bf7b520c-c6f5-41cd-88e9-b020fe0ebb32
    
    
    
    After:
    
    
    https://github.com/tldraw/tldraw/assets/469604/e39d9bcf-2b94-46d5-ace4-8a1053b2ee81
    
    
    
    
    ### Change Type
    
    <!-- ‚ùó Please select a 'Scope' label ‚ùóÔ∏è -->
    
    - [x] `sdk` ‚Äî Changes the tldraw SDK
    - [ ] `dotcom` ‚Äî Changes the tldraw.com web app
    - [ ] `docs` ‚Äî Changes to the documentation, examples, or templates.
    - [ ] `vs code` ‚Äî Changes to the vscode plugin
    - [ ] `internal` ‚Äî Does not affect user-facing stuff
    
    <!-- ‚ùó Please select a 'Type' label ‚ùóÔ∏è -->
    
    - [x] `bugfix` ‚Äî Bug fix
    - [ ] `feature` ‚Äî New feature
    - [ ] `improvement` ‚Äî Improving existing features
    - [ ] `chore` ‚Äî Updating dependencies, other boring stuff
    - [ ] `galaxy brain` ‚Äî Architectural changes
    - [ ] `tests` ‚Äî Changes to any test code
    - [ ] `tools` ‚Äî Changes to infrastructure, CI, internal scripts,
    debugging tools, etc.
    - [ ] `dunno` ‚Äî I don't know
    
    ### Release Notes
    
    - Text labels: fix edit‚Üíedit not working as expected when unfilled geo
    shapes are on 'top' of other shapes.

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index 909d51885..dbccbb2ab 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -142,6 +142,8 @@ export const Shape = memo(function Shape({
 
 	if (!shape) return null
 
+	const isFilledShape = 'fill' in shape.props && shape.props.fill !== 'none'
+
 	return (
 		<>
 			{util.backgroundComponent && (
@@ -156,7 +158,13 @@ export const Shape = memo(function Shape({
 					</OptionalErrorBoundary>
 				</div>
 			)}
-			<div ref={containerRef} className="tl-shape" data-shape-type={shape.type} draggable={false}>
+			<div
+				ref={containerRef}
+				className="tl-shape"
+				data-shape-type={shape.type}
+				data-shape-is-filled={isFilledShape}
+				draggable={false}
+			>
 				<OptionalErrorBoundary fallback={ShapeErrorFallback as any} onError={annotateError}>
 					<InnerShape shape={shape} util={util} />
 				</OptionalErrorBoundary>

commit b04ded47c30fb7c3fb77f7de0e668997612c13e0
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Wed Jun 5 11:48:52 2024 +0100

    Prevent stale shape data in render (#3882)
    
    Our Shape component is set up to, by default, not re-render the actual
    shape content when the shape's x,y coords or opacity or rotation etc
    change, since those things don't affect the shape itself but rather how
    it is composited. It does this by only triggering re-renders when
    shape.props or shape.meta change using react.memo.
    
    However the shape's render is also reactive so it is possible to trigger
    re-renders even when shape.props and shape.meta do not change, e.g. in
    the case of arrow shapes you can trigger re-renders by updating bindings
    involving the arrow, or by moving one of the arrow's bound shapes.
    
    This is fine except that the actual arrow record being passed into the
    util.component etc methods was not always the very latest version in the
    store because it has been memoized by react. This makes identity checks
    like `shape === otherShape` fail sometimes, and was causing a bug in
    arrow rendering (the grey bits to show the binding anchor were not
    always showing up).
    
    To fix that, this PR simply plucks the shape out of the store using the
    sneaky non-capturing method during render so that it's always up-to-date
    when being passed to the shape util for rendering, while still
    preserving the behaviour that by default it won't re-render unless the
    shape.props or shape.meta change.
    
    ### Change Type
    
    <!-- ‚ùó Please select a 'Scope' label ‚ùóÔ∏è -->
    
    - [x] `sdk` ‚Äî Changes the tldraw SDK
    - [ ] `dotcom` ‚Äî Changes the tldraw.com web app
    - [ ] `docs` ‚Äî Changes to the documentation, examples, or templates.
    - [ ] `vs code` ‚Äî Changes to the vscode plugin
    - [ ] `internal` ‚Äî Does not affect user-facing stuff
    
    <!-- ‚ùó Please select a 'Type' label ‚ùóÔ∏è -->
    
    - [x] `bugfix` ‚Äî Bug fix
    - [ ] `feature` ‚Äî New feature
    - [ ] `improvement` ‚Äî Improving existing features
    - [ ] `chore` ‚Äî Updating dependencies, other boring stuff
    - [ ] `galaxy brain` ‚Äî Architectural changes
    - [ ] `tests` ‚Äî Changes to any test code
    - [ ] `tools` ‚Äî Changes to infrastructure, CI, internal scripts,
    debugging tools, etc.
    - [ ] `dunno` ‚Äî I don't know
    
    
    ### Test Plan
    
    1. Add a step-by-step description of how to test your PR here.
    2.
    
    - [ ] Unit Tests
    - [ ] End to end tests
    
    ### Release Notes
    
    - Add a brief release note for your PR here.

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index dbccbb2ab..aab6e97b4 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -175,7 +175,11 @@ export const Shape = memo(function Shape({
 
 const InnerShape = memo(
 	function InnerShape<T extends TLShape>({ shape, util }: { shape: T; util: ShapeUtil<T> }) {
-		return useStateTracking('InnerShape:' + shape.type, () => util.component(shape))
+		return useStateTracking('InnerShape:' + shape.type, () =>
+			// always fetch the latest shape from the store even if the props/meta have not changed, to avoid
+			// calling the render method with stale data.
+			util.component(util.editor.store.unsafeGetWithoutCapture(shape.id) as T)
+		)
 	},
 	(prev, next) => prev.shape.props === next.shape.props && prev.shape.meta === next.shape.meta
 )
@@ -188,7 +192,11 @@ const InnerShapeBackground = memo(
 		shape: T
 		util: ShapeUtil<T>
 	}) {
-		return useStateTracking('InnerShape:' + shape.type, () => util.backgroundComponent?.(shape))
+		return useStateTracking('InnerShape:' + shape.type, () =>
+			// always fetch the latest shape from the store even if the props/meta have not changed, to avoid
+			// calling the render method with stale data.
+			util.backgroundComponent?.(util.editor.store.unsafeGetWithoutCapture(shape.id) as T)
+		)
 	},
 	(prev, next) => prev.shape.props === next.shape.props && prev.shape.meta === next.shape.meta
 )

commit 7ba4040e840fcf6e2972edf9b4ae318438039f21
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Mon Jul 15 12:18:59 2024 +0100

    Split @tldraw/state into @tldraw/state and @tldraw/state-react (#4170)
    
    The backend code uses `@tldraw/state`, which is fine, but the package
    has a peer dependency on `react`, which is not fine to impose on backend
    consumers. So let's split this up again.
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [x] `api`
    - [x] `other`
    
    ### Test plan
    
    1. Create a shape...
    2.
    
    - [ ] Unit tests
    - [ ] End to end tests
    
    ### Release notes
    
    - Fixed a bug with‚Ä¶

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index aab6e97b4..0908ece05 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -1,4 +1,4 @@
-import { useQuickReactor, useStateTracking } from '@tldraw/state'
+import { useQuickReactor, useStateTracking } from '@tldraw/state-react'
 import { TLShape, TLShapeId } from '@tldraw/tlschema'
 import { memo, useCallback, useRef } from 'react'
 import { ShapeUtil } from '../editor/shapes/ShapeUtil'

commit efa1a4b4b6fd0e266d06be80b1b86913143562f1
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Mon Aug 5 08:59:11 2024 +0100

    why did we have this dpr constrained width/height stuff again? (#4297)
    
    ```js
    // We round the shape width and height up to the nearest multiple of dprMultiple
    // to avoid the browser making miscalculations when applying the transform.
    ```
    
    this is what i wrote, and yet I can't seem to reproduce any errors at
    weird browser zoom levels if I remove this dpr stuff now. Maybe the bad
    transform stuff has been fixed in chrome. I should test a few other
    browsers.
    
    ### Change type
    
    - [ ] `bugfix`
    - [x] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Test plan
    
    1. Create a shape...
    2.
    
    - [ ] Unit tests
    - [ ] End to end tests
    
    ### Release notes
    
    - Fixed a bug with‚Ä¶

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index 0908ece05..7e01ec954 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -26,7 +26,6 @@ export const Shape = memo(function Shape({
 	index,
 	backgroundIndex,
 	opacity,
-	dprMultiple,
 }: {
 	id: TLShapeId
 	shape: TLShape
@@ -34,7 +33,6 @@ export const Shape = memo(function Shape({
 	index: number
 	backgroundIndex: number
 	opacity: number
-	dprMultiple: number
 }) {
 	const editor = useEditor()
 
@@ -82,18 +80,14 @@ export const Shape = memo(function Shape({
 			}
 
 			// Width / Height
-			// We round the shape width and height up to the nearest multiple of dprMultiple
-			// to avoid the browser making miscalculations when applying the transform.
-			const widthRemainder = bounds.w % dprMultiple
-			const heightRemainder = bounds.h % dprMultiple
-			const width = widthRemainder === 0 ? bounds.w : bounds.w + (dprMultiple - widthRemainder)
-			const height = heightRemainder === 0 ? bounds.h : bounds.h + (dprMultiple - heightRemainder)
+			const width = Math.max(bounds.width, 1)
+			const height = Math.max(bounds.height, 1)
 
 			if (width !== prev.width || height !== prev.height) {
-				setStyleProperty(containerRef.current, 'width', Math.max(width, dprMultiple) + 'px')
-				setStyleProperty(containerRef.current, 'height', Math.max(height, dprMultiple) + 'px')
-				setStyleProperty(bgContainerRef.current, 'width', Math.max(width, dprMultiple) + 'px')
-				setStyleProperty(bgContainerRef.current, 'height', Math.max(height, dprMultiple) + 'px')
+				setStyleProperty(containerRef.current, 'width', width + 'px')
+				setStyleProperty(containerRef.current, 'height', height + 'px')
+				setStyleProperty(bgContainerRef.current, 'width', width + 'px')
+				setStyleProperty(bgContainerRef.current, 'height', height + 'px')
 				prev.width = width
 				prev.height = height
 			}

commit 7d0433e91822f9a65a6b5d735918489822849bf0
Author: alex <alex@dytry.ch>
Date:   Wed Sep 4 16:33:26 2024 +0100

    add default <foreignObject> based export for shapes (#4403)
    
    Custom shapes (and our own bookmark shapes) now support SVG exports by
    default! The default implementation isn't the most efficient and won't
    work in all SVG environments, but you can still write your own if
    needed. It's pretty reliable though!
    
    ![Kapture 2024-08-27 at 17 29
    31](https://github.com/user-attachments/assets/3870e82b-b77b-486b-92b0-420921df8d51)
    
    This introduces a couple of new APIs for co-ordinating SVG exports. The
    main one is `useDelaySvgExport`. This is useful when your component
    might take a while to load, and you need to delay the export is until
    everything is ready & rendered. You use it like this:
    ```tsx
    function MyComponent() {
        const exportIsReady = useDelaySvgExport()
        const [dynamicData, setDynamicData] = useState(null)
    
        useEffect(() => {
            loadDynamicData.then((data) => {
                setDynamicData(data)
                exportIsReady()
            })
        })
    
        return <MyList data={data} />
    }
    ```
    
    This is a pretty low-level API that I wouldn't expect most people using
    these exports to need, but it does come in handy for some things.
    
    ### Change type
    
    - [x] `improvement`
    
    ### Release notes
    
    Custom shapes (and our own bookmark shapes) now render in image exports
    by default.
    
    ---------
    
    Co-authored-by: huppy-bot[bot] <128400622+huppy-bot[bot]@users.noreply.github.com>

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index 7e01ec954..bc2371682 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -167,7 +167,7 @@ export const Shape = memo(function Shape({
 	)
 })
 
-const InnerShape = memo(
+export const InnerShape = memo(
 	function InnerShape<T extends TLShape>({ shape, util }: { shape: T; util: ShapeUtil<T> }) {
 		return useStateTracking('InnerShape:' + shape.type, () =>
 			// always fetch the latest shape from the store even if the props/meta have not changed, to avoid
@@ -178,7 +178,7 @@ const InnerShape = memo(
 	(prev, next) => prev.shape.props === next.shape.props && prev.shape.meta === next.shape.meta
 )
 
-const InnerShapeBackground = memo(
+export const InnerShapeBackground = memo(
 	function InnerShapeBackground<T extends TLShape>({
 		shape,
 		util,

commit d5f4c1d05bb834ab5623d19d418e31e4ab5afa66
Author: alex <alex@dytry.ch>
Date:   Wed Oct 9 15:55:15 2024 +0100

    make sure DOM IDs are globally unique (#4694)
    
    There are a lot of places where we currently derive a DOM ID from a
    shape ID. This works fine (ish) on tldraw.com, but doesn't work for a
    lot of developer use-cases: if there are multiple tldraw instances or
    exports happening, for example. This is because the DOM expects IDs to
    be globally unique. If there are multiple elements with the same ID in
    the dom, only the first is ever used. This can cause issues if e.g.
    
    1. i have a shape with a clip-path determined by the shape ID
    2. i export that shape and add the resulting SVG to the dom. now, there
    are two clip paths with the same ID, but they're the same
    3. I change the shape - and now, the ID is referring to the export, so i
    get weird rendering issues.
    
    This diff attempts to resolve this issue and prevent it from happening
    again by introducing a new `SafeId` type, and helpers for generating and
    working with `SafeId`s. in tldraw, jsx using the `id` attribute will now
    result in a type error if the value isn't a safe ID. This doesn't affect
    library consumers writing JSX.
    
    As part of this, I've removed the ID that were added to certain shapes.
    Instead, all shapes now have a `data-shape-id` attribute on their
    wrapper.
    
    ### Change type
    
    - [x] `bugfix`
    
    ### Release notes
    
    - Exports and other tldraw instances no longer can affect how each other
    are rendered
    - **BREAKING:** the `id` attribute that was present on some shapes in
    the dom has been removed. there's now a data-shape-id attribute on every
    shape wrapper instead though.

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index bc2371682..ae24c9c4c 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -145,6 +145,7 @@ export const Shape = memo(function Shape({
 					ref={bgContainerRef}
 					className="tl-shape tl-shape-background"
 					data-shape-type={shape.type}
+					data-shape-id={shape.id}
 					draggable={false}
 				>
 					<OptionalErrorBoundary fallback={ShapeErrorFallback} onError={annotateError}>
@@ -157,6 +158,7 @@ export const Shape = memo(function Shape({
 				className="tl-shape"
 				data-shape-type={shape.type}
 				data-shape-is-filled={isFilledShape}
+				data-shape-id={shape.id}
 				draggable={false}
 			>
 				<OptionalErrorBoundary fallback={ShapeErrorFallback as any} onError={annotateError}>

commit b26822432001592346398b0e08199cd43b52eb3c
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Fri Dec 13 11:31:05 2024 +0000

    fix stale closure in InnerShape (#5117)
    
    fixes #5047
    
    the problem was we weren't destroying the shape effect schedulers when
    the editor changed, because they were only keyed by the shape type name,
    which obviously does not change when the editor is reinstantiated.
    
    this augments useStateTracking to accept a deps array, and uses the
    identity of the shape util as part of the deps array.
    
    ### Change type
    
    - [x] `bugfix`

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index ae24c9c4c..6fd7de423 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -171,13 +171,19 @@ export const Shape = memo(function Shape({
 
 export const InnerShape = memo(
 	function InnerShape<T extends TLShape>({ shape, util }: { shape: T; util: ShapeUtil<T> }) {
-		return useStateTracking('InnerShape:' + shape.type, () =>
-			// always fetch the latest shape from the store even if the props/meta have not changed, to avoid
-			// calling the render method with stale data.
-			util.component(util.editor.store.unsafeGetWithoutCapture(shape.id) as T)
+		return useStateTracking(
+			'InnerShape:' + shape.type,
+			() =>
+				// always fetch the latest shape from the store even if the props/meta have not changed, to avoid
+				// calling the render method with stale data.
+				util.component(util.editor.store.unsafeGetWithoutCapture(shape.id) as T),
+			[util, shape.id]
 		)
 	},
-	(prev, next) => prev.shape.props === next.shape.props && prev.shape.meta === next.shape.meta
+	(prev, next) =>
+		prev.shape.props === next.shape.props &&
+		prev.shape.meta === next.shape.meta &&
+		prev.util === next.util
 )
 
 export const InnerShapeBackground = memo(
@@ -188,11 +194,17 @@ export const InnerShapeBackground = memo(
 		shape: T
 		util: ShapeUtil<T>
 	}) {
-		return useStateTracking('InnerShape:' + shape.type, () =>
-			// always fetch the latest shape from the store even if the props/meta have not changed, to avoid
-			// calling the render method with stale data.
-			util.backgroundComponent?.(util.editor.store.unsafeGetWithoutCapture(shape.id) as T)
+		return useStateTracking(
+			'InnerShape:' + shape.type,
+			() =>
+				// always fetch the latest shape from the store even if the props/meta have not changed, to avoid
+				// calling the render method with stale data.
+				util.backgroundComponent?.(util.editor.store.unsafeGetWithoutCapture(shape.id) as T),
+			[util, shape.id]
 		)
 	},
-	(prev, next) => prev.shape.props === next.shape.props && prev.shape.meta === next.shape.meta
+	(prev, next) =>
+		prev.shape.props === next.shape.props &&
+		prev.shape.meta === next.shape.meta &&
+		prev.util === next.util
 )

commit 3bf31007c5a7274f3f7926a84c96c89a4cc2c278
Author: Mime ƒåuvalo <mimecuvalo@gmail.com>
Date:   Mon Mar 3 14:23:09 2025 +0000

    [feature] add rich text and contextual toolbar (#4895)
    
    We're looking to add rich text to the editor!
    
    We originally started with ProseMirror but it became quickly clear that
    since it's more down-to-the-metal we'd have to rebuild a bunch of
    functionality, effectively managing a rich text editor in addition to a
    2D canvas. Examples of this include behaviors around lists where people
    expect certain behaviors around combination of lists next to each other,
    tabbing, etc.
    On top of those product expectations, we'd need to provide a
    higher-level API that provided better DX around things like
    transactions, switching between lists‚Üîheaders, and more.
    
    Given those considerations, a very natural fit was to use TipTap. Much
    like tldraw, they provide a great experience around manipulating a rich
    text editor. And, we want to pass on those product/DX benefits
    downstream to our SDK users.
    
    Some high-level notes:
    - the data is stored as the TipTap stringified JSON, it's lightly
    validated at the moment, but not stringently.
    - there was originally going to be a short-circuit path for plaintext
    but it ended up being error-prone with richtext/plaintext living
    side-by-side. (this meant there were two separate fields)
    - We could still add a way to render faster ‚Äî I just want to avoid it
    being two separate fields, too many footguns.
    - things like arrow labels are only plain text (debatable though).
    
    Other related efforts:
    - https://github.com/tldraw/tldraw/pull/3051
    - https://github.com/tldraw/tldraw/pull/2825
    
    Todo
    - [ ] figure out whether we should have a migration or not. This is what
    we discussed cc @ds300 and @SomeHats - and whether older clients would
    start messing up newer clients. The data becomes lossy if older clients
    overwrite with plaintext.
    
    <img width="427" alt="Screenshot 2024-12-09 at 14 43 51"
    src="https://github.com/user-attachments/assets/f9dddaee-bfd3-4746-8016-d4247e417e80">
    <img width="378" alt="Screenshot 2024-12-09 at 14 42 59"
    src="https://github.com/user-attachments/assets/95e016d3-ab4d-4d34-afd3-b3ef511d2d77">
    
    Current discussion list:
    - [x] positioning: discuss toolbar position (selection bounds vs cursor
    bounds, toolbar is going in center weirdly sometimes)
    - [x] artificial delay: latest updates make it feel slow/unresponsive?
    e.g. list toggle, changing selection
    - [x] keyboard selection: discuss toolbar logic around "mousing around"
    vs. being present when keyboard selecting (which is annoying)
    - [x] mobile: discuss concerns around mobile toolbar
    - [x] mobile, precision tap: discuss / rm tap into text (and sticky
    notes?) - disable precision editing on mobile
    - [x] discuss
    useContextualToolbar/useContextualToolbarPosition/ContextualToolbar/TldrawUiContextualToolbar
    example
    - [x] existing code: middle alignment for pasted text - keep?
    - [x] existing code: should text replace the shape content when pasted?
    keep?
    - [x] discuss animation, we had it, nixed it, it's back again; why the
    0.08s animation? imperceptible?
    - [x] hide during camera move?
    - [x] short form content - hard to make a different selection b/c
    toolbar is in the way of content
    - [x] check 'overflow: hidden' on tl-text-input (update: this is needed
    to avoid scrollbars)
    - [x] decide on toolbar set: italic, underline, strikethrough, highlight
    - [x] labelColor w/ highlighted text - steve has a commit here to tweak
    highlighting
    
    todos:
    - [x] font rebuild (bold, randomization tweaks) - david looking into
    this
    
    check bugs raised:
    - [x] can't do selection on list item
    - [x] mobile: b/c of the blur/Done logic, doesn't work if you dbl-click
    on geo shape (it's a plaintext problem too)
    - [x] mobile: No cursor when using the text tool - specifically for the
    Text tool ‚Äî can't repro?
    - [x] VSCode html pasting, whitespace issue?
    - [x] Link toolbar make it extend to the widest size of the current tool
    set
    - [x] code has mutual exclusivity (this is a design choice by the Code
    plugin - we could fork)
    - [x] Text is copied to the clipboard with paragraphs rather than line
    breaks.
    - [x] multi-line plaintext for arrows busted
    
    nixed/outdated
    - [ ] ~link: on mobile should be in modal?~
    - [ ] ~link: back button?~
    - [ ] ~list button toggling? (can't repro)~
    - [ ] ~double/triple-clicking is now wonky with the new logic~
    - [ ] ~move blur() code into useEditableRichText - for Done on iOS~
    - [ ] ~toolbar when shape is rotated~
    - [ ] ~"The "isMousingDown" logic doesn't work, the events aren't
    reaching the window. Not sure how we get those from the editor element."
    (can't repro?)~
    - [ ] ~toolbar position bug when toggling code on and off (can't
    repro?)~
    - [ ] ~some issue around "Something's up with the initial size
    calculated from the text selection bounds."~
    - [ ] ~mobile: Context bar still visible out if user presses "Done" to
    end editing~
    - [ ] ~mobile: toolbar when switching between text fields~
    
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [x] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Test plan
    
    1. TODO: write a bunch more tests
    
    - [x] Unit tests
    - [x] End to end tests
    
    ### Release notes
    
    - Rich text using ProseMirror as a first-class supported option in the
    Editor.
    
    ---------
    
    Co-authored-by: huppy-bot[bot] <128400622+huppy-bot[bot]@users.noreply.github.com>
    Co-authored-by: alex <alex@dytry.ch>
    Co-authored-by: David Sheldrick <d.j.sheldrick@gmail.com>
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index 6fd7de423..c21effb4e 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -1,6 +1,7 @@
+import { react } from '@tldraw/state'
 import { useQuickReactor, useStateTracking } from '@tldraw/state-react'
 import { TLShape, TLShapeId } from '@tldraw/tlschema'
-import { memo, useCallback, useRef } from 'react'
+import { memo, useCallback, useEffect, useRef } from 'react'
 import { ShapeUtil } from '../editor/shapes/ShapeUtil'
 import { useEditor } from '../hooks/useEditor'
 import { useEditorComponents } from '../hooks/useEditorComponents'
@@ -41,6 +42,13 @@ export const Shape = memo(function Shape({
 	const containerRef = useRef<HTMLDivElement>(null)
 	const bgContainerRef = useRef<HTMLDivElement>(null)
 
+	useEffect(() => {
+		return react('load fonts', () => {
+			const fonts = editor.fonts.getShapeFontFaces(shape)
+			editor.fonts.requestFonts(fonts)
+		})
+	}, [editor, shape])
+
 	const memoizedStuffRef = useRef({
 		transform: '',
 		clipPath: 'none',

commit 5642859790c2794ed7c10f5294d3aab88a7ebad8
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon Mar 24 12:19:58 2025 +0000

    Cache the fonts extracted from rich text. (#5735)
    
    This PR improves the performance of shapes with rich text content.
    
    ## The bug
    
    Due to reasons I cannot understand, we extract the fonts from rich text
    on every frame while translating shapes. Maybe we shouldn't, I don't
    know. Anyway, this is expensive when many shapes are moving around.
    Actually, not even that many. Try it yourself!
    
    ## The fix
    
    The fix here is the same as #5658, which is to skip the work if the text
    is empt; or use a weak cache to re-use the result from last time.
    
    ### Change type
    
    - [ ] `bugfix`
    - [x] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Test plan
    
    1. Create lots of geo shapes.
    2. Drag all the geo shapes around.
    
    ### Release notes
    
    - Improved performance while editing many geo shapes or text shapes.
    
    ---------
    
    Co-authored-by: Mime ƒåuvalo <mimecuvalo@gmail.com>

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index c21effb4e..4864798b9 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -44,10 +44,10 @@ export const Shape = memo(function Shape({
 
 	useEffect(() => {
 		return react('load fonts', () => {
-			const fonts = editor.fonts.getShapeFontFaces(shape)
+			const fonts = editor.fonts.getShapeFontFaces(id)
 			editor.fonts.requestFonts(fonts)
 		})
-	}, [editor, shape])
+	}, [editor, id])
 
 	const memoizedStuffRef = useRef({
 		transform: '',

commit 5fcdc0f29d81f74d55b7e5d08d4bdb6cc968c58d
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Fri Mar 28 16:10:04 2025 +0000

    Better whyAmIRunning (#5746)
    
    @SomeHats I think this should fix the flakiness you were seeing. can you
    confirm?
    
    Leaving as draft because I still need to check the perf and probably add
    tests now that it touches normal code paths.
    
    ### Change type
    
    - [x] `other`

diff --git a/packages/editor/src/lib/components/Shape.tsx b/packages/editor/src/lib/components/Shape.tsx
index 4864798b9..43caade72 100644
--- a/packages/editor/src/lib/components/Shape.tsx
+++ b/packages/editor/src/lib/components/Shape.tsx
@@ -1,7 +1,7 @@
 import { react } from '@tldraw/state'
 import { useQuickReactor, useStateTracking } from '@tldraw/state-react'
 import { TLShape, TLShapeId } from '@tldraw/tlschema'
-import { memo, useCallback, useEffect, useRef } from 'react'
+import { memo, useCallback, useEffect, useLayoutEffect, useRef } from 'react'
 import { ShapeUtil } from '../editor/shapes/ShapeUtil'
 import { useEditor } from '../hooks/useEditor'
 import { useEditorComponents } from '../hooks/useEditorComponents'
@@ -104,22 +104,18 @@ export const Shape = memo(function Shape({
 	)
 
 	// This stuff changes pretty infrequently, so we can change them together
-	useQuickReactor(
-		'set opacity and z-index',
-		() => {
-			const container = containerRef.current
-			const bgContainer = bgContainerRef.current
-
-			// Opacity
-			setStyleProperty(container, 'opacity', opacity)
-			setStyleProperty(bgContainer, 'opacity', opacity)
-
-			// Z-Index
-			setStyleProperty(container, 'z-index', index)
-			setStyleProperty(bgContainer, 'z-index', backgroundIndex)
-		},
-		[opacity, index, backgroundIndex]
-	)
+	useLayoutEffect(() => {
+		const container = containerRef.current
+		const bgContainer = bgContainerRef.current
+
+		// Opacity
+		setStyleProperty(container, 'opacity', opacity)
+		setStyleProperty(bgContainer, 'opacity', opacity)
+
+		// Z-Index
+		setStyleProperty(container, 'z-index', index)
+		setStyleProperty(bgContainer, 'z-index', backgroundIndex)
+	}, [opacity, index, backgroundIndex])
 
 	useQuickReactor(
 		'set display',

