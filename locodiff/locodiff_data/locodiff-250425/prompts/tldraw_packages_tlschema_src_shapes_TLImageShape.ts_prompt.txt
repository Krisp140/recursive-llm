# Instructions

You are being benchmarked. You will see the output of a git log command, and from that must infer the current state of a file. Think carefully, as you must output the exact state of the file to earn full marks.

**Important:** Your goal is to reproduce the file's content *exactly* as it exists at the final commit, even if the code appears broken, buggy, or contains obvious errors. Do **not** try to "fix" the code. Attempting to correct issues will result in a poor score, as this benchmark evaluates your ability to reproduce the precise state of the file based on its history.

# Required Response Format

Wrap the content of the file in triple backticks (```). Any text outside the final closing backticks will be ignored. End your response after outputting the closing backticks.

# Example Response

```python
#!/usr/bin/env python
print('Hello, world!')
```

# File History

> git log -p --cc --topo-order --reverse -- packages/tlschema/src/shapes/TLImageShape.ts

commit 29ed921c6745923dcc8daa72ba6f815a5c4b279a
Author: alex <alex@dytry.ch>
Date:   Tue Apr 25 12:01:25 2023 +0100

    transfer-out: transfer out

diff --git a/packages/tlschema/src/shapes/TLImageShape.ts b/packages/tlschema/src/shapes/TLImageShape.ts
new file mode 100644
index 000000000..83ec13fd5
--- /dev/null
+++ b/packages/tlschema/src/shapes/TLImageShape.ts
@@ -0,0 +1,85 @@
+import { defineMigrations } from '@tldraw/tlstore'
+import { T } from '@tldraw/tlvalidate'
+import { Vec2dModel } from '../geometry-types'
+import { TLAssetId } from '../records/TLAsset'
+import { TLOpacityType } from '../style-types'
+import { assetIdValidator, opacityValidator } from '../validation'
+import { TLBaseShape, createShapeValidator } from './shape-validation'
+
+/** @public */
+export type TLImageCrop = {
+	topLeft: Vec2dModel
+	bottomRight: Vec2dModel
+}
+
+/** @public */
+export type TLImageShapeProps = {
+	opacity: TLOpacityType
+	url: string
+	playing: boolean
+	w: number
+	h: number
+	assetId: TLAssetId | null
+	crop: TLImageCrop | null
+}
+
+/** @public */
+export const cropValidator = T.object({
+	topLeft: T.point,
+	bottomRight: T.point,
+})
+
+/** @public */
+export type TLImageShape = TLBaseShape<'image', TLImageShapeProps>
+
+// --- VALIDATION ---
+/** @public */
+export const imageShapeTypeValidator: T.Validator<TLImageShape> = createShapeValidator(
+	'image',
+	T.object({
+		opacity: opacityValidator,
+		w: T.nonZeroNumber,
+		h: T.nonZeroNumber,
+		playing: T.boolean,
+		url: T.string,
+		assetId: assetIdValidator.nullable(),
+		crop: cropValidator.nullable(),
+	})
+)
+
+// --- MIGRATIONS ---
+// STEP 1: Add a new version number here, give it a meaningful name.
+// It should be 1 higher than the current version
+const Versions = {
+	Initial: 0,
+	AddUrlProp: 1,
+	AddCropProp: 2,
+} as const
+
+/** @public */
+export const imageShapeMigrations = defineMigrations({
+	// STEP 2: Update the current version to point to your latest version
+	firstVersion: Versions.Initial,
+	currentVersion: Versions.AddCropProp,
+	migrators: {
+		// STEP 3: Add an up+down migration for the new version here
+		[Versions.AddUrlProp]: {
+			up: (shape) => {
+				return { ...shape, props: { ...shape.props, url: '' } }
+			},
+			down: (shape) => {
+				const { url: _, ...props } = shape.props
+				return { ...shape, props }
+			},
+		},
+		[Versions.AddCropProp]: {
+			up: (shape) => {
+				return { ...shape, props: { ...shape.props, crop: null } }
+			},
+			down: (shape) => {
+				const { crop: _, ...props } = shape.props
+				return { ...shape, props }
+			},
+		},
+	},
+})

commit 53be9239218d051b05dad3723520d0cabc62f239
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon May 22 22:46:24 2023 +0100

    [refactor] record migrations (#1430)
    
    This PR removes comments from our record types, makes initial version
    optional, and unifies the order of initial / current version.
    
    - Initial versions are zero by default
    - If no current version is provided to `defineMigrations`, migrations
    should be undefined
    - Fixes TypeScript quirks in versioning (e.g. only initial version)
    
    This PR also:
    - Makes migrations optional when empty
    - Removes reference to empty migrations
    
    ### Change Type
    
    - [x] `major` — Breaking Change
    
    ### Test Plan
    
    - [x] Unit Tests
    - [ ] Webdriver tests
    
    ### Release Notes
    
    - [tlschema] Improve `defineMigrations`
    - [editor] Simplify migration definitions

diff --git a/packages/tlschema/src/shapes/TLImageShape.ts b/packages/tlschema/src/shapes/TLImageShape.ts
index 83ec13fd5..df8b67739 100644
--- a/packages/tlschema/src/shapes/TLImageShape.ts
+++ b/packages/tlschema/src/shapes/TLImageShape.ts
@@ -32,7 +32,6 @@ export const cropValidator = T.object({
 /** @public */
 export type TLImageShape = TLBaseShape<'image', TLImageShapeProps>
 
-// --- VALIDATION ---
 /** @public */
 export const imageShapeTypeValidator: T.Validator<TLImageShape> = createShapeValidator(
 	'image',
@@ -47,22 +46,15 @@ export const imageShapeTypeValidator: T.Validator<TLImageShape> = createShapeVal
 	})
 )
 
-// --- MIGRATIONS ---
-// STEP 1: Add a new version number here, give it a meaningful name.
-// It should be 1 higher than the current version
 const Versions = {
-	Initial: 0,
 	AddUrlProp: 1,
 	AddCropProp: 2,
 } as const
 
 /** @public */
-export const imageShapeMigrations = defineMigrations({
-	// STEP 2: Update the current version to point to your latest version
-	firstVersion: Versions.Initial,
+export const imageShapeTypeMigrations = defineMigrations({
 	currentVersion: Versions.AddCropProp,
 	migrators: {
-		// STEP 3: Add an up+down migration for the new version here
 		[Versions.AddUrlProp]: {
 			up: (shape) => {
 				return { ...shape, props: { ...shape.props, url: '' } }

commit 7307282f1f38a056b1313b3e0d2f196b28bd5586
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Sat Jun 3 09:27:44 2023 +0100

    Rename tlvalidate to validate (#1508)
    
    This PR renames the @tldraw/tlvalidate package to @tldraw/validate.
    
    ### Change Type
    
    - [x] `major` — Breaking Change
    
    ### Release Notes
    
    - Rename tlvalidate to validate

diff --git a/packages/tlschema/src/shapes/TLImageShape.ts b/packages/tlschema/src/shapes/TLImageShape.ts
index df8b67739..84142aa44 100644
--- a/packages/tlschema/src/shapes/TLImageShape.ts
+++ b/packages/tlschema/src/shapes/TLImageShape.ts
@@ -1,5 +1,5 @@
 import { defineMigrations } from '@tldraw/tlstore'
-import { T } from '@tldraw/tlvalidate'
+import { T } from '@tldraw/validate'
 import { Vec2dModel } from '../geometry-types'
 import { TLAssetId } from '../records/TLAsset'
 import { TLOpacityType } from '../style-types'

commit c1b84bf2468caeb0c6e502f621b19dffe3aa8aba
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Sat Jun 3 09:59:04 2023 +0100

    Rename tlstore to store (#1507)
    
    This PR renames the `@tldraw/tlstore` package to `@tldraw/store`, mainly
    to avoid confusion between `TLStore`. Will be doing the same with other
    packages.
    
    ### Change Type
    
    - [x] `major` — Breaking Change
    
    ### Release Notes
    
    - Replace @tldraw/tlstore with @tldraw/store

diff --git a/packages/tlschema/src/shapes/TLImageShape.ts b/packages/tlschema/src/shapes/TLImageShape.ts
index 84142aa44..d52765446 100644
--- a/packages/tlschema/src/shapes/TLImageShape.ts
+++ b/packages/tlschema/src/shapes/TLImageShape.ts
@@ -1,4 +1,4 @@
-import { defineMigrations } from '@tldraw/tlstore'
+import { defineMigrations } from '@tldraw/store'
 import { T } from '@tldraw/validate'
 import { Vec2dModel } from '../geometry-types'
 import { TLAssetId } from '../records/TLAsset'

commit 4b6383ed90ee20f93571c5e2247f6cae4a62b407
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Sat Jun 3 21:46:53 2023 +0100

    tlschema cleanup (#1509)
    
    This PR cleans up the file names and imports for @tldraw/tlschema.
    
    It also:
    - renames some erroneously named validators / migrators (e.g.
    `pageTypeValidator` -> `pageValidator`)
    - removes the duplicated `languages.ts` and makes `tlschema` the source
    of truth for languages
    - renames ID to RecordId
    
    ### Change Type
    
    - [x] `major` — Breaking Change
    
    ### Release Notes
    
    - [editor] Remove `app.createShapeId`
    - [tlschema] Cleans up exports

diff --git a/packages/tlschema/src/shapes/TLImageShape.ts b/packages/tlschema/src/shapes/TLImageShape.ts
index d52765446..bb8b1b093 100644
--- a/packages/tlschema/src/shapes/TLImageShape.ts
+++ b/packages/tlschema/src/shapes/TLImageShape.ts
@@ -1,10 +1,10 @@
 import { defineMigrations } from '@tldraw/store'
 import { T } from '@tldraw/validate'
-import { Vec2dModel } from '../geometry-types'
+import { assetIdValidator } from '../assets/TLBaseAsset'
+import { Vec2dModel } from '../misc/geometry-types'
 import { TLAssetId } from '../records/TLAsset'
-import { TLOpacityType } from '../style-types'
-import { assetIdValidator, opacityValidator } from '../validation'
-import { TLBaseShape, createShapeValidator } from './shape-validation'
+import { TLOpacityType, opacityValidator } from '../styles/TLOpacityStyle'
+import { TLBaseShape, createShapeValidator } from './TLBaseShape'
 
 /** @public */
 export type TLImageCrop = {
@@ -22,18 +22,17 @@ export type TLImageShapeProps = {
 	assetId: TLAssetId | null
 	crop: TLImageCrop | null
 }
-
 /** @public */
+export type TLImageShape = TLBaseShape<'image', TLImageShapeProps>
+
+/** @internal */
 export const cropValidator = T.object({
 	topLeft: T.point,
 	bottomRight: T.point,
 })
 
-/** @public */
-export type TLImageShape = TLBaseShape<'image', TLImageShapeProps>
-
-/** @public */
-export const imageShapeTypeValidator: T.Validator<TLImageShape> = createShapeValidator(
+/** @internal */
+export const imageShapeValidator: T.Validator<TLImageShape> = createShapeValidator(
 	'image',
 	T.object({
 		opacity: opacityValidator,
@@ -51,8 +50,8 @@ const Versions = {
 	AddCropProp: 2,
 } as const
 
-/** @public */
-export const imageShapeTypeMigrations = defineMigrations({
+/** @internal */
+export const imageShapeMigrations = defineMigrations({
 	currentVersion: Versions.AddCropProp,
 	migrators: {
 		[Versions.AddUrlProp]: {

commit f2d8fae6eaa2b6990210f2d4c42ad976e11e207d
Author: alex <alex@dytry.ch>
Date:   Tue Jun 6 17:15:12 2023 +0100

    hoist opacity out of props (#1526)
    
    This change hoists opacity out of props and changes it to a number
    instead of an enum.
    
    The change to a number is to make tldraw more flexible for library
    consumers who might want more expressivity with opacity than our 5
    possible values allow. the tldraw editor will now happily respect any
    opacity between 0 and 1. The limit to our supported values is enforced
    only in the UI. I think this is limited enough that it's a reasonable
    tradeoff between in-app simplicity and giving external developers the
    flexibility they need.
    
    There's a new `opacityForNextShape` property on the instance. This works
    exactly the same way as propsForNextShape does, except... it's just for
    opacity. With this, there should be no user-facing changes to how
    opacity works in tldraw. There are also new `opacity`/`setOpacity` APIs
    in the editor that work with it/selections similar to how props do.
    
    @ds300 do you mind reviewing the migrations here?
    
    ### Change Type
    
    - [x] `major` — Breaking Change
    
    ### Test Plan
    
    - [x] Unit Tests
    - [ ] Webdriver tests
    
    ### Release Notes
    
    [internal only for now]

diff --git a/packages/tlschema/src/shapes/TLImageShape.ts b/packages/tlschema/src/shapes/TLImageShape.ts
index bb8b1b093..1cca45e84 100644
--- a/packages/tlschema/src/shapes/TLImageShape.ts
+++ b/packages/tlschema/src/shapes/TLImageShape.ts
@@ -3,7 +3,6 @@ import { T } from '@tldraw/validate'
 import { assetIdValidator } from '../assets/TLBaseAsset'
 import { Vec2dModel } from '../misc/geometry-types'
 import { TLAssetId } from '../records/TLAsset'
-import { TLOpacityType, opacityValidator } from '../styles/TLOpacityStyle'
 import { TLBaseShape, createShapeValidator } from './TLBaseShape'
 
 /** @public */
@@ -14,7 +13,6 @@ export type TLImageCrop = {
 
 /** @public */
 export type TLImageShapeProps = {
-	opacity: TLOpacityType
 	url: string
 	playing: boolean
 	w: number
@@ -35,7 +33,6 @@ export const cropValidator = T.object({
 export const imageShapeValidator: T.Validator<TLImageShape> = createShapeValidator(
 	'image',
 	T.object({
-		opacity: opacityValidator,
 		w: T.nonZeroNumber,
 		h: T.nonZeroNumber,
 		playing: T.boolean,

commit 1927f8804158ed4bc1df42eb8a08bdc6b305c379
Author: alex <alex@dytry.ch>
Date:   Mon Jun 12 15:04:14 2023 +0100

    mini `defineShape` API (#1563)
    
    Based on #1549, but with a lot of code-structure related changes backed
    out. Shape schemas are still defined in tlschemas with this diff.
    
    Couple differences between this and #1549:
    - This tightens up the relationship between store schemas and editor
    schemas a bit
    - Reduces the number of places we need to remember to include core
    shapes
    - Only `<TLdrawEditor />` sets default shapes by default. If you're
    doing something funky with lower-level APIs, you need to specify
    `defaultShapes` manually
    - Replaces `validator` with `props` for shapes
    
    ### Change Type
    
    - [x] `major` — Breaking Change
    
    ### Test Plan
    
    1. Add a step-by-step description of how to test your PR here.
    2.
    
    - [x] Unit Tests
    - [ ] Webdriver tests
    
    ### Release Notes
    
    [dev-facing, notes to come]

diff --git a/packages/tlschema/src/shapes/TLImageShape.ts b/packages/tlschema/src/shapes/TLImageShape.ts
index 1cca45e84..6ac472bb6 100644
--- a/packages/tlschema/src/shapes/TLImageShape.ts
+++ b/packages/tlschema/src/shapes/TLImageShape.ts
@@ -3,7 +3,7 @@ import { T } from '@tldraw/validate'
 import { assetIdValidator } from '../assets/TLBaseAsset'
 import { Vec2dModel } from '../misc/geometry-types'
 import { TLAssetId } from '../records/TLAsset'
-import { TLBaseShape, createShapeValidator } from './TLBaseShape'
+import { ShapeProps, TLBaseShape } from './TLBaseShape'
 
 /** @public */
 export type TLImageCrop = {
@@ -30,17 +30,14 @@ export const cropValidator = T.object({
 })
 
 /** @internal */
-export const imageShapeValidator: T.Validator<TLImageShape> = createShapeValidator(
-	'image',
-	T.object({
-		w: T.nonZeroNumber,
-		h: T.nonZeroNumber,
-		playing: T.boolean,
-		url: T.string,
-		assetId: assetIdValidator.nullable(),
-		crop: cropValidator.nullable(),
-	})
-)
+export const imageShapeProps: ShapeProps<TLImageShape> = {
+	w: T.nonZeroNumber,
+	h: T.nonZeroNumber,
+	playing: T.boolean,
+	url: T.string,
+	assetId: assetIdValidator.nullable(),
+	crop: cropValidator.nullable(),
+}
 
 const Versions = {
 	AddUrlProp: 1,

commit b88a2370b314855237774548d627ed4d3301a1ad
Author: alex <alex@dytry.ch>
Date:   Fri Jun 16 11:33:47 2023 +0100

    Styles API (#1580)
    
    Removes `propsForNextShape` and replaces it with the new styles API.
    
    Changes in here:
    - New custom style example
    - `setProp` is now `setStyle` and takes a `StyleProp` instead of a
    string
    - `Editor.props` and `Editor.opacity` are now `Editor.sharedStyles` and
    `Editor.sharedOpacity`
    - They return an object that flags mixed vs shared types instead of
    using null to signal mixed types
    - `Editor.styles` returns a `SharedStyleMap` - keyed on `StyleProp`
    instead of `string`
    - `StateNode.shapeType` is now the shape util rather than just a string.
    This lets us pull the styles from the shape type directly.
    - `color` is no longer a core part of the editor set on the shape
    parent. Individual child shapes have to use color directly.
    - `propsForNextShape` is now `stylesForNextShape`
    - `InstanceRecordType` is created at runtime in the same way
    `ShapeRecordType` is. This is so it can pull style validators out of
    shape defs for `stylesForNextShape`
    - Shape type are now defined by their props rather than having separate
    validators & type defs
    
    ### Change Type
    
    - [x] `major` — Breaking change
    
    ### Test Plan
    
    1. Big time regression testing around styles!
    2. Check UI works as intended for all shape/style/tool combos
    
    - [x] Unit Tests
    - [ ] End to end tests
    
    ### Release Notes
    
    -
    
    ---------
    
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/packages/tlschema/src/shapes/TLImageShape.ts b/packages/tlschema/src/shapes/TLImageShape.ts
index 6ac472bb6..e570f8a30 100644
--- a/packages/tlschema/src/shapes/TLImageShape.ts
+++ b/packages/tlschema/src/shapes/TLImageShape.ts
@@ -1,44 +1,33 @@
 import { defineMigrations } from '@tldraw/store'
 import { T } from '@tldraw/validate'
 import { assetIdValidator } from '../assets/TLBaseAsset'
-import { Vec2dModel } from '../misc/geometry-types'
-import { TLAssetId } from '../records/TLAsset'
-import { ShapeProps, TLBaseShape } from './TLBaseShape'
+import { vec2dModelValidator } from '../misc/geometry-types'
+import { ShapePropsType, TLBaseShape } from './TLBaseShape'
 
 /** @public */
-export type TLImageCrop = {
-	topLeft: Vec2dModel
-	bottomRight: Vec2dModel
-}
-
-/** @public */
-export type TLImageShapeProps = {
-	url: string
-	playing: boolean
-	w: number
-	h: number
-	assetId: TLAssetId | null
-	crop: TLImageCrop | null
-}
-/** @public */
-export type TLImageShape = TLBaseShape<'image', TLImageShapeProps>
-
-/** @internal */
-export const cropValidator = T.object({
-	topLeft: T.point,
-	bottomRight: T.point,
+export const ImageShapeCrop = T.object({
+	topLeft: vec2dModelValidator,
+	bottomRight: vec2dModelValidator,
 })
+/** @public */
+export type TLImageShapeCrop = T.TypeOf<typeof ImageShapeCrop>
 
-/** @internal */
-export const imageShapeProps: ShapeProps<TLImageShape> = {
+/** @public */
+export const imageShapeProps = {
 	w: T.nonZeroNumber,
 	h: T.nonZeroNumber,
 	playing: T.boolean,
 	url: T.string,
 	assetId: assetIdValidator.nullable(),
-	crop: cropValidator.nullable(),
+	crop: ImageShapeCrop.nullable(),
 }
 
+/** @public */
+export type TLImageShapeProps = ShapePropsType<typeof imageShapeProps>
+
+/** @public */
+export type TLImageShape = TLBaseShape<'image', TLImageShapeProps>
+
 const Versions = {
 	AddUrlProp: 1,
 	AddCropProp: 2,

commit 6b1005ef71a63613a09606310f666487547d5f23
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Wed Jan 3 12:13:15 2024 +0000

    [tech debt] Primitives renaming party / cleanup (#2396)
    
    This PR:
    - renames Vec2d to Vec
    - renames Vec2dModel to VecModel
    - renames Box2d to Box
    - renames Box2dModel to BoxModel
    - renames Matrix2d to Mat
    - renames Matrix2dModel to MatModel
    - removes unused primitive helpers
    - removes unused exports
    - removes a few redundant tests in dgreensp
    
    ### Change Type
    
    - [x] `major` — Breaking change
    
    ### Release Notes
    
    - renames Vec2d to Vec
    - renames Vec2dModel to VecModel
    - renames Box2d to Box
    - renames Box2dModel to BoxModel
    - renames Matrix2d to Mat
    - renames Matrix2dModel to MatModel
    - removes unused primitive helpers

diff --git a/packages/tlschema/src/shapes/TLImageShape.ts b/packages/tlschema/src/shapes/TLImageShape.ts
index e570f8a30..436870af8 100644
--- a/packages/tlschema/src/shapes/TLImageShape.ts
+++ b/packages/tlschema/src/shapes/TLImageShape.ts
@@ -1,13 +1,13 @@
 import { defineMigrations } from '@tldraw/store'
 import { T } from '@tldraw/validate'
 import { assetIdValidator } from '../assets/TLBaseAsset'
-import { vec2dModelValidator } from '../misc/geometry-types'
+import { vecModelValidator } from '../misc/geometry-types'
 import { ShapePropsType, TLBaseShape } from './TLBaseShape'
 
 /** @public */
 export const ImageShapeCrop = T.object({
-	topLeft: vec2dModelValidator,
-	bottomRight: vec2dModelValidator,
+	topLeft: vecModelValidator,
+	bottomRight: vecModelValidator,
 })
 /** @public */
 export type TLImageShapeCrop = T.TypeOf<typeof ImageShapeCrop>

commit 6e9fe0c8be339c11e922b1e7ff4ffd177f33d23e
Author: Mitja Bezenšek <mitja.bezensek@gmail.com>
Date:   Tue Jan 9 11:49:57 2024 +0100

    Add url validation (#2428)
    
    Adds validation for urls we use for our shapes and assets. This PR
    includes a migration so we should check that existing rooms still load
    correctly. There might be some that won't, but that means that they had
    invalid url set.
    
    ### Change Type
    
    - [x] `patch` — Bug fix
    - [ ] `minor` — New feature
    - [ ] `major` — Breaking change
    - [ ] `dependencies` — Changes to package dependencies[^1]
    - [ ] `documentation` — Changes to the documentation only[^2]
    - [ ] `tests` — Changes to any test code only[^2]
    - [ ] `internal` — Any other changes that don't affect the published
    package[^2]
    - [ ] I don't know
    
    [^1]: publishes a `patch` release, for devDependencies use `internal`
    [^2]: will not publish a new version
    
    ### Test Plan
    1. Existing rooms should still load correctly (there should be no
    validation errors).
    2. Adding new images and videos should also work (test both local and
    multiplayer rooms as they handle assets differently).
    
    - [x] Unit Tests
    - [ ] End to end tests
    
    ### Release Notes
    
    - Add validation to urls.
    
    ---------
    
    Co-authored-by: alex <alex@dytry.ch>

diff --git a/packages/tlschema/src/shapes/TLImageShape.ts b/packages/tlschema/src/shapes/TLImageShape.ts
index 436870af8..f599c18c6 100644
--- a/packages/tlschema/src/shapes/TLImageShape.ts
+++ b/packages/tlschema/src/shapes/TLImageShape.ts
@@ -17,7 +17,7 @@ export const imageShapeProps = {
 	w: T.nonZeroNumber,
 	h: T.nonZeroNumber,
 	playing: T.boolean,
-	url: T.string,
+	url: T.linkUrl,
 	assetId: assetIdValidator.nullable(),
 	crop: ImageShapeCrop.nullable(),
 }
@@ -31,11 +31,12 @@ export type TLImageShape = TLBaseShape<'image', TLImageShapeProps>
 const Versions = {
 	AddUrlProp: 1,
 	AddCropProp: 2,
+	MakeUrlsValid: 3,
 } as const
 
 /** @internal */
 export const imageShapeMigrations = defineMigrations({
-	currentVersion: Versions.AddCropProp,
+	currentVersion: Versions.MakeUrlsValid,
 	migrators: {
 		[Versions.AddUrlProp]: {
 			up: (shape) => {
@@ -55,5 +56,15 @@ export const imageShapeMigrations = defineMigrations({
 				return { ...shape, props }
 			},
 		},
+		[Versions.MakeUrlsValid]: {
+			up: (shape) => {
+				const url = shape.props.url
+				if (url !== '' && !T.linkUrl.isValid(shape.props.url)) {
+					return { ...shape, props: { ...shape.props, url: '' } }
+				}
+				return shape
+			},
+			down: (shape) => shape,
+		},
 	},
 })

commit 4f70a4f4e85b278e79a4afadec2eeb08f26879a8
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Mon Apr 15 13:53:42 2024 +0100

    New migrations again (#3220)
    
    Describe what your pull request does. If appropriate, add GIFs or images
    showing the before and after.
    
    ### Change Type
    
    - [x] `sdk` — Changes the tldraw SDK
    - [x] `galaxy brain` — Architectural changes
    
    
    
    ### Test Plan
    
    1. Add a step-by-step description of how to test your PR here.
    2.
    
    - [ ] Unit Tests
    - [ ] End to end tests
    
    ### Release Notes
    
    #### BREAKING CHANGES
    
    - The `Migrations` type is now called `LegacyMigrations`.
    - The serialized schema format (e.g. returned by
    `StoreSchema.serialize()` and `Store.getSnapshot()`) has changed. You
    don't need to do anything about it unless you were reading data directly
    from the schema for some reason. In which case it'd be best to avoid
    that in the future! We have no plans to change the schema format again
    (this time was traumatic enough) but you never know.
    - `compareRecordVersions` and the `RecordVersion` type have both
    disappeared. There is no replacement. These were public by mistake
    anyway, so hopefully nobody had been using it.
    - `compareSchemas` is a bit less useful now. Our migrations system has
    become a little fuzzy to allow for simpler UX when adding/removing
    custom extensions and 3rd party dependencies, and as a result we can no
    longer compare serialized schemas in any rigorous manner. You can rely
    on this function to return `0` if the schemas are the same. Otherwise it
    will return `-1` if the schema on the right _seems_ to be newer than the
    schema on the left, but it cannot guarantee that in situations where
    migration sequences have been removed over time (e.g. if you remove one
    of the builtin tldraw shapes).
    
    Generally speaking, the best way to check schema compatibility now is to
    call `store.schema.getMigrationsSince(persistedSchema)`. This will throw
    an error if there is no upgrade path from the `persistedSchema` to the
    current version.
    
    - `defineMigrations` has been deprecated and will be removed in a future
    release. For upgrade instructions see
    https://tldraw.dev/docs/persistence#Updating-legacy-shape-migrations-defineMigrations
    
    - `migrate` has been removed. Nobody should have been using this but if
    you were you'll need to find an alternative. For migrating tldraw data,
    you should stick to using `schema.migrateStoreSnapshot` and, if you are
    building a nuanced sync engine that supports some amount of backwards
    compatibility, also feel free to use `schema.migratePersistedRecord`.
    - the `Migration` type has changed. If you need the old one for some
    reason it has been renamed to `LegacyMigration`. It will be removed in a
    future release.
    - the `Migrations` type has been renamed to `LegacyMigrations` and will
    be removed in a future release.
    - the `SerializedSchema` type has been augmented. If you need the old
    version specifically you can use `SerializedSchemaV1`
    
    ---------
    
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/packages/tlschema/src/shapes/TLImageShape.ts b/packages/tlschema/src/shapes/TLImageShape.ts
index f599c18c6..33a67e8b4 100644
--- a/packages/tlschema/src/shapes/TLImageShape.ts
+++ b/packages/tlschema/src/shapes/TLImageShape.ts
@@ -1,7 +1,11 @@
-import { defineMigrations } from '@tldraw/store'
 import { T } from '@tldraw/validate'
 import { assetIdValidator } from '../assets/TLBaseAsset'
 import { vecModelValidator } from '../misc/geometry-types'
+import {
+	RETIRED_DOWN_MIGRATION,
+	createShapePropsMigrationIds,
+	createShapePropsMigrationSequence,
+} from '../records/TLShape'
 import { ShapePropsType, TLBaseShape } from './TLBaseShape'
 
 /** @public */
@@ -28,43 +32,43 @@ export type TLImageShapeProps = ShapePropsType<typeof imageShapeProps>
 /** @public */
 export type TLImageShape = TLBaseShape<'image', TLImageShapeProps>
 
-const Versions = {
+const Versions = createShapePropsMigrationIds('image', {
 	AddUrlProp: 1,
 	AddCropProp: 2,
 	MakeUrlsValid: 3,
-} as const
+})
+
+export { Versions as imageShapeVersions }
 
 /** @internal */
-export const imageShapeMigrations = defineMigrations({
-	currentVersion: Versions.MakeUrlsValid,
-	migrators: {
-		[Versions.AddUrlProp]: {
-			up: (shape) => {
-				return { ...shape, props: { ...shape.props, url: '' } }
-			},
-			down: (shape) => {
-				const { url: _, ...props } = shape.props
-				return { ...shape, props }
+export const imageShapeMigrations = createShapePropsMigrationSequence({
+	sequence: [
+		{
+			id: Versions.AddUrlProp,
+			up: (props) => {
+				props.url = ''
 			},
+			down: RETIRED_DOWN_MIGRATION,
 		},
-		[Versions.AddCropProp]: {
-			up: (shape) => {
-				return { ...shape, props: { ...shape.props, crop: null } }
+		{
+			id: Versions.AddCropProp,
+			up: (props) => {
+				props.crop = null
 			},
-			down: (shape) => {
-				const { crop: _, ...props } = shape.props
-				return { ...shape, props }
+			down: (props) => {
+				delete props.crop
 			},
 		},
-		[Versions.MakeUrlsValid]: {
-			up: (shape) => {
-				const url = shape.props.url
-				if (url !== '' && !T.linkUrl.isValid(shape.props.url)) {
-					return { ...shape, props: { ...shape.props, url: '' } }
+		{
+			id: Versions.MakeUrlsValid,
+			up: (props) => {
+				if (!T.linkUrl.isValid(props.url)) {
+					props.url = ''
 				}
-				return shape
 			},
-			down: (shape) => shape,
+			down: (_props) => {
+				// noop
+			},
 		},
-	},
+	],
 })

commit f78719b0547ad543ab32691bec80d0601847f3d6
Author: alex <alex@dytry.ch>
Date:   Thu Apr 25 15:31:26 2024 +0100

    Expose migrations, validators, and versions from tlschema (#3613)
    
    Previously, we weren't exporting migrations & validators for our default
    shapes. This meant that it wasn't possible to make your own tlschema
    with both our default shapes and some of your own (e.g. for custom
    multiplayer). This fixes that by exposing all the migrations,
    validators, and versions from tlschema.
    
    ### Change Type
    - [x] `sdk` — Changes the tldraw SDK
    - [x] `bugfix` — Bug fix

diff --git a/packages/tlschema/src/shapes/TLImageShape.ts b/packages/tlschema/src/shapes/TLImageShape.ts
index 33a67e8b4..48f248066 100644
--- a/packages/tlschema/src/shapes/TLImageShape.ts
+++ b/packages/tlschema/src/shapes/TLImageShape.ts
@@ -40,7 +40,7 @@ const Versions = createShapePropsMigrationIds('image', {
 
 export { Versions as imageShapeVersions }
 
-/** @internal */
+/** @public */
 export const imageShapeMigrations = createShapePropsMigrationSequence({
 	sequence: [
 		{

commit da35f2bd75e43fd48d11a9a74f60ee01c84a41d1
Author: alex <alex@dytry.ch>
Date:   Wed May 8 13:37:31 2024 +0100

    Bindings (#3326)
    
    First draft of the new bindings API. We'll follow this up with some API
    refinements, tests, documentation, and examples.
    
    Bindings are a new record type for establishing relationships between
    two shapes so they can update at the same time.
    
    ### Change Type
    
    - [x] `sdk` — Changes the tldraw SDK
    - [x] `feature` — New feature
    
    ### Release Notes
    
    #### Breaking changes
    - The `start` and `end` properties on `TLArrowShape` no longer have
    `type: point | binding`. Instead, they're always a point, which may be
    out of date if a binding exists. To check for & retrieve arrow bindings,
    use `getArrowBindings(editor, shape)` instead.
    - `getArrowTerminalsInArrowSpace` must be passed a `TLArrowBindings` as
    a third argument: `getArrowTerminalsInArrowSpace(editor, shape,
    getArrowBindings(editor, shape))`
    - The following types have been renamed:
        - `ShapeProps` -> `RecordProps`
        - `ShapePropsType` -> `RecordPropsType`
        - `TLShapePropsMigrations` -> `TLPropsMigrations`
        - `SchemaShapeInfo` -> `SchemaPropsInfo`
    
    ---------
    
    Co-authored-by: David Sheldrick <d.j.sheldrick@gmail.com>

diff --git a/packages/tlschema/src/shapes/TLImageShape.ts b/packages/tlschema/src/shapes/TLImageShape.ts
index 48f248066..798f2bb7d 100644
--- a/packages/tlschema/src/shapes/TLImageShape.ts
+++ b/packages/tlschema/src/shapes/TLImageShape.ts
@@ -1,12 +1,9 @@
 import { T } from '@tldraw/validate'
 import { assetIdValidator } from '../assets/TLBaseAsset'
 import { vecModelValidator } from '../misc/geometry-types'
-import {
-	RETIRED_DOWN_MIGRATION,
-	createShapePropsMigrationIds,
-	createShapePropsMigrationSequence,
-} from '../records/TLShape'
-import { ShapePropsType, TLBaseShape } from './TLBaseShape'
+import { createShapePropsMigrationIds, createShapePropsMigrationSequence } from '../records/TLShape'
+import { RETIRED_DOWN_MIGRATION, RecordPropsType } from '../recordsWithProps'
+import { TLBaseShape } from './TLBaseShape'
 
 /** @public */
 export const ImageShapeCrop = T.object({
@@ -27,7 +24,7 @@ export const imageShapeProps = {
 }
 
 /** @public */
-export type TLImageShapeProps = ShapePropsType<typeof imageShapeProps>
+export type TLImageShapeProps = RecordPropsType<typeof imageShapeProps>
 
 /** @public */
 export type TLImageShape = TLBaseShape<'image', TLImageShapeProps>

commit fb0dd1d2fe7d974dfa194264b4c3f196469cba97
Author: alex <alex@dytry.ch>
Date:   Mon Jun 10 14:50:03 2024 +0100

    make sure everything marked @public gets documented (#3892)
    
    Previously, we had the `ae-forgotten-export` rule from api-extractor
    disabled. This rule makes sure that everything that's referred to in the
    public API is actually exported. There are more details on the rule
    [here](https://api-extractor.com/pages/messages/ae-forgotten-export/),
    but not exporting public API entires is bad because they're hard to
    document and can't be typed/called from consumer code. For us, the big
    effect is that they don't appear in our docs at all.
    
    This diff re-enables that rule. Now, if you introduce something new to
    the public API but don't export it, your build will fail.
    
    ### Change Type
    
    - [x] `docs` — Changes to the documentation, examples, or templates.
    - [x] `improvement` — Improving existing features

diff --git a/packages/tlschema/src/shapes/TLImageShape.ts b/packages/tlschema/src/shapes/TLImageShape.ts
index 798f2bb7d..c9853a32a 100644
--- a/packages/tlschema/src/shapes/TLImageShape.ts
+++ b/packages/tlschema/src/shapes/TLImageShape.ts
@@ -2,7 +2,7 @@ import { T } from '@tldraw/validate'
 import { assetIdValidator } from '../assets/TLBaseAsset'
 import { vecModelValidator } from '../misc/geometry-types'
 import { createShapePropsMigrationIds, createShapePropsMigrationSequence } from '../records/TLShape'
-import { RETIRED_DOWN_MIGRATION, RecordPropsType } from '../recordsWithProps'
+import { RecordPropsType } from '../recordsWithProps'
 import { TLBaseShape } from './TLBaseShape'
 
 /** @public */
@@ -45,7 +45,7 @@ export const imageShapeMigrations = createShapePropsMigrationSequence({
 			up: (props) => {
 				props.url = ''
 			},
-			down: RETIRED_DOWN_MIGRATION,
+			down: 'retired',
 		},
 		{
 			id: Versions.AddCropProp,

commit 9a3afa2e2aff52d219e605f9850b46e786fe0b5c
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Tue Jul 9 12:01:03 2024 +0100

    Flip images (#4113)
    
    This PR adds the ability to flip images.
    
    ### Change type
    
    - [x] `improvement`
    
    ### Test plan
    
    1. Resize an image shape
    2. Select an image shape and use the flip X / flip Y options in the
    context menu.
    
    - [x] Unit tests
    
    ### Release notes
    
    - Adds the ability to flip images.

diff --git a/packages/tlschema/src/shapes/TLImageShape.ts b/packages/tlschema/src/shapes/TLImageShape.ts
index c9853a32a..8584d65f4 100644
--- a/packages/tlschema/src/shapes/TLImageShape.ts
+++ b/packages/tlschema/src/shapes/TLImageShape.ts
@@ -21,6 +21,8 @@ export const imageShapeProps = {
 	url: T.linkUrl,
 	assetId: assetIdValidator.nullable(),
 	crop: ImageShapeCrop.nullable(),
+	flipX: T.boolean,
+	flipY: T.boolean,
 }
 
 /** @public */
@@ -33,6 +35,7 @@ const Versions = createShapePropsMigrationIds('image', {
 	AddUrlProp: 1,
 	AddCropProp: 2,
 	MakeUrlsValid: 3,
+	AddFlipProps: 4,
 })
 
 export { Versions as imageShapeVersions }
@@ -67,5 +70,16 @@ export const imageShapeMigrations = createShapePropsMigrationSequence({
 				// noop
 			},
 		},
+		{
+			id: Versions.AddFlipProps,
+			up: (props) => {
+				props.flipX = false
+				props.flipY = false
+			},
+			down: (props) => {
+				delete props.flipX
+				delete props.flipY
+			},
+		},
 	],
 })

commit d85aac58b3292ba81889f29cc4dcbe05d04cfd68
Author: alex <alex@dytry.ch>
Date:   Tue Jul 16 14:16:39 2024 +0100

    Explicitly type shape props and defaults (#4191)
    
    We rely on type inference for our `defaultX` types, as well as for our
    shape prop types. This works well and means we only have to list shape
    props once, but has some drawbacks:
    - It's unstable, which sometimes produces unintended api-report.md diffs
    that need to be worked around
    - It's not good for docs
    
    This diff makes those declared explicitly
    
    ### Change type
    
    - [x] `api`
    
    ### Release notes
    
    - Explicitly declare type types of default shapes etc. and shape props
    for better documentation

diff --git a/packages/tlschema/src/shapes/TLImageShape.ts b/packages/tlschema/src/shapes/TLImageShape.ts
index 8584d65f4..e704062f9 100644
--- a/packages/tlschema/src/shapes/TLImageShape.ts
+++ b/packages/tlschema/src/shapes/TLImageShape.ts
@@ -1,20 +1,40 @@
 import { T } from '@tldraw/validate'
 import { assetIdValidator } from '../assets/TLBaseAsset'
-import { vecModelValidator } from '../misc/geometry-types'
+import { VecModel, vecModelValidator } from '../misc/geometry-types'
+import { TLAssetId } from '../records/TLAsset'
 import { createShapePropsMigrationIds, createShapePropsMigrationSequence } from '../records/TLShape'
-import { RecordPropsType } from '../recordsWithProps'
+import { RecordProps } from '../recordsWithProps'
 import { TLBaseShape } from './TLBaseShape'
 
 /** @public */
-export const ImageShapeCrop = T.object({
+export interface TLImageShapeCrop {
+	topLeft: VecModel
+	bottomRight: VecModel
+}
+
+/** @public */
+export const ImageShapeCrop: T.ObjectValidator<TLImageShapeCrop> = T.object({
 	topLeft: vecModelValidator,
 	bottomRight: vecModelValidator,
 })
+
 /** @public */
-export type TLImageShapeCrop = T.TypeOf<typeof ImageShapeCrop>
+export interface TLImageShapeProps {
+	w: number
+	h: number
+	playing: boolean
+	url: string
+	assetId: TLAssetId | null
+	crop: TLImageShapeCrop | null
+	flipX: boolean
+	flipY: boolean
+}
 
 /** @public */
-export const imageShapeProps = {
+export type TLImageShape = TLBaseShape<'image', TLImageShapeProps>
+
+/** @public */
+export const imageShapeProps: RecordProps<TLImageShape> = {
 	w: T.nonZeroNumber,
 	h: T.nonZeroNumber,
 	playing: T.boolean,
@@ -25,12 +45,6 @@ export const imageShapeProps = {
 	flipY: T.boolean,
 }
 
-/** @public */
-export type TLImageShapeProps = RecordPropsType<typeof imageShapeProps>
-
-/** @public */
-export type TLImageShape = TLBaseShape<'image', TLImageShapeProps>
-
 const Versions = createShapePropsMigrationIds('image', {
 	AddUrlProp: 1,
 	AddCropProp: 2,

commit 7a17cab026a311d76361825f446407b0e330597c
Author: Trygve Aaberge <trygve.aaberge@autodesk.com>
Date:   Tue Jan 28 11:42:43 2025 +0100

    Add an onCrop handler to ShapeUtil (#5137)
    
    This is called when cropping and allows you to override the crop
    calculations. This is useful for instance to set a min width and/or
    height for the cropping.
    
    It can also be used to provide a completely different cropping
    mechanism, e.g. to keep the size of the shape fixed and instead resize
    the image when cropping. This would require overriding the
    SelectionForeground component, but it's better to only have to override
    that than the whole selection tool. And maybe that component can be made
    more dynamic in the future.
    
    This also defines specific crop interfaces instead of using the ones
    from the image shape and uses the correct util instead of the image util
    when cropping. Any shape can define that it supports cropping, so I
    don't think it should be tied to the image shape.
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [x] `api`
    - [ ] `other`
    
    ### Test plan
    
    1. Add an onCrop handler to a util for a shape that can be cropped.
    1. Create a shape with a crop prop.
    2. Try to crop the shape and see that the behavior in onCrop is applied.
    
    - [x] Unit tests
    - [ ] End to end tests
    
    ### Release notes
    
    - Add support for an onCrop handler on shape utils that allows you to
    prevent or modify the crop.
    - The `TLImageShapeCrop` type has been replaced by `TLShapeCrop`.
    
    ---------
    
    Co-authored-by: Mime Čuvalo <mimecuvalo@gmail.com>

diff --git a/packages/tlschema/src/shapes/TLImageShape.ts b/packages/tlschema/src/shapes/TLImageShape.ts
index e704062f9..222d02b1f 100644
--- a/packages/tlschema/src/shapes/TLImageShape.ts
+++ b/packages/tlschema/src/shapes/TLImageShape.ts
@@ -1,19 +1,14 @@
 import { T } from '@tldraw/validate'
 import { assetIdValidator } from '../assets/TLBaseAsset'
-import { VecModel, vecModelValidator } from '../misc/geometry-types'
+import { vecModelValidator } from '../misc/geometry-types'
 import { TLAssetId } from '../records/TLAsset'
 import { createShapePropsMigrationIds, createShapePropsMigrationSequence } from '../records/TLShape'
 import { RecordProps } from '../recordsWithProps'
+import { TLShapeCrop } from './ShapeWithCrop'
 import { TLBaseShape } from './TLBaseShape'
 
 /** @public */
-export interface TLImageShapeCrop {
-	topLeft: VecModel
-	bottomRight: VecModel
-}
-
-/** @public */
-export const ImageShapeCrop: T.ObjectValidator<TLImageShapeCrop> = T.object({
+export const ImageShapeCrop: T.ObjectValidator<TLShapeCrop> = T.object({
 	topLeft: vecModelValidator,
 	bottomRight: vecModelValidator,
 })
@@ -25,7 +20,7 @@ export interface TLImageShapeProps {
 	playing: boolean
 	url: string
 	assetId: TLAssetId | null
-	crop: TLImageShapeCrop | null
+	crop: TLShapeCrop | null
 	flipX: boolean
 	flipY: boolean
 }

commit 4ecb34d3434dbd9ad3119d4dfc66b7af4e598faf
Author: Mime Čuvalo <mimecuvalo@gmail.com>
Date:   Mon Apr 7 22:05:44 2025 +0100

    a11y: announce shapes as they're visited (#5773)
    
    Building off of https://github.com/tldraw/tldraw/pull/5634 and
    https://github.com/tldraw/tldraw/pull/5761 this is adding a11y live text
    to be read aloud when visiting a shape.
    
    We add an overridable method for shapes to customize this called
    `getAriaLiveText`.
    Furthermore, we lay the groundwork here to start letting media shapes
    have `altText`.
    Drive-by fix of `heart` being missing in `geo-styles` list.
    Also, drive-by fix of us calling our Image button "Asset" (what are we
    selling financial instruments here? :P) "Media" is a better word for
    this button, more human.
    
    Some of the i18n translation is funky. It's a shortcoming of our current
    system that we don't support interpolation :-/
    It sucks, and we'll revisit in the future.
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [x] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Release notes
    
    - a11y: announce shapes as they're visited
    
    ---------
    
    Co-authored-by: alex <alex@dytry.ch>

diff --git a/packages/tlschema/src/shapes/TLImageShape.ts b/packages/tlschema/src/shapes/TLImageShape.ts
index 222d02b1f..8efb8b68e 100644
--- a/packages/tlschema/src/shapes/TLImageShape.ts
+++ b/packages/tlschema/src/shapes/TLImageShape.ts
@@ -23,6 +23,7 @@ export interface TLImageShapeProps {
 	crop: TLShapeCrop | null
 	flipX: boolean
 	flipY: boolean
+	altText: string
 }
 
 /** @public */
@@ -38,6 +39,7 @@ export const imageShapeProps: RecordProps<TLImageShape> = {
 	crop: ImageShapeCrop.nullable(),
 	flipX: T.boolean,
 	flipY: T.boolean,
+	altText: T.string,
 }
 
 const Versions = createShapePropsMigrationIds('image', {
@@ -45,6 +47,7 @@ const Versions = createShapePropsMigrationIds('image', {
 	AddCropProp: 2,
 	MakeUrlsValid: 3,
 	AddFlipProps: 4,
+	AddAltText: 5,
 })
 
 export { Versions as imageShapeVersions }
@@ -90,5 +93,14 @@ export const imageShapeMigrations = createShapePropsMigrationSequence({
 				delete props.flipY
 			},
 		},
+		{
+			id: Versions.AddAltText,
+			up: (props) => {
+				props.altText = ''
+			},
+			down: (props) => {
+				delete props.altText
+			},
+		},
 	],
 })

