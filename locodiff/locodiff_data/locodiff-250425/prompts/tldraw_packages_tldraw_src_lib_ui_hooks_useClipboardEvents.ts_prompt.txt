# Instructions

You are being benchmarked. You will see the output of a git log command, and from that must infer the current state of a file. Think carefully, as you must output the exact state of the file to earn full marks.

**Important:** Your goal is to reproduce the file's content *exactly* as it exists at the final commit, even if the code appears broken, buggy, or contains obvious errors. Do **not** try to "fix" the code. Attempting to correct issues will result in a poor score, as this benchmark evaluates your ability to reproduce the precise state of the file based on its history.

# Required Response Format

Wrap the content of the file in triple backticks (```). Any text outside the final closing backticks will be ignored. End your response after outputting the closing backticks.

# Example Response

```python
#!/usr/bin/env python
print('Hello, world!')
```

# File History

> git log -p --cc --topo-order --reverse -- packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts

commit b7d9c8684cb6cf7bd710af5420135ea3516cc3bf
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon Jul 17 22:22:34 2023 +0100

    tldraw zero - package shuffle (#1710)
    
    This PR moves code between our packages so that:
    - @tldraw/editor is a ‚Äúcore‚Äù library with the engine and canvas but no
    shapes, tools, or other things
    - @tldraw/tldraw contains everything particular to the experience we‚Äôve
    built for tldraw
    
    At first look, this might seem like a step away from customization and
    configuration, however I believe it greatly increases the configuration
    potential of the @tldraw/editor while also providing a more accurate
    reflection of what configuration options actually exist for
    @tldraw/tldraw.
    
    ## Library changes
    
    @tldraw/editor re-exports its dependencies and @tldraw/tldraw re-exports
    @tldraw/editor.
    
    - users of @tldraw/editor WITHOUT @tldraw/tldraw should almost always
    only import things from @tldraw/editor.
    - users of @tldraw/tldraw should almost always only import things from
    @tldraw/tldraw.
    
    - @tldraw/polyfills is merged into @tldraw/editor
    - @tldraw/indices is merged into @tldraw/editor
    - @tldraw/primitives is merged mostly into @tldraw/editor, partially
    into @tldraw/tldraw
    - @tldraw/file-format is merged into @tldraw/tldraw
    - @tldraw/ui is merged into @tldraw/tldraw
    
    Many (many) utils and other code is moved from the editor to tldraw. For
    example, embeds now are entirely an feature of @tldraw/tldraw. The only
    big chunk of code left in core is related to arrow handling.
    
    ## API Changes
    
    The editor can now be used without tldraw's assets. We load them in
    @tldraw/tldraw instead, so feel free to use whatever fonts or images or
    whatever that you like with the editor.
    
    All tools and shapes (except for the `Group` shape) are moved to
    @tldraw/tldraw. This includes the `select` tool.
    
    You should use the editor with at least one tool, however, so you now
    also need to send in an `initialState` prop to the Editor /
    <TldrawEditor> component indicating which state the editor should begin
    in.
    
    The `components` prop now also accepts `SelectionForeground`.
    
    The complex selection component that we use for tldraw is moved to
    @tldraw/tldraw. The default component is quite basic but can easily be
    replaced via the `components` prop. We pass down our tldraw-flavored
    SelectionFg via `components`.
    
    Likewise with the `Scribble` component: the `DefaultScribble` no longer
    uses our freehand tech and is a simple path instead. We pass down the
    tldraw-flavored scribble via `components`.
    
    The `ExternalContentManager` (`Editor.externalContentManager`) is
    removed and replaced with a mapping of types to handlers.
    
    - Register new content handlers with
    `Editor.registerExternalContentHandler`.
    - Register new asset creation handlers (for files and URLs) with
    `Editor.registerExternalAssetHandler`
    
    ### Change Type
    
    - [x] `major` ‚Äî Breaking change
    
    ### Test Plan
    
    - [x] Unit Tests
    - [x] End to end tests
    
    ### Release Notes
    
    - [@tldraw/editor] lots, wip
    - [@tldraw/ui] gone, merged to tldraw/tldraw
    - [@tldraw/polyfills] gone, merged to tldraw/editor
    - [@tldraw/primitives] gone, merged to tldraw/editor / tldraw/tldraw
    - [@tldraw/indices] gone, merged to tldraw/editor
    - [@tldraw/file-format] gone, merged to tldraw/tldraw
    
    ---------
    
    Co-authored-by: alex <alex@dytry.ch>

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
new file mode 100644
index 000000000..c89abedbc
--- /dev/null
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -0,0 +1,720 @@
+import {
+	Editor,
+	TLArrowShape,
+	TLBookmarkShape,
+	TLContent,
+	TLEmbedShape,
+	TLGeoShape,
+	TLTextShape,
+	VecLike,
+	isNonNull,
+	uniq,
+	useEditor,
+} from '@tldraw/editor'
+import { compressToBase64, decompressFromBase64 } from 'lz-string'
+import { useCallback, useEffect } from 'react'
+import { pasteExcalidrawContent } from './clipboard/pasteExcalidrawContent'
+import { pasteFiles } from './clipboard/pasteFiles'
+import { pasteTldrawContent } from './clipboard/pasteTldrawContent'
+import { pasteUrl } from './clipboard/pasteUrl'
+import { useEditorIsFocused } from './useEditorIsFocused'
+import { TLUiEventSource, useEvents } from './useEventsProvider'
+
+/** @public */
+export const isValidHttpURL = (url: string) => {
+	try {
+		const u = new URL(url)
+		return u.protocol === 'http:' || u.protocol === 'https:'
+	} catch (e) {
+		return false
+	}
+}
+
+/** @public */
+const getValidHttpURLList = (url: string) => {
+	const urls = url.split(/[\n\s]/)
+	for (const url of urls) {
+		try {
+			const u = new URL(url)
+			if (!(u.protocol === 'http:' || u.protocol === 'https:')) {
+				return
+			}
+		} catch (e) {
+			return
+		}
+	}
+	return uniq(urls)
+}
+
+/** @public */
+const isSvgText = (text: string) => {
+	return /^<svg/.test(text)
+}
+
+const INPUTS = ['input', 'select', 'textarea']
+
+/**
+ * Get whether to disallow clipboard events.
+ *
+ * @param editor - The editor instance.
+ * @internal
+ */
+function disallowClipboardEvents(editor: Editor) {
+	const { activeElement } = document
+	return (
+		editor.isMenuOpen ||
+		(activeElement &&
+			(activeElement.getAttribute('contenteditable') ||
+				INPUTS.indexOf(activeElement.tagName.toLowerCase()) > -1))
+	)
+}
+
+/**
+ * Get a blob as a string.
+ *
+ * @param blob - The blob to get as a string.
+ * @internal
+ */
+async function blobAsString(blob: Blob) {
+	return new Promise<string>((resolve, reject) => {
+		const reader = new FileReader()
+		reader.addEventListener('loadend', () => {
+			const text = reader.result
+			resolve(text as string)
+		})
+		reader.addEventListener('error', () => {
+			reject(reader.error)
+		})
+		reader.readAsText(blob)
+	})
+}
+
+/**
+ * Strip HTML tags from a string.
+ * @param html - The HTML to strip.
+ * @internal
+ */
+function stripHtml(html: string) {
+	// See <https://github.com/developit/preact-markup/blob/4788b8d61b4e24f83688710746ee36e7464f7bbc/src/parse-markup.js#L60-L69>
+	const doc = document.implementation.createHTMLDocument('')
+	doc.documentElement.innerHTML = html.trim()
+	return doc.body.textContent || doc.body.innerText || ''
+}
+
+/**
+ * Whether a ClipboardItem is a file.
+ * @param item - The ClipboardItem to check.
+ * @internal
+ */
+const isFile = (item: ClipboardItem) => {
+	return item.types.find((i) => i.match(/^image\//))
+}
+
+/**
+ * Handle text pasted into the editor.
+ * @param editor - The editor instance.
+ * @param data - The text to paste.
+ * @param point - (optional) The point at which to paste the text.
+ * @internal
+ */
+const handleText = (editor: Editor, data: string, point?: VecLike) => {
+	const validUrlList = getValidHttpURLList(data)
+	if (validUrlList) {
+		for (const url of validUrlList) {
+			pasteUrl(editor, url, point)
+		}
+	} else if (isValidHttpURL(data)) {
+		pasteUrl(editor, data, point)
+	} else if (isSvgText(data)) {
+		editor.mark('paste')
+		editor.putExternalContent({
+			type: 'svg-text',
+			text: data,
+			point,
+		})
+	} else {
+		editor.mark('paste')
+		editor.putExternalContent({
+			type: 'text',
+			text: data,
+			point,
+		})
+	}
+}
+
+/**
+ * Something found on the clipboard, either through the event's clipboard data or the browser's clipboard API.
+ * @internal
+ */
+type ClipboardThing =
+	| {
+			type: 'file'
+			source: Promise<File | null>
+	  }
+	| {
+			type: 'blob'
+			source: Promise<Blob | null>
+	  }
+	| {
+			type: 'url'
+			source: Promise<string>
+	  }
+	| {
+			type: 'html'
+			source: Promise<string>
+	  }
+	| {
+			type: 'text'
+			source: Promise<string>
+	  }
+	| {
+			type: string
+			source: Promise<string>
+	  }
+
+/**
+ * The result of processing a `ClipboardThing`.
+ * @internal
+ */
+type ClipboardResult =
+	| {
+			type: 'tldraw'
+			data: TLContent
+	  }
+	| {
+			type: 'excalidraw'
+			data: any
+	  }
+	| {
+			type: 'text'
+			data: string
+			subtype: 'json' | 'html' | 'text' | 'url'
+	  }
+	| {
+			type: 'error'
+			data: string | null
+			reason: string
+	  }
+
+/**
+ * Handle a paste using event clipboard data. This is the "original"
+ * paste method that uses the clipboard data from the paste event.
+ * https://developer.mozilla.org/en-US/docs/Web/API/ClipboardEvent/clipboardData
+ *
+ * @param editor - The editor
+ * @param clipboardData - The clipboard data
+ * @param point - (optional) The point to paste at
+ * @internal
+ */
+const handlePasteFromEventClipboardData = async (
+	editor: Editor,
+	clipboardData: DataTransfer,
+	point?: VecLike
+) => {
+	// Do not paste while in any editing state
+	if (editor.editingId !== null) return
+
+	if (!clipboardData) {
+		throw Error('No clipboard data')
+	}
+
+	const things: ClipboardThing[] = []
+
+	for (const item of Object.values(clipboardData.items)) {
+		switch (item.kind) {
+			case 'file': {
+				// files are always blobs
+				things.push({
+					type: 'file',
+					source: new Promise((r) => r(item.getAsFile())) as Promise<File | null>,
+				})
+				break
+			}
+			case 'string': {
+				// strings can be text or html
+				if (item.type === 'text/html') {
+					things.push({
+						type: 'html',
+						source: new Promise((r) => item.getAsString(r)) as Promise<string>,
+					})
+				} else if (item.type === 'text/plain') {
+					things.push({
+						type: 'text',
+						source: new Promise((r) => item.getAsString(r)) as Promise<string>,
+					})
+				} else {
+					things.push({ type: item.type, source: new Promise((r) => item.getAsString(r)) })
+				}
+				break
+			}
+		}
+	}
+
+	handleClipboardThings(editor, things, point)
+}
+
+/**
+ * Handle a paste using items retrieved from the Clipboard API.
+ * https://developer.mozilla.org/en-US/docs/Web/API/ClipboardItem
+ *
+ * @param editor - The editor
+ * @param clipboardItems - The clipboard items to handle
+ * @param point - (optional) The point to paste at
+ * @internal
+ */
+const handlePasteFromClipboardApi = async (
+	editor: Editor,
+	clipboardItems: ClipboardItem[],
+	point?: VecLike
+) => {
+	// We need to populate the array of clipboard things
+	// based on the ClipboardItems from the Clipboard API.
+	// This is done in a different way than when using
+	// the clipboard data from the paste event.
+
+	const things: ClipboardThing[] = []
+
+	for (const item of clipboardItems) {
+		if (isFile(item)) {
+			for (const type of item.types) {
+				if (type.match(/^image\//)) {
+					things.push({ type: 'blob', source: item.getType(type) })
+				}
+			}
+		}
+
+		if (item.types.includes('text/html')) {
+			things.push({
+				type: 'html',
+				source: new Promise<string>((r) =>
+					item.getType('text/html').then((blob) => blobAsString(blob).then(r))
+				),
+			})
+		}
+
+		if (item.types.includes('text/uri-list')) {
+			things.push({
+				type: 'url',
+				source: new Promise<string>((r) =>
+					item.getType('text/uri-list').then((blob) => blobAsString(blob).then(r))
+				),
+			})
+		}
+
+		if (item.types.includes('text/plain')) {
+			things.push({
+				type: 'text',
+				source: new Promise<string>((r) =>
+					item.getType('text/plain').then((blob) => blobAsString(blob).then(r))
+				),
+			})
+		}
+	}
+
+	return await handleClipboardThings(editor, things, point)
+}
+
+async function handleClipboardThings(editor: Editor, things: ClipboardThing[], point?: VecLike) {
+	// 1. Handle files
+	//
+	// We need to handle files separately because if we want them to
+	// be placed next to each other, we need to create them all at once.
+
+	const files = things.filter(
+		(t) => (t.type === 'file' || t.type === 'blob') && t.source !== null
+	) as Extract<ClipboardThing, { type: 'file' } | { type: 'blob' }>[]
+
+	// Just paste the files, nothing else
+	if (files.length) {
+		const fileBlobs = await Promise.all(files.map((t) => t.source!))
+		const urls = (fileBlobs.filter(Boolean) as (File | Blob)[]).map((blob) =>
+			URL.createObjectURL(blob)
+		)
+		return await pasteFiles(editor, urls, point)
+	}
+
+	// 2. Generate clipboard results for non-file things
+	//
+	// Getting the source from the items is async, however they must be accessed syncronously;
+	// we can't await them in a loop. So we'll map them to promises and await them all at once,
+	// then make decisions based on what we find.
+
+	const results = await Promise.all<ClipboardResult>(
+		things
+			.filter((t) => t.type !== 'file')
+			.map(
+				(t) =>
+					new Promise((r) => {
+						const thing = t as Exclude<ClipboardThing, { type: 'file' } | { type: 'blob' }>
+
+						if (thing.type === 'file') {
+							r({ type: 'error', data: null, reason: 'unexpected file' })
+							return
+						}
+
+						thing.source.then((text) => {
+							// first, see if we can find tldraw content, which is JSON inside of an html comment
+							const tldrawHtmlComment = text.match(/<tldraw[^>]*>(.*)<\/tldraw>/)?.[1]
+
+							if (tldrawHtmlComment) {
+								try {
+									// If we've found tldraw content in the html string, use that as JSON
+									const jsonComment = decompressFromBase64(tldrawHtmlComment)
+									if (jsonComment === null) {
+										r({
+											type: 'error',
+											data: jsonComment,
+											reason: `found tldraw data comment but could not parse base64`,
+										})
+										return
+									} else {
+										const json = JSON.parse(jsonComment)
+										if (json.type !== 'application/tldraw') {
+											r({
+												type: 'error',
+												data: json,
+												reason: `found tldraw data comment but JSON was of a different type: ${json.type}`,
+											})
+										}
+
+										if (typeof json.data === 'string') {
+											r({
+												type: 'error',
+												data: json,
+												reason:
+													'found tldraw json but data was a string instead of a TLClipboardModel object',
+											})
+											return
+										}
+
+										r({ type: 'tldraw', data: json.data })
+										return
+									}
+								} catch (e: any) {
+									r({
+										type: 'error',
+										data: tldrawHtmlComment,
+										reason:
+											'found tldraw json but data was a string instead of a TLClipboardModel object',
+									})
+									return
+								}
+							} else {
+								if (thing.type === 'html') {
+									r({ type: 'text', data: text, subtype: 'html' })
+									return
+								}
+
+								if (thing.type === 'url') {
+									r({ type: 'text', data: text, subtype: 'url' })
+									return
+								}
+
+								// if we have not found a tldraw comment, Otherwise, try to parse the text as JSON directly.
+								try {
+									const json = JSON.parse(text)
+									if (json.type === 'excalidraw/clipboard') {
+										// If the clipboard contains content copied from excalidraw, then paste that
+										r({ type: 'excalidraw', data: json })
+										return
+									} else {
+										r({ type: 'text', data: text, subtype: 'json' })
+										return
+									}
+								} catch (e) {
+									// If we could not parse the text as JSON, then it's just text
+									r({ type: 'text', data: text, subtype: 'text' })
+									return
+								}
+							}
+
+							r({ type: 'error', data: text, reason: 'unhandled case' })
+						})
+					})
+			)
+	)
+
+	// 3.
+	//
+	// Now that we know what kind of stuff we're dealing with, we can actual create some content.
+	// There are priorities here, so order matters: we've already handled images and files, which
+	// take first priority; then we want to handle tldraw content, then excalidraw content, then
+	// html content, then links, and finally text content.
+
+	// Try to paste tldraw content
+	for (const result of results) {
+		if (result.type === 'tldraw') {
+			pasteTldrawContent(editor, result.data, point)
+			return
+		}
+	}
+
+	// Try to paste excalidraw content
+	for (const result of results) {
+		if (result.type === 'excalidraw') {
+			pasteExcalidrawContent(editor, result.data, point)
+			return
+		}
+	}
+
+	// Try to paste html content
+	for (const result of results) {
+		if (result.type === 'text' && result.subtype === 'html') {
+			// try to find a link
+			const rootNode = new DOMParser().parseFromString(result.data, 'text/html')
+			const bodyNode = rootNode.querySelector('body')
+
+			// Edge on Windows 11 home appears to paste a link as a single <a/> in
+			// the HTML document. If we're pasting a single like tag we'll just
+			// assume the user meant to paste the URL.
+			const isHtmlSingleLink =
+				bodyNode &&
+				Array.from(bodyNode.children).filter((el) => el.nodeType === 1).length === 1 &&
+				bodyNode.firstElementChild &&
+				bodyNode.firstElementChild.tagName === 'A' &&
+				bodyNode.firstElementChild.hasAttribute('href') &&
+				bodyNode.firstElementChild.getAttribute('href') !== ''
+
+			if (isHtmlSingleLink) {
+				const href = bodyNode.firstElementChild.getAttribute('href')!
+				handleText(editor, href, point)
+				return
+			}
+
+			// If the html is NOT a link, and we have NO OTHER texty content, then paste the html as text
+			if (!results.some((r) => r.type === 'text' && r.subtype !== 'html') && result.data.trim()) {
+				handleText(editor, stripHtml(result.data), point)
+				return
+			}
+		}
+	}
+
+	// Try to paste a link
+	for (const result of results) {
+		if (result.type === 'text' && result.subtype === 'url') {
+			pasteUrl(editor, result.data, point)
+			return
+		}
+	}
+
+	// Finally, if we haven't bailed on anything yet, we can paste text content
+	for (const result of results) {
+		if (result.type === 'text' && result.subtype === 'text' && result.data.trim()) {
+			// The clipboard may include multiple text items, but we only want to paste the first one
+			handleText(editor, result.data, point)
+			return
+		}
+	}
+}
+
+/**
+ * When the user copies, write the contents to local storage and to the clipboard
+ *
+ * @param editor - The editor instance.
+ * @public
+ */
+const handleNativeOrMenuCopy = (editor: Editor) => {
+	const content = editor.getContent()
+	if (!content) {
+		if (navigator && navigator.clipboard) {
+			navigator.clipboard.writeText('')
+		}
+		return
+	}
+
+	const stringifiedClipboard = compressToBase64(
+		JSON.stringify({
+			type: 'application/tldraw',
+			kind: 'content',
+			data: content,
+		})
+	)
+
+	if (typeof navigator === 'undefined') {
+		return
+	} else {
+		// Extract the text from the clipboard
+		const textItems = content.shapes
+			.map((shape) => {
+				if (
+					editor.isShapeOfType<TLTextShape>(shape, 'text') ||
+					editor.isShapeOfType<TLGeoShape>(shape, 'geo') ||
+					editor.isShapeOfType<TLArrowShape>(shape, 'arrow')
+				) {
+					return shape.props.text
+				}
+				if (
+					editor.isShapeOfType<TLBookmarkShape>(shape, 'bookmark') ||
+					editor.isShapeOfType<TLEmbedShape>(shape, 'embed')
+				) {
+					return shape.props.url
+				}
+				return null
+			})
+			.filter(isNonNull)
+
+		if (navigator.clipboard?.write) {
+			const htmlBlob = new Blob([`<tldraw>${stringifiedClipboard}</tldraw>`], {
+				type: 'text/html',
+			})
+
+			let textContent = textItems.join(' ')
+
+			// This is a bug in chrome android where it won't paste content if
+			// the text/plain content is "" so we need to always add an empty
+			// space ü§¨
+			if (textContent === '') {
+				textContent = ' '
+			}
+
+			navigator.clipboard.write([
+				new ClipboardItem({
+					'text/html': htmlBlob,
+					// What is this second blob used for?
+					'text/plain': new Blob([textContent], { type: 'text/plain' }),
+				}),
+			])
+		} else if (navigator.clipboard.writeText) {
+			navigator.clipboard.writeText(`<tldraw>${stringifiedClipboard}</tldraw>`)
+		}
+	}
+}
+
+/** @public */
+export function useMenuClipboardEvents() {
+	const editor = useEditor()
+	const trackEvent = useEvents()
+
+	const copy = useCallback(
+		function onCopy(source: TLUiEventSource) {
+			if (editor.selectedIds.length === 0) return
+
+			handleNativeOrMenuCopy(editor)
+			trackEvent('copy', { source })
+		},
+		[editor, trackEvent]
+	)
+
+	const cut = useCallback(
+		function onCut(source: TLUiEventSource) {
+			if (editor.selectedIds.length === 0) return
+
+			handleNativeOrMenuCopy(editor)
+			editor.deleteShapes()
+			trackEvent('cut', { source })
+		},
+		[editor, trackEvent]
+	)
+
+	const paste = useCallback(
+		async function onPaste(
+			data: DataTransfer | ClipboardItem[],
+			source: TLUiEventSource,
+			point?: VecLike
+		) {
+			// If we're editing a shape, or we are focusing an editable input, then
+			// we would want the user's paste interaction to go to that element or
+			// input instead; e.g. when pasting text into a text shape's content
+			if (editor.editingId !== null || disallowClipboardEvents(editor)) return
+
+			if (Array.isArray(data) && data[0] instanceof ClipboardItem) {
+				handlePasteFromClipboardApi(editor, data, point)
+				trackEvent('paste', { source: 'menu' })
+			} else {
+				// Read it first and then recurse, kind of weird
+				navigator.clipboard.read().then((clipboardItems) => {
+					paste(clipboardItems, source, point)
+				})
+			}
+		},
+		[editor, trackEvent]
+	)
+
+	return {
+		copy,
+		cut,
+		paste,
+	}
+}
+
+/** @public */
+export function useNativeClipboardEvents() {
+	const editor = useEditor()
+	const trackEvent = useEvents()
+
+	const appIsFocused = useEditorIsFocused()
+
+	useEffect(() => {
+		if (!appIsFocused) return
+		const copy = () => {
+			if (
+				editor.selectedIds.length === 0 ||
+				editor.editingId !== null ||
+				disallowClipboardEvents(editor)
+			)
+				return
+			handleNativeOrMenuCopy(editor)
+			trackEvent('copy', { source: 'kbd' })
+		}
+
+		function cut() {
+			if (
+				editor.selectedIds.length === 0 ||
+				editor.editingId !== null ||
+				disallowClipboardEvents(editor)
+			)
+				return
+			handleNativeOrMenuCopy(editor)
+			editor.deleteShapes()
+			trackEvent('cut', { source: 'kbd' })
+		}
+
+		let disablingMiddleClickPaste = false
+		const pointerUpHandler = (e: PointerEvent) => {
+			if (e.button === 1) {
+				disablingMiddleClickPaste = true
+				requestAnimationFrame(() => {
+					disablingMiddleClickPaste = false
+				})
+			}
+		}
+
+		const paste = (event: ClipboardEvent) => {
+			if (disablingMiddleClickPaste) {
+				event.stopPropagation()
+				return
+			}
+
+			// If we're editing a shape, or we are focusing an editable input, then
+			// we would want the user's paste interaction to go to that element or
+			// input instead; e.g. when pasting text into a text shape's content
+			if (editor.editingId !== null || disallowClipboardEvents(editor)) return
+
+			// First try to use the clipboard data on the event
+			if (event.clipboardData && !editor.inputs.shiftKey) {
+				handlePasteFromEventClipboardData(editor, event.clipboardData)
+			} else {
+				// Or else use the clipboard API
+				navigator.clipboard.read().then((clipboardItems) => {
+					if (Array.isArray(clipboardItems) && clipboardItems[0] instanceof ClipboardItem) {
+						handlePasteFromClipboardApi(editor, clipboardItems, editor.inputs.currentPagePoint)
+					}
+				})
+			}
+
+			trackEvent('paste', { source: 'kbd' })
+		}
+
+		document.addEventListener('copy', copy)
+		document.addEventListener('cut', cut)
+		document.addEventListener('paste', paste)
+		document.addEventListener('pointerup', pointerUpHandler)
+
+		return () => {
+			document.removeEventListener('copy', copy)
+			document.removeEventListener('cut', cut)
+			document.removeEventListener('paste', paste)
+			document.removeEventListener('pointerup', pointerUpHandler)
+		}
+	}, [editor, trackEvent, appIsFocused])
+}

commit 3e31ef2a7d01467ef92ca4f7aed13ee708db73ef
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Tue Jul 18 22:50:23 2023 +0100

    Remove helpers / extraneous API methods. (#1745)
    
    This PR removes several extraneous computed values from the editor. It
    adds some silly instance state onto the instance state record and
    unifies a few methods which were inconsistent. This is fit and finish
    work üßΩ
    
    ## Computed Values
    
    In general, where once we had a getter and setter for `isBlahMode`,
    which really masked either an `_isBlahMode` atom on the editor or
    `instanceState.isBlahMode`, these are merged into `instanceState`; they
    can be accessed / updated via `editor.instanceState` /
    `editor.updateInstanceState`.
    
    ## tldraw select tool specific things
    
    This PR also removes some tldraw specific state checks and creates new
    component overrides to allow us to include them in tldraw/tldraw.
    
    ### Change Type
    
    - [x] `major` ‚Äî Breaking change
    
    ### Test Plan
    
    - [x] Unit Tests
    - [x] End to end tests
    
    ### Release Notes
    
    - [tldraw] rename `useReadonly` to `useReadOnly`
    - [editor] remove `Editor.isDarkMode`
    - [editor] remove `Editor.isChangingStyle`
    - [editor] remove `Editor.isCoarsePointer`
    - [editor] remove `Editor.isDarkMode`
    - [editor] remove `Editor.isFocused`
    - [editor] remove `Editor.isGridMode`
    - [editor] remove `Editor.isPenMode`
    - [editor] remove `Editor.isReadOnly`
    - [editor] remove `Editor.isSnapMode`
    - [editor] remove `Editor.isToolLocked`
    - [editor] remove `Editor.locale`
    - [editor] rename `Editor.pageState` to `Editor.currentPageState`
    - [editor] add `Editor.pageStates`
    - [editor] add `Editor.setErasingIds`
    - [editor] add `Editor.setEditingId`
    - [editor] add several new component overrides

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index c89abedbc..ecca0821b 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -10,6 +10,7 @@ import {
 	isNonNull,
 	uniq,
 	useEditor,
+	useValue,
 } from '@tldraw/editor'
 import { compressToBase64, decompressFromBase64 } from 'lz-string'
 import { useCallback, useEffect } from 'react'
@@ -17,7 +18,6 @@ import { pasteExcalidrawContent } from './clipboard/pasteExcalidrawContent'
 import { pasteFiles } from './clipboard/pasteFiles'
 import { pasteTldrawContent } from './clipboard/pasteTldrawContent'
 import { pasteUrl } from './clipboard/pasteUrl'
-import { useEditorIsFocused } from './useEditorIsFocused'
 import { TLUiEventSource, useEvents } from './useEventsProvider'
 
 /** @public */
@@ -642,7 +642,7 @@ export function useNativeClipboardEvents() {
 	const editor = useEditor()
 	const trackEvent = useEvents()
 
-	const appIsFocused = useEditorIsFocused()
+	const appIsFocused = useValue('editor.isFocused', () => editor.instanceState.isFocused, [editor])
 
 	useEffect(() => {
 		if (!appIsFocused) return

commit d750da8f40efda4b011a91962ef8f30c63d1e5da
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Tue Jul 25 17:10:15 2023 +0100

    `ShapeUtil.getGeometry`, selection rewrite (#1751)
    
    This PR is a significant rewrite of our selection / hit testing logic.
    
    It
    - replaces our current geometric helpers (`getBounds`, `getOutline`,
    `hitTestPoint`, and `hitTestLineSegment`) with a new geometry API
    - moves our hit testing entirely to JS using geometry
    - improves selection logic, especially around editing shapes, groups and
    frames
    - fixes many minor selection bugs (e.g. shapes behind frames)
    - removes hit-testing DOM elements from ShapeFill etc.
    - adds many new tests around selection
    - adds new tests around selection
    - makes several superficial changes to surface editor APIs
    
    This PR is hard to evaluate. The `selection-omnibus` test suite is
    intended to describe all of the selection behavior, however all existing
    tests are also either here preserved and passing or (in a few cases
    around editing shapes) are modified to reflect the new behavior.
    
    ## Geometry
    
    All `ShapeUtils` implement `getGeometry`, which returns a single
    geometry primitive (`Geometry2d`). For example:
    
    ```ts
    class BoxyShapeUtil {
      getGeometry(shape: BoxyShape) {
        return new Rectangle2d({
            width: shape.props.width,
            height: shape.props.height,
            isFilled: true,
            margin: shape.props.strokeWidth
          })
        }
    }
    ```
    
    This geometric primitive is used for all bounds calculation, hit
    testing, intersection with arrows, etc.
    
    There are several geometric primitives that extend `Geometry2d`:
    - `Arc2d`
    - `Circle2d`
    - `CubicBezier2d`
    - `CubicSpline2d`
    - `Edge2d`
    - `Ellipse2d`
    - `Group2d`
    - `Polygon2d`
    - `Rectangle2d`
    - `Stadium2d`
    
    For shapes that have more complicated geometric representations, such as
    an arrow with a label, the `Group2d` can accept other primitives as its
    children.
    
    ## Hit testing
    
    Previously, we did all hit testing via events set on shapes and other
    elements. In this PR, I've replaced those hit tests with our own
    calculation for hit tests in JavaScript. This removed the need for many
    DOM elements, such as hit test area borders and fills which only existed
    to trigger pointer events.
    
    ## Selection
    
    We now support selecting "hollow" shapes by clicking inside of them.
    This involves a lot of new logic but it should work intuitively. See
    `Editor.getShapeAtPoint` for the (thoroughly commented) implementation.
    
    ![Kapture 2023-07-23 at 23 27
    27](https://github.com/tldraw/tldraw/assets/23072548/a743275c-acdb-42d9-a3fe-b3e20dce86b6)
    
    every sunset is actually the sun hiding in fear and respect of tldraw's
    quality of interactions
    
    This PR also fixes several bugs with scribble selection, in particular
    around the shift key modifier.
    
    ![Kapture 2023-07-24 at 23 34
    07](https://github.com/tldraw/tldraw/assets/23072548/871d67d0-8d06-42ae-a2b2-021effba37c5)
    
    ...as well as issues with labels and editing.
    
    There are **over 100 new tests** for selection covering groups, frames,
    brushing, scribbling, hovering, and editing. I'll add a few more before
    I feel comfortable merging this PR.
    
    ## Arrow binding
    
    Using the same "hollow shape" logic as selection, arrow binding is
    significantly improved.
    
    ![Kapture 2023-07-22 at 07 46
    25](https://github.com/tldraw/tldraw/assets/23072548/5aa724b3-b57d-4fb7-92d0-80e34246753c)
    
    a thousand wise men could not improve on this
    
    ## Moving focus between editing shapes
    
    Previously, this was handled in the `editing_shapes` state. This is
    moved to `useEditableText`, and should generally be considered an
    advanced implementation detail on a shape-by-shape basis. This addresses
    a bug that I'd never noticed before, but which can be reproduced by
    selecting an shape‚Äîbut not focusing its input‚Äîwhile editing a different
    shape. Previously, the new shape became the editing shape but its input
    did not focus.
    
    ![Kapture 2023-07-23 at 23 19
    09](https://github.com/tldraw/tldraw/assets/23072548/a5e157fb-24a8-42bd-a692-04ce769b1a9c)
    
    In this PR, you can select a shape by clicking on its edge or body, or
    select its input to transfer editing / focus.
    
    ![Kapture 2023-07-23 at 23 22
    21](https://github.com/tldraw/tldraw/assets/23072548/7384e7ea-9777-4e1a-8f63-15de2166a53a)
    
    tldraw, glorious tldraw
    
    ### Change Type
    
    - [x] `major` ‚Äî Breaking change
    
    ### Test Plan
    
    1. Erase shapes
    2. Select shapes
    3. Calculate their bounding boxes
    
    - [ ] Unit Tests // todo
    - [ ] End to end tests // todo
    
    ### Release Notes
    
    - [editor] Remove `ShapeUtil.getBounds`, `ShapeUtil.getOutline`,
    `ShapeUtil.hitTestPoint`, `ShapeUtil.hitTestLineSegment`
    - [editor] Add `ShapeUtil.getGeometry`
    - [editor] Add `Editor.getShapeGeometry`

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index ecca0821b..0dd502b42 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -212,7 +212,7 @@ const handlePasteFromEventClipboardData = async (
 	point?: VecLike
 ) => {
 	// Do not paste while in any editing state
-	if (editor.editingId !== null) return
+	if (editor.editingShapeId !== null) return
 
 	if (!clipboardData) {
 		throw Error('No clipboard data')
@@ -514,7 +514,7 @@ async function handleClipboardThings(editor: Editor, things: ClipboardThing[], p
  * @public
  */
 const handleNativeOrMenuCopy = (editor: Editor) => {
-	const content = editor.getContent()
+	const content = editor.getContent(editor.selectedShapeIds)
 	if (!content) {
 		if (navigator && navigator.clipboard) {
 			navigator.clipboard.writeText('')
@@ -587,7 +587,7 @@ export function useMenuClipboardEvents() {
 
 	const copy = useCallback(
 		function onCopy(source: TLUiEventSource) {
-			if (editor.selectedIds.length === 0) return
+			if (editor.selectedShapeIds.length === 0) return
 
 			handleNativeOrMenuCopy(editor)
 			trackEvent('copy', { source })
@@ -597,10 +597,10 @@ export function useMenuClipboardEvents() {
 
 	const cut = useCallback(
 		function onCut(source: TLUiEventSource) {
-			if (editor.selectedIds.length === 0) return
+			if (editor.selectedShapeIds.length === 0) return
 
 			handleNativeOrMenuCopy(editor)
-			editor.deleteShapes()
+			editor.deleteShapes(editor.selectedShapeIds)
 			trackEvent('cut', { source })
 		},
 		[editor, trackEvent]
@@ -615,7 +615,7 @@ export function useMenuClipboardEvents() {
 			// If we're editing a shape, or we are focusing an editable input, then
 			// we would want the user's paste interaction to go to that element or
 			// input instead; e.g. when pasting text into a text shape's content
-			if (editor.editingId !== null || disallowClipboardEvents(editor)) return
+			if (editor.editingShapeId !== null || disallowClipboardEvents(editor)) return
 
 			if (Array.isArray(data) && data[0] instanceof ClipboardItem) {
 				handlePasteFromClipboardApi(editor, data, point)
@@ -648,8 +648,8 @@ export function useNativeClipboardEvents() {
 		if (!appIsFocused) return
 		const copy = () => {
 			if (
-				editor.selectedIds.length === 0 ||
-				editor.editingId !== null ||
+				editor.selectedShapeIds.length === 0 ||
+				editor.editingShapeId !== null ||
 				disallowClipboardEvents(editor)
 			)
 				return
@@ -659,13 +659,13 @@ export function useNativeClipboardEvents() {
 
 		function cut() {
 			if (
-				editor.selectedIds.length === 0 ||
-				editor.editingId !== null ||
+				editor.selectedShapeIds.length === 0 ||
+				editor.editingShapeId !== null ||
 				disallowClipboardEvents(editor)
 			)
 				return
 			handleNativeOrMenuCopy(editor)
-			editor.deleteShapes()
+			editor.deleteShapes(editor.selectedShapeIds)
 			trackEvent('cut', { source: 'kbd' })
 		}
 
@@ -688,7 +688,7 @@ export function useNativeClipboardEvents() {
 			// If we're editing a shape, or we are focusing an editable input, then
 			// we would want the user's paste interaction to go to that element or
 			// input instead; e.g. when pasting text into a text shape's content
-			if (editor.editingId !== null || disallowClipboardEvents(editor)) return
+			if (editor.editingShapeId !== null || disallowClipboardEvents(editor)) return
 
 			// First try to use the clipboard data on the event
 			if (event.clipboardData && !editor.inputs.shiftKey) {

commit 2e4989255c2741889c21da0085242c82d0df0372
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Fri Jul 28 10:24:58 2023 +0100

    export `UiEventsProvider` (#1774)
    
    This PR exports the `UiEventsProvider` component (and renames
    `useEvents` to `useUiEvents`). It also changes the `useUiEvents` hook to
    work outside of the context. When used outside of the context, the hook
    will no longer throw an error‚Äîthough it will also have no effect.
    
    ### Change Type
    
    - [x] `minor`
    
    ### Release Notes
    
    - [@tldraw/tldraw] export ui events, so that UI hooks can work without
    context

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index 0dd502b42..d0f7fbc66 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -18,7 +18,7 @@ import { pasteExcalidrawContent } from './clipboard/pasteExcalidrawContent'
 import { pasteFiles } from './clipboard/pasteFiles'
 import { pasteTldrawContent } from './clipboard/pasteTldrawContent'
 import { pasteUrl } from './clipboard/pasteUrl'
-import { TLUiEventSource, useEvents } from './useEventsProvider'
+import { TLUiEventSource, useUiEvents } from './useEventsProvider'
 
 /** @public */
 export const isValidHttpURL = (url: string) => {
@@ -583,7 +583,7 @@ const handleNativeOrMenuCopy = (editor: Editor) => {
 /** @public */
 export function useMenuClipboardEvents() {
 	const editor = useEditor()
-	const trackEvent = useEvents()
+	const trackEvent = useUiEvents()
 
 	const copy = useCallback(
 		function onCopy(source: TLUiEventSource) {
@@ -640,7 +640,7 @@ export function useMenuClipboardEvents() {
 /** @public */
 export function useNativeClipboardEvents() {
 	const editor = useEditor()
-	const trackEvent = useEvents()
+	const trackEvent = useUiEvents()
 
 	const appIsFocused = useValue('editor.isFocused', () => editor.instanceState.isFocused, [editor])
 

commit 89914684467c1e18ef06fa702c82ed0f88a2ea09
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Sat Aug 5 12:21:07 2023 +0100

    history options / markId / createPage (#1796)
    
    This PR:
    
    - adds history options to several commands in order to allow them to
    support squashing and ephemeral data (previously, these commands had
    boolean values for squashing / ephemeral)
    
    It also:
    - changes `markId` to return the editor instance rather than the mark id
    passed into the command
    - removes `focus` and `blur` commands
    - changes `createPage` parameters
    - unifies `animateShape` / `animateShapes` options
    
    ### Change Type
    
    - [x] `major` ‚Äî Breaking change
    
    ### Test Plan
    
    - [x] Unit Tests

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index d0f7fbc66..17e5ad185 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -514,7 +514,7 @@ async function handleClipboardThings(editor: Editor, things: ClipboardThing[], p
  * @public
  */
 const handleNativeOrMenuCopy = (editor: Editor) => {
-	const content = editor.getContent(editor.selectedShapeIds)
+	const content = editor.getContentFromCurrentPage(editor.selectedShapeIds)
 	if (!content) {
 		if (navigator && navigator.clipboard) {
 			navigator.clipboard.writeText('')

commit 5cd74f4bd602fd2c56bdd57219aa92bde681b104
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Tue Sep 19 16:33:54 2023 +0100

    [feature] Include `sources` in `TLExternalContent` (#1925)
    
    This PR adds the source items from a paste event to the data shared with
    external content handlers. This allows developers to customize the way
    certain content is handled.
    
    For example, pasting text sometimes incudes additional clipboard items,
    such as the HTML representation of that text. We wouldn't want to create
    two shapes‚Äîone for the text and one for the HTML‚Äîso we still treat this
    as a single text paste. The `registerExternalContentHandler` API allows
    a developer to change how that text is handled, and the new `sources`
    API will now allow the developer to take into consideration all of the
    items that were on the clipboard.
    
    ![Kapture 2023-09-19 at 12 25
    52](https://github.com/tldraw/tldraw/assets/23072548/fa976320-cfec-4921-b481-10cae0d4043e)
    
    ### Change Type
    
    - [x] `minor` ‚Äî New feature
    
    ### Test Plan
    
    1. Try the external content source example.
    2. Paste text that includes HTML (e.g. from VS Code)
    
    ### Release Notes
    
    - [editor / tldraw] add `sources` to `TLExternalContent`

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index 17e5ad185..c104833fc 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -2,8 +2,8 @@ import {
 	Editor,
 	TLArrowShape,
 	TLBookmarkShape,
-	TLContent,
 	TLEmbedShape,
+	TLExternalContentSource,
 	TLGeoShape,
 	TLTextShape,
 	VecLike,
@@ -20,6 +20,18 @@ import { pasteTldrawContent } from './clipboard/pasteTldrawContent'
 import { pasteUrl } from './clipboard/pasteUrl'
 import { TLUiEventSource, useUiEvents } from './useEventsProvider'
 
+/**
+ * Strip HTML tags from a string.
+ * @param html - The HTML to strip.
+ * @internal
+ */
+function stripHtml(html: string) {
+	// See <https://github.com/developit/preact-markup/blob/4788b8d61b4e24f83688710746ee36e7464f7bbc/src/parse-markup.js#L60-L69>
+	const doc = document.implementation.createHTMLDocument('')
+	doc.documentElement.innerHTML = html.trim()
+	return doc.body.textContent || doc.body.innerText || ''
+}
+
 /** @public */
 export const isValidHttpURL = (url: string) => {
 	try {
@@ -89,18 +101,6 @@ async function blobAsString(blob: Blob) {
 	})
 }
 
-/**
- * Strip HTML tags from a string.
- * @param html - The HTML to strip.
- * @internal
- */
-function stripHtml(html: string) {
-	// See <https://github.com/developit/preact-markup/blob/4788b8d61b4e24f83688710746ee36e7464f7bbc/src/parse-markup.js#L60-L69>
-	const doc = document.implementation.createHTMLDocument('')
-	doc.documentElement.innerHTML = html.trim()
-	return doc.body.textContent || doc.body.innerText || ''
-}
-
 /**
  * Whether a ClipboardItem is a file.
  * @param item - The ClipboardItem to check.
@@ -117,7 +117,12 @@ const isFile = (item: ClipboardItem) => {
  * @param point - (optional) The point at which to paste the text.
  * @internal
  */
-const handleText = (editor: Editor, data: string, point?: VecLike) => {
+const handleText = (
+	editor: Editor,
+	data: string,
+	point?: VecLike,
+	sources?: TLExternalContentSource[]
+) => {
 	const validUrlList = getValidHttpURLList(data)
 	if (validUrlList) {
 		for (const url of validUrlList) {
@@ -131,6 +136,7 @@ const handleText = (editor: Editor, data: string, point?: VecLike) => {
 			type: 'svg-text',
 			text: data,
 			point,
+			sources,
 		})
 	} else {
 		editor.mark('paste')
@@ -138,6 +144,7 @@ const handleText = (editor: Editor, data: string, point?: VecLike) => {
 			type: 'text',
 			text: data,
 			point,
+			sources,
 		})
 	}
 }
@@ -172,30 +179,6 @@ type ClipboardThing =
 			source: Promise<string>
 	  }
 
-/**
- * The result of processing a `ClipboardThing`.
- * @internal
- */
-type ClipboardResult =
-	| {
-			type: 'tldraw'
-			data: TLContent
-	  }
-	| {
-			type: 'excalidraw'
-			data: any
-	  }
-	| {
-			type: 'text'
-			data: string
-			subtype: 'json' | 'html' | 'text' | 'url'
-	  }
-	| {
-			type: 'error'
-			data: string | null
-			reason: string
-	  }
-
 /**
  * Handle a paste using event clipboard data. This is the "original"
  * paste method that uses the clipboard data from the paste event.
@@ -339,7 +322,7 @@ async function handleClipboardThings(editor: Editor, things: ClipboardThing[], p
 	// we can't await them in a loop. So we'll map them to promises and await them all at once,
 	// then make decisions based on what we find.
 
-	const results = await Promise.all<ClipboardResult>(
+	const results = await Promise.all<TLExternalContentSource>(
 		things
 			.filter((t) => t.type !== 'file')
 			.map(
@@ -477,13 +460,13 @@ async function handleClipboardThings(editor: Editor, things: ClipboardThing[], p
 
 			if (isHtmlSingleLink) {
 				const href = bodyNode.firstElementChild.getAttribute('href')!
-				handleText(editor, href, point)
+				handleText(editor, href, point, results)
 				return
 			}
 
 			// If the html is NOT a link, and we have NO OTHER texty content, then paste the html as text
 			if (!results.some((r) => r.type === 'text' && r.subtype !== 'html') && result.data.trim()) {
-				handleText(editor, stripHtml(result.data), point)
+				handleText(editor, stripHtml(result.data), point, results)
 				return
 			}
 		}
@@ -492,7 +475,7 @@ async function handleClipboardThings(editor: Editor, things: ClipboardThing[], p
 	// Try to paste a link
 	for (const result of results) {
 		if (result.type === 'text' && result.subtype === 'url') {
-			pasteUrl(editor, result.data, point)
+			pasteUrl(editor, result.data, point, results)
 			return
 		}
 	}
@@ -501,7 +484,7 @@ async function handleClipboardThings(editor: Editor, things: ClipboardThing[], p
 	for (const result of results) {
 		if (result.type === 'text' && result.subtype === 'text' && result.data.trim()) {
 			// The clipboard may include multiple text items, but we only want to paste the first one
-			handleText(editor, result.data, point)
+			handleText(editor, result.data, point, results)
 			return
 		}
 	}

commit 828848f8af110772486f086946fab97ff8775fe6
Author: Lu Wilson <l2wilson94@gmail.com>
Date:   Fri Oct 20 16:31:50 2023 +0100

    Remove (optional) from jsdocs (#2109)
    
    This PR removes all mentions of "(optional)" from our jsdocs. This is
    for:
    
    * consistency ‚Äî many of our jsdocs don't mention "(optional)" for
    optional parameters. The developer is expected to use the type
    definition to find this out. But it's a bit unclear because we use
    "(optional)" in many places too.
    * docs site ‚Äî on our docs site, we use type definitions to figure out
    what is optional, and what isn't. We use that info to denote optional
    parameters. It looks funny having two "(optional)"s on a page. We
    *could* strip them, but it's probably better to just remove them at the
    source.
    
    <img width="526" alt="image"
    src="https://github.com/tldraw/tldraw/assets/15892272/b5b65a2b-2923-42a9-a2d3-9b1d9d55cd3d">
    
    
    ### Change Type
    
    - [x] `documentation` ‚Äî Changes to the documentation only[^2]
    
    ### Release Notes
    
    - dev: Removed duplicate/inconsistent `(optional)`s from docs

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index c104833fc..3c1a017e9 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -114,7 +114,7 @@ const isFile = (item: ClipboardItem) => {
  * Handle text pasted into the editor.
  * @param editor - The editor instance.
  * @param data - The text to paste.
- * @param point - (optional) The point at which to paste the text.
+ * @param point - The point at which to paste the text.
  * @internal
  */
 const handleText = (
@@ -186,7 +186,7 @@ type ClipboardThing =
  *
  * @param editor - The editor
  * @param clipboardData - The clipboard data
- * @param point - (optional) The point to paste at
+ * @param point - The point to paste at
  * @internal
  */
 const handlePasteFromEventClipboardData = async (
@@ -242,7 +242,7 @@ const handlePasteFromEventClipboardData = async (
  *
  * @param editor - The editor
  * @param clipboardItems - The clipboard items to handle
- * @param point - (optional) The point to paste at
+ * @param point - The point to paste at
  * @internal
  */
 const handlePasteFromClipboardApi = async (

commit 5db3c1553e14edd14aa5f7c0fc85fc5efc352335
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon Nov 13 11:51:22 2023 +0000

    Replace Atom.value with Atom.get() (#2189)
    
    This PR replaces the `.value` getter for the atom with `.get()`
    
    ### Change Type
    
    - [x] `major` ‚Äî Breaking change
    
    ---------
    
    Co-authored-by: David Sheldrick <d.j.sheldrick@gmail.com>

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index 3c1a017e9..f029a2557 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -625,7 +625,9 @@ export function useNativeClipboardEvents() {
 	const editor = useEditor()
 	const trackEvent = useUiEvents()
 
-	const appIsFocused = useValue('editor.isFocused', () => editor.instanceState.isFocused, [editor])
+	const appIsFocused = useValue('editor.isFocused', () => editor.getInstanceState().isFocused, [
+		editor,
+	])
 
 	useEffect(() => {
 		if (!appIsFocused) return

commit 2ca2f81f2aac16790c73bd334eda53a35a9d9f45
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Mon Nov 13 12:42:07 2023 +0000

    No impure getters pt2 (#2202)
    
    follow up to #2189

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index f029a2557..a5480966b 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -74,7 +74,7 @@ const INPUTS = ['input', 'select', 'textarea']
 function disallowClipboardEvents(editor: Editor) {
 	const { activeElement } = document
 	return (
-		editor.isMenuOpen ||
+		editor.getIsMenuOpen() ||
 		(activeElement &&
 			(activeElement.getAttribute('contenteditable') ||
 				INPUTS.indexOf(activeElement.tagName.toLowerCase()) > -1))
@@ -497,7 +497,7 @@ async function handleClipboardThings(editor: Editor, things: ClipboardThing[], p
  * @public
  */
 const handleNativeOrMenuCopy = (editor: Editor) => {
-	const content = editor.getContentFromCurrentPage(editor.selectedShapeIds)
+	const content = editor.getContentFromCurrentPage(editor.getSelectedShapeIds())
 	if (!content) {
 		if (navigator && navigator.clipboard) {
 			navigator.clipboard.writeText('')
@@ -570,7 +570,7 @@ export function useMenuClipboardEvents() {
 
 	const copy = useCallback(
 		function onCopy(source: TLUiEventSource) {
-			if (editor.selectedShapeIds.length === 0) return
+			if (editor.getSelectedShapeIds().length === 0) return
 
 			handleNativeOrMenuCopy(editor)
 			trackEvent('copy', { source })
@@ -580,10 +580,10 @@ export function useMenuClipboardEvents() {
 
 	const cut = useCallback(
 		function onCut(source: TLUiEventSource) {
-			if (editor.selectedShapeIds.length === 0) return
+			if (editor.getSelectedShapeIds().length === 0) return
 
 			handleNativeOrMenuCopy(editor)
-			editor.deleteShapes(editor.selectedShapeIds)
+			editor.deleteShapes(editor.getSelectedShapeIds())
 			trackEvent('cut', { source })
 		},
 		[editor, trackEvent]
@@ -633,7 +633,7 @@ export function useNativeClipboardEvents() {
 		if (!appIsFocused) return
 		const copy = () => {
 			if (
-				editor.selectedShapeIds.length === 0 ||
+				editor.getSelectedShapeIds().length === 0 ||
 				editor.editingShapeId !== null ||
 				disallowClipboardEvents(editor)
 			)
@@ -644,13 +644,13 @@ export function useNativeClipboardEvents() {
 
 		function cut() {
 			if (
-				editor.selectedShapeIds.length === 0 ||
+				editor.getSelectedShapeIds().length === 0 ||
 				editor.editingShapeId !== null ||
 				disallowClipboardEvents(editor)
 			)
 				return
 			handleNativeOrMenuCopy(editor)
-			editor.deleteShapes(editor.selectedShapeIds)
+			editor.deleteShapes(editor.getSelectedShapeIds())
 			trackEvent('cut', { source: 'kbd' })
 		}
 

commit daf729d45c879d4e234d9417570149ad854f635b
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Mon Nov 13 16:02:50 2023 +0000

    No impure getters pt4 (#2206)
    
    follow up to #2189 and #2203
    
    ### Change Type
    
    - [x] `patch` ‚Äî Bug fix

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index a5480966b..08b4da549 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -195,7 +195,7 @@ const handlePasteFromEventClipboardData = async (
 	point?: VecLike
 ) => {
 	// Do not paste while in any editing state
-	if (editor.editingShapeId !== null) return
+	if (editor.getEditingShapeId() !== null) return
 
 	if (!clipboardData) {
 		throw Error('No clipboard data')
@@ -598,7 +598,7 @@ export function useMenuClipboardEvents() {
 			// If we're editing a shape, or we are focusing an editable input, then
 			// we would want the user's paste interaction to go to that element or
 			// input instead; e.g. when pasting text into a text shape's content
-			if (editor.editingShapeId !== null || disallowClipboardEvents(editor)) return
+			if (editor.getEditingShapeId() !== null || disallowClipboardEvents(editor)) return
 
 			if (Array.isArray(data) && data[0] instanceof ClipboardItem) {
 				handlePasteFromClipboardApi(editor, data, point)
@@ -634,7 +634,7 @@ export function useNativeClipboardEvents() {
 		const copy = () => {
 			if (
 				editor.getSelectedShapeIds().length === 0 ||
-				editor.editingShapeId !== null ||
+				editor.getEditingShapeId() !== null ||
 				disallowClipboardEvents(editor)
 			)
 				return
@@ -645,7 +645,7 @@ export function useNativeClipboardEvents() {
 		function cut() {
 			if (
 				editor.getSelectedShapeIds().length === 0 ||
-				editor.editingShapeId !== null ||
+				editor.getEditingShapeId() !== null ||
 				disallowClipboardEvents(editor)
 			)
 				return
@@ -673,7 +673,7 @@ export function useNativeClipboardEvents() {
 			// If we're editing a shape, or we are focusing an editable input, then
 			// we would want the user's paste interaction to go to that element or
 			// input instead; e.g. when pasting text into a text shape's content
-			if (editor.editingShapeId !== null || disallowClipboardEvents(editor)) return
+			if (editor.getEditingShapeId() !== null || disallowClipboardEvents(editor)) return
 
 			// First try to use the clipboard data on the event
 			if (event.clipboardData && !editor.inputs.shiftKey) {

commit ac0259a6af0ede496f26041d552119a6e7dce41c
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Thu Feb 15 12:10:09 2024 +0000

    Composable custom UI  (#2796)
    
    This PR refactors our menu systems and provides an interface to hide or
    replace individual user interface elements.
    
    # Background
    
    Previously, we've had two types of overrides:
    - "schema" overrides that would allow insertion or replacement of items
    in the different menus
    - "component" overrides that would replace components in the editor's
    user interface
    
    This PR is an attempt to unify the two and to provide for additional
    cases where the "schema-based" user interface had begun to break down.
    
    # Approach
    
    This PR makes no attempt to change the `actions` or `tools`
    overrides‚Äîthe current system seems to be correct for those because they
    are not reactive. The challenge with the other ui schemas is that they
    _are_ reactive, and thus the overrides both need to a) be fed in from
    outside of the editor as props, and b) react to changes from the editor,
    which is an impossible situation.
    
    The new approach is to use React to declare menu items. (Surprise!)
    
    ```tsx
    function CustomHelpMenuContent() {
            return (
                    <>
                            <DefaultHelpMenuContent />
                            <TldrawUiMenuGroup id="custom stuff">
                                    <TldrawUiMenuItem
                                            id="about"
                                            label="Like my posts"
                                            icon="external-link"
                                            readonlyOk
                                            onSelect={() => {
                                                    window.open('https://x.com/tldraw', '_blank')
                                            }}
                                    />
                            </TldrawUiMenuGroup>
                    </>
            )
    }
    
    const components: TLComponents = {
            HelpMenuContent: CustomHelpMenuContent,
    }
    
    export default function CustomHelpMenuContentExample() {
            return (
                    <div className="tldraw__editor">
                            <Tldraw components={components} />
                    </div>
            )
    }
    ```
    
    We use a `components` prop with the combined editor and ui components.
    
    - [ ] Create a "layout" component?
    - [ ] Make UI components more isolated? If possible, they shouldn't
    depend on styles outside of themselves, so that they can be used in
    other layouts. Maybe we wait on this because I'm feeling a slippery
    slope toward presumptions about configurability.
    - [ ] OTOH maybe we go hard and consider these things as separate
    components, even packages, with their own interfaces for customizability
    / configurability, just go all the way with it, and see what that looks
    like.
    
    # Pros
    
    Top line: you can customize tldraw's user interface in a MUCH more
    granular / powerful way than before.
    
    It solves a case where menu items could not be made stateful from
    outside of the editor context, and provides the option to do things in
    the menus that we couldn't allow previously with the "schema-based"
    approach.
    
    It also may (who knows) be more performant because we can locate the
    state inside of the components for individual buttons and groups,
    instead of all at the top level above the "schema". Because items /
    groups decide their own state, we don't have to have big checks on how
    many items are selected, or whether we have a flippable state. Items and
    groups themselves are allowed to re-build as part of the regular React
    lifecycle. Menus aren't constantly being rebuilt, if that were ever an
    issue.
    
    Menu items can be shared between different menu types. We'll are
    sometimes able to re-use items between, for example, the menu and the
    context menu and the actions menu.
    
    Our overrides no longer mutate anything, so there's less weird searching
    and finding.
    
    # Cons
    
    This approach can make customization menu contents significantly more
    complex, as an end user would need to re-declare most of a menu in order
    to make any change to it. Luckily a user can add things to the top or
    bottom of the context menu fairly easily. (And who knows, folks may
    actually want to do deep customization, and this allows for it.)
    
    It's more code. We are shipping more react components, basically one for
    each menu item / group.
    
    Currently this PR does not export the subcomponents, i.e. menu items. If
    we do want to export these, then heaven help us, it's going to be a
    _lot_ of exports.
    
    # Progress
    
    - [x] Context menu
    - [x] Main menu
    - [x] Zoom menu
    - [x] Help menu
    - [x] Actions menu
    - [x] Keyboard shortcuts menu
    - [x] Quick actions in main menu? (new)
    - [x] Helper buttons? (new)
    - [x] Debug Menu
    
    And potentially
    - [x] Toolbar
    - [x] Style menu
    - [ ] Share zone
    - [x] Navigation zone
    - [ ] Other zones
    
    ### Change Type
    
    - [x] `major` ‚Äî Breaking change
    
    ### Test Plan
    
    1. use the context menu
    2. use the custom context menu example
    3. use cursor chat in the context menu
    
    - [x] Unit Tests
    - [ ] End to end tests
    
    ### Release Notes
    
    - Add a brief release note for your PR here.

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index 08b4da549..8541f8ab4 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -14,11 +14,11 @@ import {
 } from '@tldraw/editor'
 import { compressToBase64, decompressFromBase64 } from 'lz-string'
 import { useCallback, useEffect } from 'react'
+import { TLUiEventSource, useUiEvents } from '../context/events'
 import { pasteExcalidrawContent } from './clipboard/pasteExcalidrawContent'
 import { pasteFiles } from './clipboard/pasteFiles'
 import { pasteTldrawContent } from './clipboard/pasteTldrawContent'
 import { pasteUrl } from './clipboard/pasteUrl'
-import { TLUiEventSource, useUiEvents } from './useEventsProvider'
 
 /**
  * Strip HTML tags from a string.

commit dba6d4c414fa571519e252d581e3489101280acc
Author: Mime ƒåuvalo <mimecuvalo@gmail.com>
Date:   Tue Mar 12 09:10:18 2024 +0000

    chore: cleanup multiple uses of FileReader (#3110)
    
    from
    https://discord.com/channels/859816885297741824/1006133967642177556/1213038401465618433
    
    ### Change Type
    
    - [x] `patch` ‚Äî Bug fix

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index 8541f8ab4..7b51510be 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -1,5 +1,6 @@
 import {
 	Editor,
+	FileHelpers,
 	TLArrowShape,
 	TLBookmarkShape,
 	TLEmbedShape,
@@ -81,26 +82,6 @@ function disallowClipboardEvents(editor: Editor) {
 	)
 }
 
-/**
- * Get a blob as a string.
- *
- * @param blob - The blob to get as a string.
- * @internal
- */
-async function blobAsString(blob: Blob) {
-	return new Promise<string>((resolve, reject) => {
-		const reader = new FileReader()
-		reader.addEventListener('loadend', () => {
-			const text = reader.result
-			resolve(text as string)
-		})
-		reader.addEventListener('error', () => {
-			reject(reader.error)
-		})
-		reader.readAsText(blob)
-	})
-}
-
 /**
  * Whether a ClipboardItem is a file.
  * @param item - The ClipboardItem to check.
@@ -270,7 +251,7 @@ const handlePasteFromClipboardApi = async (
 			things.push({
 				type: 'html',
 				source: new Promise<string>((r) =>
-					item.getType('text/html').then((blob) => blobAsString(blob).then(r))
+					item.getType('text/html').then((blob) => FileHelpers.fileToBase64(blob).then(r))
 				),
 			})
 		}
@@ -279,7 +260,7 @@ const handlePasteFromClipboardApi = async (
 			things.push({
 				type: 'url',
 				source: new Promise<string>((r) =>
-					item.getType('text/uri-list').then((blob) => blobAsString(blob).then(r))
+					item.getType('text/uri-list').then((blob) => FileHelpers.fileToBase64(blob).then(r))
 				),
 			})
 		}
@@ -288,7 +269,7 @@ const handlePasteFromClipboardApi = async (
 			things.push({
 				type: 'text',
 				source: new Promise<string>((r) =>
-					item.getType('text/plain').then((blob) => blobAsString(blob).then(r))
+					item.getType('text/plain').then((blob) => FileHelpers.fileToBase64(blob).then(r))
 				),
 			})
 		}

commit 0a48aea7bb042ceaebf692e04cbdd0c97074d709
Author: alex <alex@dytry.ch>
Date:   Tue Mar 12 16:51:29 2024 +0000

    fixup file helpers (#3130)
    
    We had a couple regressions in #3110: first a missing `await` was
    causing fonts not to get properly embedded in exports. second, some
    `readAsText` calls were replaced with `readAsDataURL` calls.
    
    ### Change Type
    
    <!-- ‚ùó Please select a 'Scope' label ‚ùóÔ∏è -->
    
    - [x] `sdk` ‚Äî Changes the tldraw SDK
    - [ ] `dotcom` ‚Äî Changes the tldraw.com web app
    - [ ] `docs` ‚Äî Changes to the documentation, examples, or templates.
    - [ ] `vs code` ‚Äî Changes to the vscode plugin
    - [ ] `internal` ‚Äî Does not affect user-facing stuff
    
    <!-- ‚ùó Please select a 'Type' label ‚ùóÔ∏è -->
    
    - [x] `bugfix` ‚Äî Bug fix
    - [ ] `feature` ‚Äî New feature
    - [ ] `improvement` ‚Äî Improving existing features
    - [ ] `chore` ‚Äî Updating dependencies, other boring stuff
    - [ ] `galaxy brain` ‚Äî Architectural changes
    - [ ] `tests` ‚Äî Changes to any test code
    - [ ] `tools` ‚Äî Changes to infrastructure, CI, internal scripts,
    debugging tools, etc.
    - [ ] `dunno` ‚Äî I don't know

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index 7b51510be..f57dbd81f 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -250,27 +250,30 @@ const handlePasteFromClipboardApi = async (
 		if (item.types.includes('text/html')) {
 			things.push({
 				type: 'html',
-				source: new Promise<string>((r) =>
-					item.getType('text/html').then((blob) => FileHelpers.fileToBase64(blob).then(r))
-				),
+				source: (async () => {
+					const blob = await item.getType('text/html')
+					return await FileHelpers.blobToText(blob)
+				})(),
 			})
 		}
 
 		if (item.types.includes('text/uri-list')) {
 			things.push({
 				type: 'url',
-				source: new Promise<string>((r) =>
-					item.getType('text/uri-list').then((blob) => FileHelpers.fileToBase64(blob).then(r))
-				),
+				source: (async () => {
+					const blob = await item.getType('text/uri-list')
+					return await FileHelpers.blobToText(blob)
+				})(),
 			})
 		}
 
 		if (item.types.includes('text/plain')) {
 			things.push({
 				type: 'text',
-				source: new Promise<string>((r) =>
-					item.getType('text/plain').then((blob) => FileHelpers.fileToBase64(blob).then(r))
-				),
+				source: (async () => {
+					const blob = await item.getType('text/plain')
+					return await FileHelpers.blobToText(blob)
+				})(),
 			})
 		}
 	}

commit b5fab15c6d8c2b5efa7a8f1272b865620cff8923
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Sun Apr 21 12:45:55 2024 +0100

    Prevent default on native clipboard events (#3536)
    
    This PR calls prevent default on native clipboard events. This prevents
    the error sound on Safari.
    
    ### Change Type
    
    - [x] `sdk` ‚Äî Changes the tldraw SDK
    - [x] `bugfix` ‚Äî Bug fix
    
    ### Test Plan
    
    1. Use the cut, copy, and paste events on Safari.
    2. Everything should still work, but no sounds should play.
    
    ### Release Notes
    
    - Fix copy sound on clipboard events.

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index f57dbd81f..b26f39ab4 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -9,6 +9,8 @@ import {
 	TLTextShape,
 	VecLike,
 	isNonNull,
+	preventDefault,
+	stopEventPropagation,
 	uniq,
 	useEditor,
 	useValue,
@@ -615,24 +617,29 @@ export function useNativeClipboardEvents() {
 
 	useEffect(() => {
 		if (!appIsFocused) return
-		const copy = () => {
+		const copy = (e: ClipboardEvent) => {
 			if (
 				editor.getSelectedShapeIds().length === 0 ||
 				editor.getEditingShapeId() !== null ||
 				disallowClipboardEvents(editor)
-			)
+			) {
 				return
+			}
+
+			preventDefault(e)
 			handleNativeOrMenuCopy(editor)
 			trackEvent('copy', { source: 'kbd' })
 		}
 
-		function cut() {
+		function cut(e: ClipboardEvent) {
 			if (
 				editor.getSelectedShapeIds().length === 0 ||
 				editor.getEditingShapeId() !== null ||
 				disallowClipboardEvents(editor)
-			)
+			) {
 				return
+			}
+			preventDefault(e)
 			handleNativeOrMenuCopy(editor)
 			editor.deleteShapes(editor.getSelectedShapeIds())
 			trackEvent('cut', { source: 'kbd' })
@@ -648,9 +655,9 @@ export function useNativeClipboardEvents() {
 			}
 		}
 
-		const paste = (event: ClipboardEvent) => {
+		const paste = (e: ClipboardEvent) => {
 			if (disablingMiddleClickPaste) {
-				event.stopPropagation()
+				stopEventPropagation(e)
 				return
 			}
 
@@ -660,8 +667,8 @@ export function useNativeClipboardEvents() {
 			if (editor.getEditingShapeId() !== null || disallowClipboardEvents(editor)) return
 
 			// First try to use the clipboard data on the event
-			if (event.clipboardData && !editor.inputs.shiftKey) {
-				handlePasteFromEventClipboardData(editor, event.clipboardData)
+			if (e.clipboardData && !editor.inputs.shiftKey) {
+				handlePasteFromEventClipboardData(editor, e.clipboardData)
 			} else {
 				// Or else use the clipboard API
 				navigator.clipboard.read().then((clipboardItems) => {
@@ -671,6 +678,7 @@ export function useNativeClipboardEvents() {
 				})
 			}
 
+			preventDefault(e)
 			trackEvent('paste', { source: 'kbd' })
 		}
 

commit bf42d6e2a95f84500dc288698a9f144e81b186e1
Author: Mime ƒåuvalo <mimecuvalo@gmail.com>
Date:   Mon Apr 29 15:10:05 2024 +0100

    copy/paste: fix pasting not working from Edit menu (#3623)
    
    Looks like this has been broken for a while actually. I spelunked into
    the history of git blame around why we needed this but can't find when
    it was added easily. (maybe it was in brivate?)
    
    I don't _think_ we need the menu check anymore but lemme know if there's
    something I'm missing here @steveruizok
    
    ### Change Type
    
    <!-- ‚ùó Please select a 'Scope' label ‚ùóÔ∏è -->
    
    - [x] `sdk` ‚Äî Changes the tldraw SDK
    - [ ] `dotcom` ‚Äî Changes the tldraw.com web app
    - [ ] `docs` ‚Äî Changes to the documentation, examples, or templates.
    - [ ] `vs code` ‚Äî Changes to the vscode plugin
    - [ ] `internal` ‚Äî Does not affect user-facing stuff
    
    <!-- ‚ùó Please select a 'Type' label ‚ùóÔ∏è -->
    
    - [x] `bugfix` ‚Äî Bug fix
    - [ ] `feature` ‚Äî New feature
    - [ ] `improvement` ‚Äî Improving existing features
    - [ ] `chore` ‚Äî Updating dependencies, other boring stuff
    - [ ] `galaxy brain` ‚Äî Architectural changes
    - [ ] `tests` ‚Äî Changes to any test code
    - [ ] `tools` ‚Äî Changes to infrastructure, CI, internal scripts,
    debugging tools, etc.
    - [ ] `dunno` ‚Äî I don't know
    
    
    ### Release Notes
    
    - Clipboard: fix pasting from the Edit menu.

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index b26f39ab4..cb4148183 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -584,7 +584,7 @@ export function useMenuClipboardEvents() {
 			// If we're editing a shape, or we are focusing an editable input, then
 			// we would want the user's paste interaction to go to that element or
 			// input instead; e.g. when pasting text into a text shape's content
-			if (editor.getEditingShapeId() !== null || disallowClipboardEvents(editor)) return
+			if (editor.getEditingShapeId() !== null) return
 
 			if (Array.isArray(data) && data[0] instanceof ClipboardItem) {
 				handlePasteFromClipboardApi(editor, data, point)

commit fabba66c0f4b6c42ece30f409e70eb01e588f8e1
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Sat May 4 18:39:04 2024 +0100

    Camera options (#3282)
    
    This PR implements a camera options API.
    
    - [x] Initial PR
    - [x] Updated unit tests
    - [x] Feedback / review
    - [x] New unit tests
    - [x] Update use-case examples
    - [x] Ship?
    
    ## Public API
    
    A user can provide camera options to the `Tldraw` component via the
    `cameraOptions` prop. The prop is also available on the `TldrawEditor`
    component and the constructor parameters of the `Editor` class.
    
    ```tsx
    export default function CameraOptionsExample() {
            return (
                    <div className="tldraw__editor">
                            <Tldraw cameraOptions={CAMERA_OPTIONS} />
                    </div>
            )
    }
    ```
    
    At runtime, a user can:
    -  get the current camera options with `Editor.getCameraOptions`
    -  update the camera options with `Editor.setCameraOptions`
    
    Setting the camera options automatically applies them to the current
    camera.
    
    ```ts
    editor.setCameraOptions({...editor.getCameraOptions(), isLocked: true })
    ```
    
    A user can get the "camera fit zoom" via `editor.getCameraFitZoom()`.
    
    # Interface
    
    The camera options themselves can look a few different ways depending on
    the `type` provided.
    
    
    ```tsx
    export type TLCameraOptions = {
            /** Whether the camera is locked. */
            isLocked: boolean
            /** The speed of a scroll wheel / trackpad pan. Default is 1. */
            panSpeed: number
            /** The speed of a scroll wheel / trackpad zoom. Default is 1. */
            zoomSpeed: number
            /** The steps that a user can zoom between with zoom in / zoom out. The first and last value will determine the min and max zoom. */
            zoomSteps: number[]
            /** Controls whether the wheel pans or zooms.
             *
             * - `zoom`: The wheel will zoom in and out.
             * - `pan`: The wheel will pan the camera.
             * - `none`: The wheel will do nothing.
             */
            wheelBehavior: 'zoom' | 'pan' | 'none'
            /** The camera constraints. */
            constraints?: {
                    /** The bounds (in page space) of the constrained space */
                    bounds: BoxModel
                    /** The padding inside of the viewport (in screen space) */
                    padding: VecLike
                    /** The origin for placement. Used to position the bounds within the viewport when an axis is fixed or contained and zoom is below the axis fit. */
                    origin: VecLike
                    /** The camera's initial zoom, used also when the camera is reset.
                     *
                     * - `default`: Sets the initial zoom to 100%.
                     * - `fit-x`: The x axis will completely fill the viewport bounds.
                     * - `fit-y`: The y axis will completely fill the viewport bounds.
                     * - `fit-min`: The smaller axis will completely fill the viewport bounds.
                     * - `fit-max`: The larger axis will completely fill the viewport bounds.
                     * - `fit-x-100`: The x axis will completely fill the viewport bounds, or 100% zoom, whichever is smaller.
                     * - `fit-y-100`: The y axis will completely fill the viewport bounds, or 100% zoom, whichever is smaller.
                     * - `fit-min-100`: The smaller axis will completely fill the viewport bounds, or 100% zoom, whichever is smaller.
                     * - `fit-max-100`: The larger axis will completely fill the viewport bounds, or 100% zoom, whichever is smaller.
                     */
                    initialZoom:
                            | 'fit-min'
                            | 'fit-max'
                            | 'fit-x'
                            | 'fit-y'
                            | 'fit-min-100'
                            | 'fit-max-100'
                            | 'fit-x-100'
                            | 'fit-y-100'
                            | 'default'
                    /** The camera's base for its zoom steps.
                     *
                     * - `default`: Sets the initial zoom to 100%.
                     * - `fit-x`: The x axis will completely fill the viewport bounds.
                     * - `fit-y`: The y axis will completely fill the viewport bounds.
                     * - `fit-min`: The smaller axis will completely fill the viewport bounds.
                     * - `fit-max`: The larger axis will completely fill the viewport bounds.
                     * - `fit-x-100`: The x axis will completely fill the viewport bounds, or 100% zoom, whichever is smaller.
                     * - `fit-y-100`: The y axis will completely fill the viewport bounds, or 100% zoom, whichever is smaller.
                     * - `fit-min-100`: The smaller axis will completely fill the viewport bounds, or 100% zoom, whichever is smaller.
                     * - `fit-max-100`: The larger axis will completely fill the viewport bounds, or 100% zoom, whichever is smaller.
                     */
                    baseZoom:
                            | 'fit-min'
                            | 'fit-max'
                            | 'fit-x'
                            | 'fit-y'
                            | 'fit-min-100'
                            | 'fit-max-100'
                            | 'fit-x-100'
                            | 'fit-y-100'
                            | 'default'
                    /** The behavior for the constraints for both axes or each axis individually.
                     *
                     * - `free`: The bounds are ignored when moving the camera.
                     * - 'fixed': The bounds will be positioned within the viewport based on the origin
                     * - `contain`: The 'fixed' behavior will be used when the zoom is below the zoom level at which the bounds would fill the viewport; and when above this zoom, the bounds will use the 'inside' behavior.
                     * - `inside`: The bounds will stay completely within the viewport.
                     * - `outside`: The bounds will stay touching the viewport.
                     */
                    behavior:
                            | 'free'
                            | 'fixed'
                            | 'inside'
                            | 'outside'
                            | 'contain'
                            | {
                                            x: 'free' | 'fixed' | 'inside' | 'outside' | 'contain'
                                            y: 'free' | 'fixed' | 'inside' | 'outside' | 'contain'
                              }
            }
    }
    ```
    
    ### Change Type
    
    - [x] `sdk` ‚Äî Changes the tldraw SDK
    - [x] `feature` ‚Äî New feature
    
    ### Test Plan
    
    These features combine in different ways, so we'll want to write some
    more tests to find surprises.
    
    1. Add a step-by-step description of how to test your PR here.
    2.
    
    - [ ] Unit Tests
    
    ### Release Notes
    
    - SDK: Adds camera options.
    
    ---------
    
    Co-authored-by: Mitja Bezen≈°ek <mitja.bezensek@gmail.com>

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index cb4148183..16c06b07a 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -648,6 +648,7 @@ export function useNativeClipboardEvents() {
 		let disablingMiddleClickPaste = false
 		const pointerUpHandler = (e: PointerEvent) => {
 			if (e.button === 1) {
+				// middle mouse button
 				disablingMiddleClickPaste = true
 				requestAnimationFrame(() => {
 					disablingMiddleClickPaste = false

commit 142c27053b4ba56dfb265ee2661705033eab499a
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Sun May 12 22:02:53 2024 +0100

    Fix imports in Astro (#3742)
    
    This PR changes our imports so that they work in a few rare cases.
    https://github.com/tldraw/tldraw/issues/1817
    
    ### Change Type
    - [x] `sdk` ‚Äî Changes the tldraw SDK
    - [x] `bugfix` ‚Äî Bug fix
    
    ### Release Notes
    
    - Fix bug effecting imports in Astro.

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index 16c06b07a..a3ea39249 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -15,7 +15,7 @@ import {
 	useEditor,
 	useValue,
 } from '@tldraw/editor'
-import { compressToBase64, decompressFromBase64 } from 'lz-string'
+import lz from 'lz-string'
 import { useCallback, useEffect } from 'react'
 import { TLUiEventSource, useUiEvents } from '../context/events'
 import { pasteExcalidrawContent } from './clipboard/pasteExcalidrawContent'
@@ -328,7 +328,7 @@ async function handleClipboardThings(editor: Editor, things: ClipboardThing[], p
 							if (tldrawHtmlComment) {
 								try {
 									// If we've found tldraw content in the html string, use that as JSON
-									const jsonComment = decompressFromBase64(tldrawHtmlComment)
+									const jsonComment = lz.decompressFromBase64(tldrawHtmlComment)
 									if (jsonComment === null) {
 										r({
 											type: 'error',
@@ -491,7 +491,7 @@ const handleNativeOrMenuCopy = (editor: Editor) => {
 		return
 	}
 
-	const stringifiedClipboard = compressToBase64(
+	const stringifiedClipboard = lz.compressToBase64(
 		JSON.stringify({
 			type: 'application/tldraw',
 			kind: 'content',

commit aadc0aab4dba09fde89f66a32f6b67d6494a16a3
Author: Mime ƒåuvalo <mimecuvalo@gmail.com>
Date:   Tue Jun 4 09:50:40 2024 +0100

    editor: register timeouts/intervals/rafs for disposal (#3852)
    
    We have a lot of events that fire in the editor and, technically, they
    can fire after the Editor is long gone.
    This adds a registry/manager to track those timeout/interval/raf IDs
    (and some eslint rules to enforce it).
    
    Some other cleanups:
    - `requestAnimationFrame.polyfill.ts` looks like it's unused now (it
    used to be used in a prev. revision)
    - @ds300 I could use your feedback on the `EffectScheduler` tweak. in
    `useReactor` we do: `() => new EffectScheduler(name, reactFn, {
    scheduleEffect: (cb) => requestAnimationFrame(cb) }),`
    and that looks like it doesn't currently get disposed of properly.
    thoughts? happy to do that separately from this PR if you think that's a
    trickier thing.
    
    ### Change Type
    
    <!-- ‚ùó Please select a 'Scope' label ‚ùóÔ∏è -->
    
    - [x] `sdk` ‚Äî Changes the tldraw SDK
    - [ ] `dotcom` ‚Äî Changes the tldraw.com web app
    - [ ] `docs` ‚Äî Changes to the documentation, examples, or templates.
    - [ ] `vs code` ‚Äî Changes to the vscode plugin
    - [ ] `internal` ‚Äî Does not affect user-facing stuff
    
    <!-- ‚ùó Please select a 'Type' label ‚ùóÔ∏è -->
    
    - [ ] `bugfix` ‚Äî Bug fix
    - [ ] `feature` ‚Äî New feature
    - [x] `improvement` ‚Äî Improving existing features
    - [ ] `chore` ‚Äî Updating dependencies, other boring stuff
    - [ ] `galaxy brain` ‚Äî Architectural changes
    - [ ] `tests` ‚Äî Changes to any test code
    - [ ] `tools` ‚Äî Changes to infrastructure, CI, internal scripts,
    debugging tools, etc.
    - [ ] `dunno` ‚Äî I don't know
    
    
    ### Test Plan
    
    1. Test async operations and make sure they don't fire after disposal.
    
    ### Release Notes
    
    - Editor: add registry of timeouts/intervals/rafs
    
    ---------
    
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index a3ea39249..bd2da94ba 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -650,7 +650,7 @@ export function useNativeClipboardEvents() {
 			if (e.button === 1) {
 				// middle mouse button
 				disablingMiddleClickPaste = true
-				requestAnimationFrame(() => {
+				editor.timers.requestAnimationFrame(() => {
 					disablingMiddleClickPaste = false
 				})
 			}

commit 735161c4a81fb617805ffb7f76a274954ec1d2f4
Author: Mime ƒåuvalo <mimecuvalo@gmail.com>
Date:   Fri Jun 14 11:23:52 2024 +0100

    assets: store in indexedDB, not as base64 (#3836)
    
    this is take #2 of this PR https://github.com/tldraw/tldraw/pull/3745
    
    As I look at LOD holistically and whether we have multiple sources when
    working locally, I learned that our system used base64 encoding of
    assets directly. Issue https://github.com/tldraw/tldraw/issues/3728
    
    <img width="1350" alt="assetstore"
    src="https://github.com/tldraw/tldraw/assets/469604/e7b41e29-6656-4d9b-b462-72d43b98f3f7">
    
    
    The motivations and benefits are:
    - store size: not having a huge base64 blobs injected in room data
    - perf on loading snapshot: this helps with loading the room data more
    quickly
    - multiple sources: furthermore, if we do decide to have multiple
    sources locally (for each asset), then we won't get a multiplicative
    effect of even larger JSON blobs that have lots of base64 data in them
    - encoding/decoding perf: this also saves the (slow) step of having to
    base64 encode/decode our assets, we can just strictly with work with
    blobs.
    
    
    Todo:
    - [x] decodes video and images
    - [x] make sure it syncs to other tabs
    - [x] make sure it syncs to other multiplayer room
    - [x] fix tests
    
    
    ### Change Type
    
    <!-- ‚ùó Please select a 'Scope' label ‚ùóÔ∏è -->
    
    - [x] `sdk` ‚Äî Changes the tldraw SDK
    - [ ] `dotcom` ‚Äî Changes the tldraw.com web app
    - [ ] `docs` ‚Äî Changes to the documentation, examples, or templates.
    - [ ] `vs code` ‚Äî Changes to the vscode plugin
    - [ ] `internal` ‚Äî Does not affect user-facing stuff
    
    <!-- ‚ùó Please select a 'Type' label ‚ùóÔ∏è -->
    
    - [ ] `bugfix` ‚Äî Bug fix
    - [ ] `feature` ‚Äî New feature
    - [x] `improvement` ‚Äî Improving existing features
    - [ ] `chore` ‚Äî Updating dependencies, other boring stuff
    - [ ] `galaxy brain` ‚Äî Architectural changes
    - [ ] `tests` ‚Äî Changes to any test code
    - [ ] `tools` ‚Äî Changes to infrastructure, CI, internal scripts,
    debugging tools, etc.
    - [ ] `dunno` ‚Äî I don't know
    
    
    ### Test Plan
    
    1. Test the shit out of uploading/downloading video/image assets,
    locally+multiplayer.
    
    - [ ] Need to fix current tests and write new ones
    
    ### Release Notes
    
    - Assets: store as reference to blob in indexedDB instead of storing
    directly as base64 in the snapshot.

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index bd2da94ba..59aa82fc1 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -482,8 +482,10 @@ async function handleClipboardThings(editor: Editor, things: ClipboardThing[], p
  * @param editor - The editor instance.
  * @public
  */
-const handleNativeOrMenuCopy = (editor: Editor) => {
-	const content = editor.getContentFromCurrentPage(editor.getSelectedShapeIds())
+const handleNativeOrMenuCopy = async (editor: Editor) => {
+	const content = await editor.resolveAssetsInContent(
+		editor.getContentFromCurrentPage(editor.getSelectedShapeIds())
+	)
 	if (!content) {
 		if (navigator && navigator.clipboard) {
 			navigator.clipboard.writeText('')
@@ -555,20 +557,20 @@ export function useMenuClipboardEvents() {
 	const trackEvent = useUiEvents()
 
 	const copy = useCallback(
-		function onCopy(source: TLUiEventSource) {
+		async function onCopy(source: TLUiEventSource) {
 			if (editor.getSelectedShapeIds().length === 0) return
 
-			handleNativeOrMenuCopy(editor)
+			await handleNativeOrMenuCopy(editor)
 			trackEvent('copy', { source })
 		},
 		[editor, trackEvent]
 	)
 
 	const cut = useCallback(
-		function onCut(source: TLUiEventSource) {
+		async function onCut(source: TLUiEventSource) {
 			if (editor.getSelectedShapeIds().length === 0) return
 
-			handleNativeOrMenuCopy(editor)
+			await handleNativeOrMenuCopy(editor)
 			editor.deleteShapes(editor.getSelectedShapeIds())
 			trackEvent('cut', { source })
 		},
@@ -617,7 +619,7 @@ export function useNativeClipboardEvents() {
 
 	useEffect(() => {
 		if (!appIsFocused) return
-		const copy = (e: ClipboardEvent) => {
+		const copy = async (e: ClipboardEvent) => {
 			if (
 				editor.getSelectedShapeIds().length === 0 ||
 				editor.getEditingShapeId() !== null ||
@@ -627,11 +629,11 @@ export function useNativeClipboardEvents() {
 			}
 
 			preventDefault(e)
-			handleNativeOrMenuCopy(editor)
+			await handleNativeOrMenuCopy(editor)
 			trackEvent('copy', { source: 'kbd' })
 		}
 
-		function cut(e: ClipboardEvent) {
+		async function cut(e: ClipboardEvent) {
 			if (
 				editor.getSelectedShapeIds().length === 0 ||
 				editor.getEditingShapeId() !== null ||
@@ -640,7 +642,7 @@ export function useNativeClipboardEvents() {
 				return
 			}
 			preventDefault(e)
-			handleNativeOrMenuCopy(editor)
+			await handleNativeOrMenuCopy(editor)
 			editor.deleteShapes(editor.getSelectedShapeIds())
 			trackEvent('cut', { source: 'kbd' })
 		}

commit 9850ef93e2af7fb1861616dabb0fa66868689222
Author: Mime ƒåuvalo <mimecuvalo@gmail.com>
Date:   Mon Jun 24 14:10:38 2024 +0100

    clipboard: fix copy/paste on Firefox (#4003)
    
    So, here's what's up:
    - in Firefox, in version 127 `navigator.clipboard.write` support was
    added:
    https://developer.mozilla.org/en-US/docs/Mozilla/Firefox/Releases/127
    - previously, Firefox was going down an if/else branch where
    `navigator.clipboard.write` isn't present, we use
    `navigator.clipboard.writeText`
    - Now, that Firefox is using the more common path, it now puts
    MIME-types on the clipboard, both HTML and plaintext.
    - _However_, on Firefox, it uses a different sanitization algorithm than
    the Blink engine does and it ends up scrubbing out the `<tldraw>` fake
    HTML tag:
    https://developer.chrome.com/docs/web-platform/unsanitized-html-async-clipboard
    - And, unfortunately, Firefox doesn't support setting `unsanitized` on
    the ClipboardItem: https://caniuse.com/?search=unsanitized
    - see also:
    https://developer.chrome.com/docs/web-platform/unsanitized-html-async-clipboard
    - So, the workaround here is to just use `<div data-tldraw>`. I'm not
    completely happy with it since the ending `</div>` tag assumes there's
    no nesting but ¬Ø\\_(„ÉÑ)_/¬Ø it's fine in this case.
    - Plus, I wanted to make sure that in the wild no one was relying on
    this format being what was on the clipboard. Searching across all of
    GitHub it seems like it'll be fine.
    
    - The longer term, better solution, would be to use custom HTML formats:
    https://developer.chrome.com/blog/web-custom-formats-for-the-async-clipboard-api
    - However, of course, Firefox doesn't support that yet either üôÉ
    https://caniuse.com/?search=web%20custom%20format
    - see also:
    https://developer.chrome.com/blog/web-custom-formats-for-the-async-clipboard-api
    
    Talked with Alex, and what we could do down the line is copy SVG-in-HTML
    and then include `data-info` attributes that had data we could extract
    per shape. Something like that :handwavy: :)
    
    I'll hotfix this once it lands.
    
    ### Change Type
    
    <!-- ‚ùó Please select a 'Scope' label ‚ùóÔ∏è -->
    
    - [x] `sdk` ‚Äî Changes the tldraw SDK
    - [ ] `dotcom` ‚Äî Changes the tldraw.com web app
    - [ ] `docs` ‚Äî Changes to the documentation, examples, or templates.
    - [ ] `vs code` ‚Äî Changes to the vscode plugin
    - [ ] `internal` ‚Äî Does not affect user-facing stuff
    
    <!-- ‚ùó Please select a 'Type' label ‚ùóÔ∏è -->
    
    - [x] `bugfix` ‚Äî Bug fix
    - [ ] `feature` ‚Äî New feature
    - [ ] `improvement` ‚Äî Improving existing features
    - [ ] `chore` ‚Äî Updating dependencies, other boring stuff
    - [ ] `galaxy brain` ‚Äî Architectural changes
    - [ ] `tests` ‚Äî Changes to any test code
    - [ ] `tools` ‚Äî Changes to infrastructure, CI, internal scripts,
    debugging tools, etc.
    - [ ] `dunno` ‚Äî I don't know
    
    ### Release Notes
    
    - Clipboard: fix copy/paste in Firefox 127+

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index 59aa82fc1..f4f1af36a 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -323,7 +323,7 @@ async function handleClipboardThings(editor: Editor, things: ClipboardThing[], p
 
 						thing.source.then((text) => {
 							// first, see if we can find tldraw content, which is JSON inside of an html comment
-							const tldrawHtmlComment = text.match(/<tldraw[^>]*>(.*)<\/tldraw>/)?.[1]
+							const tldrawHtmlComment = text.match(/<div data-tldraw[^>]*>(.*)<\/div>/)?.[1]
 
 							if (tldrawHtmlComment) {
 								try {
@@ -525,7 +525,7 @@ const handleNativeOrMenuCopy = async (editor: Editor) => {
 			.filter(isNonNull)
 
 		if (navigator.clipboard?.write) {
-			const htmlBlob = new Blob([`<tldraw>${stringifiedClipboard}</tldraw>`], {
+			const htmlBlob = new Blob([`<div data-tldraw>${stringifiedClipboard}</div>`], {
 				type: 'text/html',
 			})
 
@@ -546,7 +546,7 @@ const handleNativeOrMenuCopy = async (editor: Editor) => {
 				}),
 			])
 		} else if (navigator.clipboard.writeText) {
-			navigator.clipboard.writeText(`<tldraw>${stringifiedClipboard}</tldraw>`)
+			navigator.clipboard.writeText(`<div data-tldraw>${stringifiedClipboard}</div data-tldraw>`)
 		}
 	}
 }

commit 8ac48877de5d69a48606c4618eeb01c3292dd76b
Author: Mime ƒåuvalo <mimecuvalo@gmail.com>
Date:   Mon Jun 24 16:00:52 2024 +0100

    clipboard: fix copy/paste bad typo, ugh (#4008)
    
    omg, now this typo broke older versions of Firefox, christ.
    followup to https://github.com/tldraw/tldraw/pull/4003
    
    ### Change Type
    
    <!-- ‚ùó Please select a 'Scope' label ‚ùóÔ∏è -->
    
    - [x] `sdk` ‚Äî Changes the tldraw SDK
    - [ ] `dotcom` ‚Äî Changes the tldraw.com web app
    - [ ] `docs` ‚Äî Changes to the documentation, examples, or templates.
    - [ ] `vs code` ‚Äî Changes to the vscode plugin
    - [ ] `internal` ‚Äî Does not affect user-facing stuff
    
    <!-- ‚ùó Please select a 'Type' label ‚ùóÔ∏è -->
    
    - [x] `bugfix` ‚Äî Bug fix
    - [ ] `feature` ‚Äî New feature
    - [ ] `improvement` ‚Äî Improving existing features
    - [ ] `chore` ‚Äî Updating dependencies, other boring stuff
    - [ ] `galaxy brain` ‚Äî Architectural changes
    - [ ] `tests` ‚Äî Changes to any test code
    - [ ] `tools` ‚Äî Changes to infrastructure, CI, internal scripts,
    debugging tools, etc.
    - [ ] `dunno` ‚Äî I don't know
    
    ### Release Notes
    
    - Clipboard: fix copy/paste for older versions of Firefox

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index f4f1af36a..b6f117b0d 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -546,7 +546,7 @@ const handleNativeOrMenuCopy = async (editor: Editor) => {
 				}),
 			])
 		} else if (navigator.clipboard.writeText) {
-			navigator.clipboard.writeText(`<div data-tldraw>${stringifiedClipboard}</div data-tldraw>`)
+			navigator.clipboard.writeText(`<div data-tldraw>${stringifiedClipboard}</div>`)
 		}
 	}
 }

commit a85c215ffc8a87439edd2c7db037944a3e8a2aba
Author: Mitja Bezen≈°ek <mitja.bezensek@gmail.com>
Date:   Tue Jul 9 11:09:34 2024 +0200

    Add "paste at cursor" option, which toggles how `cmd + v` and `cmd + shift + v` work (#4088)
    
    Add an option to make paste at cursor the default.
    
    Not sure if we also want to expose this on tldraw.com? For now I did,
    but happy to remove if we'd want to keep the preferences simple.
    
    We could also add this to the `TldrawOptions`, but it felt like some
    apps might actually allow this customization on a per user level.
    
    Solves https://github.com/tldraw/tldraw/issues/4066
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [x] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Test plan
    
    1. Copy / pasting should still work as it works now: `‚åò + v` pastes on
    top of the shape, `‚åò + ‚áß + v` pastes at cursor.
    2. There's now a new option under Preferences to paste at cursor. This
    just swaps the logic between the two shortcuts: `‚åò + v` then pastes at
    cursor and `‚åò + ‚áß + v` pastes on top of the shape.
    
    ### Release notes
    
    - Allow users and sdk users to make pasting at the cursor a default
    instead of only being available with `‚åò + ‚áß + v`.

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index b6f117b0d..0285d4d1f 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -671,12 +671,20 @@ export function useNativeClipboardEvents() {
 
 			// First try to use the clipboard data on the event
 			if (e.clipboardData && !editor.inputs.shiftKey) {
-				handlePasteFromEventClipboardData(editor, e.clipboardData)
+				if (editor.user.getPasteAtCursor()) {
+					handlePasteFromEventClipboardData(editor, e.clipboardData, editor.inputs.currentPagePoint)
+				} else {
+					handlePasteFromEventClipboardData(editor, e.clipboardData)
+				}
 			} else {
 				// Or else use the clipboard API
 				navigator.clipboard.read().then((clipboardItems) => {
 					if (Array.isArray(clipboardItems) && clipboardItems[0] instanceof ClipboardItem) {
-						handlePasteFromClipboardApi(editor, clipboardItems, editor.inputs.currentPagePoint)
+						if (e.clipboardData && editor.user.getPasteAtCursor()) {
+							handlePasteFromClipboardApi(editor, clipboardItems)
+						} else {
+							handlePasteFromClipboardApi(editor, clipboardItems, editor.inputs.currentPagePoint)
+						}
 					}
 				})
 			}

commit 332affa4a995fbe3dfbc130cfff5eaebd908b87a
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Tue Jul 9 11:16:23 2024 +0100

    Fix paste at point (#4104)
    
    This PR fixes the paste at point logic.
    
    ### Change type
    
    - [x] `bugfix`
    
    ### Test plan
    
    1. copy, paste (in original position)
    2. hold shift to paste at cursor
    3. turn on paste at cursor mode
    4. copy, paste (at cursor)
    5. hold shift to paste in original position

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index 0285d4d1f..175180de0 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -7,6 +7,7 @@ import {
 	TLExternalContentSource,
 	TLGeoShape,
 	TLTextShape,
+	Vec,
 	VecLike,
 	isNonNull,
 	preventDefault,
@@ -669,22 +670,27 @@ export function useNativeClipboardEvents() {
 			// input instead; e.g. when pasting text into a text shape's content
 			if (editor.getEditingShapeId() !== null || disallowClipboardEvents(editor)) return
 
+			// Where should the shapes go?
+			let point: Vec | undefined = undefined
+			let pasteAtCursor = false
+
+			// | Shiftkey | Paste at cursor mode | Paste at point? |
+			// |    N 		|         N            |       N 				 |
+			// |    Y 		|         N            |       Y 				 |
+			// |    N 		|         Y            |       Y 				 |
+			// |    Y 		|         Y            |       N 				 |
+			if (editor.inputs.shiftKey) pasteAtCursor = true
+			if (editor.user.getIsPasteAtCursorMode()) pasteAtCursor = !pasteAtCursor
+			if (pasteAtCursor) point = editor.inputs.currentPagePoint
+
 			// First try to use the clipboard data on the event
 			if (e.clipboardData && !editor.inputs.shiftKey) {
-				if (editor.user.getPasteAtCursor()) {
-					handlePasteFromEventClipboardData(editor, e.clipboardData, editor.inputs.currentPagePoint)
-				} else {
-					handlePasteFromEventClipboardData(editor, e.clipboardData)
-				}
+				handlePasteFromEventClipboardData(editor, e.clipboardData, point)
 			} else {
 				// Or else use the clipboard API
 				navigator.clipboard.read().then((clipboardItems) => {
 					if (Array.isArray(clipboardItems) && clipboardItems[0] instanceof ClipboardItem) {
-						if (e.clipboardData && editor.user.getPasteAtCursor()) {
-							handlePasteFromClipboardApi(editor, clipboardItems)
-						} else {
-							handlePasteFromClipboardApi(editor, clipboardItems, editor.inputs.currentPagePoint)
-						}
+						handlePasteFromClipboardApi(editor, clipboardItems, point)
 					}
 				})
 			}

commit 2458db7a4e0936a3d954e05171a63335652b4691
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Fri Jul 26 14:18:24 2024 +0100

    Deprecate editor.mark, fix cropping tests (#4250)
    
    So it turns out `editor.mark(id)` is a bit problematic unless you always
    pass in unique id, because it's quite easy to create situations where
    you will call `bailToMark(id)` but the mark that you were _intending_ to
    bail to has already been popped off the stack due to another previous
    call to `bailToMark`.
    
    I always suspected this might be the case (the original late 2022
    history api was designed to avoid this, but it got changed at some
    point) and indeed I ran into this bug while investigating a cropping
    undo/redo test error.
    
    To prevent issues for ourselves and our users, let's force people to use
    a randomly generated mark ID.
    
    Also `editor.mark` is a bad name. `mark` could mean a million things,
    even in the context of `editor.history.mark` it's a pretty bad name.
    Let's help people out and make it more descriptive.
    
    This PR deprecates the `editor.mark(id)` in favor of `id =
    editor.markHistoryStoppingPoint(name)`.
    
    I converted a couple of usages of editor.mark over but there's a lot
    left to do so I only want to do it if you don't object @steveruizok
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [x] `api`
    - [ ] `other`
    
    ### Test plan
    
    1. Create a shape...
    2.
    
    - [ ] Unit tests
    - [ ] End to end tests
    
    ### Release notes
    
    This deprecates `Editor.mark()` in favour of
    `Editor.markHistoryStoppingPoint()`.
    
    This was done because calling `editor.mark(id)` is a potential footgun
    unless you always provide a random ID. So
    `editor.markHistoryStoppingPoint()` always returns a random id.

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index 175180de0..b2094504d 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -115,7 +115,7 @@ const handleText = (
 	} else if (isValidHttpURL(data)) {
 		pasteUrl(editor, data, point)
 	} else if (isSvgText(data)) {
-		editor.mark('paste')
+		editor.markHistoryStoppingPoint('paste')
 		editor.putExternalContent({
 			type: 'svg-text',
 			text: data,
@@ -123,7 +123,7 @@ const handleText = (
 			sources,
 		})
 	} else {
-		editor.mark('paste')
+		editor.markHistoryStoppingPoint('paste')
 		editor.putExternalContent({
 			type: 'text',
 			text: data,

commit ef89eedfce969daf4d119e2abb4b894b70da3c56
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon Jul 29 14:25:58 2024 +0100

    Add option for max pasted / dropped files (#4294)
    
    This PR adds an editor option for the maximum number of pasted or
    inserted files. The default is 100, a simple sanity check.
    
    ### Change type
    
    - [x] `improvement`
    
    ### Test plan
    
    1. paste 101 files
    2. it should error
    
    ### Release notes
    
    - We now have an editor option for the maximum number of files that a
    user can paste at once.

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index b2094504d..a03198fad 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -296,6 +296,9 @@ async function handleClipboardThings(editor: Editor, things: ClipboardThing[], p
 
 	// Just paste the files, nothing else
 	if (files.length) {
+		if (files.length > editor.options.maxFilesAtOnce) {
+			throw Error('Too many files')
+		}
 		const fileBlobs = await Promise.all(files.map((t) => t.source!))
 		const urls = (fileBlobs.filter(Boolean) as (File | Blob)[]).map((blob) =>
 			URL.createObjectURL(blob)

commit d8f1f08e9da278d6b102895c61aaf67891e818a1
Author: Mitja Bezen≈°ek <mitja.bezensek@gmail.com>
Date:   Fri Aug 23 15:35:06 2024 +0200

    Simplify getting of the text (#4414)
    
    We have a method now for getting the text. This should also make it work
    for any custom shapes with text.
    
    ### Change type
    
    - [ ] `bugfix`
    - [x] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Release notes
    
    - Make copying for text also work for custom shapes that have text (they
    need to override the `getText` method in the shape util).

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index a03198fad..e88d65265 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -1,15 +1,10 @@
 import {
 	Editor,
 	FileHelpers,
-	TLArrowShape,
-	TLBookmarkShape,
-	TLEmbedShape,
 	TLExternalContentSource,
-	TLGeoShape,
-	TLTextShape,
 	Vec,
 	VecLike,
-	isNonNull,
+	isDefined,
 	preventDefault,
 	stopEventPropagation,
 	uniq,
@@ -511,22 +506,10 @@ const handleNativeOrMenuCopy = async (editor: Editor) => {
 		// Extract the text from the clipboard
 		const textItems = content.shapes
 			.map((shape) => {
-				if (
-					editor.isShapeOfType<TLTextShape>(shape, 'text') ||
-					editor.isShapeOfType<TLGeoShape>(shape, 'geo') ||
-					editor.isShapeOfType<TLArrowShape>(shape, 'arrow')
-				) {
-					return shape.props.text
-				}
-				if (
-					editor.isShapeOfType<TLBookmarkShape>(shape, 'bookmark') ||
-					editor.isShapeOfType<TLEmbedShape>(shape, 'embed')
-				) {
-					return shape.props.url
-				}
-				return null
+				const util = editor.getShapeUtil(shape)
+				return util.getText(shape)
 			})
-			.filter(isNonNull)
+			.filter(isDefined)
 
 		if (navigator.clipboard?.write) {
 			const htmlBlob = new Blob([`<div data-tldraw>${stringifiedClipboard}</div>`], {

commit 09f89a60f403ff704c1372eff9fecba6cd5ce361
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Mon Sep 30 16:27:45 2024 -0400

    [dotcom] Menus, dialogs, toasts, etc. (#4624)
    
    This PR brings tldraw's ui into the application layer: dialogs, menus,
    etc.
    
    It:
    - brings our dialogs to the application layer
    - brings our toasts to the application layer
    - brings our translations to the application layer
    - brings our assets to the application layer
    - creates a "file menu"
    - creates a "rename file" dialog
    - creates the UI for changing the title of a file in the header
    - adjusts some text sizes
    
    In order to do that, I've had to:
    - create a global `tlmenus` system for menus
    - create a global `tltime` system for timers
    - create a global `tlenv` for environment"
    - create a `useMaybeEditor` hook
    
    ### Change type
    
    - [x] `other`
    
    ### Release notes
    - exports dialogs system
    - exports toasts system
    - exports translations system
    - create a global `tlmenus` system for menus
    - create a global `tltime` system for timers
    - create a global `tlenv` for environment"
    - create a `useMaybeEditor` hook
    
    ---------
    
    Co-authored-by: Mitja Bezen≈°ek <mitja.bezensek@gmail.com>

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index e88d65265..e238361fd 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -73,7 +73,7 @@ const INPUTS = ['input', 'select', 'textarea']
 function disallowClipboardEvents(editor: Editor) {
 	const { activeElement } = document
 	return (
-		editor.getIsMenuOpen() ||
+		editor.menus.hasAnyOpenMenus() ||
 		(activeElement &&
 			(activeElement.getAttribute('contenteditable') ||
 				INPUTS.indexOf(activeElement.tagName.toLowerCase()) > -1))

commit 9d6b5916e83ef758dc7c28d3fc221fd4f0236b14
Author: Mime ƒåuvalo <mimecuvalo@gmail.com>
Date:   Mon Oct 21 13:01:37 2024 +0100

    menus: rework the open menu logic to be in one consistent place (#4642)
    
    We have a lot of logic scattered everywhere to prevent certain logic
    when menus are open. It's a very manual process, easy to forget about
    when adding new shapes/tools/logic. This flips the logic a bit to be
    handled in one place vs. various places trying to account for this.
    
    ### Change type
    
    - [ ] `bugfix`
    - [x] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Release notes
    
    - Rework open menu logic to be centralized.
    
    ---------
    
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index e238361fd..861b05111 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -67,16 +67,14 @@ const INPUTS = ['input', 'select', 'textarea']
 /**
  * Get whether to disallow clipboard events.
  *
- * @param editor - The editor instance.
  * @internal
  */
-function disallowClipboardEvents(editor: Editor) {
+function disallowClipboardEvents() {
 	const { activeElement } = document
 	return (
-		editor.menus.hasAnyOpenMenus() ||
-		(activeElement &&
-			(activeElement.getAttribute('contenteditable') ||
-				INPUTS.indexOf(activeElement.tagName.toLowerCase()) > -1))
+		activeElement &&
+		(activeElement.getAttribute('contenteditable') ||
+			INPUTS.indexOf(activeElement.tagName.toLowerCase()) > -1)
 	)
 }
 
@@ -610,7 +608,7 @@ export function useNativeClipboardEvents() {
 			if (
 				editor.getSelectedShapeIds().length === 0 ||
 				editor.getEditingShapeId() !== null ||
-				disallowClipboardEvents(editor)
+				disallowClipboardEvents()
 			) {
 				return
 			}
@@ -624,7 +622,7 @@ export function useNativeClipboardEvents() {
 			if (
 				editor.getSelectedShapeIds().length === 0 ||
 				editor.getEditingShapeId() !== null ||
-				disallowClipboardEvents(editor)
+				disallowClipboardEvents()
 			) {
 				return
 			}
@@ -654,7 +652,7 @@ export function useNativeClipboardEvents() {
 			// If we're editing a shape, or we are focusing an editable input, then
 			// we would want the user's paste interaction to go to that element or
 			// input instead; e.g. when pasting text into a text shape's content
-			if (editor.getEditingShapeId() !== null || disallowClipboardEvents(editor)) return
+			if (editor.getEditingShapeId() !== null || disallowClipboardEvents()) return
 
 			// Where should the shapes go?
 			let point: Vec | undefined = undefined

commit cda5ce3f74369b714cf946c89a66e45476ade49f
Author: Steve Ruiz <steveruizok@gmail.com>
Date:   Wed Oct 23 12:42:21 2024 +0100

    [Fix] Keyboard events on menus (#4745)
    
    This PR fixes a bug where keyboard events weren't working in dialogs.
    
    ### Change type
    
    - [x] `bugfix`

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index 861b05111..7af4af757 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -69,12 +69,14 @@ const INPUTS = ['input', 'select', 'textarea']
  *
  * @internal
  */
-function disallowClipboardEvents() {
+function areShortcutsDisabled(editor: Editor) {
 	const { activeElement } = document
+
 	return (
-		activeElement &&
-		(activeElement.getAttribute('contenteditable') ||
-			INPUTS.indexOf(activeElement.tagName.toLowerCase()) > -1)
+		editor.menus.hasAnyOpenMenus() ||
+		(activeElement &&
+			(activeElement.getAttribute('contenteditable') ||
+				INPUTS.indexOf(activeElement.tagName.toLowerCase()) > -1))
 	)
 }
 
@@ -608,7 +610,7 @@ export function useNativeClipboardEvents() {
 			if (
 				editor.getSelectedShapeIds().length === 0 ||
 				editor.getEditingShapeId() !== null ||
-				disallowClipboardEvents()
+				areShortcutsDisabled(editor)
 			) {
 				return
 			}
@@ -622,7 +624,7 @@ export function useNativeClipboardEvents() {
 			if (
 				editor.getSelectedShapeIds().length === 0 ||
 				editor.getEditingShapeId() !== null ||
-				disallowClipboardEvents()
+				areShortcutsDisabled(editor)
 			) {
 				return
 			}
@@ -652,7 +654,7 @@ export function useNativeClipboardEvents() {
 			// If we're editing a shape, or we are focusing an editable input, then
 			// we would want the user's paste interaction to go to that element or
 			// input instead; e.g. when pasting text into a text shape's content
-			if (editor.getEditingShapeId() !== null || disallowClipboardEvents()) return
+			if (editor.getEditingShapeId() !== null || areShortcutsDisabled(editor)) return
 
 			// Where should the shapes go?
 			let point: Vec | undefined = undefined

commit b301aeb64e5ff7bcd55928d7200a39092da8c501
Author: Mime ƒåuvalo <mimecuvalo@gmail.com>
Date:   Wed Oct 23 15:55:42 2024 +0100

    npm: upgrade eslint v8 ‚Üí v9 (#4757)
    
    As I worked on the i18n PR (https://github.com/tldraw/tldraw/pull/4719)
    I noticed that `react-intl` required a new version of `eslint`. That led
    me down a bit of a rabbit hole of upgrading v8 ‚Üí v9. There were a couple
    things to upgrade to make this work.
    
    - ran `npx @eslint/migrate-config .eslintrc.js` to upgrade to the new
    `eslint.config.mjs`
    - `.eslintignore` is now deprecated and part of `eslint.config.mjs`
    - some packages are no longer relevant, of note: `eslint-plugin-local`
    and `eslint-plugin-deprecation`
    - the upgrade caught a couple bugs/dead code
    
    ### Change type
    
    - [ ] `bugfix`
    - [x] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Release notes
    
    - Upgrade eslint v8 ‚Üí v9
    
    ---------
    
    Co-authored-by: alex <alex@dytry.ch>
    Co-authored-by: David Sheldrick <d.j.sheldrick@gmail.com>
    Co-authored-by: Mitja Bezen≈°ek <mitja.bezensek@gmail.com>
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index 7af4af757..1b191491d 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -36,7 +36,7 @@ export const isValidHttpURL = (url: string) => {
 	try {
 		const u = new URL(url)
 		return u.protocol === 'http:' || u.protocol === 'https:'
-	} catch (e) {
+	} catch {
 		return false
 	}
 }
@@ -50,7 +50,7 @@ const getValidHttpURLList = (url: string) => {
 			if (!(u.protocol === 'http:' || u.protocol === 'https:')) {
 				return
 			}
-		} catch (e) {
+		} catch {
 			return
 		}
 	}
@@ -358,7 +358,7 @@ async function handleClipboardThings(editor: Editor, things: ClipboardThing[], p
 										r({ type: 'tldraw', data: json.data })
 										return
 									}
-								} catch (e: any) {
+								} catch {
 									r({
 										type: 'error',
 										data: tldrawHtmlComment,
@@ -389,7 +389,7 @@ async function handleClipboardThings(editor: Editor, things: ClipboardThing[], p
 										r({ type: 'text', data: text, subtype: 'json' })
 										return
 									}
-								} catch (e) {
+								} catch {
 									// If we could not parse the text as JSON, then it's just text
 									r({ type: 'text', data: text, subtype: 'text' })
 									return

commit 1c8c3ac67ef75f82102b898763de18a94caf0ae3
Author: alex <alex@dytry.ch>
Date:   Tue Nov 12 15:37:06 2024 +0000

    make sure copy-as-png comes in at natural size (#4771)
    
    Browsers sanitize image formats to prevent security issues when pasting
    between applications. For
    paste within an application though, some browsers (only chromium-based
    browsers as of Nov 2024)
    support custom clipboard formats starting with "web " which are
    unsanitized. Our PNGs include a
    special chunk which indicates they're at 2x resolution, but that
    normally gets stripped - so if
    you copy as png from tldraw, then paste back in, the resulting image
    will be 2x the expected
    size.
    
    To work around this, this diff writes 2 version of the image to the
    clipboard - the normal png, and
    the same blob with a custom mime type. When pasting, we check first for
    the custom mime type, and
    if it's there, use that instead of the normal png.
    
    ### Change type
    
    - [x] `bugfix`
    
    ### Release notes
    
    - Shapes copied as PNG will have the same size when pasted back into
    tldraw.

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index 1b191491d..a67e715ee 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -4,6 +4,7 @@ import {
 	TLExternalContentSource,
 	Vec,
 	VecLike,
+	compact,
 	isDefined,
 	preventDefault,
 	stopEventPropagation,
@@ -13,12 +14,24 @@ import {
 } from '@tldraw/editor'
 import lz from 'lz-string'
 import { useCallback, useEffect } from 'react'
+import { TLDRAW_CUSTOM_PNG_MIME_TYPE, getCanonicalClipboardReadType } from '../../utils/clipboard'
 import { TLUiEventSource, useUiEvents } from '../context/events'
 import { pasteExcalidrawContent } from './clipboard/pasteExcalidrawContent'
 import { pasteFiles } from './clipboard/pasteFiles'
 import { pasteTldrawContent } from './clipboard/pasteTldrawContent'
 import { pasteUrl } from './clipboard/pasteUrl'
 
+// Expected paste mime types. The earlier in this array they appear, the higher preference we give
+// them. For example, we prefer the `web image/png+tldraw` type to plain `image/png` as it does not
+// strip some of the extra metadata we write into it.
+const expectedPasteFileMimeTypes = [
+	TLDRAW_CUSTOM_PNG_MIME_TYPE,
+	'image/png',
+	'image/jpeg',
+	'image/webp',
+	'image/svg+xml',
+] satisfies string[]
+
 /**
  * Strip HTML tags from a string.
  * @param html - The HTML to strip.
@@ -80,15 +93,6 @@ function areShortcutsDisabled(editor: Editor) {
 	)
 }
 
-/**
- * Whether a ClipboardItem is a file.
- * @param item - The ClipboardItem to check.
- * @internal
- */
-const isFile = (item: ClipboardItem) => {
-	return item.types.find((i) => i.match(/^image\//))
-}
-
 /**
  * Handle text pasted into the editor.
  * @param editor - The editor instance.
@@ -237,11 +241,16 @@ const handlePasteFromClipboardApi = async (
 	const things: ClipboardThing[] = []
 
 	for (const item of clipboardItems) {
-		if (isFile(item)) {
-			for (const type of item.types) {
-				if (type.match(/^image\//)) {
-					things.push({ type: 'blob', source: item.getType(type) })
-				}
+		for (const type of expectedPasteFileMimeTypes) {
+			if (item.types.includes(type)) {
+				const blobPromise = item
+					.getType(type)
+					.then((blob) => FileHelpers.rewriteMimeType(blob, getCanonicalClipboardReadType(type)))
+				things.push({
+					type: 'blob',
+					source: blobPromise,
+				})
+				break
 			}
 		}
 
@@ -294,11 +303,8 @@ async function handleClipboardThings(editor: Editor, things: ClipboardThing[], p
 		if (files.length > editor.options.maxFilesAtOnce) {
 			throw Error('Too many files')
 		}
-		const fileBlobs = await Promise.all(files.map((t) => t.source!))
-		const urls = (fileBlobs.filter(Boolean) as (File | Blob)[]).map((blob) =>
-			URL.createObjectURL(blob)
-		)
-		return await pasteFiles(editor, urls, point)
+		const fileBlobs = compact(await Promise.all(files.map((t) => t.source)))
+		return await pasteFiles(editor, fileBlobs, point)
 	}
 
 	// 2. Generate clipboard results for non-file things
@@ -669,16 +675,27 @@ export function useNativeClipboardEvents() {
 			if (editor.user.getIsPasteAtCursorMode()) pasteAtCursor = !pasteAtCursor
 			if (pasteAtCursor) point = editor.inputs.currentPagePoint
 
-			// First try to use the clipboard data on the event
-			if (e.clipboardData && !editor.inputs.shiftKey) {
-				handlePasteFromEventClipboardData(editor, e.clipboardData, point)
-			} else {
-				// Or else use the clipboard API
-				navigator.clipboard.read().then((clipboardItems) => {
-					if (Array.isArray(clipboardItems) && clipboardItems[0] instanceof ClipboardItem) {
-						handlePasteFromClipboardApi(editor, clipboardItems, point)
+			const pasteFromEvent = () => {
+				if (e.clipboardData) {
+					handlePasteFromEventClipboardData(editor, e.clipboardData, point)
+				}
+			}
+
+			// First try to use the clipboard API:
+			if (navigator.clipboard?.read) {
+				navigator.clipboard.read().then(
+					(clipboardItems) => {
+						if (Array.isArray(clipboardItems) && clipboardItems[0] instanceof ClipboardItem) {
+							handlePasteFromClipboardApi(editor, clipboardItems, point)
+						}
+					},
+					() => {
+						// if reading from the clipboard fails, try to use the event clipboard data
+						pasteFromEvent()
 					}
-				})
+				)
+			} else {
+				pasteFromEvent()
 			}
 
 			preventDefault(e)

commit f9d4bdbb2f2d2b1e52bf9c03bd03106f82819421
Author: Mime ƒåuvalo <mimecuvalo@gmail.com>
Date:   Tue Jan 7 10:35:35 2025 +0000

    embeds: fix Gist; fix Val Town; add support for <iframe> (#5143)
    
    Initial report was a problem with Github Gist's not working on dotcom
    but then as long as I was here I noticed we had some other embed issues.
    
    Fixes:
    - [x] Gists not working on dotcom
    - [ ] Val Town being flaky to load (prbly we should report to them
    separately)
    - [x] Adds support for pasting in YouTube/Google Maps embeds
    
    ### Change type
    
    - [x] `bugfix`
    - [x] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Release notes
    
    - Fixes bugs with Github Gist and Val Town; adds support for pasting
    `<iframe src="...">` embeds

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index a67e715ee..e63bc2b42 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -461,6 +461,27 @@ async function handleClipboardThings(editor: Editor, things: ClipboardThing[], p
 				return
 			}
 		}
+
+		// Allow you to paste YouTube or Google Maps embeds, for example.
+		if (result.type === 'text' && result.subtype === 'text' && result.data.startsWith('<iframe ')) {
+			// try to find an iframe
+			const rootNode = new DOMParser().parseFromString(result.data, 'text/html')
+			const bodyNode = rootNode.querySelector('body')
+
+			const isSingleIframe =
+				bodyNode &&
+				Array.from(bodyNode.children).filter((el) => el.nodeType === 1).length === 1 &&
+				bodyNode.firstElementChild &&
+				bodyNode.firstElementChild.tagName === 'IFRAME' &&
+				bodyNode.firstElementChild.hasAttribute('src') &&
+				bodyNode.firstElementChild.getAttribute('src') !== ''
+
+			if (isSingleIframe) {
+				const src = bodyNode.firstElementChild.getAttribute('src')!
+				handleText(editor, src, point, results)
+				return
+			}
+		}
 	}
 
 	// Try to paste a link

commit 30b73331b9760763e3ea05f2ff541f46e756fa19
Author: alex <alex@dytry.ch>
Date:   Thu Jan 16 10:51:37 2025 +0000

    fix clipboard file upload (#5223)
    
    In #4771, we tweaked how we read from the clipboard on native paste
    events. When we've written to the clipboard, the clipboard API lets us
    read that data back more accurately. When copying from the users local
    filesystem though, files currently aren't exposed through the clipboard
    API. This tweaks our paste code to still go first to the clipboard API,
    but if it doesn't find anything very interesting there, it falls back to
    the event files instead.
    
    Unfortunately, this is an inconsistency between pasting with the
    keyboard, and pasting with the UI. We cannot currently access these
    files at all through the UI, as that must use the clipboard api.
    
    ### Change type
    
    - [x] `bugfix`
    
    ### Release notes
    
    - Fix pasting files copied from the local filesystem with cmd-v

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index e63bc2b42..92104c2c3 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -228,11 +228,17 @@ const handlePasteFromEventClipboardData = async (
  * @param point - The point to paste at
  * @internal
  */
-const handlePasteFromClipboardApi = async (
-	editor: Editor,
-	clipboardItems: ClipboardItem[],
+const handlePasteFromClipboardApi = async ({
+	editor,
+	clipboardItems,
+	point,
+	fallbackFiles,
+}: {
+	editor: Editor
+	clipboardItems: ClipboardItem[]
 	point?: VecLike
-) => {
+	fallbackFiles?: File[]
+}) => {
 	// We need to populate the array of clipboard things
 	// based on the ClipboardItems from the Clipboard API.
 	// This is done in a different way than when using
@@ -285,6 +291,13 @@ const handlePasteFromClipboardApi = async (
 		}
 	}
 
+	if (fallbackFiles && things.length === 1 && things[0].type === 'text') {
+		things.pop()
+		things.push(
+			...fallbackFiles.map((f): ClipboardThing => ({ type: 'file', source: Promise.resolve(f) }))
+		)
+	}
+
 	return await handleClipboardThings(editor, things, point)
 }
 
@@ -603,7 +616,7 @@ export function useMenuClipboardEvents() {
 			if (editor.getEditingShapeId() !== null) return
 
 			if (Array.isArray(data) && data[0] instanceof ClipboardItem) {
-				handlePasteFromClipboardApi(editor, data, point)
+				handlePasteFromClipboardApi({ editor, clipboardItems: data, point })
 				trackEvent('paste', { source: 'menu' })
 			} else {
 				// Read it first and then recurse, kind of weird
@@ -702,12 +715,18 @@ export function useNativeClipboardEvents() {
 				}
 			}
 
-			// First try to use the clipboard API:
+			// if we can read from the clipboard API, we want to try using that first. that allows
+			// us to access most things, and doesn't strip out metadata added to tldraw's own
+			// copy-as-png features - so copied shapes come back in at the correct size.
 			if (navigator.clipboard?.read) {
+				// We can't read files from the filesystem using the clipboard API though - they'll
+				// just come in as the file names instead. So we'll use the clipboard event's files
+				// as a fallback - if we only got text, but do have files, we use those instead.
+				const fallbackFiles = Array.from(e.clipboardData?.files || [])
 				navigator.clipboard.read().then(
 					(clipboardItems) => {
 						if (Array.isArray(clipboardItems) && clipboardItems[0] instanceof ClipboardItem) {
-							handlePasteFromClipboardApi(editor, clipboardItems, point)
+							handlePasteFromClipboardApi({ editor, clipboardItems, point, fallbackFiles })
 						}
 					},
 					() => {

commit d6f0bebabc88f078e6e712a601b42d390c5c5e23
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Tue Jan 28 16:37:38 2025 +0000

    fix pasting text/plain with keyboard shortcut (#5303)
    
    Seems like this was broken a couple of weeks ago.
    
    ### Change type
    
    - [x] `bugfix`
    
    ### Release notes
    
    - Fixed a bug with handling native paste events for plain text

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index 92104c2c3..8af9ae54c 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -291,7 +291,7 @@ const handlePasteFromClipboardApi = async ({
 		}
 	}
 
-	if (fallbackFiles && things.length === 1 && things[0].type === 'text') {
+	if (fallbackFiles?.length && things.length === 1 && things[0].type === 'text') {
 		things.pop()
 		things.push(
 			...fallbackFiles.map((f): ClipboardThing => ({ type: 'file', source: Promise.resolve(f) }))

commit d14754ca7629205953c00615b2524286a2ec5353
Author: alex <alex@dytry.ch>
Date:   Wed Feb 12 13:53:55 2025 +0000

    Add tldraw and excalidraw to external content types (#5402)
    
    Almost all paste operations currently turn into calls to
    `putExternalContent`, which means they can be customized using
    `registerExternalContentHandler`. tldraw and excalidraw content are
    different: they're handled directly in the clipboard code, and so can't
    be customized.
    
    This diff changes that: these types now have external content handlers,
    and default implementations for how they work. We also add an example
    demonstrating how you can use this API to override pasting of e.g.
    single frame shapes to match how figma handles these (finding a space
    for them instead of pasting them in place).
    
    ### Change type
    
    - [x] `api`
    
    ### Release notes
    
    - You can now customize how pasted tldraw and excalidraw content is
    handled with `registerExternalContentHandler`.

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index 8af9ae54c..dcb1c67db 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -16,9 +16,7 @@ import lz from 'lz-string'
 import { useCallback, useEffect } from 'react'
 import { TLDRAW_CUSTOM_PNG_MIME_TYPE, getCanonicalClipboardReadType } from '../../utils/clipboard'
 import { TLUiEventSource, useUiEvents } from '../context/events'
-import { pasteExcalidrawContent } from './clipboard/pasteExcalidrawContent'
 import { pasteFiles } from './clipboard/pasteFiles'
-import { pasteTldrawContent } from './clipboard/pasteTldrawContent'
 import { pasteUrl } from './clipboard/pasteUrl'
 
 // Expected paste mime types. The earlier in this array they appear, the higher preference we give
@@ -431,7 +429,8 @@ async function handleClipboardThings(editor: Editor, things: ClipboardThing[], p
 	// Try to paste tldraw content
 	for (const result of results) {
 		if (result.type === 'tldraw') {
-			pasteTldrawContent(editor, result.data, point)
+			editor.markHistoryStoppingPoint('paste')
+			editor.putExternalContent({ type: 'tldraw', content: result.data, point })
 			return
 		}
 	}
@@ -439,7 +438,8 @@ async function handleClipboardThings(editor: Editor, things: ClipboardThing[], p
 	// Try to paste excalidraw content
 	for (const result of results) {
 		if (result.type === 'excalidraw') {
-			pasteExcalidrawContent(editor, result.data, point)
+			editor.markHistoryStoppingPoint('paste')
+			editor.putExternalContent({ type: 'excalidraw', content: result.data, point })
 			return
 		}
 	}

commit 3bf31007c5a7274f3f7926a84c96c89a4cc2c278
Author: Mime ƒåuvalo <mimecuvalo@gmail.com>
Date:   Mon Mar 3 14:23:09 2025 +0000

    [feature] add rich text and contextual toolbar (#4895)
    
    We're looking to add rich text to the editor!
    
    We originally started with ProseMirror but it became quickly clear that
    since it's more down-to-the-metal we'd have to rebuild a bunch of
    functionality, effectively managing a rich text editor in addition to a
    2D canvas. Examples of this include behaviors around lists where people
    expect certain behaviors around combination of lists next to each other,
    tabbing, etc.
    On top of those product expectations, we'd need to provide a
    higher-level API that provided better DX around things like
    transactions, switching between lists‚Üîheaders, and more.
    
    Given those considerations, a very natural fit was to use TipTap. Much
    like tldraw, they provide a great experience around manipulating a rich
    text editor. And, we want to pass on those product/DX benefits
    downstream to our SDK users.
    
    Some high-level notes:
    - the data is stored as the TipTap stringified JSON, it's lightly
    validated at the moment, but not stringently.
    - there was originally going to be a short-circuit path for plaintext
    but it ended up being error-prone with richtext/plaintext living
    side-by-side. (this meant there were two separate fields)
    - We could still add a way to render faster ‚Äî I just want to avoid it
    being two separate fields, too many footguns.
    - things like arrow labels are only plain text (debatable though).
    
    Other related efforts:
    - https://github.com/tldraw/tldraw/pull/3051
    - https://github.com/tldraw/tldraw/pull/2825
    
    Todo
    - [ ] figure out whether we should have a migration or not. This is what
    we discussed cc @ds300 and @SomeHats - and whether older clients would
    start messing up newer clients. The data becomes lossy if older clients
    overwrite with plaintext.
    
    <img width="427" alt="Screenshot 2024-12-09 at 14 43 51"
    src="https://github.com/user-attachments/assets/f9dddaee-bfd3-4746-8016-d4247e417e80">
    <img width="378" alt="Screenshot 2024-12-09 at 14 42 59"
    src="https://github.com/user-attachments/assets/95e016d3-ab4d-4d34-afd3-b3ef511d2d77">
    
    Current discussion list:
    - [x] positioning: discuss toolbar position (selection bounds vs cursor
    bounds, toolbar is going in center weirdly sometimes)
    - [x] artificial delay: latest updates make it feel slow/unresponsive?
    e.g. list toggle, changing selection
    - [x] keyboard selection: discuss toolbar logic around "mousing around"
    vs. being present when keyboard selecting (which is annoying)
    - [x] mobile: discuss concerns around mobile toolbar
    - [x] mobile, precision tap: discuss / rm tap into text (and sticky
    notes?) - disable precision editing on mobile
    - [x] discuss
    useContextualToolbar/useContextualToolbarPosition/ContextualToolbar/TldrawUiContextualToolbar
    example
    - [x] existing code: middle alignment for pasted text - keep?
    - [x] existing code: should text replace the shape content when pasted?
    keep?
    - [x] discuss animation, we had it, nixed it, it's back again; why the
    0.08s animation? imperceptible?
    - [x] hide during camera move?
    - [x] short form content - hard to make a different selection b/c
    toolbar is in the way of content
    - [x] check 'overflow: hidden' on tl-text-input (update: this is needed
    to avoid scrollbars)
    - [x] decide on toolbar set: italic, underline, strikethrough, highlight
    - [x] labelColor w/ highlighted text - steve has a commit here to tweak
    highlighting
    
    todos:
    - [x] font rebuild (bold, randomization tweaks) - david looking into
    this
    
    check bugs raised:
    - [x] can't do selection on list item
    - [x] mobile: b/c of the blur/Done logic, doesn't work if you dbl-click
    on geo shape (it's a plaintext problem too)
    - [x] mobile: No cursor when using the text tool - specifically for the
    Text tool ‚Äî can't repro?
    - [x] VSCode html pasting, whitespace issue?
    - [x] Link toolbar make it extend to the widest size of the current tool
    set
    - [x] code has mutual exclusivity (this is a design choice by the Code
    plugin - we could fork)
    - [x] Text is copied to the clipboard with paragraphs rather than line
    breaks.
    - [x] multi-line plaintext for arrows busted
    
    nixed/outdated
    - [ ] ~link: on mobile should be in modal?~
    - [ ] ~link: back button?~
    - [ ] ~list button toggling? (can't repro)~
    - [ ] ~double/triple-clicking is now wonky with the new logic~
    - [ ] ~move blur() code into useEditableRichText - for Done on iOS~
    - [ ] ~toolbar when shape is rotated~
    - [ ] ~"The "isMousingDown" logic doesn't work, the events aren't
    reaching the window. Not sure how we get those from the editor element."
    (can't repro?)~
    - [ ] ~toolbar position bug when toggling code on and off (can't
    repro?)~
    - [ ] ~some issue around "Something's up with the initial size
    calculated from the text selection bounds."~
    - [ ] ~mobile: Context bar still visible out if user presses "Done" to
    end editing~
    - [ ] ~mobile: toolbar when switching between text fields~
    
    
    ### Change type
    
    - [ ] `bugfix`
    - [ ] `improvement`
    - [x] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Test plan
    
    1. TODO: write a bunch more tests
    
    - [x] Unit tests
    - [x] End to end tests
    
    ### Release notes
    
    - Rich text using ProseMirror as a first-class supported option in the
    Editor.
    
    ---------
    
    Co-authored-by: huppy-bot[bot] <128400622+huppy-bot[bot]@users.noreply.github.com>
    Co-authored-by: alex <alex@dytry.ch>
    Co-authored-by: David Sheldrick <d.j.sheldrick@gmail.com>
    Co-authored-by: Steve Ruiz <steveruizok@gmail.com>

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index dcb1c67db..bd9ea3ef2 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -86,7 +86,7 @@ function areShortcutsDisabled(editor: Editor) {
 	return (
 		editor.menus.hasAnyOpenMenus() ||
 		(activeElement &&
-			(activeElement.getAttribute('contenteditable') ||
+			((activeElement as HTMLElement).isContentEditable ||
 				INPUTS.indexOf(activeElement.tagName.toLowerCase()) > -1))
 	)
 }
@@ -473,6 +473,19 @@ async function handleClipboardThings(editor: Editor, things: ClipboardThing[], p
 				handleText(editor, stripHtml(result.data), point, results)
 				return
 			}
+
+			// If the html is NOT a link, and we have other texty content, then paste the html as a text shape
+			if (results.some((r) => r.type === 'text' && r.subtype !== 'html')) {
+				editor.markHistoryStoppingPoint('paste')
+				editor.putExternalContent({
+					type: 'text',
+					text: stripHtml(result.data),
+					html: result.data,
+					point,
+					sources: results,
+				})
+				return
+			}
 		}
 
 		// Allow you to paste YouTube or Google Maps embeds, for example.

commit 40e471348e384724724ec48681429ca358aa85a3
Author: Josh Willis <blue74dot@gmail.com>
Date:   Tue Mar 4 02:38:35 2025 -0800

    fix pasting files in safari (#5545)
    
    This PR fixes a small bug with pasting files from your computer into
    Safari.
    It only addresses pasting with Cmd+V, I don't know if there is any hope
    for the Menu paste in Safari.
    
    It uses the existing "fallbackFiles" which appear to be designed to
    handle this but were only handling text files?
    
    ### Change type
    
    - [x] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Test plan
    
    1. On `main` copy a supported file from your local computer, such as a
    PNG.
    2. In the editor, in Safari, press Cmd/Ctrl + V.
    3. Note that nothing happens.
    4. Repeat the process on this branch and the file[s] should be loaded
    into the editor as expected.
    
    ### Release notes
    
    - Fixed a bug with pasting files from your computer in Safari

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index bd9ea3ef2..b64241a3b 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -294,6 +294,13 @@ const handlePasteFromClipboardApi = async ({
 		things.push(
 			...fallbackFiles.map((f): ClipboardThing => ({ type: 'file', source: Promise.resolve(f) }))
 		)
+	} else if (fallbackFiles?.length && things.length === 0) {
+		// Files pasted in Safari from your computer don't have types, so we need to use the fallback files directly
+		// if they're available. This only works if pasted keyboard shortcuts. Pasting from the menu in Safari seems to never
+		// let you access files that are copied from your computer.
+		things.push(
+			...fallbackFiles.map((f): ClipboardThing => ({ type: 'file', source: Promise.resolve(f) }))
+		)
 	}
 
 	return await handleClipboardThings(editor, things, point)

commit ce8939545e8be75d36c161e923780c20fcea89bb
Author: David Sheldrick <d.j.sheldrick@gmail.com>
Date:   Wed Mar 5 18:45:33 2025 +0000

    [important dotcom perf fix] use useMaybeEditor in ui context (#5560)
    
    So we were facing a weird problem in dotcom where the editor would
    remount immediately after mounting for the first time, causing the room
    data to be fetched twice (once before initial editor mount, and once
    again on remount).
    
    We tracked it down to this [UI context
    provider](https://github.com/tldraw/tldraw/blob/c661dfedf191a5d9b9fd168a881a99ab7e719f6b/packages/tldraw/src/lib/ui/context/TldrawUiContextProvider.tsx#L79-L86),
    and specifically the fact that reparenting this react-subtree inside a
    new context provider after the editor becomes available causes the whole
    thing to be remounted and the editor reinstantiates.
    
    A quick and dirty way to fix this is to make the provider tree static
    and make sure that all components within it use `useMaybeEditor` so the
    app doesn't crash if there isn't an editor available.
    
    The slow and clean way around this is to refactor to not have this
    UIContextProvider be so coupled to the Editor, but this is a bad perf
    issue that needs fixing asap, it's very noticeable for larger files.
    
    
    ### Change type
    
    - [x] `bugfix`

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index b64241a3b..21b145f88 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -4,12 +4,14 @@ import {
 	TLExternalContentSource,
 	Vec,
 	VecLike,
+	assert,
 	compact,
 	isDefined,
 	preventDefault,
 	stopEventPropagation,
 	uniq,
 	useEditor,
+	useMaybeEditor,
 	useValue,
 } from '@tldraw/editor'
 import lz from 'lz-string'
@@ -600,11 +602,12 @@ const handleNativeOrMenuCopy = async (editor: Editor) => {
 
 /** @public */
 export function useMenuClipboardEvents() {
-	const editor = useEditor()
+	const editor = useMaybeEditor()
 	const trackEvent = useUiEvents()
 
 	const copy = useCallback(
 		async function onCopy(source: TLUiEventSource) {
+			assert(editor, 'editor is required for copy')
 			if (editor.getSelectedShapeIds().length === 0) return
 
 			await handleNativeOrMenuCopy(editor)
@@ -615,6 +618,7 @@ export function useMenuClipboardEvents() {
 
 	const cut = useCallback(
 		async function onCut(source: TLUiEventSource) {
+			if (!editor) return
 			if (editor.getSelectedShapeIds().length === 0) return
 
 			await handleNativeOrMenuCopy(editor)
@@ -630,6 +634,7 @@ export function useMenuClipboardEvents() {
 			source: TLUiEventSource,
 			point?: VecLike
 		) {
+			if (!editor) return
 			// If we're editing a shape, or we are focusing an editable input, then
 			// we would want the user's paste interaction to go to that element or
 			// input instead; e.g. when pasting text into a text shape's content

commit f3ad945f4591e0a1e6bb946460dc99c10b9dfd20
Author: Mime ƒåuvalo <mimecuvalo@gmail.com>
Date:   Tue Apr 1 16:18:18 2025 +0100

    fix error pasting shapes from Miro (#5790)
    
    minor thing but b/c Miro is just an HTML string, we go down a path where
    we try to insert an empty string b/c all the HTML is stripped
    
    ![Screenshot 2025-04-01 at 16 08
    58](https://github.com/user-attachments/assets/11d16632-6255-47d1-b3e8-8f8245a8d2dd)
    
    ### Change type
    
    - [x] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Release notes
    
    - Fix blowing up when pasting Miro shapes into tldraw.

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index 21b145f88..100b96add 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -479,7 +479,10 @@ async function handleClipboardThings(editor: Editor, things: ClipboardThing[], p
 
 			// If the html is NOT a link, and we have NO OTHER texty content, then paste the html as text
 			if (!results.some((r) => r.type === 'text' && r.subtype !== 'html') && result.data.trim()) {
-				handleText(editor, stripHtml(result.data), point, results)
+				const html = stripHtml(result.data) ?? ''
+				if (html) {
+					handleText(editor, stripHtml(result.data), point, results)
+				}
 				return
 			}
 

commit fff04afa92e29fa8bca1a89a197882f7ea741699
Author: Mime ƒåuvalo <mimecuvalo@gmail.com>
Date:   Mon Apr 14 16:16:12 2025 +0100

    fix error pasting shapes from Miro, pt 2 (#5896)
    
    followup to https://github.com/tldraw/tldraw/pull/5790
    
    cc @ds300  thanks for the heads up
    
    ### Change type
    
    - [x] `bugfix`
    - [ ] `improvement`
    - [ ] `feature`
    - [ ] `api`
    - [ ] `other`
    
    ### Release notes
    
    - Fix blowing up when pasting Miro shapes into tldraw.

diff --git a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
index 100b96add..faf62f538 100644
--- a/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
+++ b/packages/tldraw/src/lib/ui/hooks/useClipboardEvents.ts
@@ -482,21 +482,24 @@ async function handleClipboardThings(editor: Editor, things: ClipboardThing[], p
 				const html = stripHtml(result.data) ?? ''
 				if (html) {
 					handleText(editor, stripHtml(result.data), point, results)
+					return
 				}
-				return
 			}
 
 			// If the html is NOT a link, and we have other texty content, then paste the html as a text shape
 			if (results.some((r) => r.type === 'text' && r.subtype !== 'html')) {
-				editor.markHistoryStoppingPoint('paste')
-				editor.putExternalContent({
-					type: 'text',
-					text: stripHtml(result.data),
-					html: result.data,
-					point,
-					sources: results,
-				})
-				return
+				const html = stripHtml(result.data) ?? ''
+				if (html) {
+					editor.markHistoryStoppingPoint('paste')
+					editor.putExternalContent({
+						type: 'text',
+						text: html,
+						html: result.data,
+						point,
+						sources: results,
+					})
+					return
+				}
 			}
 		}
 

