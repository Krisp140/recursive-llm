
index 039baf10b..d3061559b 100644
--- a/tldraw_apps_dotcom_sync-worker_src_TLPostgresReplicator.ts_expectedoutput.txt (expected):tmp/tmp30hgopzs_expected.txt	
+++ b/tldraw_apps_dotcom_sync-worker_src_TLPostgresReplicator.ts_extracted.txt (actual):tmp/tmpx9mixxb__actual.txt	
@@ -361,23 +361,6 @@ export class TLPostgresReplicator extends DurableObject<Environment> {
 		}
 	}
 
-	async getDiagnostics() {
-		const earliestHistoryRow = this.sqlite
-			.exec('select * from history order by rowid asc limit 1')
-			.toArray()[0]
-		const latestHistoryRow = this.sqlite
-			.exec('select * from history order by rowid desc limit 1')
-			.toArray()[0]
-		const activeUsers = this.sqlite.exec('select count(*) from active_user').one().count as number
-		const meta = this.sqlite.exec('select * from meta').one()
-		return {
-			earliestHistoryRow,
-			latestHistoryRow,
-			activeUsers,
-			meta,
-		}
-	}
-
 	private queue = new ExecutionQueue()
 
 	private async reboot(source: TLPostgresReplicatorRebootSource, delay = true) {
@@ -527,72 +510,20 @@ export class TLPostgresReplicator extends DurableObject<Environment> {
 		}
 	}
 
-	private parseChange(change: Wal2Json.Change): Change | null {
-		const table = change.table as ReplicationEvent['table']
-		if (change.kind === 'truncate' || change.kind === 'message' || !(table in relevantTables)) {
-			return null
-		}
-
-		const row = {} as any
-		const previous = {} as any
-		// take everything from change.columnnames and associated the values from change.columnvalues
-		if (change.kind === 'delete') {
-			const oldkeys = change.oldkeys
-			assert(oldkeys, 'oldkeys is required for delete events')
-			assert(oldkeys.keyvalues, 'oldkeys is required for delete events')
-			oldkeys.keynames.forEach((key, i) => {
-				row[key] = oldkeys.keyvalues[i]
-			})
-		} else if (change.kind === 'update') {
-			const oldkeys = change.oldkeys
-			assert(oldkeys, 'oldkeys is required for delete events')
-			assert(oldkeys.keyvalues, 'oldkeys is required for delete events')
-			oldkeys.keynames.forEach((key, i) => {
-				previous[key] = oldkeys.keyvalues[i]
-			})
-			change.columnnames.forEach((col, i) => {
-				row[col] = change.columnvalues[i]
-			})
-		} else {
-			change.columnnames.forEach((col, i) => {
-				row[col] = change.columnvalues[i]
-			})
-		}
-
-		let userId = null as string | null
-		let fileId = null as string | null
-		switch (table) {
-			case 'user':
-				userId = (row as TlaUser).id
-				break
-			case 'file':
-				userId = (row as TlaFile).ownerId
-				fileId = (row as TlaFile).id
-				break
-			case 'file_state':
-				userId = (row as TlaFileState).userId
-				fileId = (row as TlaFileState).fileId
-				break
-			case 'user_mutation_number':
-				userId = (row as { userId: string }).userId
-				break
-			default: {
-				// assert never
-				const _x: never = table
-			}
-		}
-
-		if (!userId) return null
-
+	async getDiagnostics() {
+		const earliestHistoryRow = this.sqlite
+			.exec('select * from history order by rowid asc limit 1')
+			.toArray()[0]
+		const latestHistoryRow = this.sqlite
+			.exec('select * from history order by rowid desc limit 1')
+			.toArray()[0]
+		const activeUsers = this.sqlite.exec('select count(*) from active_user').one().count as number
+		const meta = this.sqlite.exec('select * from meta').one()
 		return {
-			row,
-			previous,
-			event: {
-				command: change.kind,
-				table,
-			},
-			userId,
-			fileId,
+			earliestHistoryRow,
+			latestHistoryRow,
+			activeUsers,
+			meta,
 		}
 	}
 
@@ -629,7 +560,11 @@ export class TLPostgresReplicator extends DurableObject<Environment> {
 		try {
 			switch (table) {
 				case 'user_mutation_number':
-					this.handleMutationConfirmationEvent(collator, change.row, { command, table })
+					this.handleMutationConfirmationEvent(
+						collator,
+						change.row,
+						{ command, table }
+					)
 					break
 				case 'file_state':
 					this.handleFileStateEvent(collator, change.row, { command, table })
@@ -805,15 +740,6 @@ export class TLPostgresReplicator extends DurableObject<Environment> {
 		}
 	}
 
-	reportActiveUsers() {
-		try {
-			const { count } = this.sqlite.exec('SELECT COUNT(*) as count FROM active_user').one()
-			this.logEvent({ type: 'active_users', count: count as number })
-		} catch (e) {
-			console.error('Error in reportActiveUsers', e)
-		}
-	}
-
 	private getResumeType(
 		lsn: string,
 		userId: string,
@@ -942,6 +868,84 @@ export class TLPostgresReplicator extends DurableObject<Environment> {
 		}
 	}
 
+	reportActiveUsers() {
+		try {
+			const { count } = this.sqlite.exec('SELECT COUNT(*) as count FROM active_user').one()
+			this.logEvent({ type: 'active_users', count: count as number })
+		} catch (e) {
+			console.error('Error in reportActiveUsers', e)
+		}
+	}
+
+	private parseChange(change: Wal2Json.Change): Change | null {
+		const table = change.table as ReplicationEvent['table']
+		if (change.kind === 'truncate' || change.kind === 'message' || !(table in relevantTables)) {
+			return null
+		}
+
+		const row = {} as any
+		const previous = {} as any
+		// take everything from change.columnnames and associated the values from change.columnvalues
+		if (change.kind === 'delete') {
+			const oldkeys = change.oldkeys
+			assert(oldkeys, 'oldkeys is required for delete events')
+			assert(oldkeys.keyvalues, 'oldkeys is required for delete events')
+			oldkeys.keynames.forEach((key, i) => {
+				row[key] = oldkeys.keyvalues[i]
+			})
+		} else if (change.kind === 'update') {
+			const oldkeys = change.oldkeys
+			assert(oldkeys, 'oldkeys is required for delete events')
+			assert(oldkeys.keyvalues, 'oldkeys is required for delete events')
+			oldkeys.keynames.forEach((key, i) => {
+				previous[key] = oldkeys.keyvalues[i]
+			})
+			change.columnnames.forEach((col, i) => {
+				row[col] = change.columnvalues[i]
+			})
+		} else {
+			change.columnnames.forEach((col, i) => {
+				row[col] = change.columnvalues[i]
+			})
+		}
+
+		let userId = null as string | null
+		let fileId = null as string | null
+		switch (table) {
+			case 'user':
+				userId = (row as TlaUser).id
+				break
+			case 'file':
+				userId = (row as TlaFile).ownerId
+				fileId = (row as TlaFile).id
+				break
+			case 'file_state':
+				userId = (row as TlaFileState).userId
+				fileId = (row as TlaFileState).fileId
+				break
+			case 'user_mutation_number':
+				userId = (row as { userId: string }).userId
+				break
+			default: {
+				// assert never
+				const _x: never = table
+			}
+		}
+
+		if (!userId) return null
+
+		return {
+			row,
+			previous,
+			event: {
+				command: change.kind,
+				table,
+			},
+			userId,
+			fileId,
+		}
+	}
+
 	private async requestLsnUpdate(userId: string) {
 		try {
 			this.log.debug('requestLsnUpdate', userId)
