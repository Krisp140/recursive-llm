# -o nospace requires we add back a space when a completion is finished
# and not part of a --key= completion
addSpaces() {
  for idx in "${!COMPREPLY[@]}"; do
    [ -n "${COMPREPLY[idx]}" ] && COMPREPLY[idx]="${COMPREPLY[idx]} ";
  done
}

_fonts() {
  local IFS=$'\n'
  mapfile -t COMPREPLY < <( compgen -P '"' -S '"' -W "$($ghostty +list-fonts | grep '^[A-Z]' )" -- "$cur")
}

_themes() {
  local IFS=$'\n'
  mapfile -t COMPREPLY < <( compgen -P '"' -S '"' -W "$($ghostty +list-themes | sed -E 's/^(.*) \(.*$/\1/')" -- "$cur")
}

_files() {
  mapfile -t COMPREPLY < <( compgen -o filenames -f -- "$cur" )
  for i in "${!COMPREPLY[@]}"; do
    if [[ -d "${COMPREPLY[i]}" ]]; then
      COMPREPLY[i]="${COMPREPLY[i]}/";
    fi
    if [[ -f "${COMPREPLY[i]}" ]]; then
      COMPREPLY[i]="${COMPREPLY[i]} ";
    fi
  done
}

_dirs() {
  mapfile -t COMPREPLY < <( compgen -o dirnames -d -- "$cur" )
  for i in "${!COMPREPLY[@]}"; do
    if [[ -d "${COMPREPLY[i]}" ]]; then
      COMPREPLY[i]="${COMPREPLY[i]}/";
    fi
  done
  if [[ "${#COMPREPLY[@]}" == 0 && -d "$cur" ]]; then
    COMPREPLY=( "$cur " )
  fi
}

_ghostty() {

  # -o nospace requires we add back a space when a completion is finished
  # and not part of a --key= completion
  _add_spaces() {
    for idx in "${!COMPREPLY[@]}"; do
      [ -n "${COMPREPLY[idx]}" ] && COMPREPLY[idx]="${COMPREPLY[idx]} ";
    done
  }

  _fonts() {
    local IFS=$'\n'
    mapfile -t COMPREPLY < <( compgen -P '"' -S '"' -W "$($ghostty +list-fonts | grep '^[A-Z]' )" -- "$cur")
  }

  _themes() {
    local IFS=$'\n'
    mapfile -t COMPREPLY < <( compgen -P '"' -S '"' -W "$($ghostty +list-themes | sed -E 's/^(.*) \(.*$/\1/')" -- "$cur")
  }

  _files() {
    mapfile -t COMPREPLY < <( compgen -o filenames -f -- "$cur" )
    for i in "${!COMPREPLY[@]}"; do
      if [[ -d "${COMPREPLY[i]}" ]]; then
        COMPREPLY[i]="${COMPREPLY[i]}/";
      fi
      if [[ -f "${COMPREPLY[i]}" ]]; then
        COMPREPLY[i]="${COMPREPLY[i]} ";
      fi
    done
  }

  _dirs() {
    mapfile -t COMPREPLY < <( compgen -o dirnames -d -- "$cur" )
    for i in "${!COMPREPLY[@]}"; do
      if [[ -d "${COMPREPLY[i]}" ]]; then
        COMPREPLY[i]="${COMPREPLY[i]}/";
      fi
    done
    if [[ "${#COMPREPLY[@]}" == 0 && -d "$cur" ]]; then
      COMPREPLY=( "$cur " )
    fi
  }

  _handle_config() {
    local config="--help"
    config+=" --version"
    config+=" '--background-opacity '"
    config+=" --background-opacity="
    config+=" '--clipboard-read '"
    config+=" '--clipboard-write '"
    config+=" '--confirm-close-surface '"
    config+=" '--confirm-close-surface-threshold '"
    config+=" '--confirm-close-surface-threshold="
    config+=" '--cursor-blink-interval-ms '"
    config+=" --cursor-blink-interval-ms="
    config+=" '--cursor-click-distance-px '"
    config+=" --cursor-click-distance-px="
    config+=" '--cursor-hold-select '"
    config+=" '--cursor-shape '"
    config+=" --cursor-shape="
    config+=" '--cursor-style '"
    config+=" --cursor-style="
    config+=" '--debug-logging '"
    config+=" '--default-cwd '"
    config+=" --default-cwd="
    config+=" '--default-program '"
    config+=" --default-program="
    config+=" '--enable-audio-bell '"
    config+=" '--font-family '"
    config+=" --font-family="
    config+=" '--font-features '"
    config+=" --font-features="
    config+=" '--font-size '"
    config+=" --font-size="
    config+=" '--framerate '"
    config+=" --framerate="
    config+=" '--gtk-theme-variant '"
    config+=" --gtk-theme-variant="
    config+=" '--hide-cursor-when-typing '"
    config+=" '--hold-after-exit '"
    config+=" '--ignore-ime-mod-state '"
    config+=" '--ime-preedit-offset '"
    config+=" --ime-preedit-offset="
    config+=" '--ime-style '"
    config+=" --ime-style="
    config+=" '--keyboard-layout '"
    config+=" --keyboard-layout="
    config+=" '--ligature-blacklist '"
    config+=" --ligature-blacklist="
    config+=" '--load-existing-config '"
    config+=" '--macos-colorspace '"
    config+=" --macos-colorspace="
    config+=" '--macos-disable-window-tabbing '"
    config+=" '--macos-move-to-active-space-when-opened '"
    config+=" '--macos-option-as-alt '"
    config+=" '--macos-quit-when-last-window-closed '"
    config+=" '--macos-titlebar-is-vibrant '"
    config+=" '--middle-click-action '"
    config+=" --middle-click-action="
    config+=" '--mouse-hide-while-typing '"
    config+=" '--native-macos-fullscreen '"
    config+=" '--native-wayland-fullscreen '"
    config+=" '--pad-horiz '"
    config+=" --pad-horiz="
    config+=" '--pad-vert '"
    config+=" --pad-vert="
    config+=" '--pixel-snap '"
    config+=" '--preserve-root-title '"
    config+=" '--print-style '"
    config+=" --print-style="
    config+=" '--resize-increments '"
    config+=" '--right-click-action '"
    config+=" --right-click-action="
    config+=" '--scroll-multiplier '"
    config+=" --scroll-multiplier="
    config+=" '--scrollback-lines '"
    config+=" --scrollback-lines="
    config+=" '--scrollback-live-feed '"
    config+=" '--selection-block-scrolling '"
    config+=" '--selection-scrolling '"
    config+=" '--selection-semantic-shift '"
    config+=" '--selection-word-select '"
    config+=" '--shell-integration '"
    config+=" '--shell-integration-features '"
    config+=" --shell-integration-features="
    config+=" '--style '"
    config+=" --style="
    config+=" '--sync-selections '"
    config+=" '--syslog-errors '"
    config+=" '--theme '"
    config+=" --theme="
    config+=" '--use-ime '"
    config+=" '--window-decoration '"
    config+=" --window-decoration="
    config+=" '--working-directory '"
    config+=" --working-directory="

    case "$prev" in
      --background-opacity) mapfile -t COMPREPLY < <( compgen -W "0 0.1 0.2 0.3 0.4 0.5 0.6 0.7 0.8 0.9 1" -- "$cur" ); _add_spaces ;;
      --clipboard-read) return ;;
      --clipboard-write) return ;;
      --confirm-close-surface) return ;;
      --confirm-close-surface-threshold) return ;;
      --cursor-blink-interval-ms) return ;;
      --cursor-click-distance-px) return ;;
      --cursor-hold-select) return ;;
      --cursor-shape) mapfile -t COMPREPLY < <( compgen -W "block beam underline" -- "$cur" ); _add_spaces ;;
      --cursor-style) mapfile -t COMPREPLY < <( compgen -W "blink steady" -- "$cur" ); _add_spaces ;;
      --debug-logging) return ;;
      --default-cwd) _dirs ;;
      --default-program) return ;;
      --enable-audio-bell) return ;;
      --font-family) _fonts ;;
      --font-features) return ;;
      --font-size) return ;;
      --framerate) return ;;
      --gtk-theme-variant) mapfile -t COMPREPLY < <( compgen -W "system light dark" -- "$cur" ); _add_spaces ;;
      --hide-cursor-when-typing) return ;;
      --hold-after-exit) return ;;
      --ignore-ime-mod-state) return ;;
      --ime-preedit-offset) return ;;
      --ime-style) mapfile -t COMPREPLY < <( compgen -W "native system" -- "$cur" ); _add_spaces ;;
      --keyboard-layout) return ;;
      --ligature-blacklist) return ;;
      --load-existing-config) return ;;
      --macos-colorspace) mapfile -t COMPREPLY < <( compgen -W "default srgb display-p3" -- "$cur" ); _add_spaces ;;
      --macos-disable-window-tabbing) return ;;
      --macos-move-to-active-space-when-opened) return ;;
      --macos-option-as-alt) mapfile -t COMPREPLY < <( compgen -W "left right both none" -- "$cur" ); _add_spaces ;;
      --macos-quit-when-last-window-closed) return ;;
      --macos-titlebar-is-vibrant) return ;;
      --middle-click-action) mapfile -t COMPREPLY < <( compgen -W "paste-selection open-link" -- "$cur" ); _add_spaces ;;
      --mouse-hide-while-typing) return ;;
      --native-macos-fullscreen) return ;;
      --native-wayland-fullscreen) return ;;
      --pad-horiz) return ;;
      --pad-vert) return ;;
      --pixel-snap) return ;;
      --preserve-root-title) return ;;
      --print-style) mapfile -t COMPREPLY < <( compgen -W "default unicode" -- "$cur" ); _add_spaces ;;
      --resize-increments) return ;;
      --right-click-action) mapfile -t COMPREPLY < <( compgen -W "paste clipboard-paste open-link" -- "$cur" ); _add_spaces ;;
      --scroll-multiplier) return ;;
      --scrollback-lines) return ;;
      --scrollback-live-feed) return ;;
      --selection-block-scrolling) return ;;
      --selection-scrolling) return ;;
      --selection-semantic-shift) return ;;
      --selection-word-select) return ;;
      --shell-integration) mapfile -t COMPREPLY < <( compgen -W "native none" -- "$cur" ); _add_spaces ;;
      --shell-integration-features) mapfile -t COMPREPLY < <( compgen -W "no-cursor no-title no-status-bar no-cwd" -- "$cur" ); _add_spaces ;;
      --style) _files ;;
      --sync-selections) return ;;
      --syslog-errors) return ;;
      --theme) _themes ;;
      --use-ime) return ;;
      --window-decoration) mapfile -t COMPREPLY < <( compgen -W "none title-bar macos-native" -- "$cur" ); _add_spaces ;;
      --working-directory) _dirs ;;
      *) mapfile -t COMPREPLY < <( compgen -W "$config" -- "$cur" ) ;;
    esac

    return 0
  }

  _handle_actions() {
    local config_set="--config-file= --help"
    local config_get="--config-file= --help"
    local window_new="--config-file= --help"
    local surface_new="--config-file= --help"
    local list_fonts="--help"
    local list_themes="--help"
    local debug_info="--help"
    local update_terminfo="--help"
    local update_shell_integration="--help"
    local update_manpages="--help"

    case "${COMP_WORDS[1]}" in
      +config-set)
        case $prev in
          --config-file) _files ;;
          *) mapfile -t COMPREPLY < <( compgen -W "$config_set" -- "$cur" ) ;;
        esac
      ;;
      +config-get)
        case $prev in
          --config-file) _files ;;
          *) mapfile -t COMPREPLY < <( compgen -W "$config_get" -- "$cur" ) ;;
        esac
      ;;
      +window-new)
        case $prev in
          --config-file) _files ;;
          *) mapfile -t COMPREPLY < <( compgen -W "$window_new" -- "$cur" ) ;;
        esac
      ;;
      +surface-new)
        case $prev in
          --config-file) _files ;;
          *) mapfile -t COMPREPLY < <( compgen -W "$surface_new" -- "$cur" ) ;;
        esac
      ;;
      +list-fonts)
        case $prev in
          *) mapfile -t COMPREPLY < <( compgen -W "$list_fonts" -- "$cur" ) ;;
        esac
      ;;
      +list-themes)
        case $prev in
          *) mapfile -t COMPREPLY < <( compgen -W "$list_themes" -- "$cur" ) ;;
        esac
      ;;
      +debug-info)
        case $prev in
          *) mapfile -t COMPREPLY < <( compgen -W "$debug_info" -- "$cur" ) ;;
        esac
      ;;
      +update-terminfo)
        case $prev in
          *) mapfile -t COMPREPLY < <( compgen -W "$update_terminfo" -- "$cur" ) ;;
        esac
      ;;
      +update-shell-integration)
        case $prev in
          *) mapfile -t COMPREPLY < <( compgen -W "$update_shell_integration" -- "$cur" ) ;;
        esac
      ;;
      +update-manpages)
        case $prev in
          *) mapfile -t COMPREPLY < <( compgen -W "$update_manpages" -- "$cur" ) ;;
        esac
      ;;
      *) mapfile -t COMPREPLY < <( compgen -W "--help" -- "$cur" ) ;;
    esac

    return 0
  }

  # begin main logic
  local topLevel="-e"
  topLevel+=" --help"
  topLevel+=" --version"
  topLevel+=" +config-set"
  topLevel+=" +config-get"
  topLevel+=" +window-new"
  topLevel+=" +surface-new"
  topLevel+=" +list-fonts"
  topLevel+=" +list-themes"
  topLevel+=" +debug-info"
  topLevel+=" +update-terminfo"
  topLevel+=" +update-shell-integration"
  topLevel+=" +update-manpages"

  local cur=""; local prev=""; local prevWasEq=false; COMPREPLY=()
  local ghostty="$1"

  # script assumes default COMP_WORDBREAKS of roughly $' \t\n"\'><=;|&(:'
  # if = is missing this script will degrade to matching on keys only.
  # eg: --key=
  # this can be improved if needed see: https://github.com/ghostty-org/ghostty/discussions/2994

  if [ "$2" = "=" ]; then cur=""
  else                    cur="$2"
  fi

  if [ "$3" = "=" ]; then prev="${COMP_WORDS[COMP_CWORD-2]}"; prevWasEq=true;
  else                    prev="${COMP_WORDS[COMP_CWORD-1]}"
  fi

  # current completion is double quoted add a space so the curor progresses
  if [[ "$2" == \"*\" ]]; then
    COMPREPLY=( "$cur " );
    return;
  fi

  case "$COMP_CWORD" in
    1)
      case "${COMP_WORDS[1]}" in
        -e | --help | --version) return 0 ;;
        --*) _handle_config ;;
        *) mapfile -t COMPREPLY < <( compgen -W "${topLevel}" -- "$cur" ); _add_spaces ;;
      esac
      ;;
    *)
      case "$prev" in
        -e | --help | --version) return 0 ;;
        *)
          if [[ "=" != "${COMP_WORDS[COMP_CWORD]}" && $prevWasEq != true ]]; then
            # must be completing with a space after the key eg: '--<key> '
            # clear out prev so we don't run any of the key specific completions
            prev=""
          fi

          case "${COMP_WORDS[1]}" in
            --*) _handle_config ;;
            +*) _handle_actions ;;
          esac
          ;;
      esac
      ;;
  esac

  return 0
}

complete -o nospace -o bashdefault -F _ghostty ghostty